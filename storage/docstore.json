{"docstore/metadata": {"452719e6-dc5a-416a-9ae6-a31e8aae46ba": {"doc_hash": "984bd54b3c816e26bc5b09a92767357e88ed18d830191ed0dfe1d1dc0d908ff9"}, "7cbc0a2a-c981-4ec1-9ded-920d0241dca9": {"doc_hash": "a9863c7f7a476c07ddf8fa08015a045acee4a1a1a954d8c2d5bed853e8eff5eb"}, "7f15b7b9-b758-45da-b7ec-44ebbf180a5b": {"doc_hash": "734cfc9d745a627ef4700bf53096d6e3b62ac68c090686e1c8633948234d844b"}, "649e0877-ef07-4eb4-9757-d99a3e142954": {"doc_hash": "500f4453d67ee61ee5f9827d04f66653afed405d7ac97f7a0023a4e8b2cf2c77"}, "0a32108a-a19e-45c5-b967-ea3496ec4151": {"doc_hash": "dc11add2fbd6c060241764958949de7748ff195761999e5a7b45bac9211498b9"}, "4ba513da-8176-4c46-bd36-559b7325ea0d": {"doc_hash": "b393c2ec5ca82602396a19938a5d6b8aa452424cdf6a0a9de0f900f8326aa435"}, "8af8abd0-43ad-4548-a883-60adf617a50d": {"doc_hash": "1714a199813f7f4e48de32b33120710717dea30182254fffbfcd61d75657b7d6"}, "5ca13317-56ef-4cc7-a3e1-f36ea4ca2bde": {"doc_hash": "edb323195c39b575c465a7ab75212aa26797d8587ca96066322be8ddc3da8137"}, "17a12e9c-7800-4beb-a313-7223d929da87": {"doc_hash": "b945d484faf7275245c2e39647d86d3bb0c7e05025e88350554a48fa42d3790e"}, "944a7045-eba3-42ba-965c-db2f535de128": {"doc_hash": "cdbc6433352d8251ff30a514df56f6be7292089f70347ccbc0f68acc21f22f44"}, "f2512cca-0fa6-4443-9d1e-eb8176920f61": {"doc_hash": "8e0785f8003068694650ea0cff8f2b843bf1c33de87d6f35f244dbf67cb983b8"}, "72841d28-ba1e-424e-8023-0b0823df9ec7": {"doc_hash": "9d15865e1fc3c7a8e32019d0894b221dc9dbeb77fde0ea1605f15a3f6144b9f6"}, "f3febc04-20fc-4651-ae44-daff4cc5bc74": {"doc_hash": "daf29f8705b1aff71603b2946efa8d6a40ce11758daa9dc8511de2a202dccac2"}, "791fa0a1-ef16-43b3-ae0f-6ce91fcd3982": {"doc_hash": "3dab9994c07fef1cea7ae2affc23e33bf0e482666c830e409c86401b990f1109"}, "b1685fa9-c29e-4648-82a8-da69110af002": {"doc_hash": "fb26cf505814ab3a5303cbf88fcb953fc6dc62427bd253880c2c8c9af62dee67"}, "2d22952b-f353-4fd8-91db-1b3ffbccbbb3": {"doc_hash": "cd36109717c5b1ce2889c3b731b35b7c5adcdb0aeb4c49b603863053eb716c67"}, "47ef942d-4e7c-4b8b-a31f-63bb4a87272a": {"doc_hash": "ec3ea1aa939d6561742eb64ba9321f6d361ac03ad77c70575ab47f36074ac2a0"}, "623d9f4c-a409-45f9-b87f-6f7ddaecbd9b": {"doc_hash": "9da3b9767b426d05bea6dacd513ecc62e6d94bd66bb7f1775637b8c16adb64b9"}, "c837571e-9916-40cf-a47b-c5a6832b4b0d": {"doc_hash": "854b9c07b86103aff11a05a3ddc474d7624b5e9b61898727d57478a20782f169"}, "72fb99a6-8254-4f90-ac5c-2d76702d3626": {"doc_hash": "be476494a5c5d1a53a8514f34bf7cfe57f7feb26e8bd07bbf738d47e16a71bfb"}, "d080b56a-f7e8-4d10-b673-9ee7aa103a05": {"doc_hash": "f0e3a9fbccee84158375c5d037162bdf90b9b2ea41bd9548a6ac4ee7b161f258"}, "21ef2447-58b3-4267-bab6-cba51b47d579": {"doc_hash": "3c561980e0d43262506e717517987eb4bb0d1758b3c1ef43730e232cc9923cd3"}, "084d2857-7398-4172-8425-2506e020917f": {"doc_hash": "4a3aa1fe12fcbcac8fb998e4071c6dc7b3edaca15cad91766e27b927f1adf399"}, "edce654c-e12f-4d0c-bcc7-59aab2d88ea2": {"doc_hash": "d9e08879154de8fadc60f9f3b262f8c74c8e25706fec9d7b31ef33326e9b7180"}, "59eaab45-a46c-4d8a-b4ff-139c9d0e67b6": {"doc_hash": "8da19dfad15481323950ff83090c1d53a493c28eb3070716473a283e6f3389c6"}, "0fd13993-78dc-4353-ae98-f0fb5771d168": {"doc_hash": "837b591821a71114fe9ae469e4348f3a196ecb96262be754220d7a10006576d0"}, "75d843d1-6d07-4f24-a0ee-153f1af4f10b": {"doc_hash": "6f5d46d1bd0ba1480ae7e89a67eba5b28fdbd52186fa306a198bf8eeae35f89e"}, "9699f80e-72da-4d28-bd0e-7db183ca235e": {"doc_hash": "3d17bb16ddc040a74d9e5e8a9e7e58653c137e91a289db8014f76b586da00882"}, "71e2a82f-ad00-4dbc-b526-5e625a8cda43": {"doc_hash": "1a69b8717b3adedbc99e8f8571eee4af71edb6980829d4d70f6877b2c59faa39"}, "6c29441d-7bfb-4e17-9db3-ff323cc3190f": {"doc_hash": "580a47dae51f347fd6ce9a35406a652c287027ce1f9df4c0b71eb442cb9e7be1"}, "b9752c92-923b-4765-9c3d-96f24e84b361": {"doc_hash": "0cc8cca0abb0fad9198016382674b81dfb916b424ef1d7a334b830cd1e7c1fff"}, "0193b7c7-e67f-417d-8040-a3fefaca9ec4": {"doc_hash": "81bf02b8a8da2de628a7e75ffd840d2272499b7db80a49c3d967afc3482907e6"}, "3a8e2b95-be73-4d30-8f12-4e89059b933c": {"doc_hash": "a9296c5b8c863945ae593001c6635ec15861f118d208da4cb64b64edff3f7de0"}, "2530a1a9-9ec3-4099-bf86-38f40a7eb25c": {"doc_hash": "c1578ad554444b13c5fec5efb2e73ad134dae26e15871597d720c184c3ab1e79"}, "e1cfddfb-e17a-4220-bd6c-f967d79dee9e": {"doc_hash": "1a355ddc62b3ea4ca04e28954ff1aeabc02421af7ea61f8fdcea64afeb07a070"}, "b16bfb58-d366-4669-958d-c5e47f69298f": {"doc_hash": "f65e876601be6d372d34060c76834fae6d95b694deebb191e7974e3a03d94c6e"}, "1ecb7f8c-c239-4df3-ae82-87934e1785c0": {"doc_hash": "6bad34f2d20a74a1426519b7c9539aa929b8aac648a46c7153de2b3fc6409fda"}, "d219add8-5278-4d44-9b97-73c57038c907": {"doc_hash": "738b63f37d91c512632e4d2bf690393a40ecac60b3bbc8fb8d0c6b46c17be18f"}, "ed2689ba-d0c1-4c1a-8f3c-a83131b7b4c8": {"doc_hash": "efbc1376a75dd70cd46a9bb45098e3e9581f5e045f2a2287bbf8291b22bca196"}, "6b927665-04e0-4bc1-859c-44b86808361c": {"doc_hash": "8f2ed7b39f9783213df1a6ee55342a142f09165a9f4163b00f32abd97f37e640"}, "4c40bf77-29a3-48b9-b9bc-79cd209fb5f4": {"doc_hash": "9e4867a994f508e9792a967141bbcd70c6aff165dc2d7382e9436ed53136e30a"}, "04b40021-cc7f-49d7-bb90-87432bdc7a01": {"doc_hash": "f125aead0d2523af1bbd81234b220f3a4b8d0a423bb9ea5bb2b50bc30069ef25"}, "be0abac0-92fb-4ffe-a151-21b167412d07": {"doc_hash": "164247bbd5547873846ba4a4be0ee49142b69c9787d8059cebf29e67c5920610"}, "ac7bab28-7528-4223-a181-bed58104082a": {"doc_hash": "42ca99e76c3f9d9f833eef16cc836a81ac703e3614d66478632c7d5913f48b5f"}, "dd97e852-7b38-4daa-be9d-72ada2ff60b2": {"doc_hash": "d7261e5b580a7b1f749448e4bf70efd6f030897faa6d6cade26a31dab2395a16"}, "68f3d29c-e880-4c5d-b040-652e5acb68ab": {"doc_hash": "276cfc7ef595a6f3821a5360d1c0252c48e8e7624863991d5a0562c820e92ec3"}, "fb9ac0a9-3b54-4c48-bc50-cc8d37ad2ea4": {"doc_hash": "c794c83ea4fed05bb33ae192efddb3da6c897576f0d836887165d3ce38d8181e"}, "58334eb2-4abf-4aa9-a68e-ee1ce63aa522": {"doc_hash": "94e3c0e49ebb18f9c0681d74f819bd99e809afa886d9d6be4d8f1482d08cc2b5"}, "4bd6c109-ea92-48d9-ae98-0e3fd54f975e": {"doc_hash": "d1684c9172950abd205d3364e46cd35fd6fa517818f1d8c89e5a38ee1c662109"}, "75482dc6-110f-4a7f-8d2f-1c589e68b7bc": {"doc_hash": "90e619591a5ac17dd90df7140531929b7e02295114f7fd3d6e1c5c2f78402de5"}, "fcd06331-492d-4004-ab85-d4b1e3e04703": {"doc_hash": "af7ab2b06e3e8f48563bdcc67e204db6cb08ec043c8df508e1e65aad1c5eb5bf"}, "a27465cd-c293-41cf-ae48-ed9ca95cc6a2": {"doc_hash": "8b7de1524a6884a82b101c1901168f5ebcf2da9461641d6671885d47f4dcd612"}, "b65bfe97-58eb-4f1f-a892-b4c8529c9a4f": {"doc_hash": "97752e34a230490c257d0b55632859d03b57eba6e6be0bf05f1842a85a80e512"}, "f0d803cd-f7cb-41b5-914f-0654ff3d9c82": {"doc_hash": "fd8670428abc0cc04ab35fb54844a4e469d6d66f54d0f1c62fe86b122650db26"}, "f2b37f08-3fe3-486d-a728-766ddc4cc726": {"doc_hash": "d2a174ac436792e293e88fa680668a9f92c4102ddbdb6c9547c41b0fdf84b71f"}, "bf436449-e80d-4d33-8a50-2369d1168551": {"doc_hash": "e8d80d6953916f92fcb3ff6426848ecc1981168025659f29724e5b3ba9191d9c"}, "f6091f5f-3b99-46bc-92d6-4407be75b727": {"doc_hash": "1da4394716d462f186f20c357cdae8d6f168590d217615ddca9f3a055dfbed7d"}, "a8f93518-1344-4ff9-a3fa-16c577e1d2e8": {"doc_hash": "626e2b2df2a3f576fc236c252f7faa69deaae16c3cc8d10c21eddba5d2343a5e"}, "555a4cf3-84d5-473f-a79f-3acd00d6f038": {"doc_hash": "6f3c66418e87798e8750c9c4d933e5d160f56d4ab13fd70b7e07adfc4660c3b7"}, "9199cb99-33f3-48d1-8f7b-dd1b4d41d5d1": {"doc_hash": "20a588d472e7674fb25f972fca2f17583d6573ef167d7118624c576060ed9088"}, "d7cf21b9-e632-40ea-870a-c7c33b2a5597": {"doc_hash": "da789a061dda815847e6ad009985f898c2ee06c50a622b9a7eb643a50216eac3"}, "b5bc249e-f558-434e-9e1e-df01ebb123d3": {"doc_hash": "b9e5a054c3136e7afdee8bb2c7e1ebdb38f3e3aecb78b206a5a24c1be0a883db"}, "ec80adb7-1e19-42e1-9c9e-c72304ded225": {"doc_hash": "d36f663dee32b9c63530ec8db753229fd2b2ed39ac25270b0afea0fc53385ecb"}, "4ba162b9-7119-44ec-bf12-36b4df557b4a": {"doc_hash": "ef68f519aa8d4705abcf07f610d5959bdd76637d0300192509a34034a4ee3b2f"}, "76f8076c-b9ad-4ec2-9635-1dc6cac1217e": {"doc_hash": "f8e61900d4181f45001cdb723754a2ae04de4d4b162d7dc156dd7c26ecd3cd9c"}, "fd4fe35f-8dfa-45f8-b847-a745c776ba01": {"doc_hash": "5c52c73464bd8cf6b0f8a2298840755503fd72bfce2ac6130157b61bdbf216ac"}, "983b1bc6-4018-4ca0-bfd3-113a59ba53c4": {"doc_hash": "33805d7628e1c23ea9c42c18263d8832fa4d99d101f3a766d1c7aba6c23d7214"}, "2b3e410e-1735-433e-a26d-6a0b0734a659": {"doc_hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a"}, "9ecd1dcb-1da9-40da-a8dc-3035678caead": {"doc_hash": "7e4ba3aef9879ae4cd5b2e254c5dcb597fd94f07ba5a023b76cd534ceeedf2b1"}, "80514101-fc7f-4fa3-a6c7-0e720faa8681": {"doc_hash": "5211a7a46b1361f834e3f234797645825ccd7815c8f6dc9c1615e72adf61458e"}, "f7089940-ac3d-4982-813b-0f1f9fcbfce0": {"doc_hash": "bb1badb949c7c267d86d089934d5c3abf9ee9546d1b4710469c1d80331321a32"}, "207e6bfc-4554-4ae6-90cb-19f777c30ba3": {"doc_hash": "c22c4d846639c84ed167270edfa801c88dc27d891b091c85af93433ce71e0872"}, "8219d331-a4fd-4480-b5d6-b507ede38e0b": {"doc_hash": "7d487cac969a5eeb02c1cf69d3e09989069fe5960b28f7d8eda0ec2ea0368489"}, "d1408d73-ee06-4439-b14c-1dab77a38edf": {"doc_hash": "610c1ab0f03c4b3ce5cc12652e2b3d3b0a043e6dff30d8f13bb6c6c222e2201b"}, "2aa4c010-8271-4f68-b5ec-f2d43ae8ce3b": {"doc_hash": "c33f702e0e1c8b9237eb2000b0b712781ca9a8b74a099178b823791886159beb"}, "85e1f88b-9db1-4d48-a6eb-f6da51cddb31": {"doc_hash": "4bdbd1a046332b6255e4c0f1359df6c264143fd76e6597a46476213561ef3a33"}, "0b825a90-3ed8-40a4-af6f-a23526a54c6f": {"doc_hash": "df56e9ab2a37eef977fffe4a6423a2c39faa3d62dabc3c9086de072bd61d28d0"}, "7edff531-f9a2-445d-b3fe-fefce6ea1469": {"doc_hash": "3e90ad5b32da2c0592cc11931f91ccd1a0aee8671306db63f9c28e45e1ec5d02"}, "ac39ce31-2917-4938-b1cf-f30ddf5ecc5f": {"doc_hash": "411c12c6755a98addc3ad480a37cdb01c90a0da67f47c5f466395a1987c056e5"}, "989a4d13-fc47-49e7-af38-f28af1dc9abb": {"doc_hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485"}, "a4138d34-acce-45e7-afa5-70ee1e20901a": {"doc_hash": "e462d3fd70d8c404f93b3a5c237b60c12e27c3baa33446d6f372f752e49d6aaa"}, "661e34ff-e65c-4e69-b3b0-898ffbc65201": {"doc_hash": "4bde4606a466adde7e8c828baa0d8e252e7056fc25d64729444c3114a2515207"}, "6e414818-2def-4da0-ad7b-2083240dafac": {"doc_hash": "f8a72cc6e8458dd43d16918aada63c8e238043c2aa49ba16ee7a9afb89c55387"}, "6a3e6291-5b9b-434d-a8a0-9fb83d3eb662": {"doc_hash": "3420a063dd2f5b023079eafbfb1432695a46418829ebc45508c9c978b7499c4e"}, "265ddd63-d8e6-4210-820b-0bd4e7797745": {"doc_hash": "5e88a1cfff48d153c07a21f9d12eb90a3fa1f1371a8b50a3e64de4a558fd79d7"}, "36b75554-8723-460d-8ca5-cac6322fbc27": {"doc_hash": "866af3273d058371e617f96e28de703495007643c9b5b4c58791aaad83d8c012"}, "29096612-3ffa-4ba9-bf73-48fa3f45b354": {"doc_hash": "21e2d4aaa098cfbaefbfe834e6b0c4451c2b1d91d6ebcc5d34d73a1b7a313ea0"}, "f52fd3e4-756d-420f-8950-efc855d6dbd0": {"doc_hash": "a0d9a7bb7cddf72e2d27f10b97399ea4abb32ed7b44360146930b5050b0d7d73"}, "342b7401-f2f2-4cd6-b4dd-bbb4dda0bfdf": {"doc_hash": "b14eb2fc6fa99337afef5940b477227c9285578897823ecf1a15f5133c07f5c4"}, "6aa7835c-ff39-4440-a414-2c1e18f53662": {"doc_hash": "c0f68c536e0fe0a1bcafe00590d8ba71dc04c071982ea2f538d4fc01c3cffc14"}, "2fc296be-32a3-4c53-b5c2-39397423556f": {"doc_hash": "9bf3bd80044dd149460117ff003080a21f44651019185ff962302fefef52d7bd"}, "935ac8d6-1523-4919-90ec-9902cbeaf7b6": {"doc_hash": "d6364761163781151dfd8dd2bea12ac65b938d93185c339bf477fd2b75dccfbb"}, "10d73805-bb4f-40cc-9ba4-4e5389a4629d": {"doc_hash": "92fef61b67b4fef314ab67b24b4e1c92e6d10123d3fa5ab6d858d350d9dcfc7c"}, "11648e8a-5b5f-47b4-a171-042f18c322a1": {"doc_hash": "60551d2e98a1db5f9fe459c9331faa26524cf30af3963c305d6306ac4e8aa4d0"}, "d33ca55a-61c0-4c93-a37a-7ab825660ef8": {"doc_hash": "d8f9dd15ea60291d8f93faabd345da35bc8404947e1f52cfaf5dbf3c8e7123d3"}, "d51e5ac3-855f-4c59-b6cf-89ac2dacd175": {"doc_hash": "e11ee20fde401f06970e095648bd38ebe315087be21300133a49a0aaff4d9541"}, "9f0213a1-8b99-416a-b97e-d6f73804b606": {"doc_hash": "eaa4317d1554ef2dd755b6d7cd861e59dc3032f63944b103de913d0b1fc108c3"}, "f6f10c33-48e1-47c1-b2d0-39873e999a6d": {"doc_hash": "27bc1055903a1bf62fc357d235fd54432338d503678761c3dfb367cf5248defc"}, "76dd1381-3d9d-4f76-8d0c-54637b99cecd": {"doc_hash": "7734c1862992de87bc0ef2818edbeffb01dd0459e60a2ffb7baf1cd151885a12"}, "1f2a38cd-ebe7-4884-a677-dcbbbb0a51a6": {"doc_hash": "654d5d970e20dee0eccf4f1c0fcf10c6ba0f96a4b83ded6ebcbb1ab03900f7bb"}, "9851deb0-e7de-4c86-b544-d9521b2fdaff": {"doc_hash": "ec6fe53a6adca4f619a0aab1cf504a6a4997cbb08501930f0f4fd5234e72e767"}, "337e53a3-c540-47f3-80f9-6c691356ea9b": {"doc_hash": "12951de4ded2fbce3e1903ec41cc39cbfa1c2230d0ae58158258a92e1b04df5d"}, "d357f2a6-8e6c-4e2d-8856-fd2c94d167e5": {"doc_hash": "8287bbbddea5151e998a22997c53b47164f282172af4350d65f7ebe399c324ba"}, "1b38f269-50a5-4c64-bc9b-83f445d36732": {"doc_hash": "6441902d914feab1ffb71d864b40b00dd658652cdac3bba51682f5f0cda0c969"}, "20d69657-d22e-4beb-8e97-03b91bc9ed8a": {"doc_hash": "fa49b598665a7db6413838d9f42164c5d9f630ed5b6668018b3e7c1199a48344"}, "8b235e2c-da4f-41a5-a1a6-3217968dd14d": {"doc_hash": "68ea1745508fed45c8b22ad8b297ca31d1b066ab39a0c99e8a4c35bb5f45b164"}, "b257e43a-66b1-4df6-be67-3150de4be004": {"doc_hash": "4bfdca8fb03180d22329965bba19939a57734bb861cb8506342cd0ef88b7678b"}, "9708101b-ad08-43dd-85ef-86d69891d93b": {"doc_hash": "268f04d1d0b905fdc181a7932cc43c302cbd53753740c84cb505302006a06008"}, "08098e45-63d2-47c0-bb1a-f63a21099f39": {"doc_hash": "3b5b780b27405c6c8ef94ab478c16d6a8aeaa16dd4bceedf9e5c323319ee7a27"}, "eaeb5440-d56f-4082-bb26-6804bd20272e": {"doc_hash": "606ea19822d69fcc8a1ff7df2db6c145420ad84209695a1533609bee0f5099ce"}, "1d8a64a0-0b1f-4a2b-aaa9-cd28e115d880": {"doc_hash": "0fc15d852bc3190f1448dfe7d399925e8a4efb9ec844519a7895c9805aa54bb8"}, "4e1187b0-d907-4d0a-93ab-350d9a58dd11": {"doc_hash": "c4173ee59bac4c73424d2e87eeb8b5891126feded455766707cf1bb736fdaf1a"}, "29763e78-76e0-4efb-8899-64c6f8b2c148": {"doc_hash": "a2efe080342b49f8e5d1c71a5bdc8cfb09590d37d4aa566a2cf41778671896f9"}, "f33f5799-0b3c-4b81-bb8c-de1e4f1e5ba0": {"doc_hash": "c679b18eeaa58a198861c3a46b5fbf6ec3d44602caff2e4ef0bd44a88a14ac67"}, "038fdd76-c25d-469a-9f9f-b90d63e65b31": {"doc_hash": "680b60d8cbfd0ef342111aca83998130b0170f5c7c6fa0cb87889c6064d1cde8"}, "0c00f1af-b690-47b4-bf76-346204af944d": {"doc_hash": "90f46a41e21928ec836d546868dd191da842ab399fd66c7b5d8344b39cd88d44"}, "be81d64d-f554-4617-ba36-9494e1830d4f": {"doc_hash": "a044daf62087f5b414f8e0b5241679cd8c5fb81ec57da0dfa6a4209b4c01b854"}, "54cc6769-ba4b-443d-aa5f-205a61ea7085": {"doc_hash": "a2701dd865d7450580e279ce85fe6a8047a1e2649ff61a3cd784e39dec07948b"}, "50baffb5-891f-46e9-ba9f-5f231427eb73": {"doc_hash": "d6ce5a14474122db5bce83d8a9e495d3e93e976871e3e6bc7ff0a86aa5b49f92"}, "e45c7760-5324-472f-80a0-430efd09f021": {"doc_hash": "eabf40839a92ad265145dc7cab693dec176b8b1be3803424089d39cb7be69ef1"}, "d4de66b4-b616-426f-858d-e555e6b6e888": {"doc_hash": "8a0477784fe01491ba610699f399e16e268dc034483aa6f57181327dd5526524"}, "986aee79-7a40-4e5c-8c4a-ba677c3efc5e": {"doc_hash": "4c68025dc5aaeec27b459e2c4ea2f980684d0e1d3aa598b8d1d0ec37a0a07bf6"}, "a2d5c3b6-9721-4d11-b886-23c01d077a5d": {"doc_hash": "76ea8ed83fabb615c464d54c0f10e624e8c303e882d76d914e5440273e043e2c"}, "19bb81de-ecb8-418e-b274-7bfe2361812f": {"doc_hash": "d339f5282dc5b80f5c1c0a3465155fb8c30beac498e08a15c67a05ef0ffd5830"}, "1a986fab-103a-41f1-bd7b-c7b25aeab08e": {"doc_hash": "ac8cd5dbc42930dc313a3f2f9fee2487ce1928cdecd446ea0e4e4805ef657671"}, "2995b554-16b2-47a1-8290-752393aab1ae": {"doc_hash": "a71998828cad36c2ad54ef08c80a883781149c366a40cbc0a44d0d71e5fe67e7"}, "2210e22d-819c-4ee8-b4bf-a668724032f4": {"doc_hash": "179f242cd05a2a4315c856f3c63f4a0a06935e03a3a4f702ba7170b76a59d4d3"}, "643e9968-020a-4265-ba3a-c136bb3fb51b": {"doc_hash": "47d29b66d8f258925822618dd7cd78d85743c70ebf61b3e668a7274528d5571c"}, "e4f8a88e-a468-459f-be6a-731cf35faf13": {"doc_hash": "d0ff18660bc5bf82c0af8120f6eb0a5fcb8672113349284ef706c697c58ef345"}, "70106f2e-7567-435e-acd4-f7e6b59fc3d7": {"doc_hash": "a4601452557316f1ff96f2b9e5db398d51f1a8547a6b39086954bfa36a6939d0"}, "7780775f-421d-4242-b7fe-f5f4d8398457": {"doc_hash": "b416fd2b2cdf32ec402a7468d7c6e1daeb44962e7d5034f0c2f710aeb5703a3f"}, "0875b3a1-3c84-4558-9165-c8e5e9179b74": {"doc_hash": "828b538485ab5e2bd964b0a87dde811a96d49908c268283b0065c692cc730c81"}, "7c3a0f7d-fb58-4c67-971f-4d0f0b70149b": {"doc_hash": "9c30359663ad07c0f40d6165b096f980d03e2d12b126696e99c0949992627d98"}, "a58bd078-5e80-4548-a6dc-3ffcf58de308": {"doc_hash": "c8226f8ca0070688533c1d1ff9415bc5e42e75a92a1e1c721fa70e7d85cf8b39"}, "9f7d5136-1a68-4d2f-ac12-61ba612ae228": {"doc_hash": "d1c8e1e7bdb14d3fe21c31cc6ba24ad533b1d5aa6093c620c8c7d4b4860b41f9"}, "9ec685e0-f3bb-433a-97c5-2e7e1d8d5d9e": {"doc_hash": "c310e31304503605a47020ea1f7b4e50682fd5b133fbf610a4e93589511fae4d"}, "569b3716-77bc-4551-9d10-2b0b23894e00": {"doc_hash": "90a003b77c727663dbcd3bd5fb35f40f10db3a9ab15efce2ad1e36bff48cca14"}, "3c0d95a2-5c99-4fda-b060-990250966bd2": {"doc_hash": "55e6f220d6f21bd14305b841a3964723ecc967dfb5a5feff92999875a26cc274"}, "c77100a9-e1c8-4c85-8649-952b428ea00b": {"doc_hash": "a9604540f61483deb83aa479658aaff08acb8661c195d4e99d36a476e0bad2a7"}, "3f20c2af-f0dd-4a74-bb3c-b33d76eb2cf1": {"doc_hash": "c3c9c4f37986650a487c51f6e96337b26d8fa92fb92c64d1c0742d5db52d02de"}, "326af040-385f-4592-be57-172ee53c0865": {"doc_hash": "5940c009620e860e8d4841556cba7ec5cdeb120c0f7698781dd2fafff5623c06"}, "5ecddff0-031e-48cb-8316-73806ef9f524": {"doc_hash": "9bcfa3c5b7084e8d99351b1223d1f03033579b68df9cc48474d03a721c034731"}, "69ada291-f55c-49a7-a2a2-98550c6cba35": {"doc_hash": "3425c9ffd0e80406df281439320e9aa02205c4a083f073c8c2eb1815f415118e"}, "6bcb8ccf-b935-43f8-948c-84b6dfe58909": {"doc_hash": "a27fa1948df91c6d89498a2207abb7106f9a93450eeb7f995a8216727e2bb879"}, "17e250dc-a486-42ac-92b9-79283e8bb181": {"doc_hash": "82523ae6d036209b57c6f4a9a8ef516562d3300feb99150ca8f32a85c9a31d78"}, "3b7b22d2-b9a7-4439-a33a-e62e91aa2301": {"doc_hash": "f7e20a49b010db315e63f8fe742ba773043d93e7e7a4c22ab3cf7b7981f2fcf6"}, "c5943d27-24e8-4821-b817-a97ff01f6fb3": {"doc_hash": "c1e4c13546f87d760204f92fad204985bc3657f3fc1e528c7aca5be645391d24"}, "5b77fe54-9b10-498c-ab50-ef1b5a679d1e": {"doc_hash": "7c5611477f9f9f7f35b3bd7912712e91181659d170dc867767bdb40e1d5c08c3"}, "1c8b7ffe-3389-4c3c-983c-a66ee5cd0d8d": {"doc_hash": "701819e2381a488d71c53be82ad10b21b2023e8bf00e739d38168d674cf5ea6a"}, "70742b89-de98-429f-8de5-bc66aec0c8c8": {"doc_hash": "d3e3e8b8233ab3ff613beab793a2a3a79ddb0d6c61ef8f1c647d5d83fee05d86"}, "581ead2c-4ccc-4e96-9bcf-1cbb133447ca": {"doc_hash": "3c377360864dac470100df1d9fc6fa29e597e64aaae832873a7e6d6c91c64281"}, "3047959e-b205-4a94-8909-8848c2158d71": {"doc_hash": "f8489ee33f5ff0d862643b030066da94432fc9654887dfd452f87e01a4223543"}, "93bb9756-5ed5-44dd-a57e-afe5415b2f5c": {"doc_hash": "703942e85f3c171628a694c6dc744771e22ca5f0bd5548144c09dc6693636066"}, "cb44686a-6ca1-4136-97da-0f623d76042a": {"doc_hash": "e9954d89c60315f4a140bde2fd45b9d64a628b6e07a8f39ac848ae655238de56"}, "1ae1750c-c9fd-4451-a7ae-cfa6ebfa57e1": {"doc_hash": "2537b6fb0fcd69b5e5ea7e9772d8ad3ea3f6155e01660c473e1bbc7c54072b37"}, "39a14761-f57b-43a5-bd54-3763fe95b651": {"doc_hash": "597cd41e3ef6441618a23aae93bb6784cce4a448dafe4e47ab327dacd45c8716"}, "75907ae3-2764-40b0-8140-09ccf704d647": {"doc_hash": "8fa597c4ee44faadc281cd8dc3c7838c40bc9837b97e470e4c9a4b287d9a7018"}, "05a8716f-7666-4469-bb93-1556c22c722a": {"doc_hash": "c6c699a3bfbfbdda1403bb2f60558bb221ec94a9729c0bca5dd6f81fe0b2877b"}, "2c33595d-a26c-422f-9f6d-34e9267baada": {"doc_hash": "847627d8f7b2ccbfe548235914858ab2232088d56af94244f2b9dda0c0154af6"}, "7382a6cf-214f-4b11-946e-170d48598305": {"doc_hash": "eca5e9659a9173c1ce29fe22aadfe4358961d738e3ff6cdc1e59e73fba0b8050"}, "d136238d-a534-46cb-ae84-7e34780fb8a9": {"doc_hash": "6eb20881a07434f5026ba2c2b23594b54b27c031cf2a08da2aa03977ba9809e7"}, "688effb7-04ea-421b-bd98-f8cf0a6ac441": {"doc_hash": "93cbb0f6cca557e040ea6211bc1966b447b7fd2dddc74e5fb410ccafb1d747e8"}, "93214708-e259-4fbb-868c-51606fbceaf4": {"doc_hash": "c23320a5eb480f68e7541c540f0c0f988427625cb6f7ba485b121ebdbce12416"}, "cbb8f796-bd73-4862-9638-517f64f5486f": {"doc_hash": "012c8f7a39d53d98e01508f275f54f012f8f06d309d8036ffcc0e2f38a251b76"}, "58406d29-193c-46a4-9940-66d19f8aa1a5": {"doc_hash": "a5c4c909faad298c526fe937ccd4283776ef57f9d37372f599492f233e55b53f"}, "09712d3b-9cac-46ea-9aeb-8a261fb052e7": {"doc_hash": "349642bfb2f63f0f485a4e547d08c503a47bd1bc9c85dd02fd39233116740340"}, "3583b44f-8839-4d9b-8a70-7661e91b5d2c": {"doc_hash": "b144d5c576954d2505ef78d53fb04c305b9decd1166e4c0648bbfc12a8c12e10"}, "f84654c1-b017-4e1c-a53a-a264e4499db4": {"doc_hash": "119ccdfe4427e1cad7c8484cc9c4cf387090dfe46112460029886257e217b019"}, "1faf9863-89b1-4892-99d1-67d0f4af8780": {"doc_hash": "27cb79551772b49c2820c36e4e60be194a6ec14b741151071b6d1e20c5adea6a"}, "fb0a5321-3fc6-485c-97e9-20cd17c77874": {"doc_hash": "f1defdf8a5d3ffa3a5027f4beb76ec406bd5f52893afa11b4d85aca78b00cce5"}, "27d35423-7646-440a-93bc-acca5d10dc3f": {"doc_hash": "a46417434bd559ffe45807859033beebc2e2faa7fae1132170633705cceeb153"}, "0ea4417c-ec04-4bbc-962b-16f385506760": {"doc_hash": "291bebf3936fc33d3adbfec15bb96edfb38009a1d375ef6cbce78fd682a55597"}, "50c08b3a-e30e-4aec-be63-0955f844961d": {"doc_hash": "d2bb23a27f060eec2ef2225d680c540e6b7d43a9a94d7e2ccd1dd97e186fc4e0"}, "341107bd-c8af-4db9-8c15-1ac84d75d9c1": {"doc_hash": "8da1e068b8cf21f706e00b1745c4948ed2ac55435ccd55ca7656d402c00b22aa"}, "ba82f80f-2d9d-4ccc-ba84-b619721ddf53": {"doc_hash": "e6076bab260537909c31884f12a043f474465a71478f51a2a72eb9035650c4ed"}, "97ba2cc4-0258-41c3-9ebc-e445cc98c19f": {"doc_hash": "1064514ddd26cf8729bf7c4b42a351216bb9d1c3b9f3171bae22ed464210e97d"}, "ab3eb9f0-efa5-46bf-8f05-c7550691d3fd": {"doc_hash": "e04b80764565d133c998675da96bf049fcf2b9bb7ca450f3e2a2ec5aa73a22a6"}, "6297b80b-1fb0-43d9-9cf7-3af223dff8f4": {"doc_hash": "8cea0e703df781ba43f155a309849dd3a4fa24ca16e22585982afa5389ca599e"}, "bb0c7ee8-f9db-44d1-a277-0e29c17dc739": {"doc_hash": "d2c397f4f29844a865c78800f83bd699dd1f192233d25f503bd8fce9531374bd"}, "4ccfa527-961b-4559-b0e8-a3b5577e374c": {"doc_hash": "d914370ff9990aeada6d0b60430e8f7b7602c4f92ff0a1edcafb01968c968d03"}, "788035dc-a6ee-45c6-82e8-2fe5edbc50d6": {"doc_hash": "137f876fd807e9ffa7fe2e20032e001b668f563a1f207bf20879ba7d6b8f5eda"}, "d86ce7b4-3ebe-4523-a400-7d76bcf3345b": {"doc_hash": "423196ffdf4517053147430779674246d94e4000a84aa879daa0633581beb9a5"}, "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b": {"doc_hash": "75ce5e1e937f0d08d6d3f5d5482f2b7da322f25b300bb18a9ee561e46dacb00d"}, "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d": {"doc_hash": "9af025739324b81a7e91ddfc87e2c70c9cc906e3ebb8f0e6695a1b428d6af755"}, "cb6502a1-1650-4d3c-a04a-11a62afa999e": {"doc_hash": "d4adb32fa16ffb4b40a059c7b54b7e71bdbe0015c4e3e7d70f5720339512aa0c"}, "6d1eb4e1-26e7-4182-8b2f-a301288f768e": {"doc_hash": "d5b4ad1b676dae92df0da44f57d13a6f5aa7fdda11f57f010147e11af791012a"}, "bd027c39-9dc5-4d34-acde-f4c416dabc22": {"doc_hash": "691115ece3459a854321b105016173f9fb6935f3b7dbfe87a9df3ad83ebd628b"}, "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0": {"doc_hash": "ec8652f334691402b841696a210c6156b28f1688ab2cf306bdd1176bdc50d7a0"}, "81bfd6e6-4c4b-467b-a9bc-b47d512ff960": {"doc_hash": "05fd8136c747f117ecd9153eac157b619c947cd08a97e7bc68063eb543ea9f65"}, "2e0b49ab-a3fd-4af3-8911-597e30482e53": {"doc_hash": "dc1b08f2205ad6958873e2afc499e24f3cc44c1697e1cd7c75b4513aa8f61ba2"}, "a3079cdf-9c72-4211-8b17-937bf2df6322": {"doc_hash": "8087022e044e45a79e6e1c9ba0f766017f44e6e4d87d515027cc6b88498eb6a2"}, "9e523807-7308-4af7-ba56-998ea6431ba2": {"doc_hash": "e9ba5252e1adfae69fa4e31a859572beb2d5ef250d1af6684177183f4ec587bd"}, "fece5066-9485-4734-8b7e-e516ad9b868f": {"doc_hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927"}, "b2592cd2-45af-4230-8baf-a6e99c36c4bd": {"doc_hash": "4f26be8f342ba40220c803eb5ee77a97b0b0786aa1bc41dff86e019181855139"}, "7983b46e-58f1-4f9b-a389-2588d6edef24": {"doc_hash": "a390e776dcaced88e1a3b23800ca911eb4b437449eade697f7009fca6e08c986"}, "c41d658b-1b6b-4bdd-9b34-f96365b4ac82": {"doc_hash": "7bc709ec31a8690adb123c46d0329f00a9ab4b73b750ead07d29d4c8d9e996e3"}, "88cba982-fb17-4b97-baa3-2f4d667ae13e": {"doc_hash": "e7cc8920342c0395230269af66f38ecf9330c0173fd57cae8464a90cf87cac81"}, "0de11889-4a35-4bf4-b303-05575c99a366": {"doc_hash": "08ec90d97b3e5b056819a742060de4225f02e0ee903f607dc778b7bfb3c4e9af"}, "f58052c3-2b80-4156-b1a2-53145ff358b6": {"doc_hash": "98e3f19a4fc9e86670208a18db3205074dba03963bb31f6f9bb5e2d78f7c7849"}, "19062a8f-ecf6-4569-9cba-72d49b774a24": {"doc_hash": "e55d3c411e632c17bf0bb5c37bc6514318f821f4ee8263da4522eba7f7941252"}, "20e450e3-0323-4181-8acb-11ffb5b2e030": {"doc_hash": "e0012a8f4c6a1e31dc7bac9617c777097e67d5638e422c9bee5b2bd02ec67d9f"}, "d3e82f6b-64a9-4daf-9f0e-b6a3326b7a07": {"doc_hash": "3961f5d91ad50d81104d563160c84fb5148f0919104d9c73e44753acd9ed2a08"}, "abb2a4d6-5bbe-4b35-bfe8-49d1e9a79a06": {"doc_hash": "56da6040361912473035b5cf372abb658b569d9a63b7ebcbf5a863ff9d6e22c1"}, "3eece43e-f014-437e-b56e-5a4573b463e8": {"doc_hash": "eec17607180cb668e56c25aaf9f095d149e92e1d0fbcd0719c971042ab176ace"}, "f0d783f3-b717-486f-8c6f-57d61a800f51": {"doc_hash": "cda94762fb6bd06ea162febf3ceec654fcee63d3dfa5dbf61e387a132c0a4fd0"}, "d5245b86-deea-467b-8bc4-d06f0f93600a": {"doc_hash": "95e953851bd2b49444b11a467c8ed9a6aad91ddcf11d879431d254cc9091f148", "ref_doc_id": "452719e6-dc5a-416a-9ae6-a31e8aae46ba"}, "b6aaa604-b321-44c0-b94e-6d971a9a05ce": {"doc_hash": "27827da2717f48e42e6d6a2f3e891121e0c9c32b493ba92ef5fe4f45103c8083", "ref_doc_id": "452719e6-dc5a-416a-9ae6-a31e8aae46ba"}, "6012402e-cfd1-4624-8707-b6db0934cd2a": {"doc_hash": "996368d664ec3e1b6a617e97258c01872c0a3c2f8118c599ef89c5af8420c1d9", "ref_doc_id": "452719e6-dc5a-416a-9ae6-a31e8aae46ba"}, "9d99c789-7d43-49d8-99fe-5e2304104d65": {"doc_hash": "14b8796672f417dcf0eada8638d5ef47650bc299d5c906a9395dc039f7423c58", "ref_doc_id": "452719e6-dc5a-416a-9ae6-a31e8aae46ba"}, "a60245b5-dda1-43c4-99c6-446b53ab7715": {"doc_hash": "a9863c7f7a476c07ddf8fa08015a045acee4a1a1a954d8c2d5bed853e8eff5eb", "ref_doc_id": "7cbc0a2a-c981-4ec1-9ded-920d0241dca9"}, "7c889e8d-7602-4c65-a1f6-8c2efb84d7c1": {"doc_hash": "e5dd96e19e1b19735e29d4537ed152c67f21e60d17fb53ee50003e16fee47328", "ref_doc_id": "7f15b7b9-b758-45da-b7ec-44ebbf180a5b"}, "03c522f2-b9d8-4d0c-bb95-a7ef7ec72d8b": {"doc_hash": "29b0379a34e4fdd177ad3fccca322840e007213cd9aaf10b91bc133fa042b7d3", "ref_doc_id": "7f15b7b9-b758-45da-b7ec-44ebbf180a5b"}, "8de27ec6-8134-42e7-89dd-779c6db6e619": {"doc_hash": "b85815c1ddf2962f5c9010fdf5d5ee2198b4d1c217cc48bc5ae7a771b7e28a5f", "ref_doc_id": "7f15b7b9-b758-45da-b7ec-44ebbf180a5b"}, "f50e232b-61d0-4c57-91d7-b74912380f3b": {"doc_hash": "19d61c02bfa2caeaa541468e443d8a5265123935b2d3a7268f89799811bbb1d6", "ref_doc_id": "7f15b7b9-b758-45da-b7ec-44ebbf180a5b"}, "396030fe-a5dd-4e15-8aa3-6aeed81a3b75": {"doc_hash": "c5045e06e65be7253be0a3e25ca2661e1b2e07057b5de02041a9ceef7285498b", "ref_doc_id": "649e0877-ef07-4eb4-9757-d99a3e142954"}, "add62210-a42c-4e5c-a8fb-7b87d6dbb70d": {"doc_hash": "99771bfa6d207ea395fd33bd69d287cefa4aadd4fb521da4eb813b43bfc67bd5", "ref_doc_id": "649e0877-ef07-4eb4-9757-d99a3e142954"}, "734b4d07-8097-48ca-8ff1-13de33d4f81b": {"doc_hash": "6fa82c5e9fefb7aaf54d60a0806e4e083e27db6ea4c7027705fbb8e23fd72a27", "ref_doc_id": "649e0877-ef07-4eb4-9757-d99a3e142954"}, "80e94cb7-d8ff-44cb-a2c7-4511e7b39620": {"doc_hash": "6dac179dc4af029cdbd005f8e381030dc638aa566445c1465969bd08f27e34c2", "ref_doc_id": "649e0877-ef07-4eb4-9757-d99a3e142954"}, "95550363-55fe-4a5f-af0d-df0dbd90a656": {"doc_hash": "df06f7d7454262095fe51ef673addf122ca8b8684a926823784a78c30428ce5f", "ref_doc_id": "0a32108a-a19e-45c5-b967-ea3496ec4151"}, "6037fc0c-32ba-4765-bd2a-f29669d6fb10": {"doc_hash": "d5c8a6edf55b750b9945da38d9963e671397d9ee6633bf8a023b1c8dc1b47349", "ref_doc_id": "0a32108a-a19e-45c5-b967-ea3496ec4151"}, "9779d1c5-856d-497c-8c52-ed337d288f95": {"doc_hash": "e1eb46d0ced2a39205019de4b64ea55bc44a78eae7e3abe7ff6fbf2c7461d1b6", "ref_doc_id": "0a32108a-a19e-45c5-b967-ea3496ec4151"}, "33ae3e09-337c-43f8-80f5-a159d9de582a": {"doc_hash": "64f00add3f078fa8823e31445475f6933ff5c25202419c5a60bb173c9447f258", "ref_doc_id": "4ba513da-8176-4c46-bd36-559b7325ea0d"}, "171f1fb8-9973-43f4-8978-0d0707a6fbd1": {"doc_hash": "aa084b3517db14cd561a10b3afea1093aac547499dcebdeffc7e0ee7ed25b4aa", "ref_doc_id": "8af8abd0-43ad-4548-a883-60adf617a50d"}, "b35ed1c8-d20a-4a01-b17b-3ef33c4fb3ce": {"doc_hash": "609a4d6b443dfff5e538dae9083523cdcccb317a64bb751af1ac12ade7a0026f", "ref_doc_id": "8af8abd0-43ad-4548-a883-60adf617a50d"}, "50a71ecb-7625-41c3-ade1-d13c50f73a86": {"doc_hash": "d8366c06b5ba52ff53c226c4f70db74b0d5a549e9cf2bc699e0280946416962d", "ref_doc_id": "8af8abd0-43ad-4548-a883-60adf617a50d"}, "d0884373-d5ad-4f15-a62f-da1f9d32c644": {"doc_hash": "9b1831d7f1d779a2d16635d8eddcea4ebf7c7a38fc0e4fce7bace61df1de56a9", "ref_doc_id": "8af8abd0-43ad-4548-a883-60adf617a50d"}, "b7bc953d-1b23-4fe4-a98e-87ade49f0703": {"doc_hash": "9e33e5dff9e60f9f6c458ff82c2bde29d3bd06b630d8d371663ded1b3273b883", "ref_doc_id": "8af8abd0-43ad-4548-a883-60adf617a50d"}, "43cf191f-b8b6-4323-912d-4c284c744c33": {"doc_hash": "6465acf2a9638cef82aa6ab5aecf1a32d848b7a3954d56ac5cbbcb276ae4c7c6", "ref_doc_id": "8af8abd0-43ad-4548-a883-60adf617a50d"}, "742945ba-e49d-4739-ac7e-5d7945c50cad": {"doc_hash": "7bace7406f761b1c21a5c03808d381751b2ef9ce87b85c17f694c02f7e3d6db9", "ref_doc_id": "5ca13317-56ef-4cc7-a3e1-f36ea4ca2bde"}, "8e76522d-e12e-46ef-acc3-9739478eb40f": {"doc_hash": "444815036fd5f0477d45fe66b00edc553c1ca29f09b490de3d1d8ae0c9723ebd", "ref_doc_id": "17a12e9c-7800-4beb-a313-7223d929da87"}, "f35d8c0a-53e9-41ad-9efd-becad964365b": {"doc_hash": "6968bbbc85185abc56a2f17d19ed23b3cb19fe9dd2128bc67ee15336a946646a", "ref_doc_id": "17a12e9c-7800-4beb-a313-7223d929da87"}, "5bdbff67-4aa1-474f-95ab-1d46aae2d53c": {"doc_hash": "2dbf430d1fba7c930576c2a79865cde9423ad35d5374b7312c615e29b5a32de1", "ref_doc_id": "944a7045-eba3-42ba-965c-db2f535de128"}, "8ac87245-c104-494d-be22-a6f4d546e701": {"doc_hash": "e1da2ab5377e8eb4a1ae5476b861aab00d8f25121d297f7b468e57b830208cbf", "ref_doc_id": "944a7045-eba3-42ba-965c-db2f535de128"}, "b1cce014-3941-4704-af62-0cab5b47d067": {"doc_hash": "12e7c03fd40f781da2f80faa4b6ee55d8af5867af19de6f99848729b11ff85c2", "ref_doc_id": "f2512cca-0fa6-4443-9d1e-eb8176920f61"}, "a999c9a4-a501-4e77-9c79-9596845f7ee9": {"doc_hash": "80bf98a9fdcf14d19e5bd26e769b98440dc7378871e7ae1d13aaae7eff0c6351", "ref_doc_id": "f2512cca-0fa6-4443-9d1e-eb8176920f61"}, "ccf3741c-0516-4935-9b58-4fc16b9a7e51": {"doc_hash": "3b5ad24587d5cc5887c96248067efac43741aa9e1c1e55f92da7b26af453559d", "ref_doc_id": "72841d28-ba1e-424e-8023-0b0823df9ec7"}, "f6b4085c-3566-4d79-aa58-7a1a19224e03": {"doc_hash": "ef5b96f45b57848c401b2d58c28797293ff003219ffd1fa00dfb2bea14619a9b", "ref_doc_id": "72841d28-ba1e-424e-8023-0b0823df9ec7"}, "2b478a8e-acf3-4a6d-8b69-6302116cf8c5": {"doc_hash": "96b04b5be859ffe642beef5415924383521fe65db4ed7d6a14592f0a580074c3", "ref_doc_id": "72841d28-ba1e-424e-8023-0b0823df9ec7"}, "200605a2-e22f-4d5f-bb17-54a23e5c9bc5": {"doc_hash": "7e0919715f0bd2f6097e3ea53c703d2b072a772bb30157b20ef5779f937e8be5", "ref_doc_id": "f3febc04-20fc-4651-ae44-daff4cc5bc74"}, "54b35d02-b86f-4728-b9a5-6ed497eb34c6": {"doc_hash": "99f0521aee632f060561488c2eb7397a681a800a32ce9224961bc77df2a11cc1", "ref_doc_id": "f3febc04-20fc-4651-ae44-daff4cc5bc74"}, "ca7c4fcd-d9f0-4e3d-b7ba-77f293e98f51": {"doc_hash": "cbf094210704c420fad7a27e03c46639e0d071d8dcb527da1dd8ea2e512800d6", "ref_doc_id": "f3febc04-20fc-4651-ae44-daff4cc5bc74"}, "22b1eef8-3929-4630-842e-944d97e9783b": {"doc_hash": "f285f45b0d7cb88ed8eade34fa682fd88c785ed596eea85926b7710862315dfe", "ref_doc_id": "791fa0a1-ef16-43b3-ae0f-6ce91fcd3982"}, "5cdea29c-ef99-4bde-9c45-1110c60751f8": {"doc_hash": "57dee74cfc8255e19167cdc6e96b45a1322bfcfa12532e074ced2b7430519f55", "ref_doc_id": "791fa0a1-ef16-43b3-ae0f-6ce91fcd3982"}, "da8e0de4-6c84-433d-9761-5fa03409fc45": {"doc_hash": "12074e7881269f7f38384a5ce68ca5174eba07c865a1e639c3e9dd55b675c42c", "ref_doc_id": "791fa0a1-ef16-43b3-ae0f-6ce91fcd3982"}, "c75d44c6-e84e-4055-b2c2-ea848ef62786": {"doc_hash": "50fd5814befe39067e1b930c6e47c2f8ffe21c226fe59baf1a61dc01d1e5bfb2", "ref_doc_id": "791fa0a1-ef16-43b3-ae0f-6ce91fcd3982"}, "7ee3a314-1989-40aa-9b96-c8b9f1411aac": {"doc_hash": "ecc0ac95da09447b69e91cd54a6a83fd99738d5728b234572e9acd2135654409", "ref_doc_id": "b1685fa9-c29e-4648-82a8-da69110af002"}, "cf828070-2cc0-4677-8b1c-534450c5d950": {"doc_hash": "4d65775992c190ec593adeedc74f6be63e8792fa6ee8ebc9621f9871b0d00444", "ref_doc_id": "b1685fa9-c29e-4648-82a8-da69110af002"}, "4b2d4ff8-9492-471a-8cb4-40d2a0458932": {"doc_hash": "124eda212ea905559e557da8d563175b50733f461d07ae4ce62edbed9b28cf32", "ref_doc_id": "2d22952b-f353-4fd8-91db-1b3ffbccbbb3"}, "8de11b9f-7516-4ded-9fb5-57391e7ac8f4": {"doc_hash": "1c096e460bd5f4113a2d2e9c8ab95db25cd1c45d9634a238d55a305c8ce25b8a", "ref_doc_id": "2d22952b-f353-4fd8-91db-1b3ffbccbbb3"}, "17f16b38-aaa9-4de5-83ad-77f09595413f": {"doc_hash": "3dc4ff7ef821aede2e6efe2865150263f6cf18ceeeee4d9fc67d05fbc55b9308", "ref_doc_id": "47ef942d-4e7c-4b8b-a31f-63bb4a87272a"}, "00ea1eb8-e391-4f88-a6b4-bc537d8adfd5": {"doc_hash": "f8ad277275acb9f912cccad17fed2f169af284768dd6f0fd5bd6a0627aecdc19", "ref_doc_id": "47ef942d-4e7c-4b8b-a31f-63bb4a87272a"}, "29814bdc-fb4d-4666-b1fb-d625c107489b": {"doc_hash": "117cb50de466011bebef305ff7813a74572e3e725442e21828ecc9b47eefcb57", "ref_doc_id": "623d9f4c-a409-45f9-b87f-6f7ddaecbd9b"}, "64b44d21-bae1-44b6-9acc-2844af51070d": {"doc_hash": "a0d3a11691fe9fb49ffb06833ff10e5cae7c301613a05f9b4ce83075b4ff241c", "ref_doc_id": "623d9f4c-a409-45f9-b87f-6f7ddaecbd9b"}, "17dde553-57f8-4e81-bc21-28d6d7f2e6b2": {"doc_hash": "0e07f849c13f85f6787f7f455b745d484b76e978d1c0985afdee808d76dd5947", "ref_doc_id": "623d9f4c-a409-45f9-b87f-6f7ddaecbd9b"}, "1317761a-85a1-4422-98a7-177ddcec1deb": {"doc_hash": "c67a462069387354f04705a1131eba061adeef3008c69fc30177180d13ab2b1f", "ref_doc_id": "c837571e-9916-40cf-a47b-c5a6832b4b0d"}, "f17949ff-8dc0-43a6-a5fd-be34a19c1986": {"doc_hash": "28148d69ec141214e9b17bf611e18ac4982a1ac73db9a4a95347dc205b279c88", "ref_doc_id": "c837571e-9916-40cf-a47b-c5a6832b4b0d"}, "eb77c6a5-bf54-4737-b5e1-fcaa0e7c80e4": {"doc_hash": "af319ac673aab06b42ebbbb6ecb62e57af051d54f8c05eb0bd14a6c2e0d5ebba", "ref_doc_id": "72fb99a6-8254-4f90-ac5c-2d76702d3626"}, "42f48b85-8954-4feb-9189-4a8bfee0bffc": {"doc_hash": "57983fd73e7d5546bd42bbdf7c2824240186cff03d22d81017693a0f8dc7eda2", "ref_doc_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05"}, "34212621-39e3-4f0f-ade3-80a21c90d91d": {"doc_hash": "51c045131a487632dcd776f0d70fdbcc97853f427bff0d2e0ce436445a3c1153", "ref_doc_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05"}, "bad13939-b66b-41a4-b23c-be9e111d63aa": {"doc_hash": "6378eb2c49032aacffcc46e3be2853472db9a9a70b7bdd8247b2d9a35e966236", "ref_doc_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05"}, "57558293-7012-4cd5-9821-426c725f239c": {"doc_hash": "fb8dd40fb29ef4ae8e6acca94727bfa4c2731e3a5ba1a4ea44eaa999cee1247d", "ref_doc_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05"}, "722b9ab4-79da-44a4-aeab-10320524d0dc": {"doc_hash": "f0aa83709c64a2ced5614b2015ea6d1f6c66e3c775b018e76e1ad50c80c04c06", "ref_doc_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05"}, "88109f45-e2b0-4f63-a34d-6ed6caf26347": {"doc_hash": "ebfb7cfd95102b2faac4a92a289e75eaa4401fd4cfbfef0e863e416a4cf2ee3f", "ref_doc_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05"}, "5b9134af-6e70-4c3b-bb7c-3b85f7cc582e": {"doc_hash": "a7a76b0dd19156d65cd4125634451cc7e1bba50a4f68ea9ea6a6184b96c68314", "ref_doc_id": "21ef2447-58b3-4267-bab6-cba51b47d579"}, "42bae144-5f37-4d0a-8c47-4c8048783e3f": {"doc_hash": "50ee9813af5d14827f7593c72a6db1b8663afedda6619036d95f10e84bbf209d", "ref_doc_id": "084d2857-7398-4172-8425-2506e020917f"}, "93ce8a20-cb88-48c8-9c32-d44d1961ecfd": {"doc_hash": "effe423609fbc00edd50adbb28e4907565b2cdbfab047fbae75901c850a94afc", "ref_doc_id": "edce654c-e12f-4d0c-bcc7-59aab2d88ea2"}, "48991ca9-cef0-4390-9e73-61914c996054": {"doc_hash": "c114b9711bb34d21f1e69b5b98c9c861da781928f73bbad467434ecf5fa27597", "ref_doc_id": "59eaab45-a46c-4d8a-b4ff-139c9d0e67b6"}, "4aa593d9-a568-4d1d-9e7d-e872d4f3dde4": {"doc_hash": "57dee472876db2a8d3be5dd91856cb56769f7a15a14f81ee63dcf9b85b1c5bc9", "ref_doc_id": "0fd13993-78dc-4353-ae98-f0fb5771d168"}, "d7ad1a6d-e33b-462e-ab0e-5da36caf341c": {"doc_hash": "c6b08e20eb122c23668dff1596b4a5d58d68369393ccd5382bcd5e42b5d731b8", "ref_doc_id": "0fd13993-78dc-4353-ae98-f0fb5771d168"}, "05ec67e9-4a1d-47ec-a457-aa3b38fb672d": {"doc_hash": "c598e623d11cdccd2efddd5e5c6123a33ba395e746869f2c293ca9ddcf108d5b", "ref_doc_id": "0fd13993-78dc-4353-ae98-f0fb5771d168"}, "f4387d1e-a498-4bd7-af9f-a3a9da8ce936": {"doc_hash": "743a146a1d6198749e2ae7224ea923e74ba63cbb86a051b94768918029c47561", "ref_doc_id": "75d843d1-6d07-4f24-a0ee-153f1af4f10b"}, "94f03584-1f19-4277-a1b5-672c0747ca84": {"doc_hash": "c25701a2aeff89a492d9385bb74408153987c0b42f55265a7869ef640b5130e1", "ref_doc_id": "9699f80e-72da-4d28-bd0e-7db183ca235e"}, "2947d14b-4d6d-45e6-bae6-b23b37acb71c": {"doc_hash": "bae2c9cc3e9b1d69b9a299aeeca6faa48e42dd6d4b84c7e35da516e2f826bb23", "ref_doc_id": "71e2a82f-ad00-4dbc-b526-5e625a8cda43"}, "92de65ea-3b96-49e8-baac-12ca5dd8b114": {"doc_hash": "7347e35f52d6555c4d5e83633132d66b657891f5c5ba23aba8e773956c6537c6", "ref_doc_id": "71e2a82f-ad00-4dbc-b526-5e625a8cda43"}, "264c50e3-8a9c-40d6-9cc7-8f3371b892c4": {"doc_hash": "e8013a7fef3d4792f7a0279db9f7fd3379995138f18ea1d0c9616e88e0e37726", "ref_doc_id": "71e2a82f-ad00-4dbc-b526-5e625a8cda43"}, "b62f3379-75be-4f9d-8d2f-8e01c77951e1": {"doc_hash": "0c73387449e1dc47b6fa8020a8e09cc630cfcf5cad966dba7ed272361b3b39f3", "ref_doc_id": "6c29441d-7bfb-4e17-9db3-ff323cc3190f"}, "ac0b5851-a26c-40a7-a402-278a6b79a1d6": {"doc_hash": "d40b3ee4f4956d95033310bccff5f34c9aa4bf658eacad37546755aec4d6b88f", "ref_doc_id": "6c29441d-7bfb-4e17-9db3-ff323cc3190f"}, "b1a38a09-07e4-427b-ba62-3532f4b60028": {"doc_hash": "94d2978733a6a1b045bf9cbee95cd80b382d1c4ce78bfd388fcd6eb073d8e0bc", "ref_doc_id": "b9752c92-923b-4765-9c3d-96f24e84b361"}, "d44890db-634d-4ebb-abe7-78bfd1a10699": {"doc_hash": "0e4a977bd99400fdbc7fd8fb18e57768b40876a919a687cef616e2771df02ff6", "ref_doc_id": "b9752c92-923b-4765-9c3d-96f24e84b361"}, "cac91c07-25e4-4b76-a17a-06d1e3e94bfb": {"doc_hash": "2ce79cc820384f64b75173db369498d1c002e4fd67e730d85e9533fb2f0cb6b1", "ref_doc_id": "0193b7c7-e67f-417d-8040-a3fefaca9ec4"}, "bc42ea72-fed3-466e-b723-06a5c83c0faa": {"doc_hash": "d0a5827f986d8923ce5ace93b303a635dfc6adbbb0ad306c4adbd5a5512dc145", "ref_doc_id": "0193b7c7-e67f-417d-8040-a3fefaca9ec4"}, "efebbe32-1f4f-48e1-a6b6-198bfd6bcea7": {"doc_hash": "e16025992a9063694241b789ef7671c0cc6d43a42f65cbb7b10d787c7206cb0f", "ref_doc_id": "3a8e2b95-be73-4d30-8f12-4e89059b933c"}, "c04f0a5e-495a-48e7-88b9-1193615324a6": {"doc_hash": "a3c25663920a3090d3803571a91eddfd06a44d07a03084ff5bc6294669835807", "ref_doc_id": "3a8e2b95-be73-4d30-8f12-4e89059b933c"}, "0c54ea1d-3352-436d-971b-71cb8704e65c": {"doc_hash": "03c3406117bf2a1ae31c7e7a062a6a44b9e419e5764653d2c09ee3f4dd022236", "ref_doc_id": "3a8e2b95-be73-4d30-8f12-4e89059b933c"}, "de8878da-bd2d-4383-8336-0ca7e1728788": {"doc_hash": "ad1bd75d44b9b589a5c4b461ada5558ff9433532af9e18a33654617c32737ab4", "ref_doc_id": "2530a1a9-9ec3-4099-bf86-38f40a7eb25c"}, "22f82111-098f-4b48-985a-3ac462e23867": {"doc_hash": "31aeb681d0b2fa49f757e262572aa944e7210b39f0fa7fbf8ab286e66238f096", "ref_doc_id": "2530a1a9-9ec3-4099-bf86-38f40a7eb25c"}, "df95e599-fb71-4d88-abf6-56bfc8ecdbe6": {"doc_hash": "bb864b7966d333dc7aca491248e025e1ddfc8ef5c8c2a9dc73150aa95ee8495c", "ref_doc_id": "e1cfddfb-e17a-4220-bd6c-f967d79dee9e"}, "167442e8-7ba7-43bc-b6ae-1ca478000af3": {"doc_hash": "4d5fadaaa55a6e49f7f757c892e73a0dc1344e75ae9dae4e62b7598ceef2d682", "ref_doc_id": "b16bfb58-d366-4669-958d-c5e47f69298f"}, "15d58a4e-22de-48c3-a4ce-9eb21f734860": {"doc_hash": "20b09720a7c37018cd8e4b0961e0d730bf9823d88204dd44840a863c032cb696", "ref_doc_id": "1ecb7f8c-c239-4df3-ae82-87934e1785c0"}, "a9eba842-e393-4fe3-91f8-e9c752d2f3f9": {"doc_hash": "9a64b4fb9966be70bfd3ce25f7c181e0dcd885d77abec46c76b656d5d045ef3c", "ref_doc_id": "1ecb7f8c-c239-4df3-ae82-87934e1785c0"}, "c5761b68-d681-495b-bb0f-492ba17cc04d": {"doc_hash": "f7d74c5b4389b85974685f31015a1af030e758f3084f5bc8b46bf892a17d9ca9", "ref_doc_id": "1ecb7f8c-c239-4df3-ae82-87934e1785c0"}, "5b65a6a5-9d8f-4318-b0cf-c8044729cc9f": {"doc_hash": "450f86bc7684746aa6a52a4d128970f08e760e13053c66bc8eab98e8353bb533", "ref_doc_id": "1ecb7f8c-c239-4df3-ae82-87934e1785c0"}, "3c1998cd-03cc-43eb-ba3b-352de9c77dec": {"doc_hash": "556886f0c6a57df9530ea499a024f52639784989e84e17aa53a3771d17a0acc6", "ref_doc_id": "d219add8-5278-4d44-9b97-73c57038c907"}, "58cde054-7542-4884-b924-0ef174006528": {"doc_hash": "84fc8f419414dc5b7e8631f1eccee60aa2423545a2cd5931e43f04318ab3cd80", "ref_doc_id": "d219add8-5278-4d44-9b97-73c57038c907"}, "5c354231-7c0a-4949-a736-05d64b95f295": {"doc_hash": "9191df135c4f4d90d87600633cf86924e0164c5d3901b4c69759633a8672a541", "ref_doc_id": "d219add8-5278-4d44-9b97-73c57038c907"}, "2b13ff52-7436-4cdc-917e-9f373f0bd070": {"doc_hash": "82821470289099a3cd3b3ee05a5579142272f2aab4db6bbbe1ce12aaeed62397", "ref_doc_id": "ed2689ba-d0c1-4c1a-8f3c-a83131b7b4c8"}, "51e52a81-64a3-4952-bd21-6d2837b42860": {"doc_hash": "b0a1eb2329b7583f074171ddaa9660c2bb62c9b060ebe9dc1fb9b4ddc985b1ee", "ref_doc_id": "ed2689ba-d0c1-4c1a-8f3c-a83131b7b4c8"}, "8fa2d30a-64d6-4ca9-ae85-29ac05dc7189": {"doc_hash": "5d77d890b8469d7113c1e07004265d19e81e63cc6ca55ffba943ede09e715d86", "ref_doc_id": "ed2689ba-d0c1-4c1a-8f3c-a83131b7b4c8"}, "567182dd-c3fa-4aee-8d59-d04b12f43a0f": {"doc_hash": "8624f7323191e208b631f9abf8ac93290cef4c7910dda9631abe5d1e96d25380", "ref_doc_id": "ed2689ba-d0c1-4c1a-8f3c-a83131b7b4c8"}, "76f6aa2f-759a-49df-b79b-4d6f82738653": {"doc_hash": "a6196c2b8084984976628107275bfc58eba33ede151f86cbbef2b39a933dec39", "ref_doc_id": "6b927665-04e0-4bc1-859c-44b86808361c"}, "4d477748-3e63-4f44-8ef4-2fad1938f8fd": {"doc_hash": "0608cf6aaa3c89f3b213fc3e475d3019a8602e20910c380f4b2792a29fdbb17e", "ref_doc_id": "6b927665-04e0-4bc1-859c-44b86808361c"}, "f9c8d3ae-dcb5-4d7b-af46-16b9f50b7142": {"doc_hash": "d7a70190f4612425eaaac7841e7e7cc3db40544893153243c1cfbea41d2199ad", "ref_doc_id": "6b927665-04e0-4bc1-859c-44b86808361c"}, "d3ea2e15-f174-4527-8ae5-8a34d7ae1537": {"doc_hash": "1279dd0cf6a18a314df602aaf5557213a68a861eb8490ed5e75049277895adaf", "ref_doc_id": "4c40bf77-29a3-48b9-b9bc-79cd209fb5f4"}, "b3aa4d10-1fc0-42d6-8ff2-de40de46cc2d": {"doc_hash": "8b91c0b79d812642289385884e26fd9e75c8097f54121a9138a263669e8a81d2", "ref_doc_id": "04b40021-cc7f-49d7-bb90-87432bdc7a01"}, "bfe8d8e3-64ce-4474-802f-481be7b5cc94": {"doc_hash": "69bea442dce4edcc18fcef2f1853c111fc84879cc3dab1c38a03c4fefb9d2264", "ref_doc_id": "04b40021-cc7f-49d7-bb90-87432bdc7a01"}, "9fd7eb40-4c95-4ce0-8378-662783b2a6be": {"doc_hash": "14b2b996c0c7584e458a6180b68ee64315deedb60142bcc770a7a8c44a73e439", "ref_doc_id": "be0abac0-92fb-4ffe-a151-21b167412d07"}, "1c5975d5-6841-488c-acf9-45ffe90a459a": {"doc_hash": "7101bdf58d11c1b95b54f6e733095ea78c4e904ef8f9e54308dd68e8caa0fe89", "ref_doc_id": "be0abac0-92fb-4ffe-a151-21b167412d07"}, "f2b4495d-6e0c-4952-9caf-e3e19346851b": {"doc_hash": "a64971f24f4d65185062c3453f8e88cf09a0dd0250519bc4671ceee3b7ac596d", "ref_doc_id": "be0abac0-92fb-4ffe-a151-21b167412d07"}, "e374470f-9d2b-40cf-a3b9-2651e45b0f6f": {"doc_hash": "7d303b6a5f6567fea0b9e1bac97885a8cd4b2f93e9dcd92ff04c8ed02463f713", "ref_doc_id": "be0abac0-92fb-4ffe-a151-21b167412d07"}, "f30d135c-7467-405f-a43d-087fc1228037": {"doc_hash": "d12871d8cd1ddd300c7aec3d77014a86a39953a5caa79834b782a2b7e6101dd4", "ref_doc_id": "ac7bab28-7528-4223-a181-bed58104082a"}, "27878837-c577-4918-a1a0-ae0b1c53f684": {"doc_hash": "df424ea7bfc80467abc2878984cb547de7444f6232b5866f2a1e382ada9b1e3a", "ref_doc_id": "dd97e852-7b38-4daa-be9d-72ada2ff60b2"}, "e09a5fcb-253b-428d-b7e8-ce79cbf364b1": {"doc_hash": "e22e5f11c790efbda7b2d73101e585f68a697f59df1d98206c127feecffe01ca", "ref_doc_id": "dd97e852-7b38-4daa-be9d-72ada2ff60b2"}, "626f1f51-9933-47e3-9fa2-c10549066ebc": {"doc_hash": "93cfdbfa3419e58933ee473b1c9e8199b8fa2a1afc6c95e8baa8eb3acf82893a", "ref_doc_id": "dd97e852-7b38-4daa-be9d-72ada2ff60b2"}, "4eb326b6-06aa-47ee-85ff-a0674a43884d": {"doc_hash": "2cf85fb4b1b3963459536db048480caa497eb8167bd652bac9713efb8705f90f", "ref_doc_id": "68f3d29c-e880-4c5d-b040-652e5acb68ab"}, "12ecfd74-3f96-4b37-b3a5-c3fa66471573": {"doc_hash": "f1d8d4265cc0d272d321d513bad400cb8019031de0195ae39349799696a88a57", "ref_doc_id": "fb9ac0a9-3b54-4c48-bc50-cc8d37ad2ea4"}, "6b9890fc-b5b4-464d-801a-8a2fbccb9a12": {"doc_hash": "2245ef372f611e5490ba5fcfac007b51f18503bb7daf63e8413edf9a0d4ec715", "ref_doc_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522"}, "ccaa2fcb-7363-46cd-a5d7-554b8c45fd0c": {"doc_hash": "09d79721a81d40ddfa66a1442d96d4376a44800fa36ce712a385ddc788e75dd3", "ref_doc_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522"}, "e3e34443-694a-407b-a57f-003f4d782a19": {"doc_hash": "567012b28a459df6c1cf6bbc8e38068bd684ed1e182205581da6c83a9152df32", "ref_doc_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522"}, "58d9708f-89f0-4230-83c2-f5c6321f56ec": {"doc_hash": "efe50a5e469b7f6eec2ac0a553a9f41afc642c36f21abaf8fbe156ccfdabd826", "ref_doc_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522"}, "d95d6df5-7def-4c8c-92b8-ad0582f6b116": {"doc_hash": "68fddbd98307838d3b8a4f9a9ac182f5ea8a79df6a96deae8982942dd4ae18a7", "ref_doc_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522"}, "8f47418a-0c22-4298-8f96-79bf36a6d497": {"doc_hash": "d9ff8c33b819bbe8714aecf9c1a35d5f5d7a27345213ed8da726b4c6c7d9a46b", "ref_doc_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522"}, "8545ec01-1c13-474f-b6f7-371094ed312c": {"doc_hash": "4806402c0d072399e3f4a077c26441d0c392b27905f99a7557e72216d8e21bad", "ref_doc_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522"}, "535c9687-23e6-409c-81b6-1edc7e352359": {"doc_hash": "24a7531ee253304fc4c28855bf09cecb9623a04ce62fbc6134927b7e32cd559b", "ref_doc_id": "4bd6c109-ea92-48d9-ae98-0e3fd54f975e"}, "50618e85-2f28-416a-a626-75e4abfa9cb5": {"doc_hash": "db7791a9f19284c3a3f40850d26b91021d7de29bc8bb0f3222fd24c49a6e3554", "ref_doc_id": "4bd6c109-ea92-48d9-ae98-0e3fd54f975e"}, "1bf98a6c-83fe-48ef-a922-2c9d16bab0a0": {"doc_hash": "1de2c844e3f8b7b5d05189652b55ff1bdc508c190bc4b4049019b9724d4d39a6", "ref_doc_id": "4bd6c109-ea92-48d9-ae98-0e3fd54f975e"}, "0cad90a1-8971-4dc4-8525-49497c5c056c": {"doc_hash": "e423b24cebf632eed74a4b70f4724fca2b1f12cc88542bea6f033069ac323556", "ref_doc_id": "4bd6c109-ea92-48d9-ae98-0e3fd54f975e"}, "1a339394-03b9-4eaa-aa2a-99098db55e70": {"doc_hash": "143811e9108e4c309708ded3f5f64ab901a517c88637b3a869e3915afe4740c7", "ref_doc_id": "4bd6c109-ea92-48d9-ae98-0e3fd54f975e"}, "5127c329-e747-4dc5-8f80-1e58a35e23c1": {"doc_hash": "16f34578596eba01f1c7fd9d1fe0ab484d6c6656c794f1ce2bc5a50c0d502e4b", "ref_doc_id": "75482dc6-110f-4a7f-8d2f-1c589e68b7bc"}, "ad269d0b-e7f4-4fb0-bb45-6a4ac0a5948e": {"doc_hash": "ee699ebe3e18fb5e5e944954574b2f55f24c8ab948ddc7f11550374b61d6a200", "ref_doc_id": "fcd06331-492d-4004-ab85-d4b1e3e04703"}, "ff59811a-ee14-4f10-ace0-837a6996dd9b": {"doc_hash": "f32003a42d6f9ce616a927719649ebc37a2cbc04014d2d6abfedb801bf0fcca2", "ref_doc_id": "fcd06331-492d-4004-ab85-d4b1e3e04703"}, "46f3da86-a853-4441-8736-a97500e059f0": {"doc_hash": "ae248d650a8beb8eb6f8482dbe6e6e109c1e142c96cc12cb551bbd220c4df0a0", "ref_doc_id": "fcd06331-492d-4004-ab85-d4b1e3e04703"}, "823b5796-edeb-42a2-8c24-8feb053f334d": {"doc_hash": "1db08706445997a5792ab8e4cddd585b358ee3c8e92df702002aa0c10d0ee07a", "ref_doc_id": "a27465cd-c293-41cf-ae48-ed9ca95cc6a2"}, "c57a51d6-8a13-4baf-9072-2e0d2e4db110": {"doc_hash": "9289893f247c4b0b0fac2b1c4e2c8eabe6de0043ab47c3bf623c983c1b29b25f", "ref_doc_id": "a27465cd-c293-41cf-ae48-ed9ca95cc6a2"}, "3ad8de8b-b3d1-45e1-b423-c856fafe9847": {"doc_hash": "1ceea6ee61b7a0983849630e73fb7a2544f14d19f48449d59eb21ccd6f7bee1f", "ref_doc_id": "a27465cd-c293-41cf-ae48-ed9ca95cc6a2"}, "11967f22-2cab-4d85-9f54-c852913550d4": {"doc_hash": "1207ff47179e382bd7aa2ba024e8e392906b12ce6d0fd7b9b4654b9cbea8d107", "ref_doc_id": "a27465cd-c293-41cf-ae48-ed9ca95cc6a2"}, "e642a20e-246b-4b7d-9757-a2ff8e038035": {"doc_hash": "d6484a8fae30bc1f3a04d22cca074bc58fa0f2c1e889704823126d437c84bcc2", "ref_doc_id": "b65bfe97-58eb-4f1f-a892-b4c8529c9a4f"}, "55b70490-8214-4461-86ab-cde65dbcadb0": {"doc_hash": "f15a41570376c02f96e851fb8f057797d7e5856e8ae00bdfd6a937337baf8ecd", "ref_doc_id": "b65bfe97-58eb-4f1f-a892-b4c8529c9a4f"}, "fdbc0e1e-b676-492a-b459-42daafbc0a7d": {"doc_hash": "fd8670428abc0cc04ab35fb54844a4e469d6d66f54d0f1c62fe86b122650db26", "ref_doc_id": "f0d803cd-f7cb-41b5-914f-0654ff3d9c82"}, "972f3990-9ccf-4752-b552-ba9ccbafd109": {"doc_hash": "08445dbb58bb6366d878af18e3bda1f535cade4c1df61c6d30c6c40193f806a9", "ref_doc_id": "f2b37f08-3fe3-486d-a728-766ddc4cc726"}, "050a525a-f23a-4688-8913-5a17779de7fd": {"doc_hash": "6e5c29904ad100dfd59b3a3de39fa7d17a6571a6dd959bc5c21250fdb40ae491", "ref_doc_id": "f2b37f08-3fe3-486d-a728-766ddc4cc726"}, "617adbe4-bcf3-474f-8127-39ace2089116": {"doc_hash": "635856480a4fd02d1ecb46f2cefa50f86641797e0877ea123448ef2a6ab8c5fd", "ref_doc_id": "bf436449-e80d-4d33-8a50-2369d1168551"}, "37f3c8ee-5bbe-4106-99d3-7cdf058987d7": {"doc_hash": "ea97f5f12fe72144d328ec0e659366c09ea542570971259c9405eaf5a56f8fea", "ref_doc_id": "f6091f5f-3b99-46bc-92d6-4407be75b727"}, "dff6d655-ec3f-479e-a0ea-f53763cf55f1": {"doc_hash": "bceff5a655c5a2f61be7bdc35003eed80946fb2fb5b7d8c7edfc9cfdba5435dd", "ref_doc_id": "a8f93518-1344-4ff9-a3fa-16c577e1d2e8"}, "6d5b7b65-0a70-43ed-9b64-b29a0205da64": {"doc_hash": "d9957f66ddd5cff30ba9eafed0bde7384b3b492bf6667c523bcc9d0c2a4f8075", "ref_doc_id": "555a4cf3-84d5-473f-a79f-3acd00d6f038"}, "c731a862-e010-46dc-8ca5-4e60b1ac5517": {"doc_hash": "5db8f882aeac7cfe4e667de549ba04621052284c5ba149d441f29ce43e9f2c7a", "ref_doc_id": "9199cb99-33f3-48d1-8f7b-dd1b4d41d5d1"}, "1064f8fb-3498-4645-bb85-d46d125136ea": {"doc_hash": "d33f0863e3e720a6ae026260f64371bf8e29267657b77ede6747db08931b74b0", "ref_doc_id": "d7cf21b9-e632-40ea-870a-c7c33b2a5597"}, "d5092611-1baa-4ecc-bf8d-eb17bbdf8949": {"doc_hash": "eada4e2ff2d4cd74953158dd26709dd34ec71502dd9ade335b67f5ceace108e5", "ref_doc_id": "d7cf21b9-e632-40ea-870a-c7c33b2a5597"}, "e382f51c-15c8-4c2d-aa7a-067581695b2c": {"doc_hash": "0694a72a7b4065ace761d30f633692dae5436cd0fdd7e67b900e3b8e0b19a529", "ref_doc_id": "d7cf21b9-e632-40ea-870a-c7c33b2a5597"}, "ff75761f-a5f1-4685-ad50-90a893ec4994": {"doc_hash": "9fb11d7e7d41e4365526b50b21c10eb8e6530a8d911a53d644dffca0d0f85358", "ref_doc_id": "b5bc249e-f558-434e-9e1e-df01ebb123d3"}, "dff5c957-ba3f-44e6-8018-5af35e4eafe4": {"doc_hash": "683af168a37c4c2649b76a54b385da6ba04ebfa9fc3a421c72a000bea8d776e7", "ref_doc_id": "ec80adb7-1e19-42e1-9c9e-c72304ded225"}, "3bd1e46c-05fb-4f98-bca9-226da59d6864": {"doc_hash": "4a1ba9b9ab8846370b8a789f4467ec850855092f2156cefcdcf994bf46d89851", "ref_doc_id": "ec80adb7-1e19-42e1-9c9e-c72304ded225"}, "e78781fc-1da8-45ff-9e43-3a2ffcc0b9c9": {"doc_hash": "b2e97d5d0d3af932e6bb1ae4ed2792f6867e2e25e55e021eaaecf493383f177b", "ref_doc_id": "ec80adb7-1e19-42e1-9c9e-c72304ded225"}, "0e51e622-5281-4ed5-9e7c-ee256b0cd870": {"doc_hash": "d8b18d6d9122f7706872257c3ca7d939f7d1dcfe72ae74e61da29f107c883d8c", "ref_doc_id": "4ba162b9-7119-44ec-bf12-36b4df557b4a"}, "80109394-815e-4d0d-9fac-b996bb32bf87": {"doc_hash": "6e4e77e5d68360bc1b267ce97b5bad646cc6dc15f7f4a807faaac776f852d72f", "ref_doc_id": "4ba162b9-7119-44ec-bf12-36b4df557b4a"}, "ac768216-94ce-4dac-bcb4-884068b762e2": {"doc_hash": "5756f362817482687e06d10021993717254bfb151baf16a24df2bcdce5840bb5", "ref_doc_id": "76f8076c-b9ad-4ec2-9635-1dc6cac1217e"}, "63e8f198-5138-4b0a-a3aa-79010b05fecc": {"doc_hash": "43c8354f13559a6209340f1ddf81c9adc7e3a8997a61c63b95f48dabf20b2239", "ref_doc_id": "76f8076c-b9ad-4ec2-9635-1dc6cac1217e"}, "4f1c2edb-a684-4b28-8856-3a9f2167a2ad": {"doc_hash": "0bd9724bf54f2b207fdd56e7430548b0dfae47cb0d17b81d071ca5714054025a", "ref_doc_id": "fd4fe35f-8dfa-45f8-b847-a745c776ba01"}, "26eb2191-e916-46a5-98e4-45031a0c1fff": {"doc_hash": "e3ee0b295fb4033a01076c8054251dcf01a80f07fd497bdff3c8d704f36b203d", "ref_doc_id": "983b1bc6-4018-4ca0-bfd3-113a59ba53c4"}, "8aa4adf2-e005-4c87-9b9b-24671126cf86": {"doc_hash": "9dc0b3019764baf2f0b686696e88bdb4bfb247c02b2c999174c1841f383293b5", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "2ec5eb91-5404-4770-a1a5-8014b7e7462e": {"doc_hash": "b323155a69748d42e5e9bd2c9907fcaeab8588af93f56ad7d3044a81c405c76d", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "aee77904-2308-4c50-aee7-3e5f34733775": {"doc_hash": "4d0e56acd15a51813127ba5878e6627df0941cf6caf774ba9354c3ede742e51b", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "78492376-95e6-48a0-9ef1-fccf05210c39": {"doc_hash": "a678ccecc63b9653a6e9e5fcacb829aa87ff7b1caa1e08bf35d407a8e4d21bc7", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "9904175a-c176-4865-b351-0937385ff585": {"doc_hash": "a44b24bea473c756f63f8b1f50d86cb02062861013048a1d251b9706503677fe", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "c9288313-8d43-4391-b88d-d0da6936e659": {"doc_hash": "4cc6b076cc0c4eca50e6fa65c2a1e128519f8523735e8f403a2917d52b28a438", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "665147ae-3561-4525-8f05-9b663d6ab100": {"doc_hash": "ce4d764376e109242007f1a7c623595ebf695934515ba892886681ab9001ccc3", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "14828b4d-172b-41f4-a157-edf69c5aa1f4": {"doc_hash": "af97d4b37714cca975438d71209f9b6e1c0098e8c658ed9bbbb332669d91486d", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "f5d7a17d-317a-48d2-9811-d34ac0e3cbcd": {"doc_hash": "6fefe6996fd8d605304931121aafbebbeb50a669e735fffcefcdb288476d79ec", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "14329a39-a8ce-4e09-b601-1a030712231c": {"doc_hash": "e0aff4b2af9d548507d73b596804d53288ba3f4b7a3538151d5cb1b02cfb4551", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "baaf14ac-e422-4f6d-9b74-784c9de83cd9": {"doc_hash": "30464f6086fa7d4b5feca3c8ae178de07a48cd776f4031b1b2b1373364d66def", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "47fbfd2b-4015-42cc-971d-e80526624410": {"doc_hash": "18ae73cf65ad9eb98e9e396153dbc2bf2075ab6209afd763276fa251f824cfcb", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "5dd945ec-caac-4bea-890f-d957b06afab4": {"doc_hash": "df28d8085f6454cbb4fe6c3564c5ee4cafa503c1c2f2f7bbb251f9e8c8021ec5", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "1ec36c44-efd8-4074-b387-f3669a040d74": {"doc_hash": "4f29171de493a59f20115f77fa7d8335d595c6558c9be1c493ac246cbffd18d6", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "3aab2fd3-0120-4047-b597-e7dc7c2ef2ee": {"doc_hash": "6d6800891d88b9abee9800582e87739368c8c202abb49fa9b9212a8ad005d81a", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "2a97ee66-bf37-46ee-8b8c-21c743c0d9e3": {"doc_hash": "609ac4035ba3b396057d2eacf7c68084d5d598e1efe377444d9b0d0740c2e240", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "59d02ba7-2070-45e1-afcc-80a07f36fee4": {"doc_hash": "fd9f78f749dd07e04cf302d6ddd6c64f07b626fa03671aedf31e46f198a03568", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "3440163e-8445-444f-8a86-b53231b3e1ee": {"doc_hash": "692795c28ae31608cef725b6bcf4b84a0e30a2e0e73e5c7bd754997e6d6228e3", "ref_doc_id": "2b3e410e-1735-433e-a26d-6a0b0734a659"}, "a4d27306-85ce-48a5-ab38-7380e28fbfee": {"doc_hash": "d6b4371ba72ad18e7a439e533f7bce70e8e86a42b3ea5cee3cf7ac9718fb8679", "ref_doc_id": "9ecd1dcb-1da9-40da-a8dc-3035678caead"}, "52023b49-1775-4d7e-903e-d12c8f382c55": {"doc_hash": "5211a7a46b1361f834e3f234797645825ccd7815c8f6dc9c1615e72adf61458e", "ref_doc_id": "80514101-fc7f-4fa3-a6c7-0e720faa8681"}, "edc65b51-e3dc-4165-aa16-6172afdeb09f": {"doc_hash": "3db46f196eef5b41f0a363ac4ba7b2d4dbfe4695a3e4fa0c6b5670f803a1eb9c", "ref_doc_id": "f7089940-ac3d-4982-813b-0f1f9fcbfce0"}, "128663cc-5953-43f4-ade9-e35d8bb51cc3": {"doc_hash": "20319efdb108253aa57b1a220a09a06cbb98df7f71501b75f1c5bd8e26f6e761", "ref_doc_id": "f7089940-ac3d-4982-813b-0f1f9fcbfce0"}, "5cc9bea4-e150-4c2a-ac22-139eaedbfdfb": {"doc_hash": "a8cba2a1be2cc206a7998235d0a40009b0de83853f791a64e0c5bf831704352c", "ref_doc_id": "f7089940-ac3d-4982-813b-0f1f9fcbfce0"}, "c94c0747-d6b5-44db-9ac5-b808d103ba9d": {"doc_hash": "9248ce578a62f4a2bfed12cbf29202eb392494e03b660a7524c5f70eb11e6973", "ref_doc_id": "207e6bfc-4554-4ae6-90cb-19f777c30ba3"}, "c76e7603-27d5-4bf8-8318-fdb62264e15d": {"doc_hash": "fa7107702b18fd7aae1c4f0c1c6eb32daab6ef3a7e3e25fa2786217838f96d5b", "ref_doc_id": "8219d331-a4fd-4480-b5d6-b507ede38e0b"}, "c46dccb7-53e8-46d0-aab6-35e0eab8e048": {"doc_hash": "8b0796ae9ce74f22b6a31c12a0c82fec598236434109e081ce45c56081f72be9", "ref_doc_id": "d1408d73-ee06-4439-b14c-1dab77a38edf"}, "3d4b355f-6ec2-426c-805d-53a56706bbc3": {"doc_hash": "4e38e9b1616dffe271b224dc2f85235911a42bd9b8f05d01579288eb85a11bbc", "ref_doc_id": "d1408d73-ee06-4439-b14c-1dab77a38edf"}, "8d391dc4-45c8-4ce2-bf79-a8b5c3e7cc2a": {"doc_hash": "66b376c48efabd0bf541faeda1a66602c26fe1bc399221e241d3f441b798c6e6", "ref_doc_id": "d1408d73-ee06-4439-b14c-1dab77a38edf"}, "23e36d55-b747-40e1-9217-8b34ad32c2eb": {"doc_hash": "aa97c3d512bfedf6d29bd0c02d5f7b9e8b4a4af4de3dade59c2e8008614309fc", "ref_doc_id": "d1408d73-ee06-4439-b14c-1dab77a38edf"}, "3d5381e4-212a-4b8c-b84d-433093088c71": {"doc_hash": "e399a1a07a4c2ce5cbfa43ad300602993d4f23c8a1f27dc1225aed729278e3fc", "ref_doc_id": "2aa4c010-8271-4f68-b5ec-f2d43ae8ce3b"}, "a2c5f4a4-138c-44a6-b598-d6580b1cb954": {"doc_hash": "c4d1af2cd6eda851557e2957eadfe60b9a86d7b5ce3baa89fc04d9273ec631de", "ref_doc_id": "2aa4c010-8271-4f68-b5ec-f2d43ae8ce3b"}, "6b44ffbe-6515-4a6d-ad59-88fa05b4ee82": {"doc_hash": "f128da24d693ea10d6893184bd5b96a57075f91b9511f3f240f841a9c21a9a26", "ref_doc_id": "2aa4c010-8271-4f68-b5ec-f2d43ae8ce3b"}, "8ffd2447-76ce-4cf2-ba91-08447d0805c0": {"doc_hash": "810c080a01ca227fdf6ea00932db075a10101705f63677b65d9933ab29a6ba0a", "ref_doc_id": "85e1f88b-9db1-4d48-a6eb-f6da51cddb31"}, "a16124ec-0ed0-44bf-b9d2-de7ebc02735d": {"doc_hash": "472dbe38272bbcfdec7da86bea57427b1e3787e8ab0e6ad82d1cb5832b1bd0b2", "ref_doc_id": "85e1f88b-9db1-4d48-a6eb-f6da51cddb31"}, "7fb646e6-21c1-4899-9802-0c9412a64966": {"doc_hash": "2f3a43a38a384b2a5ee4f70c833ce486cf74549de4cca2d102b1dfff2c4a939e", "ref_doc_id": "0b825a90-3ed8-40a4-af6f-a23526a54c6f"}, "4f76b6ef-7f7c-493b-be7b-93e232b1fcd4": {"doc_hash": "35134680e69e5ae612106959924367330c160c0023ee1953353caf2d5affdc85", "ref_doc_id": "0b825a90-3ed8-40a4-af6f-a23526a54c6f"}, "fb4a4e92-f9dd-43ce-a6b2-afcb3558b99b": {"doc_hash": "997d815b0997f2edaae519a68d5f20610dbfd7c49adea68fdbb3e7911f827d3b", "ref_doc_id": "7edff531-f9a2-445d-b3fe-fefce6ea1469"}, "45a01ac8-94aa-4c16-a48b-5d10fff9b419": {"doc_hash": "eef5ad23fd705d6e6b8943ba5ddde9388c5e93956c13a1964b53fccb0ea2238a", "ref_doc_id": "7edff531-f9a2-445d-b3fe-fefce6ea1469"}, "3f2f0192-39ad-4774-933b-ecc2764025e2": {"doc_hash": "7b77fe33472d3a43aa75652d1e6322c69f15f398442d8ce816bc9d19304218f9", "ref_doc_id": "ac39ce31-2917-4938-b1cf-f30ddf5ecc5f"}, "33a45088-0f20-4977-90ca-42d2a7f1c529": {"doc_hash": "3c621077e2bd7bbf115a079df019b7b9437b7171c06280e4c68bf06c431d77f2", "ref_doc_id": "ac39ce31-2917-4938-b1cf-f30ddf5ecc5f"}, "822e6fb7-c7fc-4eac-9a0d-cc9c23b04f41": {"doc_hash": "b0312dedcce5f2bd1ab414ab786eafcf650979732c7fc292067a11535847ae41", "ref_doc_id": "ac39ce31-2917-4938-b1cf-f30ddf5ecc5f"}, "5aa919ed-a38e-4f99-abbf-6e07b90a2182": {"doc_hash": "8e7bb1c593cd00d15fa1079dae53869ff40164fc7c7f8cf25230b64662002e4a", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "6411b1eb-46af-4b3e-a973-a2f90ab73c1d": {"doc_hash": "13e6fd1c41bc68a4a7cf9613b0c17e1acfc26c565e1b6623913cbe7fff4bd8ad", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "22b5a32d-774a-4ea0-ba7e-02673c6de0ed": {"doc_hash": "c8603f4858017d1bfd18e20ea620fc05f85c440f9d45f0521702c2df59f76d4e", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "a3a14f9b-75f9-475a-b38a-60beeb16a1f1": {"doc_hash": "bc17b1177a04f73e989f59e802ddeeb1129e1e4ad7f5255cf7a9de0c32f8a5ed", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "b9bc750d-75e3-49a8-b720-3fe1666b0ab0": {"doc_hash": "09a9dc1a5fe77657783830c073a518f14b62dc320b4e192404a6f5edd159b5fb", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "61ad2d53-ceae-442f-9aab-e83024058f1f": {"doc_hash": "216e436796df96909dd15d93c350c992648f5ddadc0abffb8ecec622f6ace161", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "24cfde90-aef7-49e4-aa14-735c1399d06f": {"doc_hash": "86f855a2289ff545cfb01620f870cbfa34bd0bf86961677a57de857aec6a3a74", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "1a15d8fa-3213-4717-97ee-3a00a813c5df": {"doc_hash": "30815973054dad731355153d565f6ba14ea21064d94c11ac64506ff53325cc3a", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "c30cd625-1ceb-40ca-a927-d240e4203047": {"doc_hash": "a7cb3e356513830472311ceac8aabef662263237b5660bee7f8a2f28e5aadf62", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "907b793d-273e-4925-a483-d1868209a391": {"doc_hash": "5b68bc42ed93ff9bd2154af429f5a3354b55ea90eb888c237c4b9961eb8621a2", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "172ced35-d90c-42d6-b58c-301018821d3f": {"doc_hash": "db3f37fd65d31cff6b3d62cf188b91a35dc35729844d42e45e35a076b88ca3de", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "56aed099-8241-4ce0-bc2c-a199c635ac21": {"doc_hash": "f58d4024898d6c4b5bab47046933133b393501551ddfe918d88098917114dade", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "262c8b90-f76b-4006-a322-4e07d3446f4b": {"doc_hash": "34ff0818c129ab7d9a1f1d8383eede78a00aca8de260faaa6b74f774bb135d1b", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "befd36bd-acb9-4a23-aece-e7f1d077b9b1": {"doc_hash": "0f8fe6aa3410679fe513a1aa417c784f6c2897b0331ac99a11d0c1ab7284b873", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "fcb3aeaf-f895-468e-a379-f70ff91ace81": {"doc_hash": "63cfd52bbb8411af8fbd7be8dc6f81a3a6812a6555601007387e50ff1ce21b4a", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "c7a18404-9c81-49f8-844e-4fb9a5c486e9": {"doc_hash": "74a50dce4bbb12d6fc25b79e1349e0d71b5101410aabf9dabb436651654c178d", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "eb4630ce-dd89-4cf4-accd-8d30c2f1a1e9": {"doc_hash": "2fbf557398b0a69b6c8409e998897e76e0a6ed1528a232c13bacaf74a0f3b9ff", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "d479f69b-3ded-49af-b22d-3f26cb9e53a4": {"doc_hash": "ce2e313a06a4cb754e52219c56e9b20669e11439e125eb0415d61ebc20ba14ce", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "a5fa4e16-cd42-484d-8dea-35f7f0f82e19": {"doc_hash": "8dcafe540413a7b1b5eb74e4239ccd53a80ae21c8c0121a1233d437d3fff6b38", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "a617a3fd-f0b2-42c8-a192-ed00c56ecde2": {"doc_hash": "8a53d08eb091d496827d0a5caef5b82f5bb16665389942edac03e91226f523ee", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "7610e168-59f1-40e8-9dc0-a9df04ff6b02": {"doc_hash": "e3b969555f9fd3232400696df78b80cee66ad033cd69971ba0de2d3686075ff2", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "88ff1c6e-35f2-4a26-8498-a3c3988707bf": {"doc_hash": "f13e2137e9c9f74ebd9d3e2c3608d99589bc8aeab425c31533d85b002e120831", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "dfd05c9a-a89e-447e-a544-f282e7a70f67": {"doc_hash": "7a0d327e0fe28aaaf0fdeae3146361ab07a57e24ece9774f6c350ef9d0e973e3", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "966b4781-46ee-4852-9c93-2eaf2d232617": {"doc_hash": "eda2a3520c931ce3fbb16eb279daafd20c369dcd73af562c9d191e6b5ea0acd1", "ref_doc_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb"}, "b1695045-39da-4a75-85b2-b835db9a2906": {"doc_hash": "59c3a9978f8feddfef2e8ac6537c7cd65f8ed1daa51f881cb8758e0a1b6dab47", "ref_doc_id": "a4138d34-acce-45e7-afa5-70ee1e20901a"}, "29482fbb-00b7-4ee5-9ece-882b657de04d": {"doc_hash": "8833f2898adfa76f23311f03a61b890fd82f97efc3d505e970404c5cd042306b", "ref_doc_id": "a4138d34-acce-45e7-afa5-70ee1e20901a"}, "3a6c2027-d621-417a-8be8-8f2cff9f6992": {"doc_hash": "4430a96c3dfc3d9387bff76c335693bc11a61606e29adb314afb6857488a4e2e", "ref_doc_id": "a4138d34-acce-45e7-afa5-70ee1e20901a"}, "1bfb7cc3-a107-4076-9524-2ff8631ca224": {"doc_hash": "3563f99f64f327b8d965ba2c1da5d07a6ace8deb1ef1a5a50df1cbf89d12b20b", "ref_doc_id": "a4138d34-acce-45e7-afa5-70ee1e20901a"}, "891fa1d1-d13f-4c4a-96e4-9d26c0224e77": {"doc_hash": "e24d846a3e358a343a2723a1eb50d2a1762ad5bbfb184e897470e2bd10935f5a", "ref_doc_id": "a4138d34-acce-45e7-afa5-70ee1e20901a"}, "ed781b74-f00e-4a36-a9fb-130e1bb1e340": {"doc_hash": "8ff4f0b71f583e55f5ba2f95ddfe2b8a1b452f5e8b84bd9bbd0311ff36d8751a", "ref_doc_id": "a4138d34-acce-45e7-afa5-70ee1e20901a"}, "c485acb2-0b63-4fa8-ae9d-e407b2a9e7da": {"doc_hash": "39d275a42180da0655bd05e1bc6389a7da02b7396f178f30a513b17d42b260e6", "ref_doc_id": "661e34ff-e65c-4e69-b3b0-898ffbc65201"}, "9c94e055-f57c-4d60-b19c-da2f8dd7851b": {"doc_hash": "13cbad7e9f31c874992ff43566aaf9edb46b327bbb7cd77af7a10f4d3affaef8", "ref_doc_id": "661e34ff-e65c-4e69-b3b0-898ffbc65201"}, "e905bd8c-c552-4268-9c12-a27839f69421": {"doc_hash": "bdaa1a821a6c0338e466d1c9514a7e5248c5fe30949836aa33d7da8252a3b016", "ref_doc_id": "661e34ff-e65c-4e69-b3b0-898ffbc65201"}, "f3e62a9a-1886-4619-845b-b95b29804058": {"doc_hash": "44a19c528e72af67a60a9f8cbe3e9c3627190e902e920cff41cc84b8a7f79be7", "ref_doc_id": "661e34ff-e65c-4e69-b3b0-898ffbc65201"}, "0b8503dc-0335-43a8-947e-6175105c4def": {"doc_hash": "dc8dc9175569f9954eb3c4c682ec043f6e2a38cd1d3064cebe39b8dd2d0a463c", "ref_doc_id": "6e414818-2def-4da0-ad7b-2083240dafac"}, "8dd9050b-29f0-454a-b5a7-555d98abe524": {"doc_hash": "3420a063dd2f5b023079eafbfb1432695a46418829ebc45508c9c978b7499c4e", "ref_doc_id": "6a3e6291-5b9b-434d-a8a0-9fb83d3eb662"}, "9c738ddf-68ae-4f34-920f-aa34cf9b7294": {"doc_hash": "979df02b0633eb98c8749ab2f6ccf9e01aac56773aee6100bb25f0b0f3b27846", "ref_doc_id": "265ddd63-d8e6-4210-820b-0bd4e7797745"}, "cc0de57e-eece-4650-a46b-82a7c2fcbf53": {"doc_hash": "1ca0aaa0787dfd8a5600bf89a766412999992c5887c5004ddedbbe8a68c71467", "ref_doc_id": "265ddd63-d8e6-4210-820b-0bd4e7797745"}, "2169e8d1-ead4-4c44-a547-bd8fbe8ecabb": {"doc_hash": "ebce6f92b73bf6b46903bd9687c1e03b75004fca0cbf921c7a31ddbf03b4c578", "ref_doc_id": "265ddd63-d8e6-4210-820b-0bd4e7797745"}, "6d79fa1d-5938-4d1c-b749-19b241964f33": {"doc_hash": "b9e72ded454b99388be51e54317e417b0b4329fd8259289c9b991c144f7945d7", "ref_doc_id": "265ddd63-d8e6-4210-820b-0bd4e7797745"}, "c925a0f4-71d2-48ed-8d25-65722cd3d060": {"doc_hash": "434bb623aef3f3658c2000e8d1d9e533b66f83699a55d61c47f6398fd1e5d52a", "ref_doc_id": "36b75554-8723-460d-8ca5-cac6322fbc27"}, "5dab1c3d-e65e-41bf-96b1-eddcfe8b1c62": {"doc_hash": "99cf628916ba5c96a1c022f9005008ad5f4a6f35de044c5e226f0e29b122893f", "ref_doc_id": "29096612-3ffa-4ba9-bf73-48fa3f45b354"}, "d77588c7-85fa-439d-8997-a804e99feba4": {"doc_hash": "b75e05a1a7f5dfc45f54980cb4ccea85b42e2edfc51a6c9a57f7af10bd41ccba", "ref_doc_id": "29096612-3ffa-4ba9-bf73-48fa3f45b354"}, "88399c72-a630-4786-ba4b-b3e32f649cf1": {"doc_hash": "6269814eaf34359b5503fee6cf0e239d6bf7f14b442286eeec1038a240bddecc", "ref_doc_id": "29096612-3ffa-4ba9-bf73-48fa3f45b354"}, "64e51d6e-4ffc-4ea4-b91c-5ad1ec1a369c": {"doc_hash": "ac8666e6b26007bc4f5d64bebf78e2cd3822ab6169b9dadf3bd558f4eb55a359", "ref_doc_id": "29096612-3ffa-4ba9-bf73-48fa3f45b354"}, "b465b2ff-9c61-4d97-8063-d3c5ed4b35a4": {"doc_hash": "d76dd36d2546612e4480fadefb47d2e9e344057256168c041eb272c8853b22f5", "ref_doc_id": "29096612-3ffa-4ba9-bf73-48fa3f45b354"}, "899b9843-5ea6-4d19-a410-bc15e0287219": {"doc_hash": "640049eeb8f5ec2ffbeb996b35aedbe43b49ad26867d91de387de2a47f419059", "ref_doc_id": "f52fd3e4-756d-420f-8950-efc855d6dbd0"}, "f64a07c9-f79f-465f-8d1d-4924f23faba0": {"doc_hash": "3557265cf1ffd8b231a175799098f76544c079b312efdb8ddc295c6a1c929696", "ref_doc_id": "342b7401-f2f2-4cd6-b4dd-bbb4dda0bfdf"}, "66c84286-d684-4570-a1a4-90b93392e8c9": {"doc_hash": "ea5e89212abf524cf142c7e0deffea3b9f1b62f7488df0d8e74243684dd3a56a", "ref_doc_id": "6aa7835c-ff39-4440-a414-2c1e18f53662"}, "dc845597-b1c6-428c-92d9-279e6c8fac92": {"doc_hash": "0655ae46ace406496c115b4251ec800deab5ffa5e964be045f8044c0b3a7faa9", "ref_doc_id": "6aa7835c-ff39-4440-a414-2c1e18f53662"}, "f5ff53c9-cfab-4e96-8447-22f1155b0b72": {"doc_hash": "1485ed09ab5c4b6734509d105d1e35e0f368b2cb1657d6298efc8736543fc33a", "ref_doc_id": "2fc296be-32a3-4c53-b5c2-39397423556f"}, "c2cea6f4-27cf-47eb-83a1-fcec31bf95bd": {"doc_hash": "8a01a2641b4e6dc37a5a8330dbd6361152451f0eb0cdd2bd2d4fb02cb1e50783", "ref_doc_id": "2fc296be-32a3-4c53-b5c2-39397423556f"}, "3e59af38-1f60-46fd-9b00-dd90735f14fe": {"doc_hash": "40938c10caa25cae4d993746652a6025244aa0880076fa6cc62d031e5165ca57", "ref_doc_id": "2fc296be-32a3-4c53-b5c2-39397423556f"}, "5dc10106-0a8b-4123-8bbb-b8654d935765": {"doc_hash": "68843e8e2edc0542dcbeb9887763b464f0675e818a7dc049b6f95122ba1aa0a7", "ref_doc_id": "935ac8d6-1523-4919-90ec-9902cbeaf7b6"}, "fd8538cc-76ef-4e3a-a400-5c9bb566d341": {"doc_hash": "1a888f48b6d0f038b59218868af3491e7e9f35cacc2d9ecf71f9167d304a4f03", "ref_doc_id": "935ac8d6-1523-4919-90ec-9902cbeaf7b6"}, "22da6b71-621e-4217-8a47-806f03c4a510": {"doc_hash": "a4a765015a8501095ec0a62207b36fd765f1b0eb806ff3897c6aa4c44605de04", "ref_doc_id": "935ac8d6-1523-4919-90ec-9902cbeaf7b6"}, "004ccd63-afda-43bc-b998-5203a63edf27": {"doc_hash": "aa4b4b449f18e3a043e4424f9b247a6682710ff6e7c1c55ee06780e9ef4096c9", "ref_doc_id": "935ac8d6-1523-4919-90ec-9902cbeaf7b6"}, "2ae11cb1-095f-4fcd-8138-6a952b249a1c": {"doc_hash": "550bda7fd91b0217e03cfee11f9552c4aa3e6ad3f9dac8111b97327d09dcf8fc", "ref_doc_id": "10d73805-bb4f-40cc-9ba4-4e5389a4629d"}, "5aa76912-85fa-4943-9707-8a427a2db18c": {"doc_hash": "4215f6415cd8d4495d16295e94873d722d08f69d8d55208761362ad2dcb3bae0", "ref_doc_id": "10d73805-bb4f-40cc-9ba4-4e5389a4629d"}, "6a1de7df-ecb1-48a5-81f2-8ec326ec5c0c": {"doc_hash": "c102c57669f16c4c0abd5d6223e354b29a356314754146826bda8cc4e95fe20b", "ref_doc_id": "11648e8a-5b5f-47b4-a171-042f18c322a1"}, "7ed8104f-dab0-4781-8a99-9bbc91277315": {"doc_hash": "a3b5c7ec5edeb1ff485ccdc2b4b62370aaa609aa06e2e2dc3e8ceab359d556a8", "ref_doc_id": "d33ca55a-61c0-4c93-a37a-7ab825660ef8"}, "9821444d-aab9-4174-b47e-3c6dcb776dfc": {"doc_hash": "7e090890b043f04af9badaf6c48ab273d2ef223395e7c39371d2e27f26b2092f", "ref_doc_id": "d33ca55a-61c0-4c93-a37a-7ab825660ef8"}, "1dee5a99-3ded-490a-bb9e-6f8d0907e38c": {"doc_hash": "bb46461f32c5dc1d96fe2ecfcca5e8fcfe034566b2625e8a098830edad5c7a4c", "ref_doc_id": "d33ca55a-61c0-4c93-a37a-7ab825660ef8"}, "0b92b392-c6e5-490c-b136-8c0c48e38e45": {"doc_hash": "fdd61c9c6b4a92e54920ec70aae6d1307ecd4652a0d038122e2681d025fb795a", "ref_doc_id": "d51e5ac3-855f-4c59-b6cf-89ac2dacd175"}, "aab679ae-2d69-49e3-b716-ce9f6d3dc64f": {"doc_hash": "54c667235a395da80ed10a6d309ac8a3f9f2c0ac87e25b72898efda5963ac8e6", "ref_doc_id": "d51e5ac3-855f-4c59-b6cf-89ac2dacd175"}, "6f807265-4089-41cc-9dc2-416a200e46e5": {"doc_hash": "3a0c1d073ffe55cfcc031d2e5e1a695c97672cbebf64d6b1ffd1d38a5614a323", "ref_doc_id": "9f0213a1-8b99-416a-b97e-d6f73804b606"}, "e82e749c-541f-4f2e-8aec-96ded845d24a": {"doc_hash": "36eb52b5c1b698de16fe871f861125a463079b3f6721cd72c9cd13d1a76bd5a7", "ref_doc_id": "f6f10c33-48e1-47c1-b2d0-39873e999a6d"}, "6fdbbcca-edfe-4749-ae67-a6de1bcbc3d5": {"doc_hash": "bf7036dc22d2d1cc1e8b14fc3d328d8cc82ccc8ef7603d2a1465bc50a1e00bae", "ref_doc_id": "76dd1381-3d9d-4f76-8d0c-54637b99cecd"}, "78e39a88-8c05-4570-b0b3-58c4e6b60119": {"doc_hash": "41bb2fd2f22a527c18106172ece5c452cd027f270079274ddf75ae07d242a83b", "ref_doc_id": "76dd1381-3d9d-4f76-8d0c-54637b99cecd"}, "753424f8-e4b0-4b34-804c-41959cac64e1": {"doc_hash": "32b9b7c4712b96d3c0a3f85ab12a9445aa6ecfd847ea741313305933eefc3099", "ref_doc_id": "76dd1381-3d9d-4f76-8d0c-54637b99cecd"}, "6d0df27e-e863-4c3f-835f-291dfd167e1d": {"doc_hash": "cd35a60e2252c5f618df13fbb0445fb8c8c74c148a34e027f7570d6def2aa307", "ref_doc_id": "76dd1381-3d9d-4f76-8d0c-54637b99cecd"}, "58aa4eb7-4dfd-4d67-9bfa-116cf705c9b7": {"doc_hash": "6d366fe1d8e760136eca55c1555cd58ffd66db2bb47df625b16efb4c71b28e5d", "ref_doc_id": "9851deb0-e7de-4c86-b544-d9521b2fdaff"}, "72cf6043-20f7-4c2e-a9fb-f01ac41350ce": {"doc_hash": "fcca4f2c4b00322f273f98db2d2faa23f64a1d72d3eaf4aade390a7e01f791b6", "ref_doc_id": "337e53a3-c540-47f3-80f9-6c691356ea9b"}, "331b9e8e-7faf-46b7-8089-85ecf84b987c": {"doc_hash": "58e61c7839d3bea0ad7d9e72555612c23df32b3294d7c96edda17b5684eebdc5", "ref_doc_id": "d357f2a6-8e6c-4e2d-8856-fd2c94d167e5"}, "bb62e80f-4fcb-4491-98ad-0364206f5422": {"doc_hash": "f5aae99f7549a788e620f5f69c2c30cdf742e8aa6f43ff3f3b1f6125c979913e", "ref_doc_id": "1b38f269-50a5-4c64-bc9b-83f445d36732"}, "9ab63a13-8876-445d-8941-e45035b6327a": {"doc_hash": "22328afdc3959701105da2cb16a57de170294182abad4cae9d5eafed3be3adcb", "ref_doc_id": "20d69657-d22e-4beb-8e97-03b91bc9ed8a"}, "aad0558b-391d-40d6-bef7-25a9b68ef48e": {"doc_hash": "eef3485cdda1256113feac908c8bfd98a5ab3861fbde5b67549f4eddebbab6c8", "ref_doc_id": "8b235e2c-da4f-41a5-a1a6-3217968dd14d"}, "612f0646-d7fb-4826-929f-d504f68d2439": {"doc_hash": "c2ca5adfa1e5262348ae06a8cff0156b90f1b386efa54761a5b14b58e71f4bc5", "ref_doc_id": "b257e43a-66b1-4df6-be67-3150de4be004"}, "4b9b7d8a-c51c-43c4-af6d-e596e33cf7c6": {"doc_hash": "7f65dca6ca774d8d5ebdda803d62938d55453392f857834ff26870c8690a02d3", "ref_doc_id": "b257e43a-66b1-4df6-be67-3150de4be004"}, "c6ed794f-96d9-418f-9360-1c5d2f670019": {"doc_hash": "483bb40fcd1a5cadd9a1cb29553687886ec3a2286adc5f3bb75b7e1cb8fc5f6c", "ref_doc_id": "b257e43a-66b1-4df6-be67-3150de4be004"}, "3876ded9-df10-4f8c-8f59-ecbde9f99020": {"doc_hash": "8a756234ade488938e967c85fd481d2daee6b1e92d68e9908661fef473c6c041", "ref_doc_id": "b257e43a-66b1-4df6-be67-3150de4be004"}, "7d7cbdd7-b024-4630-96b1-79a833222298": {"doc_hash": "4bd938f84d26858aa39053ac90aaf0c800d82b5c288b0e90bd2b7dba341b57d0", "ref_doc_id": "b257e43a-66b1-4df6-be67-3150de4be004"}, "a0a8dfa2-2daa-4c1e-a72e-1185c486fe96": {"doc_hash": "07b51def1e43ba7d611c7b98635a33d64ef6e809cd297b36a4fd877f56be2bad", "ref_doc_id": "9708101b-ad08-43dd-85ef-86d69891d93b"}, "802d2599-9478-45a3-943b-5614bdd226be": {"doc_hash": "3fe027ed5e39adf35fd46cdb2cd1c942250034ecaf24def9e542aa2b075ce3d3", "ref_doc_id": "08098e45-63d2-47c0-bb1a-f63a21099f39"}, "46b0b898-3aa9-41b1-aaac-a781b978fe8e": {"doc_hash": "782ef5d977773df9a8b173f4aa8423a21129b21d548f70c5f9299d9405afa0d8", "ref_doc_id": "08098e45-63d2-47c0-bb1a-f63a21099f39"}, "7708cbed-c46d-4a56-a1fc-d8e23b1176c3": {"doc_hash": "e21d09183a321ec2d51526711ebb339b18f78f6552ecdccd3054c8a567beacb6", "ref_doc_id": "08098e45-63d2-47c0-bb1a-f63a21099f39"}, "f7bf6631-3fc8-49e5-b814-2c63e2d1f3d2": {"doc_hash": "bdb0c4d84d0f133a799084bf53af4cac0bde300430e4b550b12b5f3b7e8bc4bb", "ref_doc_id": "08098e45-63d2-47c0-bb1a-f63a21099f39"}, "0829a6ff-388a-4a41-bcc9-6f95268b9ec8": {"doc_hash": "6a82cce84977540d20bad13ee3092c0e2125f18710ae72069cff7d97a7e49849", "ref_doc_id": "eaeb5440-d56f-4082-bb26-6804bd20272e"}, "f24f80f2-9c40-4692-a1cd-cd0f808ef38a": {"doc_hash": "5815fb778ad33bb9dda205376c363702267694f785852b759e5fd97d6ee180be", "ref_doc_id": "eaeb5440-d56f-4082-bb26-6804bd20272e"}, "7bddda63-87c4-4d0b-b0a0-30163f361c4d": {"doc_hash": "6f0b88c7c205b55e36bd5341e163c7966ca1f4fbf87450d70f624697059cdce4", "ref_doc_id": "eaeb5440-d56f-4082-bb26-6804bd20272e"}, "f964a7a5-c70b-43a3-bb14-178f0578b850": {"doc_hash": "f808b34ebef15526da552df65e9db6194976398ab521f49ab46f5c27ec54182b", "ref_doc_id": "eaeb5440-d56f-4082-bb26-6804bd20272e"}, "2ced75d0-4613-4266-b73f-f1ef8bf3b743": {"doc_hash": "a9a0bb236fbf2904f8748f742b8743cc58988184ac7a0f21cb6e296ad16ecfd8", "ref_doc_id": "1d8a64a0-0b1f-4a2b-aaa9-cd28e115d880"}, "f318ec37-4a1a-49c3-af63-6f7cc967c3a2": {"doc_hash": "e6eafe689f22e22ef2a6c108a374163c56bbd52a4c7bdb611de604f440806376", "ref_doc_id": "1d8a64a0-0b1f-4a2b-aaa9-cd28e115d880"}, "2e2ce22d-5907-4c79-adbe-b359746620c8": {"doc_hash": "c59f2fbdb8ec3ea58b783f86ee0f05e78fb54f0bbda171a12c078c955fecc3bf", "ref_doc_id": "1d8a64a0-0b1f-4a2b-aaa9-cd28e115d880"}, "169278cd-2fe1-4352-9cf3-ef4d4c8f6582": {"doc_hash": "ff522447812fc75fe3771c296e7d2949d57f945b5db797be2f138efcc72b29a5", "ref_doc_id": "4e1187b0-d907-4d0a-93ab-350d9a58dd11"}, "a16d19c6-0404-41c7-a781-eddf9005763c": {"doc_hash": "ad184febd79f219f609f988fc7a6d666639567fe4d8aa51e99c22f7164f0978b", "ref_doc_id": "29763e78-76e0-4efb-8899-64c6f8b2c148"}, "217fe079-d69d-482a-aae4-7aa77b40f2fb": {"doc_hash": "5c2b50cc89b72779b056a5d75f1a874f2bac8d1ff270b8445d5ad55ea6081c66", "ref_doc_id": "f33f5799-0b3c-4b81-bb8c-de1e4f1e5ba0"}, "744e327a-0ab9-485d-8bb8-4c1e7324bcb6": {"doc_hash": "ea2116dad6628886c068c2105cf97de152a951a1368f577a9a1ea8ac4f281b32", "ref_doc_id": "f33f5799-0b3c-4b81-bb8c-de1e4f1e5ba0"}, "33f67462-1b67-49e6-a985-ed964b546f03": {"doc_hash": "b7ecf8bc0c398c83bd324c938c9e2258269de4a29f1959f23fd30a547bec8d0e", "ref_doc_id": "038fdd76-c25d-469a-9f9f-b90d63e65b31"}, "4b2a641d-e25a-4b4b-83ac-b28fb87fe444": {"doc_hash": "9aadf1486c78351cfe1895bc4c7f7656973de3dc334b9301c22004976051730d", "ref_doc_id": "0c00f1af-b690-47b4-bf76-346204af944d"}, "9d84ac0f-c9bb-490c-8106-d2b8f4e287f6": {"doc_hash": "f047b7f98a101b1997d207b87d0f4ea1231e44032131ed984f49ac6b0c3e3f23", "ref_doc_id": "be81d64d-f554-4617-ba36-9494e1830d4f"}, "2064ba8e-ab08-4577-adf1-3cf548819731": {"doc_hash": "d412e30e02f052dfc19c42cd1e5b1104b0dbdc3b7b57707df0ad8f6039930e2b", "ref_doc_id": "54cc6769-ba4b-443d-aa5f-205a61ea7085"}, "b1b9b403-4417-4c76-aeb7-3f44f4cc80bd": {"doc_hash": "ffa0e57d228988153ef39eae6d87fce4be014919fd58e9df3c9d21405fd1e7ed", "ref_doc_id": "50baffb5-891f-46e9-ba9f-5f231427eb73"}, "b1831ff0-5075-497b-bfa1-9bd719798526": {"doc_hash": "4275cdd32f659c0725afa28f50d2541853fc0a9454b4405a8b9353b9d6453f5d", "ref_doc_id": "e45c7760-5324-472f-80a0-430efd09f021"}, "22c8a723-8d19-4c30-9b7a-b83178e4f238": {"doc_hash": "8040889974e5b6c32eef2afc2e90ddbcd1a6f34c450ba82f1828c16c8f786110", "ref_doc_id": "d4de66b4-b616-426f-858d-e555e6b6e888"}, "ec977477-afd7-4e2c-8917-3591236d8bed": {"doc_hash": "8ce6cbf7f4b3b83b7b12c819babaf909b54b60503128c09fe20cd2cace972038", "ref_doc_id": "986aee79-7a40-4e5c-8c4a-ba677c3efc5e"}, "dee21d55-3a8b-45f3-b096-18e3e2396110": {"doc_hash": "93d6208f9a40adfbe691e32d9844f1de4beecb3fd23ac3430f2b7d3b3566fac9", "ref_doc_id": "a2d5c3b6-9721-4d11-b886-23c01d077a5d"}, "dc86671d-02ca-4b37-990d-7a6b635e05b7": {"doc_hash": "24538fa20d6482679b423fa8ec248d4c16e20214907e25f5c2a688daf25fb7a1", "ref_doc_id": "19bb81de-ecb8-418e-b274-7bfe2361812f"}, "15453c59-d3dc-4f80-a018-2098e91f680f": {"doc_hash": "8b715f0adb1c8040459eff932983aaecbedf17e92e503090006dd5948fa3060c", "ref_doc_id": "1a986fab-103a-41f1-bd7b-c7b25aeab08e"}, "40b87286-fb0a-457f-ae14-6d45bade3d45": {"doc_hash": "df4cdedb1a30c11c002f861eaa5eb84a1f9cb9ca522359f445763513cb4e758d", "ref_doc_id": "1a986fab-103a-41f1-bd7b-c7b25aeab08e"}, "46fed4cb-1b39-4339-84c1-c7795188164b": {"doc_hash": "9968f8f4bfd1db280ba1e19718c8265e6ac4bf1f4f19a0a71ec0ba86f3249b33", "ref_doc_id": "2995b554-16b2-47a1-8290-752393aab1ae"}, "09aa36da-5f6d-4fb6-82ab-d6e3df12184d": {"doc_hash": "ef2b34e578b5fa21ba226ff87b50b1949fb345718dd8735977c7f0c23c6ea6b4", "ref_doc_id": "2210e22d-819c-4ee8-b4bf-a668724032f4"}, "efd292d3-6c16-403d-a12c-37c0a10867b6": {"doc_hash": "93edc5d0b182414c1627e703abc391b8b84c90e7d717ad3777f13f751efaa2b2", "ref_doc_id": "2210e22d-819c-4ee8-b4bf-a668724032f4"}, "81a90d2a-574d-4ae2-a300-c3e4c993fa6c": {"doc_hash": "f22db8179897922e5e7a92fbe66b0a1752ad1b893e186948c0225a22f44dc267", "ref_doc_id": "643e9968-020a-4265-ba3a-c136bb3fb51b"}, "53323c09-9b3f-49ff-b1f8-f499b3741ed9": {"doc_hash": "e36959c56577480e0e7b4fb594cdc4b498ee4d5b0d352499a24ef09f6897ee7e", "ref_doc_id": "643e9968-020a-4265-ba3a-c136bb3fb51b"}, "73adaafa-dc61-4a99-8176-a3e29ff98dce": {"doc_hash": "79abe222a05b4556a8d9af825241444496d7d1225afd3efbe9312af9148dbc4f", "ref_doc_id": "e4f8a88e-a468-459f-be6a-731cf35faf13"}, "6e49edac-1e90-4008-b2af-0ad97ccf877a": {"doc_hash": "67c1738d68e9660864a2c98d14fdd3066517caf0082f5cea4223c3634608e879", "ref_doc_id": "70106f2e-7567-435e-acd4-f7e6b59fc3d7"}, "7753a2e9-c2e3-4317-b054-63d9a6148743": {"doc_hash": "1d01534c0199efed98947db60168ec69e2ef7c13168e36915a08befa3fec81f3", "ref_doc_id": "70106f2e-7567-435e-acd4-f7e6b59fc3d7"}, "1945848b-8d8f-4421-9b85-353e06c916d5": {"doc_hash": "b82253c049e19d3d5eea43f7ed0c9102ba14e819cf1cc370951c312d614f2337", "ref_doc_id": "7780775f-421d-4242-b7fe-f5f4d8398457"}, "7ee5b1e0-ac82-46bc-87d0-d8f0bbbc4543": {"doc_hash": "875480055590763f0faba67ac3c097055179367a145fb62fc905037cb1640f11", "ref_doc_id": "0875b3a1-3c84-4558-9165-c8e5e9179b74"}, "d83cfdcc-4403-4467-88d7-0584566d3105": {"doc_hash": "c8998c4a4d47695cd0c882316fe84b6afa43cf79ef166e2c8a35abcfa5f4e5e2", "ref_doc_id": "7c3a0f7d-fb58-4c67-971f-4d0f0b70149b"}, "5fe02189-b760-4478-a125-23b68cf1960e": {"doc_hash": "91fbf524fb67f2a7eef98a7e0f2c406a4fa4400d5d616bbff7bb9ba887f4cdc6", "ref_doc_id": "7c3a0f7d-fb58-4c67-971f-4d0f0b70149b"}, "edcddc78-7606-4a8b-9f2f-286c675a84c7": {"doc_hash": "967fa56231919d768416dbf88500b55df3e9108d05946124aba66e6eec9822e5", "ref_doc_id": "a58bd078-5e80-4548-a6dc-3ffcf58de308"}, "cdef3be0-c434-41f0-99b3-fee83a57116e": {"doc_hash": "de60815511ccc69fbeb544ac0aaa934241165dfc2ce2b83d195a09e5b305b5f6", "ref_doc_id": "9f7d5136-1a68-4d2f-ac12-61ba612ae228"}, "0d79ad5d-a10b-48de-afbb-2411d8895f1c": {"doc_hash": "c3bd5f7a498f9d022fb5902f44682a1800f23f7a4ea68c154409bfe0d5bc8dde", "ref_doc_id": "9ec685e0-f3bb-433a-97c5-2e7e1d8d5d9e"}, "d543ef81-725a-47f8-8c3b-c431457d80df": {"doc_hash": "507ca3f2e3aaff2ceddbf7063aea67d0d3750357f3fc072c5a3d9914d8a7f8bb", "ref_doc_id": "569b3716-77bc-4551-9d10-2b0b23894e00"}, "8455fed0-9a0f-42f1-a3c3-77b75f7b21d8": {"doc_hash": "75a311de30a09230fac4378e6b2f3eda3accda7392031ee655f716fb0297fd69", "ref_doc_id": "3c0d95a2-5c99-4fda-b060-990250966bd2"}, "0f7827e1-0d43-4557-a986-3f2864af70c6": {"doc_hash": "43b542a05586463e5193a3acf52384d04fe1acdc8cce06b83d85192b290755a7", "ref_doc_id": "3c0d95a2-5c99-4fda-b060-990250966bd2"}, "8a30f374-beae-42ee-829f-8668d8e9da4b": {"doc_hash": "ea6303893a016b6e8d0820a25957b9dedef172b8b000151fee1dbf60fffdd8c5", "ref_doc_id": "c77100a9-e1c8-4c85-8649-952b428ea00b"}, "2fcae706-ebc3-47e8-9974-e2be0aa3a8b3": {"doc_hash": "ac845d3ebb5f7cfb82e5b83281b658c6aabb058a100bcb2bf6760a0386d00827", "ref_doc_id": "c77100a9-e1c8-4c85-8649-952b428ea00b"}, "c3bd8588-fa8f-4377-a4fe-4d5861d0758e": {"doc_hash": "38b1aabf02c8c39cac727fc5db5b629d52895dfb5397419568ade87d38cd7762", "ref_doc_id": "3f20c2af-f0dd-4a74-bb3c-b33d76eb2cf1"}, "666e1f44-60fd-4df2-a0a7-d3b93cb29e96": {"doc_hash": "f5584665bad5716b8f871c0fd3a9028a5bf162dfa27dd023207f6acb4d83fafb", "ref_doc_id": "326af040-385f-4592-be57-172ee53c0865"}, "033afa20-be0f-45e9-8811-b4df2ab32f8d": {"doc_hash": "8813488edf066bede208b9e8dd4905b4f8e3cea83913728138cee183ffacb91b", "ref_doc_id": "5ecddff0-031e-48cb-8316-73806ef9f524"}, "34e544be-3bc2-4af7-b4d7-4415f937441f": {"doc_hash": "bf3e66d112afc55891f40417635b705e54fcb33e24f2479acd99289e4a2c0bc9", "ref_doc_id": "69ada291-f55c-49a7-a2a2-98550c6cba35"}, "a06d5482-b557-4870-8739-98e76111edc5": {"doc_hash": "30c7b4e647a8eadc4d128d8a54f5122beef61d3b42b4bcd9c27deb0d53473eae", "ref_doc_id": "69ada291-f55c-49a7-a2a2-98550c6cba35"}, "3f7bb3e9-99e4-4881-baf0-e42298893cb0": {"doc_hash": "d41dd8849f64be82256bced5d0cf94b161e787200b9e8a2de6a9598ca18e4dbe", "ref_doc_id": "69ada291-f55c-49a7-a2a2-98550c6cba35"}, "1b9c636c-3917-438b-a5c6-63cd915720b4": {"doc_hash": "b893e8c262d318b24ea2b2bc09cb6985c3bec0a4a94f6c71930252d9215f4ac6", "ref_doc_id": "6bcb8ccf-b935-43f8-948c-84b6dfe58909"}, "7ab5f559-ccb2-49b2-83e8-2157c1b1354c": {"doc_hash": "e0fc7ccda8ef3354c67834f62155b22017ab8ced4b2c779215130553223add85", "ref_doc_id": "6bcb8ccf-b935-43f8-948c-84b6dfe58909"}, "d119ec1a-0561-4491-a9d7-31752efdc612": {"doc_hash": "efad97cb64f52cef456b03acb279fd67b0e633aa7193da12864c718eeeaa6cd6", "ref_doc_id": "6bcb8ccf-b935-43f8-948c-84b6dfe58909"}, "2cb1a28c-3bdf-4695-8ce4-d83da532bdfb": {"doc_hash": "bb8bec931c9f5424a153a896512858339e6abc75eebda927ebac53a9062a59c3", "ref_doc_id": "6bcb8ccf-b935-43f8-948c-84b6dfe58909"}, "ed8efb4a-6815-46a3-b73f-e11ced1257f8": {"doc_hash": "04d35984740daddbd8e65ee6be5705eda7fc7357dd12c9c890c977a2e0e0015a", "ref_doc_id": "17e250dc-a486-42ac-92b9-79283e8bb181"}, "0d2dbbdd-a03b-4a28-ade5-7f9cf43e5ec7": {"doc_hash": "5ab43b1f88e8011d6db4813b9ae53197f3a778202d2b3c3371fbd85ce2db368e", "ref_doc_id": "3b7b22d2-b9a7-4439-a33a-e62e91aa2301"}, "3c719b24-1c54-4418-93e6-7b8cea11eb9f": {"doc_hash": "c18ebb2eef4439069a96a2eca35640809b22c9e6a0e25ee89a2c6eab3d945da2", "ref_doc_id": "c5943d27-24e8-4821-b817-a97ff01f6fb3"}, "2b01c65c-ff77-4943-b0e1-8603972cfd00": {"doc_hash": "c979178c81e9334eed95739ded179af1e8f409968301c95db25a84c73b57ca0e", "ref_doc_id": "5b77fe54-9b10-498c-ab50-ef1b5a679d1e"}, "af48e01b-bc6c-4217-928f-7fbb56bb5391": {"doc_hash": "311013f597373d4173f761a673aeea103bb93301383116a5706ce30d40ad7342", "ref_doc_id": "1c8b7ffe-3389-4c3c-983c-a66ee5cd0d8d"}, "1a44ee57-a47a-4a5e-bfcb-21678516f46c": {"doc_hash": "0818df5283f19209ed26df65bef885a34be68d5463fc942876be0a88681a38b6", "ref_doc_id": "70742b89-de98-429f-8de5-bc66aec0c8c8"}, "a1e01383-cd89-4deb-a975-e34349b90ce5": {"doc_hash": "fd0081d3a5e6774e3f8e173c8013a04599e9e1c84c8e1108ce1943366f9f3620", "ref_doc_id": "581ead2c-4ccc-4e96-9bcf-1cbb133447ca"}, "c81d2e08-2e3e-4bfc-972e-becce5d4924a": {"doc_hash": "b3b3c3b729258ae96cd3d58b59bd691e0afff3db9483ee363cb6fbdb3d15ce20", "ref_doc_id": "581ead2c-4ccc-4e96-9bcf-1cbb133447ca"}, "612445c6-76a4-4945-ab1f-fb56454eec8d": {"doc_hash": "f8489ee33f5ff0d862643b030066da94432fc9654887dfd452f87e01a4223543", "ref_doc_id": "3047959e-b205-4a94-8909-8848c2158d71"}, "eaf9dea7-2e42-40cc-beda-359923646183": {"doc_hash": "66bf2f807ec7a6eee6ac9fec6690865d927a2b5472e5c33d529288a3e6aa32ea", "ref_doc_id": "93bb9756-5ed5-44dd-a57e-afe5415b2f5c"}, "9090160f-49eb-4067-9f25-3f8a4845913c": {"doc_hash": "fe231367cd50f9195a7f3084c42c68480c6f97318208336ec39dd30f7312d763", "ref_doc_id": "cb44686a-6ca1-4136-97da-0f623d76042a"}, "54557e51-f726-4646-a99f-c2290a1be641": {"doc_hash": "0a49d3287c925c72f45ccc0c91d928a7cb1e1d841d04f46ef687e4aac92f58b1", "ref_doc_id": "1ae1750c-c9fd-4451-a7ae-cfa6ebfa57e1"}, "552654b9-58e6-49ef-95ce-fad60cbf9b75": {"doc_hash": "d0cff3be70d03352b14ec48d559d4a69d44c315e8ff4fc2bc5ae01882173cfed", "ref_doc_id": "39a14761-f57b-43a5-bd54-3763fe95b651"}, "437c61ba-8bc3-48d9-a626-f23bc2e2b96d": {"doc_hash": "035c3c8a08655abe942d31d762ffbd4c8da42bce9b32ce47617ae4d998fdf501", "ref_doc_id": "75907ae3-2764-40b0-8140-09ccf704d647"}, "6992e90a-4c68-4645-941b-80d00cec4dd1": {"doc_hash": "7b501d9300821f9b0febcf668bd6c5773aeae9c4e1164c5a065051733f6099e0", "ref_doc_id": "05a8716f-7666-4469-bb93-1556c22c722a"}, "8fdb4730-6eb8-49e7-af41-20e84aa09eef": {"doc_hash": "973a4e0556e947f439e0ef069180c6ded56a568f14b3e22629281db3a60b2001", "ref_doc_id": "2c33595d-a26c-422f-9f6d-34e9267baada"}, "0366115f-e42c-423c-96b1-bdb34e05df3e": {"doc_hash": "63cc75b0875c2cbadf871526fee5b04bbce730375ba20650b5205d19dbe5f711", "ref_doc_id": "7382a6cf-214f-4b11-946e-170d48598305"}, "ccaef467-a201-4dfe-b03b-9b072d630143": {"doc_hash": "e7134e97a44188a40b66eaf9c74c258ec90aae92ed6a04a13b712c94e2627923", "ref_doc_id": "d136238d-a534-46cb-ae84-7e34780fb8a9"}, "2c8e6b71-26d3-424a-8bc2-6047db841fb0": {"doc_hash": "b19217fb8eb60ff040b4d150f99cfea60d1830797e4fa6cf380340ba5b1baf78", "ref_doc_id": "688effb7-04ea-421b-bd98-f8cf0a6ac441"}, "815cd613-0496-4144-903c-f641afa70e33": {"doc_hash": "4d0c6d0adfcd028e8ec50c441822a086f55354a24c1e10534d81dfa8230613f2", "ref_doc_id": "93214708-e259-4fbb-868c-51606fbceaf4"}, "760ae05b-0e0d-4c3c-8ccb-b3f862febd62": {"doc_hash": "4d90d1b34fafea7d44ebe33d1a9145a1322c9b78da35d7edec01c08c956c3218", "ref_doc_id": "cbb8f796-bd73-4862-9638-517f64f5486f"}, "c3aad143-c8d9-4dd6-803a-8557911222ad": {"doc_hash": "cac890d7a91a1f14d0f82e9ac3084f4f3ee8b2abd5718e92622e1ed25995ee72", "ref_doc_id": "58406d29-193c-46a4-9940-66d19f8aa1a5"}, "6e203d6f-8f21-48d1-aa31-dfa749314653": {"doc_hash": "f188b0e4aee3d4dc480658361dd17c0b26bea2c7f65bccf726b7715717336be0", "ref_doc_id": "09712d3b-9cac-46ea-9aeb-8a261fb052e7"}, "fd3aca82-f0fb-422a-9c7c-98341bf58846": {"doc_hash": "6d205363660d61005c9feb55dbd36133d35636cc24a9ce4e7c86c1dd62b9535f", "ref_doc_id": "3583b44f-8839-4d9b-8a70-7661e91b5d2c"}, "d4d836f2-7be5-4534-bf17-6b7440ceddc3": {"doc_hash": "80c7965ed302612c41b967e1880e38be9e778eb5a3dde243cce2a6215abb30f3", "ref_doc_id": "f84654c1-b017-4e1c-a53a-a264e4499db4"}, "01c75418-1e75-4089-923c-4ff6598b6b1e": {"doc_hash": "b05c65cb8462bc67d270b79c4e775272f621ffa104f56df2f81913f146488ff1", "ref_doc_id": "1faf9863-89b1-4892-99d1-67d0f4af8780"}, "db0be077-d45a-4fe6-b833-2d79d1049c29": {"doc_hash": "c97e910402ec684e098c229c33d418f437a97fba1cdf8d78ece0f58825f534a0", "ref_doc_id": "fb0a5321-3fc6-485c-97e9-20cd17c77874"}, "f1bc8e25-88ee-43d8-9095-840d9b78a467": {"doc_hash": "dbc570c217757eb851857b51e92eb2d93a2c3170849c3ce37cab6550a1fc7c94", "ref_doc_id": "27d35423-7646-440a-93bc-acca5d10dc3f"}, "7b6ed93e-cc15-4f42-9d27-58dd5563f7d2": {"doc_hash": "a3016effdcc0736f6cdbbe3d24c1373b0f2ffa776d1ed1b83eb3ee23a1ff52e0", "ref_doc_id": "0ea4417c-ec04-4bbc-962b-16f385506760"}, "208baf1f-d45e-447f-805f-9e4d3a1bcb8a": {"doc_hash": "978d0e0dd1317bfe9576360c6322107272aab4ad4903d1aad748d74089235534", "ref_doc_id": "50c08b3a-e30e-4aec-be63-0955f844961d"}, "cd066c4b-2112-40c6-8c13-c1464aecc7a1": {"doc_hash": "a3caf83690423b228aded1fa949670a6871dc328ef32cce2bc0d2623274bb2ca", "ref_doc_id": "341107bd-c8af-4db9-8c15-1ac84d75d9c1"}, "ccf183a0-2138-47b1-a86e-4b5c0412c869": {"doc_hash": "ee5b49a842e17be08ed5066ebf63caad648d1a805f80a51233b256059e08bee7", "ref_doc_id": "ba82f80f-2d9d-4ccc-ba84-b619721ddf53"}, "16e002d8-5567-439c-86d8-be1b16a5041b": {"doc_hash": "7ce5e64cc0553eff84f7e108c2006ad2f8738286a8628fe9cf5c023f6dd231ab", "ref_doc_id": "97ba2cc4-0258-41c3-9ebc-e445cc98c19f"}, "af56d3db-9ad0-46c4-906d-17db0147f39b": {"doc_hash": "bf8df7d2c18dd13d5820d5da78c7d43039a63c8df255a131e19fd795c5172205", "ref_doc_id": "ab3eb9f0-efa5-46bf-8f05-c7550691d3fd"}, "74fad9d7-bdd0-4362-8b21-8e58b3422d1a": {"doc_hash": "41e3560106010c6b007de17e1768d80de6dce5ba623af9e6cc0b95f0ea860743", "ref_doc_id": "6297b80b-1fb0-43d9-9cf7-3af223dff8f4"}, "afba74f4-1820-4741-b83b-24f2fdc06422": {"doc_hash": "62907fefe670bf045e9d9a101439b5f73b4e0fa24ada1f9b3a4fcb0486336a43", "ref_doc_id": "bb0c7ee8-f9db-44d1-a277-0e29c17dc739"}, "757a7382-2542-48cb-8b6f-3f0ae8772f79": {"doc_hash": "c4f299d96f989be490d184ea31dee57f9447e8139de82c971b043532d64c1182", "ref_doc_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c"}, "83a601a8-4d3e-47ef-8fa6-33eb6c426c04": {"doc_hash": "be24be944d9197d9f70723f9e427986f514304a312d372826f79360fd6a6ada0", "ref_doc_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c"}, "26c2ae28-e046-4c83-9e6e-71dd20a0cc4a": {"doc_hash": "5dad4882a4ede37b4d2ee5f5faec2075eab3483e383422e4f9e6422c04fa38db", "ref_doc_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c"}, "c4ae8c59-f484-4bca-9483-86be7b303477": {"doc_hash": "4a2eedab38541d6ea6276e4e9d7f95e76248d0cc522a4d8dd6ef408c9d7874bc", "ref_doc_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c"}, "0994923f-450d-4876-aead-d5091de5c4fc": {"doc_hash": "a0f80b7948aa03a6496c7190530d737aa86bcd85178e64c6deca9207b22ae50a", "ref_doc_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c"}, "e6d19f77-9557-4fc0-af87-f9e582bfcac9": {"doc_hash": "7d823123ec5ccdb8e7209339c88c90f02b3b87a136934a95c02673c1dc1add6a", "ref_doc_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c"}, "6e3dbc47-bc3d-4695-80b7-552d4ae0ad86": {"doc_hash": "6b87b57d364c23b093e0e8cdfe796a49e24c86907c0275fe54eb92f2b3ed182b", "ref_doc_id": "788035dc-a6ee-45c6-82e8-2fe5edbc50d6"}, "83c4d1a0-5c76-43dc-9ad6-2db8b3945e3c": {"doc_hash": "391fc8fb35221dd2fee045545c4ec598f81b7b8b113849295fce939a5aa95c6e", "ref_doc_id": "788035dc-a6ee-45c6-82e8-2fe5edbc50d6"}, "436628a7-2cef-48be-b8a5-0f595233da92": {"doc_hash": "009fd74df2215e89ba7bc0c20d1a5ee81bf6331c9954bcad0d7f5bf97cdd5193", "ref_doc_id": "788035dc-a6ee-45c6-82e8-2fe5edbc50d6"}, "566838e0-ae64-47ec-b414-3105ac4dd579": {"doc_hash": "0094f2ae63bcaed09073d969d36820a141b343bf108c89893dcb299671ec38f5", "ref_doc_id": "788035dc-a6ee-45c6-82e8-2fe5edbc50d6"}, "43255017-ff84-4d1e-bd3b-8d8b026a6e1f": {"doc_hash": "fdbec9099d4922a80dda5adc95012032f74e9e34eba4fe3926bbea7f9da84a56", "ref_doc_id": "788035dc-a6ee-45c6-82e8-2fe5edbc50d6"}, "04691b0e-e1a9-4789-baab-4c97a3618090": {"doc_hash": "db2939929bd66c9ef07ba35a11d4ab8462a92c2b405b3585aa6c28d8d1e80332", "ref_doc_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b"}, "e669d4f6-e189-4ed7-9957-f6bc4ce0c28a": {"doc_hash": "27df62fc2eb38692c3fb657b5c7b6d8c37b04f14089954e8c46dac51a1f4f153", "ref_doc_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b"}, "b89f6108-84ca-4704-957e-b985267149f6": {"doc_hash": "7034689172f5a96ddaa9521a5901010f54df51245fee82c1edf63a8f4f1cf3b8", "ref_doc_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b"}, "74f2c2bc-4330-4a28-97b4-15792d043452": {"doc_hash": "161900dfec4f11762252b1788279d05c02231e4c3daf44fb3772ae285f5b5afd", "ref_doc_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b"}, "14244dcc-ebda-4ad6-b0e7-a09f90d1c9be": {"doc_hash": "eeb068a7cabe0036ebd7b180d70ac979ca49f949107ef0bd8cc9167791db3ce1", "ref_doc_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b"}, "3751deb0-9218-4bba-98fd-8e351554e362": {"doc_hash": "468aa69c21b75cf25cdfa087ab472da719eea375b58abd42fa87c985281c9e58", "ref_doc_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b"}, "81f75453-3f99-415b-a53d-cda4cdbcb2a7": {"doc_hash": "f15f299211cd8ef19146f6b668a4efffea3ee2f19c96f812c7a709556c8b6b6e", "ref_doc_id": "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b"}, "7a88f0d7-1083-44e7-8d18-cc971c4305b9": {"doc_hash": "20fb2281d48a22bc1187e64c6bb8f8db57e72dfc077397b57266e86db754143c", "ref_doc_id": "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b"}, "36c522f0-ee31-4310-8ec2-d7cef5cc0eaa": {"doc_hash": "7ade2d61144afb541e894f444bb0c9a4ba0188489357cea05dd16e85247227c2", "ref_doc_id": "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b"}, "135ad231-0b04-4ab4-aba7-4cbb3dbd4427": {"doc_hash": "cc820d03da5320a3f648d48a989a123713c929ab9d1bec2a115939f12dd6d516", "ref_doc_id": "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b"}, "b8c959e0-32a8-4db9-bbc5-f25dae6649cd": {"doc_hash": "87ab8784749597e0046f19b3718040ca68f48412f24576d7aeb8b35b1b9ee1f1", "ref_doc_id": "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b"}, "8eb3d2f9-06bd-465a-9ad4-0c58b1533535": {"doc_hash": "eb67c7644f027954609b811033f227fee03043b73d53cfc8e2e2ecc6e3611554", "ref_doc_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d"}, "cf0e476c-4653-455c-8849-5971d2a0b42f": {"doc_hash": "40cc8d1e85c020793e8668b444a46efd338b19ca044af32e99f193a43512e734", "ref_doc_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d"}, "ececcc0c-34cb-447f-9e25-6d461b547ef1": {"doc_hash": "9eac212792384f1185918d07cfa407d844c9f310856ab832632aa1f274f8312b", "ref_doc_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d"}, "8c2fc024-3454-4765-924b-d8b7b8ad18cb": {"doc_hash": "b13e53d78b00e88e7f6ffb2c926a03c509542ad772e37395155751489a3ae56e", "ref_doc_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d"}, "2acf7ece-d27d-4ca3-9f4e-5965c228be13": {"doc_hash": "8f24a81a48d38fe9e673b4535b04436af79ae7e4a3604c21d0c6149310f155b0", "ref_doc_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d"}, "21e67d06-58b8-446b-8e95-134cce03e837": {"doc_hash": "e194ec38101dd60ffc4846a324c9e7e5dd9a10d2c848541ab34fe2479f5e6d0b", "ref_doc_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d"}, "69d8fc56-a8b3-4a84-9d95-ea38df5e5cba": {"doc_hash": "69b1c0013b3465a15bd169414b8d4c4438bc221a832c2760ba797f2596c7f5ec", "ref_doc_id": "cb6502a1-1650-4d3c-a04a-11a62afa999e"}, "26396f6e-0eee-4387-acc9-864a6bd4e9d1": {"doc_hash": "aeebdebe6b0d57cd4ce301bd24c0bc63b36531ce3381a06ba130581d398f6652", "ref_doc_id": "cb6502a1-1650-4d3c-a04a-11a62afa999e"}, "09bb3549-1b4f-4373-b5b2-1825e814fffe": {"doc_hash": "d3fc027fdeff536992b4028ffdbfa938eeae226fef661328e7263f6f91563d37", "ref_doc_id": "cb6502a1-1650-4d3c-a04a-11a62afa999e"}, "0711f047-86b3-4bce-bb10-8f7480a47f46": {"doc_hash": "471be14001cdd39d3840aa72238f43fc5987f38ddd2968389b504752bdff4470", "ref_doc_id": "cb6502a1-1650-4d3c-a04a-11a62afa999e"}, "63e6781b-049f-4c25-8153-8e18ee1b6c59": {"doc_hash": "977ba94843ead551b276613ce66b1ac9e088ff6605dde964ff3fef5d9cdc8b5a", "ref_doc_id": "cb6502a1-1650-4d3c-a04a-11a62afa999e"}, "31250343-d683-48fa-91c9-ad9d65346916": {"doc_hash": "946923c26c356bc53844041f7885bdc41bdedf985394bcd0066cb8c0870337f4", "ref_doc_id": "6d1eb4e1-26e7-4182-8b2f-a301288f768e"}, "de782a34-5de6-470e-b8dd-6cf7fcf57549": {"doc_hash": "b1af9a92024d60a93be69114768f7a9bd55a5668b0cfb8e12d5d06144acf2c08", "ref_doc_id": "6d1eb4e1-26e7-4182-8b2f-a301288f768e"}, "41573d29-c330-446e-a7e7-50e87559ebf9": {"doc_hash": "0d7f8383c27f153a542a8b1e2ba60c26d28f323d2d349a9b9e9dfc900f490b62", "ref_doc_id": "6d1eb4e1-26e7-4182-8b2f-a301288f768e"}, "7fa11c02-225a-4511-93a9-130a72b4616b": {"doc_hash": "5a1163773d91639add7139f93dd2adba0606888ca64c70141e08cde9e92f808d", "ref_doc_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22"}, "e2f3bc36-1239-4a1e-8f17-3ef59b6839e2": {"doc_hash": "f2d3f58a8d7879009c39bee7b45511a509827635e59ffc42a27f250a09d99865", "ref_doc_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22"}, "90efa031-8fe7-459a-a54f-9123318a6684": {"doc_hash": "bb274c06e4a8caa6c1cb1f1d1058f472f2f8af3285bbb35cd610106b0ebccf65", "ref_doc_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22"}, "b0489814-f6e0-400b-ac1c-e46a7c8312d7": {"doc_hash": "4ddcc14d160bb21fe4a3debedfc92b248c1ed6d5239c22e76f37e6e5e711e4db", "ref_doc_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22"}, "577b19c8-5d7c-4959-93c9-aae14a9c859b": {"doc_hash": "9352255712cd58c4d8ef5c5b6cbe0a9c5e3fae7e33698d1fbe0410f65e661d89", "ref_doc_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22"}, "e95a2112-139c-4f41-ae26-d0416cd69b65": {"doc_hash": "f87d7386bde980f0b832e25d3bc5eb81e2c6e5013c518f4bfcb23324b974b9b2", "ref_doc_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22"}, "5578c71b-544f-40e8-94d6-7f959893f695": {"doc_hash": "5da2ceb49724c20117d44bff9464fcbe808830e8db0409395091369f2df194a3", "ref_doc_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22"}, "2cd5fbbd-cdfb-4992-b941-b7b2d8bc0f9c": {"doc_hash": "7bffdb28ff8337cf4248e9768f42056008c78c83270b4ef7e32c6cf6731d032a", "ref_doc_id": "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0"}, "eba33f6b-013c-4e1e-b9bb-9cab2b603bf1": {"doc_hash": "d2d9f29328103cc27eb89d764d96b9d52c32b2a0d7734cb495103627e925646c", "ref_doc_id": "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0"}, "05a2fab3-c692-4fef-bad1-98bd5b474bd9": {"doc_hash": "7230ab55a531db70058850f39bc641c8f49f39fe75bdcd38351278849d8463f9", "ref_doc_id": "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0"}, "2c2e1cd0-fe47-4482-b74f-09c29bb70672": {"doc_hash": "c3506700fcfb0d9f95438e671e1ecc05e9f8b5351e469e3fc4abdad480fa2f14", "ref_doc_id": "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0"}, "d8d73997-59fc-4784-b811-5f3f74c53222": {"doc_hash": "155a7919baaa0cdef4e8828b68c3fd052136bc793a985d3035810783681f0f5c", "ref_doc_id": "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0"}, "f09ee431-3eeb-4fd5-82c5-a96daeea1a41": {"doc_hash": "11685649cd4d33b380002b620c50f4e6616b3d1c596db8a58e1c2034f71e599a", "ref_doc_id": "81bfd6e6-4c4b-467b-a9bc-b47d512ff960"}, "f27384fb-e990-449d-92c5-438083a20223": {"doc_hash": "2634a6ef959c1161cb9e5af790ca4ce68c392210117a66af7e354139b441a6bf", "ref_doc_id": "81bfd6e6-4c4b-467b-a9bc-b47d512ff960"}, "68f7e8d9-7160-4bdb-8342-c9c99aca6024": {"doc_hash": "538b3d02c58efb86b6ba6527f2aeeaf390ec4e0020817abfedc9df687b75144f", "ref_doc_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53"}, "3fce3c90-03f4-495a-93a9-abd0746d3fd8": {"doc_hash": "9a1b0cbc2a4b7beb2c19ccfdb1146a2be5c070b0490179590376bfa61316d49b", "ref_doc_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53"}, "b3583997-8db7-44d0-95eb-09e33a72bf86": {"doc_hash": "1f0e480d6a34b686b31001b11f4b404659b74f1941fb61a3ecebebf2d3158962", "ref_doc_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53"}, "21f20e6f-a2e2-4320-b417-8163633c0722": {"doc_hash": "15a365195eef252053d98f465f35d90581f70b06d9eb3962a307b93bc69ca546", "ref_doc_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53"}, "b81541e1-8975-4e7c-a131-56d4bc6daf5a": {"doc_hash": "16ba299052ecc4e4a84c5b64a202a60dd70c16d348910acfe1ec76808e468c35", "ref_doc_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53"}, "da2c7ccb-0989-4e36-b7f0-cc91c04d3630": {"doc_hash": "6c4c5707dcff2beaacda6f37248d6a4e9ec68ea51645d805ccad64d2a9854a91", "ref_doc_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53"}, "dc45ba00-9d3e-4238-ac88-e7de5ea641d5": {"doc_hash": "ffc87b2f88e2e712d08080fdf767ab691946b9e0ce261e0b52ca5c51a0670c02", "ref_doc_id": "a3079cdf-9c72-4211-8b17-937bf2df6322"}, "042c80a1-261e-4fcb-ab99-3a64ea675845": {"doc_hash": "0188d13d424dba3c702a2bca58e3ae1204cd49db75923df87d2903b8b077a434", "ref_doc_id": "a3079cdf-9c72-4211-8b17-937bf2df6322"}, "58779001-7119-49a3-9107-41b1e589798d": {"doc_hash": "5d7329de4f5fa761a6f6d498215994d6f180bf9d8c093a6f1421639a7639fc0b", "ref_doc_id": "a3079cdf-9c72-4211-8b17-937bf2df6322"}, "8a9e37a2-fec5-4fd2-aab2-9a044012df76": {"doc_hash": "91b87ba6e55047aa7981d2f6d8afa356fbf0b42e7868a0ea5ca59ed28d9e4f87", "ref_doc_id": "a3079cdf-9c72-4211-8b17-937bf2df6322"}, "efe5985f-bee3-4e3d-a313-83ca4632fd4e": {"doc_hash": "067dfa7041e5e2655739b48c70505fda8fdb3f3b0645b6874a4091d868c064dd", "ref_doc_id": "9e523807-7308-4af7-ba56-998ea6431ba2"}, "038f01e9-3e44-4977-a6ff-fa1593623260": {"doc_hash": "040a6f053fabe5d2efc8d6ba9be42534f84f5a3c1d4903a746b783f32a94dd23", "ref_doc_id": "9e523807-7308-4af7-ba56-998ea6431ba2"}, "2d80feb5-ebf0-40df-9d23-1227f201b201": {"doc_hash": "6a1d78109b1623e646651d46b12b4affc482395e83c163b6c1469660cfde382a", "ref_doc_id": "9e523807-7308-4af7-ba56-998ea6431ba2"}, "a79cb706-d28c-48b5-8e01-045dc1e95136": {"doc_hash": "b574d7376b52ff57146074a40e7a28b4a8b6e4719f2a4973fb1daed756ea3f20", "ref_doc_id": "9e523807-7308-4af7-ba56-998ea6431ba2"}, "af494ee7-b56b-4fb9-9977-d2c36c3de341": {"doc_hash": "86652d7c2058b2a9517be11d27ab3b4a76fd37e83acd80a0b95a7b8c8ff61d37", "ref_doc_id": "fece5066-9485-4734-8b7e-e516ad9b868f"}, "f46a98e2-a9ec-4392-b739-c261d567ed98": {"doc_hash": "e0bc980657552bcc4e1f7980d381edd4de86ede5b7b21da49b6ad875ffaee2da", "ref_doc_id": "fece5066-9485-4734-8b7e-e516ad9b868f"}, "3e8f2ec6-c323-40b4-9ed6-be276661afbd": {"doc_hash": "cb8b977a0f9cbf8cccebf4f7b10fa76a7cf56eca2cbea3cacccfddf8529224a0", "ref_doc_id": "fece5066-9485-4734-8b7e-e516ad9b868f"}, "e06a546b-df1f-4d68-9083-494a3e4a7d23": {"doc_hash": "1b0247a78fe90a38a7c0c39b7b735e5084b6d56f38b4ce9f5f38285e9d83fc7c", "ref_doc_id": "fece5066-9485-4734-8b7e-e516ad9b868f"}, "3d1e557e-395d-4b62-a07d-be31d4709cf2": {"doc_hash": "c95a5af47c36aa18e7f670950c1905de7582fb382d7e9388d948144c927f9b8b", "ref_doc_id": "fece5066-9485-4734-8b7e-e516ad9b868f"}, "9611f88a-2a44-494c-891b-cc138b4dbe11": {"doc_hash": "2a7fa29b582f63ee768171e68c9e4f477bb7647b381c0689b5515e3f5b344241", "ref_doc_id": "fece5066-9485-4734-8b7e-e516ad9b868f"}, "2f9496ff-c19a-4c9c-9535-a40283e396fb": {"doc_hash": "e2832b87994129e69a705d450882cc2dbbb9cec58359c9158be086136e1dec91", "ref_doc_id": "fece5066-9485-4734-8b7e-e516ad9b868f"}, "95a2fb9d-11d3-4e53-8d47-6612b90b66cb": {"doc_hash": "e955ad667a29d9711773d9bd8247472e1b7028da6930734481d8bed2103d7a36", "ref_doc_id": "fece5066-9485-4734-8b7e-e516ad9b868f"}, "f4ac6860-d059-42ff-a4cc-40ce2d257908": {"doc_hash": "a6fca7a9ad2be1a3cb5e4ede3499ecbe80ee10b527593e5d3e1b286affa86697", "ref_doc_id": "fece5066-9485-4734-8b7e-e516ad9b868f"}, "16cc0a18-6b99-4573-a216-edd13ae09ca3": {"doc_hash": "221b7e4544c8b6d29ed5cb77f8aa78868a82da3130725e824806de4a0568958a", "ref_doc_id": "fece5066-9485-4734-8b7e-e516ad9b868f"}, "2887d11e-da82-4f36-adf0-0fe80d76d7f3": {"doc_hash": "6cc28a1a34834f11410c31e05d71c281553f580579b4a81792ba19ad46054c34", "ref_doc_id": "b2592cd2-45af-4230-8baf-a6e99c36c4bd"}, "7dcacd5d-c264-402e-82b6-d7385361cfe5": {"doc_hash": "c86b40dbd93ebc64659c6186004ed1e0674cf36800e5dd82a440f6fe29d506ee", "ref_doc_id": "b2592cd2-45af-4230-8baf-a6e99c36c4bd"}, "6ff0537a-1587-44c9-bfdc-511d31272616": {"doc_hash": "2ce3cac77b86341b2a7b0a137f45014702e6ccd5206ac7174bedf2913b9aeb59", "ref_doc_id": "7983b46e-58f1-4f9b-a389-2588d6edef24"}, "25f4b3c8-b4ef-43bf-91f7-c6c6397cbc97": {"doc_hash": "9dc7262c087b3cb08a3f19aaa95cf6d73ab4c4b96da881d6aa457714e21b3e3a", "ref_doc_id": "7983b46e-58f1-4f9b-a389-2588d6edef24"}, "dc0a7853-9319-4908-8f8c-867597acfc34": {"doc_hash": "d351f2621464743c2553106b963da46ab1d20674db7bf00e3a593a04b0eeb55e", "ref_doc_id": "7983b46e-58f1-4f9b-a389-2588d6edef24"}, "ed07c4aa-37ee-4d9b-86e5-0cb3660263ee": {"doc_hash": "17f1049cb6374059192e8209b8602f78fe223978aff2158022b81cb424a6aed6", "ref_doc_id": "7983b46e-58f1-4f9b-a389-2588d6edef24"}, "5fcabd73-d92e-4157-86cc-290fcd46db4e": {"doc_hash": "b179be03a89f90af6e3a949290d2dce51b76d602aa41cef302b3c07cf7cdba73", "ref_doc_id": "7983b46e-58f1-4f9b-a389-2588d6edef24"}, "b14969c2-d401-4431-8054-e171188eaa7b": {"doc_hash": "8f91462b4426a117bc5793d651ef77fe90f2886b84c2b08f60d19df59ab743f4", "ref_doc_id": "7983b46e-58f1-4f9b-a389-2588d6edef24"}, "6ee26294-c1dd-48b0-9bb2-9d9b7c33e3d0": {"doc_hash": "050f3ed6fd1aacb936619711d182bc1ccc422a4fd8e68a6f748a8a98938e4a0b", "ref_doc_id": "7983b46e-58f1-4f9b-a389-2588d6edef24"}, "63fe201c-9c6e-4e3a-a9b9-9dcf6201ccc4": {"doc_hash": "3f47e2d328ff5e59ffa8453a2296d8d9deaddad235045d37afe445b15ebbf27a", "ref_doc_id": "7983b46e-58f1-4f9b-a389-2588d6edef24"}, "05495d88-f368-44c5-ab1a-ff73d4f0e3cd": {"doc_hash": "ddf7bf32cdf27239657c5d0b8172226daa6945fd5e46bb8cd720d675a02f9936", "ref_doc_id": "7983b46e-58f1-4f9b-a389-2588d6edef24"}, "b3b18377-3a62-4498-83cb-360fd9e07714": {"doc_hash": "b9818143e683b9802743cceeb567acf726772fbf973b2913df040e1162f86c04", "ref_doc_id": "c41d658b-1b6b-4bdd-9b34-f96365b4ac82"}, "ac46a0ac-4404-4384-8280-b27ee95b70d1": {"doc_hash": "48704d77e55fbb729284035fa170df99912a70593039b4612b8726dcf385f460", "ref_doc_id": "88cba982-fb17-4b97-baa3-2f4d667ae13e"}, "16e7e1ac-be38-4c09-9ff9-63d771cc465c": {"doc_hash": "4832d4810fcbb426680f128a12244b2f755754956ff970757154ce9e4e767d62", "ref_doc_id": "0de11889-4a35-4bf4-b303-05575c99a366"}, "52993a83-5c5b-41ef-904b-e47effd50b2b": {"doc_hash": "03f938e571147b8a3786cc23311b7906f8937452d7f015c77db00e89c34fe682", "ref_doc_id": "f58052c3-2b80-4156-b1a2-53145ff358b6"}, "279e21f2-5cf2-44ac-83b9-86a811121baa": {"doc_hash": "7b8abd3f15e5115a709f3aaad5ebc45636a5a1d2807d854e4e3a766efdd021cd", "ref_doc_id": "f58052c3-2b80-4156-b1a2-53145ff358b6"}, "27454026-63dc-4179-a8f6-823e765b1286": {"doc_hash": "96eaf90965100a1e76d8872e07080c1853b39566d6ba9b1b792b55f75f27b1cb", "ref_doc_id": "f58052c3-2b80-4156-b1a2-53145ff358b6"}, "e0bedf76-c15d-4c28-ba62-8bfc614de4a9": {"doc_hash": "3ae9e7a9ac6f73f1788b877f443520b8a25f5d4f5df26d59f686b9de06552e48", "ref_doc_id": "f58052c3-2b80-4156-b1a2-53145ff358b6"}, "5dacf70e-6265-434c-8e19-bfa904c3f5f5": {"doc_hash": "0744a05b1d3361efe15c82e798c7b8415b8e0e54be119654097c1287e0992d79", "ref_doc_id": "19062a8f-ecf6-4569-9cba-72d49b774a24"}, "9d094e7f-e856-4dad-8e7d-93e2cd07aa6a": {"doc_hash": "f3c13d9fe648288fd2c135886ffb11946edfa7d83d5267309c59bbfc23d971a1", "ref_doc_id": "20e450e3-0323-4181-8acb-11ffb5b2e030"}, "12f92ccc-5547-4af8-adbc-4d65ce9da93b": {"doc_hash": "8af078a10c8cb7a8d021d199e5670f85bfd448ec18268d03392e8fdaa528c0f5", "ref_doc_id": "20e450e3-0323-4181-8acb-11ffb5b2e030"}, "9e08a145-ecff-46a2-b2a8-bfd51fa88d92": {"doc_hash": "3961f5d91ad50d81104d563160c84fb5148f0919104d9c73e44753acd9ed2a08", "ref_doc_id": "d3e82f6b-64a9-4daf-9f0e-b6a3326b7a07"}, "e9169eee-a568-4bf6-898a-bcb54c631d9c": {"doc_hash": "82bedda8193f5d591dcdf68b889c3113d1633e262d6715dc9ee51178d230e9ef", "ref_doc_id": "abb2a4d6-5bbe-4b35-bfe8-49d1e9a79a06"}, "89532045-3266-4a4b-a55b-f7c304e4e68e": {"doc_hash": "7a4c0717690ff2ab07184a0d3a1c17515bc5798d82e08baea373ed4318c1c57c", "ref_doc_id": "3eece43e-f014-437e-b56e-5a4573b463e8"}, "372151b0-0514-4202-ab5a-c932424ae73f": {"doc_hash": "4bc343805fab72d2a430893a73e8904ce5e231bb9f3d991ad17f899eac0dc08b", "ref_doc_id": "f0d783f3-b717-486f-8c6f-57d61a800f51"}}, "docstore/data": {"d5245b86-deea-467b-8bc4-d06f0f93600a": {"__data__": {"id_": "d5245b86-deea-467b-8bc4-d06f0f93600a", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "452719e6-dc5a-416a-9ae6-a31e8aae46ba", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "hash": "984bd54b3c816e26bc5b09a92767357e88ed18d830191ed0dfe1d1dc0d908ff9", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b6aaa604-b321-44c0-b94e-6d971a9a05ce", "node_type": "1", "metadata": {}, "hash": "19352886ae29d9428b3278b1d60a71c4a645a436bcc403e9e99123df71c669f2", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nAPI Dependencies\nFastAPI dependency injection utilities\n\"\"\"\n\nimport json # Adicionado\nimport uuid # Adicionado para corrigir erro de tipo UUID\nfrom typing import Annotated\n\nfrom fastapi import Depends, HTTPException, status\nfrom fastapi.security import HTTPAuthorizationCredentials, HTTPBearer\nfrom jose import JWTError\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom app.config.database import get_db\nfrom app.config.security import decode_token\nfrom app.infrastructure.database.models import User\nfrom app.schemas.auth import TokenData\nfrom sqlalchemy import select\n\nsecurity = HTTPBearer()\n\n\nasync def get_current_user(\n    credentials: Annotated[HTTPAuthorizationCredentials, Depends(security)],\n    db: Annotated[AsyncSession, Depends(get_db)],\n) -> User:\n    \"\"\"\n    Get current user from JWT token - PARQUET ONLY (SIMPLIFIED)\n    \"\"\"\n    import polars as pl\n    from pathlib import Path\n    from datetime import datetime, timezone\n    import sys\n\n    credentials_exception = HTTPException(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"Could not validate credentials\",\n        headers={\"WWW-Authenticate\": \"Bearer\"},\n    )\n\n    # Decode JWT\n    try:\n        token = credentials.credentials\n        payload = decode_token(token)\n\n        if payload.get(\"type\") != \"access\":\n            # print(\"==> Invalid token type <==\", file=sys.stderr, flush=True)\n            raise credentials_exception\n\n        user_id = payload.get(\"sub\")\n        if user_id is None:\n            # print(\"==> No user_id in token <==\", file=sys.stderr, flush=True)\n            raise credentials_exception\n\n        # print(f\"==> Token decoded: user_id={user_id} <==\", file=sys.stderr, flush=True)\n\n    except JWTError as e:\n        # print(f\"==> JWT Error: {e} <==\", file=sys.stderr, flush=True)\n        raise credentials_exception\n\n    # Read from Parquet ONLY\n    # Docker path vs Dev path\n    docker_path = Path(\"/app/data/parquet/users.parquet\")\n    dev_path = Path(__file__).parent.parent.parent.parent / \"data\" / \"parquet\" / \"users.parquet\"\n    parquet_path = docker_path if docker_path.exists() else dev_path\n    # print(f\"==> Parquet path: {parquet_path} <==\", file=sys.stderr, flush=True)\n\n    if not parquet_path.exists():\n        # print(f\"==> Parquet NOT FOUND <==\", file=sys.stderr, flush=True)\n        raise credentials_exception\n\n    try:\n        df = pl.read_parquet(parquet_path)\n        # print(f\"==> Parquet loaded: {len(df)} rows <==\", file=sys.stderr, flush=True)\n\n        # Simple filter without cast\n        user_data = df.filter(pl.col(\"id\") == user_id)\n        # print(f\"==> Filter result: {len(user_data)} rows <==\", file=sys.stderr, flush=True)\n\n        if len(user_data) == 0:\n            # print(f\"==> User {user_id} NOT FOUND <==\", file=sys.stderr, flush=True)\n            raise credentials_exception\n\n        user_row = user_data.row(0, named=True)\n        # print(f\"==> User found: {user_row['username']} <==\", file=sys.stderr, flush=True)\n\n        user = User(\n            id=uuid.UUID(str(user_row[\"id\"])),\n            username=user_row[\"username\"],\n            email=user_row.get(\"email\", \"\"),\n            role=user_row[\"role\"],\n            is_active=user_row.get(\"is_active\", True),\n            hashed_password=user_row[\"hashed_password\"],\n            allowed_segments=user_row.get(\"allowed_segments\", \"[]\"), # Adicionado\n            created_at=user_row.get(\"created_at\", datetime.now(timezone.utc)),\n            updated_at=user_row.get(\"updated_at\", datetime.now(timezone.utc)),\n            last_login=user_row.get(\"last_login\")\n        )\n\n        if not user.is_active:\n            # print(\"==> User INACTIVE <==\", file=sys.stderr, flush=True)\n            raise HTTPException(\n                status_code=status.HTTP_403_FORBIDDEN,\n                detail=\"Inactive user\"\n            )\n\n        # print(f\"==> SUCCESS: {user.username} authenticated <==\", file=sys.stderr, flush=True)\n        return user\n\n    except HTTPException:\n        raise\n    except Exception as e:\n        # print(f\"==> ERROR: {e} <==\", file=sys.stderr, flush=True)\n        raise credentials_exception", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4120, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b6aaa604-b321-44c0-b94e-6d971a9a05ce": {"__data__": {"id_": "b6aaa604-b321-44c0-b94e-6d971a9a05ce", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "452719e6-dc5a-416a-9ae6-a31e8aae46ba", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "hash": "984bd54b3c816e26bc5b09a92767357e88ed18d830191ed0dfe1d1dc0d908ff9", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "d5245b86-deea-467b-8bc4-d06f0f93600a", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "hash": "95e953851bd2b49444b11a467c8ed9a6aad91ddcf11d879431d254cc9091f148", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "6012402e-cfd1-4624-8707-b6db0934cd2a", "node_type": "1", "metadata": {}, "hash": "f31aba6f457149422fbb4750aec9af062b905cb7e669f70b159898b97ee7f1e9", "class_name": "RelatedNodeInfo"}}, "text": "async def get_current_user_old(\n    credentials: Annotated[HTTPAuthorizationCredentials, Depends(security)],\n    db: Annotated[AsyncSession, Depends(get_db)],\n) -> User:\n    \"\"\"\n    Get current authenticated user from JWT token - PARQUET ONLY VERSION\n    \n    Simplified version that ONLY uses Parquet for maximum speed and reliability.\n    \"\"\"\n    import sys\n    import polars as pl\n    from pathlib import Path\n    from datetime import datetime, timezone\n    \n    # print(\"==> get_current_user CALLED <==\", file=sys.stderr, flush=True)\n    \n    credentials_exception = HTTPException(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"Could not validate credentials\",\n        headers={\"WWW-Authenticate\": \"Bearer\"},\n    )\n\n    # Decode and validate JWT token\n    try:\n        token = credentials.credentials\n        payload = decode_token(token)\n        \n        # print(f\"==> Token decoded successfully <==\", file=sys.stderr, flush=True)\n\n        if payload.get(\"type\") != \"access\":\n            # print(f\"==> Invalid token type: {payload.get('type')} <==\", file=sys.stderr, flush=True)\n            raise credentials_exception\n\n        user_id: str | None = payload.get(\"sub\")\n        if user_id is None:\n            # print(f\"==> No user_id in token <==\", file=sys.stderr, flush=True)\n            raise credentials_exception\n            \n        # print(f\"==> Looking for user_id: {user_id} <==\", file=sys.stderr, flush=True)\n\n    except JWTError as e:\n        # print(f\"==> JWT Error: {e} <==\", file=sys.stderr, flush=True)\n        raise credentials_exception\n\n    # Load user from Parquet\n    docker_path = Path(\"/app/data/parquet/users.parquet\")\n    dev_path = Path(__file__).parent.parent.parent / \"data\" / \"parquet\" / \"users.parquet\"\n    parquet_path = docker_path if docker_path.exists() else dev_path\n    \n    # print(f\"==> Parquet path: {parquet_path} <==\", file=sys.stderr, flush=True)\n    # print(f\"==> Exists: {parquet_path.exists()} <==\", file=sys.stderr, flush=True)\n\n    if not parquet_path.exists():\n        # print(f\"==> ERROR: Parquet file not found! <==\", file=sys.stderr, flush=True)\n        raise credentials_exception\n\n    try:\n        df = pl.read_parquet(parquet_path)\n        # print(f\"==> Parquet loaded: {len(df)} rows <==\", file=sys.stderr, flush=True)\n        \n        # Filter for user (simple comparison without cast)\n        user_data = df.filter(pl.col(\"id\") == user_id)\n        # print(f\"==> Filter result: {len(user_data)} rows <==\", file=sys.stderr, flush=True)\n\n        if len(user_data) == 0:\n            # print(f\"==> User {user_id} NOT FOUND <==\", file=sys.stderr, flush=True)\n            raise credentials_exception\n\n        user_row = user_data.row(0, named=True)\n        # print(f\"==> User found: {user_row.get('username')} <==\", file=sys.stderr, flush=True)\n\n        user = User(\n            id=user_row[\"id\"],\n            username=user_row[\"username\"],\n            email=user_row.get(\"email\", \"\"),\n            role=user_row[\"role\"],\n            is_active=user_row.get(\"is_active\", True),\n            hashed_password=user_row[\"hashed_password\"],\n            created_at=user_row.get(\"created_at\", datetime.now(timezone.utc)),\n            updated_at=user_row.get(\"updated_at\", datetime.now(timezone.utc)),\n            last_login=user_row.get(\"last_login\")\n        )\n\n        if not user.is_active:\n            # print(f\"==> User {user.username} is INACTIVE <==\", file=sys.stderr, flush=True)\n            raise HTTPException(\n                status_code=status.HTTP_403_FORBIDDEN,\n                detail=\"Inactive user\"\n            )\n\n        # print(f\"==> User {user.username} AUTHENTICATED <==\", file=sys.stderr, flush=True)\n        return user\n\n    except HTTPException:\n        raise\n    except Exception as e:\n        # print(f\"==> ERROR: {e} <==\", file=sys.stderr, flush=True)\n        import traceback\n        # traceback.print_exc(file=sys.stderr)\n        raise credentials_exception\n\n\nasync def get_current_active_user(\n    current_user: Annotated[User, Depends(get_current_user)]\n) -> User:\n    \"\"\"Get current active user\"\"\"\n    if not current_user.is_active:\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"Inactive user\"\n        )\n    return current_user", "mimetype": "text/plain", "start_char_idx": 4123, "end_char_idx": 8398, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6012402e-cfd1-4624-8707-b6db0934cd2a": {"__data__": {"id_": "6012402e-cfd1-4624-8707-b6db0934cd2a", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "452719e6-dc5a-416a-9ae6-a31e8aae46ba", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "hash": "984bd54b3c816e26bc5b09a92767357e88ed18d830191ed0dfe1d1dc0d908ff9", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b6aaa604-b321-44c0-b94e-6d971a9a05ce", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "hash": "27827da2717f48e42e6d6a2f3e891121e0c9c32b493ba92ef5fe4f45103c8083", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "9d99c789-7d43-49d8-99fe-5e2304104d65", "node_type": "1", "metadata": {}, "hash": "5d36dba4e5dbd5534dd051131ed41ed8888832bdbbc1c23d17f930ac087dfeb7", "class_name": "RelatedNodeInfo"}}, "text": "async def get_current_active_user(\n    current_user: Annotated[User, Depends(get_current_user)]\n) -> User:\n    \"\"\"Get current active user\"\"\"\n    if not current_user.is_active:\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"Inactive user\"\n        )\n    return current_user\n\n\nasync def get_current_user_from_token(token: str) -> User:\n    \"\"\"\n    Get current user from raw JWT token string\n    Used for SSE endpoints where EventSource doesn't support custom headers\n    \"\"\"\n    import polars as pl\n    from pathlib import Path\n    from datetime import datetime, timezone\n    import sys\n    \n    credentials_exception = HTTPException(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"Could not validate credentials\",\n        headers={\"WWW-Authenticate\": \"Bearer\"},\n    )\n    \n    # Decode JWT\n    try:\n        payload = decode_token(token)\n        \n        if payload.get(\"type\") != \"access\":\n            raise credentials_exception\n        \n        user_id = payload.get(\"sub\")\n        if user_id is None:\n            raise credentials_exception\n            \n    except JWTError:\n        raise credentials_exception\n    \n    # Read from Parquet\n    docker_path = Path(\"/app/data/parquet/users.parquet\")\n    dev_path = Path(__file__).parent.parent.parent.parent / \"data\" / \"parquet\" / \"users.parquet\"\n    parquet_path = docker_path if docker_path.exists() else dev_path\n    \n    if not parquet_path.exists():\n        raise credentials_exception\n    \n    try:\n        df = pl.read_parquet(parquet_path)\n        user_data = df.filter(pl.col(\"id\") == user_id)\n        \n        if len(user_data) == 0:\n            raise credentials_exception\n        \n        # CORRE\u00c7\u00c3O: Definir user_row antes de usar\n        user_row = user_data.row(0, named=True)\n        \n        user = User(\n            id=uuid.UUID(str(user_row[\"id\"])),\n            username=user_row[\"username\"],\n            email=user_row.get(\"email\", \"\"),\n            role=user_row[\"role\"],\n            is_active=user_row.get(\"is_active\", True),\n            hashed_password=user_row[\"hashed_password\"],\n            allowed_segments=user_row.get(\"allowed_segments\", \"[]\"), # Adicionado\n            created_at=user_row.get(\"created_at\", datetime.now(timezone.utc)),\n            updated_at=user_row.get(\"updated_at\", datetime.now(timezone.utc)),\n            last_login=user_row.get(\"last_login\")\n        )\n        \n        if not user.is_active:\n            raise HTTPException(\n                status_code=status.HTTP_403_FORBIDDEN,\n                detail=\"Inactive user\"\n            )\n        \n        return user\n        \n    except HTTPException:\n        raise\n    except Exception:\n        raise credentials_exception\n\n\n\ndef require_role(*allowed_roles: str):\n    \"\"\"\n    Dependency to require specific roles\n    \n    Usage:\n        @router.get(\"/admin\")\n        async def admin_endpoint(user: User = Depends(require_role(\"admin\"))):\n            ...\n    \"\"\"\n    async def role_checker(\n        current_user: Annotated[User, Depends(get_current_active_user)]\n    ) -> User:\n        if current_user.role not in allowed_roles:\n            raise HTTPException(\n                status_code=status.HTTP_403_FORBIDDEN,\n                detail=f\"Permission denied. Required roles: {', '.join(allowed_roles)}\"\n            )\n        return current_user\n    \n    return role_checker\n\n\ndef require_permission(permission: str):\n    \"\"\"\n    Dependency to require specific permission\n    \n    Usage:\n        @router.get(\"/reports\")\n        async def get_reports(user: User = Depends(require_permission(\"VIEW_REPORTS\"))):\n            ...\n    \"\"\"\n    # Permission mapping (same as frontend)\n    ROLE_PERMISSIONS = {\n        \"admin\": [\"*\"],  # All permissions\n        \"user\": [\n            \"VIEW_ANALYTICS\", \"VIEW_REPORTS\", \"CREATE_REPORTS\", \n            \"EDIT_REPORTS\", \"USE_CHAT\"\n        ],\n        \"viewer\": [\"VIEW_ANALYTICS\", \"VIEW_REPORTS\"],\n    }\n    \n    async def permission_checker(\n        current_user: Annotated[User, Depends(get_current_active_user)]\n    ) -> User:\n        user_permissions = ROLE_PERMISSIONS.get(current_user.role, [])\n        \n        if \"*\" not in user_permissions and permission not in user_permissions:\n            raise HTTPException(\n                status_code=status.HTTP_403_FORBIDDEN,\n                detail=f\"Permission denied. Required permission: {permission}\"\n            )\n        return current_user\n    \n    return permission_checker\n\n\nasync def get_current_active_user(\n    current_user: Annotated[User, Depends(get_current_user)]\n) -> User:\n    \"\"\"Get current active user\"\"\"\n    if not current_user.is_active:\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"Inactive user\"\n        )\n    return current_user", "mimetype": "text/plain", "start_char_idx": 8074, "end_char_idx": 12887, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9d99c789-7d43-49d8-99fe-5e2304104d65": {"__data__": {"id_": "9d99c789-7d43-49d8-99fe-5e2304104d65", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "452719e6-dc5a-416a-9ae6-a31e8aae46ba", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "hash": "984bd54b3c816e26bc5b09a92767357e88ed18d830191ed0dfe1d1dc0d908ff9", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "6012402e-cfd1-4624-8707-b6db0934cd2a", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}, "hash": "996368d664ec3e1b6a617e97258c01872c0a3c2f8118c599ef89c5af8420c1d9", "class_name": "RelatedNodeInfo"}}, "text": "async def get_current_active_user(\n    current_user: Annotated[User, Depends(get_current_user)]\n) -> User:\n    \"\"\"Get current active user\"\"\"\n    if not current_user.is_active:\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"Inactive user\"\n        )\n    return current_user\n\n\nasync def get_current_user_from_token(token: str) -> User:\n    \"\"\"\n    Get current user from raw JWT token string\n    Used for SSE endpoints where EventSource doesn't support custom headers\n    \"\"\"\n    import polars as pl\n    from pathlib import Path\n    from datetime import datetime, timezone\n    import sys\n    \n    credentials_exception = HTTPException(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"Could not validate credentials\",\n        headers={\"WWW-Authenticate\": \"Bearer\"},\n    )\n    \n    # Decode JWT\n    try:\n        payload = decode_token(token)\n        \n        if payload.get(\"type\") != \"access\":\n            raise credentials_exception\n        \n        user_id = payload.get(\"sub\")\n        if user_id is None:\n            raise credentials_exception\n            \n    except JWTError:\n        raise credentials_exception\n    \n    # Read from Parquet\n    docker_path = Path(\"/app/data/parquet/users.parquet\")\n    dev_path = Path(__file__).parent.parent.parent.parent / \"data\" / \"parquet\" / \"users.parquet\"\n    parquet_path = docker_path if docker_path.exists() else dev_path\n    \n    if not parquet_path.exists():\n        raise credentials_exception\n    \n    try:\n        df = pl.read_parquet(parquet_path)\n        user_data = df.filter(pl.col(\"id\") == user_id)\n        \n        if len(user_data) == 0:\n            raise credentials_exception\n        \n        # CORRE\u00c7\u00c3O: Definir user_row antes de usar\n        user_row = user_data.row(0, named=True)\n        \n        user = User(\n            id=uuid.UUID(str(user_row[\"id\"])),\n            username=user_row[\"username\"],\n            email=user_row.get(\"email\", \"\"),\n            role=user_row[\"role\"],\n            is_active=user_row.get(\"is_active\", True),\n            hashed_password=user_row[\"hashed_password\"],\n            allowed_segments=user_row.get(\"allowed_segments\", \"[]\"), # Adicionado\n            created_at=user_row.get(\"created_at\", datetime.now(timezone.utc)),\n            updated_at=user_row.get(\"updated_at\", datetime.now(timezone.utc)),\n            last_login=user_row.get(\"last_login\")\n        )\n        \n        if not user.is_active:\n            raise HTTPException(\n                status_code=status.HTTP_403_FORBIDDEN,\n                detail=\"Inactive user\"\n            )\n        \n        return user\n        \n    except HTTPException:\n        raise\n    except Exception:\n        raise credentials_exception\n\n\n\ndef require_role(*allowed_roles: str):\n    \"\"\"\n    Dependency to require specific roles\n    \n    Usage:\n        @router.get(\"/admin\")\n        async def admin_endpoint(user: User = Depends(require_role(\"admin\"))):\n            ...\n    \"\"\"\n    async def role_checker(\n        current_user: Annotated[User, Depends(get_current_active_user)]\n    ) -> User:\n        if current_user.role not in allowed_roles:\n            raise HTTPException(\n                status_code=status.HTTP_403_FORBIDDEN,\n                detail=f\"Permission denied. Required roles: {', '.join(allowed_roles)}\"\n            )\n        return current_user\n    \n    return role_checker\n\n\ndef require_permission(permission: str):\n    \"\"\"\n    Dependency to require specific permission\n    \n    Usage:\n        @router.get(\"/reports\")\n        async def get_reports(user: User = Depends(require_permission(\"VIEW_REPORTS\"))):\n            ...\n    \"\"\"\n    # Permission mapping (same as frontend)\n    ROLE_PERMISSIONS = {\n        \"admin\": [\"*\"],  # All permissions\n        \"user\": [\n            \"VIEW_ANALYTICS\", \"VIEW_REPORTS\", \"CREATE_REPORTS\", \n            \"EDIT_REPORTS\", \"USE_CHAT\"\n        ],\n        \"viewer\": [\"VIEW_ANALYTICS\", \"VIEW_REPORTS\"],\n    }\n    \n    async def permission_checker(\n        current_user: Annotated[User, Depends(get_current_active_user)]\n    ) -> User:\n        user_permissions = ROLE_PERMISSIONS.get(current_user.role, [])\n        \n        if \"*\" not in user_permissions and permission not in user_permissions:\n            raise HTTPException(\n                status_code=status.HTTP_403_FORBIDDEN,\n                detail=f\"Permission denied. Required permission: {permission}\"\n            )\n        return current_user\n    \n    return permission_checker", "mimetype": "text/plain", "start_char_idx": 8074, "end_char_idx": 12560, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a60245b5-dda1-43c4-99c6-446b53ab7715": {"__data__": {"id_": "a60245b5-dda1-43c4-99c6-446b53ab7715", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\router.py", "language": "python", "lines": 56, "filename": "router.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7cbc0a2a-c981-4ec1-9ded-920d0241dca9", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\router.py", "language": "python", "lines": 56, "filename": "router.py"}, "hash": "a9863c7f7a476c07ddf8fa08015a045acee4a1a1a954d8c2d5bed853e8eff5eb", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nAPI V1 Router\nCombines all v1 endpoints\n\"\"\"\n\nfrom fastapi import APIRouter\n\nfrom app.api.v1.endpoints import (\n    admin,\n    analytics,\n    auth,\n    reports,\n    auth_alt,\n    metrics,\n    chat,\n    rupturas,\n    transfers,\n    diagnostics,\n    learning,\n    playground,\n    frontend_logs,\n    shared,\n    preferences,\n    insights,\n    health,\n    code_chat  # Code Chat RAG\n)\n\napi_router = APIRouter()\n\n# Include all endpoint routers\n# Health check endpoints (no auth required)\napi_router.include_router(health.router)\n\n# Authentication endpoints\napi_router.include_router(auth.router)\napi_router.include_router(auth_alt.router_alt)  # Login alternativo\napi_router.include_router(analytics.router)\napi_router.include_router(reports.router)\napi_router.include_router(admin.router)\napi_router.include_router(metrics.router)  # Dashboard metrics\napi_router.include_router(chat.router)  # BI Chat\n\n# New Endpoints\napi_router.include_router(rupturas.router)\napi_router.include_router(transfers.router)\napi_router.include_router(diagnostics.router)\napi_router.include_router(learning.router)\napi_router.include_router(playground.router)\napi_router.include_router(shared.router)\napi_router.include_router(preferences.router)\napi_router.include_router(insights.router)\napi_router.include_router(code_chat.router)  # Code Chat RAG\n\n# Frontend Logs\napi_router.include_router(frontend_logs.router)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1394, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7c889e8d-7602-4c65-a1f6-8c2efb84d7c1": {"__data__": {"id_": "7c889e8d-7602-4c65-a1f6-8c2efb84d7c1", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7f15b7b9-b758-45da-b7ec-44ebbf180a5b", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "hash": "734cfc9d745a627ef4700bf53096d6e3b62ac68c090686e1c8633948234d844b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "03c522f2-b9d8-4d0c-bb95-a7ef7ec72d8b", "node_type": "1", "metadata": {}, "hash": "1d75db6c60b0e52f789e1568d9abfec6e2cd2a910e7c8a2d334d191cea53fb60", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nAdmin Endpoints\nUser management, audit logs, and system settings\n\"\"\"\n\nimport uuid\nimport json # Added import\nfrom typing import Annotated\n\nfrom fastapi import APIRouter, Depends, HTTPException, status, BackgroundTasks\nfrom sqlalchemy import func, select\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom pydantic import BaseModel\n\nfrom app.api.dependencies import get_db, require_role, get_current_active_user\nfrom app.config.security import get_password_hash\nfrom app.infrastructure.database.models import AuditLog, Report, User\nfrom app.schemas.user import UserCreate, UserResponse, UserUpdate\nfrom app.core.parquet_cache import cache\nfrom app.core.sync_service import sync_service\nfrom app.core.supabase_user_service import supabase_user_service\n\nrouter = APIRouter(prefix=\"/admin\", tags=[\"Admin\"])\n\n\n# Modelos adicionais para compatibilidade\nclass AdminStats(BaseModel):\n    totalUsers: int\n    activeUsers: int\n    totalQueries: int\n    systemHealth: str\n\n\n@router.post(\"/sync-parquet\")\nasync def sync_parquet_data(\n    background_tasks: BackgroundTasks,\n    current_user: Annotated[User, Depends(require_role(\"admin\"))],\n):\n    \"\"\"\n    Trigger SQL Server -> Parquet synchronization\n    \n    Runs in background. Requires admin role.\n    \"\"\"\n    background_tasks.add_task(sync_service.run_sync)\n    return {\"message\": \"Sincroniza\u00e7\u00e3o iniciada em segundo plano. Verifique os logs para progresso.\", \"status\": \"processing\"}\n\n\n@router.get(\"/stats\", response_model=AdminStats)\nasync def get_admin_stats(\n    db: Annotated[AsyncSession, Depends(get_db)],\n    current_user: Annotated[User, Depends(get_current_active_user)],\n) -> AdminStats:\n    \"\"\"\n    Get system statistics\n\n    Returns admin dashboard metrics with real data from Parquet.\n    Requires admin role.\n    \"\"\"\n    import polars as pl\n    import logging\n\n    logger = logging.getLogger(__name__)\n\n    # Verificar se \u00e9 admin\n    if current_user.role != \"admin\":\n        raise HTTPException(status_code=403, detail=\"Admin access required\")\n\n    try:\n        # Contar usu\u00e1rios no banco\n        try:\n            result = await db.execute(select(func.count(User.id)))\n            total_users = result.scalar()\n\n            result = await db.execute(select(func.count(User.id)).where(User.is_active == True))\n            active_users = result.scalar()\n        except:\n            # Fallback para Parquet se SQL falhar\n            df_users = cache.get_dataframe(\"users.parquet\")\n            total_users = len(df_users)\n            active_users = df_users.filter(pl.col(\"is_active\") == True).height\n\n        # Estat\u00edsticas de dados do sistema\n        df_admmat = cache.get_dataframe(\"admmat.parquet\")\n        total_queries = df_admmat.filter(pl.col(\"VENDA_30DD\") > 0).height\n\n        logger.info(f\"Admin stats: {total_users} users, {total_queries} active products\")\n\n        return AdminStats(\n            totalUsers=total_users or 0,\n            activeUsers=active_users or 0,\n            totalQueries=total_queries,\n            systemHealth=\"healthy\"\n        )\n\n    except Exception as e:\n        logger.error(f\"Error fetching admin stats: {str(e)}\")\n        raise HTTPException(status_code=500, detail=f\"Error fetching stats: {str(e)}\")\n\n\n@router.get(\"/users\")\nasync def get_users(\n    current_user: Annotated[User, Depends(require_role(\"admin\"))],\n    db: Annotated[AsyncSession, Depends(get_db)],\n) -> list[dict]:\n    \"\"\"\n    Get all users from Supabase\n\n    Returns list of users with their profiles and auth status.\n    Requires admin role.\n    \"\"\"\n    from app.config.settings import settings\n\n    if settings.USE_SUPABASE_AUTH:\n        # Use Supabase user service\n        users = supabase_user_service.list_users(limit=1000)\n        return users\n    else:\n        # Fallback to SQL Server (legacy)\n        result = await db.execute(select(User).order_by(User.created_at.desc()))\n        users = result.scalars().all()\n        return [\n            {\n                \"id\": str(user.id),\n                \"username\": user.username,\n                \"email\": user.email or \"\",\n                \"role\": user.role,\n                \"is_active\": user.is_active,\n                \"created_at\": user.created_at.isoformat() if user.created_at else \"\",\n                \"updated_at\": user.updated_at.isoformat() if user.updated_at else \"\",\n            }\n            for user in users\n        ]", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4344, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "03c522f2-b9d8-4d0c-bb95-a7ef7ec72d8b": {"__data__": {"id_": "03c522f2-b9d8-4d0c-bb95-a7ef7ec72d8b", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7f15b7b9-b758-45da-b7ec-44ebbf180a5b", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "hash": "734cfc9d745a627ef4700bf53096d6e3b62ac68c090686e1c8633948234d844b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "7c889e8d-7602-4c65-a1f6-8c2efb84d7c1", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "hash": "e5dd96e19e1b19735e29d4537ed152c67f21e60d17fb53ee50003e16fee47328", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "8de27ec6-8134-42e7-89dd-779c6db6e619", "node_type": "1", "metadata": {}, "hash": "8f30c98536c685e83927992bae99050f67cd87342a62868fbb1d8f63468b5d4f", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/users/{user_id}\", response_model=UserResponse)\nasync def get_user(\n    user_id: uuid.UUID,\n    db: Annotated[AsyncSession, Depends(get_db)],\n    current_user: Annotated[User, Depends(require_role(\"admin\"))],\n) -> User:\n    \"\"\"Get user by ID\"\"\"\n    result = await db.execute(select(User).where(User.id == user_id))\n    user = result.scalar_one_or_none()\n    \n    if not user:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"User not found\"\n        )\n    \n    return user\n\n\n@router.post(\"/users\", status_code=status.HTTP_201_CREATED)\nasync def create_user(\n    user_data: UserCreate,\n    current_user: Annotated[User, Depends(require_role(\"admin\"))],\n    db: Annotated[AsyncSession, Depends(get_db)],\n) -> dict:\n    \"\"\"\n    Create new user in Supabase Auth + user_profiles\n\n    Creates user with auto-confirmed email and profile data.\n    Requires admin role.\n    \"\"\"\n    from app.config.settings import settings\n\n    if settings.USE_SUPABASE_AUTH:\n        try:\n            # Create user in Supabase\n            new_user = supabase_user_service.create_user(\n                email=user_data.email,\n                password=user_data.password,\n                username=user_data.username,\n                role=user_data.role,\n                full_name=user_data.username,  # Can be enhanced later\n                allowed_segments=user_data.allowed_segments # Added allowed_segments\n            )\n            return new_user\n        except Exception as e:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=str(e)\n            )\n    else:\n        # Fallback to SQL Server (legacy)\n        result = await db.execute(\n            select(User).where(\n                (User.username == user_data.username) | (User.email == user_data.email)\n            )\n        )\n        existing_user = result.scalar_one_or_none()\n\n        if existing_user:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=\"Username or email already registered\"\n            )\n\n        hashed_password = get_password_hash(user_data.password)\n        new_user = User(\n            username=user_data.username,\n            email=user_data.email,\n            hashed_password=hashed_password,\n            role=user_data.role,\n            allowed_segments=json.dumps(user_data.allowed_segments) if user_data.allowed_segments else \"[]\" # Added allowed_segments\n        )\n\n        db.add(new_user)\n        await db.commit()\n        await db.refresh(new_user)\n\n        return {\n            \"id\": str(new_user.id),\n            \"username\": new_user.username,\n            \"email\": new_user.email,\n            \"role\": new_user.role,\n            \"is_active\": new_user.is_active,\n            \"allowed_segments\": user_data.allowed_segments\n        }", "mimetype": "text/plain", "start_char_idx": 4347, "end_char_idx": 7230, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8de27ec6-8134-42e7-89dd-779c6db6e619": {"__data__": {"id_": "8de27ec6-8134-42e7-89dd-779c6db6e619", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7f15b7b9-b758-45da-b7ec-44ebbf180a5b", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "hash": "734cfc9d745a627ef4700bf53096d6e3b62ac68c090686e1c8633948234d844b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "03c522f2-b9d8-4d0c-bb95-a7ef7ec72d8b", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "hash": "29b0379a34e4fdd177ad3fccca322840e007213cd9aaf10b91bc133fa042b7d3", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f50e232b-61d0-4c57-91d7-b74912380f3b", "node_type": "1", "metadata": {}, "hash": "3731a2e394301f1f7ad3f0dff1d931dae92f710f939e5c92c9ce07e1fbd1d4ce", "class_name": "RelatedNodeInfo"}}, "text": "@router.put(\"/users/{user_id}\")\nasync def update_user(\n    user_id: str,\n    user_data: UserUpdate,\n    current_user: Annotated[User, Depends(require_role(\"admin\"))],\n    db: Annotated[AsyncSession, Depends(get_db)],\n) -> dict:\n    \"\"\"\n    Update user in Supabase\n\n    Updates user auth data and profile information.\n    Requires admin role.\n    \"\"\"\n    from app.config.settings import settings\n\n    if settings.USE_SUPABASE_AUTH:\n        try:\n            update_data = user_data.model_dump(exclude_unset=True)\n\n            updated_user = supabase_user_service.update_user(\n                user_id=user_id,\n                email=update_data.get(\"email\"),\n                username=update_data.get(\"username\"),\n                role=update_data.get(\"role\"),\n                password=update_data.get(\"password\"),\n                is_active=update_data.get(\"is_active\"),\n                allowed_segments=update_data.get(\"allowed_segments\") # Added allowed_segments\n            )\n\n            if not updated_user:\n                raise HTTPException(\n                    status_code=status.HTTP_404_NOT_FOUND,\n                    detail=\"User not found\"\n                )\n\n            return updated_user\n        except HTTPException:\n            raise\n        except Exception as e:\n            raise HTTPException(\n                status_code=status.HTTP_400_BAD_REQUEST,\n                detail=str(e)\n            )\n    else:\n        # Fallback to SQL Server (legacy)\n        result = await db.execute(select(User).where(User.id == user_id))\n        user = result.scalar_one_or_none()\n\n        if not user:\n            raise HTTPException(\n                status_code=status.HTTP_404_NOT_FOUND,\n                detail=\"User not found\"\n            )\n\n        update_data = user_data.model_dump(exclude_unset=True)\n\n        if \"password\" in update_data:\n            update_data[\"hashed_password\"] = get_password_hash(update_data.pop(\"password\"))\n\n        # Handle allowed_segments conversion for SQL Server\n        if \"allowed_segments\" in update_data:\n            user.allowed_segments = json.dumps(update_data.pop(\"allowed_segments\"))\n\n        for field, value in update_data.items():\n            setattr(user, field, value)\n\n        await db.commit()\n        await db.refresh(user)\n\n        return {\n            \"id\": str(user.id),\n            \"username\": user.username,\n            \"email\": user.email,\n            \"role\": user.role,\n            \"is_active\": user.is_active,\n            \"allowed_segments\": json.loads(user.allowed_segments) if user.allowed_segments else []\n        }\n\n\n@router.delete(\"/users/{user_id}\", status_code=status.HTTP_204_NO_CONTENT)\nasync def delete_user(\n    user_id: str,\n    current_user: Annotated[User, Depends(require_role(\"admin\"))],\n    db: Annotated[AsyncSession, Depends(get_db)],\n):\n    \"\"\"\n    Delete user from Supabase\n\n    Removes user from auth and profile tables.\n    Requires admin role. Cannot delete self.\n    \"\"\"\n    from app.config.settings import settings\n\n    # Prevent self-deletion\n    if user_id == str(current_user.id):\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=\"Cannot delete your own account\"\n        )\n\n    if settings.USE_SUPABASE_AUTH:\n        success = supabase_user_service.delete_user(user_id)\n        if not success:\n            raise HTTPException(\n                status_code=status.HTTP_404_NOT_FOUND,\n                detail=\"User not found or deletion failed\"\n            )\n    else:\n        # Fallback to SQL Server (legacy)\n        result = await db.execute(select(User).where(User.id == user_id))\n        user = result.scalar_one_or_none()\n\n        if not user:\n            raise HTTPException(\n                status_code=status.HTTP_404_NOT_FOUND,\n                detail=\"User not found\"\n            )\n\n        await db.delete(user)\n        await db.commit()", "mimetype": "text/plain", "start_char_idx": 7233, "end_char_idx": 11120, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f50e232b-61d0-4c57-91d7-b74912380f3b": {"__data__": {"id_": "f50e232b-61d0-4c57-91d7-b74912380f3b", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7f15b7b9-b758-45da-b7ec-44ebbf180a5b", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "hash": "734cfc9d745a627ef4700bf53096d6e3b62ac68c090686e1c8633948234d844b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8de27ec6-8134-42e7-89dd-779c6db6e619", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}, "hash": "b85815c1ddf2962f5c9010fdf5d5ee2198b4d1c217cc48bc5ae7a771b7e28a5f", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/audit-logs\")\nasync def get_audit_logs(\n    db: Annotated[AsyncSession, Depends(get_db)],\n    current_user: Annotated[User, Depends(require_role(\"admin\"))],\n    limit: int = 100,\n) -> list[dict]:\n    \"\"\"Get audit logs\"\"\"\n    \n    result = await db.execute(\n        select(AuditLog)\n        .order_by(AuditLog.timestamp.desc())\n        .limit(limit)\n    )\n    logs = result.scalars().all()\n    \n    # Get user names\n    user_ids = {log.user_id for log in logs}\n    users_result = await db.execute(\n        select(User.id, User.username).where(User.id.in_(user_ids))\n    )\n    users_map = {user_id: username for user_id, username in users_result}\n    \n    return [\n        {\n            \"id\": str(log.id),\n            \"user_id\": str(log.user_id),\n            \"user_name\": users_map.get(log.user_id, \"Unknown\"),\n            \"action\": log.action,\n            \"resource\": log.resource,\n            \"details\": log.details,\n            \"ip_address\": str(log.ip_address),\n            \"timestamp\": log.timestamp.isoformat(),\n            \"status\": log.status,\n        }\n        for log in logs\n    ]", "mimetype": "text/plain", "start_char_idx": 11123, "end_char_idx": 12225, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "396030fe-a5dd-4e15-8aa3-6aeed81a3b75": {"__data__": {"id_": "396030fe-a5dd-4e15-8aa3-6aeed81a3b75", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "649e0877-ef07-4eb4-9757-d99a3e142954", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "hash": "500f4453d67ee61ee5f9827d04f66653afed405d7ac97f7a0023a4e8b2cf2c77", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "add62210-a42c-4e5c-a8fb-7b87d6dbb70d", "node_type": "1", "metadata": {}, "hash": "f1b943c374d24077461ae61564cd519e0c15bfc1bcc66c158c6cf78860b8f571", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nAnalytics Endpoints\nData analysis, metrics, export and custom queries\n\"\"\"\n\nfrom typing import Annotated, List, Dict, Any, Optional\nfrom datetime import datetime, timedelta, date\nimport json\nimport logging\n\nfrom fastapi import APIRouter, Depends, HTTPException, Query, status\nfrom pydantic import BaseModel\n\nfrom app.api.dependencies import get_current_active_user\nfrom app.infrastructure.database.models import User\nfrom app.core.monitoring.metrics_dashboard import MetricsDashboard\nfrom app.config.settings import settings # For initializing MetricsDashboard\n\nlogger = logging.getLogger(__name__)\n\n# Initialize MetricsDashboard globally\n# In a larger application, consider dependency injection or FastAPI lifespan events.\nmetrics_dashboard: Optional[MetricsDashboard] = None\n\n# @Deprecate this global initialization in favor of FastAPI's lifespan events. This is for quick setup.\ndef _initialize_metrics_dashboard():\n    global metrics_dashboard\n    if metrics_dashboard is None:\n        metrics_dashboard = MetricsDashboard(\n            query_history=None, # Will use default from settings in MetricsDashboard\n            response_cache=None # Will use default from settings in MetricsDashboard\n        )\n        logger.info(\"MetricsDashboard initialized.\")\n\n_initialize_metrics_dashboard()\n\nrouter = APIRouter(prefix=\"/analytics\", tags=[\"Analytics\"])\n\n\nclass MetricsSummary(BaseModel):\n    total_queries: int\n    total_errors: int\n    success_rate_feedback: float\n    cache_hit_rate: float\n    average_response_time_ms: str\n\n\nclass ErrorTrendItem(BaseModel):\n    date: str\n    error_count: int\n\n\nclass TopQueryItem(BaseModel):\n    query: str\n    count: int\n\n\n@router.get(\"/kpis\", response_model=MetricsSummary)\nasync def get_kpis(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    days: int = Query(7, description=\"Number of days to look back for metrics\"),\n) -> MetricsSummary:\n    \"\"\"\n    Retrieves key performance indicators (KPIs) for the agent system.\n    (T4.4.1: GET /analytics/kpis)\n    \"\"\"\n    if metrics_dashboard is None:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=\"MetricsDashboard not initialized.\"\n        )\n    try:\n        kpis = metrics_dashboard.get_metrics(days=days)\n        return MetricsSummary(**kpis)\n    except Exception as e:\n        logger.error(f\"Error fetching KPIs: {e}\", exc_info=True)\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error fetching KPIs: {str(e)}\"\n        )\n\n\n@router.get(\"/error-trend\", response_model=List[ErrorTrendItem])\nasync def get_error_trend(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    days: int = Query(30, description=\"Number of days to look back for error trend\"),\n) -> List[ErrorTrendItem]:\n    \"\"\"\n    Provides a daily trend of errors for the agent system.\n    (T4.4.1: GET /analytics/error-trend)\n    \"\"\"\n    if metrics_dashboard is None:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=\"MetricsDashboard not initialized.\"\n        )\n    try:\n        trend = metrics_dashboard.get_error_trend(days=days)\n        return [ErrorTrendItem(**item) for item in trend]\n    except Exception as e:\n        logger.error(f\"Error fetching error trend: {e}\", exc_info=True)\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error fetching error trend: {str(e)}\"\n        )", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3539, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "add62210-a42c-4e5c-a8fb-7b87d6dbb70d": {"__data__": {"id_": "add62210-a42c-4e5c-a8fb-7b87d6dbb70d", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "649e0877-ef07-4eb4-9757-d99a3e142954", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "hash": "500f4453d67ee61ee5f9827d04f66653afed405d7ac97f7a0023a4e8b2cf2c77", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "396030fe-a5dd-4e15-8aa3-6aeed81a3b75", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "hash": "c5045e06e65be7253be0a3e25ca2661e1b2e07057b5de02041a9ceef7285498b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "734b4d07-8097-48ca-8ff1-13de33d4f81b", "node_type": "1", "metadata": {}, "hash": "cf1168308b5aeb19a555b4511412a38c8836e95ba805d69fa211136bd2f2e3b2", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/top-queries\", response_model=List[TopQueryItem])\nasync def get_top_queries(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    days: int = Query(7, description=\"Number of days to look back for top queries\"),\n    limit: int = Query(10, description=\"Maximum number of top queries to return\"),\n) -> List[TopQueryItem]:\n    \"\"\"\n    Identifies the most frequent queries made to the agent system.\n    (T4.4.1: GET /analytics/top-queries)\n    \"\"\"\n    if metrics_dashboard is None:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=\"MetricsDashboard not initialized.\"\n        )\n    try:\n        top_queries = metrics_dashboard.get_top_queries(days=days, limit=limit)\n        return [TopQueryItem(**item) for item in top_queries]\n    except Exception as e:\n        logger.error(f\"Error fetching top queries: {e}\", exc_info=True)\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error fetching top queries: {str(e)}\"\n        )\n\n\n@router.get(\"/filter-options\")\nasync def get_filter_options(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    segmento: Optional[str] = Query(None, description=\"Segmento para filtrar as categorias retornadas\")\n) -> Dict[str, List[str]]:\n    \"\"\"\n    Retorna valores \u00fanicos de categoria e segmento para os filtros.\n    Pode filtrar categorias por um segmento espec\u00edfico.\n    \"\"\"\n    import polars as pl\n    from app.core.data_scope_service import data_scope_service\n\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user, max_rows=50000)\n\n        categorias = []\n        segmentos = []\n        \n        # Filtrar o DataFrame pelo segmento se fornecido\n        if segmento and \"NOMESEGMENTO\" in df.columns:\n            df = df.filter(pl.col(\"NOMESEGMENTO\").str.to_lowercase() == segmento.lower())\n\n        # Categorias \u00fanicas\n        if \"NOMECATEGORIA\" in df.columns:\n            cat_unique = df.select(\"NOMECATEGORIA\").unique().sort(\"NOMECATEGORIA\")\n            for row in cat_unique.iter_rows(named=True):\n                cat = str(row[\"NOMECATEGORIA\"]).strip()\n                if cat and cat != \"null\" and cat != \"None\":\n                    categorias.append(cat)\n\n        # Segmentos \u00fanicos (sempre da base original, n\u00e3o filtrada por categoria)\n        df_all_segments = data_scope_service.get_filtered_dataframe(current_user, max_rows=50000)\n        if \"NOMESEGMENTO\" in df_all_segments.columns:\n            seg_unique = df_all_segments.select(\"NOMESEGMENTO\").unique().sort(\"NOMESEGMENTO\")\n            for row in seg_unique.iter_rows(named=True):\n                seg = str(row[\"NOMESEGMENTO\"]).strip()\n                if seg and seg != \"null\" and seg != \"None\":\n                    segmentos.append(seg)\n\n        return {\n            \"categorias\": categorias,\n            \"segmentos\": segmentos\n        }\n\n    except Exception as e:\n        logger.error(f\"Error getting filter options: {e}\", exc_info=True)\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error getting filter options: {str(e)}\"\n        )\n\n\n@router.get(\"/sales-analysis\")\nasync def get_sales_analysis(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    categoria: Optional[str] = Query(None),\n    segmento: Optional[str] = Query(None)\n) -> Dict[str, Any]:\n    \"\"\"\n    An\u00e1lise de vendas e estoque com gr\u00e1ficos.\n    Retorna dados para gr\u00e1ficos de vendas por categoria, giro de estoque e distribui\u00e7\u00e3o ABC.\n    \"\"\"", "mimetype": "text/plain", "start_char_idx": 3542, "end_char_idx": 7134, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "734b4d07-8097-48ca-8ff1-13de33d4f81b": {"__data__": {"id_": "734b4d07-8097-48ca-8ff1-13de33d4f81b", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "649e0877-ef07-4eb4-9757-d99a3e142954", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "hash": "500f4453d67ee61ee5f9827d04f66653afed405d7ac97f7a0023a4e8b2cf2c77", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "add62210-a42c-4e5c-a8fb-7b87d6dbb70d", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "hash": "99771bfa6d207ea395fd33bd69d287cefa4aadd4fb521da4eb813b43bfc67bd5", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "80e94cb7-d8ff-44cb-a2c7-4511e7b39620", "node_type": "1", "metadata": {}, "hash": "eb53d75ebb9a4afb939d07ec43930322de3b71b99a298beb113479b5d0ca2a02", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/sales-analysis\")\nasync def get_sales_analysis(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    categoria: Optional[str] = Query(None),\n    segmento: Optional[str] = Query(None)\n) -> Dict[str, Any]:\n    \"\"\"\n    An\u00e1lise de vendas e estoque com gr\u00e1ficos.\n    Retorna dados para gr\u00e1ficos de vendas por categoria, giro de estoque e distribui\u00e7\u00e3o ABC.\n    \"\"\"\n    import polars as pl\n    from app.core.data_scope_service import data_scope_service\n\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user, max_rows=50000)\n\n        # Determinar nomes corretos das colunas\n        categoria_col = \"NOMECATEGORIA\" if \"NOMECATEGORIA\" in df.columns else (\"CATEGORIA\" if \"CATEGORIA\" in df.columns else None)\n        segmento_col = \"NOMESEGMENTO\" if \"NOMESEGMENTO\" in df.columns else (\"SEGMENTO\" if \"SEGMENTO\" in df.columns else None)\n\n        # Aplicar filtros se fornecidos (exato, case-insensitive)\n        if categoria and categoria_col:\n            df = df.filter(pl.col(categoria_col).str.to_lowercase() == categoria.lower())\n        if segmento and segmento_col:\n            df = df.filter(pl.col(segmento_col).str.to_lowercase() == segmento.lower())\n\n        # 1. Vendas por Categoria\n        vendas_categoria = []\n        if categoria_col:\n            df_cat = df.group_by(categoria_col).agg([\n                pl.col(\"VENDA_30DD\").sum().alias(\"vendas\")\n            ]).sort(\"vendas\", descending=True).head(10)\n\n            for row in df_cat.iter_rows(named=True):\n                cat = str(row[categoria_col]).strip()\n                if cat and cat != \"null\" and cat != \"None\":\n                    vendas_categoria.append({\n                        \"categoria\": cat[:30],\n                        \"vendas\": int(row[\"vendas\"])\n                    })\n\n        # 2. Giro de Estoque (vendas / estoque m\u00e9dio)\n        giro_estoque = []\n        if \"VENDA_30DD\" in df.columns and \"ESTOQUE_UNE\" in df.columns:\n            # Clean and cast ESTOQUE_UNE, handling empty strings\n            estoque_cleaned = pl.col(\"ESTOQUE_UNE\").replace(\"\", None).cast(pl.Float64)\n\n            df_giro = df.filter(\n                (pl.col(\"VENDA_30DD\") > 0) &\n                (estoque_cleaned > 0)\n            ).group_by(\"PRODUTO\", \"NOME\").agg([\n                pl.col(\"VENDA_30DD\").sum().alias(\"vendas\"),\n                estoque_cleaned.mean().alias(\"estoque_medio\")\n            ])\n\n            df_giro = df_giro.with_columns([\n                (pl.col(\"vendas\") / pl.col(\"estoque_medio\")).alias(\"giro\")\n            ]).sort(\"giro\", descending=True).head(15)\n\n            for row in df_giro.iter_rows(named=True):\n                giro_estoque.append({\n                    \"produto\": str(row[\"PRODUTO\"]),\n                    \"nome\": str(row[\"NOME\"])[:40],\n                    \"giro\": round(float(row[\"giro\"]), 2)\n                })\n\n        # 3.", "mimetype": "text/plain", "start_char_idx": 6743, "end_char_idx": 9609, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "80e94cb7-d8ff-44cb-a2c7-4511e7b39620": {"__data__": {"id_": "80e94cb7-d8ff-44cb-a2c7-4511e7b39620", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "649e0877-ef07-4eb4-9757-d99a3e142954", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "hash": "500f4453d67ee61ee5f9827d04f66653afed405d7ac97f7a0023a4e8b2cf2c77", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "734b4d07-8097-48ca-8ff1-13de33d4f81b", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}, "hash": "6fa82c5e9fefb7aaf54d60a0806e4e083e27db6ea4c7027705fbb8e23fd72a27", "class_name": "RelatedNodeInfo"}}, "text": "Distribui\u00e7\u00e3o ABC (baseado em vendas)\n        distribuicao_abc = {\"A\": 0, \"B\": 0, \"C\": 0}\n        if \"VENDA_30DD\" in df.columns:\n            df_abc = df.filter(pl.col(\"VENDA_30DD\") > 0).sort(\"VENDA_30DD\", descending=True)\n\n            total_produtos = len(df_abc)\n            if total_produtos > 0:\n                # Curva ABC: A=20%, B=30%, C=50%\n                limite_a = int(total_produtos * 0.2)\n                limite_b = int(total_produtos * 0.5)\n\n                distribuicao_abc[\"A\"] = limite_a\n                distribuicao_abc[\"B\"] = limite_b - limite_a\n                distribuicao_abc[\"C\"] = total_produtos - limite_b\n\n        return {\n            \"vendas_por_categoria\": vendas_categoria,\n            \"giro_estoque\": giro_estoque,\n            \"distribuicao_abc\": distribuicao_abc\n        }\n\n    except Exception as e:\n        logger.error(f\"Error in sales analysis: {e}\", exc_info=True)\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error analyzing sales: {str(e)}\"\n        )", "mimetype": "text/plain", "start_char_idx": 9610, "end_char_idx": 10664, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "95550363-55fe-4a5f-af0d-df0dbd90a656": {"__data__": {"id_": "95550363-55fe-4a5f-af0d-df0dbd90a656", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth.py", "language": "python", "lines": 207, "filename": "auth.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0a32108a-a19e-45c5-b967-ea3496ec4151", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth.py", "language": "python", "lines": 207, "filename": "auth.py"}, "hash": "dc11add2fbd6c060241764958949de7748ff195761999e5a7b45bac9211498b9", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "6037fc0c-32ba-4765-bd2a-f29669d6fb10", "node_type": "1", "metadata": {}, "hash": "ee545d1d846fc8b7f40b2ea77de4ca35502e610264dfd39ee44a5f0a78728311", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"Authentication Endpoints\nLogin, logout, refresh token, and current user\n\"\"\"\n\nfrom datetime import datetime, timezone\nfrom typing import Annotated\n\nimport logging\nlogger = logging.getLogger(__name__) # General logger\nsecurity_logger = logging.getLogger(\"security\") # Dedicated security logger\n\nfrom fastapi import APIRouter, Depends, HTTPException, Form, status\nfrom sqlalchemy import select\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom app.api.dependencies import get_current_active_user\nfrom app.config.database import get_db\nfrom app.config.security import (\n    create_access_token,\n    create_refresh_token,\n    verify_password,\n    decode_token,\n    get_password_hash, # Added for password change logging\n)\nfrom app.infrastructure.database.models import User\nfrom app.schemas.auth import LoginRequest, RefreshTokenRequest, Token\nfrom app.schemas.user import UserResponse\n\nrouter = APIRouter(prefix=\"/auth\", tags=[\"Authentication\"])\n\n@router.post(\"/login\", response_model=Token)\nasync def login(\n    login_data: LoginRequest,\n    db: Annotated[AsyncSession, Depends(get_db)],\n) -> Token:\n    \"\"\"\n    Production authentication endpoint - optimized for speed.\n\n    Uses hybrid authentication:\n    1. Parquet (primary, fast)\n    2. SQL Server (only if explicitly enabled and USE_SQL_SERVER=true)\n\n    Fast and efficient with proper error handling.\n    \"\"\"\n    from app.core.auth_service import auth_service\n    from app.config.settings import settings\n\n    # Autentica usando Parquet diretamente quando SQL Server desabilitado\n    user_data = await auth_service.authenticate_user(\n        username=login_data.username,\n        password=login_data.password,\n        db=db if settings.USE_SQL_SERVER else None,\n    )\n\n    if not user_data:\n        security_logger.warning(f\"Failed login attempt for username: {login_data.username}\")\n        raise HTTPException(\n            status_code=status.HTTP_401_UNAUTHORIZED,\n            detail=\"Incorrect username or password\",\n            headers={\"WWW-Authenticate\": \"Bearer\"},\n        )\n\n    if not user_data.get(\"is_active\", False):\n        security_logger.warning(f\"Inactive user '{user_data.get('username')}' attempted to log in.\")\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"Inactive user\"\n        )\n\n    # Generate tokens\n    token_data = {\n        \"sub\": user_data[\"id\"],\n        \"username\": user_data[\"username\"],\n        \"role\": user_data[\"role\"],\n        \"allowed_segments\": user_data.get(\"allowed_segments\", [])\n    }\n    access_token = create_access_token(token_data)\n    refresh_token = create_refresh_token(token_data)\n\n    security_logger.info(f\"User '{user_data['username']}' logged in successfully.\")\n    return Token(\n        access_token=access_token,\n        refresh_token=refresh_token,\n        token_type=\"bearer\"\n    )\n\n@router.post(\"/login_form\", response_model=Token)\nasync def login_form(\n    username: str = Form(...),\n    password: str = Form(...),\n    db: AsyncSession = Depends(get_db),\n) -> Token:\n    \"\"\"Login endpoint that accepts form data (used by HTML login page).\"\"\"\n    result = await db.execute(select(User).where(User.username == username))\n    user = result.scalar_one_or_none()\n    if not user or not verify_password(password, user.hashed_password):\n        security_logger.warning(f\"Failed login (form) attempt for username: {username}\")\n        raise HTTPException(\n            status_code=status.HTTP_401_UNAUTHORIZED,\n            detail=\"Incorrect username or password\",\n            headers={\"WWW-Authenticate\": \"Bearer\"},\n        )\n    if not user.is_active:\n        security_logger.warning(f\"Inactive user '{username}' attempted to log in (form).\")\n        raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail=\"Inactive user\")\n    user.last_login = datetime.now(timezone.utc)\n    await db.commit()\n    token_data = {\"sub\": str(user.id), \"username\": user.username, \"role\": user.role}\n    access_token = create_access_token(token_data)\n    refresh_token = create_refresh_token(token_data)\n    security_logger.info(f\"User '{username}' logged in successfully (form).\")\n    return Token(access_token=access_token, refresh_token=refresh_token, token_type=\"bearer\")\n\n@router.post(\"/refresh\", response_model=Token)\nasync def refresh_token(\n    refresh_data: RefreshTokenRequest,\n    db: Annotated[AsyncSession, Depends(get_db)],\n) -> Token:\n    \"\"\"Refresh access token using refresh token.\"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4455, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6037fc0c-32ba-4765-bd2a-f29669d6fb10": {"__data__": {"id_": "6037fc0c-32ba-4765-bd2a-f29669d6fb10", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth.py", "language": "python", "lines": 207, "filename": "auth.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0a32108a-a19e-45c5-b967-ea3496ec4151", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth.py", "language": "python", "lines": 207, "filename": "auth.py"}, "hash": "dc11add2fbd6c060241764958949de7748ff195761999e5a7b45bac9211498b9", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "95550363-55fe-4a5f-af0d-df0dbd90a656", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth.py", "language": "python", "lines": 207, "filename": "auth.py"}, "hash": "df06f7d7454262095fe51ef673addf122ca8b8684a926823784a78c30428ce5f", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "9779d1c5-856d-497c-8c52-ed337d288f95", "node_type": "1", "metadata": {}, "hash": "159225c12a1f801b1f6a33a919bc2a65b7b284b8a75cb2c9385b12823a99bbea", "class_name": "RelatedNodeInfo"}}, "text": "raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail=\"Inactive user\")\n    user.last_login = datetime.now(timezone.utc)\n    await db.commit()\n    token_data = {\"sub\": str(user.id), \"username\": user.username, \"role\": user.role}\n    access_token = create_access_token(token_data)\n    refresh_token = create_refresh_token(token_data)\n    security_logger.info(f\"User '{username}' logged in successfully (form).\")\n    return Token(access_token=access_token, refresh_token=refresh_token, token_type=\"bearer\")\n\n@router.post(\"/refresh\", response_model=Token)\nasync def refresh_token(\n    refresh_data: RefreshTokenRequest,\n    db: Annotated[AsyncSession, Depends(get_db)],\n) -> Token:\n    \"\"\"Refresh access token using refresh token.\"\"\"\n    try:\n        payload = decode_token(refresh_data.refresh_token)\n        if payload.get(\"type\") != \"refresh\":\n            security_logger.warning(f\"Invalid token type for refresh: {payload.get('type')}\")\n            raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail=\"Invalid token type\")\n        user_id = payload.get(\"sub\")\n        if not user_id:\n            security_logger.warning(\"Refresh token payload missing user ID.\")\n            raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail=\"Invalid token\")\n        result = await db.execute(select(User).where(User.id == user_id))\n        user = result.scalar_one_or_none()\n        if not user or not user.is_active:\n            security_logger.warning(f\"Refresh token for non-existent or inactive user ID: {user_id}\")\n            raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail=\"User not found or inactive\")\n        token_data = {\n            \"sub\": str(user.id), \n            \"username\": user.username, \n            \"role\": user.role,\n            \"allowed_segments\": getattr(user, \"allowed_segments\", [])\n        }\n        access_token = create_access_token(token_data)\n        new_refresh_token = create_refresh_token(token_data)\n        security_logger.info(f\"User '{user.username}' refreshed token successfully.\")\n        return Token(access_token=access_token, refresh_token=new_refresh_token, token_type=\"bearer\")\n    except JWTError as e:\n        security_logger.warning(f\"JWT Error during token refresh: {e}\")\n        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail=\"Invalid refresh token\")\n\n\n@router.get(\"/me\", response_model=UserResponse)\nasync def get_current_user_info(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n) -> UserResponse:\n    \"\"\"Get current authenticated user information.\"\"\"\n    return current_user\n\n@router.post(\"/logout\")\nasync def logout(current_user: Annotated[User, Depends(get_current_active_user)]) -> dict[str, str]:\n    \"\"\"Placeholder logout endpoint (client can discard tokens).\"\"\"\n    security_logger.info(f\"User '{current_user.username}' logged out.\")\n    return {\"detail\": \"Logged out\"}", "mimetype": "text/plain", "start_char_idx": 3715, "end_char_idx": 6637, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9779d1c5-856d-497c-8c52-ed337d288f95": {"__data__": {"id_": "9779d1c5-856d-497c-8c52-ed337d288f95", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth.py", "language": "python", "lines": 207, "filename": "auth.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0a32108a-a19e-45c5-b967-ea3496ec4151", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth.py", "language": "python", "lines": 207, "filename": "auth.py"}, "hash": "dc11add2fbd6c060241764958949de7748ff195761999e5a7b45bac9211498b9", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "6037fc0c-32ba-4765-bd2a-f29669d6fb10", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth.py", "language": "python", "lines": 207, "filename": "auth.py"}, "hash": "d5c8a6edf55b750b9945da38d9963e671397d9ee6633bf8a023b1c8dc1b47349", "class_name": "RelatedNodeInfo"}}, "text": "return Token(access_token=access_token, refresh_token=new_refresh_token, token_type=\"bearer\")\n    except JWTError as e:\n        security_logger.warning(f\"JWT Error during token refresh: {e}\")\n        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail=\"Invalid refresh token\")\n\n\n@router.get(\"/me\", response_model=UserResponse)\nasync def get_current_user_info(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n) -> UserResponse:\n    \"\"\"Get current authenticated user information.\"\"\"\n    return current_user\n\n@router.post(\"/logout\")\nasync def logout(current_user: Annotated[User, Depends(get_current_active_user)]) -> dict[str, str]:\n    \"\"\"Placeholder logout endpoint (client can discard tokens).\"\"\"\n    security_logger.info(f\"User '{current_user.username}' logged out.\")\n    return {\"detail\": \"Logged out\"}\n\n\n@router.post(\"/change-password\")\nasync def change_password(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    old_password: str = Form(...),\n    new_password: str = Form(...)\n):\n    \"\"\"Change user password (updates Parquet only).\"\"\"\n    import polars as pl\n    from pathlib import Path\n\n    # Verify old password\n    if not verify_password(old_password, current_user.hashed_password):\n        security_logger.warning(f\"User '{current_user.username}' failed to change password - incorrect old password.\")\n        raise HTTPException(status_code=400, detail=\"Incorrect old password\")\n\n    # Determine Parquet path (same logic as auth_service)\n    docker_path = Path(\"/app/data/parquet/users.parquet\")\n    dev_path = Path(__file__).parent.parent.parent.parent.parent.parent / \"data\" / \"parquet\" / \"users.parquet\"\n    parquet_path = docker_path if docker_path.exists() else dev_path\n\n    if not parquet_path.exists():\n        security_logger.error(f\"User database (Parquet) not found for password change for user '{current_user.username}'.\")\n        raise HTTPException(status_code=500, detail=\"User database not found\")\n\n    try:\n        df = pl.read_parquet(parquet_path)\n        new_hash = get_password_hash(new_password)\n        \n        # Update password for specific user\n        df = df.with_columns(\n            pl.when(pl.col(\"id\") == current_user.id)\n            .then(pl.lit(new_hash))\n            .otherwise(pl.col(\"hashed_password\"))\n            .alias(\"hashed_password\")\n        )\n        \n        df.write_parquet(parquet_path)\n        security_logger.info(f\"User '{current_user.username}' changed password successfully.\")\n        return {\"message\": \"Password updated successfully\"}\n        \n    except Exception as e:\n        security_logger.error(f\"Failed to update password for user '{current_user.username}': {e}\")\n        raise HTTPException(status_code=500, detail=f\"Failed to update password: {str(e)}\")", "mimetype": "text/plain", "start_char_idx": 5794, "end_char_idx": 8584, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "33ae3e09-337c-43f8-80f5-a159d9de582a": {"__data__": {"id_": "33ae3e09-337c-43f8-80f5-a159d9de582a", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth_alt.py", "language": "python", "lines": 121, "filename": "auth_alt.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4ba513da-8176-4c46-bd36-559b7325ea0d", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth_alt.py", "language": "python", "lines": 121, "filename": "auth_alt.py"}, "hash": "b393c2ec5ca82602396a19938a5d6b8aa452424cdf6a0a9de0f900f8326aa435", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nENDPOINT DE LOGIN ALTERNATIVO - USA PYODBC DIRETO (S\u00cdNCRONO)\nBypass do problema com aioodbc\n\"\"\"\nfrom fastapi import APIRouter, HTTPException, status\nfrom pydantic import BaseModel\nimport pyodbc\nimport bcrypt\nfrom app.config.security import create_access_token, create_refresh_token\n\nrouter_alt = APIRouter(prefix=\"/auth-alt\", tags=[\"Auth Alternative\"])\n\nclass LoginRequest(BaseModel):\n    username: str\n    password: str\n\nclass UserData(BaseModel):\n    id: str\n    username: str\n    email: str\n    role: str\n\nclass Token(BaseModel):\n    access_token: str\n    refresh_token: str\n    token_type: str\n    user: UserData\n\n@router_alt.post(\"/login\", response_model=Token)\ndef login_alt(login_data: LoginRequest):\n    \"\"\"\n    Login alternativo usando pyodbc s\u00edncrono\n    \"\"\"\n    try:\n        # Conectar diretamente com pyodbc\n        conn = pyodbc.connect(\n            \"DRIVER={ODBC Driver 17 for SQL Server};\"\n            \"SERVER=FAMILIA\\\\SQLJR,1433;\"\n            \"DATABASE=agentbi;\"\n            \"UID=AgenteVirtual;\"\n            \"PWD=Cacula@2020;\"\n            \"TrustServerCertificate=yes;\",\n            timeout=5\n        )\n        cursor = conn.cursor()\n        \n        # Buscar usu\u00e1rio\n        cursor.execute(\n            \"SELECT id, username, email, hashed_password, role, is_active FROM users WHERE username = ?\",\n            (login_data.username,)\n        )\n        user = cursor.fetchone()\n        \n        if not user:\n            raise HTTPException(\n                status_code=status.HTTP_401_UNAUTHORIZED,\n                detail=\"Incorrect username or password\"\n            )\n        \n        user_id, username, email, hashed_password, role, is_active = user\n        \n        # Verificar senha\n        if not bcrypt.checkpw(login_data.password.encode('utf-8'), hashed_password.encode('utf-8')):\n            raise HTTPException(\n                status_code=status.HTTP_401_UNAUTHORIZED,\n                detail=\"Incorrect username or password\"\n            )\n        \n        # Verificar se est\u00e1 ativo\n        if not is_active:\n            raise HTTPException(\n                status_code=status.HTTP_403_FORBIDDEN,\n                detail=\"Inactive user\"\n            )\n        \n        # Atualizar last_login\n        cursor.execute(\n            \"UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?\",\n            (str(user_id),)\n        )\n        conn.commit()\n        \n        cursor.close()\n        conn.close()\n        \n        # Criar tokens\n        token_data = {\n            \"sub\": str(user_id),\n            \"username\": username,\n            \"role\": role,\n        }\n        \n        access_token = create_access_token(token_data)\n        refresh_token = create_refresh_token(token_data)\n        \n        # Criar objeto de usu\u00e1rio\n        user_data = UserData(\n            id=str(user_id),\n            username=username,\n            email=email or \"\",\n            role=role\n        )\n        \n        return Token(\n            access_token=access_token,\n            refresh_token=refresh_token,\n            token_type=\"bearer\",\n            user=user_data\n        )\n        \n    except pyodbc.Error as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Database error: {str(e)}\"\n        )\n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error: {str(e)}\"\n        )", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3439, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "171f1fb8-9973-43f4-8978-0d0707a6fbd1": {"__data__": {"id_": "171f1fb8-9973-43f4-8978-0d0707a6fbd1", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "8af8abd0-43ad-4548-a883-60adf617a50d", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "1714a199813f7f4e48de32b33120710717dea30182254fffbfcd61d75657b7d6", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b35ed1c8-d20a-4a01-b17b-3ef33c4fb3ce", "node_type": "1", "metadata": {}, "hash": "2cd81f6b2458ec60279937ccc0b67421fafbc2fd1299f5ffde4955e88f77af1b", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nChat Endpoints\nBI Chat with AI assistant\n\"\"\"\n\nfrom typing import Annotated, Dict, Any, Optional\nfrom fastapi import APIRouter, Depends, HTTPException, Request, status\nfrom fastapi.responses import ORJSONResponse, StreamingResponse\nfrom pydantic import BaseModel\nfrom pathlib import Path\nimport json\nimport asyncio\nimport logging\nimport sys\nimport numpy as np\nimport pandas as pd\nfrom decimal import Decimal\nfrom datetime import datetime, date\n\n# Import core dependencies\nfrom app.api.dependencies import get_current_active_user\nfrom app.infrastructure.database.models import User\nfrom app.config.settings import settings\nfrom app.core.utils.response_cache import ResponseCache\nfrom app.core.utils.query_history import QueryHistory\nfrom app.core.utils.field_mapper import FieldMapper\nfrom app.core.rag.query_retriever import QueryRetriever\nfrom app.core.learning.pattern_matcher import PatternMatcher\nfrom app.core.agents.code_gen_agent import CodeGenAgent\nfrom app.core.agents.caculinha_bi_agent import CaculinhaBIAgent\nfrom app.core.llm_gemini_adapter import GeminiLLMAdapter\nfrom app.core.utils.error_handler import APIError\nfrom app.core.utils.session_manager import SessionManager\nfrom app.core.utils.semantic_cache import cache_get, cache_set, cache_stats\nfrom app.core.utils.response_validator import validate_response, validator_stats\n\nlogger = logging.getLogger(__name__)\n\n\ndef safe_json_dumps(obj: Any, **kwargs) -> str:\n    \"\"\"\n    Safely serialize any Python object to JSON string.\n    Handles MapComposite, numpy types, pandas types, datetime, and other non-serializable objects.\n    \"\"\"\n    def default_handler(o):\n        # Handle numpy types\n        if isinstance(o, (np.integer, np.int64, np.int32, np.int16, np.int8)):\n            return int(o)\n        elif isinstance(o, (np.floating, np.float64, np.float32, np.float16)):\n            if np.isnan(o) or np.isinf(o):\n                return None\n            return float(o)\n        elif isinstance(o, np.ndarray):\n            return o.tolist()\n        elif isinstance(o, np.bool_):\n            return bool(o)\n\n        # Handle pandas types\n        elif isinstance(o, pd.Timestamp):\n            return o.isoformat()\n        elif isinstance(o, pd.Timedelta):\n            return str(o)\n        elif pd.isna(o):\n            return None\n\n        # Handle datetime types\n        elif isinstance(o, (datetime, date)):\n            return o.isoformat()\n\n        # Handle Decimal\n        elif isinstance(o, Decimal):\n            return float(o)\n\n        # Handle bytes\n        elif isinstance(o, bytes):\n            return o.decode('utf-8', errors='ignore')\n\n        # Handle SQLAlchemy Row/MapComposite and similar mapping types\n        elif hasattr(o, '_mapping'):\n            return dict(o._mapping)\n        elif hasattr(o, '__dict__') and not isinstance(o, type):\n            # Generic object with __dict__\n            return {k: v for k, v in o.__dict__.items() if not k.startswith('_')}\n\n        # Last resort: convert to string\n        else:\n            return str(o)\n\n    try:\n        # Merge default handler with any custom kwargs\n        if 'default' not in kwargs:\n            kwargs['default'] = default_handler\n        return json.dumps(obj, **kwargs)\n    except Exception as e:\n        logger.error(f\"Failed to serialize object: {e}\", exc_info=True)\n        # Ultimate fallback: return error as JSON\n        return json.dumps({\"error\": f\"Serialization failed: {str(e)}\"}, ensure_ascii=False)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3465, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b35ed1c8-d20a-4a01-b17b-3ef33c4fb3ce": {"__data__": {"id_": "b35ed1c8-d20a-4a01-b17b-3ef33c4fb3ce", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "8af8abd0-43ad-4548-a883-60adf617a50d", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "1714a199813f7f4e48de32b33120710717dea30182254fffbfcd61d75657b7d6", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "171f1fb8-9973-43f4-8978-0d0707a6fbd1", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "aa084b3517db14cd561a10b3afea1093aac547499dcebdeffc7e0ee7ed25b4aa", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "50a71ecb-7625-41c3-ade1-d13c50f73a86", "node_type": "1", "metadata": {}, "hash": "d81435ee7989654059361d255a3bf947f49fb1c3449306050b6052b2f6660273", "class_name": "RelatedNodeInfo"}}, "text": "# Initialize agents and LLM globally for performance.\nllm = None\nfield_mapper = None\nquery_retriever = None\npattern_matcher = None\nresponse_cache = None\nquery_history = None\ncode_gen_agent = None\ncaculinha_bi_agent = None\nsession_manager = None\n\ndef _initialize_agents_and_llm():\n    global llm, field_mapper, query_retriever, pattern_matcher, response_cache, query_history, code_gen_agent, caculinha_bi_agent, session_manager\n    if llm is None:\n        logger.info(\"Initializing LLM and Agents...\")\n        if not settings.GEMINI_API_KEY:\n            logger.error(\"GEMINI_API_KEY is not set. LLM will not be initialized.\")\n            raise ValueError(\"GEMINI_API_KEY must be set in environment variables.\")\n\n        # System instruction for conversational ChatBI\n        chatbi_system_instruction = \"\"\"Voc\u00ea \u00e9 um assistente conversacional inteligente com expertise em Business Intelligence.\nResponda a qualquer pergunta de forma \u00fatil e precisa.\nPara perguntas sobre dados de BI (estoque, vendas, produtos, etc.), use as ferramentas dispon\u00edveis.\nSeja conversacional, amig\u00e1vel e preciso.\"\"\"\n\n        llm = GeminiLLMAdapter(\n            model_name=settings.LLM_MODEL_NAME,\n            gemini_api_key=settings.GEMINI_API_KEY,\n            system_instruction=chatbi_system_instruction\n        ).get_llm()\n        \n        field_mapper = FieldMapper()\n        query_retriever = QueryRetriever(\n            embedding_model_name=settings.RAG_EMBEDDING_MODEL,\n            faiss_index_path=settings.RAG_FAISS_INDEX_PATH,\n            examples_path=settings.LEARNING_EXAMPLES_PATH\n        )\n        pattern_matcher = PatternMatcher()\n        response_cache = ResponseCache(cache_dir=\"data/cache\", ttl_minutes=settings.CACHE_TTL_MINUTES)\n        query_history = QueryHistory(history_dir=\"data/query_history\")\n        session_manager = SessionManager(storage_dir=\"app/data/sessions\")\n\n        code_gen_agent = CodeGenAgent(\n            llm=llm,\n            field_mapper=field_mapper,\n            query_retriever=query_retriever,\n            pattern_matcher=pattern_matcher,\n            response_cache=response_cache,\n            query_history=query_history\n        )\n        caculinha_bi_agent = CaculinhaBIAgent(\n            llm=llm,\n            code_gen_agent=code_gen_agent,\n            field_mapper=field_mapper\n        )\n        logger.info(\"LLM and Agents initialized successfully.\")\n\n_initialize_agents_and_llm()\n\nrouter = APIRouter(prefix=\"/chat\", tags=[\"Chat\"])\n\n\nclass ChatRequest(BaseModel):\n    query: str\n\n\nclass FeedbackRequest(BaseModel):\n    response_id: str\n    feedback_type: str\n    comment: Optional[str] = None\n\n\nclass ChatResponse(BaseModel):\n    response: str\n\n\n@router.get(\"/stream\")\nasync def stream_chat(\n    q: str,\n    token: str,\n    session_id: str,\n    request: Request,\n):\n    \"\"\"\n    Streaming endpoint using Server-Sent Events (SSE)\n    Integrates the agent system for dynamic responses.\n    \"\"\"", "mimetype": "text/plain", "start_char_idx": 3468, "end_char_idx": 6384, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "50a71ecb-7625-41c3-ade1-d13c50f73a86": {"__data__": {"id_": "50a71ecb-7625-41c3-ade1-d13c50f73a86", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "8af8abd0-43ad-4548-a883-60adf617a50d", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "1714a199813f7f4e48de32b33120710717dea30182254fffbfcd61d75657b7d6", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b35ed1c8-d20a-4a01-b17b-3ef33c4fb3ce", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "609a4d6b443dfff5e538dae9083523cdcccb317a64bb751af1ac12ade7a0026f", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "d0884373-d5ad-4f15-a62f-da1f9d32c644", "node_type": "1", "metadata": {}, "hash": "58fe20184c20985e122ebcbdc0d1bb1097f98e76de089f18d139e07b7e16a5ec", "class_name": "RelatedNodeInfo"}}, "text": "class ChatRequest(BaseModel):\n    query: str\n\n\nclass FeedbackRequest(BaseModel):\n    response_id: str\n    feedback_type: str\n    comment: Optional[str] = None\n\n\nclass ChatResponse(BaseModel):\n    response: str\n\n\n@router.get(\"/stream\")\nasync def stream_chat(\n    q: str,\n    token: str,\n    session_id: str,\n    request: Request,\n):\n    \"\"\"\n    Streaming endpoint using Server-Sent Events (SSE)\n    Integrates the agent system for dynamic responses.\n    \"\"\"\n    from app.api.dependencies import get_current_user_from_token\n\n    try:\n        current_user = await get_current_user_from_token(token)\n        logger.info(f\"SSE authenticated user: {current_user.username}\")\n    except Exception as e:\n        logger.error(f\"SSE authentication failed: {e}\")\n        async def error_generator():\n            yield f\"data: {safe_json_dumps({'error': 'N\u00e3o autenticado'})}\\n\\n\"\n        return StreamingResponse(error_generator(), media_type=\"text/event-stream\")\n\n    last_event_id = request.headers.get(\"Last-Event-ID\")\n    logger.info(f\"==> SSE STREAM REQUEST: {q} (Session: {session_id}) (Last-Event-ID: {last_event_id}) <==\")\n    \n    async def event_generator():\n        try:\n            event_counter = int(last_event_id) if last_event_id else 0\n            \n            if caculinha_bi_agent is None:\n                yield f\"data: {safe_json_dumps({'error': 'Agent system not initialized'})}\\n\\n\"\n                return\n\n            # Retrieve History\n            chat_history = session_manager.get_history(session_id)\n            # Add User Message to History immediately\n            session_manager.add_message(session_id, \"user\", q)\n\n            logger.info(f\"Processing query with CaculinhaBIAgent: '{q}' | History len: {len(chat_history)}\")\n            \n            # NOVO: Verificar Semantic Cache primeiro\n            cached_response = cache_get(q)\n            if cached_response:\n                logger.info(f\"CACHE HIT: Resposta encontrada em cache para: {q[:50]}...\")\n                event_counter += 1\n                yield f\"id: {event_counter}\\n\"\n                yield f\"data: {safe_json_dumps({'type': 'cache_hit', 'done': False})}\\n\\n\"\n                agent_response = cached_response\n            else:\n                # Run Agent with History (cache miss)\n                agent_response = await asyncio.to_thread(caculinha_bi_agent.run, user_query=q, chat_history=chat_history)\n                \n                # Salvar resposta v\u00e1lida em cache\n                if agent_response and \"error\" not in str(agent_response).lower():\n                    cache_set(q, agent_response)\n                    logger.info(f\"Cache SET: Resposta salva para: {q[:50]}...\")\n            \n            if not agent_response:\n                logger.warning(f\"Agent retornou resposta vazia para query: {q}\")\n                agent_response = {\n                    \"type\": \"text\",\n                    \"result\": {\n                        \"mensagem\": f\"Desculpe, n\u00e3o consegui processar sua pergunta. Por favor, reformule e tente novamente.\"\n                    }\n                }\n            \n            logger.info(f\"Agent response received: {agent_response}\")\n\n            # NOVO: Validar resposta com Response Validator\n            validation = validate_response(agent_response, q)\n            if not validation.is_valid:\n                logger.warning(f\"Validacao: confidence={validation.confidence:.2f}, issues={validation.issues}\")\n                # Adicionar aviso \u00e0 resposta se houver problemas\n                if validation.confidence < 0.5:\n                    event_counter += 1\n                    yield f\"id: {event_counter}\\n\"\n                    yield f\"data: {safe_json_dumps({'type': 'warning', 'message': 'Resposta com baixa confian\u00e7a. Verifique os dados.', 'done': False})}\\n\\n\"\n            else:\n                logger.info(f\"Validacao OK: confidence={validation.confidence:.2f}\")\n\n            response_type = agent_response.get(\"type\", \"text\")\n            response_content = agent_response.get(\"result\")\n            response_text = \"\"\n\n            if response_type == \"text\" or response_type == \"tool_result\":\n                response_text = agent_response.get(\"result\", {}).get(\"mensagem\", \"\") if response_type == \"tool_result\" else agent_response.get(\"result\", \"\")\n                if not response_text:\n                    response_text = str(agent_response.get(\"result\", \"\"))\n                \n                if not response_text or (isinstance(response_text, str) and not response_text.strip()):\n                    response_text = \"Resposta processada, mas nenhum texto foi gerado. Por favor, tente reformular sua pergunta.\"", "mimetype": "text/plain", "start_char_idx": 5928, "end_char_idx": 10564, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d0884373-d5ad-4f15-a62f-da1f9d32c644": {"__data__": {"id_": "d0884373-d5ad-4f15-a62f-da1f9d32c644", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "8af8abd0-43ad-4548-a883-60adf617a50d", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "1714a199813f7f4e48de32b33120710717dea30182254fffbfcd61d75657b7d6", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "50a71ecb-7625-41c3-ade1-d13c50f73a86", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "d8366c06b5ba52ff53c226c4f70db74b0d5a549e9cf2bc699e0280946416962d", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b7bc953d-1b23-4fe4-a98e-87ade49f0703", "node_type": "1", "metadata": {}, "hash": "1d2ac59a57d594d5363a3464e191642f2f29b07031ce144c64e0afcd11e338e6", "class_name": "RelatedNodeInfo"}}, "text": "Verifique os dados.', 'done': False})}\\n\\n\"\n            else:\n                logger.info(f\"Validacao OK: confidence={validation.confidence:.2f}\")\n\n            response_type = agent_response.get(\"type\", \"text\")\n            response_content = agent_response.get(\"result\")\n            response_text = \"\"\n\n            if response_type == \"text\" or response_type == \"tool_result\":\n                response_text = agent_response.get(\"result\", {}).get(\"mensagem\", \"\") if response_type == \"tool_result\" else agent_response.get(\"result\", \"\")\n                if not response_text:\n                    response_text = str(agent_response.get(\"result\", \"\"))\n                \n                if not response_text or (isinstance(response_text, str) and not response_text.strip()):\n                    response_text = \"Resposta processada, mas nenhum texto foi gerado. Por favor, tente reformular sua pergunta.\"\n\n                if not isinstance(response_text, str):\n                    response_text = str(response_text)\n            \n            \n            elif response_type == \"code_result\":\n                chart_spec = agent_response.get(\"chart_spec\")\n\n                # Log para debug\n                logger.info(f\"DEBUG: response_content = {response_content}\")\n                \n                # O agent retorna: {\"result\": {\"result\": [...], \"chart_spec\": ...}, \"chart_spec\": ...}\n                # Ent\u00e3o precisamos acessar response_content[\"result\"] para pegar os dados\n                if response_content and isinstance(response_content, dict):\n                    # Verificar se h\u00e1 dados aninhados em \"result\"\n                    if \"result\" in response_content:\n                        table_data = response_content.get(\"result\")\n                    else:\n                        # Caso os dados estejam diretamente em response_content\n                        table_data = response_content\n                    \n                    logger.info(f\"DEBUG: table_data type = {type(table_data)}, is_list = {isinstance(table_data, list)}\")\n                    if isinstance(table_data, list):\n                        logger.info(f\"DEBUG: table_data length = {len(table_data)}, first_item = {table_data[0] if len(table_data) > 0 else 'empty'}\")\n                    \n                    if isinstance(table_data, list) and len(table_data) > 0 and isinstance(table_data[0], dict):\n                        # Enviar texto introdut\u00f3rio ANTES da tabela\n                        intro_text = f\"Aqui est\u00e3o os {len(table_data)} resultados da sua consulta:\"\n                        \n                        # Stream do texto introdut\u00f3rio palavra por palavra\n                        intro_words = intro_text.split(\" \")\n                        for i in range(0, len(intro_words), 1):\n                            chunk_words = intro_words[i:i + 1]\n                            prefix = \" \" if i > 0 else \"\"\n                            chunk_text = prefix + \" \".join(chunk_words)\n                            event_counter += 1\n                            yield f\"id: {event_counter}\\n\"\n                            yield f\"data: {safe_json_dumps({'type': 'text', 'text': chunk_text, 'done': False})}\\n\\n\"\n                        \n                        # Converter MapComposite para dict antes de serializar\n                        def convert_row(row):\n                            \"\"\"Converte objetos MapComposite e similares para dict\"\"\"\n                            if hasattr(row, '_mapping'):\n                                return dict(row._mapping)\n                            elif isinstance(row, dict):\n                                # Converter valores internos tamb\u00e9m\n                                return {k: (dict(v._mapping) if hasattr(v, '_mapping') else v) for k, v in row.items()}\n                            return row\n                        \n                        # Converter todos os dados\n                        clean_table_data = [convert_row(row) for row in table_data]\n                        \n                        # Agora enviar a tabela com dados limpos\n                        event_counter += 1\n                        yield f\"id: {event_counter}\\n\"\n                        columns = list(clean_table_data[0].keys())\n                        yield f\"data: {safe_json_dumps({'type': 'table', 'data': clean_table_data, 'columns': columns, 'done': False})}\\n\\n\"\n                        logger.info(f\"Streaming table data with {len(clean_table_data)} rows...\")\n                        \n                        # Limpar response_text para n\u00e3o enviar texto adicional\n                        response_text = \"\"\n                    else:\n                        response_text = f\"Resultados da sua an\u00e1lise:\\n```json\\n{safe_json_dumps(response_content, indent=2, ensure_ascii=False)}\\n```\"\n                elif response_content:\n                    response_text = f\"Resultados da sua an\u00e1lise:\\n```json\\n{safe_json_dumps(response_content, indent=2, ensure_ascii=False)}\\n```\"\n                else:\n                    response_text = \"Sua an\u00e1lise foi processada.\"", "mimetype": "text/plain", "start_char_idx": 9668, "end_char_idx": 14732, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b7bc953d-1b23-4fe4-a98e-87ade49f0703": {"__data__": {"id_": "b7bc953d-1b23-4fe4-a98e-87ade49f0703", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "8af8abd0-43ad-4548-a883-60adf617a50d", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "1714a199813f7f4e48de32b33120710717dea30182254fffbfcd61d75657b7d6", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "d0884373-d5ad-4f15-a62f-da1f9d32c644", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "9b1831d7f1d779a2d16635d8eddcea4ebf7c7a38fc0e4fce7bace61df1de56a9", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "43cf191f-b8b6-4323-912d-4c284c744c33", "node_type": "1", "metadata": {}, "hash": "f90ea6c6be651725d59f5d5d137bacb565818399b08f02266ef2cd7d8f5fea76", "class_name": "RelatedNodeInfo"}}, "text": "if chart_spec:\n                    event_counter += 1\n                    yield f\"id: {event_counter}\\n\"\n                    yield f\"data: {safe_json_dumps({'type': 'chart', 'chart_spec': chart_spec, 'done': False})}\\n\\n\"\n                    logger.info(\"Streaming chart spec...\")\n            \n            # Save Assistant Response to History\n            session_manager.add_message(session_id, \"assistant\", response_text if response_text else \"Dados enviados\")\n\n            # S\u00f3 fazer streaming de texto se houver texto para enviar\n            if response_text and response_text.strip():\n                words = response_text.split(\" \")\n                # Use smaller chunks for smoother streaming (like a real typewriter)\n                chunk_size = 1 \n                \n                logger.info(f\"Initiating text streaming of {len(words)} words...\")\n                \n                for i in range(0, len(words), chunk_size):\n                    chunk_words = words[i:i + chunk_size]\n                    # Reconstruct spacing correctly\n                    prefix = \" \" if i > 0 else \"\"\n                    chunk_text = prefix + \" \".join(chunk_words)\n                    \n                    event_counter += 1\n\n                    yield f\"id: {event_counter}\\n\"\n                    yield f\"data: {safe_json_dumps({'type': 'text', 'text': chunk_text, 'done': False})}\\n\\n\"\n                    \n                    # Small delay to simulate typing speed if needed, but usually network latency is enough\n                    # await asyncio.sleep(0.01)\n\n            logger.info(\"Text streaming complete. Sending done signal.\")\n            yield f\"id: {event_counter + 1}\\n\"\n            yield f\"data: {safe_json_dumps({'type': 'final', 'text': '', 'done': True})}\\n\\n\"\n\n        except APIError as e:\n            logger.error(f\"Agent API Error in stream: {e.message}\", exc_info=True)\n            yield f\"data: {safe_json_dumps({'type': 'error', 'error': e.message, 'details': e.details})}\\n\\n\"\n            yield f\"data: {safe_json_dumps({'type': 'final', 'text': '', 'done': True})}\\n\\n\"\n        except Exception as e:\n            logger.error(f\"Unexpected error in stream: {e}\", exc_info=True)\n            yield f\"data: {safe_json_dumps({'type': 'error', 'error': 'Um erro inesperado ocorreu. Tente novamente mais tarde.'})}\\n\\n\"\n            yield f\"data: {safe_json_dumps({'type': 'final', 'text': '', 'done': True})}\\n\\n\"\n    \n    return StreamingResponse(\n        event_generator(),\n        media_type=\"text/event-stream\",\n        headers={\n            \"Cache-Control\": \"no-cache\",\n            \"Connection\": \"keep-alive\",\n            \"X-Accel-Buffering\": \"no\",\n        }\n    )", "mimetype": "text/plain", "start_char_idx": 14750, "end_char_idx": 17429, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "43cf191f-b8b6-4323-912d-4c284c744c33": {"__data__": {"id_": "43cf191f-b8b6-4323-912d-4c284c744c33", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "8af8abd0-43ad-4548-a883-60adf617a50d", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "1714a199813f7f4e48de32b33120710717dea30182254fffbfcd61d75657b7d6", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b7bc953d-1b23-4fe4-a98e-87ade49f0703", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}, "hash": "9e33e5dff9e60f9f6c458ff82c2bde29d3bd06b630d8d371663ded1b3273b883", "class_name": "RelatedNodeInfo"}}, "text": "Tente novamente mais tarde.'})}\\n\\n\"\n            yield f\"data: {safe_json_dumps({'type': 'final', 'text': '', 'done': True})}\\n\\n\"\n    \n    return StreamingResponse(\n        event_generator(),\n        media_type=\"text/event-stream\",\n        headers={\n            \"Cache-Control\": \"no-cache\",\n            \"Connection\": \"keep-alive\",\n            \"X-Accel-Buffering\": \"no\",\n        }\n    )\n\n\n@router.post(\"/feedback\")\nasync def submit_feedback(\n    feedback_data: FeedbackRequest,\n    current_user: Annotated[User, Depends(get_current_active_user)],\n):\n    if query_history is None:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=\"QueryHistory system not initialized.\"\n        )\n    \n    feedback_entry = {\n        \"timestamp\": \"now\", # Placeholder, would import datetime\n        \"user_id\": current_user.username,\n        \"response_id\": feedback_data.response_id,\n        \"feedback_type\": feedback_data.feedback_type,\n        \"comment\": feedback_data.comment\n    }\n    \n    feedback_file_path = Path(settings.LEARNING_FEEDBACK_PATH) / \"feedback.jsonl\"\n    os.makedirs(Path(settings.LEARNING_FEEDBACK_PATH), exist_ok=True)\n    try:\n        with open(feedback_file_path, \"a\", encoding=\"utf-8\") as f:\n            f.write(safe_json_dumps(feedback_entry, ensure_ascii=False) + \"\\n\")\n        logger.info(f\"Feedback submitted by {current_user.username}: {feedback_entry}\")\n    except OSError as e:\n        logger.error(f\"Failed to write feedback to file: {e}\", exc_info=True)\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=\"Failed to save feedback.\"\n        )\n\n    return {\"message\": \"Feedback submitted successfully.\"}\n\n@router.post(\"\", response_class=ORJSONResponse)\nasync def send_chat_message(\n    request: ChatRequest,\n    current_user: Annotated[User, Depends(get_current_active_user)],\n) -> dict:\n    # Legacy - calling agent without history for now, or could pass session_id if we updated request model\n    logger.warning(\"Legacy chat endpoint used.\")\n    if caculinha_bi_agent is None:\n        raise HTTPException(status_code=500, detail=\"Agent not init\")\n\n    # Assuming no history for legacy non-session calls\n    agent_response = await asyncio.to_thread(caculinha_bi_agent.run, user_query=request.query, chat_history=[])\n    return {\"response\": str(agent_response), \"full_agent_response\": agent_response}", "mimetype": "text/plain", "start_char_idx": 17043, "end_char_idx": 19477, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "742945ba-e49d-4739-ac7e-5d7945c50cad": {"__data__": {"id_": "742945ba-e49d-4739-ac7e-5d7945c50cad", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\code_chat.py", "language": "python", "lines": 152, "filename": "code_chat.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "5ca13317-56ef-4cc7-a3e1-f36ea4ca2bde", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\code_chat.py", "language": "python", "lines": 152, "filename": "code_chat.py"}, "hash": "edb323195c39b575c465a7ab75212aa26797d8587ca96066322be8ddc3da8137", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nCode Chat API Endpoints\n=======================\n\nProvides REST API for semantic code search and analysis.\n\nEndpoints:\n- GET  /api/v1/code-chat/stats - Get index statistics\n- POST /api/v1/code-chat/query - Query the codebase\n\nAuthor: Antigravity AI\nDate: 2025-12-15\n\"\"\"\n\nfrom typing import Annotated, List, Optional\nfrom datetime import datetime\nimport logging\n\nfrom fastapi import APIRouter, Depends, HTTPException\nfrom pydantic import BaseModel, Field\n\nfrom app.api.dependencies import get_current_active_user\nfrom app.infrastructure.database.models import User\nfrom app.core.code_rag_service import get_code_rag_service\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRouter(prefix=\"/code-chat\", tags=[\"Code Chat\"])\n\n\n# ============================================================================\n# Request/Response Models\n# ============================================================================\n\nclass ChatMessage(BaseModel):\n    \"\"\"Chat message model.\"\"\"\n    role: str  # \"user\" or \"assistant\"\n    content: str\n    timestamp: Optional[str] = None\n\n\nclass CodeChatRequest(BaseModel):\n    \"\"\"Request model for code chat queries.\"\"\"\n    message: str = Field(..., min_length=1, description=\"User's question about the code\")\n    history: List[ChatMessage] = Field(default_factory=list, description=\"Conversation history\")\n    filters: Optional[dict] = Field(default=None, description=\"Optional filters (language, directory)\")\n\n\nclass CodeReference(BaseModel):\n    \"\"\"Code reference model.\"\"\"\n    file: str\n    score: float\n    content: str\n    lines: str\n\n\nclass CodeChatResponse(BaseModel):\n    \"\"\"Response model for code chat queries.\"\"\"\n    response: str\n    code_references: List[CodeReference]\n    metadata: dict\n\n\nclass IndexStats(BaseModel):\n    \"\"\"Index statistics model.\"\"\"\n    status: str\n    total_files: int\n    total_functions: int\n    total_classes: int\n    total_lines: int\n    indexed_at: Optional[str]\n    languages: List[str]\n\n\n# ============================================================================\n# Endpoints\n# ============================================================================\n\n@router.get(\"/stats\", response_model=IndexStats)\nasync def get_index_stats(\n    current_user: Annotated[User, Depends(get_current_active_user)]\n):\n    \"\"\"\n    Get statistics about the code index.\n    \n    Returns:\n        IndexStats: Statistics about indexed code\n    \"\"\"\n    try:\n        rag_service = get_code_rag_service()\n        stats = rag_service.get_index_stats()\n        return stats\n        \n    except Exception as e:\n        logger.error(f\"Error getting index stats: {e}\", exc_info=True)\n        raise HTTPException(\n            status_code=500,\n            detail=f\"Erro ao obter estat\u00edsticas do \u00edndice: {str(e)}\"\n        )\n\n\n@router.post(\"/query\", response_model=CodeChatResponse)\nasync def query_codebase(\n    request: CodeChatRequest,\n    current_user: Annotated[User, Depends(get_current_active_user)]\n):\n    \"\"\"\n    Query the codebase with semantic search.\n    \n    Args:\n        request: CodeChatRequest with message, history, and filters\n        current_user: Authenticated user\n        \n    Returns:\n        CodeChatResponse: Response with code references and metadata\n    \"\"\"\n    try:\n        # Validate message\n        if not request.message or not request.message.strip():\n            raise HTTPException(\n                status_code=400,\n                detail=\"A mensagem n\u00e3o pode estar vazia\"\n            )\n        \n        # Get RAG service\n        rag_service = get_code_rag_service()\n        \n        # Convert history to dict format\n        history_dicts = [\n            {\"role\": msg.role, \"content\": msg.content}\n            for msg in request.history\n        ]\n        \n        # Query the codebase\n        logger.info(f\"Code chat query from {current_user.username}: {request.message[:100]}...\")\n        result = rag_service.query(\n            message=request.message,\n            history=history_dicts,\n            filters=request.filters\n        )\n        \n        return result\n        \n    except HTTPException:\n        raise\n    except Exception as e:\n        logger.error(f\"Error in code chat query: {e}\", exc_info=True)\n        raise HTTPException(\n            status_code=500,\n            detail=f\"Erro ao processar consulta: {str(e)}\"\n        )", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4315, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8e76522d-e12e-46ef-acc3-9739478eb40f": {"__data__": {"id_": "8e76522d-e12e-46ef-acc3-9739478eb40f", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\diagnostics.py", "language": "python", "lines": 198, "filename": "diagnostics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "17a12e9c-7800-4beb-a313-7223d929da87", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\diagnostics.py", "language": "python", "lines": 198, "filename": "diagnostics.py"}, "hash": "b945d484faf7275245c2e39647d86d3bb0c7e05025e88350554a48fa42d3790e", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f35d8c0a-53e9-41ad-9efd-becad964365b", "node_type": "1", "metadata": {}, "hash": "fa85ff05db657e2a8dc149d04b874bd2083ec67ee9e079e5f17476554b5466e2", "class_name": "RelatedNodeInfo"}}, "text": "from typing import Annotated, Dict, Any, List\nfrom pathlib import Path\nimport logging\n\nfrom fastapi import APIRouter, Depends, HTTPException\nfrom pydantic import BaseModel\n\nfrom app.api.dependencies import require_role\nfrom app.config.settings import settings\nfrom app.infrastructure.database.models import User\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRouter(prefix=\"/diagnostics\", tags=[\"Diagnostics\"])\n\n\nclass DBConfig(BaseModel):\n    use_sql_server: bool\n    use_supabase: bool\n    database_server: str | None\n    database_name: str | None\n    database_user: str | None\n    supabase_url: str | None\n\n\nclass ConnectionTestResult(BaseModel):\n    success: bool\n    message: str\n    version: str | None = None\n    tables: List[str] | None = None\n\n@router.get(\"/db-status\")\nasync def get_db_status(\n    current_user: Annotated[User, Depends(require_role(\"admin\"))]\n):\n    \"\"\"\n    Status das conex\u00f5es com banco de dados e arquivos.\n    \"\"\"\n    # Verificar Parquet (Root Data vs Backend Data)\n    # Backend usa logicamente: app/data/parquet OU ../../../../data/parquet\n    \n    # Vamos verificar ambos para reportar\n    backend_parquet = Path(\"/app/data/parquet/admmat.parquet\")\n    local_parquet = Path(__file__).resolve().parent.parent.parent.parent.parent.parent / \"data\" / \"parquet\" / \"admmat.parquet\"\n    \n    parquet_status = \"unknown\"\n    parquet_size = 0\n    parquet_path_used = \"none\"\n    \n    if backend_parquet.exists():\n        parquet_status = \"ok\"\n        parquet_size = backend_parquet.stat().st_size\n        parquet_path_used = str(backend_parquet)\n    elif local_parquet.exists():\n        parquet_status = \"ok\"\n        parquet_size = local_parquet.stat().st_size\n        parquet_path_used = str(local_parquet)\n    else:\n        parquet_status = \"missing\"\n\n    return {\n        \"parquet\": {\n            \"status\": parquet_status,\n            \"size_mb\": round(parquet_size / 1024 / 1024, 2) if parquet_size else 0,\n            \"path\": parquet_path_used\n        },\n        \"sql_server\": {\n            \"status\": \"enabled\" if settings.USE_SQL_SERVER else \"disabled\",\n            \"url\": settings.DATABASE_URL if settings.USE_SQL_SERVER else None\n        },\n        \"supabase\": {\n            \"status\": \"enabled\" if settings.USE_SUPABASE_AUTH else \"disabled\",\n            \"url\": settings.SUPABASE_URL if settings.USE_SUPABASE_AUTH else None\n        }\n    }\n\n\n@router.get(\"/config\", response_model=DBConfig)\nasync def get_db_config(\n    current_user: Annotated[User, Depends(require_role(\"admin\"))]\n):\n    \"\"\"\n    Retorna as configura\u00e7\u00f5es detectadas do banco de dados.\n    \"\"\"\n    # Extrair informa\u00e7\u00f5es do DATABASE_URL se dispon\u00edvel\n    db_server = None\n    db_name = None\n    db_user = None\n\n    if settings.DATABASE_URL and settings.USE_SQL_SERVER:\n        try:\n            # Formato: mssql+aioodbc://user:pass@host:port/db?driver=...\n            url_str = str(settings.DATABASE_URL)\n            if \"@\" in url_str and \"/\" in url_str:\n                # Extrair user\n                user_part = url_str.split(\"://\")[1].split(\":\")[0] if \"://\" in url_str else None\n                # Extrair host\n                host_part = url_str.split(\"@\")[1].split(\"/\")[0].split(\":\")[0] if \"@\" in url_str else None\n                # Extrair database\n                db_part = url_str.split(\"/\")[-1].split(\"?\")[0] if \"/\" in url_str else None\n\n                db_user = user_part\n                db_server = host_part\n                db_name = db_part\n        except Exception as e:\n            logger.warning(f\"Failed to parse DATABASE_URL: {e}\")\n\n    return DBConfig(\n        use_sql_server=settings.USE_SQL_SERVER,\n        use_supabase=settings.USE_SUPABASE_AUTH,\n        database_server=db_server,\n        database_name=db_name,\n        database_user=db_user,\n        supabase_url=settings.SUPABASE_URL if settings.USE_SUPABASE_AUTH else None\n    )", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3849, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f35d8c0a-53e9-41ad-9efd-becad964365b": {"__data__": {"id_": "f35d8c0a-53e9-41ad-9efd-becad964365b", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\diagnostics.py", "language": "python", "lines": 198, "filename": "diagnostics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "17a12e9c-7800-4beb-a313-7223d929da87", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\diagnostics.py", "language": "python", "lines": 198, "filename": "diagnostics.py"}, "hash": "b945d484faf7275245c2e39647d86d3bb0c7e05025e88350554a48fa42d3790e", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8e76522d-e12e-46ef-acc3-9739478eb40f", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\diagnostics.py", "language": "python", "lines": 198, "filename": "diagnostics.py"}, "hash": "444815036fd5f0477d45fe66b00edc553c1ca29f09b490de3d1d8ae0c9723ebd", "class_name": "RelatedNodeInfo"}}, "text": "@router.post(\"/test-connection\", response_model=ConnectionTestResult)\nasync def test_sql_connection(\n    current_user: Annotated[User, Depends(require_role(\"admin\"))]\n):\n    \"\"\"\n    Testa a conex\u00e3o com o SQL Server e retorna vers\u00e3o e tabelas dispon\u00edveis.\n    \"\"\"\n    if not settings.USE_SQL_SERVER:\n        return ConnectionTestResult(\n            success=False,\n            message=\"SQL Server est\u00e1 desabilitado (USE_SQL_SERVER=false)\"\n        )\n\n    if not settings.DATABASE_URL:\n        return ConnectionTestResult(\n            success=False,\n            message=\"DATABASE_URL n\u00e3o configurado\"\n        )\n\n    try:\n        # Tentar importar o aioodbc e pyodbc\n        import aioodbc\n        import asyncio\n\n        async def _test():\n            try:\n                # Criar conex\u00e3o tempor\u00e1ria\n                conn = await asyncio.wait_for(\n                    aioodbc.connect(dsn=str(settings.DATABASE_URL)),\n                    timeout=5.0\n                )\n\n                async with conn.cursor() as cursor:\n                    # Obter vers\u00e3o do SQL Server\n                    await cursor.execute(\"SELECT @@VERSION\")\n                    version_row = await cursor.fetchone()\n                    version = version_row[0] if version_row else \"Unknown\"\n\n                    # Listar tabelas\n                    await cursor.execute(\"\"\"\n                        SELECT TABLE_NAME\n                        FROM INFORMATION_SCHEMA.TABLES\n                        WHERE TABLE_TYPE = 'BASE TABLE'\n                        ORDER BY TABLE_NAME\n                    \"\"\")\n                    tables_rows = await cursor.fetchall()\n                    tables = [row[0] for row in tables_rows]\n\n                await conn.close()\n\n                return ConnectionTestResult(\n                    success=True,\n                    message=\"Conex\u00e3o estabelecida com sucesso!\",\n                    version=version.split('\\n')[0] if version else None,\n                    tables=tables[:50]  # Limitar a 50 tabelas\n                )\n            except asyncio.TimeoutError:\n                return ConnectionTestResult(\n                    success=False,\n                    message=\"Timeout ao conectar com SQL Server (5s)\"\n                )\n            except Exception as e:\n                return ConnectionTestResult(\n                    success=False,\n                    message=f\"Erro ao conectar: {str(e)}\"\n                )\n\n        return await _test()\n\n    except ImportError as e:\n        return ConnectionTestResult(\n            success=False,\n            message=f\"Bibliotecas necess\u00e1rias n\u00e3o instaladas: {str(e)}\"\n        )\n    except Exception as e:\n        logger.error(f\"Error testing SQL connection: {e}\", exc_info=True)\n        return ConnectionTestResult(\n            success=False,\n            message=f\"Erro inesperado: {str(e)}\"\n        )", "mimetype": "text/plain", "start_char_idx": 3852, "end_char_idx": 6698, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5bdbff67-4aa1-474f-95ab-1d46aae2d53c": {"__data__": {"id_": "5bdbff67-4aa1-474f-95ab-1d46aae2d53c", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\frontend_logs.py", "language": "python", "lines": 158, "filename": "frontend_logs.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "944a7045-eba3-42ba-965c-db2f535de128", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\frontend_logs.py", "language": "python", "lines": 158, "filename": "frontend_logs.py"}, "hash": "cdbc6433352d8251ff30a514df56f6be7292089f70347ccbc0f68acc21f22f44", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "8ac87245-c104-494d-be22-a6f4d546e701", "node_type": "1", "metadata": {}, "hash": "b14a5be160476750b3f64d29563b716619eff9c9933234332208e650b320bf21", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nEndpoint para receber logs do frontend\nPermite que o frontend envie logs importantes para an\u00e1lise\n\"\"\"\nimport logging\nfrom typing import List, Any, Dict\nfrom datetime import datetime\n\nfrom fastapi import APIRouter, HTTPException, Request\nfrom pydantic import BaseModel, Field\n\nfrom app.core.logging_config import log_api_request\n\nrouter = APIRouter(tags=[\"logs\"])\n\n# Logger espec\u00edfico para logs do frontend\nfrontend_logger = logging.getLogger(\"agentbi.frontend\")\n\n\nclass FrontendLogEntry(BaseModel):\n    \"\"\"Modelo para entrada de log do frontend\"\"\"\n    timestamp: str\n    level: int\n    levelName: str = Field(..., alias=\"levelName\")\n    message: str\n    context: Dict[str, Any] | None = None\n    error: Dict[str, Any] | None = None\n    user: Dict[str, Any] | None = None\n    session: Dict[str, Any] | None = None\n    page: Dict[str, Any] | None = None\n    browser: Dict[str, Any] | None = None\n\n    class Config:\n        populate_by_name = True\n\n\nclass FrontendLogsRequest(BaseModel):\n    \"\"\"Request contendo m\u00faltiplos logs do frontend\"\"\"\n    logs: List[FrontendLogEntry]\n\n\ndef map_frontend_log_level(level: int) -> int:\n    \"\"\"\n    Mapeia n\u00edveis de log do frontend para n\u00edveis do Python logging\n    Frontend: DEBUG=0, INFO=1, WARN=2, ERROR=3, CRITICAL=4\n    Python: DEBUG=10, INFO=20, WARNING=30, ERROR=40, CRITICAL=50\n    \"\"\"\n    mapping = {\n        0: logging.DEBUG,      # DEBUG\n        1: logging.INFO,       # INFO\n        2: logging.WARNING,    # WARN\n        3: logging.ERROR,      # ERROR\n        4: logging.CRITICAL,   # CRITICAL\n    }\n    return mapping.get(level, logging.INFO)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1593, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8ac87245-c104-494d-be22-a6f4d546e701": {"__data__": {"id_": "8ac87245-c104-494d-be22-a6f4d546e701", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\frontend_logs.py", "language": "python", "lines": 158, "filename": "frontend_logs.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "944a7045-eba3-42ba-965c-db2f535de128", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\frontend_logs.py", "language": "python", "lines": 158, "filename": "frontend_logs.py"}, "hash": "cdbc6433352d8251ff30a514df56f6be7292089f70347ccbc0f68acc21f22f44", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "5bdbff67-4aa1-474f-95ab-1d46aae2d53c", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\frontend_logs.py", "language": "python", "lines": 158, "filename": "frontend_logs.py"}, "hash": "2dbf430d1fba7c930576c2a79865cde9423ad35d5374b7312c615e29b5a32de1", "class_name": "RelatedNodeInfo"}}, "text": "class FrontendLogsRequest(BaseModel):\n    \"\"\"Request contendo m\u00faltiplos logs do frontend\"\"\"\n    logs: List[FrontendLogEntry]\n\n\ndef map_frontend_log_level(level: int) -> int:\n    \"\"\"\n    Mapeia n\u00edveis de log do frontend para n\u00edveis do Python logging\n    Frontend: DEBUG=0, INFO=1, WARN=2, ERROR=3, CRITICAL=4\n    Python: DEBUG=10, INFO=20, WARNING=30, ERROR=40, CRITICAL=50\n    \"\"\"\n    mapping = {\n        0: logging.DEBUG,      # DEBUG\n        1: logging.INFO,       # INFO\n        2: logging.WARNING,    # WARN\n        3: logging.ERROR,      # ERROR\n        4: logging.CRITICAL,   # CRITICAL\n    }\n    return mapping.get(level, logging.INFO)\n\n\n@router.post(\"/logs\", status_code=202)\nasync def receive_frontend_logs(\n    request: Request,\n    logs_request: FrontendLogsRequest\n) -> dict:\n    \"\"\"\n    Recebe e processa logs do frontend\n\n    - **logs**: Lista de entradas de log do frontend\n\n    Retorna um status 202 (Accepted) indicando que os logs foram recebidos\n    \"\"\"\n    try:\n        logs_received = len(logs_request.logs)\n\n        # Processa cada log\n        for log_entry in logs_request.logs:\n            # Mapeia o n\u00edvel do log\n            python_level = map_frontend_log_level(log_entry.level)\n\n            # Prepara dados extras para o log\n            extra = {\n                \"source\": \"frontend\",\n                \"frontend_timestamp\": log_entry.timestamp,\n            }\n\n            # Adiciona contexto se dispon\u00edvel\n            if log_entry.context:\n                extra[\"context\"] = log_entry.context\n\n            # Adiciona informa\u00e7\u00f5es do usu\u00e1rio\n            if log_entry.user:\n                extra[\"user_id\"] = log_entry.user.get(\"id\")\n                extra[\"user_email\"] = log_entry.user.get(\"email\")\n\n            # Adiciona informa\u00e7\u00f5es da sess\u00e3o\n            if log_entry.session:\n                extra[\"session_id\"] = log_entry.session.get(\"id\")\n                extra[\"session_duration\"] = log_entry.session.get(\"duration\")\n\n            # Adiciona informa\u00e7\u00f5es da p\u00e1gina\n            if log_entry.page:\n                extra[\"page_url\"] = log_entry.page.get(\"url\")\n                extra[\"page_title\"] = log_entry.page.get(\"title\")\n\n            # Adiciona informa\u00e7\u00f5es do browser\n            if log_entry.browser:\n                extra[\"user_agent\"] = log_entry.browser.get(\"userAgent\")\n                extra[\"browser_language\"] = log_entry.browser.get(\"language\")\n                extra[\"browser_platform\"] = log_entry.browser.get(\"platform\")\n\n            # Adiciona informa\u00e7\u00f5es de erro se dispon\u00edvel\n            error_info = None\n            if log_entry.error:\n                error_info = (\n                    f\"{log_entry.error.get('name', 'Error')}: \"\n                    f\"{log_entry.error.get('message', 'Unknown error')}\"\n                )\n                if log_entry.error.get(\"stack\"):\n                    error_info += f\"\\n{log_entry.error.get('stack')}\"\n                extra[\"error\"] = error_info\n\n            # Registra o log\n            message = f\"[Frontend] {log_entry.message}\"\n            if error_info:\n                message += f\" - {error_info}\"\n\n            frontend_logger.log(\n                python_level,\n                message,\n                extra=extra\n            )\n\n        return {\n            \"status\": \"accepted\",\n            \"logs_received\": logs_received,\n            \"message\": f\"Successfully received {logs_received} log(s) from frontend\"\n        }\n\n    except Exception as e:\n        frontend_logger.error(\n            f\"Error processing frontend logs: {str(e)}\",\n            exc_info=True\n        )\n        raise HTTPException(\n            status_code=500,\n            detail=f\"Error processing logs: {str(e)}\"\n        )\n\n\n@router.get(\"/logs/health\")\nasync def logs_health_check() -> dict:\n    \"\"\"\n    Health check endpoint para o sistema de logs\n    \"\"\"\n    return {\n        \"status\": \"healthy\",\n        \"service\": \"frontend-logs\",\n        \"timestamp\": datetime.utcnow().isoformat()\n    }", "mimetype": "text/plain", "start_char_idx": 951, "end_char_idx": 4905, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b1cce014-3941-4704-af62-0cab5b47d067": {"__data__": {"id_": "b1cce014-3941-4704-af62-0cab5b47d067", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\health.py", "language": "python", "lines": 259, "filename": "health.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f2512cca-0fa6-4443-9d1e-eb8176920f61", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\health.py", "language": "python", "lines": 259, "filename": "health.py"}, "hash": "8e0785f8003068694650ea0cff8f2b843bf1c33de87d6f35f244dbf67cb983b8", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "a999c9a4-a501-4e77-9c79-9596845f7ee9", "node_type": "1", "metadata": {}, "hash": "a04176c77de8050200d4c7fc84b80b835610e9faba5591e1582fe231b6bb5f61", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nHealth Check Endpoint with Timeout\nProvides system health status with configurable timeout\n\"\"\"\n\nimport asyncio\nimport time\nfrom datetime import datetime\nfrom typing import Dict, Any\n\nfrom fastapi import APIRouter, HTTPException, status\nimport structlog\n\nfrom app.config.settings import get_settings\n\nrouter = APIRouter()\nlogger = structlog.get_logger(\"agentbi.health\")\nsettings = get_settings()\n\n# Health check configuration\nHEALTH_CHECK_TIMEOUT = 5  # seconds\nDEPENDENCY_CHECK_INTERVAL = 30  # cache health status for 30 seconds\n\n# Cache for health status\n_last_health_check: Dict[str, Any] = {\n    \"timestamp\": 0,\n    \"status\": None\n}\n\n\n@router.get(\"/health\", tags=[\"health\"], status_code=status.HTTP_200_OK)\nasync def health_check():\n    \"\"\"\n    Health check endpoint with timeout protection\n\n    Returns:\n        - status: healthy/degraded/unhealthy\n        - version: application version\n        - environment: current environment\n        - timestamp: current timestamp\n        - checks: detailed health checks for each component\n\n    Raises:\n        503 Service Unavailable if health check times out\n    \"\"\"\n    try:\n        # Use cached health status if fresh (< 30 seconds old)\n        current_time = time.time()\n        if (_last_health_check[\"status\"] and\n            current_time - _last_health_check[\"timestamp\"] < DEPENDENCY_CHECK_INTERVAL):\n            logger.debug(\"health_check_cached\", age=current_time - _last_health_check[\"timestamp\"])\n            return _last_health_check[\"status\"]\n\n        # Perform health check with timeout\n        health_status = await asyncio.wait_for(\n            check_dependencies(),\n            timeout=HEALTH_CHECK_TIMEOUT\n        )\n\n        # Update cache\n        _last_health_check[\"timestamp\"] = current_time\n        _last_health_check[\"status\"] = health_status\n\n        logger.info(\"health_check_success\", status=health_status[\"status\"])\n        return health_status\n\n    except asyncio.TimeoutError:\n        logger.error(\"health_check_timeout\", timeout=HEALTH_CHECK_TIMEOUT)\n        raise HTTPException(\n            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,\n            detail=f\"Health check timeout after {HEALTH_CHECK_TIMEOUT}s\"\n        )\n    except Exception as e:\n        logger.error(\"health_check_error\", error=str(e))\n        raise HTTPException(\n            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,\n            detail=f\"Health check failed: {str(e)}\"\n        )\n\n\nasync def check_dependencies() -> Dict[str, Any]:\n    \"\"\"\n    Check health of all system dependencies\n\n    Returns:\n        Dictionary with overall status and individual component checks\n    \"\"\"\n    checks = {}\n    overall_status = \"healthy\"\n\n    # Check 1: Database connectivity (if enabled)\n    if settings.USE_SQL_SERVER:\n        db_check = await check_database()\n        checks[\"database\"] = db_check\n        if db_check[\"status\"] != \"healthy\":\n            overall_status = \"degraded\"\n    else:\n        checks[\"database\"] = {\n            \"status\": \"disabled\",\n            \"message\": \"SQL Server disabled, using Parquet fallback\"\n        }\n\n    # Check 2: Data adapter (Parquet/Hybrid)\n    data_check = await check_data_adapter()\n    checks[\"data_adapter\"] = data_check\n    if data_check[\"status\"] != \"healthy\":\n        overall_status = \"degraded\"\n\n    # Check 3: Environment configuration\n    env_check = check_environment()\n    checks[\"environment\"] = env_check\n    if env_check[\"status\"] != \"healthy\":\n        overall_status = \"unhealthy\"\n\n    return {\n        \"status\": overall_status,\n        \"version\": settings.APP_VERSION,\n        \"environment\": settings.ENVIRONMENT,\n        \"timestamp\": datetime.utcnow().isoformat(),\n        \"checks\": checks\n    }\n\n\nasync def check_database() -> Dict[str, Any]:\n    \"\"\"\n    Check database connectivity with timeout\n\n    Returns:\n        Status dictionary for database\n    \"\"\"\n    try:\n        from app.config.database import engine\n\n        # Try to connect with short timeout\n        async with asyncio.timeout(2):\n            async with engine.connect() as conn:\n                await conn.execute(\"SELECT 1\")\n\n        return {\n            \"status\": \"healthy\",\n            \"message\": \"Database connected\"\n        }\n    except asyncio.TimeoutError:\n        return {\n            \"status\": \"unhealthy\",\n            \"message\": \"Database timeout\"\n        }\n    except Exception as e:\n        return {\n            \"status\": \"unhealthy\",\n            \"message\": f\"Database error: {str(e)}\"\n        }", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4484, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a999c9a4-a501-4e77-9c79-9596845f7ee9": {"__data__": {"id_": "a999c9a4-a501-4e77-9c79-9596845f7ee9", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\health.py", "language": "python", "lines": 259, "filename": "health.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f2512cca-0fa6-4443-9d1e-eb8176920f61", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\health.py", "language": "python", "lines": 259, "filename": "health.py"}, "hash": "8e0785f8003068694650ea0cff8f2b843bf1c33de87d6f35f244dbf67cb983b8", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b1cce014-3941-4704-af62-0cab5b47d067", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\health.py", "language": "python", "lines": 259, "filename": "health.py"}, "hash": "12e7c03fd40f781da2f80faa4b6ee55d8af5867af19de6f99848729b11ff85c2", "class_name": "RelatedNodeInfo"}}, "text": "async def check_database() -> Dict[str, Any]:\n    \"\"\"\n    Check database connectivity with timeout\n\n    Returns:\n        Status dictionary for database\n    \"\"\"\n    try:\n        from app.config.database import engine\n\n        # Try to connect with short timeout\n        async with asyncio.timeout(2):\n            async with engine.connect() as conn:\n                await conn.execute(\"SELECT 1\")\n\n        return {\n            \"status\": \"healthy\",\n            \"message\": \"Database connected\"\n        }\n    except asyncio.TimeoutError:\n        return {\n            \"status\": \"unhealthy\",\n            \"message\": \"Database timeout\"\n        }\n    except Exception as e:\n        return {\n            \"status\": \"unhealthy\",\n            \"message\": f\"Database error: {str(e)}\"\n        }\n\n\nasync def check_data_adapter() -> Dict[str, Any]:\n    \"\"\"\n    Check data adapter (Parquet/Hybrid) status\n\n    Returns:\n        Status dictionary for data adapter\n    \"\"\"\n    try:\n        from pathlib import Path\n\n        # Check if Parquet file exists\n        parquet_path = Path(settings.PARQUET_DATA_PATH)\n        if parquet_path.exists():\n            return {\n                \"status\": \"healthy\",\n                \"source\": \"parquet\",\n                \"message\": f\"Parquet file accessible: {parquet_path.name}\"\n            }\n        else:\n            return {\n                \"status\": \"unhealthy\",\n                \"source\": \"parquet\",\n                \"message\": f\"Parquet file not found: {settings.PARQUET_DATA_PATH}\"\n            }\n    except Exception as e:\n        return {\n            \"status\": \"unhealthy\",\n            \"message\": f\"Data adapter error: {str(e)}\"\n        }\n\n\ndef check_environment() -> Dict[str, Any]:\n    \"\"\"\n    Check critical environment variables\n\n    Returns:\n        Status dictionary for environment configuration\n    \"\"\"\n    try:\n        issues = []\n\n        # Check SECRET_KEY\n        if not settings.SECRET_KEY or len(settings.SECRET_KEY) < 32:\n            issues.append(\"SECRET_KEY too short\")\n\n        # Check GEMINI_API_KEY (if needed for AI features)\n        if not settings.GEMINI_API_KEY or settings.GEMINI_API_KEY == \"sua_chave_api_gemini_aqui\":\n            issues.append(\"GEMINI_API_KEY not configured\")\n\n        if issues:\n            return {\n                \"status\": \"degraded\",\n                \"message\": f\"Environment issues: {', '.join(issues)}\"\n            }\n\n        return {\n            \"status\": \"healthy\",\n            \"message\": \"Environment configured\"\n        }\n    except Exception as e:\n        return {\n            \"status\": \"unhealthy\",\n            \"message\": f\"Environment check error: {str(e)}\"\n        }\n\n\n@router.get(\"/health/live\", tags=[\"health\"], status_code=status.HTTP_200_OK)\nasync def liveness_probe():\n    \"\"\"\n    Kubernetes liveness probe - checks if app is running\n\n    Returns:\n        Simple status response\n    \"\"\"\n    return {\"status\": \"alive\"}\n\n\n@router.get(\"/health/ready\", tags=[\"health\"], status_code=status.HTTP_200_OK)\nasync def readiness_probe():\n    \"\"\"\n    Kubernetes readiness probe - checks if app is ready to serve traffic\n\n    Returns:\n        Ready status if all critical dependencies are available\n\n    Raises:\n        503 if not ready\n    \"\"\"\n    try:\n        # Quick check of critical dependencies only\n        health = await asyncio.wait_for(check_dependencies(), timeout=3)\n\n        if health[\"status\"] == \"unhealthy\":\n            raise HTTPException(\n                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,\n                detail=\"Service not ready\"\n            )\n\n        return {\"status\": \"ready\"}\n    except asyncio.TimeoutError:\n        raise HTTPException(\n            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,\n            detail=\"Readiness check timeout\"\n        )", "mimetype": "text/plain", "start_char_idx": 3707, "end_char_idx": 7468, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ccf3741c-0516-4935-9b58-4fc16b9a7e51": {"__data__": {"id_": "ccf3741c-0516-4935-9b58-4fc16b9a7e51", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\insights.py", "language": "python", "lines": 295, "filename": "insights.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "72841d28-ba1e-424e-8023-0b0823df9ec7", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\insights.py", "language": "python", "lines": 295, "filename": "insights.py"}, "hash": "9d15865e1fc3c7a8e32019d0894b221dc9dbeb77fde0ea1605f15a3f6144b9f6", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f6b4085c-3566-4d79-aa58-7a1a19224e03", "node_type": "1", "metadata": {}, "hash": "90382bb412677fd189e4a2e1fbb3035c50fba1f61f95d216a9d3b5119e9d1fc2", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nAI Insights Endpoints\nProactive AI-powered business insights\n\"\"\"\n\nfrom typing import Any, List\nfrom datetime import datetime, timedelta\nimport logging\nimport json\nimport re\nimport polars as pl\n\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom pydantic import BaseModel\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom app.api.dependencies import get_current_user, get_db\nfrom app.infrastructure.database.models import User\nfrom app.core.llm_gemini_adapter import GeminiLLMAdapter\nfrom app.infrastructure.data.hybrid_adapter import HybridDataAdapter\nfrom app.core.data_scope_service import data_scope_service\nfrom app.config.settings import settings\n\nrouter = APIRouter(prefix=\"/insights\", tags=[\"AI Insights\"])\nlogger = logging.getLogger(__name__)\n\n\n# Pydantic Models\nclass InsightResponse(BaseModel):\n    \"\"\"AI-generated insight\"\"\"\n    id: str\n    title: str\n    description: str\n    category: str  # trend, anomaly, opportunity, risk\n    severity: str  # low, medium, high\n    recommendation: str | None\n    data_points: List[dict] | None\n    created_at: str\n\n\nclass InsightsListResponse(BaseModel):\n    \"\"\"List of insights\"\"\"\n    insights: List[InsightResponse]\n    total: int\n    generated_at: str\n\n\n@router.get(\"/proactive\", response_model=InsightsListResponse)\nasync def get_proactive_insights(\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    Get AI-powered proactive insights based on current business data.\n\n    Analyzes recent data and generates intelligent insights about:\n    - Sales trends\n    - Inventory anomalies\n    - Revenue opportunities\n    - Stock risks\n    \"\"\"\n    logger.info(f\"\ud83e\udde0 Proactive Insights solicitado por: {current_user.username}\")\n    try:\n        # Initialize adapters\n        llm_adapter = GeminiLLMAdapter()\n        \n        # Get filtered dataframe using singleton service (Fast & Secure)\n        df = data_scope_service.get_filtered_dataframe(current_user)\n        \n        # Collect business metrics using Polars\n        insights_data = []\n\n        # Helper to safely get column\n        def get_col(candidates, default=None):\n            for c in candidates:\n                if c in df.columns: return c\n            return default\n\n        # Map columns based on ADMMAT schema\n        col_segment = get_col([\"NOMESEGMENTO\", \"SEGMENTO\", \"CATEGORIA\"], \"SEGMENTO\")\n        col_sales = get_col([\"VENDA_30DD\", \"QtdVenda\", \"VENDA\"], \"VENDA_30DD\")\n        col_revenue = get_col([\"MES_01\", \"VrVenda\", \"RECEITA\"], \"MES_01\")\n        col_stock = get_col([\"ESTOQUE_UNE\", \"QtdEstoque\"], \"ESTOQUE_UNE\")\n        col_product = get_col([\"PRODUTO\", \"CODPRODUTO\"], \"PRODUTO\")\n        col_name = get_col([\"NOME\", \"NOMPRODUTO\"], \"NOME\")\n\n        # 1. Sales Trends Analysis (Aggregated by Segment)\n        if col_segment and col_sales and col_revenue:\n            try:\n                # Group by Segment\n                df_sales = df.group_by(col_segment).agg([\n                    pl.col(col_sales).sum().alias(\"total_vendas\"),\n                    pl.col(col_revenue).sum().alias(\"receita_total\"),\n                    pl.col(col_product).n_unique().alias(\"produtos_vendidos\")\n                ]).sort(\"receita_total\", descending=True).head(10)\n                \n                sales_data = df_sales.to_dicts()\n                if sales_data:\n                    insights_data.append({\n                        \"type\": \"sales_by_segment\",\n                        \"data\": sales_data\n                    })\n            except Exception as e:\n                logger.warning(f\"Sales analysis failed: {e}\")\n\n        # 2.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3620, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f6b4085c-3566-4d79-aa58-7a1a19224e03": {"__data__": {"id_": "f6b4085c-3566-4d79-aa58-7a1a19224e03", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\insights.py", "language": "python", "lines": 295, "filename": "insights.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "72841d28-ba1e-424e-8023-0b0823df9ec7", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\insights.py", "language": "python", "lines": 295, "filename": "insights.py"}, "hash": "9d15865e1fc3c7a8e32019d0894b221dc9dbeb77fde0ea1605f15a3f6144b9f6", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "ccf3741c-0516-4935-9b58-4fc16b9a7e51", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\insights.py", "language": "python", "lines": 295, "filename": "insights.py"}, "hash": "3b5ad24587d5cc5887c96248067efac43741aa9e1c1e55f92da7b26af453559d", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2b478a8e-acf3-4a6d-8b69-6302116cf8c5", "node_type": "1", "metadata": {}, "hash": "10a344680d853621b04867877dbf60bf01b8d5a07f3a3b7c30f3fb2562b9ceeb", "class_name": "RelatedNodeInfo"}}, "text": "Sales Trends Analysis (Aggregated by Segment)\n        if col_segment and col_sales and col_revenue:\n            try:\n                # Group by Segment\n                df_sales = df.group_by(col_segment).agg([\n                    pl.col(col_sales).sum().alias(\"total_vendas\"),\n                    pl.col(col_revenue).sum().alias(\"receita_total\"),\n                    pl.col(col_product).n_unique().alias(\"produtos_vendidos\")\n                ]).sort(\"receita_total\", descending=True).head(10)\n                \n                sales_data = df_sales.to_dicts()\n                if sales_data:\n                    insights_data.append({\n                        \"type\": \"sales_by_segment\",\n                        \"data\": sales_data\n                    })\n            except Exception as e:\n                logger.warning(f\"Sales analysis failed: {e}\")\n\n        # 2. Stock Rupture Analysis (Low Stock items)\n        if col_name and col_stock and col_sales:\n            try:\n                # Filter potential ruptures: Stock < 10% of monthly sales\n                df_rupture = df.filter(\n                    (pl.col(col_stock).cast(pl.Float64).fill_null(0) < (pl.col(col_sales).cast(pl.Float64).fill_null(0) * 0.1)) &\n                    (pl.col(col_sales).cast(pl.Float64).fill_null(0) > 0)\n                ).sort(col_sales, descending=True).head(10).select([\n                    col_name, col_stock, col_sales, col_segment\n                ])\n\n                rupture_data = df_rupture.to_dicts()\n                if rupture_data:\n                    insights_data.append({\n                        \"type\": \"critical_ruptures\",\n                        \"data\": rupture_data\n                    })\n            except Exception as e:\n                logger.warning(f\"Rupture analysis failed: {e}\")\n\n        # 3. High Value Products (Pareto/ABC)\n        if col_name and col_revenue:\n            try:\n                df_high_value = df.sort(col_revenue, descending=True).head(10).select([\n                    col_name, col_revenue, col_sales, col_segment\n                ])\n                \n                high_value_data = df_high_value.to_dicts()\n                if high_value_data:\n                    insights_data.append({\n                        \"type\": \"top_revenue_products\",\n                        \"data\": high_value_data\n                    })\n            except Exception as e:\n                logger.warning(f\"High value analysis failed: {e}\")\n\n        # Generate insights using Gemini\n        try:\n            # Call Gemini\n            response = await llm_adapter.generate_response(prompt)\n            \n            # Log raw response for debugging (truncated)\n            logger.info(f\"\ud83e\udd16 Gemini Raw Response: {response[:200]}...\")\n\n            # Extract JSON from response (handles markdown code blocks)\n            # Regex robusto para capturar JSON dentro ou fora de blocos de c\u00f3digo\n            json_match = re.search(r'```json\\s*(\\{.*?\\})\\s*```', response, re.DOTALL)\n            if json_match:\n                json_str = json_match.group(1)\n            else:\n                # Tenta encontrar o primeiro { e o \u00faltimo }\n                start = response.find('{')\n                end = response.rfind('}') + 1\n                if start != -1 and end > start:\n                    json_str = response[start:end]\n                else:\n                    json_str = response\n\n            insights_response = json.loads(json_str)\n\n        except Exception as llm_error:\n            logger.error(f\"\u274c Falha no LLM ou Parse: {llm_error}. Usando fallback.\")\n            # Fallback seguro para n\u00e3o quebrar o frontend\n            insights_response = {\n                \"insights\": [\n                    {\n                        \"id\": \"fallback-1\",\n                        \"title\": \"An\u00e1lise de Dados Dispon\u00edvel\",\n                        \"description\": \"Os dados foram processados com sucesso, mas a an\u00e1lise detalhada da IA est\u00e1 temporariamente indispon\u00edvel.\",\n                        \"category\": \"opportunity\",\n                        \"severity\": \"low\",\n                        \"recommendation\": \"Verifique os gr\u00e1ficos de KPI para an\u00e1lise manual.\",\n                        \"data_points\": []\n                    }\n                ]\n            }\n\n        # Format insights with timestamps\n        formatted_insights = []\n        for idx, insight in enumerate(insights_response.get('insights', [])):\n            formatted_insights.append(InsightResponse(\n                id=insight.get('id', f\"insight-{idx}\"),\n                title=insight.get('title', 'Insight Gerado'),\n                description=insight.get('description', 'Sem descri\u00e7\u00e3o dispon\u00edvel.", "mimetype": "text/plain", "start_char_idx": 2760, "end_char_idx": 7407, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2b478a8e-acf3-4a6d-8b69-6302116cf8c5": {"__data__": {"id_": "2b478a8e-acf3-4a6d-8b69-6302116cf8c5", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\insights.py", "language": "python", "lines": 295, "filename": "insights.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "72841d28-ba1e-424e-8023-0b0823df9ec7", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\insights.py", "language": "python", "lines": 295, "filename": "insights.py"}, "hash": "9d15865e1fc3c7a8e32019d0894b221dc9dbeb77fde0ea1605f15a3f6144b9f6", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "f6b4085c-3566-4d79-aa58-7a1a19224e03", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\insights.py", "language": "python", "lines": 295, "filename": "insights.py"}, "hash": "ef5b96f45b57848c401b2d58c28797293ff003219ffd1fa00dfb2bea14619a9b", "class_name": "RelatedNodeInfo"}}, "text": "\",\n                        \"category\": \"opportunity\",\n                        \"severity\": \"low\",\n                        \"recommendation\": \"Verifique os gr\u00e1ficos de KPI para an\u00e1lise manual.\",\n                        \"data_points\": []\n                    }\n                ]\n            }\n\n        # Format insights with timestamps\n        formatted_insights = []\n        for idx, insight in enumerate(insights_response.get('insights', [])):\n            formatted_insights.append(InsightResponse(\n                id=insight.get('id', f\"insight-{idx}\"),\n                title=insight.get('title', 'Insight Gerado'),\n                description=insight.get('description', 'Sem descri\u00e7\u00e3o dispon\u00edvel.'),\n                category=insight.get('category', 'opportunity'),\n                severity=insight.get('severity', 'low'),\n                recommendation=insight.get('recommendation'),\n                data_points=insight.get('data_points'),\n                created_at=datetime.utcnow().isoformat()\n            ))\n\n        return InsightsListResponse(\n            insights=formatted_insights,\n            total=len(formatted_insights),\n            generated_at=datetime.utcnow().isoformat()\n        )\n\n    except Exception as e:\n        logger.error(f\"\ud83d\udd25 Erro Cr\u00edtico em Proactive Insights: {e}\", exc_info=True)\n        # \u00daltima linha de defesa: retornar lista vazia em vez de 500\n        return InsightsListResponse(\n            insights=[],\n            total=0,\n            generated_at=datetime.utcnow().isoformat()\n        )\n\n\n@router.get(\"/anomalies\")\nasync def detect_anomalies(\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    Detect anomalies in sales and stock data using AI.\n\n    Returns unusual patterns that require attention.\n    \"\"\"\n    data_adapter = HybridDataAdapter()\n    segments = data_scope_service.get_user_segments(current_user)\n\n    # Detect sudden drops in sales\n    anomaly_query = \"\"\"\n    SELECT\n        NOMPRODUTO,\n        CODPRODUTO,\n        QtdVenda,\n        VrVenda,\n        QtdEstoque,\n        SEGMENTO\n    FROM AdmMatao\n    WHERE SEGMENTO IN ({})\n        AND (\n            QtdEstoque = 0 AND QtdVenda > 100\n            OR QtdVenda = 0 AND QtdEstoque > 1000\n        )\n    ORDER BY QtdVenda DESC\n    \"\"\".format(','.join(f\"'{s}'\" for s in segments))\n\n    try:\n        anomalies_df = await data_adapter.execute_query(anomaly_query)\n\n        return {\n            \"anomalies\": anomalies_df.to_dict('records') if not anomalies_df.empty else [],\n            \"count\": len(anomalies_df),\n            \"detected_at\": datetime.utcnow().isoformat()\n        }\n    except Exception as e:\n        logger.error(f\"Anomaly detection failed: {e}\")\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error detecting anomalies: {str(e)}\"\n        )\n\n\n@router.post(\"/ask\")\nasync def ask_insight_question(\n    question: str,\n    current_user: User = Depends(get_current_user)\n) -> Any:\n    \"\"\"\n    Ask a specific question about business insights.\n\n    Example: \"What products should I restock urgently?\"\n    \"\"\"\n    llm_adapter = GeminiLLMAdapter()\n\n    prompt = f\"\"\"\nVoc\u00ea \u00e9 um assistente de BI. Responda a seguinte pergunta de neg\u00f3cio:\n\n**Pergunta:** {question}\n\nForne\u00e7a uma resposta clara, objetiva e com recomenda\u00e7\u00f5es acion\u00e1veis.\nSe precisar de dados espec\u00edficos, mencione quais consultas seriam \u00fateis.\n\"\"\"\n\n    try:\n        response = await llm_adapter.generate_response(prompt)\n\n        return {\n            \"question\": question,\n            \"answer\": response,\n            \"answered_at\": datetime.utcnow().isoformat()\n        }\n    except Exception as e:\n        logger.error(f\"Question answering failed: {e}\")\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error answering question: {str(e)}\"\n        )", "mimetype": "text/plain", "start_char_idx": 6712, "end_char_idx": 10616, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "200605a2-e22f-4d5f-bb17-54a23e5c9bc5": {"__data__": {"id_": "200605a2-e22f-4d5f-bb17-54a23e5c9bc5", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\learning.py", "language": "python", "lines": 272, "filename": "learning.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f3febc04-20fc-4651-ae44-daff4cc5bc74", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\learning.py", "language": "python", "lines": 272, "filename": "learning.py"}, "hash": "daf29f8705b1aff71603b2946efa8d6a40ce11758daa9dc8511de2a202dccac2", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "54b35d02-b86f-4728-b9a5-6ed497eb34c6", "node_type": "1", "metadata": {}, "hash": "80db796c53b1ac0aa5d288ed1d6761c8c1d5ae5e062e934087fce8f13a6a6dc7", "class_name": "RelatedNodeInfo"}}, "text": "from typing import Annotated, Dict, Any, List\nfrom pathlib import Path\nimport json\nimport os\n\nimport polars as pl\nfrom fastapi import APIRouter, Depends, HTTPException\nfrom pydantic import BaseModel\n\nfrom app.api.dependencies import get_current_active_user\nfrom app.core.data_scope_service import data_scope_service\nfrom app.infrastructure.database.models import User\nfrom app.config.settings import settings\n\nrouter = APIRouter(prefix=\"/learning\", tags=[\"Learning\"])\n\n# Paths para dados de aprendizado\nFEEDBACK_PATH = Path(settings.LEARNING_FEEDBACK_PATH) if hasattr(settings, 'LEARNING_FEEDBACK_PATH') else Path(\"data/feedback\")\nPATTERNS_PATH = Path(settings.LEARNING_EXAMPLES_PATH) if hasattr(settings, 'LEARNING_EXAMPLES_PATH') else Path(\"data/learning\")\n\nos.makedirs(FEEDBACK_PATH, exist_ok=True)\nos.makedirs(PATTERNS_PATH, exist_ok=True)\n\n@router.get(\"/insights\", response_model=Dict[str, List[Dict[str, Any]]])\nasync def get_insights(\n    current_user: Annotated[User, Depends(get_current_active_user)]\n):\n    \"\"\"\n    Gera insights simples baseados em regras sobre os dados.\n    (Placeholder para futura integra\u00e7\u00e3o com LLM)\n    \"\"\"\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user, max_rows=10000)\n\n        insights = []\n\n        # 1. Top Performer\n        if \"VENDA_30DD\" in df.columns and \"NOME\" in df.columns:\n            try:\n                # Converter VENDA_30DD para num\u00e9rico, tratando strings vazias e erros\n                df_clean = df.with_columns([\n                    pl.col(\"VENDA_30DD\").cast(pl.Float64, strict=False).fill_null(0).alias(\"VENDA_30DD\")\n                ])\n\n                top = df_clean.sort(\"VENDA_30DD\", descending=True).head(1)\n                if len(top) > 0:\n                    nome = top[\"NOME\"][0]\n                    vendas = top[\"VENDA_30DD\"][0]\n                    if vendas and vendas > 0:\n                        insights.append({\n                            \"type\": \"top_performer\",\n                            \"title\": \"Produto Campe\u00e3o de Vendas\",\n                            \"description\": f\"O produto '{nome}' teve {int(vendas)} vendas nos \u00faltimos 30 dias.\"\n                        })\n            except Exception as e:\n                # Silenciosamente ignorar se n\u00e3o conseguir processar top performer\n                pass\n\n        # 2. Stock Alert\n        if \"ESTOQUE_UNE\" in df.columns and \"VENDA_30DD\" in df.columns:\n            try:\n                # Converter colunas para num\u00e9rico, tratando strings vazias\n                df_clean = df.with_columns([\n                    pl.col(\"VENDA_30DD\").cast(pl.Float64, strict=False).fill_null(0).alias(\"VENDA_30DD\"),\n                    pl.col(\"ESTOQUE_UNE\").cast(pl.Float64, strict=False).fill_null(0).alias(\"ESTOQUE_UNE\")\n                ])\n\n                low_stock = df_clean.filter(\n                    (pl.col(\"VENDA_30DD\") > 10) & (pl.col(\"ESTOQUE_UNE\") < 5)\n                )\n                if len(low_stock) > 0:\n                    insights.append({\n                        \"type\": \"stock_alert\",\n                        \"title\": \"Risco de Ruptura\",\n                        \"description\": f\"{len(low_stock)} produtos com alta venda e estoque baixo.\"\n                    })\n            except Exception as e:\n                # Silenciosamente ignorar se n\u00e3o conseguir processar stock alert\n                pass\n\n        return {\"insights\": insights}\n\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3477, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "54b35d02-b86f-4728-b9a5-6ed497eb34c6": {"__data__": {"id_": "54b35d02-b86f-4728-b9a5-6ed497eb34c6", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\learning.py", "language": "python", "lines": 272, "filename": "learning.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f3febc04-20fc-4651-ae44-daff4cc5bc74", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\learning.py", "language": "python", "lines": 272, "filename": "learning.py"}, "hash": "daf29f8705b1aff71603b2946efa8d6a40ce11758daa9dc8511de2a202dccac2", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "200605a2-e22f-4d5f-bb17-54a23e5c9bc5", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\learning.py", "language": "python", "lines": 272, "filename": "learning.py"}, "hash": "7e0919715f0bd2f6097e3ea53c703d2b072a772bb30157b20ef5779f937e8be5", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "ca7c4fcd-d9f0-4e3d-b7ba-77f293e98f51", "node_type": "1", "metadata": {}, "hash": "456c112f670d0e7250c844e7d42e93c42e3745708ab05244a83a60e674815d02", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/feedback-stats\")\nasync def get_feedback_stats(\n    current_user: Annotated[User, Depends(get_current_active_user)]\n) -> Dict[str, Any]:\n    \"\"\"\n    Retorna estat\u00edsticas de feedback dos usu\u00e1rios.\n    \"\"\"\n    try:\n        feedback_file = FEEDBACK_PATH / \"feedback.jsonl\"\n\n        if not feedback_file.exists():\n            return {\n                \"total_feedback\": 0,\n                \"positive\": 0,\n                \"negative\": 0,\n                \"partial\": 0,\n                \"success_rate\": 0.0,\n                \"problematic_queries\": []\n            }\n\n        # Ler feedback\n        feedbacks = []\n        with open(feedback_file, 'r', encoding='utf-8') as f:\n            for line in f:\n                try:\n                    feedbacks.append(json.loads(line))\n                except:\n                    continue\n\n        total = len(feedbacks)\n        positive = sum(1 for f in feedbacks if f.get('feedback_type') == 'positive')\n        negative = sum(1 for f in feedbacks if f.get('feedback_type') == 'negative')\n        partial = sum(1 for f in feedbacks if f.get('feedback_type') == 'partial')\n\n        success_rate = (positive / total * 100) if total > 0 else 0.0\n\n        # Queries problem\u00e1ticas (com feedback negativo)\n        problematic = [\n            {\n                \"query\": f.get('comment', 'N/A'),\n                \"feedback_type\": f.get('feedback_type'),\n                \"timestamp\": f.get('timestamp')\n            }\n            for f in feedbacks if f.get('feedback_type') == 'negative'\n        ][:10]\n\n        return {\n            \"total_feedback\": total,\n            \"positive\": positive,\n            \"negative\": negative,\n            \"partial\": partial,\n            \"success_rate\": round(success_rate, 1),\n            \"problematic_queries\": problematic\n        }\n\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=f\"Error fetching feedback stats: {str(e)}\")\n\n\n@router.get(\"/error-analysis\")\nasync def get_error_analysis(\n    current_user: Annotated[User, Depends(get_current_active_user)]\n) -> Dict[str, Any]:\n    \"\"\"\n    Analisa erros do sistema de aprendizado.\n    \"\"\"\n    try:\n        # Simular dados de erro (em produ\u00e7\u00e3o, ler de logs)\n        error_types = {\n            \"query_timeout\": 12,\n            \"data_not_found\": 8,\n            \"invalid_filter\": 5,\n            \"llm_error\": 3,\n            \"permission_denied\": 2\n        }\n\n        total_errors = sum(error_types.values())\n\n        error_details = [\n            {\n                \"error_type\": \"query_timeout\",\n                \"count\": 12,\n                \"suggestion\": \"Otimize queries complexas ou aumente o timeout\"\n            },\n            {\n                \"error_type\": \"data_not_found\",\n                \"count\": 8,\n                \"suggestion\": \"Verifique se os filtros est\u00e3o corretos\"\n            },\n            {\n                \"error_type\": \"invalid_filter\",\n                \"count\": 5,\n                \"suggestion\": \"Valide os filtros antes de executar a query\"\n            }\n        ]\n\n        return {\n            \"total_errors\": total_errors,\n            \"error_types\": error_types,\n            \"error_details\": error_details\n        }\n\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=f\"Error analyzing errors: {str(e)}\")", "mimetype": "text/plain", "start_char_idx": 3480, "end_char_idx": 6778, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ca7c4fcd-d9f0-4e3d-b7ba-77f293e98f51": {"__data__": {"id_": "ca7c4fcd-d9f0-4e3d-b7ba-77f293e98f51", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\learning.py", "language": "python", "lines": 272, "filename": "learning.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f3febc04-20fc-4651-ae44-daff4cc5bc74", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\learning.py", "language": "python", "lines": 272, "filename": "learning.py"}, "hash": "daf29f8705b1aff71603b2946efa8d6a40ce11758daa9dc8511de2a202dccac2", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "54b35d02-b86f-4728-b9a5-6ed497eb34c6", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\learning.py", "language": "python", "lines": 272, "filename": "learning.py"}, "hash": "99f0521aee632f060561488c2eb7397a681a800a32ce9224961bc77df2a11cc1", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/patterns\")\nasync def get_patterns(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    search: str = None\n) -> Dict[str, Any]:\n    \"\"\"\n    Retorna padr\u00f5es de queries bem-sucedidas.\n    \"\"\"\n    try:\n        # Padr\u00f5es de exemplo (em produ\u00e7\u00e3o, ler de arquivos de aprendizado)\n        patterns = [\n            {\n                \"id\": 1,\n                \"keywords\": [\"vendas\", \"top\", \"produtos\"],\n                \"pattern\": \"Listar top N produtos por vendas\",\n                \"examples\": [\n                    \"Quais os 10 produtos mais vendidos?\",\n                    \"Top 5 produtos em vendas\"\n                ],\n                \"success_count\": 45\n            },\n            {\n                \"id\": 2,\n                \"keywords\": [\"ruptura\", \"estoque\", \"cr\u00edtico\"],\n                \"pattern\": \"Identificar produtos em ruptura\",\n                \"examples\": [\n                    \"Produtos com estoque zerado\",\n                    \"Rupturas cr\u00edticas\"\n                ],\n                \"success_count\": 38\n            },\n            {\n                \"id\": 3,\n                \"keywords\": [\"transfer\u00eancia\", \"UNE\", \"sugest\u00e3o\"],\n                \"pattern\": \"Sugerir transfer\u00eancias entre UNEs\",\n                \"examples\": [\n                    \"Sugerir transfer\u00eancias para UNE 101\",\n                    \"Produtos para transferir\"\n                ],\n                \"success_count\": 27\n            },\n            {\n                \"id\": 4,\n                \"keywords\": [\"categoria\", \"segmento\", \"vendas\"],\n                \"pattern\": \"Vendas por categoria/segmento\",\n                \"examples\": [\n                    \"Vendas por categoria\",\n                    \"Qual segmento vende mais?\"\n                ],\n                \"success_count\": 22\n            },\n            {\n                \"id\": 5,\n                \"keywords\": [\"giro\", \"estoque\", \"rotatividade\"],\n                \"pattern\": \"An\u00e1lise de giro de estoque\",\n                \"examples\": [\n                    \"Produtos com maior giro\",\n                    \"Giro de estoque por UNE\"\n                ],\n                \"success_count\": 18\n            }\n        ]\n\n        # Filtrar por busca se fornecido\n        if search:\n            search_lower = search.lower()\n            patterns = [\n                p for p in patterns\n                if search_lower in p['pattern'].lower() or\n                any(search_lower in kw for kw in p['keywords'])\n            ]\n\n        return {\n            \"total_patterns\": len(patterns),\n            \"patterns\": patterns\n        }\n\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=f\"Error fetching patterns: {str(e)}\")", "mimetype": "text/plain", "start_char_idx": 6781, "end_char_idx": 9450, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "22b1eef8-3929-4630-842e-944d97e9783b": {"__data__": {"id_": "22b1eef8-3929-4630-842e-944d97e9783b", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "791fa0a1-ef16-43b3-ae0f-6ce91fcd3982", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "hash": "3dab9994c07fef1cea7ae2affc23e33bf0e482666c830e409c86401b990f1109", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "5cdea29c-ef99-4bde-9c45-1110c60751f8", "node_type": "1", "metadata": {}, "hash": "a0dbae55d35f5f653d6d7f866318da0ae987ab461f710acad52cac3155b97e3d", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nMetrics Endpoints\nDashboard metrics and summary data\n\"\"\"\n\nfrom typing import Annotated\nfrom fastapi import APIRouter, Depends, HTTPException\nfrom pydantic import BaseModel\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom app.api.dependencies import get_current_active_user\nfrom app.infrastructure.database.models import User\nfrom app.core.data_scope_service import data_scope_service # Importar o servi\u00e7o\n\nrouter = APIRouter(prefix=\"/metrics\", tags=[\"Metrics\"])\n\n\nclass MetricsSummary(BaseModel):\n    totalSales: int\n    totalUsers: int\n    revenue: float\n    productsCount: int\n    salesGrowth: float\n    usersGrowth: float\n\n\n@router.get(\"/summary\", response_model=MetricsSummary)\nasync def get_metrics_summary(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    # db: Annotated[AsyncSession, Depends(get_db)] # N\u00e3o mais usada diretamente aqui\n) -> MetricsSummary:\n    \"\"\"\n    Get dashboard metrics summary\n\n    Returns aggregated metrics for dashboard display using real Parquet data.\n    Requires authentication and active user status.\n    \"\"\"\n\n    import polars as pl\n    import logging\n\n    logger = logging.getLogger(__name__)\n\n    try:\n        # Limitar a 10000 linhas para c\u00e1lculo de m\u00e9tricas (performance)\n        df = data_scope_service.get_filtered_dataframe(current_user, max_rows=10000)\n\n        # Calcular m\u00e9tricas reais baseado no schema do admmat.parquet\n        # Produtos \u00fanicos\n        products_count = df.select(pl.col(\"PRODUTO\")).n_unique()\n\n        # Total de vendas \u00faltimos 30 dias (soma de VENDA_30DD)\n        total_sales = int(df.select(pl.col(\"VENDA_30DD\").sum()).item()) if \"VENDA_30DD\" in df.columns else 0\n\n        # Receita estimada (considerando m\u00e9dia de volume de vendas)\n        # Usando MES_01 (m\u00eas mais recente) como proxy de movimenta\u00e7\u00e3o\n        revenue = float(df.select(pl.col(\"MES_01\").sum()).item()) if \"MES_01\" in df.columns else 0.0\n\n        # UNEs ativas (lojas/unidades)\n        total_users = df.select(pl.col(\"UNE\")).n_unique() if \"UNE\" in df.columns else 0\n\n        # Calcular crescimento comparando MES_01 vs MES_02\n        sales_growth = 0.0\n        users_growth = 0.0\n\n        if \"MES_01\" in df.columns and \"MES_02\" in df.columns:\n            mes_01 = float(df.select(pl.col(\"MES_01\").sum()).item())\n            mes_02 = float(df.select(pl.col(\"MES_02\").sum()).item())\n            if mes_02 > 0:\n                sales_growth = ((mes_01 - mes_02) / mes_02) * 100\n\n        # Crescimento de UNEs ativas (comparando MES_01 vs MES_02 agregado por UNE)\n        if \"UNE\" in df.columns and \"MES_01\" in df.columns and \"MES_02\" in df.columns:\n            unes_atual = df.filter(pl.col(\"MES_01\") > 0).select(\"UNE\").n_unique()\n            unes_anterior = df.filter(pl.col(\"MES_02\") > 0).select(\"UNE\").n_unique()\n            if unes_anterior > 0:\n                users_growth = ((unes_atual - unes_anterior) / unes_anterior) * 100\n            else:\n                users_growth = 0.0\n        \n        return MetricsSummary(\n            totalSales=total_sales,\n            totalUsers=total_users if total_users > 0 else 0,\n            revenue=revenue,\n            productsCount=products_count,\n            salesGrowth=sales_growth,\n            usersGrowth=users_growth\n        )\n        \n    except Exception as e:\n        logger.error(f\"Error calculating metrics: {str(e)}\")\n        raise HTTPException(status_code=500, detail=f\"Error calculating metrics: {str(e)}\")\n\n\nclass SaleItem(BaseModel):\n    date: str\n    product: str\n    value: float\n    quantity: int\n\n\nclass TopProduct(BaseModel):\n    product: str\n    productName: str\n    totalSales: int\n    revenue: float", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3636, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5cdea29c-ef99-4bde-9c45-1110c60751f8": {"__data__": {"id_": "5cdea29c-ef99-4bde-9c45-1110c60751f8", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "791fa0a1-ef16-43b3-ae0f-6ce91fcd3982", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "hash": "3dab9994c07fef1cea7ae2affc23e33bf0e482666c830e409c86401b990f1109", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "22b1eef8-3929-4630-842e-944d97e9783b", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "hash": "f285f45b0d7cb88ed8eade34fa682fd88c785ed596eea85926b7710862315dfe", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "da8e0de4-6c84-433d-9761-5fa03409fc45", "node_type": "1", "metadata": {}, "hash": "13687fb5f0fc62418d884d53a6068093ca021a246f56b70ffe61b0b64f970d6d", "class_name": "RelatedNodeInfo"}}, "text": "class SaleItem(BaseModel):\n    date: str\n    product: str\n    value: float\n    quantity: int\n\n\nclass TopProduct(BaseModel):\n    product: str\n    productName: str\n    totalSales: int\n    revenue: float\n\n\n@router.get(\"/recent-sales\", response_model=list[SaleItem])\nasync def get_recent_sales(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    limit: int = 10\n) -> list[SaleItem]:\n    \"\"\"\n    Get recent sales from Parquet data\n\n    Returns the most recent sales transactions.\n    \"\"\"\n    import polars as pl\n    import logging\n\n    logger = logging.getLogger(__name__)\n\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        # Usar colunas reais do admmat.parquet\n        # Filtrar produtos com vendas na semana atual (converter para num\u00e9rico primeiro)\n        df_recent = df.filter(\n            pl.col(\"QTDE_SEMANA_ATUAL\").cast(pl.Float64).fill_null(0) > 0\n        ).head(limit)\n\n        sales = []\n        for row in df_recent.iter_rows(named=True):\n            sales.append(SaleItem(\n                date=str(row.get(\"updated_at\", \"N/A\")),\n                product=str(row.get(\"NOME\", row.get(\"PRODUTO\", \"N/A\"))),\n                value=float(row.get(\"MES_01\", 0.0)),\n                quantity=int(row.get(\"QTDE_SEMANA_ATUAL\", 1))\n            ))\n\n        return sales\n\n    except Exception as e:\n        logger.error(f\"Error fetching recent sales: {str(e)}\")\n        raise HTTPException(status_code=500, detail=f\"Error fetching recent sales: {str(e)}\")\n\n\n@router.get(\"/top-products\", response_model=list[TopProduct])\nasync def get_top_products(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    limit: int = 5\n) -> list[TopProduct]:\n    \"\"\"\n    Get top selling products from Parquet data\n\n    Returns products ranked by total sales count and revenue.\n    \"\"\"\n    import polars as pl\n    import logging\n\n    logger = logging.getLogger(__name__)\n\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        # Usar VENDA_30DD para ranking de top produtos\n        df_with_sales = df.filter(pl.col(\"VENDA_30DD\") > 0)\n\n        # Agrupar por produto\n        df_grouped = df_with_sales.group_by([\"PRODUTO\", \"NOME\"]).agg([\n            pl.col(\"VENDA_30DD\").sum().alias(\"total_sales\"),\n            pl.col(\"MES_01\").sum().alias(\"revenue\")\n        ])\n\n        df_sorted = df_grouped.sort(\"total_sales\", descending=True).head(limit)\n\n        # Criar resultado\n        top_products = []\n        for row in df_sorted.iter_rows(named=True):\n            top_products.append(TopProduct(\n                product=str(row[\"PRODUTO\"]),\n                productName=str(row[\"NOME\"])[:50],  # Limitar tamanho\n                totalSales=int(row[\"total_sales\"]),\n                revenue=float(row[\"revenue\"])\n            ))\n\n        return top_products\n\n    except Exception as e:\n        logger.error(f\"Error fetching top products: {str(e)}\")\n        raise HTTPException(status_code=500, detail=f\"Error fetching top products: {str(e)}\")\n\n\nclass BusinessKPIs(BaseModel):\n    total_produtos: int\n    total_unes: int\n    produtos_ruptura: int\n    valor_estoque: float\n    top_produtos: list[dict]\n    vendas_por_categoria: list[dict]\n\n\n@router.get(\"/business-kpis\", response_model=BusinessKPIs)\nasync def get_business_kpis(\n    current_user: Annotated[User, Depends(get_current_active_user)]\n) -> BusinessKPIs:\n    \"\"\"\n    Get business KPIs for Dashboard\n\n    Returns key business metrics including products, UNEs, stock ruptures, and top sellers.\n    Optimized to use Polars LazyFrame for memory efficiency.\n    \"\"\"", "mimetype": "text/plain", "start_char_idx": 3436, "end_char_idx": 7025, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "da8e0de4-6c84-433d-9761-5fa03409fc45": {"__data__": {"id_": "da8e0de4-6c84-433d-9761-5fa03409fc45", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "791fa0a1-ef16-43b3-ae0f-6ce91fcd3982", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "hash": "3dab9994c07fef1cea7ae2affc23e33bf0e482666c830e409c86401b990f1109", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "5cdea29c-ef99-4bde-9c45-1110c60751f8", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "hash": "57dee74cfc8255e19167cdc6e96b45a1322bfcfa12532e074ced2b7430519f55", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c75d44c6-e84e-4055-b2c2-ea848ef62786", "node_type": "1", "metadata": {}, "hash": "fc41e0825ddd611e9658af5e53d862e95fc2cb46faa39e50d8ac1481b42f70a8", "class_name": "RelatedNodeInfo"}}, "text": "class BusinessKPIs(BaseModel):\n    total_produtos: int\n    total_unes: int\n    produtos_ruptura: int\n    valor_estoque: float\n    top_produtos: list[dict]\n    vendas_por_categoria: list[dict]\n\n\n@router.get(\"/business-kpis\", response_model=BusinessKPIs)\nasync def get_business_kpis(\n    current_user: Annotated[User, Depends(get_current_active_user)]\n) -> BusinessKPIs:\n    \"\"\"\n    Get business KPIs for Dashboard\n\n    Returns key business metrics including products, UNEs, stock ruptures, and top sellers.\n    Optimized to use Polars LazyFrame for memory efficiency.\n    \"\"\"\n    import polars as pl\n    import logging\n\n    logger = logging.getLogger(__name__)\n\n    try:\n        # Usar LazyFrame para evitar carregar tudo na mem\u00f3ria\n        lf = data_scope_service.get_filtered_lazyframe(current_user)\n        \n        # Verificar se temos dados antes de tentar processar\n        # collect_schema \u00e9 r\u00e1pido\n        schema = lf.collect_schema()\n        if not schema.names():\n             return BusinessKPIs(total_produtos=0, total_unes=0, produtos_ruptura=0, valor_estoque=0.0, top_produtos=[], vendas_por_categoria=[])\n\n        logger.info(f\"\ud83d\udcca KPIs: Iniciando processamento LAZY\")\n\n        # Preparar express\u00f5es de agrega\u00e7\u00e3o para rodar em UMA \u00daNICA PASSADA se poss\u00edvel\n        # Nota: Polars otimiza scans, ent\u00e3o m\u00faltiplas coletas s\u00e3o eficientes se o grafo for simples,\n        # mas agregar tudo de uma vez \u00e9 melhor.\n        \n        # Casting seguro para colunas num\u00e9ricas\n        def safe_col(name):\n            if name in schema.names():\n                return pl.col(name)\n            return pl.lit(0)\n\n        # Defini\u00e7\u00f5es de colunas\n        c_produto = safe_col(\"PRODUTO\")\n        c_une = safe_col(\"UNE\")\n        c_venda30 = safe_col(\"VENDA_30DD\").cast(pl.Float64, strict=False).fill_null(0)\n        c_est_une = safe_col(\"ESTOQUE_UNE\").cast(pl.Float64, strict=False).fill_null(0)\n        c_est_cd = safe_col(\"ESTOQUE_CD\").cast(pl.Float64, strict=False).fill_null(0)\n        c_est_lv = safe_col(\"ESTOQUE_LV\").cast(pl.Float64, strict=False).fill_null(0)\n        c_nome = safe_col(\"NOME\")\n        c_segmento = safe_col(\"NOMESEGMENTO\") if \"NOMESEGMENTO\" in schema.names() else safe_col(\"SEGMENTO\")\n\n        # 1. M\u00e9tricas Escalares (Count, Sum)\n        # Podemos coletar isso em uma query r\u00e1pida\n        metrics_lf = lf.select([\n            pl.col(\"PRODUTO\").n_unique().alias(\"total_produtos\"),\n            pl.col(\"UNE\").n_unique().alias(\"total_unes\") if \"UNE\" in schema.names() else pl.lit(0).alias(\"total_unes\"),\n            c_est_une.sum().alias(\"sum_estoque_une\"),\n            c_est_cd.sum().alias(\"sum_estoque_cd\"),\n            # Ruptura: CD=0 & Loja < LV & Venda > 0\n            ((c_est_cd == 0) & (c_est_une < c_est_lv) & (c_venda30 > 0)).sum().alias(\"produtos_ruptura\")\n        ])\n        \n        metrics_df = metrics_lf.collect() # Executa\n        metrics = metrics_df.row(0, named=True)\n        \n        valor_estoque = metrics[\"sum_estoque_une\"] + metrics[\"sum_estoque_cd\"]\n        \n        # 2. Top Produtos (precisa de group_by)\n        top_produtos_lf = lf.filter(c_venda30 > 0)\\\n            .group_by([\"PRODUTO\", \"NOME\"])\\\n            .agg([c_venda30.sum().alias(\"vendas\")])\\\n            .sort(\"vendas\", descending=True)\\\n            .head(10)\n            \n        top_produtos_df = top_produtos_lf.collect()\n        \n        top_produtos = []\n        for row in top_produtos_df.iter_rows(named=True):\n            top_produtos.append({\n                \"produto\": str(row[\"PRODUTO\"]),\n                \"nome\": str(row[\"NOME\"])[:40],\n                \"vendas\": int(row[\"vendas\"])\n            })\n\n        # 3.", "mimetype": "text/plain", "start_char_idx": 6451, "end_char_idx": 10073, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c75d44c6-e84e-4055-b2c2-ea848ef62786": {"__data__": {"id_": "c75d44c6-e84e-4055-b2c2-ea848ef62786", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "791fa0a1-ef16-43b3-ae0f-6ce91fcd3982", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "hash": "3dab9994c07fef1cea7ae2affc23e33bf0e482666c830e409c86401b990f1109", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "da8e0de4-6c84-433d-9761-5fa03409fc45", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}, "hash": "12074e7881269f7f38384a5ce68ca5174eba07c865a1e639c3e9dd55b675c42c", "class_name": "RelatedNodeInfo"}}, "text": "Top Produtos (precisa de group_by)\n        top_produtos_lf = lf.filter(c_venda30 > 0)\\\n            .group_by([\"PRODUTO\", \"NOME\"])\\\n            .agg([c_venda30.sum().alias(\"vendas\")])\\\n            .sort(\"vendas\", descending=True)\\\n            .head(10)\n            \n        top_produtos_df = top_produtos_lf.collect()\n        \n        top_produtos = []\n        for row in top_produtos_df.iter_rows(named=True):\n            top_produtos.append({\n                \"produto\": str(row[\"PRODUTO\"]),\n                \"nome\": str(row[\"NOME\"])[:40],\n                \"vendas\": int(row[\"vendas\"])\n            })\n\n        # 3. Vendas por Categoria\n        vendas_cat_lf = lf.filter(c_segmento.is_not_null())\\\n            .group_by(c_segmento)\\\n            .agg([\n                c_venda30.sum().alias(\"vendas\"),\n                pl.col(\"PRODUTO\").n_unique().alias(\"produtos\")\n            ])\\\n            .sort(\"vendas\", descending=True)\\\n            .head(8)\n            \n        vendas_cat_df = vendas_cat_lf.collect()\n        \n        vendas_por_categoria = []\n        for row in vendas_cat_df.iter_rows(named=True):\n            # O nome da coluna de agrupamento no resultado do group_by \u00e9 o pr\u00f3prio nome da coluna\n            seg_col_name = \"NOMESEGMENTO\" if \"NOMESEGMENTO\" in schema.names() else \"SEGMENTO\"\n            segmento = str(row.get(seg_col_name, \"N/A\")).strip()\n            \n            if segmento and segmento != \"null\":\n                vendas_por_categoria.append({\n                    \"categoria\": segmento[:30],\n                    \"vendas\": int(row[\"vendas\"]),\n                    \"produtos\": int(row[\"produtos\"])\n                })\n\n        logger.info(f\"\ud83d\udcca KPIs calculados (Lazy) - Produtos: {metrics['total_produtos']}\")\n\n        return BusinessKPIs(\n            total_produtos=metrics[\"total_produtos\"],\n            total_unes=metrics[\"total_unes\"],\n            produtos_ruptura=metrics[\"produtos_ruptura\"],\n            valor_estoque=valor_estoque,\n            top_produtos=top_produtos,\n            vendas_por_categoria=vendas_por_categoria\n        )\n\n    except Exception as e:\n        logger.error(f\"Error fetching business KPIs: {str(e)}\", exc_info=True)\n        raise HTTPException(status_code=500, detail=f\"Error fetching business KPIs: {str(e)}\")", "mimetype": "text/plain", "start_char_idx": 9461, "end_char_idx": 11722, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7ee3a314-1989-40aa-9b96-c8b9f1411aac": {"__data__": {"id_": "7ee3a314-1989-40aa-9b96-c8b9f1411aac", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\playground.py", "language": "python", "lines": 169, "filename": "playground.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b1685fa9-c29e-4648-82a8-da69110af002", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\playground.py", "language": "python", "lines": 169, "filename": "playground.py"}, "hash": "fb26cf505814ab3a5303cbf88fcb953fc6dc62427bd253880c2c8c9af62dee67", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "cf828070-2cc0-4677-8b1c-534450c5d950", "node_type": "1", "metadata": {}, "hash": "6fbab4c937a23b16dc249e1bf0c97c05e5f5916f8b83acb190ade0afd6b43810", "class_name": "RelatedNodeInfo"}}, "text": "from typing import Annotated, Dict, Any, List, Optional\nfrom datetime import datetime\nimport json\nimport logging\n\nimport polars as pl\nfrom fastapi import APIRouter, Depends, HTTPException\nfrom pydantic import BaseModel, Field\n\nfrom app.api.dependencies import require_role, get_current_active_user\nfrom app.core.data_scope_service import data_scope_service\nfrom app.infrastructure.database.models import User\nfrom app.config.settings import settings\nfrom app.core.llm_gemini_adapter import GeminiLLMAdapter\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRouter(prefix=\"/playground\", tags=[\"Playground\"])\n\nclass QueryRequest(BaseModel):\n    query: str # N\u00e3o usada diretamente como SQL, mas sim como intent\n    columns: List[str] = []\n    limit: int = 100\n\nclass ChatMessage(BaseModel):\n    role: str  # \"user\" ou \"assistant\"\n    content: str\n    timestamp: Optional[str] = None\n\nclass PlaygroundChatRequest(BaseModel):\n    message: str\n    system_instruction: Optional[str] = None\n    history: List[ChatMessage] = Field(default_factory=list)\n    temperature: float = Field(default=1.0, ge=0.0, le=2.0)\n    max_tokens: int = Field(default=2048, ge=100, le=8192)\n    json_mode: bool = False\n    stream: bool = False\n\n@router.post(\"/query\")\nasync def execute_query(\n    current_user: Annotated[User, Depends(require_role(\"admin\"))],\n    request: QueryRequest\n):\n    \"\"\"\n    Endpoint para explora\u00e7\u00e3o de dados (Admin Only).\n    Permite selecionar colunas e visualizar dados brutos.\n    \"\"\"\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        # Selecionar colunas se especificadas\n        if request.columns:\n            valid_cols = [c for c in request.columns if c in df.columns]\n            if valid_cols:\n                df = df.select(valid_cols)\n\n        # Limitar resultados\n        result = df.head(request.limit)\n\n        return {\n            \"rows\": result.to_dicts(),\n            \"count\": len(result),\n            \"total_rows\": len(df), # Total no dataset (lazy count seria melhor, mas aqui df j\u00e1 \u00e9 eager ou quase)\n            \"columns\": result.columns\n        }\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2192, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "cf828070-2cc0-4677-8b1c-534450c5d950": {"__data__": {"id_": "cf828070-2cc0-4677-8b1c-534450c5d950", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\playground.py", "language": "python", "lines": 169, "filename": "playground.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b1685fa9-c29e-4648-82a8-da69110af002", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\playground.py", "language": "python", "lines": 169, "filename": "playground.py"}, "hash": "fb26cf505814ab3a5303cbf88fcb953fc6dc62427bd253880c2c8c9af62dee67", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "7ee3a314-1989-40aa-9b96-c8b9f1411aac", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\playground.py", "language": "python", "lines": 169, "filename": "playground.py"}, "hash": "ecc0ac95da09447b69e91cd54a6a83fd99738d5728b234572e9acd2135654409", "class_name": "RelatedNodeInfo"}}, "text": "@router.post(\"/chat\")\nasync def playground_chat(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    request: PlaygroundChatRequest\n):\n    \"\"\"\n    Endpoint de chat do Playground com controles avan\u00e7ados.\n    Permite testar o modelo Gemini com diferentes par\u00e2metros.\n    \"\"\"\n    try:\n        # Validar mensagem n\u00e3o vazia\n        if not request.message or not request.message.strip():\n            raise HTTPException(\n                status_code=400,\n                detail=\"A mensagem n\u00e3o pode estar vazia. Por favor, digite algo.\"\n            )\n\n        if not settings.GEMINI_API_KEY:\n            raise HTTPException(\n                status_code=500,\n                detail=\"GEMINI_API_KEY n\u00e3o configurada no servidor\"\n            )\n\n        # Configurar LLM com par\u00e2metros customizados usando GeminiLLMAdapter\n        llm = GeminiLLMAdapter(\n            model_name=settings.LLM_MODEL_NAME,\n            gemini_api_key=settings.GEMINI_API_KEY,\n            system_instruction=request.system_instruction\n        ).get_llm()\n\n        # Note: GeminiLLMAdapter doesn't support custom temperature/max_tokens in get_llm()\n        # These parameters would need to be added to the adapter if needed\n\n        # Construir hist\u00f3rico de mensagens\n        messages = []\n        for msg in request.history:\n            if msg.role == \"user\":\n                messages.append((\"human\", msg.content))\n            elif msg.role == \"assistant\":\n                messages.append((\"assistant\", msg.content))\n\n        # Adicionar mensagem atual\n        messages.append((\"human\", request.message))\n\n        # Invocar LLM\n        start_time = datetime.now()\n        response = llm.invoke(messages)\n        end_time = datetime.now()\n\n        response_time = (end_time - start_time).total_seconds()\n\n        # Estat\u00edsticas de cache (simuladas por enquanto)\n        # Em produ\u00e7\u00e3o, voc\u00ea poderia usar Redis ou outro sistema de cache\n        cache_stats = {\n            \"hits\": 0,\n            \"misses\": 0,\n            \"hit_rate\": 0.0,\n            \"enabled\": False\n        }\n\n        return {\n            \"response\": response.content,\n            \"model_info\": {\n                \"model\": settings.LLM_MODEL_NAME,\n                \"temperature\": request.temperature,\n                \"max_tokens\": request.max_tokens,\n                \"json_mode\": request.json_mode\n            },\n            \"metadata\": {\n                \"response_time\": round(response_time, 2),\n                \"timestamp\": datetime.now().isoformat(),\n                \"user\": current_user.username\n            },\n            \"cache_stats\": cache_stats\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro no playground chat: {e}\", exc_info=True)\n        raise HTTPException(\n            status_code=500,\n            detail=f\"Erro ao processar mensagem: {str(e)}\"\n        )\n\n\n@router.get(\"/info\")\nasync def get_model_info(\n    current_user: Annotated[User, Depends(get_current_active_user)]\n):\n    \"\"\"\n    Retorna informa\u00e7\u00f5es sobre o modelo LLM configurado.\n    \"\"\"\n    return {\n        \"model\": settings.LLM_MODEL_NAME,\n        \"api_key_configured\": bool(settings.GEMINI_API_KEY),\n        \"default_temperature\": 1.0,\n        \"default_max_tokens\": 2048,\n        \"max_temperature\": 2.0,\n        \"max_tokens_limit\": 8192\n    }", "mimetype": "text/plain", "start_char_idx": 2195, "end_char_idx": 5484, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "4b2d4ff8-9492-471a-8cb4-40d2a0458932": {"__data__": {"id_": "4b2d4ff8-9492-471a-8cb4-40d2a0458932", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\preferences.py", "language": "python", "lines": 286, "filename": "preferences.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2d22952b-f353-4fd8-91db-1b3ffbccbbb3", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\preferences.py", "language": "python", "lines": 286, "filename": "preferences.py"}, "hash": "cd36109717c5b1ce2889c3b731b35b7c5adcdb0aeb4c49b603863053eb716c67", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "8de11b9f-7516-4ded-9fb5-57391e7ac8f4", "node_type": "1", "metadata": {}, "hash": "096db2c16978b06640e0483bd103c93f7fb69e58d46fa1de1a3276000036631e", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nUser Preferences Endpoints\nHandles user preferences and persistent memory\n\"\"\"\n\nfrom typing import Any\nimport uuid\n\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom pydantic import BaseModel\nfrom sqlalchemy import select, and_\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom app.api.dependencies import get_current_user, get_db\nfrom app.infrastructure.database.models import UserPreference, User\n\nrouter = APIRouter(prefix=\"/preferences\", tags=[\"Preferences\"])\n\n\n# Pydantic Models\nclass PreferenceCreate(BaseModel):\n    \"\"\"Request to create or update a preference\"\"\"\n    key: str\n    value: str\n    context: str | None = None\n\n\nclass PreferenceResponse(BaseModel):\n    \"\"\"Preference response\"\"\"\n    id: str\n    key: str\n    value: str\n    context: str | None\n    created_at: str\n    updated_at: str\n\n\nclass PreferenceListResponse(BaseModel):\n    \"\"\"List of preferences\"\"\"\n    preferences: dict[str, str]  # key: value mapping\n\n\n@router.get(\"\", response_model=PreferenceListResponse)\nasync def list_preferences(\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    List all preferences for the current user.\n\n    Returns a dictionary mapping preference keys to values.\n    \"\"\"\n    result = await db.execute(\n        select(UserPreference).where(UserPreference.user_id == current_user.id)\n    )\n    preferences = result.scalars().all()\n\n    return PreferenceListResponse(\n        preferences={pref.key: pref.value for pref in preferences}\n    )\n\n\n@router.get(\"/{key}\")\nasync def get_preference(\n    key: str,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    Get a specific preference by key.\n    \"\"\"\n    result = await db.execute(\n        select(UserPreference).where(\n            and_(\n                UserPreference.user_id == current_user.id,\n                UserPreference.key == key\n            )\n        )\n    )\n    preference = result.scalar_one_or_none()\n\n    if not preference:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=f\"Preference '{key}' not found\"\n        )\n\n    return PreferenceResponse(\n        id=str(preference.id),\n        key=preference.key,\n        value=preference.value,\n        context=preference.context,\n        created_at=preference.created_at.isoformat(),\n        updated_at=preference.updated_at.isoformat()\n    )\n\n\n@router.post(\"\", response_model=PreferenceResponse)\nasync def set_preference(\n    request: PreferenceCreate,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    Create or update a preference.\n\n    If the preference already exists, it will be updated.\n    \"\"\"\n    # Check if preference exists\n    result = await db.execute(\n        select(UserPreference).where(\n            and_(\n                UserPreference.user_id == current_user.id,\n                UserPreference.key == request.key\n            )\n        )\n    )\n    existing_pref = result.scalar_one_or_none()\n\n    if existing_pref:\n        # Update existing preference\n        existing_pref.value = request.value\n        if request.context is not None:\n            existing_pref.context = request.context\n        await db.commit()\n        await db.refresh(existing_pref)\n        preference = existing_pref\n    else:\n        # Create new preference\n        preference = UserPreference(\n            user_id=current_user.id,\n            key=request.key,\n            value=request.value,\n            context=request.context\n        )\n        db.add(preference)\n        await db.commit()\n        await db.refresh(preference)\n\n    return PreferenceResponse(\n        id=str(preference.id),\n        key=preference.key,\n        value=preference.value,\n        context=preference.context,\n        created_at=preference.created_at.isoformat(),\n        updated_at=preference.updated_at.isoformat()\n    )", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3960, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8de11b9f-7516-4ded-9fb5-57391e7ac8f4": {"__data__": {"id_": "8de11b9f-7516-4ded-9fb5-57391e7ac8f4", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\preferences.py", "language": "python", "lines": 286, "filename": "preferences.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2d22952b-f353-4fd8-91db-1b3ffbccbbb3", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\preferences.py", "language": "python", "lines": 286, "filename": "preferences.py"}, "hash": "cd36109717c5b1ce2889c3b731b35b7c5adcdb0aeb4c49b603863053eb716c67", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "4b2d4ff8-9492-471a-8cb4-40d2a0458932", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\preferences.py", "language": "python", "lines": 286, "filename": "preferences.py"}, "hash": "124eda212ea905559e557da8d563175b50733f461d07ae4ce62edbed9b28cf32", "class_name": "RelatedNodeInfo"}}, "text": "@router.put(\"/batch\")\nasync def set_preferences_batch(\n    preferences: dict[str, str],\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    Set multiple preferences at once.\n\n    Accepts a dictionary of key-value pairs.\n    \"\"\"\n    updated_count = 0\n    created_count = 0\n\n    for key, value in preferences.items():\n        # Check if preference exists\n        result = await db.execute(\n            select(UserPreference).where(\n                and_(\n                    UserPreference.user_id == current_user.id,\n                    UserPreference.key == key\n                )\n            )\n        )\n        existing_pref = result.scalar_one_or_none()\n\n        if existing_pref:\n            existing_pref.value = value\n            updated_count += 1\n        else:\n            new_pref = UserPreference(\n                user_id=current_user.id,\n                key=key,\n                value=value\n            )\n            db.add(new_pref)\n            created_count += 1\n\n    await db.commit()\n\n    return {\n        \"message\": \"Preferences updated successfully\",\n        \"updated\": updated_count,\n        \"created\": created_count,\n        \"total\": len(preferences)\n    }\n\n\n@router.delete(\"/{key}\")\nasync def delete_preference(\n    key: str,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    Delete a specific preference.\n    \"\"\"\n    result = await db.execute(\n        select(UserPreference).where(\n            and_(\n                UserPreference.user_id == current_user.id,\n                UserPreference.key == key\n            )\n        )\n    )\n    preference = result.scalar_one_or_none()\n\n    if not preference:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=f\"Preference '{key}' not found\"\n        )\n\n    await db.delete(preference)\n    await db.commit()\n\n    return {\"message\": f\"Preference '{key}' deleted successfully\"}\n\n\n@router.get(\"/common/keys\")\nasync def get_common_keys() -> Any:\n    \"\"\"\n    Get list of common preference keys with descriptions.\n\n    Useful for frontend to know what preferences are available.\n    \"\"\"\n    return {\n        \"keys\": [\n            {\n                \"key\": UserPreference.Keys.PREFERRED_CHART_TYPE,\n                \"description\": \"Tipo de gr\u00e1fico preferido\",\n                \"options\": [\"bar\", \"line\", \"pie\", \"scatter\"],\n                \"default\": \"bar\"\n            },\n            {\n                \"key\": UserPreference.Keys.PREFERRED_DATA_FORMAT,\n                \"description\": \"Formato de dados preferido\",\n                \"options\": [\"table\", \"chart\", \"both\"],\n                \"default\": \"both\"\n            },\n            {\n                \"key\": UserPreference.Keys.LANGUAGE,\n                \"description\": \"Idioma\",\n                \"options\": [\"pt-BR\", \"en-US\"],\n                \"default\": \"pt-BR\"\n            },\n            {\n                \"key\": UserPreference.Keys.THEME,\n                \"description\": \"Tema\",\n                \"options\": [\"light\", \"dark\"],\n                \"default\": \"light\"\n            },\n            {\n                \"key\": UserPreference.Keys.COMPANY_NAME,\n                \"description\": \"Nome da empresa\",\n                \"type\": \"text\"\n            },\n            {\n                \"key\": UserPreference.Keys.BUSINESS_SEGMENT,\n                \"description\": \"Segmento de neg\u00f3cio\",\n                \"type\": \"text\"\n            },\n            {\n                \"key\": UserPreference.Keys.ANALYSIS_FOCUS,\n                \"description\": \"Foco principal de an\u00e1lise\",\n                \"options\": [\"sales\", \"inventory\", \"finance\"],\n                \"default\": \"sales\"\n            },\n            {\n                \"key\": UserPreference.Keys.NOTIFICATION_ENABLED,\n                \"description\": \"Notifica\u00e7\u00f5es habilitadas\",\n                \"options\": [\"true\", \"false\"],\n                \"default\": \"true\"\n            }\n        ]\n    }", "mimetype": "text/plain", "start_char_idx": 3963, "end_char_idx": 7938, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "17f16b38-aaa9-4de5-83ad-77f09595413f": {"__data__": {"id_": "17f16b38-aaa9-4de5-83ad-77f09595413f", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\reports.py", "language": "python", "lines": 218, "filename": "reports.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "47ef942d-4e7c-4b8b-a31f-63bb4a87272a", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\reports.py", "language": "python", "lines": 218, "filename": "reports.py"}, "hash": "ec3ea1aa939d6561742eb64ba9321f6d361ac03ad77c70575ab47f36074ac2a0", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "00ea1eb8-e391-4f88-a6b4-bc537d8adfd5", "node_type": "1", "metadata": {}, "hash": "77d3a9156a8134c6200e3f33db8bb8bf8ceedda8c57b80f50b654aa06ca019e7", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nReports Endpoints\nCRUD operations for reports\n\"\"\"\n\nimport uuid\nfrom typing import Annotated\n\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom sqlalchemy import select\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom app.api.dependencies import get_current_active_user, get_db, require_permission\nfrom app.infrastructure.database.models import Report, User\nfrom app.schemas.report import ReportCreate, ReportListResponse, ReportResponse, ReportUpdate\n\nrouter = APIRouter(prefix=\"/reports\", tags=[\"Reports\"])\n\n\n@router.get(\"\", response_model=list[ReportListResponse])\nasync def get_reports(\n    db: Annotated[AsyncSession, Depends(get_db)],\n    _: Annotated[User, Depends(require_permission(\"VIEW_REPORTS\"))],\n    status_filter: str | None = None,\n) -> list[Report]:\n    \"\"\"Get all reports with optional status filter\"\"\"\n    \n    query = select(Report).order_by(Report.created_at.desc())\n    \n    if status_filter:\n        query = query.where(Report.status == status_filter)\n    \n    result = await db.execute(query)\n    reports = result.scalars().all()\n    return list(reports)\n\n\n@router.get(\"/{report_id}\", response_model=ReportResponse)\nasync def get_report(\n    report_id: uuid.UUID,\n    db: Annotated[AsyncSession, Depends(get_db)],\n    _: Annotated[User, Depends(require_permission(\"VIEW_REPORTS\"))],\n) -> Report:\n    \"\"\"Get report by ID\"\"\"\n    \n    result = await db.execute(\n        select(Report).where(Report.id == report_id)\n    )\n    report = result.scalar_one_or_none()\n    \n    if not report:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Report not found\"\n        )\n    \n    # Add author name\n    author_result = await db.execute(\n        select(User.username).where(User.id == report.author_id)\n    )\n    author_name = author_result.scalar_one_or_none()\n    \n    # Convert to dict and add author_name\n    report_dict = {\n        \"id\": report.id,\n        \"title\": report.title,\n        \"description\": report.description,\n        \"content\": report.content,\n        \"status\": report.status,\n        \"author_id\": report.author_id,\n        \"author_name\": author_name,\n        \"created_at\": report.created_at,\n        \"updated_at\": report.updated_at,\n    }\n    \n    return report_dict\n\n\n@router.post(\"\", response_model=ReportResponse, status_code=status.HTTP_201_CREATED)\nasync def create_report(\n    report_data: ReportCreate,\n    db: Annotated[AsyncSession, Depends(get_db)],\n    current_user: Annotated[User, Depends(require_permission(\"CREATE_REPORTS\"))],\n) -> dict:\n    \"\"\"Create new report\"\"\"\n    \n    new_report = Report(\n        title=report_data.title,\n        description=report_data.description,\n        content=report_data.content,\n        status=report_data.status,\n        author_id=current_user.id,\n    )\n    \n    db.add(new_report)\n    await db.commit()\n    await db.refresh(new_report)\n    \n    return {\n        \"id\": new_report.id,\n        \"title\": new_report.title,\n        \"description\": new_report.description,\n        \"content\": new_report.content,\n        \"status\": new_report.status,\n        \"author_id\": new_report.author_id,\n        \"author_name\": current_user.username,\n        \"created_at\": new_report.created_at,\n        \"updated_at\": new_report.updated_at,\n    }", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3281, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "00ea1eb8-e391-4f88-a6b4-bc537d8adfd5": {"__data__": {"id_": "00ea1eb8-e391-4f88-a6b4-bc537d8adfd5", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\reports.py", "language": "python", "lines": 218, "filename": "reports.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "47ef942d-4e7c-4b8b-a31f-63bb4a87272a", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\reports.py", "language": "python", "lines": 218, "filename": "reports.py"}, "hash": "ec3ea1aa939d6561742eb64ba9321f6d361ac03ad77c70575ab47f36074ac2a0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "17f16b38-aaa9-4de5-83ad-77f09595413f", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\reports.py", "language": "python", "lines": 218, "filename": "reports.py"}, "hash": "3dc4ff7ef821aede2e6efe2865150263f6cf18ceeeee4d9fc67d05fbc55b9308", "class_name": "RelatedNodeInfo"}}, "text": "@router.put(\"/{report_id}\", response_model=ReportResponse)\nasync def update_report(\n    report_id: uuid.UUID,\n    report_data: ReportUpdate,\n    db: Annotated[AsyncSession, Depends(get_db)],\n    current_user: Annotated[User, Depends(require_permission(\"EDIT_REPORTS\"))],\n) -> dict:\n    \"\"\"Update report\"\"\"\n    \n    result = await db.execute(\n        select(Report).where(Report.id == report_id)\n    )\n    report = result.scalar_one_or_none()\n    \n    if not report:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Report not found\"\n        )\n    \n    # Check ownership (non-admins can only edit their own reports)\n    if current_user.role != \"admin\" and report.author_id != current_user.id:\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"You can only edit your own reports\"\n        )\n    \n    # Update fields\n    update_data = report_data.model_dump(exclude_unset=True)\n    for field, value in update_data.items():\n        setattr(report, field, value)\n    \n    await db.commit()\n    await db.refresh(report)\n    \n    return {\n        \"id\": report.id,\n        \"title\": report.title,\n        \"description\": report.description,\n        \"content\": report.content,\n        \"status\": report.status,\n        \"author_id\": report.author_id,\n        \"author_name\": current_user.username,\n        \"created_at\": report.created_at,\n        \"updated_at\": report.updated_at,\n    }\n\n\n@router.delete(\"/{report_id}\", status_code=status.HTTP_204_NO_CONTENT)\nasync def delete_report(\n    report_id: uuid.UUID,\n    db: Annotated[AsyncSession, Depends(get_db)],\n    current_user: Annotated[User, Depends(require_permission(\"DELETE_REPORTS\"))],\n):\n    \"\"\"Delete report\"\"\"\n    \n    result = await db.execute(\n        select(Report).where(Report.id == report_id)\n    )\n    report = result.scalar_one_or_none()\n    \n    if not report:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Report not found\"\n        )\n    \n    # Check ownership (non-admins can only delete their own reports)\n    if current_user.role != \"admin\" and report.author_id != current_user.id:\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"You can only delete your own reports\"\n        )\n    \n    await db.delete(report)\n    await db.commit()\n\n\n@router.post(\"/{report_id}/generate-pdf\")\nasync def generate_pdf(\n    report_id: uuid.UUID,\n    db: Annotated[AsyncSession, Depends(get_db)],\n    _: Annotated[User, Depends(require_permission(\"VIEW_REPORTS\"))],\n) -> dict[str, str]:\n    \"\"\"\n    Generate PDF for report\n    \n    TODO: Implement PDF generation with reportlab or weasyprint\n    \"\"\"\n    result = await db.execute(\n        select(Report).where(Report.id == report_id)\n    )\n    report = result.scalar_one_or_none()\n    \n    if not report:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Report not found\"\n        )\n    \n    # Mock response - implement actual PDF generation\n    return {\n        \"message\": \"PDF generation not yet implemented\",\n        \"report_id\": str(report_id),\n        \"report_title\": report.title,\n    }", "mimetype": "text/plain", "start_char_idx": 3284, "end_char_idx": 6520, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "29814bdc-fb4d-4666-b1fb-d625c107489b": {"__data__": {"id_": "29814bdc-fb4d-4666-b1fb-d625c107489b", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\rupturas.py", "language": "python", "lines": 193, "filename": "rupturas.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "623d9f4c-a409-45f9-b87f-6f7ddaecbd9b", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\rupturas.py", "language": "python", "lines": 193, "filename": "rupturas.py"}, "hash": "9da3b9767b426d05bea6dacd513ecc62e6d94bd66bb7f1775637b8c16adb64b9", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "64b44d21-bae1-44b6-9acc-2844af51070d", "node_type": "1", "metadata": {}, "hash": "d618015130824eb12e79bf2e000e8336f7332f2f189139e449f67b74799113c9", "class_name": "RelatedNodeInfo"}}, "text": "from typing import Annotated, List, Dict, Any, Optional\n\nimport polars as pl\nfrom fastapi import APIRouter, Depends, HTTPException, Query\n\nfrom app.api.dependencies import get_current_active_user\nfrom app.core.data_scope_service import data_scope_service\nfrom app.infrastructure.database.models import User\n\nrouter = APIRouter(prefix=\"/rupturas\", tags=[\"Rupturas\"])\n\n@router.get(\"/critical\", response_model=List[Dict[str, Any]])\nasync def get_critical_rupturas(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    limit: int = Query(50, description=\"N\u00famero m\u00e1ximo de resultados\"),\n    segmento: Optional[str] = Query(None, description=\"Filtro por segmento (NOMESEGMENTO)\"),\n    une: Optional[str] = Query(None, description=\"Filtro por UNE\")\n):\n    \"\"\"\n    Produtos com ruptura cr\u00edtica (ESTOQUE_CD=0 + Estoque Loja < Linha Verde).\n\n    Defini\u00e7\u00e3o de Ruptura Cr\u00edtica (conforme regras de neg\u00f3cio):\n    - ESTOQUE_CD = 0 (sem estoque no centro de distribui\u00e7\u00e3o)\n    - ESTOQUE_UNE < ESTOQUE_LV (estoque da loja menor que linha verde)\n    - VENDA_30DD > 0 (produtos com vendas nos \u00faltimos 30 dias)\n\n    Retorna:\n    - CRITICIDADE_PCT: percentual de criticidade (0-100%) baseado na raz\u00e3o venda/linha verde\n    - NECESSIDADE: quantidade faltando para atingir a linha verde\n    \"\"\"\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        # Verificar colunas necess\u00e1rias\n        required_cols = [\"ESTOQUE_CD\", \"ESTOQUE_UNE\", \"ESTOQUE_LV\", \"VENDA_30DD\"]\n        if not all(col in df.columns for col in required_cols):\n            return []\n\n        # Casting para garantir tipos num\u00e9ricos\n        df = df.with_columns([\n            pl.col(\"VENDA_30DD\").cast(pl.Float64, strict=False).fill_null(0),\n            pl.col(\"ESTOQUE_CD\").cast(pl.Float64, strict=False).fill_null(0),\n            pl.col(\"ESTOQUE_UNE\").cast(pl.Float64, strict=False).fill_null(0),\n            pl.col(\"ESTOQUE_LV\").cast(pl.Float64, strict=False).fill_null(0),\n        ])\n\n        # Aplicar filtros opcionais\n        if segmento and \"NOMESEGMENTO\" in df.columns:\n            df = df.filter(pl.col(\"NOMESEGMENTO\") == segmento)\n\n        if une:\n            df = df.filter(pl.col(\"UNE\") == une)\n\n        # Defini\u00e7\u00e3o de ruptura cr\u00edtica:\n        # CD=0 + Loja < Linha Verde + Vendas > 0\n        rupturas = df.filter(\n            (pl.col(\"ESTOQUE_CD\") <= 0) &\n            (pl.col(\"ESTOQUE_UNE\") < pl.col(\"ESTOQUE_LV\")) &\n            (pl.col(\"VENDA_30DD\") > 0)\n        )\n\n        # Calcular criticidade % e necessidade\n        rupturas = rupturas.with_columns([\n            # Criticidade = (Venda / Linha Verde) * 100, limitado a 100%\n            pl.when(pl.col(\"ESTOQUE_LV\") > 0)\n              .then((pl.col(\"VENDA_30DD\") / pl.col(\"ESTOQUE_LV\") * 100).clip(0, 100))\n              .otherwise(0)\n              .alias(\"CRITICIDADE_PCT\"),\n\n            # Necessidade = Linha Verde - Estoque Atual\n            (pl.col(\"ESTOQUE_LV\") - pl.col(\"ESTOQUE_UNE\"))\n              .clip(0, None)\n              .alias(\"NECESSIDADE\")\n        ])\n\n        # Ordenar por criticidade e venda\n        rupturas = rupturas.sort([\"CRITICIDADE_PCT\", \"VENDA_30DD\"], descending=[True, True]).head(limit)\n\n        return rupturas.to_dicts()\n    except Exception as e:\n        import traceback\n        with open(\"rupturas_error.log\", \"a\") as f:\n            f.write(f\"Error in endpoint: {e}\\n\")\n            traceback.print_exc(file=f)\n        raise HTTPException(status_code=500, detail=str(e))", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3466, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "64b44d21-bae1-44b6-9acc-2844af51070d": {"__data__": {"id_": "64b44d21-bae1-44b6-9acc-2844af51070d", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\rupturas.py", "language": "python", "lines": 193, "filename": "rupturas.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "623d9f4c-a409-45f9-b87f-6f7ddaecbd9b", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\rupturas.py", "language": "python", "lines": 193, "filename": "rupturas.py"}, "hash": "9da3b9767b426d05bea6dacd513ecc62e6d94bd66bb7f1775637b8c16adb64b9", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "29814bdc-fb4d-4666-b1fb-d625c107489b", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\rupturas.py", "language": "python", "lines": 193, "filename": "rupturas.py"}, "hash": "117cb50de466011bebef305ff7813a74572e3e725442e21828ecc9b47eefcb57", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "17dde553-57f8-4e81-bc21-28d6d7f2e6b2", "node_type": "1", "metadata": {}, "hash": "43be6198fa943feb1ccbd075ac7f4cea3285d7ac238e08b743473bd4772fd25a", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/filters/segmentos\", response_model=List[str])\nasync def get_segmentos(\n    current_user: Annotated[User, Depends(get_current_active_user)]\n):\n    \"\"\"\n    Lista todos os segmentos dispon\u00edveis para filtro.\n    \"\"\"\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        if \"NOMESEGMENTO\" not in df.columns:\n            return []\n\n        segmentos = df.select(\"NOMESEGMENTO\").unique().sort(\"NOMESEGMENTO\").to_series().to_list()\n        return [s for s in segmentos if s is not None and str(s).strip()]\n    except Exception as e:\n        import traceback\n        with open(\"rupturas_error.log\", \"a\") as f:\n            f.write(f\"Error in endpoint: {e}\\n\")\n            traceback.print_exc(file=f)\n        raise HTTPException(status_code=500, detail=str(e))\n\n\n@router.get(\"/filters/unes\", response_model=List[str])\nasync def get_unes(\n    current_user: Annotated[User, Depends(get_current_active_user)]\n):\n    \"\"\"\n    Lista todas as UNEs dispon\u00edveis para filtro.\n    \"\"\"\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        if \"UNE\" not in df.columns:\n            return []\n\n        unes = df.select(\"UNE\").unique().sort(\"UNE\").to_series().to_list()\n        return [str(u) for u in unes if u is not None]\n    except Exception as e:\n        import traceback\n        with open(\"rupturas_error.log\", \"a\") as f:\n            f.write(f\"Error in endpoint: {e}\\n\")\n            traceback.print_exc(file=f)\n        raise HTTPException(status_code=500, detail=str(e))", "mimetype": "text/plain", "start_char_idx": 3469, "end_char_idx": 4998, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "17dde553-57f8-4e81-bc21-28d6d7f2e6b2": {"__data__": {"id_": "17dde553-57f8-4e81-bc21-28d6d7f2e6b2", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\rupturas.py", "language": "python", "lines": 193, "filename": "rupturas.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "623d9f4c-a409-45f9-b87f-6f7ddaecbd9b", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\rupturas.py", "language": "python", "lines": 193, "filename": "rupturas.py"}, "hash": "9da3b9767b426d05bea6dacd513ecc62e6d94bd66bb7f1775637b8c16adb64b9", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "64b44d21-bae1-44b6-9acc-2844af51070d", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\rupturas.py", "language": "python", "lines": 193, "filename": "rupturas.py"}, "hash": "a0d3a11691fe9fb49ffb06833ff10e5cae7c301613a05f9b4ce83075b4ff241c", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/filters/unes\", response_model=List[str])\nasync def get_unes(\n    current_user: Annotated[User, Depends(get_current_active_user)]\n):\n    \"\"\"\n    Lista todas as UNEs dispon\u00edveis para filtro.\n    \"\"\"\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        if \"UNE\" not in df.columns:\n            return []\n\n        unes = df.select(\"UNE\").unique().sort(\"UNE\").to_series().to_list()\n        return [str(u) for u in unes if u is not None]\n    except Exception as e:\n        import traceback\n        with open(\"rupturas_error.log\", \"a\") as f:\n            f.write(f\"Error in endpoint: {e}\\n\")\n            traceback.print_exc(file=f)\n        raise HTTPException(status_code=500, detail=str(e))\n\n\n@router.get(\"/summary\", response_model=Dict[str, Any])\nasync def get_rupturas_summary(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    segmento: Optional[str] = Query(None, description=\"Filtro por segmento\"),\n    une: Optional[str] = Query(None, description=\"Filtro por UNE\")\n):\n    \"\"\"\n    Retorna resumo de m\u00e9tricas de rupturas cr\u00edticas.\n    \"\"\"\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        required_cols = [\"ESTOQUE_CD\", \"ESTOQUE_UNE\", \"ESTOQUE_LV\", \"VENDA_30DD\"]\n        if not all(col in df.columns for col in required_cols):\n            return {\"total\": 0, \"criticos\": 0, \"valor_estimado\": 0}\n\n        # Casting\n        df = df.with_columns([\n            pl.col(\"VENDA_30DD\").cast(pl.Float64, strict=False).fill_null(0),\n            pl.col(\"ESTOQUE_CD\").cast(pl.Float64, strict=False).fill_null(0),\n            pl.col(\"ESTOQUE_UNE\").cast(pl.Float64, strict=False).fill_null(0),\n            pl.col(\"ESTOQUE_LV\").cast(pl.Float64, strict=False).fill_null(0),\n        ])\n\n        # Aplicar filtros\n        if segmento and \"NOMESEGMENTO\" in df.columns:\n            df = df.filter(pl.col(\"NOMESEGMENTO\") == segmento)\n        if une:\n            df = df.filter(pl.col(\"UNE\") == une)\n\n        # Filtrar rupturas\n        rupturas = df.filter(\n            (pl.col(\"ESTOQUE_CD\") <= 0) &\n            (pl.col(\"ESTOQUE_UNE\") < pl.col(\"ESTOQUE_LV\")) &\n            (pl.col(\"VENDA_30DD\") > 0)\n        )\n\n        # Calcular criticidade\n        rupturas = rupturas.with_columns([\n            pl.when(pl.col(\"ESTOQUE_LV\") > 0)\n              .then((pl.col(\"VENDA_30DD\") / pl.col(\"ESTOQUE_LV\") * 100).clip(0, 100))\n              .otherwise(0)\n              .alias(\"CRITICIDADE_PCT\")\n        ])\n\n        total = rupturas.height\n        criticos = rupturas.filter(pl.col(\"CRITICIDADE_PCT\") >= 75).height\n\n        return {\n            \"total\": total,\n            \"criticos\": criticos,\n            \"valor_estimado\": 0  # Pode ser calculado se houver coluna de custo\n        }\n    except Exception as e:\n        import traceback\n        with open(\"rupturas_error.log\", \"a\") as f:\n            f.write(f\"Error in endpoint: {e}\\n\")\n            traceback.print_exc(file=f)\n        raise HTTPException(status_code=500, detail=str(e))", "mimetype": "text/plain", "start_char_idx": 4268, "end_char_idx": 7275, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1317761a-85a1-4422-98a7-177ddcec1deb": {"__data__": {"id_": "1317761a-85a1-4422-98a7-177ddcec1deb", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\shared.py", "language": "python", "lines": 196, "filename": "shared.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "c837571e-9916-40cf-a47b-c5a6832b4b0d", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\shared.py", "language": "python", "lines": 196, "filename": "shared.py"}, "hash": "854b9c07b86103aff11a05a3ddc474d7624b5e9b61898727d57478a20782f169", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f17949ff-8dc0-43a6-a5fd-be34a19c1986", "node_type": "1", "metadata": {}, "hash": "22985ed1a1ac72f1035fbf12f1cbab6410f71f8dfb01ed4f99be9c739a857524", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nShared Conversations Endpoints\nHandles sharing and viewing shared conversations\n\"\"\"\n\nimport secrets\nfrom datetime import datetime, timedelta\nfrom typing import Any\nimport uuid\n\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom pydantic import BaseModel\nfrom sqlalchemy import select\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom app.api.dependencies import get_current_user, get_db\nfrom app.infrastructure.database.models import SharedConversation, User\n\nrouter = APIRouter(prefix=\"/shared\", tags=[\"Shared Conversations\"])\n\n\n# Pydantic Models\nclass ShareConversationRequest(BaseModel):\n    \"\"\"Request to share a conversation\"\"\"\n    session_id: str\n    messages: list[dict]\n    title: str | None = None\n    expires_in_days: int | None = 30  # Default 30 days\n\n\nclass ShareConversationResponse(BaseModel):\n    \"\"\"Response with share URL\"\"\"\n    share_id: str\n    share_url: str\n    expires_at: datetime | None\n\n\nclass SharedConversationView(BaseModel):\n    \"\"\"Shared conversation data for viewing\"\"\"\n    share_id: str\n    title: str | None\n    messages: list[dict]\n    created_at: datetime\n    view_count: int\n\n\n@router.post(\"/share\", response_model=ShareConversationResponse)\nasync def share_conversation(\n    request: ShareConversationRequest,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    Share a conversation and get a public link.\n\n    Creates a shareable link for the conversation that can be accessed by anyone.\n    \"\"\"\n    # Generate unique share_id\n    share_id = secrets.token_urlsafe(16)\n\n    # Calculate expiration date\n    expires_at = None\n    if request.expires_in_days:\n        expires_at = datetime.utcnow() + timedelta(days=request.expires_in_days)\n\n    # Create shared conversation\n    shared_conv = SharedConversation(\n        share_id=share_id,\n        session_id=request.session_id,\n        user_id=current_user.id,\n        title=request.title,\n        messages_list=request.messages,\n        expires_at=expires_at,\n        is_active=True,\n        view_count=0\n    )\n\n    db.add(shared_conv)\n    await db.commit()\n    await db.refresh(shared_conv)\n\n    return ShareConversationResponse(\n        share_id=share_id,\n        share_url=f\"/shared/{share_id}\",\n        expires_at=expires_at\n    )\n\n\n@router.get(\"/{share_id}\", response_model=SharedConversationView)\nasync def view_shared_conversation(\n    share_id: str,\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    View a shared conversation by its share_id.\n\n    This endpoint is public and doesn't require authentication.\n    \"\"\"\n    # Query the shared conversation\n    result = await db.execute(\n        select(SharedConversation).where(SharedConversation.share_id == share_id)\n    )\n    shared_conv = result.scalar_one_or_none()\n\n    if not shared_conv:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Shared conversation not found\"\n        )\n\n    # Check if expired\n    if shared_conv.is_expired or not shared_conv.is_active:\n        raise HTTPException(\n            status_code=status.HTTP_410_GONE,\n            detail=\"This shared conversation has expired or is no longer available\"\n        )\n\n    # Increment view count\n    shared_conv.increment_view_count()\n    await db.commit()\n\n    return SharedConversationView(\n        share_id=shared_conv.share_id,\n        title=shared_conv.title,\n        messages=shared_conv.messages_list,\n        created_at=shared_conv.created_at,\n        view_count=shared_conv.view_count\n    )\n\n\n@router.delete(\"/{share_id}\")\nasync def delete_shared_conversation(\n    share_id: str,\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    Delete/deactivate a shared conversation.\n\n    Only the owner or admin can delete a shared conversation.\n    \"\"\"\n    # Query the shared conversation\n    result = await db.execute(\n        select(SharedConversation).where(SharedConversation.share_id == share_id)\n    )\n    shared_conv = result.scalar_one_or_none()\n\n    if not shared_conv:\n        raise HTTPException(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"Shared conversation not found\"\n        )\n\n    # Check ownership or admin\n    if shared_conv.user_id != current_user.id and current_user.role != \"admin\":\n        raise HTTPException(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"You don't have permission to delete this shared conversation\"\n        )\n\n    # Soft delete - just deactivate\n    shared_conv.is_active = False\n    await db.commit()\n\n    return {\"message\": \"Shared conversation deleted successfully\"}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4684, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f17949ff-8dc0-43a6-a5fd-be34a19c1986": {"__data__": {"id_": "f17949ff-8dc0-43a6-a5fd-be34a19c1986", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\shared.py", "language": "python", "lines": 196, "filename": "shared.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "c837571e-9916-40cf-a47b-c5a6832b4b0d", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\shared.py", "language": "python", "lines": 196, "filename": "shared.py"}, "hash": "854b9c07b86103aff11a05a3ddc474d7624b5e9b61898727d57478a20782f169", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "1317761a-85a1-4422-98a7-177ddcec1deb", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\shared.py", "language": "python", "lines": 196, "filename": "shared.py"}, "hash": "c67a462069387354f04705a1131eba061adeef3008c69fc30177180d13ab2b1f", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/user/list\")\nasync def list_user_shared_conversations(\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db)\n) -> Any:\n    \"\"\"\n    List all shared conversations created by the current user.\n    \"\"\"\n    result = await db.execute(\n        select(SharedConversation)\n        .where(SharedConversation.user_id == current_user.id)\n        .where(SharedConversation.is_active == True)\n        .order_by(SharedConversation.created_at.desc())\n    )\n    shared_convs = result.scalars().all()\n\n    return [\n        {\n            \"share_id\": conv.share_id,\n            \"title\": conv.title,\n            \"session_id\": conv.session_id,\n            \"created_at\": conv.created_at,\n            \"expires_at\": conv.expires_at,\n            \"view_count\": conv.view_count,\n            \"is_expired\": conv.is_expired\n        }\n        for conv in shared_convs\n    ]", "mimetype": "text/plain", "start_char_idx": 4687, "end_char_idx": 5578, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "eb77c6a5-bf54-4737-b5e1-fcaa0e7c80e4": {"__data__": {"id_": "eb77c6a5-bf54-4737-b5e1-fcaa0e7c80e4", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\test.py", "language": "python", "lines": 15, "filename": "test.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "72fb99a6-8254-4f90-ac5c-2d76702d3626", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\test.py", "language": "python", "lines": 15, "filename": "test.py"}, "hash": "be476494a5c5d1a53a8514f34bf7cfe57f7feb26e8bd07bbf738d47e16a71bfb", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"Endpoint de teste SEM banco para verificar se backend funciona\"\"\"\nfrom fastapi import APIRouter\n\ntest_router = APIRouter(prefix=\"/test\", tags=[\"Test\"])\n\n@test_router.get(\"/ping\")\nasync def ping():\n    \"\"\"Teste simples sem banco\"\"\"\n    return {\"status\": \"pong\", \"message\": \"Backend funcionando!\"}\n\n@test_router.post(\"/echo\")\nasync def echo(data: dict):\n    \"\"\"Echo dos dados recebidos\"\"\"\n    return {\"received\": data, \"status\": \"ok\"}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 435, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "42f48b85-8954-4feb-9189-4a8bfee0bffc": {"__data__": {"id_": "42f48b85-8954-4feb-9189-4a8bfee0bffc", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "f0e3a9fbccee84158375c5d037162bdf90b9b2ea41bd9548a6ac4ee7b161f258", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "34212621-39e3-4f0f-ade3-80a21c90d91d", "node_type": "1", "metadata": {}, "hash": "902f45a60c7fa39f8d4966b234c8de34853834d449a4640e69791b09ca287e8b", "class_name": "RelatedNodeInfo"}}, "text": "from typing import Annotated, List, Dict, Any, Optional\nfrom datetime import datetime\nimport json\nimport os\nfrom pathlib import Path\n\nfrom fastapi import APIRouter, Depends, HTTPException, status, Query\nfrom pydantic import BaseModel, Field\n\nfrom app.api.dependencies import get_current_active_user\nfrom app.infrastructure.database.models import User\nfrom app.core.tools.une_tools import (\n    validar_transferencia_produto,\n    sugerir_transferencias_automaticas,\n)\nfrom app.core.utils.error_handler import APIError\n\nrouter = APIRouter(prefix=\"/transfers\", tags=[\"Transfers\"])\n\n# Path to store transfer requests\nTRANSFER_REQUESTS_DIR = Path(\"data/transferencias\")\nos.makedirs(TRANSFER_REQUESTS_DIR, exist_ok=True)\n\n\nclass TransferRequestPayload(BaseModel):\n    produto_id: int\n    une_origem: int\n    une_destino: int\n    quantidade: int\n    solicitante_id: str # Will be populated by current_user\n\n\nclass TransferReportQuery(BaseModel):\n    start_date: Optional[str] = None\n    end_date: Optional[str] = None\n\n\nclass ProductSearchRequest(BaseModel):\n    segmento: Optional[str] = None\n    fabricante: Optional[str] = None\n    estoque_min: Optional[int] = None\n    limit: int = Field(default=50, le=500)\n\n\nclass BulkTransferRequestPayload(BaseModel):\n    \"\"\"Payload para transfer\u00eancias m\u00faltiplas (1\u2192N ou N\u2192N)\"\"\"\n    items: List[TransferRequestPayload]\n    modo: str = Field(description=\"Modo: '1\u21921', '1\u2192N', ou 'N\u2192N'\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1418, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "34212621-39e3-4f0f-ade3-80a21c90d91d": {"__data__": {"id_": "34212621-39e3-4f0f-ade3-80a21c90d91d", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "f0e3a9fbccee84158375c5d037162bdf90b9b2ea41bd9548a6ac4ee7b161f258", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "42f48b85-8954-4feb-9189-4a8bfee0bffc", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "57983fd73e7d5546bd42bbdf7c2824240186cff03d22d81017693a0f8dc7eda2", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "bad13939-b66b-41a4-b23c-be9e111d63aa", "node_type": "1", "metadata": {}, "hash": "915d0e49c0fc8914d3a57f68f36ff5fbe6f1e7da36adc4cdb1446942eaec8b3d", "class_name": "RelatedNodeInfo"}}, "text": "class TransferRequestPayload(BaseModel):\n    produto_id: int\n    une_origem: int\n    une_destino: int\n    quantidade: int\n    solicitante_id: str # Will be populated by current_user\n\n\nclass TransferReportQuery(BaseModel):\n    start_date: Optional[str] = None\n    end_date: Optional[str] = None\n\n\nclass ProductSearchRequest(BaseModel):\n    segmento: Optional[str] = None\n    fabricante: Optional[str] = None\n    estoque_min: Optional[int] = None\n    limit: int = Field(default=50, le=500)\n\n\nclass BulkTransferRequestPayload(BaseModel):\n    \"\"\"Payload para transfer\u00eancias m\u00faltiplas (1\u2192N ou N\u2192N)\"\"\"\n    items: List[TransferRequestPayload]\n    modo: str = Field(description=\"Modo: '1\u21921', '1\u2192N', ou 'N\u2192N'\")\n\n\n@router.post(\"/validate\")\nasync def validate_transfer(\n    payload: TransferRequestPayload,\n    current_user: Annotated[User, Depends(get_current_active_user)],\n) -> Dict[str, Any]:\n    \"\"\"\n    Endpoint to validate a product transfer between UNEs.\n    Integrates with `validar_transferencia_produto` tool.\n    Includes priority score (0-100) and urgency level.\n    \"\"\"\n    import polars as pl\n    from app.core.data_scope_service import data_scope_service\n\n    try:\n        # Valida\u00e7\u00e3o b\u00e1sica usando a tool existente\n        result = validar_transferencia_produto.invoke({\n            \"produto_id\": payload.produto_id,\n            \"une_origem\": payload.une_origem,\n            \"une_destino\": payload.une_destino,\n            \"quantidade\": payload.quantidade,\n        })\n\n        # Calcular score de prioridade baseado em criticidade\n        score_prioridade = 50  # Default\n        nivel_urgencia = \"NORMAL\"\n\n        try:\n            df = data_scope_service.get_filtered_dataframe(current_user)\n\n            # Buscar dados do produto na UNE destino\n            df_produto = df.filter(\n                (pl.col(\"PRODUTO\") == payload.produto_id) &\n                (pl.col(\"UNE\") == payload.une_destino)\n            )\n\n            if len(df_produto) > 0:\n                row = df_produto.row(0, named=True)\n\n                estoque_loja = float(row.get(\"ESTOQUE_UNE\", 0) or 0)\n                estoque_cd = float(row.get(\"ESTOQUE_CD\", 0) or 0)\n                linha_verde = float(row.get(\"ESTOQUE_LV\", 0) or 0)\n                venda_30dd = float(row.get(\"VENDA_30DD\", 0) or 0)\n\n                # Calcular score (0-100)\n                # Fatores: ruptura, vendas, rela\u00e7\u00e3o estoque/linha verde\n                score = 0\n\n                # +40 pontos se CD zerado\n                if estoque_cd == 0:\n                    score += 40\n\n                # +30 pontos se estoque loja < linha verde\n                if estoque_loja < linha_verde:\n                    score += 30\n\n                # +20 pontos baseado em vendas (normalizado)\n                if venda_30dd > 0:\n                    score += min(20, int(venda_30dd / 10))\n\n                # +10 pontos se estoque cr\u00edtico (< 50% da LV)\n                if linha_verde > 0 and estoque_loja < (linha_verde * 0.5):\n                    score += 10\n\n                score_prioridade = min(100, score)\n\n                # Determinar n\u00edvel de urg\u00eancia\n                if score_prioridade >= 80:\n                    nivel_urgencia = \"URGENTE\"\n                elif score_prioridade >= 60:\n                    nivel_urgencia = \"ALTA\"\n                elif score_prioridade >= 40:\n                    nivel_urgencia = \"M\u00c9DIA\"\n                else:\n                    nivel_urgencia = \"BAIXA\"\n\n        except Exception as e:\n            print(f\"Erro ao calcular score: {e}\")\n\n        # Adicionar score ao resultado\n        result[\"score_prioridade\"] = score_prioridade\n        result[\"nivel_urgencia\"] = nivel_urgencia\n\n        return result\n\n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error validating transfer: {str(e)}\",\n        )", "mimetype": "text/plain", "start_char_idx": 717, "end_char_idx": 4582, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "bad13939-b66b-41a4-b23c-be9e111d63aa": {"__data__": {"id_": "bad13939-b66b-41a4-b23c-be9e111d63aa", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "f0e3a9fbccee84158375c5d037162bdf90b9b2ea41bd9548a6ac4ee7b161f258", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "34212621-39e3-4f0f-ade3-80a21c90d91d", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "51c045131a487632dcd776f0d70fdbcc97853f427bff0d2e0ce436445a3c1153", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "57558293-7012-4cd5-9821-426c725f239c", "node_type": "1", "metadata": {}, "hash": "e8cb8cbeb6d5ff931967d406eb3200e84f86dba161cf400f841c80c4fa91d65f", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/suggestions\")\nasync def get_transfer_suggestions(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    segmento: Optional[str] = Query(None),\n    une_origem_excluir: Optional[int] = Query(None),\n    limit: int = Query(5),\n) -> List[Dict[str, Any]]:\n    \"\"\"\n    Endpoint to get automatic transfer suggestions.\n    Integrates with `sugerir_transferencias_automaticas` tool.\n    \"\"\"\n    try:\n        suggestions = sugerir_transferencias_automaticas(\n            segmento=segmento, une_origem_excluir=une_origem_excluir, limite=limit\n        )\n        return suggestions\n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error getting transfer suggestions: {str(e)}\",\n        )\n\n\n@router.post(\"\")\nasync def create_transfer_request(\n    payload: TransferRequestPayload,\n    current_user: Annotated[User, Depends(get_current_active_user)],\n) -> Dict[str, Any]:\n    \"\"\"\n    Endpoint to create and save a transfer request.\n    \"\"\"\n    try:\n        transfer_data = payload.model_dump()\n        transfer_data[\"solicitante_id\"] = current_user.username\n        transfer_data[\"timestamp\"] = datetime.now().isoformat()\n        transfer_id = f\"transfer_{datetime.now().strftime('%Y%m%d%H%M%S%f')}\"\n        \n        file_path = TRANSFER_REQUESTS_DIR / f\"{transfer_id}.json\"\n        with open(file_path, \"w\", encoding=\"utf-8\") as f:\n            json.dump(transfer_data, f, ensure_ascii=False, indent=4)\n\n        return {\"message\": \"Transfer request created successfully\", \"transfer_id\": transfer_id}\n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error creating transfer request: {str(e)}\",\n        )\n\n\n@router.get(\"/report\")\nasync def get_transfers_report(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    query: TransferReportQuery = Depends(),\n) -> List[Dict[str, Any]]:\n    \"\"\"\n    Endpoint to generate a report of transfer requests.\n    Reads JSON files from the `data/transferencias/` directory.\n    \"\"\"\n    all_transfers = []\n    start_date = datetime.fromisoformat(query.start_date) if query.start_date else datetime.min\n    end_date = datetime.fromisoformat(query.end_date) if query.end_date else datetime.max\n\n    for filename in os.listdir(TRANSFER_REQUESTS_DIR):\n        if filename.endswith(\".json\"):\n            file_path = TRANSFER_REQUESTS_DIR / filename\n            try:\n                with open(file_path, \"r\", encoding=\"utf-8\") as f:\n                    transfer_data = json.load(f)\n                    transfer_timestamp = datetime.fromisoformat(transfer_data.get(\"timestamp\"))\n                    if start_date <= transfer_timestamp <= end_date:\n                        all_transfers.append(transfer_data)\n            except (json.JSONDecodeError, OSError) as e:\n                print(f\"Error reading or decoding transfer file {file_path}: {e}\")\n                # Optionally, raise HTTPException if corrupt file is critical\n\n    # Basic aggregation or sorting could be done here if needed\n    all_transfers.sort(key=lambda x: x.get(\"timestamp\"), reverse=True)\n\n    return all_transfers", "mimetype": "text/plain", "start_char_idx": 4585, "end_char_idx": 7816, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "57558293-7012-4cd5-9821-426c725f239c": {"__data__": {"id_": "57558293-7012-4cd5-9821-426c725f239c", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "f0e3a9fbccee84158375c5d037162bdf90b9b2ea41bd9548a6ac4ee7b161f258", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "bad13939-b66b-41a4-b23c-be9e111d63aa", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "6378eb2c49032aacffcc46e3be2853472db9a9a70b7bdd8247b2d9a35e966236", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "722b9ab4-79da-44a4-aeab-10320524d0dc", "node_type": "1", "metadata": {}, "hash": "675fbe5d03919386f6b3fc5439fef205d17c95d9fa080f6d433258d0262888a2", "class_name": "RelatedNodeInfo"}}, "text": "@router.get(\"/filters\")\nasync def get_transfer_filters(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n    segmento: Optional[str] = Query(None),\n) -> Dict[str, Any]:\n    \"\"\"\n    Endpoint to get available filter options for transfers.\n    Returns unique values for segmento and fabricante.\n    If 'segmento' is provided, filters 'fabricantes' accordingly.\n    \"\"\"\n    import polars as pl\n    from app.core.data_scope_service import data_scope_service\n\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        # Determinar nomes corretos das colunas\n        segmento_col = \"NOMESEGMENTO\" if \"NOMESEGMENTO\" in df.columns else None\n        fabricante_col = \"NOMEFABRICANTE\" if \"NOMEFABRICANTE\" in df.columns else None\n\n        # Obter valores \u00fanicos de segmentos (independentemente do filtro)\n        segmentos = []\n        if segmento_col:\n            segmentos = df.select(pl.col(segmento_col)).unique().drop_nulls().sort(segmento_col).to_series().to_list()\n            segmentos = [str(s) for s in segmentos if s and str(s).strip()]\n\n        # Filtrar DF se segmento for fornecido\n        if segmento and segmento_col:\n            # Usar contains para flexibilidade ou == para exato. Backend original usava contains.\n            # Vamos usar exato se poss\u00edvel para filtros de combo, ou contains se o frontend mandar parcial.\n            # O frontend manda o valor do option, ent\u00e3o deve ser exato.\n            # Mas como o searchProducts usa contains, vou usar == para ser preciso na lista dependente.\n            df = df.filter(pl.col(segmento_col) == segmento)\n\n        # Obter fabricantes (filtrados ou n\u00e3o)\n        fabricantes = []\n        if fabricante_col:\n            fabricantes = df.select(pl.col(fabricante_col)).unique().drop_nulls().sort(fabricante_col).to_series().to_list()\n            fabricantes = [str(f) for f in fabricantes if f and str(f).strip()]\n\n        return {\n            \"segmentos\": segmentos[:100],  # Limitar a 100 para performance\n            \"fabricantes\": fabricantes[:100]\n        }\n\n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error getting filters: {str(e)}\",\n        )", "mimetype": "text/plain", "start_char_idx": 7819, "end_char_idx": 10071, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "722b9ab4-79da-44a4-aeab-10320524d0dc": {"__data__": {"id_": "722b9ab4-79da-44a4-aeab-10320524d0dc", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "f0e3a9fbccee84158375c5d037162bdf90b9b2ea41bd9548a6ac4ee7b161f258", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "57558293-7012-4cd5-9821-426c725f239c", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "fb8dd40fb29ef4ae8e6acca94727bfa4c2731e3a5ba1a4ea44eaa999cee1247d", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "88109f45-e2b0-4f63-a34d-6ed6caf26347", "node_type": "1", "metadata": {}, "hash": "a8ddcf3d1698b20b90b825c4bd38402a70a750af5a66b96ec4b3d701458855dd", "class_name": "RelatedNodeInfo"}}, "text": "@router.post(\"/products/search\")\nasync def search_products(\n    request: ProductSearchRequest,\n    current_user: Annotated[User, Depends(get_current_active_user)],\n) -> List[Dict[str, Any]]:\n    \"\"\"\n    Endpoint to search products with filters for transfer management.\n    Returns products matching criteria with stock information.\n    \"\"\"\n    import polars as pl\n    from app.core.data_scope_service import data_scope_service\n\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        # Determinar nomes corretos das colunas\n        segmento_col = \"NOMESEGMENTO\" if \"NOMESEGMENTO\" in df.columns else None\n        fabricante_col = \"NOMEFABRICANTE\" if \"NOMEFABRICANTE\" in df.columns else None\n\n        # Aplicar filtros\n        if request.segmento and segmento_col:\n            df = df.filter(pl.col(segmento_col).str.contains(request.segmento, literal=False))\n\n        if request.fabricante and fabricante_col:\n            df = df.filter(pl.col(fabricante_col).str.contains(request.fabricante, literal=False))\n\n        if request.estoque_min is not None:\n            df = df.filter(pl.col(\"ESTOQUE_UNE\").cast(pl.Float64, strict=False).fill_null(0) >= request.estoque_min)\n\n        # Preparar colunas para agrupamento\n        group_cols = [\"PRODUTO\", \"NOME\"]\n        if segmento_col:\n            group_cols.append(segmento_col)\n        if fabricante_col:\n            group_cols.append(fabricante_col)\n\n        # Agrupar por produto e agregar informa\u00e7\u00f5es\n        df_grouped = df.group_by(group_cols).agg([\n            pl.col(\"ESTOQUE_UNE\").cast(pl.Float64, strict=False).fill_null(0).sum().alias(\"estoque_total_loja\"),\n            pl.col(\"ESTOQUE_CD\").cast(pl.Float64, strict=False).fill_null(0).sum().alias(\"estoque_total_cd\"),\n            pl.col(\"VENDA_30DD\").cast(pl.Float64, strict=False).fill_null(0).sum().alias(\"vendas_30dd\"),\n            pl.col(\"UNE\").n_unique().alias(\"unes_com_estoque\")\n        ])\n\n        df_result = df_grouped.head(request.limit)\n\n        products = []\n        for row in df_result.iter_rows(named=True):\n            products.append({\n                \"produto_id\": int(row[\"PRODUTO\"]),\n                \"nome\": str(row[\"NOME\"])[:60],\n                \"segmento\": str(row.get(segmento_col, \"N/A\")) if segmento_col else \"N/A\",\n                \"fabricante\": str(row.get(fabricante_col, \"N/A\"))[:30] if fabricante_col else \"N/A\",\n                \"estoque_loja\": int(row[\"estoque_total_loja\"]),\n                \"estoque_cd\": int(row[\"estoque_total_cd\"]),\n                \"vendas_30dd\": int(row[\"vendas_30dd\"]),\n                \"unes\": int(row[\"unes_com_estoque\"])\n            })\n\n        return products\n\n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error searching products: {str(e)}\",\n        )", "mimetype": "text/plain", "start_char_idx": 10074, "end_char_idx": 12915, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "88109f45-e2b0-4f63-a34d-6ed6caf26347": {"__data__": {"id_": "88109f45-e2b0-4f63-a34d-6ed6caf26347", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d080b56a-f7e8-4d10-b673-9ee7aa103a05", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "f0e3a9fbccee84158375c5d037162bdf90b9b2ea41bd9548a6ac4ee7b161f258", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "722b9ab4-79da-44a4-aeab-10320524d0dc", "node_type": "1", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}, "hash": "f0aa83709c64a2ced5614b2015ea6d1f6c66e3c775b018e76e1ad50c80c04c06", "class_name": "RelatedNodeInfo"}}, "text": "@router.post(\"/bulk\")\nasync def create_bulk_transfer_request(\n    payload: BulkTransferRequestPayload,\n    current_user: Annotated[User, Depends(get_current_active_user)],\n) -> Dict[str, Any]:\n    \"\"\"\n    Endpoint to create multiple transfer requests at once (1\u2192N or N\u2192N modes).\n    Saves all transfers in a single batch file.\n    \"\"\"\n    try:\n        batch_id = f\"batch_{datetime.now().strftime('%Y%m%d%H%M%S%f')}\"\n        batch_data = {\n            \"batch_id\": batch_id,\n            \"modo\": payload.modo,\n            \"solicitante_id\": current_user.username,\n            \"timestamp\": datetime.now().isoformat(),\n            \"total_transferencias\": len(payload.items),\n            \"transferencias\": []\n        }\n\n        for item in payload.items:\n            transfer = item.model_dump()\n            transfer[\"solicitante_id\"] = current_user.username\n            batch_data[\"transferencias\"].append(transfer)\n\n        file_path = TRANSFER_REQUESTS_DIR / f\"{batch_id}.json\"\n        with open(file_path, \"w\", encoding=\"utf-8\") as f:\n            json.dump(batch_data, f, ensure_ascii=False, indent=4)\n\n        return {\n            \"message\": f\"Batch transfer request created successfully ({len(payload.items)} items)\",\n            \"batch_id\": batch_id,\n            \"modo\": payload.modo\n        }\n\n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error creating bulk transfer request: {str(e)}\",\n        )\n\n\n@router.get(\"/unes\")\nasync def get_available_unes(\n    current_user: Annotated[User, Depends(get_current_active_user)],\n) -> List[Dict[str, Any]]:\n    \"\"\"\n    Endpoint to get list of available UNEs for transfer selection.\n    \"\"\"\n    import polars as pl\n    from app.core.data_scope_service import data_scope_service\n\n    try:\n        df = data_scope_service.get_filtered_dataframe(current_user)\n\n        # Obter UNEs \u00fanicas com contagem de produtos\n        unes_data = df.group_by(\"UNE\").agg([\n            pl.col(\"PRODUTO\").n_unique().alias(\"total_produtos\"),\n            pl.col(\"ESTOQUE_UNE\").cast(pl.Float64, strict=False).fill_null(0).sum().alias(\"estoque_total\")\n        ]).sort(\"UNE\")\n\n        unes = []\n        for row in unes_data.iter_rows(named=True):\n            unes.append({\n                \"une\": int(row[\"UNE\"]),\n                \"total_produtos\": int(row[\"total_produtos\"]),\n                \"estoque_total\": int(row[\"estoque_total\"])\n            })\n\n        return unes\n\n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=f\"Error fetching UNEs: {str(e)}\",\n        )", "mimetype": "text/plain", "start_char_idx": 12918, "end_char_idx": 15581, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5b9134af-6e70-4c3b-bb7c-3b85f7cc582e": {"__data__": {"id_": "5b9134af-6e70-4c3b-bb7c-3b85f7cc582e", "embedding": null, "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\__init__.py", "language": "python", "lines": 6, "filename": "__init__.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "21ef2447-58b3-4267-bab6-cba51b47d579", "node_type": "4", "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\__init__.py", "language": "python", "lines": 6, "filename": "__init__.py"}, "hash": "3c561980e0d43262506e717517987eb4bb0d1758b3c1ef43730e232cc9923cd3", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"Endpoints package\"\"\"\n\nfrom app.api.v1.endpoints import admin, analytics, auth, reports\n\n__all__ = [\"auth\", \"analytics\", \"reports\", \"admin\"]", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 142, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "42bae144-5f37-4d0a-8c47-4c8048783e3f": {"__data__": {"id_": "42bae144-5f37-4d0a-8c47-4c8048783e3f", "embedding": null, "metadata": {"file_path": "backend\\app\\config\\database.py", "language": "python", "lines": 84, "filename": "database.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "084d2857-7398-4172-8425-2506e020917f", "node_type": "4", "metadata": {"file_path": "backend\\app\\config\\database.py", "language": "python", "lines": 84, "filename": "database.py"}, "hash": "4a3aa1fe12fcbcac8fb998e4071c6dc7b3edaca15cad91766e27b927f1adf399", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nDatabase Configuration\nSQLAlchemy async engine and session\n\"\"\"\n\nfrom collections.abc import AsyncGenerator\nfrom contextlib import asynccontextmanager\n\nfrom sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine\nfrom sqlalchemy.orm import DeclarativeBase\n\nfrom app.config.settings import get_settings\n\nsettings = get_settings()\n\n# Create async engine with optimized pool settings\n# Use NullPool when SQL Server is disabled to avoid connection attempts\nfrom sqlalchemy.pool import NullPool\n\nif settings.USE_SQL_SERVER:\n    engine = create_async_engine(\n        str(settings.DATABASE_URL),\n        echo=settings.DB_ECHO,\n        pool_size=settings.DB_POOL_SIZE,\n        max_overflow=settings.DB_MAX_OVERFLOW,\n        pool_pre_ping=True,\n        pool_timeout=settings.SQL_SERVER_TIMEOUT,\n        connect_args={\"timeout\": settings.SQL_SERVER_TIMEOUT},\n    )\nelse:\n    # Use NullPool when SQL Server is disabled - no connection pooling, no connection attempts\n    engine = create_async_engine(\n        \"sqlite+aiosqlite:///:memory:\",  # Dummy in-memory DB when SQL disabled\n        poolclass=NullPool,\n        echo=False,\n    )\n\n# Create session factory\nAsyncSessionLocal = async_sessionmaker(\n    engine,\n    class_=AsyncSession,\n    expire_on_commit=False,\n    autocommit=False,\n    autoflush=False,\n)\n\n\nclass Base(DeclarativeBase):\n    \"\"\"Base class for all models\"\"\"\n\n    pass\n\n\nasync def get_db() -> AsyncGenerator[AsyncSession, None]:\n    \"\"\"\n    Dependency for getting async database session\n    \n    Usage:\n        @router.get(\"/items\")\n        async def get_items(db: AsyncSession = Depends(get_db)):\n            ...\n    \"\"\"\n    async with AsyncSessionLocal() as session:\n        try:\n            yield session\n            await session.commit()\n        except Exception:\n            await session.rollback()\n            raise\n        finally:\n            await session.close()\n\n\n@asynccontextmanager\nasync def get_db_context():\n    \"\"\"Context manager for database session\"\"\"\n    async with AsyncSessionLocal() as session:\n        try:\n            yield session\n            await session.commit()\n        except Exception:\n            await session.rollback()\n            raise", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2213, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "93ce8a20-cb88-48c8-9c32-d44d1961ecfd": {"__data__": {"id_": "93ce8a20-cb88-48c8-9c32-d44d1961ecfd", "embedding": null, "metadata": {"file_path": "backend\\app\\config\\logging_config.py", "language": "python", "lines": 87, "filename": "logging_config.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "edce654c-e12f-4d0c-bcc7-59aab2d88ea2", "node_type": "4", "metadata": {"file_path": "backend\\app\\config\\logging_config.py", "language": "python", "lines": 87, "filename": "logging_config.py"}, "hash": "d9e08879154de8fadc60f9f3b262f8c74c8e25706fec9d7b31ef33326e9b7180", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nLogging Configuration for Agent Solution BI\nCentralizes logging setup with rotation and formatting\n\"\"\"\n\nimport logging\nimport sys\nfrom pathlib import Path\nfrom logging.handlers import RotatingFileHandler\nfrom typing import Optional\n\n\ndef setup_logging(\n    log_level: str = \"INFO\",\n    log_file: Optional[Path] = None,\n    max_bytes: int = 10 * 1024 * 1024,  # 10 MB\n    backup_count: int = 5,\n    suppress_warnings: list[str] = None\n) -> logging.Logger:\n    \"\"\"\n    Configure application logging with rotation and consistent formatting\n    \n    Args:\n        log_level: Logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL)\n        log_file: Optional path to log file. If None, logs only to console\n        max_bytes: Maximum size of log file before rotation (default 10MB)\n        backup_count: Number of backup files to keep (default 5)\n        suppress_warnings: List of warning patterns to suppress\n    \n    Returns:\n        Configured logger instance\n    \"\"\"\n    \n    # Create logger\n    logger = logging.getLogger(\"agent_bi\")\n    logger.setLevel(getattr(logging, log_level.upper()))\n    \n    # Remove existing handlers to avoid duplicates\n    logger.handlers.clear()\n    \n    # Create formatter\n    formatter = logging.Formatter(\n        fmt='[%(asctime)s] %(levelname)-8s [%(name)s:%(funcName)s:%(lineno)d] %(message)s',\n        datefmt='%Y-%m-%d %H:%M:%S'\n    )\n    \n    # Console handler\n    console_handler = logging.StreamHandler(sys.stdout)\n    console_handler.setLevel(getattr(logging, log_level.upper()))\n    console_handler.setFormatter(formatter)\n    logger.addHandler(console_handler)\n    \n    # File handler with rotation (if log_file specified)\n    if log_file:\n        log_file.parent.mkdir(parents=True, exist_ok=True)\n        file_handler = RotatingFileHandler(\n            filename=log_file,\n            maxBytes=max_bytes,\n            backupCount=backup_count,\n            encoding='utf-8'\n        )\n        file_handler.setLevel(getattr(logging, log_level.upper()))\n        file_handler.setFormatter(formatter)\n        logger.addHandler(file_handler)\n    \n    # Suppress specific warnings if requested\n    if suppress_warnings:\n        for warning_pattern in suppress_warnings:\n            logging.getLogger(warning_pattern).setLevel(logging.ERROR)\n    \n    logger.info(f\"Logging configured: level={log_level}, file={log_file}\")\n    \n    return logger\n\n\ndef get_logger(name: str) -> logging.Logger:\n    \"\"\"\n    Get a logger instance with the application's configuration\n    \n    Args:\n        name: Logger name (typically __name__)\n    \n    Returns:\n        Logger instance\n    \"\"\"\n    return logging.getLogger(f\"agent_bi.{name}\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2660, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "48991ca9-cef0-4390-9e73-61914c996054": {"__data__": {"id_": "48991ca9-cef0-4390-9e73-61914c996054", "embedding": null, "metadata": {"file_path": "backend\\app\\config\\security.py", "language": "python", "lines": 82, "filename": "security.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "59eaab45-a46c-4d8a-b4ff-139c9d0e67b6", "node_type": "4", "metadata": {"file_path": "backend\\app\\config\\security.py", "language": "python", "lines": 82, "filename": "security.py"}, "hash": "8da19dfad15481323950ff83090c1d53a493c28eb3070716473a283e6f3389c6", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSecurity Configuration\nJWT, password hashing, and authentication utilities\n\"\"\"\n\nfrom datetime import datetime, timedelta, timezone\nfrom typing import Any\n\nfrom jose import JWTError, jwt\nfrom passlib.context import CryptContext\n\nfrom app.config.settings import get_settings\n\nsettings = get_settings()\n\n# Password hashing\npwd_context = CryptContext(schemes=[\"bcrypt\"], deprecated=\"auto\")\n\n\ndef verify_password(plain_password: str, hashed_password: str) -> bool:\n    \"\"\"Verify a password against a hash\"\"\"\n    return pwd_context.verify(plain_password, hashed_password)\n\n\ndef get_password_hash(password: str) -> str:\n    \"\"\"Hash a password\"\"\"\n    return pwd_context.hash(password)\n\n\ndef create_access_token(data: dict[str, Any], expires_delta: timedelta | None = None) -> str:\n    \"\"\"\n    Create JWT access token\n    \n    Args:\n        data: Data to encode in token\n        expires_delta: Token expiration time\n        \n    Returns:\n        Encoded JWT token\n    \"\"\"\n    to_encode = data.copy()\n    \n    if expires_delta:\n        expire = datetime.now(timezone.utc) + expires_delta\n    else:\n        expire = datetime.now(timezone.utc) + timedelta(\n            minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES\n        )\n    \n    to_encode.update({\"exp\": expire, \"type\": \"access\"})\n    encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)\n    return encoded_jwt\n\n\ndef create_refresh_token(data: dict[str, Any]) -> str:\n    \"\"\"Create JWT refresh token\"\"\"\n    to_encode = data.copy()\n    expire = datetime.now(timezone.utc) + timedelta(days=settings.REFRESH_TOKEN_EXPIRE_DAYS)\n    to_encode.update({\"exp\": expire, \"type\": \"refresh\"})\n    encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)\n    return encoded_jwt\n\n\ndef decode_token(token: str) -> dict[str, Any]:\n    \"\"\"\n    Decode and verify JWT token\n    \n    Args:\n        token: JWT token to decode\n        \n    Returns:\n        Decoded token payload\n        \n    Raises:\n        JWTError: If token is invalid\n    \"\"\"\n    try:\n        payload = jwt.decode(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])\n        return payload\n    except JWTError as e:\n        raise JWTError(f\"Could not validate credentials: {e}\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2244, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "4aa593d9-a568-4d1d-9e7d-e872d4f3dde4": {"__data__": {"id_": "4aa593d9-a568-4d1d-9e7d-e872d4f3dde4", "embedding": null, "metadata": {"file_path": "backend\\app\\config\\settings.py", "language": "python", "lines": 199, "filename": "settings.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0fd13993-78dc-4353-ae98-f0fb5771d168", "node_type": "4", "metadata": {"file_path": "backend\\app\\config\\settings.py", "language": "python", "lines": 199, "filename": "settings.py"}, "hash": "837b591821a71114fe9ae469e4348f3a196ecb96262be754220d7a10006576d0", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "d7ad1a6d-e33b-462e-ab0e-5da36caf341c", "node_type": "1", "metadata": {}, "hash": "5ad6bc28e5e29505ad357f0eb33160acb72e3473cf2b82db8f57c785e6f0e369", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSettings Configuration\nPydantic Settings with environment variables\n\"\"\"\n\nfrom functools import lru_cache\nfrom typing import Literal\nimport os\n\nfrom pydantic import Field, field_validator, model_validator, RedisDsn\nfrom pydantic_settings import BaseSettings, SettingsConfigDict\nfrom sqlalchemy.engine import make_url\n\n\nclass Settings(BaseSettings):\n    \"\"\"Application settings\"\"\"\n\n    # Calculate absolute path to .env file\n    # backend/app/config/settings.py -> backend/.env\n    _base_dir = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))\n    _env_path = os.path.join(_base_dir, \".env\")\n\n    model_config = SettingsConfigDict(\n        env_file=_env_path,\n        env_file_encoding=\"utf-8\",\n        case_sensitive=False,\n        extra=\"ignore\",\n    )\n\n    # App\n    APP_NAME: str = \"Agent BI Backend\"\n    APP_VERSION: str = \"1.0.0\"\n    DEBUG: bool = False\n    ENVIRONMENT: Literal[\"development\", \"staging\", \"production\"] = \"development\"\n\n    # API\n    API_V1_PREFIX: str = \"/api/v1\"\n    BACKEND_CORS_ORIGINS: str = Field(\n        default=\"http://localhost:3000,http://localhost:8000\"\n    )\n\n    # @field_validator(\"BACKEND_CORS_ORIGINS\", mode=\"before\")\n    # @classmethod\n    # def assemble_cors_origins(cls, v: str | list[str]) -> list[str]:\n    #     if isinstance(v, str):\n    #         return [i.strip() for i in v.split(\",\")]\n    #     return v\n\n    # Database - SQL Server\n    # Usando aioodbc para suporte ass\u00edncrono com SQLAlchemy\n    DATABASE_URL: str = Field(\n        default=\"\"\n    )\n    DB_ECHO: bool = False\n    DB_POOL_SIZE: int = 10\n    DB_MAX_OVERFLOW: int = 20\n    \n    # Connection string para aioodbc (SQLServerAdapter)\n    # Deve corresponder aos mesmos par\u00e2metros do DATABASE_URL\n    PYODBC_CONNECTION_STRING: str = Field(\n        default=\"\"\n    )\n    \n    # Hybrid Architecture Flags\n    USE_SQL_SERVER: bool = False  # Disabled by default to prevent timeouts\n    FALLBACK_TO_PARQUET: bool = True\n    SQL_SERVER_TIMEOUT: int = 2  # Reduced timeout\n\n    # Redis\n    REDIS_URL: RedisDsn = Field(default=\"redis://localhost:6379/0\")\n    REDIS_CACHE_TTL: int = 3600  # 1 hour\n\n    # Custom Cache Settings\n    CACHE_TTL_MINUTES: int = 360 # 6 hours for LLM responses\n    CACHE_MAX_AGE_DAYS: int = 7 # For cache cleaner\n    AGENT_GRAPH_CACHE_TTL_MINUTES: int = 360 # 6 hours for agent graph cache\n\n    # RAG (Retrieval Augmented Generation)\n    RAG_EMBEDDING_MODEL: str = \"all-MiniLM-L6-v2\"\n    RAG_FAISS_INDEX_PATH: str = \"data/rag/faiss_index.bin\"\n\n    # Learning System\n    LEARNING_FEEDBACK_PATH: str = \"data/feedback/\"\n    LEARNING_EXAMPLES_PATH: str = \"data/learning/\"\n    LEARNING_MAX_EXAMPLES: int = 1000\n\n    # Security\n    SECRET_KEY: str = Field(\n        default=\"your-secret-key-change-in-production-min-32-chars-long\"\n    )\n    ALGORITHM: str = \"HS256\"\n    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30\n    REFRESH_TOKEN_EXPIRE_DAYS: int = 7\n\n    # Rate Limiting\n    RATE_LIMIT_PER_MINUTE: int = 100\n    RATE_LIMIT_AUTH_PER_MINUTE: int = 5\n\n    # Logging\n    LOG_LEVEL: Literal[\"DEBUG\", \"INFO\", \"WARNING\", \"ERROR\", \"CRITICAL\"] = \"INFO\"\n    LOG_FORMAT: Literal[\"json\", \"console\"] = \"json\"\n\n    # Sentry\n    SENTRY_DSN: str | None = None\n    SENTRY_ENVIRONMENT: str = \"development\"\n    SENTRY_TRACES_SAMPLE_RATE: float = 0.1\n\n    # Prometheus\n    METRICS_ENABLED: bool = True\n\n    # AI / LLM - Usando Gemini 2.0 Flash Experimental (mais moderno e inteligente)\n    GEMINI_API_KEY: str | None = None\n    LLM_MODEL_NAME: str = \"gemini-2.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3485, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d7ad1a6d-e33b-462e-ab0e-5da36caf341c": {"__data__": {"id_": "d7ad1a6d-e33b-462e-ab0e-5da36caf341c", "embedding": null, "metadata": {"file_path": "backend\\app\\config\\settings.py", "language": "python", "lines": 199, "filename": "settings.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0fd13993-78dc-4353-ae98-f0fb5771d168", "node_type": "4", "metadata": {"file_path": "backend\\app\\config\\settings.py", "language": "python", "lines": 199, "filename": "settings.py"}, "hash": "837b591821a71114fe9ae469e4348f3a196ecb96262be754220d7a10006576d0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "4aa593d9-a568-4d1d-9e7d-e872d4f3dde4", "node_type": "1", "metadata": {"file_path": "backend\\app\\config\\settings.py", "language": "python", "lines": 199, "filename": "settings.py"}, "hash": "57dee472876db2a8d3be5dd91856cb56769f7a15a14f81ee63dcf9b85b1c5bc9", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "05ec67e9-4a1d-47ec-a457-aa3b38fb672d", "node_type": "1", "metadata": {}, "hash": "2c33550f7eb4791bd526e826cf5997a48a3d5a77f69dc0aa84b8e1890a6b7513", "class_name": "RelatedNodeInfo"}}, "text": "\"INFO\", \"WARNING\", \"ERROR\", \"CRITICAL\"] = \"INFO\"\n    LOG_FORMAT: Literal[\"json\", \"console\"] = \"json\"\n\n    # Sentry\n    SENTRY_DSN: str | None = None\n    SENTRY_ENVIRONMENT: str = \"development\"\n    SENTRY_TRACES_SAMPLE_RATE: float = 0.1\n\n    # Prometheus\n    METRICS_ENABLED: bool = True\n\n    # AI / LLM - Usando Gemini 2.0 Flash Experimental (mais moderno e inteligente)\n    GEMINI_API_KEY: str | None = None\n    LLM_MODEL_NAME: str = \"gemini-2.0-flash-exp\"\n    INTENT_CLASSIFICATION_MODEL: str = \"gemini-2.0-flash-exp\"\n    CODE_GENERATION_MODEL: str = \"gemini-2.0-flash-exp\"\n\n    # Data Sources\n    PARQUET_DATA_PATH: str = Field(default=\"data/parquet/admmat.parquet\")\n    PARQUET_FILE_PATH: str = Field(default=\"data/parquet/admmat.parquet\")  # Alias for compatibility\n    \n    # Business Rules\n    ALLOWED_UNES: list[int] = Field(default=[\n        1, 3, 11, 35, 57, 64, 79, 81, 135, 148, 265, 520, 1685, 1974, \n        2365, 2401, 2475, 2586, 2599, 2720, 2906, 2952, 3038, 3054, \n        3091, 3116, 3281, 3318, 3387, 3404, 3481, 3499, 3577, 3578, \n        5570, 5822\n    ])\n\n    # Supabase\n    SUPABASE_URL: str = Field(default=\"\")\n    SUPABASE_ANON_KEY: str = Field(default=\"\")\n    USE_SUPABASE_AUTH: bool = Field(default=False)  # Disabled by default to align with Parquet auth\n\n    @model_validator(mode=\"after\")\n    def validate_secret_key(self) -> \"Settings\":\n        if not self.SECRET_KEY or len(self.SECRET_KEY) < 32:\n            raise ValueError(\"SECRET_KEY must be at least 32 characters\")\n        return self\n\n    @model_validator(mode=\"after\")\n    def compute_pyodbc_string(self) -> \"Settings\":\n        # OTIMIZA\u00c7\u00c3O: Se DATABASE_URL vazio, desabilitar SQL Server (evita timeout de 10s no login!)\n        if not self.DATABASE_URL or self.DATABASE_URL.strip() == \"\":\n            self.USE_SQL_SERVER = False\n            self.FALLBACK_TO_PARQUET = True\n            return self\n\n        # For\u00e7a a verifica\u00e7\u00e3o da vari\u00e1vel de ambiente para USE_SQL_SERVER\n        if os.environ.get(\"USE_SQL_SERVER\", \"false\").lower() == \"true\":\n            self.USE_SQL_SERVER = True\n        # Se a URL for SQLite, e a vari\u00e1vel de ambiente n\u00e3o for true, desabilitar o uso do SQL Server\n        elif self.DATABASE_URL and self.DATABASE_URL.startswith(\"sqlite\"):\n            self.USE_SQL_SERVER = False\n            self.FALLBACK_TO_PARQUET = True\n            return self\n\n        # Se PYODBC_CONNECTION_STRING for o default, tentar derivar de DATABASE_URL\n        default_pyodbc = self.model_fields[\"PYODBC_CONNECTION_STRING\"].default\n        if self.PYODBC_CONNECTION_STRING == default_pyodbc and self.DATABASE_URL:\n            try:\n                url = make_url(str(self.DATABASE_URL))\n                # Construir string ODBC\n                # DRIVER={driver};SERVER=host;DATABASE=db;UID=user;PWD=pass\n                driver = url.query.get(\"driver\", \"ODBC Driver 17 for SQL Server\")\n                trust_cert = url.query.get(\"TrustServerCertificate\", \"yes\")\n                \n                # Tratar host e port\n                server = url.host\n                if url.port:\n                    server = f\"{server},{url.port}\"\n                \n                conn_str = (\n                    f\"DRIVER={{{driver}}};\"\n                    f\"SERVER={server};\"\n                    f\"DATABASE={url.database};\"\n                    f\"TrustServerCertificate={trust_cert};\"\n                )\n                \n                if url.username:\n                    conn_str += f\"UID={url.username};PWD={url.password};\"\n                else:\n                    conn_str += \"Trusted_Connection=yes;\"\n                    \n                self.PYODBC_CONNECTION_STRING = conn_str\n            except Exception:\n                # Se falhar, manter o default ou o que foi passado\n                pass\n        return self", "mimetype": "text/plain", "start_char_idx": 3040, "end_char_idx": 6836, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "05ec67e9-4a1d-47ec-a457-aa3b38fb672d": {"__data__": {"id_": "05ec67e9-4a1d-47ec-a457-aa3b38fb672d", "embedding": null, "metadata": {"file_path": "backend\\app\\config\\settings.py", "language": "python", "lines": 199, "filename": "settings.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0fd13993-78dc-4353-ae98-f0fb5771d168", "node_type": "4", "metadata": {"file_path": "backend\\app\\config\\settings.py", "language": "python", "lines": 199, "filename": "settings.py"}, "hash": "837b591821a71114fe9ae469e4348f3a196ecb96262be754220d7a10006576d0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "d7ad1a6d-e33b-462e-ab0e-5da36caf341c", "node_type": "1", "metadata": {"file_path": "backend\\app\\config\\settings.py", "language": "python", "lines": 199, "filename": "settings.py"}, "hash": "c6b08e20eb122c23668dff1596b4a5d58d68369393ccd5382bcd5e42b5d731b8", "class_name": "RelatedNodeInfo"}}, "text": "@lru_cache\ndef get_settings() -> Settings:\n    \"\"\"Get cached settings instance\"\"\"\n    return Settings()\n\n\n# Global settings instance\nsettings = get_settings()", "mimetype": "text/plain", "start_char_idx": 6839, "end_char_idx": 6997, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f4387d1e-a498-4bd7-af9f-a3a9da8ce936": {"__data__": {"id_": "f4387d1e-a498-4bd7-af9f-a3a9da8ce936", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agent_state.py", "language": "python", "lines": 35, "filename": "agent_state.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "75d843d1-6d07-4f24-a0ee-153f1af4f10b", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agent_state.py", "language": "python", "lines": 35, "filename": "agent_state.py"}, "hash": "6f5d46d1bd0ba1480ae7e89a67eba5b28fdbd52186fa306a198bf8eeae35f89e", "class_name": "RelatedNodeInfo"}}, "text": "from __future__ import annotations\n\nimport operator\nfrom typing import (\n    TYPE_CHECKING,\n    Annotated,\n    Any,\n    Dict,\n    List,\n    Optional,\n    Sequence,\n    TypedDict,\n)\n\nfrom langchain_core.messages import BaseMessage\nfrom plotly.graph_objects import Figure as PlotlyFigure\n\n\n# RouteDecision ser\u00e1 definido como string para evitar import circular\n# from app.core.agents.supervisor import RouteDecision\n\n# O bloco TYPE_CHECKING anterior para RouteDecision n\u00e3o \u00e9 mais estritamente necess\u00e1rio\n# para esta anota\u00e7\u00e3o espec\u00edfica, pois RouteDecision \u00e9 importado diretamente.\n# Mantendo o bloco TYPE_CHECKING caso seja usado para outras importa\u00e7\u00f5es condicionais.\nif TYPE_CHECKING:\n    pass  # Pode ser usado para outras importa\u00e7\u00f5es apenas de checagem de tipo\n\n\nclass AgentState(TypedDict):\n    messages: Annotated[Sequence[BaseMessage], operator.add]\n    retrieved_data: Optional[List[Dict[str, Any]]]\n    chart_code: Optional[str]\n    plotly_fig: Optional[PlotlyFigure]\n    route_decision: Optional[\"RouteDecision\"]  # Usar string para anota\u00e7\u00e3o de tipo", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1055, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "94f03584-1f19-4277-a1b5-672c0747ca84": {"__data__": {"id_": "94f03584-1f19-4277-a1b5-672c0747ca84", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agent_wrapper.py", "language": "python", "lines": 75, "filename": "agent_wrapper.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9699f80e-72da-4d28-bd0e-7db183ca235e", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agent_wrapper.py", "language": "python", "lines": 75, "filename": "agent_wrapper.py"}, "hash": "3d17bb16ddc040a74d9e5e8a9e7e58653c137e91a289db8014f76b586da00882", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nWrapper simplificado para integra\u00e7\u00e3o do sistema de agentes com FastAPI\n\"\"\"\nimport logging\nimport os\nfrom pathlib import Path\n\nlogger = logging.getLogger(__name__)\n\n\nclass AgentWrapper:\n    \"\"\"\n    Wrapper para integrar o sistema de agentes do Agent_Business com FastAPI\n    \"\"\"\n    \n    def __init__(self):\n        self.query_processor = None\n        self._initialize()\n    \n    def _initialize(self):\n        \"\"\"Inicializa o sistema de agentes\"\"\"\n        try:\n            # Configurar GEMINI_API_KEY se n\u00e3o estiver configurada\n            if not os.getenv(\"GEMINI_API_KEY\"):\n                logger.warning(\"GEMINI_API_KEY n\u00e3o configurada, usando fallback\")\n                return\n            \n            # Importar QueryProcessor\n            from app.core.query_processor import QueryProcessor\n            \n            self.query_processor = QueryProcessor()\n            logger.info(\"Sistema de agentes inicializado com sucesso\")\n            \n        except Exception as e:\n            logger.error(f\"Erro ao inicializar sistema de agentes: {e}\")\n            self.query_processor = None\n    \n    def process_query(self, query: str) -> dict:\n        \"\"\"\n        Processa uma consulta usando o sistema de agentes\n        \n        Args:\n            query: Pergunta do usu\u00e1rio\n            \n        Returns:\n            dict com type e output\n        \"\"\"\n        if self.query_processor is None:\n            return {\n                \"type\": \"text\",\n                \"output\": \"Sistema de agentes n\u00e3o dispon\u00edvel. Verifique a configura\u00e7\u00e3o do GEMINI_API_KEY.\"\n            }\n        \n        try:\n            result = self.query_processor.process_query(query)\n            return result\n        except Exception as e:\n            logger.error(f\"Erro ao processar consulta: {e}\")\n            return {\n                \"type\": \"text\",\n                \"output\": f\"Erro ao processar consulta: {str(e)}\"\n            }\n\n\n# Inst\u00e2ncia global do wrapper\n_agent_wrapper = None\n\n\ndef get_agent_wrapper() -> AgentWrapper:\n    \"\"\"Retorna inst\u00e2ncia singleton do AgentWrapper\"\"\"\n    global _agent_wrapper\n    if _agent_wrapper is None:\n        _agent_wrapper = AgentWrapper()\n    return _agent_wrapper", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2180, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2947d14b-4d6d-45e6-bae6-b23b37acb71c": {"__data__": {"id_": "2947d14b-4d6d-45e6-bae6-b23b37acb71c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\auth_service.py", "language": "python", "lines": 287, "filename": "auth_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "71e2a82f-ad00-4dbc-b526-5e625a8cda43", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\auth_service.py", "language": "python", "lines": 287, "filename": "auth_service.py"}, "hash": "1a69b8717b3adedbc99e8f8571eee4af71edb6980829d4d70f6877b2c59faa39", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "92de65ea-3b96-49e8-baac-12ca5dd8b114", "node_type": "1", "metadata": {}, "hash": "46aa5946a5c4dfd406a7df33ec4f45d7d1e282c10cc152fa7712d3179ac1468a", "class_name": "RelatedNodeInfo"}}, "text": "import logging\nfrom pathlib import Path\nfrom typing import Optional\nfrom datetime import datetime, timezone\nimport json # Import json\n\nimport polars as pl\nimport bcrypt\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select\n\nfrom app.config.settings import get_settings\nfrom app.infrastructure.database.models import User\n\nsettings = get_settings()\nlogger = logging.getLogger(__name__) # General logger\nsecurity_logger = logging.getLogger(\"security\") # Dedicated security logger\n\n\nclass AuthService:\n    \"\"\"\n    Authentication service with intelligent fallback.\n\n    Priority:\n    1. SQL Server (if USE_SQL_SERVER=true and available)\n    2. Parquet (fallback or when SQL Server disabled)\n    \"\"\"\n\n    def __init__(self):\n        self.use_sql_server = settings.USE_SQL_SERVER\n        self.use_supabase = settings.USE_SUPABASE_AUTH\n\n        # Try Docker path first, then development path\n        docker_path = Path(\"/app/data/parquet/users.parquet\")\n        dev_path = Path(__file__).parent.parent.parent.parent / \"data\" / \"parquet\" / \"users.parquet\"\n\n        if docker_path.exists():\n            self.parquet_path = docker_path\n        else:\n            self.parquet_path = dev_path\n\n    async def authenticate_user(\n        self,\n        username: str,\n        password: str,\n        db: Optional[AsyncSession] = None\n    ) -> Optional[dict]:\n        \"\"\"\n        Authenticate user with hybrid approach.\n\n        Priority:\n        1. Supabase (if USE_SUPABASE_AUTH=true)\n        2. Parquet (fallback or when Supabase disabled)\n        3. SQL Server (last resort)\n\n        Args:\n            username: User's username or email\n            password: User's plain text password\n            db: Optional database session (used when SQL Server is enabled)\n\n        Returns:\n            User dict if authenticated, None otherwise\n        \"\"\"\n        user_data = None\n\n        # Priority 1: Supabase Auth (if enabled)\n        if self.use_supabase:\n            try:\n                user_data = await self._auth_from_supabase(username, password)\n                if user_data:\n                    security_logger.info(f\"User '{username}' authenticated via Supabase\")\n                    return user_data\n            except Exception as e:\n                security_logger.warning(f\"Supabase auth failed for '{username}': {e}\")\n\n        # Priority 2: Parquet (fallback or primary if Supabase disabled)\n        try:\n            user_data = await self._auth_from_parquet(username, password)\n            if user_data:\n                security_logger.info(f\"User '{username}' authenticated via Parquet\")\n                return user_data\n        except Exception as e:\n            security_logger.error(f\"Parquet auth failed for '{username}': {e}\")\n\n        # Priority 3: SQL Server (last resort)\n        if self.use_sql_server and db is not None:\n            try:\n                user_data = await self._auth_from_sql(username, password, db)\n                if user_data:\n                    security_logger.info(f\"User '{username}' authenticated via SQL Server\")\n                    return user_data\n            except Exception as e:\n                security_logger.warning(f\"SQL Server auth failed for '{username}': {e}\")\n\n        security_logger.warning(f\"Authentication failed for user '{username}' - Invalid credentials or inactive.\")\n        return None\n\n    async def _auth_from_sql(\n        self,\n        username: str,\n        password: str,\n        db: AsyncSession\n    ) -> Optional[dict]:\n        \"\"\"Authenticate from SQL Server\"\"\"\n        result = await db.execute(\n            select(User).where(User.username == username)\n        )\n        user = result.scalar_one_or_none()\n\n        if not user:\n            security_logger.warning(f\"User '{username}' not found in SQL Server.\")\n            return None\n\n        # Verify password\n        if not self._verify_password(password, user.hashed_password):\n            security_logger.warning(f\"Invalid password attempt for user '{username}' in SQL Server.\")\n            return None\n\n        # Check if active\n        if not user.is_active:\n            security_logger.warning(f\"Inactive user '{username}' attempted to log in via SQL Server.\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4208, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "92de65ea-3b96-49e8-baac-12ca5dd8b114": {"__data__": {"id_": "92de65ea-3b96-49e8-baac-12ca5dd8b114", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\auth_service.py", "language": "python", "lines": 287, "filename": "auth_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "71e2a82f-ad00-4dbc-b526-5e625a8cda43", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\auth_service.py", "language": "python", "lines": 287, "filename": "auth_service.py"}, "hash": "1a69b8717b3adedbc99e8f8571eee4af71edb6980829d4d70f6877b2c59faa39", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2947d14b-4d6d-45e6-bae6-b23b37acb71c", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\auth_service.py", "language": "python", "lines": 287, "filename": "auth_service.py"}, "hash": "bae2c9cc3e9b1d69b9a299aeeca6faa48e42dd6d4b84c7e35da516e2f826bb23", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "264c50e3-8a9c-40d6-9cc7-8f3371b892c4", "node_type": "1", "metadata": {}, "hash": "09b660e84d56173066ff87d68b63d81b9bd96e0b5e619b0c37f5a83d67b829d0", "class_name": "RelatedNodeInfo"}}, "text": "return None\n\n    async def _auth_from_sql(\n        self,\n        username: str,\n        password: str,\n        db: AsyncSession\n    ) -> Optional[dict]:\n        \"\"\"Authenticate from SQL Server\"\"\"\n        result = await db.execute(\n            select(User).where(User.username == username)\n        )\n        user = result.scalar_one_or_none()\n\n        if not user:\n            security_logger.warning(f\"User '{username}' not found in SQL Server.\")\n            return None\n\n        # Verify password\n        if not self._verify_password(password, user.hashed_password):\n            security_logger.warning(f\"Invalid password attempt for user '{username}' in SQL Server.\")\n            return None\n\n        # Check if active\n        if not user.is_active:\n            security_logger.warning(f\"Inactive user '{username}' attempted to log in via SQL Server.\")\n            return None\n\n        # Update last_login\n        user.last_login = datetime.now(timezone.utc)\n        await db.commit()\n\n        # Parse allowed_segments\n        allowed_segments = []\n        if user.allowed_segments:\n            try:\n                allowed_segments = json.loads(user.allowed_segments)\n            except:\n                allowed_segments = []\n\n        return {\n            \"id\": str(user.id),\n            \"username\": user.username,\n            \"email\": user.email or \"\",\n            \"role\": user.role,\n            \"is_active\": user.is_active,\n            \"allowed_segments\": allowed_segments\n        }\n\n    async def _auth_from_supabase(\n        self,\n        username: str,\n        password: str\n    ) -> Optional[dict]:\n        \"\"\"Authenticate from Supabase Auth\"\"\"\n        try:\n            from app.core.supabase_client import get_supabase_client\n            from supabase import AuthApiError\n\n            try:\n                supabase = get_supabase_client()\n            except ValueError as ve:\n                security_logger.error(f\"Supabase client not configured: {ve}\")\n                return None\n\n            # Supabase usa email para login, ent\u00e3o tentamos com username como email\n            # Se username n\u00e3o for email, tentamos adicionar @agentbi.com\n            email = username if \"@\" in username else f\"{username}@agentbi.com\"\n\n            # Tentar autenticar com Supabase - Python usa estrutura diferente\n            try:\n                response = supabase.auth.sign_in_with_password({\n                    \"email\": email,\n                    \"password\": password\n                })\n            except AuthApiError as auth_err:\n                security_logger.warning(f\"Supabase auth failed for '{email}': {auth_err}\")\n                return None\n\n            # Na biblioteca Python, response tem session e user\n            if not response or not response.session or not response.session.user:\n                security_logger.warning(f\"Supabase auth failed: no user/session returned for '{email}'\")\n                return None\n\n            user = response.session.user\n\n            # Buscar metadados adicionais (role) se existir tabela user_profiles\n            role = \"user\"  # Default\n            try:\n                profile_response = supabase.table(\"user_profiles\").select(\"*\").eq(\"id\", str(user.id)).execute()\n                if profile_response.data and len(profile_response.data) > 0:\n                    role = profile_response.data[0].get(\"role\", \"user\")\n            except Exception as e:\n                logger.warning(f\"Could not fetch user profile from Supabase: {e}\")\n\n            # Get allowed_segments from user_metadata\n            user_metadata = user.user_metadata or {}\n            allowed_segments = user_metadata.get(\"allowed_segments\", [])\n\n            return {\n                \"id\": str(user.id),\n                \"username\": email.split(\"@\")[0],  # Extrair username do email\n                \"email\": user.email or email,\n                \"role\": role,\n                \"is_active\": True,\n                \"allowed_segments\": allowed_segments\n            }\n\n        except Exception as e:\n            security_logger.error(f\"Supabase authentication error for '{username}': {e}\")\n            return None\n\n    async def _auth_from_parquet(\n        self,\n        username: str,\n        password: str\n    ) -> Optional[dict]:\n        \"\"\"Authenticate from Parquet file\"\"\"\n        # logger.info(f\"Password received length: {len(password)}\") # Removed sensitive logging\n        \n        if not self.parquet_path.exists():\n            security_logger.error(f\"Parquet file not found for authentication: {self.parquet_path}\")\n            return None\n\n        try:\n            # Read users from Parquet\n            df = pl.read_parquet(self.parquet_path)\n            # security_logger.info(f\"Parquet loaded.", "mimetype": "text/plain", "start_char_idx": 3354, "end_char_idx": 8076, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "264c50e3-8a9c-40d6-9cc7-8f3371b892c4": {"__data__": {"id_": "264c50e3-8a9c-40d6-9cc7-8f3371b892c4", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\auth_service.py", "language": "python", "lines": 287, "filename": "auth_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "71e2a82f-ad00-4dbc-b526-5e625a8cda43", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\auth_service.py", "language": "python", "lines": 287, "filename": "auth_service.py"}, "hash": "1a69b8717b3adedbc99e8f8571eee4af71edb6980829d4d70f6877b2c59faa39", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "92de65ea-3b96-49e8-baac-12ca5dd8b114", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\auth_service.py", "language": "python", "lines": 287, "filename": "auth_service.py"}, "hash": "7347e35f52d6555c4d5e83633132d66b657891f5c5ba23aba8e773956c6537c6", "class_name": "RelatedNodeInfo"}}, "text": "Users found: {len(df)}\") # Removed verbose logging\n\n            # Filter by username\n            user_data = df.filter(pl.col(\"username\") == username)\n\n            if len(user_data) == 0:\n                security_logger.warning(f\"User '{username}' not found in Parquet.\")\n                return None\n\n            # Get user row\n            user_row = user_data.row(0, named=True)\n            security_logger.info(f\"User '{username}' found in Parquet. Verifying password...\")\n\n            # Verify password\n            hashed_password = user_row[\"hashed_password\"]\n            is_valid = self._verify_password(password, hashed_password)\n            \n            if not is_valid:\n                security_logger.warning(f\"Invalid password attempt for user '{username}' in Parquet.\")\n                return None\n            \n            security_logger.info(f\"Password verified for '{username}' in Parquet.\")\n\n            # Check if active\n            if not user_row.get(\"is_active\", True):\n                security_logger.warning(f\"Inactive user '{username}' attempted to log in via Parquet.\")\n                return None\n\n            # Parse allowed_segments\n            allowed_segments = []\n            if \"allowed_segments\" in user_row and user_row[\"allowed_segments\"]:\n                try:\n                    # It should be a JSON string\n                    allowed_segments = json.loads(user_row[\"allowed_segments\"])\n                except:\n                    # Fallback if it's not JSON (e.g. legacy data)\n                    allowed_segments = []\n\n            return {\n                \"id\": str(user_row[\"id\"]),\n                \"username\": user_row[\"username\"],\n                \"email\": user_row.get(\"email\", \"\"),\n                \"role\": user_row[\"role\"],\n                \"is_active\": user_row.get(\"is_active\", True),\n                \"allowed_segments\": allowed_segments\n            }\n        except Exception as e:\n            security_logger.error(f\"Error reading/processing Parquet for user '{username}': {e}\")\n            return None\n\n    def _verify_password(self, plain_password: str, hashed_password: str) -> bool:\n        \"\"\"Verify password using bcrypt\"\"\"\n        try:\n            return bcrypt.checkpw(\n                plain_password.encode('utf-8'),\n                hashed_password.encode('utf-8')\n            )\n        except Exception as e:\n            security_logger.error(f\"Password verification error for provided hash: {e}\")\n            return False\n\n\n# Global instance\nauth_service = AuthService()", "mimetype": "text/plain", "start_char_idx": 8077, "end_char_idx": 10602, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b62f3379-75be-4f9d-8d2f-8e01c77951e1": {"__data__": {"id_": "b62f3379-75be-4f9d-8d2f-8e01c77951e1", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\cache.py", "language": "python", "lines": 197, "filename": "cache.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6c29441d-7bfb-4e17-9db3-ff323cc3190f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\cache.py", "language": "python", "lines": 197, "filename": "cache.py"}, "hash": "580a47dae51f347fd6ce9a35406a652c287027ce1f9df4c0b71eb442cb9e7be1", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "ac0b5851-a26c-40a7-a402-278a6b79a1d6", "node_type": "1", "metadata": {}, "hash": "e03d94abb21809fa8d9d748e6e1a60ec5ff8bf5e06e0b7e7c4c34dc01baff4f0", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nAgent Graph Cache\nManages caching of agent graphs, both in-memory and on disk, with versioning.\n\"\"\"\n\nimport time\nimport json\nimport os\nimport hashlib\nfrom typing import Dict, Any, Optional\nfrom datetime import datetime, timedelta\n\nfrom app.config.settings import settings\n\nclass AgentGraphCache:\n    \"\"\"\n    A hybrid in-memory and on-disk cache specifically for agent graphs.\n    Supports versioning for automatic invalidation and TTL.\n    (T6.1.1 from TASK_LIST)\n    \"\"\"\n\n    def __init__(self, cache_dir: str = \"data/cache_agent_graph\", ttl_minutes: int = settings.AGENT_GRAPH_CACHE_TTL_MINUTES):\n        self.cache_dir = cache_dir\n        os.makedirs(self.cache_dir, exist_ok=True)\n        self.ttl = timedelta(minutes=ttl_minutes)\n        self.in_memory_cache: Dict[str, Dict[str, Any]] = {} # {key: {value: graph_data, timestamp: datetime, version: str}}\n        print(f\"AgentGraphCache initialized in {self.cache_dir} with TTL {self.ttl}\")\n\n        # Load existing cache from disk on startup\n        self._load_all_from_disk()\n\n    def _get_cache_file_path(self, key: str) -> str:\n        \"\"\"Generates a file path for a given cache key.\"\"\"\n        return os.path.join(self.cache_dir, f\"{key}.json\")\n\n    def _get_current_version(self) -> str:\n        \"\"\"\n        Generates a hash representing the current version of the agent's code/config.\n        This hash is used to invalidate the cache if agent logic changes.\n        (T6.1.4 from TASK_LIST)\n        \"\"\"\n        # For simplicity, let's hash a combination of settings and a dummy version string.\n        # In a real scenario, this would involve hashing agent source code files,\n        # prompt templates, and relevant configuration files.\n        version_data = {\n            \"agent_code_version\": \"1.0\", # Placeholder: could be hash of agent source code\n            \"settings_llm_model\": settings.LLM_MODEL_NAME,\n            \"settings_rag_model\": settings.RAG_EMBEDDING_MODEL,\n        }\n        return hashlib.sha256(json.dumps(version_data, sort_keys=True).encode(\"utf-8\")).hexdigest()\n\n    def _load_from_disk(self, key: str) -> Optional[Dict[str, Any]]:\n        \"\"\"Loads a single cache entry from disk.\"\"\"\n        file_path = self._get_cache_file_path(key)\n        if os.path.exists(file_path):\n            try:\n                with open(file_path, \"r\", encoding=\"utf-8\") as f:\n                    cached_data = json.load(f)\n                return cached_data\n            except (json.JSONDecodeError, OSError) as e:\n                print(f\"Error reading or decoding cache file {file_path}: {e}\")\n                if os.path.exists(file_path):\n                    os.remove(file_path) # Remove corrupt file\n        return None\n\n    def _save_to_disk(self, key: str, value: Any, timestamp: datetime, version: str):\n        \"\"\"Saves a single cache entry to disk.\"\"\"\n        file_path = self._get_cache_file_path(key)\n        data_to_cache = {\n            \"value\": value,\n            \"timestamp\": timestamp.isoformat(),\n            \"version\": version\n        }\n        try:\n            with open(file_path, \"w\", encoding=\"utf-8\") as f:\n                json.dump(data_to_cache, f, ensure_ascii=False, indent=4)\n            # print(f\"Agent graph cache saved to disk for key: {key}\")\n        except OSError as e:\n            print(f\"Error writing agent graph cache file {file_path}: {e}\")\n\n    def _load_all_from_disk(self):\n        \"\"\"Loads all valid cache entries from disk into memory on startup.\"\"\"\n        current_version = self._get_current_version()\n        for filename in os.listdir(self.cache_dir):\n            if filename.endswith(\".json\"):\n                key = filename[:-5] # Remove .json extension\n                cached_data = self._load_from_disk(key)\n                if cached_data:\n                    cached_time = datetime.fromisoformat(cached_data[\"timestamp\"])\n                    if (datetime.now() - cached_time < self.ttl) and \\\n                       (cached_data.get(\"version\") == current_version):\n                        self.in_memory_cache[key] = cached_data\n                        # print(f\"Loaded valid agent graph cache for key: {key} from disk.\")\n                    else:\n                        print(f\"Invalidated old agent graph cache for key: {key} (expired or version mismatch).\")\n                        os.remove(self._get_cache_file_path(key))\n    \n    def get(self, key: str) -> Any:\n        \"\"\"\n        Gets an entry from the cache (memory first, then disk).\n        Checks for expiration and version compatibility.\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4537, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ac0b5851-a26c-40a7-a402-278a6b79a1d6": {"__data__": {"id_": "ac0b5851-a26c-40a7-a402-278a6b79a1d6", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\cache.py", "language": "python", "lines": 197, "filename": "cache.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6c29441d-7bfb-4e17-9db3-ff323cc3190f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\cache.py", "language": "python", "lines": 197, "filename": "cache.py"}, "hash": "580a47dae51f347fd6ce9a35406a652c287027ce1f9df4c0b71eb442cb9e7be1", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b62f3379-75be-4f9d-8d2f-8e01c77951e1", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\cache.py", "language": "python", "lines": 197, "filename": "cache.py"}, "hash": "0c73387449e1dc47b6fa8020a8e09cc630cfcf5cad966dba7ed272361b3b39f3", "class_name": "RelatedNodeInfo"}}, "text": "else:\n                        print(f\"Invalidated old agent graph cache for key: {key} (expired or version mismatch).\")\n                        os.remove(self._get_cache_file_path(key))\n    \n    def get(self, key: str) -> Any:\n        \"\"\"\n        Gets an entry from the cache (memory first, then disk).\n        Checks for expiration and version compatibility.\n        \"\"\"\n        current_version = self._get_current_version()\n        \n        # Check in-memory cache\n        if key in self.in_memory_cache:\n            entry = self.in_memory_cache[key]\n            cached_time = datetime.fromisoformat(entry[\"timestamp\"])\n            if (datetime.now() - cached_time < self.ttl) and \\\n               (entry.get(\"version\") == current_version):\n                # print(f\"Agent graph cache hit (in-memory) for key: {key}\")\n                return entry[\"value\"]\n            else:\n                del self.in_memory_cache[key] # Expired or old version\n        \n        # Check disk cache if not found in memory or invalidated\n        cached_data_from_disk = self._load_from_disk(key)\n        if cached_data_from_disk:\n            cached_time = datetime.fromisoformat(cached_data_from_disk[\"timestamp\"])\n            if (datetime.now() - cached_time < self.ttl) and \\\n               (cached_data_from_disk.get(\"version\") == current_version):\n                self.in_memory_cache[key] = cached_data_from_disk # Load into memory\n                # print(f\"Agent graph cache hit (disk) for key: {key}\")\n                return cached_data_from_disk[\"value\"]\n            else:\n                print(f\"Invalidated old agent graph cache for key: {key} (expired or version mismatch).\")\n                os.remove(self._get_cache_file_path(key))\n        \n        return None\n\n    def set(self, key: str, value: Any) -> None:\n        \"\"\"\n        Sets an entry in the cache (both in-memory and on disk).\n        \"\"\"\n        timestamp = datetime.now()\n        version = self._get_current_version()\n        entry = {\n            \"value\": value,\n            \"timestamp\": timestamp.isoformat(),\n            \"version\": version\n        }\n        self.in_memory_cache[key] = entry\n        self._save_to_disk(key, value, timestamp, version)\n        # print(f\"Agent graph cache set for key: {key}\")\n\n    def clear(self, key: Optional[str] = None):\n        \"\"\"Clears a specific key or the entire cache.\"\"\"\n        if key:\n            if key in self.in_memory_cache:\n                del self.in_memory_cache[key]\n            file_path = self._get_cache_file_path(key)\n            if os.path.exists(file_path):\n                os.remove(file_path)\n            print(f\"Agent graph cache cleared for key: {key}\")\n        else:\n            self.in_memory_cache.clear()\n            for filename in os.listdir(self.cache_dir):\n                file_path = os.path.join(self.cache_dir, filename)\n                if os.path.isfile(file_path):\n                    os.remove(file_path)\n            print(\"All agent graph cache cleared.\")\n\n# Example usage\nif __name__ == '__main__':\n    # Ensure cache directory exists for testing\n    os.makedirs(settings.LEARNING_EXAMPLES_PATH, exist_ok=True) # Using LEARNING_EXAMPLES_PATH as temp dir\n    \n    cache = AgentGraphCache(cache_dir=settings.LEARNING_EXAMPLES_PATH, ttl_minutes=1) # 1 minute TTL for testing\n\n    test_key = \"my_agent_graph_key\"\n    test_graph_data = {\"nodes\": [\"A\", \"B\"], \"edges\": [(\"A\", \"B\")]}\n\n    # Test set\n    cache.set(test_key, test_graph_data)\n    \n    # Test get (should hit)\n    retrieved = cache.get(test_key)\n    print(f\"Retrieved (should hit): {retrieved}\")\n    assert retrieved == test_graph_data\n\n    # Test get (after expiration - manual simulation)\n    print(\"Waiting for cache to expire (1 minute)...\")\n    import time\n    time.sleep(65) # Wait a bit more than 1 minute\n\n    retrieved_expired = cache.get(test_key)\n    print(f\"Retrieved (should miss after expiration): {retrieved_expired}\")\n    assert retrieved_expired is None\n\n    # Test clear\n    cache.set(test_key, test_graph_data)\n    cache.clear(test_key)\n    assert cache.get(test_key) is None\n\n    print(\"\\nAgentGraphCache tests passed!\")", "mimetype": "text/plain", "start_char_idx": 4166, "end_char_idx": 8303, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b1a38a09-07e4-427b-ba62-3532f4b60028": {"__data__": {"id_": "b1a38a09-07e4-427b-ba62-3532f4b60028", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\code_rag_service.py", "language": "python", "lines": 260, "filename": "code_rag_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b9752c92-923b-4765-9c3d-96f24e84b361", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\code_rag_service.py", "language": "python", "lines": 260, "filename": "code_rag_service.py"}, "hash": "0cc8cca0abb0fad9198016382674b81dfb916b424ef1d7a334b830cd1e7c1fff", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "d44890db-634d-4ebb-abe7-78bfd1a10699", "node_type": "1", "metadata": {}, "hash": "7465844adffd8c408a3982091c684ec7f29af11f70df3f2fd874e96506e89a2a", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nCode RAG Service - Semantic Code Search with LlamaIndex + Gemini\n================================================================\n\nProvides semantic search and analysis of the entire codebase using:\n- LlamaIndex for RAG (Retrieval-Augmented Generation)\n- Gemini 2.5 Flash for LLM\n- GeminiEmbedding for semantic search\n- FAISS for vector storage\n\nAuthor: Antigravity AI\nDate: 2025-12-15\n\"\"\"\n\nimport os\nimport json\nimport logging\nfrom pathlib import Path\nfrom typing import Optional, Dict, Any, List\nfrom datetime import datetime\n\nfrom app.config.settings import settings\n\nlogger = logging.getLogger(__name__)\n\n\nclass CodeRAGService:\n    \"\"\"\n    Service for semantic code search and analysis using RAG.\n    \n    Features:\n    - Semantic search across entire codebase\n    - Context-aware code analysis\n    - Intelligent code suggestions\n    - Multi-language support (Python, TypeScript, etc.)\n    \"\"\"\n    \n    def __init__(self):\n        \"\"\"Initialize the RAG service with lazy loading.\"\"\"\n        # Melhor pr\u00e1tica Context7: Usar caminho absoluto baseado no arquivo, n\u00e3o no CWD\n        # ./backend/app/core/code_rag_service.py -> ../../../storage\n        self._storage_path = Path(__file__).resolve().parents[3] / \"storage\"\n        self._initialized = False\n        \n    def _ensure_initialized(self) -> bool:\n        \"\"\"\n        Lazy initialization of the RAG engine.\n        Only loads when first query is made.\n        \n        Returns:\n            bool: True if initialized successfully\n        \"\"\"\n        if self._initialized:\n            return True\n            \n        try:\n            logger.info(\"\ud83d\udd27 Initializing Code RAG Service...\")\n            logger.info(f\"\ud83d\udcc1 Storage Path: {self._storage_path}\")\n            \n            # Check if storage exists\n            if not self._storage_path.exists():\n                logger.error(f\"\u274c Storage path does not exist: {self._storage_path}\")\n                logger.error(\"Please run: python scripts/index_codebase.py\")\n                return False\n\n            # Check if Gemini API key is configured\n            if not settings.GEMINI_API_KEY:\n                logger.error(\"\u274c GEMINI_API_KEY not configured\")\n                return False\n            \n            # Import LlamaIndex components (lazy import)\n            try:\n                from llama_index.core import (\n                    VectorStoreIndex,\n                    Settings,\n                    load_index_from_storage,\n                )\n                from llama_index.core.storage import StorageContext\n                from llama_index.llms.gemini import Gemini\n                from llama_index.embeddings.gemini import GeminiEmbedding\n            except ImportError as e:\n                logger.error(f\"\u274c Missing dependencies (ImportError): {e}\")\n                logger.error(\"Install with: pip install llama-index llama-index-vector-stores-faiss llama-index-llms-gemini llama-index-embeddings-gemini\")\n                return False\n            \n            # Configure LlamaIndex Settings\n            # Usando modelos est\u00e1veis: gemini-1.5-flash e text-embedding-004\n            Settings.llm = Gemini(\n                model_name=\"models/gemini-1.5-flash\", \n                api_key=settings.GEMINI_API_KEY,\n                temperature=0.1,\n            )\n            \n            Settings.embed_model = GeminiEmbedding(\n                model_name=\"models/text-embedding-004\",\n                api_key=settings.GEMINI_API_KEY,\n            )\n            \n            # Load FAISS index\n            logger.info(\"Loading index from storage...\")\n            storage_context = StorageContext.from_defaults(\n                persist_dir=str(self._storage_path)\n            )\n            \n            self._index = load_index_from_storage(storage_context)\n            self._query_engine = self._index.as_query_engine(\n                similarity_top_k=5,\n                response_mode=\"tree_summarize\"\n            )\n            \n            # Load index statistics\n            stats_file = self._storage_path / \"index_stats.json\"\n            if stats_file.exists():\n                with open(stats_file, 'r', encoding='utf-8') as f:\n                    self._index_stats = json.load(f)\n            \n            self._initialized = True\n            logger.info(\"\u2705 Code RAG Service initialized successfully\")\n            return True\n            \n        except Exception as e:\n            # CRITICAL: Log the full traceback to understand why it fails\n            import traceback\n            trace = traceback.format_exc()\n            logger.error(f\"\u274c Failed to initialize RAG service: {e}\\n{trace}\")\n            return False\n    \n    def get_index_stats(self) -> Dict[str, Any]:\n        \"\"\"\n        Get statistics about the code index.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4742, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d44890db-634d-4ebb-abe7-78bfd1a10699": {"__data__": {"id_": "d44890db-634d-4ebb-abe7-78bfd1a10699", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\code_rag_service.py", "language": "python", "lines": 260, "filename": "code_rag_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b9752c92-923b-4765-9c3d-96f24e84b361", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\code_rag_service.py", "language": "python", "lines": 260, "filename": "code_rag_service.py"}, "hash": "0cc8cca0abb0fad9198016382674b81dfb916b424ef1d7a334b830cd1e7c1fff", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b1a38a09-07e4-427b-ba62-3532f4b60028", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\code_rag_service.py", "language": "python", "lines": 260, "filename": "code_rag_service.py"}, "hash": "94d2978733a6a1b045bf9cbee95cd80b382d1c4ce78bfd388fcd6eb073d8e0bc", "class_name": "RelatedNodeInfo"}}, "text": "Returns:\n            Dict with index statistics\n        \"\"\"\n        if self._index_stats:\n            return self._index_stats\n        \n        # Default stats if not loaded\n        return {\n            \"status\": \"not_indexed\",\n            \"total_files\": 0,\n            \"total_functions\": 0,\n            \"total_classes\": 0,\n            \"total_lines\": 0,\n            \"indexed_at\": None,\n            \"languages\": []\n        }\n    \n    def query(\n        self,\n        message: str,\n        history: Optional[List[Dict[str, str]]] = None,\n        filters: Optional[Dict[str, Any]] = None\n    ) -> Dict[str, Any]:\n        \"\"\"\n        Query the codebase with semantic search.\n        \n        Args:\n            message: User's question about the code\n            history: Previous conversation history\n            filters: Optional filters (language, directory, etc.)\n            \n        Returns:\n            Dict with response, code references, and metadata\n        \"\"\"\n        # Ensure service is initialized\n        if not self._ensure_initialized():\n            return {\n                \"response\": (\n                    \"\u274c **Servi\u00e7o RAG n\u00e3o dispon\u00edvel**\\n\\n\"\n                    \"O \u00edndice de c\u00f3digo n\u00e3o foi encontrado ou o servi\u00e7o n\u00e3o p\u00f4de ser inicializado.\\n\\n\"\n                    \"**Poss\u00edveis causas:**\\n\"\n                    \"1. GEMINI_API_KEY n\u00e3o configurada\\n\"\n                    \"2. Depend\u00eancias faltando (llama-index, faiss)\\n\"\n                    \"3. \u00cdndice n\u00e3o gerado (execute `python scripts/index_codebase.py`)\\n\\n\"\n                    \"Verifique os logs para mais detalhes.\"\n                ),\n                \"code_references\": [],\n                \"metadata\": {\n                    \"response_time\": 0,\n                    \"sources_count\": 0,\n                    \"error\": \"Service not initialized\"\n                }\n            }\n        \n        try:\n            start_time = datetime.now()\n            \n            # Build context from history if provided\n            context_messages = []\n            if history:\n                for msg in history[-5:]:  # Last 5 messages for context\n                    role = msg.get(\"role\", \"user\")\n                    content = msg.get(\"content\", \"\")\n                    context_messages.append(f\"{role}: {content}\")\n            \n            # Construct query with context\n            full_query = message\n            if context_messages:\n                context_str = \"\\n\".join(context_messages)\n                full_query = f\"Contexto da conversa:\\n{context_str}\\n\\nPergunta atual: {message}\"\n            \n            # Query the RAG engine\n            logger.info(f\"\ud83d\udd0d Querying codebase: {message[:100]}...\")\n            response = self._query_engine.query(full_query)\n            \n            # Extract source nodes (code references)\n            code_references = []\n            if hasattr(response, 'source_nodes'):\n                for node in response.source_nodes[:5]:  # Top 5 sources\n                    metadata = node.node.metadata\n                    code_references.append({\n                        \"file\": metadata.get(\"file_path\", \"unknown\"),\n                        \"score\": node.score,\n                        \"content\": node.node.text[:500],  # First 500 chars\n                        \"lines\": metadata.get(\"lines\", \"\"),\n                    })\n            \n            end_time = datetime.now()\n            response_time = (end_time - start_time).total_seconds()\n            \n            return {\n                \"response\": str(response),\n                \"code_references\": code_references,\n                \"metadata\": {\n                    \"response_time\": round(response_time, 2),\n                    \"sources_count\": len(code_references),\n                    \"timestamp\": datetime.now().isoformat()\n                }\n            }\n            \n        except Exception as e:\n            logger.error(f\"Error querying codebase: {e}\", exc_info=True)\n            return {\n                \"response\": f\"\u274c **Erro ao processar consulta**\\n\\n{str(e)}\",\n                \"code_references\": [],\n                \"metadata\": {\n                    \"response_time\": 0,\n                    \"sources_count\": 0,\n                    \"error\": str(e)\n                }\n            }\n\n\n# Singleton instance\n_code_rag_service: Optional[CodeRAGService] = None\n\n\ndef get_code_rag_service() -> CodeRAGService:\n    \"\"\"\n    Get or create the singleton CodeRAGService instance.\n    \n    Returns:\n        CodeRAGService instance\n    \"\"\"\n    global _code_rag_service\n    if _code_rag_service is None:\n        _code_rag_service = CodeRAGService()\n    return _code_rag_service", "mimetype": "text/plain", "start_char_idx": 4760, "end_char_idx": 9381, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "cac91c07-25e4-4b76-a17a-06d1e3e94bfb": {"__data__": {"id_": "cac91c07-25e4-4b76-a17a-06d1e3e94bfb", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\data_scope_service.py", "language": "python", "lines": 170, "filename": "data_scope_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0193b7c7-e67f-417d-8040-a3fefaca9ec4", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\data_scope_service.py", "language": "python", "lines": 170, "filename": "data_scope_service.py"}, "hash": "81bf02b8a8da2de628a7e75ffd840d2272499b7db80a49c3d967afc3482907e6", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "bc42ea72-fed3-466e-b723-06a5c83c0faa", "node_type": "1", "metadata": {}, "hash": "fad84fd52957a479923b5fe4b4c6d8f8304f9e13250f5441e23d4d3de0195f8f", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/data_scope_service.py\nimport polars as pl\nimport logging\nimport time\nfrom typing import List, Optional, Union\nfrom pathlib import Path\n\nfrom app.infrastructure.database.models.user import User\nfrom app.config.settings import settings\n\nlogger = logging.getLogger(__name__)\n\nclass DataScopeService:\n    \"\"\"\n    Servi\u00e7o para filtrar DataFrames baseados nas permiss\u00f5es de segmento do usu\u00e1rio.\n    Garante que cada usu\u00e1rio veja apenas os dados aos quais tem acesso.\n    \n    PERFORMANCE UPDATE: Uses LazyFrame (scan_parquet) to avoid loading full dataset into memory.\n    \"\"\"\n\n    def __init__(self):\n        # Determine path once\n        docker_path = Path(\"/app/data/parquet/admmat.parquet\")\n        dev_path = Path(__file__).parent.parent.parent / \"data\" / \"parquet\" / \"admmat.parquet\"\n        \n        if docker_path.exists():\n            self.parquet_path = str(docker_path)\n        else:\n            self.parquet_path = str(dev_path)\n            \n        logger.info(f\"DataScopeService: Initialized with Lazy Path: {self.parquet_path}\")\n\n    def _get_base_lazyframe(self) -> pl.LazyFrame:\n        \"\"\"\n        Returns a base LazyFrame with global filters applied.\n        WORKAROUND: Uses read_parquet().lazy() instead of scan_parquet() \n        to avoid 'assertion left == right failed' panic in streaming engine.\n        \"\"\"\n        # lf = pl.scan_parquet(self.parquet_path)\n        # Using eager read + lazy conversion to bypass streaming reader bug\n        try:\n            lf = pl.read_parquet(self.parquet_path).lazy()\n        except Exception as e:\n            logger.error(f\"Failed to read parquet file eagerly: {e}\")\n            # Fallback to scan if read fails (though scan is likely to fail too if it's the same bug)\n            lf = pl.scan_parquet(self.parquet_path)\n        \n        # GLOBAL FILTER: Apply allowed UNEs whitelist if configured\n        if settings.ALLOWED_UNES:\n            # We assume 'UNE' column exists, but check schema safely if needed\n            # In Lazy mode, we just apply the filter. If col doesn't exist, it will fail at collection time.\n            lf = lf.filter(pl.col(\"UNE\").is_in(settings.ALLOWED_UNES))\n            \n        return lf\n\n    def get_filtered_dataframe(self, user: User, max_rows: Optional[int] = None) -> Union[pl.DataFrame, pl.LazyFrame]:\n        \"\"\"\n        Retorna o DataFrame admmat.parquet filtrado pelos allowed_segments do usu\u00e1rio.\n        \n        Args:\n            user: Usu\u00e1rio autenticado\n            max_rows: Limite m\u00e1ximo de linhas a retornar (None = sem limite)\n            \n        Returns:\n            pl.DataFrame: The collected filtered data.\n        \"\"\"\n        start_time = time.perf_counter()\n        \n        try:\n            lf = self._get_base_lazyframe()\n            \n            # 1. Apply User Permission Filters\n            if not user or user.role == \"admin\" or \"*\" in user.segments_list:\n                # Admin or Full Access: No segment filter\n                pass\n            else:\n                allowed_segments = user.segments_list\n                if not allowed_segments:\n                    logger.warning(f\"Usu\u00e1rio {user.username} sem segmentos permitidos.\")\n                    return pl.DataFrame() # Return empty DF\n                \n                # Check schema for column name (optimization: cached schema could be better)\n                schema = lf.collect_schema()\n                segment_col = \"NOMESEGMENTO\" if \"NOMESEGMENTO\" in schema.names() else \"SEGMENTO\"\n                \n                if segment_col in schema.names():\n                    lf = lf.filter(pl.col(segment_col).is_in(allowed_segments))\n                else:\n                    logger.warning(f\"Coluna de segmento n\u00e3o encontrada no schema. Retornando vazio.\")\n                    return pl.DataFrame()\n\n            # 2. Apply Row Limits (Optimization: Limit at source)\n            if max_rows is not None and max_rows > 0:\n                lf = lf.head(max_rows)\n                \n            # 3.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3998, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "bc42ea72-fed3-466e-b723-06a5c83c0faa": {"__data__": {"id_": "bc42ea72-fed3-466e-b723-06a5c83c0faa", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\data_scope_service.py", "language": "python", "lines": 170, "filename": "data_scope_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0193b7c7-e67f-417d-8040-a3fefaca9ec4", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\data_scope_service.py", "language": "python", "lines": 170, "filename": "data_scope_service.py"}, "hash": "81bf02b8a8da2de628a7e75ffd840d2272499b7db80a49c3d967afc3482907e6", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "cac91c07-25e4-4b76-a17a-06d1e3e94bfb", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\data_scope_service.py", "language": "python", "lines": 170, "filename": "data_scope_service.py"}, "hash": "2ce79cc820384f64b75173db369498d1c002e4fd67e730d85e9533fb2f0cb6b1", "class_name": "RelatedNodeInfo"}}, "text": "return pl.DataFrame() # Return empty DF\n                \n                # Check schema for column name (optimization: cached schema could be better)\n                schema = lf.collect_schema()\n                segment_col = \"NOMESEGMENTO\" if \"NOMESEGMENTO\" in schema.names() else \"SEGMENTO\"\n                \n                if segment_col in schema.names():\n                    lf = lf.filter(pl.col(segment_col).is_in(allowed_segments))\n                else:\n                    logger.warning(f\"Coluna de segmento n\u00e3o encontrada no schema. Retornando vazio.\")\n                    return pl.DataFrame()\n\n            # 2. Apply Row Limits (Optimization: Limit at source)\n            if max_rows is not None and max_rows > 0:\n                lf = lf.head(max_rows)\n                \n            # 3. Collect Data\n            # Removed streaming=True due to panic issues\n            result_df = lf.collect()\n            \n            elapsed = time.perf_counter() - start_time\n            logger.info(f\"\u26a1 Filtro LAZY (via Eager) para {user.username}: {result_df.height} linhas em {elapsed:.4f}s\")\n            \n            return result_df\n\n        except Exception as e:\n            logger.error(f\"Erro ao filtrar dados (Lazy): {e}\")\n            return pl.DataFrame() # Fail safe\n\n    def get_filtered_lazyframe(self, user: User) -> pl.LazyFrame:\n        \"\"\"\n        Retorna um LazyFrame com os filtros de seguran\u00e7a aplicados, mas SEM coletar os dados.\n        Permite que os endpoints fa\u00e7am agrega\u00e7\u00f5es otimizadas antes de trazer dados para a mem\u00f3ria.\n        \"\"\"\n        try:\n            lf = self._get_base_lazyframe()\n            \n            if not user or user.role == \"admin\" or \"*\" in user.segments_list:\n                return lf\n            \n            allowed_segments = user.segments_list\n            if not allowed_segments:\n                return self._get_empty_lazyframe(lf)\n            \n            schema = lf.collect_schema()\n            segment_col = \"NOMESEGMENTO\" if \"NOMESEGMENTO\" in schema.names() else \"SEGMENTO\"\n            \n            if segment_col in schema.names():\n                return lf.filter(pl.col(segment_col).is_in(allowed_segments))\n            \n            return self._get_empty_lazyframe(lf)\n            \n        except Exception as e:\n            logger.error(f\"Erro ao obter LazyFrame: {e}\")\n            # Retornar um LazyFrame vazio seguro usando um scan dummy ou similar\n            # Hack: Scan no mesmo arquivo com filtro imposs\u00edvel\n            return self._get_base_lazyframe().filter(pl.lit(False))\n\n    def _get_empty_lazyframe(self, lf: pl.LazyFrame) -> pl.LazyFrame:\n        \"\"\"Helper para retornar LazyFrame vazio preservando schema\"\"\"\n        return lf.filter(pl.lit(False))\n\n    def get_user_segments(self, user: User) -> List[str]:\n        \"\"\"\n        Retorna a lista de segmentos \u00fanicos dispon\u00edveis para o usu\u00e1rio.\n        Se admin, faz um scan r\u00e1pido para pegar valores \u00fanicos.\n        \"\"\"\n        if not user:\n            return []\n            \n        if user.role != \"admin\" and \"*\" not in user.segments_list:\n            return user.segments_list\n            \n        # For admins, we need to fetch unique segments from DB\n        try:\n            lf = self._get_base_lazyframe()\n            schema = lf.collect_schema()\n            segment_col = \"NOMESEGMENTO\" if \"NOMESEGMENTO\" in schema.names() else \"SEGMENTO\"\n            \n            if segment_col in schema.names():\n                # Efficient unique value extraction\n                unique_segments = lf.select(segment_col).unique().collect().get_column(segment_col).to_list()\n                return [str(s) for s in unique_segments if s]\n                \n            return []\n        except Exception as e:\n            logger.error(f\"Erro ao buscar segmentos \u00fanicos: {e}\")\n            return []\n\n# Inicializar o servi\u00e7o como um singleton\ndata_scope_service = DataScopeService()", "mimetype": "text/plain", "start_char_idx": 3200, "end_char_idx": 7100, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "efebbe32-1f4f-48e1-a6b6-198bfd6bcea7": {"__data__": {"id_": "efebbe32-1f4f-48e1-a6b6-198bfd6bcea7", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\data_source_manager.py", "language": "python", "lines": 219, "filename": "data_source_manager.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "3a8e2b95-be73-4d30-8f12-4e89059b933c", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\data_source_manager.py", "language": "python", "lines": 219, "filename": "data_source_manager.py"}, "hash": "a9296c5b8c863945ae593001c6635ec15861f118d208da4cb64b64edff3f7de0", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c04f0a5e-495a-48e7-88b9-1193615324a6", "node_type": "1", "metadata": {}, "hash": "792680112c82dd83e4d3983e4b56ac11fac526097646b48deceb3d237d20b899", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nData Source Manager - Acesso centralizado aos dados Parquet\nAdaptado para Agent Solution BI: admmat.parquet\n\"\"\"\n\nimport logging\nimport pandas as pd\nfrom pathlib import Path\nfrom typing import Dict, Any, Optional, List\nfrom app.core.parquet_cache import cache\n\nlogger = logging.getLogger(__name__)\n\n# Constantes: Arquivos de dados\nPROJECT_ROOT = Path(__file__).resolve().parent.parent.parent.parent\nMAIN_DATA_FILE = PROJECT_ROOT / \"data\" / \"parquet\" / \"admmat.parquet\"\n\n\nclass ParquetDataSource:\n    \"\"\"Acesso centralizado ao arquivo admmat.parquet.\"\"\"\n\n    def __init__(self):\n        self._connected = False\n        self._df_cache: Optional[pd.DataFrame] = None\n\n        # Caminho h\u00edbrido Docker/Dev\n        docker_path = Path(\"/app/data/parquet/admmat.parquet\")\n        dev_path = MAIN_DATA_FILE\n\n        self.file_path = docker_path if docker_path.exists() else dev_path\n        logger.info(f\"\ud83d\udcca Usando arquivo: {self.file_path}\")\n\n    def connect(self) -> bool:\n        \"\"\"Verifica se arquivo Parquet existe.\"\"\"\n        if self.file_path.exists():\n            self._connected = True\n            logger.info(f\"\u2713 Parquet conectado: {self.file_path}\")\n            return True\n\n        logger.error(f\"\u2717 Arquivo n\u00e3o encontrado: {self.file_path}\")\n        self._connected = False\n        return False\n\n    def is_connected(self) -> bool:\n        \"\"\"Verifica se est\u00e1 conectado.\"\"\"\n        return self._connected and self.file_path.exists()\n\n    def _load_data(self, force_reload: bool = False) -> pd.DataFrame:\n        \"\"\"\n        Carrega os dados do arquivo Parquet usando ParquetCache global.\n        \u2705 OTIMIZADO: Usa cache global ao inv\u00e9s de cache local.\n        \"\"\"\n        try:\n            # Usar ParquetCache global (j\u00e1 retorna Polars DataFrame)\n            df_polars = cache.get_dataframe(\"admmat.parquet\")\n\n            # Converter de Polars para Pandas (necess\u00e1rio para compatibilidade com ferramentas existentes)\n            df = df_polars.to_pandas()\n            logger.info(f\"\u2713 Dados obtidos do cache: {df.shape}\")\n\n            return df\n\n        except FileNotFoundError as e:\n            logger.error(f\"\u2717 ERRO CR\u00cdTICO: Arquivo n\u00e3o encontrado: {self.file_path}\")\n            raise\n        except Exception as e:\n            logger.error(f\"\u2717 ERRO ao ler Parquet: {e}\")\n            raise\n\n    def get_data(self, limit: int = None) -> pd.DataFrame:\n        \"\"\"Obt\u00e9m todos os dados ou limitados.\"\"\"\n        df = self._load_data()\n        if limit and not df.empty:\n            df = df.head(limit)\n        return df\n\n    def search(self, column: str, value: str, limit: int = 10) -> pd.DataFrame:\n        \"\"\"Busca em uma coluna.\"\"\"\n        try:\n            df = self._load_data()\n            if df.empty or column not in df.columns:\n                return pd.DataFrame()\n\n            # Busca case-insensitive\n            mask = df[column].astype(str).str.contains(value, case=False, na=False)\n            result = df[mask].head(limit)\n            return result\n\n        except Exception as e:\n            logger.error(f\"Erro ao buscar: {e}\")\n            return pd.DataFrame()\n\n    def get_filtered_data(\n        self, filters: Dict[str, Any], limit: int = None\n    ) -> pd.DataFrame:\n        \"\"\"Busca com filtros exatos.\"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3230, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c04f0a5e-495a-48e7-88b9-1193615324a6": {"__data__": {"id_": "c04f0a5e-495a-48e7-88b9-1193615324a6", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\data_source_manager.py", "language": "python", "lines": 219, "filename": "data_source_manager.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "3a8e2b95-be73-4d30-8f12-4e89059b933c", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\data_source_manager.py", "language": "python", "lines": 219, "filename": "data_source_manager.py"}, "hash": "a9296c5b8c863945ae593001c6635ec15861f118d208da4cb64b64edff3f7de0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "efebbe32-1f4f-48e1-a6b6-198bfd6bcea7", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\data_source_manager.py", "language": "python", "lines": 219, "filename": "data_source_manager.py"}, "hash": "e16025992a9063694241b789ef7671c0cc6d43a42f65cbb7b10d787c7206cb0f", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "0c54ea1d-3352-436d-971b-71cb8704e65c", "node_type": "1", "metadata": {}, "hash": "ea286b2538678bb3753a09e32cf64e4d72c2bc0bcfd529da86954249a826d6cd", "class_name": "RelatedNodeInfo"}}, "text": "df = self._load_data()\n        if limit and not df.empty:\n            df = df.head(limit)\n        return df\n\n    def search(self, column: str, value: str, limit: int = 10) -> pd.DataFrame:\n        \"\"\"Busca em uma coluna.\"\"\"\n        try:\n            df = self._load_data()\n            if df.empty or column not in df.columns:\n                return pd.DataFrame()\n\n            # Busca case-insensitive\n            mask = df[column].astype(str).str.contains(value, case=False, na=False)\n            result = df[mask].head(limit)\n            return result\n\n        except Exception as e:\n            logger.error(f\"Erro ao buscar: {e}\")\n            return pd.DataFrame()\n\n    def get_filtered_data(\n        self, filters: Dict[str, Any], limit: int = None\n    ) -> pd.DataFrame:\n        \"\"\"Busca com filtros exatos.\"\"\"\n        try:\n            df = self._load_data()\n            if df.empty:\n                return pd.DataFrame()\n\n            for col, value in filters.items():\n                if col in df.columns:\n                    col_dtype = df[col].dtype\n                    try:\n                        if pd.api.types.is_numeric_dtype(col_dtype) and isinstance(value, str):\n                            converted_value = pd.to_numeric(value, errors='raise')\n                            df = df[df[col] == converted_value]\n                        elif pd.api.types.is_datetime64_any_dtype(col_dtype) and isinstance(value, str):\n                            converted_value = pd.to_datetime(value, errors='raise')\n                            df = df[df[col] == converted_value]\n                        else:\n                            df = df[df[col] == value]\n                    except (ValueError, TypeError):\n                        df = df[df[col].astype(str).str.lower() == str(value).lower()]\n                else:\n                    logger.warning(f\"Coluna '{col}' n\u00e3o encontrada\")\n                    return pd.DataFrame()\n\n            if limit:\n                df = df.head(limit)\n\n            return df\n        except Exception as e:\n            logger.error(f\"Erro ao filtrar: {e}\")\n            return pd.DataFrame()\n\n    def get_columns(self) -> List[str]:\n        \"\"\"Retorna lista de colunas.\"\"\"\n        df = self._load_data()\n        return df.columns.tolist() if not df.empty else []\n\n    def get_shape(self) -> tuple:\n        \"\"\"Retorna dimens\u00f5es dos dados.\"\"\"\n        df = self._load_data()\n        return df.shape if not df.empty else (0, 0)\n\n    def get_info(self) -> Dict[str, Any]:\n        \"\"\"Retorna informa\u00e7\u00f5es sobre os dados.\"\"\"\n        df = self._load_data()\n        if df.empty:\n            return {\"status\": \"sem_dados\"}\n\n        return {\n            \"file\": str(self.file_path),\n            \"shape\": df.shape,\n            \"columns\": df.columns.tolist(),\n            \"dtypes\": {k: str(v) for k, v in df.dtypes.to_dict().items()},\n            \"memory_mb\": round(df.memory_usage(deep=True).sum() / 1024**2, 2),\n        }", "mimetype": "text/plain", "start_char_idx": 2415, "end_char_idx": 5365, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0c54ea1d-3352-436d-971b-71cb8704e65c": {"__data__": {"id_": "0c54ea1d-3352-436d-971b-71cb8704e65c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\data_source_manager.py", "language": "python", "lines": 219, "filename": "data_source_manager.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "3a8e2b95-be73-4d30-8f12-4e89059b933c", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\data_source_manager.py", "language": "python", "lines": 219, "filename": "data_source_manager.py"}, "hash": "a9296c5b8c863945ae593001c6635ec15861f118d208da4cb64b64edff3f7de0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c04f0a5e-495a-48e7-88b9-1193615324a6", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\data_source_manager.py", "language": "python", "lines": 219, "filename": "data_source_manager.py"}, "hash": "a3c25663920a3090d3803571a91eddfd06a44d07a03084ff5bc6294669835807", "class_name": "RelatedNodeInfo"}}, "text": "df = self._load_data()\n        return df.columns.tolist() if not df.empty else []\n\n    def get_shape(self) -> tuple:\n        \"\"\"Retorna dimens\u00f5es dos dados.\"\"\"\n        df = self._load_data()\n        return df.shape if not df.empty else (0, 0)\n\n    def get_info(self) -> Dict[str, Any]:\n        \"\"\"Retorna informa\u00e7\u00f5es sobre os dados.\"\"\"\n        df = self._load_data()\n        if df.empty:\n            return {\"status\": \"sem_dados\"}\n\n        return {\n            \"file\": str(self.file_path),\n            \"shape\": df.shape,\n            \"columns\": df.columns.tolist(),\n            \"dtypes\": {k: str(v) for k, v in df.dtypes.to_dict().items()},\n            \"memory_mb\": round(df.memory_usage(deep=True).sum() / 1024**2, 2),\n        }\n\n\nclass DataSourceManager:\n    \"\"\"\n    Gerenciador de fonte de dados centralizado.\n    Acessa: data/parquet/admmat.parquet\n    \"\"\"\n\n    def __init__(self):\n        self._source = ParquetDataSource()\n        self._source.connect()\n\n    def get_data(\n        self, table_name: str = None, limit: int = None, source: str = None\n    ) -> pd.DataFrame:\n        \"\"\"Obt\u00e9m dados (table_name \u00e9 ignorado).\"\"\"\n        return self._source.get_data(limit)\n\n    def search_data(\n        self,\n        table_name: str = None,\n        column: str = None,\n        value: str = None,\n        limit: int = 10,\n        source: str = None,\n    ) -> pd.DataFrame:\n        \"\"\"Busca dados em coluna especificada.\"\"\"\n        if not column or not value:\n            return pd.DataFrame()\n        return self._source.search(column, value, limit)\n\n    def get_filtered_data(\n        self,\n        table_name: str = None,\n        filters: Dict[str, Any] = None,\n        limit: int = None,\n        source: str = None,\n    ) -> pd.DataFrame:\n        \"\"\"Busca com filtros.\"\"\"\n        if not filters:\n            return pd.DataFrame()\n        return self._source.get_filtered_data(filters, limit)\n\n    def execute_query(self, query: str, params: Dict = None) -> List[Dict]:\n        \"\"\"N\u00e3o suportado para Parquet.\"\"\"\n        return []\n\n    def get_available_sources(self) -> List[str]:\n        \"\"\"Retorna fontes dispon\u00edveis.\"\"\"\n        if self._source.is_connected():\n            return [\"admmat_parquet\"]\n        return []\n\n    def get_source_info(self) -> Dict[str, Any]:\n        \"\"\"Retorna informa\u00e7\u00f5es da fonte.\"\"\"\n        return self._source.get_info()\n\n\n# Inst\u00e2ncia global singleton\n_data_manager_instance: Optional[DataSourceManager] = None\n\n\ndef get_data_manager() -> DataSourceManager:\n    \"\"\"Retorna inst\u00e2ncia singleton do DataSourceManager.\"\"\"\n    global _data_manager_instance\n    if _data_manager_instance is None:\n        _data_manager_instance = DataSourceManager()\n    return _data_manager_instance", "mimetype": "text/plain", "start_char_idx": 4637, "end_char_idx": 7345, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "de8878da-bd2d-4383-8336-0ca7e1728788": {"__data__": {"id_": "de8878da-bd2d-4383-8336-0ca7e1728788", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\intelligent_chatbi.py", "language": "python", "lines": 195, "filename": "intelligent_chatbi.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2530a1a9-9ec3-4099-bf86-38f40a7eb25c", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\intelligent_chatbi.py", "language": "python", "lines": 195, "filename": "intelligent_chatbi.py"}, "hash": "c1578ad554444b13c5fec5efb2e73ad134dae26e15871597d720c184c3ab1e79", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "22f82111-098f-4b48-985a-3ac462e23867", "node_type": "1", "metadata": {}, "hash": "b5dde9384b4de3710e35628bb6769f59d9b27293cc13cc5e7b8a956e872e84ab", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nChat BI - Sistema Inteligente com Gemini\nSolu\u00e7\u00e3o definitiva para processar perguntas em linguagem natural\n\"\"\"\n\nimport google.generativeai as genai\nimport polars as pl\nfrom pathlib import Path\nimport json\nimport re\nfrom typing import Dict, Any, Optional\nimport os\n\n\nclass IntelligentChatBI:\n    \"\"\"\n    Sistema inteligente de Chat BI usando Gemini para NL2SQL\n    \"\"\"\n    \n    def __init__(self, parquet_path: Path):\n        self.parquet_path = parquet_path\n        \n        # Configurar Gemini\n        api_key = os.getenv(\"GEMINI_API_KEY\")\n        if not api_key:\n            raise ValueError(\"GEMINI_API_KEY n\u00e3o configurada\")\n        \n        genai.configure(api_key=api_key)\n        \n        # Usar modelo EST\u00c1VEL (n\u00e3o experimental)\n        self.model = genai.GenerativeModel('gemini-1.5-flash')\n        \n        # Carregar schema do Parquet\n        self.schema = self._load_schema()\n    \n    def _load_schema(self) -> Dict[str, str]:\n        \"\"\"Carrega schema do Parquet para contexto\"\"\"\n        lf = pl.scan_parquet(self.parquet_path)\n        schema = lf.collect_schema()\n        \n        return {\n            \"columns\": list(schema.names()),\n            \"description\": {\n                \"PRODUTO\": \"C\u00f3digo do produto\",\n                \"NOME\": \"Nome do produto\",\n                \"UNE\": \"Unidade de Neg\u00f3cio (loja)\",\n                \"MES_01\": \"Vendas/Pre\u00e7o do m\u00eas 1\",\n                \"MES_02\": \"Vendas/Pre\u00e7o do m\u00eas 2\",\n                \"MES_03\": \"Vendas/Pre\u00e7o do m\u00eas 3\",\n                # Adicionar mais conforme necess\u00e1rio\n            }\n        }\n    \n    def process_query(self, user_query: str) -> Dict[str, Any]:\n        \"\"\"\n        Processa pergunta do usu\u00e1rio usando Gemini\n        Retorna resposta estruturada com dados e texto\n        \"\"\"\n        \n        # Detec\u00e7\u00e3o r\u00e1pida de sauda\u00e7\u00f5es (sem usar Gemini)\n        query_lower = user_query.lower()\n        saudacoes = [\"ol\u00e1\", \"oi\", \"ola\", \"hello\", \"boa tarde\", \"bom dia\", \"boa noite\"]\n        \n        if any(saudacao in query_lower for saudacao in saudacoes):\n            return {\n                \"success\": True,\n                \"text\": \"\ud83d\udc4b Ol\u00e1! Sou seu assistente de BI.\\n\\nPosso ajudar com:\\n\u2022 Consultas de pre\u00e7os\\n\u2022 An\u00e1lise de vendas\\n\u2022 Informa\u00e7\u00f5es de produtos\\n\\nFa\u00e7a uma pergunta!\",\n                \"data\": None\n            }\n        \n        # Criar prompt SIMPLIFICADO para Gemini (evitar erro 400)\n        prompt = f\"\"\"Analise esta pergunta sobre dados de vendas e retorne JSON:\n\nPergunta: \"{user_query}\"\n\nColunas dispon\u00edveis: PRODUTO, NOME, UNE, MES_01, MES_02, MES_03\n\nRetorne JSON:\n{{\n  \"produto\": \"c\u00f3digo ou null\",\n  \"une\": \"c\u00f3digo ou null\",\n  \"meses\": [\"MES_01\", \"MES_02\", \"MES_03\"],\n  \"operacao\": \"sum|filter|count\"\n}}\n\nExemplo: \"vendas produto 59294 une 261 \u00faltimos 3 meses\"\n{{\n  \"produto\": \"59294\",\n  \"une\": \"261\",\n  \"meses\": [\"MES_01\", \"MES_02\", \"MES_03\"],\n  \"operacao\": \"sum\"\n}}\n\"\"\"\n        \n        try:\n            # Chamar Gemini\n            response = self.model.generate_content(prompt)\n            response_text = response.text.strip()\n            \n            # Extrair JSON\n            json_match = re.search(r'\\{.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3102, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "22f82111-098f-4b48-985a-3ac462e23867": {"__data__": {"id_": "22f82111-098f-4b48-985a-3ac462e23867", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\intelligent_chatbi.py", "language": "python", "lines": 195, "filename": "intelligent_chatbi.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2530a1a9-9ec3-4099-bf86-38f40a7eb25c", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\intelligent_chatbi.py", "language": "python", "lines": 195, "filename": "intelligent_chatbi.py"}, "hash": "c1578ad554444b13c5fec5efb2e73ad134dae26e15871597d720c184c3ab1e79", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "de8878da-bd2d-4383-8336-0ca7e1728788", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\intelligent_chatbi.py", "language": "python", "lines": 195, "filename": "intelligent_chatbi.py"}, "hash": "ad1bd75d44b9b589a5c4b461ada5558ff9433532af9e18a33654617c32737ab4", "class_name": "RelatedNodeInfo"}}, "text": "*\\}', response_text, re.DOTALL)\n            if not json_match:\n                return self._fallback_response(user_query)\n            \n            query_plan = json.loads(json_match.group())\n            \n            # Executar consulta Polars\n            lf = pl.scan_parquet(self.parquet_path)\n            \n            produto = query_plan.get(\"produto\")\n            une = query_plan.get(\"une\")\n            meses = query_plan.get(\"meses\", [\"MES_01\", \"MES_02\", \"MES_03\"])\n            \n            # Construir filtro\n            filters = []\n            if produto:\n                filters.append(pl.col(\"PRODUTO\") == produto)\n            if une:\n                filters.append(pl.col(\"UNE\") == une)\n            \n            # Aplicar filtros\n            if filters:\n                result = lf.filter(pl.all_horizontal(filters)).select([\"PRODUTO\", \"NOME\", \"UNE\"] + meses).head(1).collect()\n            else:\n                result = lf.select(meses).sum().collect()\n            \n            # Formatar resposta\n            if len(result) > 0:\n                row = result.row(0, named=True)\n                \n                if produto and une:\n                    nome = row.get(\"NOME\", \"Produto\")\n                    valores = [row.get(m, 0) for m in meses]\n                    total = sum(valores)\n                    \n                    response_text = f\"\ud83d\udcca **Produto {produto}** na UNE {une}:\\n\\n**Nome:** {nome}\\n\"\n                    for i, mes in enumerate(meses, 1):\n                        response_text += f\"**M\u00eas {i}:** {row.get(mes, 0):,.0f}\\n\"\n                    response_text += f\"\\n**Total:** {total:,.0f}\"\n                else:\n                    total = sum([row.get(m, 0) for m in meses])\n                    response_text = f\"\ud83d\udcc8 **Total de Vendas:** {total:,.0f}\"\n                \n                return {\n                    \"success\": True,\n                    \"text\": response_text,\n                    \"data\": row\n                }\n            \n            return self._fallback_response(user_query)\n            \n        except Exception as e:\n            print(f\"Erro ao processar com Gemini: {e}\")\n            import traceback\n            traceback.print_exc()\n            return self._fallback_response(user_query)\n    \n    def _format_response(self, plan: Dict, result: Any) -> Dict[str, Any]:\n        \"\"\"Formata resposta baseado no template\"\"\"\n        \n        template = plan.get(\"response_template\", \"\")\n        \n        # Extrair dados do resultado Polars\n        if isinstance(result, pl.DataFrame):\n            if len(result) > 0:\n                row = result.row(0, named=True)\n                \n                # Calcular total se houver m\u00faltiplos meses\n                total = sum([v for k, v in row.items() if k.startswith(\"MES_\")])\n                \n                # Substituir placeholders\n                text = template.format(\n                    produto=plan.get(\"produto\", \"\"),\n                    une=plan.get(\"une\", \"\"),\n                    mes_01=row.get(\"MES_01\", 0),\n                    mes_02=row.get(\"MES_02\", 0),\n                    mes_03=row.get(\"MES_03\", 0),\n                    total=total\n                )\n                \n                return {\n                    \"text\": text,\n                    \"data\": row\n                }\n        \n        return {\"text\": str(result)}\n    \n    def _fallback_response(self, query: str) -> Dict[str, Any]:\n        \"\"\"Resposta de fallback quando Gemini falha\"\"\"\n        return {\n            \"success\": False,\n            \"text\": f\"\ud83e\udd14 Desculpe, n\u00e3o consegui processar sua pergunta: '{query}'\\n\\nTente reformular ou use perguntas mais simples como:\\n\u2022 'Qual o pre\u00e7o do produto X?'\\n\u2022 'Vendas do produto X na UNE Y'\",\n            \"data\": None\n        }", "mimetype": "text/plain", "start_char_idx": 3102, "end_char_idx": 6848, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "df95e599-fb71-4d88-abf6-56bfc8ecdbe6": {"__data__": {"id_": "df95e599-fb71-4d88-abf6-56bfc8ecdbe6", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\llm_base.py", "language": "python", "lines": 8, "filename": "llm_base.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "e1cfddfb-e17a-4220-bd6c-f967d79dee9e", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\llm_base.py", "language": "python", "lines": 8, "filename": "llm_base.py"}, "hash": "1a355ddc62b3ea4ca04e28954ff1aeabc02421af7ea61f8fdcea64afeb07a070", "class_name": "RelatedNodeInfo"}}, "text": "from abc import ABC, abstractmethod\n\n\nclass BaseLLMAdapter(ABC):\n    @abstractmethod\n    def get_completion(self, prompt: str) -> str:\n        pass", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 147, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "167442e8-7ba7-43bc-b6ae-1ca478000af3": {"__data__": {"id_": "167442e8-7ba7-43bc-b6ae-1ca478000af3", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\llm_factory.py", "language": "python", "lines": 88, "filename": "llm_factory.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b16bfb58-d366-4669-958d-c5e47f69298f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\llm_factory.py", "language": "python", "lines": 88, "filename": "llm_factory.py"}, "hash": "f65e876601be6d372d34060c76834fae6d95b694deebb191e7974e3a03d94c6e", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nFactory para sele\u00e7\u00e3o autom\u00e1tica de adaptadores LLM.\n\"\"\"\n\nimport logging\nfrom typing import Optional\nfrom app.config.settings import settings\nfrom app.core.llm_base import BaseLLMAdapter\n\n\nclass LLMFactory:\n    \"\"\"Factory pattern para criar adaptadores LLM.\"\"\"\n\n    _instance: Optional[\"LLMFactory\"] = None\n    _adapter: Optional[BaseLLMAdapter] = None\n    _logger = logging.getLogger(__name__)\n\n    def __new__(cls):\n        if cls._instance is None:\n            cls._instance = super().__new__(cls)\n        return cls._instance\n\n    @classmethod\n    def get_adapter(cls) -> BaseLLMAdapter:\n        \"\"\"\n        Obt\u00e9m o adaptador LLM configurado (apenas Gemini).\n\n        Returns:\n            BaseLLMAdapter: Adaptador LLM inicializado\n\n        Raises:\n            ValueError: Se o adaptador Gemini n\u00e3o puder ser inicializado\n        \"\"\"\n        if cls._adapter is not None:\n            return cls._adapter\n\n        factory = cls()\n        cls._logger.info(\"Inicializando adaptador Gemini.\")\n        cls._adapter = factory._get_gemini_adapter()\n\n        if cls._adapter is None:\n            raise ValueError(\n                \"Nenhum adaptador LLM pode ser inicializado. \"\n                \"Verifique as configura\u00e7\u00f5es de GEMINI_API_KEY.\"\n            )\n\n        return cls._adapter\n\n    @staticmethod\n    def _get_gemini_adapter() -> Optional[BaseLLMAdapter]:\n        \"\"\"Tenta inicializar adaptador Gemini.\"\"\"\n        try:\n            from app.core.llm_gemini_adapter import GeminiLLMAdapter\n\n            if not settings.GEMINI_API_KEY:\n                LLMFactory._logger.warning(\"GEMINI_API_KEY n\u00e3o configurada\")\n                return None\n\n            adapter = GeminiLLMAdapter()\n            LLMFactory._logger.info(\"Adaptador Gemini inicializado com sucesso\")\n            return adapter\n\n        except Exception as e:\n            LLMFactory._logger.error(f\"Erro ao inicializar Gemini: {e}\")\n            return None\n\n    @classmethod\n    def reset(cls):\n        \"\"\"Reseta o adaptador cache (\u00fatil para testes).\"\"\"\n        cls._adapter = None\n        cls._logger.info(\"Adaptador LLM resetado\")\n\n    @classmethod\n    def get_available_providers(cls) -> dict:\n        \"\"\"\n        Verifica quais provedores est\u00e3o dispon\u00edveis.\n\n        Returns:\n            dict: {'gemini': bool}\n        \"\"\"\n        providers = {}\n        try:\n            providers[\"gemini\"] = settings.GEMINI_API_KEY is not None\n        except Exception:\n            providers[\"gemini\"] = False\n\n        return providers", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2488, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "15d58a4e-22de-48c3-a4ce-9eb21f734860": {"__data__": {"id_": "15d58a4e-22de-48c3-a4ce-9eb21f734860", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1ecb7f8c-c239-4df3-ae82-87934e1785c0", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "hash": "6bad34f2d20a74a1426519b7c9539aa929b8aac648a46c7153de2b3fc6409fda", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "a9eba842-e393-4fe3-91f8-e9c752d2f3f9", "node_type": "1", "metadata": {}, "hash": "52b0ab690f687dbce24e641c73921dba94ca06369248bc44823eeec35cd83bf8", "class_name": "RelatedNodeInfo"}}, "text": "from typing import List, Dict, Any, Optional\nimport logging\nimport threading\nimport time\nfrom queue import Queue\nimport json # Adicionado para json.dumps\nimport os\nfrom app.core.llm_base import BaseLLMAdapter\nfrom app.config.settings import settings\n\nGEMINI_AVAILABLE = False # Assume false until all imports succeed\nLANGCHAIN_GEMINI_AVAILABLE = False\n\ntry:\n    import google.generativeai as genai\n    from google.api_core.exceptions import RetryError, InternalServerError\n    from google.generativeai.types import FunctionDeclaration, Tool\n    GEMINI_AVAILABLE = True\nexcept ImportError as e:\n    print(f\"Erro de importa\u00e7\u00e3o do Gemini: {e}\")\n    FunctionDeclaration = Any # Fallback to avoid NameError\n\n# Disable langchain-google-genai to avoid version conflicts\n# Using native google.generativeai adapter instead\nLANGCHAIN_GEMINI_AVAILABLE = False\n\n\nclass GeminiLLMAdapter(BaseLLMAdapter):\n    \"\"\"\n    Adaptador para Google Gemini API.\n    Implementa padr\u00e3o similar ao OpenAI com retry autom\u00e1tico e tratamento de erros.\n    \"\"\"\n\n    def __init__(self, model_name: Optional[str] = None, gemini_api_key: Optional[str] = None, system_instruction: Optional[str] = None):\n        self.logger = logging.getLogger(__name__)\n\n        if not GEMINI_AVAILABLE:\n            raise ImportError(\n                \"google-generativeai n\u00e3o est\u00e1 instalado. \"\n                \"Execute: pip install google-generativeai\"\n            )\n\n        # Use provided API key or fall back to settings\n        api_key = gemini_api_key or settings.GEMINI_API_KEY\n        if not api_key:\n            raise ValueError(\"GEMINI_API_KEY n\u00e3o configurada no arquivo .env\")\n\n        genai.configure(api_key=api_key)\n        self.gemini_api_key = api_key\n\n        # Use provided model name or fall back to settings (which loads from .env)\n        self.model_name = model_name or settings.LLM_MODEL_NAME or \"gemini-1.5-flash\"\n        self.max_retries = 3  # \u2705 Increased to 3 attempts\n        self.retry_delay = 0.5  # \u2705 500ms entre tentativas\n\n        # Store configurable system instruction (default None)\n        self.system_instruction = system_instruction\n\n        self.logger.info(f\"Gemini adapter inicializado com modelo: {self.model_name}\")\n\n    async def generate_response(self, prompt: str) -> str:\n        \"\"\"\n        Gera uma resposta de texto simples para um prompt dado.\n        Wrapper para get_completion para compatibilidade com insights.py.\n        \"\"\"\n        messages = [{\"role\": \"user\", \"content\": prompt}]\n        result = self.get_completion(messages)\n        \n        if \"error\" in result:\n            raise Exception(result[\"error\"])\n            \n        return result.get(\"content\", \"\")\n\n    def get_llm(self):\n        \"\"\"\n        Returns a LangChain-compatible ChatGoogleGenerativeAI instance.\n        This method is required by chat.py endpoint for agent initialization.\n        Falls back to self if langchain-google-genai is not available.\n        \"\"\"\n        if not LANGCHAIN_GEMINI_AVAILABLE:\n            self.logger.info(\"LangChain Google GenAI nao disponivel - usando adapter nativo\")\n            # Return self as fallback - the adapter itself can be used as an LLM\n            return self\n\n        try:\n            return ChatGoogleGenerativeAI(\n                model=self.model_name,\n                google_api_key=self.gemini_api_key,\n                temperature=0.0,\n                max_retries=self.max_retries\n            )\n        except Exception as e:\n            self.logger.error(f\"Erro ao criar ChatGoogleGenerativeAI: {e}\")\n            self.logger.info(f\"Erro ao criar ChatGoogleGenerativeAI: {e} - usando adapter nativo\")\n            return self\n\n    def invoke(self, input: Any, config: Optional[Dict] = None) -> Any:\n        \"\"\"\n        Implementation of the LangChain Runnable invoke protocol.\n        Allows the adapter to be used directly in LangChain sequences.\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3885, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a9eba842-e393-4fe3-91f8-e9c752d2f3f9": {"__data__": {"id_": "a9eba842-e393-4fe3-91f8-e9c752d2f3f9", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1ecb7f8c-c239-4df3-ae82-87934e1785c0", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "hash": "6bad34f2d20a74a1426519b7c9539aa929b8aac648a46c7153de2b3fc6409fda", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "15d58a4e-22de-48c3-a4ce-9eb21f734860", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "hash": "20b09720a7c37018cd8e4b0961e0d730bf9823d88204dd44840a863c032cb696", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c5761b68-d681-495b-bb0f-492ba17cc04d", "node_type": "1", "metadata": {}, "hash": "b3503b1bab8d73a7766f3fb61065f148aeaecd27d61a1d85697331eb7a4dc0b8", "class_name": "RelatedNodeInfo"}}, "text": "if not LANGCHAIN_GEMINI_AVAILABLE:\n            self.logger.info(\"LangChain Google GenAI nao disponivel - usando adapter nativo\")\n            # Return self as fallback - the adapter itself can be used as an LLM\n            return self\n\n        try:\n            return ChatGoogleGenerativeAI(\n                model=self.model_name,\n                google_api_key=self.gemini_api_key,\n                temperature=0.0,\n                max_retries=self.max_retries\n            )\n        except Exception as e:\n            self.logger.error(f\"Erro ao criar ChatGoogleGenerativeAI: {e}\")\n            self.logger.info(f\"Erro ao criar ChatGoogleGenerativeAI: {e} - usando adapter nativo\")\n            return self\n\n    def invoke(self, input: Any, config: Optional[Dict] = None) -> Any:\n        \"\"\"\n        Implementation of the LangChain Runnable invoke protocol.\n        Allows the adapter to be used directly in LangChain sequences.\n        \"\"\"\n        from langchain_core.messages import AIMessage, HumanMessage, SystemMessage, BaseMessage\n        from langchain_core.prompt_values import ChatPromptValue\n\n        messages = []\n        if isinstance(input, ChatPromptValue):\n            messages = input.to_messages()\n        elif isinstance(input, list):\n            messages = input\n        elif isinstance(input, str):\n            messages = [HumanMessage(content=input)]\n        \n        # Convert LangChain messages to the dict format expected by _convert_messages\n        adapter_messages = []\n        for msg in messages:\n            role = \"user\"\n            if isinstance(msg, AIMessage):\n                role = \"model\"\n            elif isinstance(msg, SystemMessage):\n                role = \"user\" \n            elif isinstance(msg, HumanMessage):\n                role = \"user\"\n            \n            content = msg.content if hasattr(msg, \"content\") else str(msg)\n            adapter_messages.append({\"role\": role, \"content\": content})\n\n        # Call get_completion\n        result = self.get_completion(adapter_messages)\n        \n        if \"error\" in result:\n             # Log the error but try to return it as text if possible, or raise\n             self.logger.error(f\"Error in invoke: {result['error']}\")\n             raise ValueError(result[\"error\"])\n             \n        return AIMessage(content=result.get(\"content\", \"\"))\n\n    def get_completion(\n        self,\n        messages: List[Dict[str, str]],\n        tools: Optional[Dict[str, List[Dict[str, Any]]]] = None, # Alterado aqui\n    ) -> Dict[str, Any]:\n        \"\"\"\n        Obt\u00e9m completion da API Gemini com retry autom\u00e1tico.\n\n        Args:\n            messages: Lista de mensagens no formato OpenAI-like\n            tools: Dicion\u00e1rio opcional de ferramentas no formato Gemini (com 'function_declarations')\n\n        Returns:\n            Dicion\u00e1rio com resultado ou erro\n        \"\"\"\n        for attempt in range(self.max_retries):\n            try:\n                q = Queue()\n\n                def worker():\n                    try:\n                        gemini_messages = self._convert_messages(messages)\n                        \n                        if tools:\n                            gemini_tools = self._convert_tools(tools)\n                        else:\n                            gemini_tools = []\n\n                        # \u2705 NOVO: Configura\u00e7\u00e3o de gera\u00e7\u00e3o avan\u00e7ada com Thinking Mode\n                        generation_config = genai.GenerationConfig(\n                            temperature=0.7,  # Balanceado para criatividade e precis\u00e3o\n                            top_p=0.95,\n                            top_k=40,\n                            max_output_tokens=8192,  # Aumentado para respostas detalhadas\n                        )\n\n                        model = genai.GenerativeModel(\n                            model_name=self.model_name,\n                            tools=gemini_tools if gemini_tools else None,\n                            generation_config=generation_config,\n                            # Use configurable system instruction (set during __init__)\n                            system_instruction=self.system_instruction\n                        )\n\n                        chat_session = model.start_chat(history=gemini_messages[:-1])\n\n                        self.logger.info(\n                            f\"Chamada Gemini (tentativa {attempt + 1}/\"\n                            f\"{self.max_retries}) - Thinking Mode ativo\"\n                        )\n\n                        response = chat_session.send_message(gemini_messages[-1][\"parts\"])\n\n                        self.logger.info(\"Chamada Gemini conclu\u00edda.\")", "mimetype": "text/plain", "start_char_idx": 2948, "end_char_idx": 7564, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c5761b68-d681-495b-bb0f-492ba17cc04d": {"__data__": {"id_": "c5761b68-d681-495b-bb0f-492ba17cc04d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1ecb7f8c-c239-4df3-ae82-87934e1785c0", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "hash": "6bad34f2d20a74a1426519b7c9539aa929b8aac648a46c7153de2b3fc6409fda", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "a9eba842-e393-4fe3-91f8-e9c752d2f3f9", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "hash": "9a64b4fb9966be70bfd3ce25f7c181e0dcd885d77abec46c76b656d5d045ef3c", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "5b65a6a5-9d8f-4318-b0cf-c8044729cc9f", "node_type": "1", "metadata": {}, "hash": "7438e4595be7770b1b3ea207a43a97a6c2f940c5f245353977b30249586ba8ab", "class_name": "RelatedNodeInfo"}}, "text": "tool_calls = []\n                        content = \"\"\n                        \n                        if response.candidates:\n                            candidate = response.candidates[0]\n                            if candidate.content and candidate.content.parts:\n                                for part in candidate.content.parts:\n                                    if part.function_call:\n                                        function_call = part.function_call\n                                        tool_calls.append({\n                                            \"id\": f\"call_{function_call.name}\", # Gemini doesn't provide an ID, so we generate one\n                                            \"function\": {\n                                                \"arguments\": json.dumps(dict(function_call.args)),\n                                                \"name\": function_call.name,\n                                            },\n                                            \"type\": \"function\",\n                                        })\n                                        # Se h\u00e1 tool_call, o conte\u00fado textual deve ser vazio\n                                        content = \"\" \n                                        break # Only handle the first function call for now\n                                    elif part.text:\n                                        content = part.text\n                                        break # Only handle the first text part for now\n                        \n                        result = {\"content\": content}\n                        if tool_calls:\n                            result[\"tool_calls\"] = tool_calls\n                        \n                        q.put(result)\n\n                    except Exception as e:\n                        error_msg = str(e).lower()\n\n                        retentable = any(\n                            [\n                                \"quota\" in error_msg,\n                                \"rate\" in error_msg,\n                                \"timeout\" in error_msg,\n                                \"500\" in error_msg,\n                                \"503\" in error_msg,\n                                \"429\" in error_msg,\n                            ]\n                        )\n\n                        self.logger.warning(\n                            f\"Erro Gemini na tentativa {attempt + 1}: {e} \"\n                            f\"(retent\u00e1vel: {retentable})\"\n                        )\n\n                        q.put({\"error\": f\"Erro: {e}\", \"retry\": retentable})\n\n                thread = threading.Thread(target=worker)\n                thread.start()\n                thread.join(timeout=30.0)  # \u2705 Increased to 30s\n\n                if thread.is_alive():\n                    self.logger.warning(f\"Thread timeout tentativa {attempt + 1}\")\n                    continue\n\n                result = q.get()\n\n                if \"error\" not in result:\n                    return result\n\n                if result.get(\"retry\") and (attempt < self.max_retries - 1):\n                    delay = self.retry_delay * (2**attempt)\n                    self.logger.info(\n                        f\"Aguardando {delay}s antes da pr\u00f3xima tentativa...\"\n                    )\n                    time.sleep(delay)\n                    continue\n\n                return result\n\n            except Exception as e:\n                self.logger.error(\n                    f\"Erro externo tentativa {attempt + 1}: {e}\", exc_info=True\n                )\n                if attempt < self.max_retries - 1:\n                    delay = self.retry_delay * (2**attempt)\n                    time.sleep(delay)\n                    continue\n                return {\"error\": f\"Erro ap\u00f3s {self.max_retries} tentativas: {e}\"}\n\n        return {\"error\": f\"Falha ap\u00f3s {self.max_retries} tentativas\"}\n\n    def _convert_messages(self, messages: List[Dict[str, str]]) -> List[Dict[str, Any]]:\n        \"\"\"\n        Converte mensagens do formato OpenAI-like para formato Gemini.", "mimetype": "text/plain", "start_char_idx": 7590, "end_char_idx": 11606, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5b65a6a5-9d8f-4318-b0cf-c8044729cc9f": {"__data__": {"id_": "5b65a6a5-9d8f-4318-b0cf-c8044729cc9f", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1ecb7f8c-c239-4df3-ae82-87934e1785c0", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "hash": "6bad34f2d20a74a1426519b7c9539aa929b8aac648a46c7153de2b3fc6409fda", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c5761b68-d681-495b-bb0f-492ba17cc04d", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}, "hash": "f7d74c5b4389b85974685f31015a1af030e758f3084f5bc8b46bf892a17d9ca9", "class_name": "RelatedNodeInfo"}}, "text": "Formato OpenAI-like: [{\"role\": \"user\", \"content\": \"...\"}]\n        Formato Gemini: [{\"role\": \"user\", \"parts\": [{\"text\": \"...\"}]}]\n        \"\"\"\n        gemini_messages = []\n\n        for msg in messages:\n            role = msg.get(\"role\", \"user\")\n            content = msg.get(\"content\", \"\")\n            tool_calls = msg.get(\"tool_calls\")\n            function_call = msg.get(\"function_call\")\n\n            # Determine Gemini role based on actual content and OpenAI-like role\n            # IMPORTANT: Check for tool_calls and function_call FIRST, before checking role\n            if tool_calls:\n                # Model's turn: calls a tool\n                gemini_msg = {\n                    \"role\": \"model\",\n                    \"parts\": [\n                        {\"function_call\": {\"name\": tc[\"function\"][\"name\"], \"args\": json.loads(tc[\"function\"][\"arguments\"])}}\n                        for tc in tool_calls\n                    ]\n                }\n            elif function_call:\n                # User's turn: provides tool response\n                # This handles both explicit \"function\"/\"tool\" roles AND cases where\n                # LangChain sends \"user\" role with function_call metadata\n                gemini_msg = {\n                    \"role\": \"user\",\n                    \"parts\": [\n                        {\n                            \"function_response\": {\n                                \"name\": function_call[\"name\"],\n                                \"response\": {\"content\": content}\n                            }\n                        }\n                    ]\n                }\n            elif role == \"user\":\n                gemini_msg = {\"role\": \"user\", \"parts\": [{\"text\": content}]}\n            elif role == \"assistant\" or role == \"model\":\n                gemini_msg = {\"role\": \"model\", \"parts\": [{\"text\": content}]}\n            else: # Fallback for unexpected roles, treat as user to avoid errors\n                self.logger.warning(f\"Unexpected role encountered: {role}. Treating as 'user'.\")\n                gemini_msg = {\"role\": \"user\", \"parts\": [{\"text\": content}]}\n\n            gemini_messages.append(gemini_msg)\n\n        return gemini_messages\n\n    def _convert_tools(self, tools_wrapper: Dict[str, List[Dict[str, Any]]]) -> List['Tool']:\n        \"\"\"\n        Converte ferramentas do formato OpenAI-like (agora encapsulado em 'function_declarations')\n        para Gemini Tool Format.\n        \"\"\"\n        gemini_tools = []\n\n        # Extract the list of function declarations from the wrapper dictionary\n        function_declarations = tools_wrapper.get(\"function_declarations\", [])\n\n        for tool_declaration in function_declarations:\n            # Each tool_declaration is already in the format expected by FunctionDeclaration\n            # e.g., {\"name\": \"tool_name\", \"description\": \"...\", \"parameters\": {...}}\n            gemini_tool = FunctionDeclaration(\n                name=tool_declaration.get(\"name\", \"\"),\n                description=tool_declaration.get(\"description\", \"\"),\n                parameters=tool_declaration.get(\"parameters\", {}),\n            )\n            gemini_tools.append(gemini_tool)\n\n        return [Tool(function_declarations=gemini_tools)]", "mimetype": "text/plain", "start_char_idx": 11616, "end_char_idx": 14806, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3c1998cd-03cc-43eb-ba3b-352de9c77dec": {"__data__": {"id_": "3c1998cd-03cc-43eb-ba3b-352de9c77dec", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\llm_langchain_adapter.py", "language": "python", "lines": 294, "filename": "llm_langchain_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d219add8-5278-4d44-9b97-73c57038c907", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\llm_langchain_adapter.py", "language": "python", "lines": 294, "filename": "llm_langchain_adapter.py"}, "hash": "738b63f37d91c512632e4d2bf690393a40ecac60b3bbc8fb8d0c6b46c17be18f", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "58cde054-7542-4884-b924-0ef174006528", "node_type": "1", "metadata": {}, "hash": "b966fe40cd074dcfc29935b61a52beb8e467b8b2d41905a78e96f62dcfb42e40", "class_name": "RelatedNodeInfo"}}, "text": "# core/llm_langchain_adapter.py\nfrom typing import Any, List, Optional, Dict\nimport json\nimport logging\n\nfrom app.core.llm_base import BaseLLMAdapter\n\nlogger = logging.getLogger(__name__)\n\nLANGCHAIN_AVAILABLE = False\ntry:\n    from langchain_core.callbacks import CallbackManagerForLLMRun\n    from langchain_core.language_models import BaseChatModel\n    from langchain_core.messages import (\n        BaseMessage,\n        AIMessage,\n        HumanMessage,\n        SystemMessage,\n        FunctionMessage,\n        ToolMessage,\n        ToolCall,\n        AIMessageChunk,\n    )\n    from langchain_core.outputs import (\n        ChatResult,\n        ChatGeneration,\n        ChatGenerationChunk,\n    )\n    LANGCHAIN_AVAILABLE = True\nexcept (ImportError, OSError):\n    # Dummy classes for safe import\n    BaseChatModel = object\n    CallbackManagerForLLMRun = Any\n    BaseMessage = Any\n    ChatResult = Any\n    logger.warning(\"LangChain dependencies missing. CustomLangChainLLM will be disabled.\")\n\n\ndef _clean_json_schema(schema: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"\n    Remove a chave 'anyOf' de um dicion\u00e1rio JSON Schema, recursivamente.\n    A API Gemini n\u00e3o suporta 'anyOf' diretamente.\n    \"\"\"\n    cleaned_schema = {}\n    for key, value in schema.items():\n        if key == \"anyOf\":\n            # Ignorar 'anyOf' completamente\n            continue\n        elif isinstance(value, dict):\n            cleaned_schema[key] = _clean_json_schema(value)\n        elif isinstance(value, list):\n            cleaned_list = []\n            for item in value:\n                if isinstance(item, dict):\n                    cleaned_list.append(_clean_json_schema(item))\n                else:\n                    cleaned_list.append(item)\n            cleaned_schema[key] = cleaned_list\n        else:\n            cleaned_schema[key] = value\n    return cleaned_schema\n\n\nclass CustomLangChainLLM(BaseChatModel):\n    llm_adapter: BaseLLMAdapter\n    tools: Optional[List[Any]] = None # Adicionado para permitir o campo 'tools'\n\n    @property\n    def _llm_type(self) -> str:\n        return \"custom_llm\"\n\n    def __init__(self, llm_adapter: BaseLLMAdapter, **kwargs: Any):\n        if not LANGCHAIN_AVAILABLE:\n            raise ImportError(\"LangChain is not available.\")\n        super().__init__(llm_adapter=llm_adapter, **kwargs)\n\n    def bind_tools(\n        self,\n        tools: List[Any],\n        **kwargs: Any,\n    ) -> \"CustomLangChainLLM\":\n        \"\"\"Bind tools to the model.\"\"\"\n        if not LANGCHAIN_AVAILABLE:\n             raise ImportError(\"LangChain is not available.\")\n             \n        new_instance = self.__class__(llm_adapter=self.llm_adapter, **kwargs)\n        new_instance.tools = tools  # Store tools for _generate to access\n        return new_instance\n\n    def _generate(\n        self,\n        messages: List[BaseMessage],\n        stop: Optional[List[str]] = None,\n        run_manager: Optional[CallbackManagerForLLMRun] = None,\n        **kwargs: Any,\n    ) -> ChatResult:\n        if not LANGCHAIN_AVAILABLE:\n             raise ImportError(\"LangChain is not available.\")\n\n        # Convert LangChain messages to a generic dictionary format\n        # that GeminiLLMAdapter can understand (similar to OpenAI-like format)\n        generic_messages = []\n        for msg in messages:\n            if isinstance(msg, HumanMessage):\n                generic_messages.append({\"role\": \"user\", \"content\": msg.content})\n            elif isinstance(msg, AIMessage):\n                if msg.tool_calls:\n                    processed_tool_calls = []\n                    for tc in msg.tool_calls:\n                        tc_dict = tc if isinstance(tc, dict) else tc.dict()\n                        processed_tool_calls.append({\n                            \"id\": tc_dict.get(\"id\"),\n                            \"type\": \"function\",\n                            \"function\": {\n                                \"name\": tc_dict.get(\"name\"),\n                                \"arguments\": json.dumps(tc_dict.get(\"args\", {})),\n                            },\n                        })\n                    generic_messages.append(\n                        {\n                            \"role\": \"model\",\n                            \"content\": msg.content,\n                            \"tool_calls\": processed_tool_calls,\n                        }\n                    )\n                else:\n                    generic_messages.append(\n                        {\"role\": \"model\", \"content\": msg.content}\n                    )\n            elif isinstance(msg, SystemMessage):\n                # Treat SystemMessage as a user message for Gemini\n                generic_messages.append({\"role\": \"user\", \"content\": msg.content})\n            elif isinstance(msg,", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4714, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "58cde054-7542-4884-b924-0ef174006528": {"__data__": {"id_": "58cde054-7542-4884-b924-0ef174006528", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\llm_langchain_adapter.py", "language": "python", "lines": 294, "filename": "llm_langchain_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d219add8-5278-4d44-9b97-73c57038c907", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\llm_langchain_adapter.py", "language": "python", "lines": 294, "filename": "llm_langchain_adapter.py"}, "hash": "738b63f37d91c512632e4d2bf690393a40ecac60b3bbc8fb8d0c6b46c17be18f", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3c1998cd-03cc-43eb-ba3b-352de9c77dec", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\llm_langchain_adapter.py", "language": "python", "lines": 294, "filename": "llm_langchain_adapter.py"}, "hash": "556886f0c6a57df9530ea499a024f52639784989e84e17aa53a3771d17a0acc6", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "5c354231-7c0a-4949-a736-05d64b95f295", "node_type": "1", "metadata": {}, "hash": "78503a3083c6c3695cdb5b1b48641898c9e70e4fe78fa7082cb385d39c7feec3", "class_name": "RelatedNodeInfo"}}, "text": "tool_calls:\n                        tc_dict = tc if isinstance(tc, dict) else tc.dict()\n                        processed_tool_calls.append({\n                            \"id\": tc_dict.get(\"id\"),\n                            \"type\": \"function\",\n                            \"function\": {\n                                \"name\": tc_dict.get(\"name\"),\n                                \"arguments\": json.dumps(tc_dict.get(\"args\", {})),\n                            },\n                        })\n                    generic_messages.append(\n                        {\n                            \"role\": \"model\",\n                            \"content\": msg.content,\n                            \"tool_calls\": processed_tool_calls,\n                        }\n                    )\n                else:\n                    generic_messages.append(\n                        {\"role\": \"model\", \"content\": msg.content}\n                    )\n            elif isinstance(msg, SystemMessage):\n                # Treat SystemMessage as a user message for Gemini\n                generic_messages.append({\"role\": \"user\", \"content\": msg.content})\n            elif isinstance(msg, FunctionMessage):\n                # FunctionMessage is typically a tool response in LangChain\n                # Convert it to a user message with function_response for Gemini\n                generic_messages.append(\n                    {\n                        \"role\": \"user\",\n                        \"function_call\": { # This key is used by GeminiLLMAdapter to identify tool responses\n                            \"name\": msg.name, # The name of the tool that was called\n                            \"response\": {\"content\": str(msg.content)}\n                        }\n                    }\n                )\n            elif isinstance(msg, ToolMessage):\n                # ToolMessage is also a tool response in LangChain\n                # Convert it to a user message with function_response for Gemini\n\n                # Extract tool name from ToolMessage\n                tool_name = msg.name\n\n                # Fallback: if name is empty, try to extract from tool_call_id\n                if not tool_name or tool_name == \"\":\n                    if hasattr(msg, 'tool_call_id') and msg.tool_call_id:\n                        # tool_call_id format is typically \"call_<function_name>\"\n                        tool_name = msg.tool_call_id.replace(\"call_\", \"\")\n                    else:\n                        # Last resort: use a default name\n                        tool_name = \"unknown_tool\"\n\n                generic_messages.append(\n                    {\n                        \"role\": \"user\", # Tool responses are part of the user's turn\n                        \"function_call\": { # This key is used by GeminiLLMAdapter to identify tool responses\n                            \"name\": tool_name,  # The name of the tool that was called\n                            \"response\": {\"content\": str(msg.content)}\n                        }\n                    }\n                )\n            else:\n                raise ValueError(f\"Unsupported message type: {type(msg)}\")\n\n        # Check if tools were bound via bind_tools or passed directly in kwargs\n        tools_to_pass = getattr(self, 'tools', None) or kwargs.get(\"tools\")\n        if tools_to_pass:\n            generic_tools_declarations = []\n            for tool in tools_to_pass:\n                if hasattr(tool, 'name') and hasattr(tool, 'description') and hasattr(tool, 'args'):\n                    # LangChain's StructuredTool has 'name', 'description', and 'args'\n                    \n                    # Infer required parameters\n                    required_params = [\n                        param for param, details in tool.args.items() \n                        if details.get(\"default\") is None and details.get(\"type\") != \"null\"\n                    ]\n\n                    # Create a copy of tool.args and remove 'default' if it's causing issues\n                    processed_args = {}\n                    for param, details in tool.args.items():\n                        param_details = details.copy()\n                        if \"default\" in param_details:\n                            del param_details[\"default\"] # Remover a chave 'default'\n                        if \"title\" in param_details: # Remover a chave 'title'\n                            del param_details[\"title\"]\n                        processed_args[param] = param_details\n\n                    # Limpar o esquema de processed_args para remover 'anyOf'\n                    cleaned_processed_args = _clean_json_schema(processed_args)\n\n                    generic_tools_declarations.append(\n                        {\n                            \"name\": tool.name,\n                            \"description\": tool.description,\n                            \"parameters\": {\n                                \"type\": \"object\",\n                                \"properties\": cleaned_processed_args, # Usar cleaned_processed_args\n                                \"required\": required_params,\n                            },\n                        }\n                    )\n                elif isinstance(tool, dict) and \"name\" in tool and \"description\" in tool and \"parameters\" in tool:\n                    # If it's already a dictionary in the expected function declaration format\n                    generic_tools_declarations.append(tool)\n                else:\n                    # Fallback for other tool types or if the tool object is not fully formed\n                    print(f\"Warning: Unexpected tool format encountered: {type(tool)} - {tool}\")\n                    if hasattr(tool,", "mimetype": "text/plain", "start_char_idx": 3563, "end_char_idx": 9217, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5c354231-7c0a-4949-a736-05d64b95f295": {"__data__": {"id_": "5c354231-7c0a-4949-a736-05d64b95f295", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\llm_langchain_adapter.py", "language": "python", "lines": 294, "filename": "llm_langchain_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d219add8-5278-4d44-9b97-73c57038c907", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\llm_langchain_adapter.py", "language": "python", "lines": 294, "filename": "llm_langchain_adapter.py"}, "hash": "738b63f37d91c512632e4d2bf690393a40ecac60b3bbc8fb8d0c6b46c17be18f", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "58cde054-7542-4884-b924-0ef174006528", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\llm_langchain_adapter.py", "language": "python", "lines": 294, "filename": "llm_langchain_adapter.py"}, "hash": "84fc8f419414dc5b7e8631f1eccee60aa2423545a2cd5931e43f04318ab3cd80", "class_name": "RelatedNodeInfo"}}, "text": "append(\n                        {\n                            \"name\": tool.name,\n                            \"description\": tool.description,\n                            \"parameters\": {\n                                \"type\": \"object\",\n                                \"properties\": cleaned_processed_args, # Usar cleaned_processed_args\n                                \"required\": required_params,\n                            },\n                        }\n                    )\n                elif isinstance(tool, dict) and \"name\" in tool and \"description\" in tool and \"parameters\" in tool:\n                    # If it's already a dictionary in the expected function declaration format\n                    generic_tools_declarations.append(tool)\n                else:\n                    # Fallback for other tool types or if the tool object is not fully formed\n                    print(f\"Warning: Unexpected tool format encountered: {type(tool)} - {tool}\")\n                    if hasattr(tool, 'name') and hasattr(tool, 'description'):\n                         generic_tools_declarations.append(\n                                {\n                                    \"name\": tool.name,\n                                    \"description\": tool.description,\n                                    \"parameters\": {\"type\": \"object\", \"properties\": {}}, # Empty parameters\n                                }\n                        )\n                    else:\n                        raise ValueError(f\"Unsupported tool object: {tool}\")\n\n            # Gemini API expects a single list of function declarations under a 'function_declarations' key\n            tools_to_pass = {\"function_declarations\": generic_tools_declarations}\n        else:\n            tools_to_pass = None\n\n\n        llm_response = self.llm_adapter.get_completion(\n            messages=generic_messages, tools=tools_to_pass\n        )\n\n        if \"error\" in llm_response:\n            raise Exception(f\"LLM Adapter Error: {llm_response['error']}\")\n\n        content = llm_response.get(\"content\") or \"\"\n        tool_calls_data = llm_response.get(\"tool_calls\")\n\n        lc_tool_calls = []\n        if tool_calls_data:\n            for tc_data in tool_calls_data:\n                try:\n                    # tc_data is already a dictionary from GeminiLLMAdapter\n                    args = json.loads(tc_data[\"function\"][\"arguments\"])\n                except (json.JSONDecodeError, TypeError):\n                    args = {\n                        \"error\": \"Argumentos em formato JSON inv\u00e1lido\",\n                        \"received\": tc_data[\"function\"][\"arguments\"],\n                    }\n\n                lc_tool_calls.append(\n                    ToolCall(name=tc_data[\"function\"][\"name\"], args=args, id=tc_data[\"id\"])\n                )\n\n        ai_message = AIMessage(content=content, tool_calls=lc_tool_calls)\n\n        return ChatResult(generations=[ChatGeneration(message=ai_message)])\n\n    async def _agenerate(\n        self,\n        messages: List[BaseMessage],\n        stop: Optional[List[str]] = None,\n        run_manager: Optional[CallbackManagerForLLMRun] = None,\n        **kwargs: Any,\n    ) -> ChatResult:\n        raise NotImplementedError(\n            \"CustomLangChainLLM does not support async generation yet.\"\n        )\n\n    def _stream(\n        self,\n        messages: List[BaseMessage],\n        stop: Optional[List[str]] = None,\n        run_manager: Optional[CallbackManagerForLLMRun] = None,\n        **kwargs: Any,\n    ) -> ChatResult:\n        if not LANGCHAIN_AVAILABLE:\n             raise ImportError(\"LangChain is not available.\")\n             \n        chat_result = self._generate(messages, stop, run_manager, **kwargs)\n        generation = chat_result.generations[0]\n        ai_message = generation.message\n\n        message_chunk = AIMessageChunk(\n            content=ai_message.content, tool_calls=ai_message.tool_calls\n        )\n\n        yield ChatGenerationChunk(message=message_chunk)", "mimetype": "text/plain", "start_char_idx": 8222, "end_char_idx": 12177, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2b13ff52-7436-4cdc-917e-9f373f0bd070": {"__data__": {"id_": "2b13ff52-7436-4cdc-917e-9f373f0bd070", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ed2689ba-d0c1-4c1a-8f3c-a83131b7b4c8", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "hash": "efbc1376a75dd70cd46a9bb45098e3e9581f5e045f2a2287bbf8291b22bca196", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "51e52a81-64a3-4952-bd21-6d2837b42860", "node_type": "1", "metadata": {}, "hash": "d3aabb9f79c9d3cd3ea905853d8e888dfc0ef05d93f498382f60a3eddbd84b9f", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSistema de Logging Centralizado\nConfigura\u00e7\u00e3o completa de logs para o AgentBI Backend\n\"\"\"\nimport logging\nimport sys\nfrom datetime import datetime\nfrom pathlib import Path\nfrom typing import Any\nimport json\n\nfrom logging.handlers import RotatingFileHandler, TimedRotatingFileHandler\nimport structlog\n\n\nclass LogConfig:\n    \"\"\"Configura\u00e7\u00e3o centralizada de logging\"\"\"\n\n    # Diret\u00f3rios de logs\n    BASE_LOG_DIR = Path(\"logs\")\n    APP_LOG_DIR = BASE_LOG_DIR / \"app\"\n    API_LOG_DIR = BASE_LOG_DIR / \"api\"\n    SECURITY_LOG_DIR = BASE_LOG_DIR / \"security\"\n    CHAT_LOG_DIR = BASE_LOG_DIR / \"chat\"\n    ERROR_LOG_DIR = BASE_LOG_DIR / \"errors\"\n    AUDIT_LOG_DIR = BASE_LOG_DIR / \"audit\"\n\n    # Configura\u00e7\u00f5es de rota\u00e7\u00e3o\n    MAX_BYTES = 10 * 1024 * 1024  # 10 MB\n    BACKUP_COUNT = 10\n\n    # N\u00edveis de log por ambiente\n    LOG_LEVELS = {\n        \"development\": \"DEBUG\",\n        \"staging\": \"INFO\",\n        \"production\": \"WARNING\"\n    }\n\n    @classmethod\n    def setup_directories(cls):\n        \"\"\"Cria todos os diret\u00f3rios de logs necess\u00e1rios\"\"\"\n        for log_dir in [\n            cls.APP_LOG_DIR,\n            cls.API_LOG_DIR,\n            cls.SECURITY_LOG_DIR,\n            cls.CHAT_LOG_DIR,\n            cls.ERROR_LOG_DIR,\n            cls.AUDIT_LOG_DIR\n        ]:\n            log_dir.mkdir(parents=True, exist_ok=True)\n\n\nclass JSONFormatter(logging.Formatter):\n    \"\"\"Formatter que gera logs em formato JSON estruturado\"\"\"\n\n    def format(self, record: logging.LogRecord) -> str:\n        log_data = {\n            \"timestamp\": datetime.utcnow().isoformat(),\n            \"level\": record.levelname,\n            \"logger\": record.name,\n            \"message\": record.getMessage(),\n            \"module\": record.module,\n            \"function\": record.funcName,\n            \"line\": record.lineno,\n        }\n\n        # Adiciona informa\u00e7\u00f5es extras se dispon\u00edveis\n        if hasattr(record, \"user_id\"):\n            log_data[\"user_id\"] = record.user_id\n        if hasattr(record, \"request_id\"):\n            log_data[\"request_id\"] = record.request_id\n        if hasattr(record, \"ip_address\"):\n            log_data[\"ip_address\"] = record.ip_address\n        if hasattr(record, \"endpoint\"):\n            log_data[\"endpoint\"] = record.endpoint\n        if hasattr(record, \"method\"):\n            log_data[\"method\"] = record.method\n        if hasattr(record, \"status_code\"):\n            log_data[\"status_code\"] = record.status_code\n        if hasattr(record, \"duration\"):\n            log_data[\"duration\"] = record.duration\n\n        # Adiciona exception info se presente\n        if record.exc_info:\n            log_data[\"exception\"] = self.formatException(record.exc_info)\n\n        # Adiciona stack info se presente\n        if hasattr(record, \"stack_info\") and record.stack_info:\n            log_data[\"stack_info\"] = record.stack_info\n\n        return json.dumps(log_data, ensure_ascii=False)\n\n\nclass ColoredConsoleFormatter(logging.Formatter):\n    \"\"\"Formatter com cores para console (development)\"\"\"\n\n    COLORS = {\n        'DEBUG': '\\033[36m',      # Cyan\n        'INFO': '\\033[32m',       # Green\n        'WARNING': '\\033[33m',    # Yellow\n        'ERROR': '\\033[31m',      # Red\n        'CRITICAL': '\\033[35m',   # Magenta\n    }\n    RESET = '\\033[0m'\n\n    def format(self, record: logging.LogRecord) -> str:\n        color = self.COLORS.get(record.levelname, self.RESET)\n        record.levelname = f\"{color}{record.levelname}{self.RESET}\"\n        return super().format(record)\n\n\ndef get_file_handler(\n    filename: Path,\n    level: int = logging.INFO,\n    max_bytes: int = LogConfig.MAX_BYTES,\n    backup_count: int = LogConfig.BACKUP_COUNT,\n    use_json: bool = True\n) -> RotatingFileHandler:\n    \"\"\"Cria um handler rotativo para arquivo\"\"\"\n    handler = RotatingFileHandler(\n        filename=filename,\n        maxBytes=max_bytes,\n        backupCount=backup_count,\n        encoding='utf-8'\n    )\n    handler.setLevel(level)\n\n    if use_json:\n        handler.setFormatter(JSONFormatter())\n    else:\n        handler.setFormatter(\n            logging.Formatter(\n                '%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n                datefmt='%Y-%m-%d %H:%M:%S'\n            )\n        )\n\n    return handler", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4190, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "51e52a81-64a3-4952-bd21-6d2837b42860": {"__data__": {"id_": "51e52a81-64a3-4952-bd21-6d2837b42860", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ed2689ba-d0c1-4c1a-8f3c-a83131b7b4c8", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "hash": "efbc1376a75dd70cd46a9bb45098e3e9581f5e045f2a2287bbf8291b22bca196", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2b13ff52-7436-4cdc-917e-9f373f0bd070", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "hash": "82821470289099a3cd3b3ee05a5579142272f2aab4db6bbbe1ce12aaeed62397", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "8fa2d30a-64d6-4ca9-ae85-29ac05dc7189", "node_type": "1", "metadata": {}, "hash": "d0ec87cee44d855db921ae42c46a0fedd5162276a5c745c31f431cfaff043ebe", "class_name": "RelatedNodeInfo"}}, "text": "def get_file_handler(\n    filename: Path,\n    level: int = logging.INFO,\n    max_bytes: int = LogConfig.MAX_BYTES,\n    backup_count: int = LogConfig.BACKUP_COUNT,\n    use_json: bool = True\n) -> RotatingFileHandler:\n    \"\"\"Cria um handler rotativo para arquivo\"\"\"\n    handler = RotatingFileHandler(\n        filename=filename,\n        maxBytes=max_bytes,\n        backupCount=backup_count,\n        encoding='utf-8'\n    )\n    handler.setLevel(level)\n\n    if use_json:\n        handler.setFormatter(JSONFormatter())\n    else:\n        handler.setFormatter(\n            logging.Formatter(\n                '%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n                datefmt='%Y-%m-%d %H:%M:%S'\n            )\n        )\n\n    return handler\n\n\ndef get_timed_file_handler(\n    filename: Path,\n    level: int = logging.INFO,\n    when: str = 'midnight',\n    interval: int = 1,\n    backup_count: int = 30,\n    use_json: bool = True\n) -> TimedRotatingFileHandler:\n    \"\"\"Cria um handler com rota\u00e7\u00e3o por tempo\"\"\"\n    handler = TimedRotatingFileHandler(\n        filename=filename,\n        when=when,\n        interval=interval,\n        backupCount=backup_count,\n        encoding='utf-8'\n    )\n    handler.setLevel(level)\n\n    if use_json:\n        handler.setFormatter(JSONFormatter())\n    else:\n        handler.setFormatter(\n            logging.Formatter(\n                '%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n                datefmt='%Y-%m-%d %H:%M:%S'\n            )\n        )\n\n    return handler\n\n\ndef get_console_handler(level: int = logging.DEBUG, colored: bool = True) -> logging.StreamHandler:\n    \"\"\"Cria um handler para console\"\"\"\n    handler = logging.StreamHandler(sys.stdout)\n    handler.setLevel(level)\n\n    if colored:\n        handler.setFormatter(\n            ColoredConsoleFormatter(\n                '%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n                datefmt='%Y-%m-%d %H:%M:%S'\n            )\n        )\n    else:\n        handler.setFormatter(\n            logging.Formatter(\n                '%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n                datefmt='%Y-%m-%d %H:%M:%S'\n            )\n        )\n\n    return handler\n\n\ndef setup_logger(\n    name: str,\n    log_file: Path | None = None,\n    level: int = logging.INFO,\n    console: bool = True,\n    use_json: bool = False\n) -> logging.Logger:\n    \"\"\"\n    Configura um logger espec\u00edfico\n\n    Args:\n        name: Nome do logger\n        log_file: Caminho do arquivo de log (opcional)\n        level: N\u00edvel de log\n        console: Se deve mostrar logs no console\n        use_json: Se deve usar formato JSON\n\n    Returns:\n        Logger configurado\n    \"\"\"\n    logger = logging.getLogger(name)\n    logger.setLevel(level)\n    logger.handlers.clear()  # Remove handlers existentes\n\n    # Handler de console\n    if console:\n        logger.addHandler(get_console_handler(level, colored=True))\n\n    # Handler de arquivo\n    if log_file:\n        logger.addHandler(get_file_handler(log_file, level, use_json=use_json))\n\n    logger.propagate = False\n    return logger\n\n\ndef configure_structlog(environment: str = \"development\"):\n    \"\"\"\n    Configura structlog para logging estruturado\n\n    Args:\n        environment: Ambiente de execu\u00e7\u00e3o (development, staging, production)\n    \"\"\"\n    processors = [\n        structlog.stdlib.add_logger_name,\n        structlog.stdlib.add_log_level,\n        structlog.processors.TimeStamper(fmt=\"iso\"),\n        structlog.processors.StackInfoRenderer(),\n        structlog.processors.format_exc_info,\n        structlog.processors.UnicodeDecoder(),\n    ]\n\n    # Em desenvolvimento, usa console renderer colorido\n    # Em produ\u00e7\u00e3o, usa JSON renderer\n    if environment == \"development\":\n        processors.append(structlog.dev.ConsoleRenderer(colors=True))\n    else:\n        processors.append(structlog.processors.JSONRenderer())\n\n    structlog.configure(\n        processors=processors,\n        logger_factory=structlog.stdlib.LoggerFactory(),\n        wrapper_class=structlog.stdlib.BoundLogger,\n        cache_logger_on_first_use=True,\n    )", "mimetype": "text/plain", "start_char_idx": 3450, "end_char_idx": 7516, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8fa2d30a-64d6-4ca9-ae85-29ac05dc7189": {"__data__": {"id_": "8fa2d30a-64d6-4ca9-ae85-29ac05dc7189", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ed2689ba-d0c1-4c1a-8f3c-a83131b7b4c8", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "hash": "efbc1376a75dd70cd46a9bb45098e3e9581f5e045f2a2287bbf8291b22bca196", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "51e52a81-64a3-4952-bd21-6d2837b42860", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "hash": "b0a1eb2329b7583f074171ddaa9660c2bb62c9b060ebe9dc1fb9b4ddc985b1ee", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "567182dd-c3fa-4aee-8d59-d04b12f43a0f", "node_type": "1", "metadata": {}, "hash": "99437e97519ee2e772352da51415964da4794fb00bb260ac74c63af92bb926de", "class_name": "RelatedNodeInfo"}}, "text": "def setup_application_logging(environment: str = \"development\"):\n    \"\"\"\n    Configura todo o sistema de logging da aplica\u00e7\u00e3o\n\n    Args:\n        environment: Ambiente de execu\u00e7\u00e3o\n    \"\"\"\n    # Cria diret\u00f3rios\n    LogConfig.setup_directories()\n\n    # Configura structlog\n    configure_structlog(environment)\n\n    # N\u00edvel base de log baseado no ambiente\n    base_level = getattr(logging, LogConfig.LOG_LEVELS.get(environment, \"INFO\"))\n\n    # Logger principal da aplica\u00e7\u00e3o\n    app_logger = setup_logger(\n        \"agentbi\",\n        log_file=LogConfig.APP_LOG_DIR / \"app.log\",\n        level=base_level,\n        console=True,\n        use_json=(environment != \"development\")\n    )\n\n    # Logger de API\n    api_logger = setup_logger(\n        \"agentbi.api\",\n        log_file=LogConfig.API_LOG_DIR / \"api.log\",\n        level=logging.INFO,\n        console=(environment == \"development\"),\n        use_json=(environment != \"development\")\n    )\n\n    # Logger de seguran\u00e7a\n    security_logger = setup_logger(\n        \"agentbi.security\",\n        log_file=LogConfig.SECURITY_LOG_DIR / \"security.log\",\n        level=logging.INFO,\n        console=True,\n        use_json=True  # Sempre JSON para an\u00e1lise de seguran\u00e7a\n    )\n\n    # Logger de chat/conversas\n    chat_logger = setup_logger(\n        \"agentbi.chat\",\n        log_file=LogConfig.CHAT_LOG_DIR / \"chat.log\",\n        level=logging.INFO,\n        console=(environment == \"development\"),\n        use_json=True\n    )\n\n    # Logger de erros (todos os erros v\u00e3o aqui tamb\u00e9m)\n    error_logger = setup_logger(\n        \"agentbi.errors\",\n        log_file=LogConfig.ERROR_LOG_DIR / \"errors.log\",\n        level=logging.ERROR,\n        console=True,\n        use_json=True\n    )\n\n    # Logger de auditoria\n    audit_logger = setup_logger(\n        \"agentbi.audit\",\n        log_file=LogConfig.AUDIT_LOG_DIR / \"audit.log\",\n        level=logging.INFO,\n        console=False,\n        use_json=True  # Sempre JSON para an\u00e1lise de auditoria\n    )\n\n    # Configura handler de erros global para capturar tudo\n    root_logger = logging.getLogger()\n    root_logger.setLevel(base_level)\n\n    # Remove handlers padr\u00e3o\n    root_logger.handlers.clear()\n\n    # Adiciona handlers\n    if environment == \"development\":\n        root_logger.addHandler(get_console_handler(base_level, colored=True))\n\n    # Adiciona handler de arquivo para erros cr\u00edticos\n    root_logger.addHandler(\n        get_file_handler(\n            LogConfig.ERROR_LOG_DIR / \"critical.log\",\n            level=logging.ERROR,\n            use_json=True\n        )\n    )\n\n    return {\n        \"app\": app_logger,\n        \"api\": api_logger,\n        \"security\": security_logger,\n        \"chat\": chat_logger,\n        \"errors\": error_logger,\n        \"audit\": audit_logger,\n    }\n\n\n# Fun\u00e7\u00f5es auxiliares para logging espec\u00edfico\n\ndef log_api_request(\n    logger: logging.Logger,\n    method: str,\n    endpoint: str,\n    user_id: str | None = None,\n    ip_address: str | None = None,\n    request_id: str | None = None,\n    **kwargs\n):\n    \"\"\"Log de requisi\u00e7\u00e3o API\"\"\"\n    extra = {\n        \"method\": method,\n        \"endpoint\": endpoint,\n        \"user_id\": user_id,\n        \"ip_address\": ip_address,\n        \"request_id\": request_id,\n        **kwargs\n    }\n    logger.info(f\"API Request: {method} {endpoint}\", extra=extra)\n\n\ndef log_api_response(\n    logger: logging.Logger,\n    method: str,\n    endpoint: str,\n    status_code: int,\n    duration: float,\n    user_id: str | None = None,\n    request_id: str | None = None,\n    **kwargs\n):\n    \"\"\"Log de resposta API\"\"\"\n    extra = {\n        \"method\": method,\n        \"endpoint\": endpoint,\n        \"status_code\": status_code,\n        \"duration\": duration,\n        \"user_id\": user_id,\n        \"request_id\": request_id,\n        **kwargs\n    }\n\n    if status_code >= 500:\n        logger.error(f\"API Response: {method} {endpoint} - {status_code}\", extra=extra)\n    elif status_code >= 400:\n        logger.warning(f\"API Response: {method} {endpoint} - {status_code}\", extra=extra)\n    else:\n        logger.info(f\"API Response: {method} {endpoint} - {status_code}\", extra=extra)", "mimetype": "text/plain", "start_char_idx": 7519, "end_char_idx": 11593, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "567182dd-c3fa-4aee-8d59-d04b12f43a0f": {"__data__": {"id_": "567182dd-c3fa-4aee-8d59-d04b12f43a0f", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ed2689ba-d0c1-4c1a-8f3c-a83131b7b4c8", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "hash": "efbc1376a75dd70cd46a9bb45098e3e9581f5e045f2a2287bbf8291b22bca196", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8fa2d30a-64d6-4ca9-ae85-29ac05dc7189", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}, "hash": "5d77d890b8469d7113c1e07004265d19e81e63cc6ca55ffba943ede09e715d86", "class_name": "RelatedNodeInfo"}}, "text": "def log_security_event(\n    logger: logging.Logger,\n    event_type: str,\n    user_id: str | None = None,\n    ip_address: str | None = None,\n    details: dict[str, Any] | None = None,\n    success: bool = True\n):\n    \"\"\"Log de evento de seguran\u00e7a\"\"\"\n    extra = {\n        \"event_type\": event_type,\n        \"user_id\": user_id,\n        \"ip_address\": ip_address,\n        \"success\": success,\n        \"details\": details or {}\n    }\n\n    if success:\n        logger.info(f\"Security Event: {event_type}\", extra=extra)\n    else:\n        logger.warning(f\"Security Event Failed: {event_type}\", extra=extra)\n\n\ndef log_audit_event(\n    logger: logging.Logger,\n    action: str,\n    user_id: str,\n    resource: str,\n    resource_id: str | None = None,\n    changes: dict[str, Any] | None = None,\n    ip_address: str | None = None\n):\n    \"\"\"Log de evento de auditoria\"\"\"\n    extra = {\n        \"action\": action,\n        \"user_id\": user_id,\n        \"resource\": resource,\n        \"resource_id\": resource_id,\n        \"changes\": changes or {},\n        \"ip_address\": ip_address\n    }\n    logger.info(f\"Audit: {action} on {resource}\", extra=extra)\n\n\ndef log_chat_interaction(\n    logger: logging.Logger,\n    user_id: str,\n    message: str,\n    response: str | None = None,\n    tokens_used: int | None = None,\n    duration: float | None = None,\n    model: str | None = None\n):\n    \"\"\"Log de intera\u00e7\u00e3o de chat\"\"\"\n    extra = {\n        \"user_id\": user_id,\n        \"message_preview\": message[:100] + \"...\" if len(message) > 100 else message,\n        \"response_preview\": (response[:100] + \"...\" if response and len(response) > 100 else response) if response else None,\n        \"tokens_used\": tokens_used,\n        \"duration\": duration,\n        \"model\": model\n    }\n    logger.info(f\"Chat interaction from user {user_id}\", extra=extra)", "mimetype": "text/plain", "start_char_idx": 11596, "end_char_idx": 13398, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "76f6aa2f-759a-49df-b79b-4d6f82738653": {"__data__": {"id_": "76f6aa2f-759a-49df-b79b-4d6f82738653", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\logging_middleware.py", "language": "python", "lines": 302, "filename": "logging_middleware.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6b927665-04e0-4bc1-859c-44b86808361c", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\logging_middleware.py", "language": "python", "lines": 302, "filename": "logging_middleware.py"}, "hash": "8f2ed7b39f9783213df1a6ee55342a142f09165a9f4163b00f32abd97f37e640", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "4d477748-3e63-4f44-8ef4-2fad1938f8fd", "node_type": "1", "metadata": {}, "hash": "f67d3ecfa30ece748ae2431fbcea131e6985bd2f503dba8fcb93f49118db646b", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nMiddleware de Logging para FastAPI\nCaptura e registra todas as requisi\u00e7\u00f5es e respostas HTTP\n\"\"\"\nimport time\nimport uuid\nfrom typing import Callable\n\nimport structlog\nfrom fastapi import Request, Response\nfrom starlette.middleware.base import BaseHTTPMiddleware\nfrom starlette.types import ASGIApp\n\nfrom .logging_config import log_api_request, log_api_response\n\n\nclass RequestLoggingMiddleware(BaseHTTPMiddleware):\n    \"\"\"\n    Middleware que registra todas as requisi\u00e7\u00f5es HTTP\n    com informa\u00e7\u00f5es detalhadas e m\u00e9tricas de performance\n    \"\"\"\n\n    def __init__(self, app: ASGIApp, logger_name: str = \"agentbi.api\"):\n        super().__init__(app)\n        self.logger = structlog.get_logger(logger_name)\n\n    async def dispatch(self, request: Request, call_next: Callable) -> Response:\n        # Gera um ID \u00fanico para a requisi\u00e7\u00e3o\n        request_id = str(uuid.uuid4())\n        request.state.request_id = request_id\n\n        # Extrai informa\u00e7\u00f5es da requisi\u00e7\u00e3o\n        method = request.method\n        url = str(request.url)\n        path = request.url.path\n        client_host = request.client.host if request.client else None\n        user_agent = request.headers.get(\"user-agent\", \"unknown\")\n\n        # Extrai user_id se dispon\u00edvel (do token JWT)\n        user_id = None\n        if hasattr(request.state, \"user\"):\n            user_id = getattr(request.state.user, \"id\", None)\n\n        # Log da requisi\u00e7\u00e3o\n        self.logger.info(\n            \"request_started\",\n            request_id=request_id,\n            method=method,\n            url=url,\n            path=path,\n            client_host=client_host,\n            user_agent=user_agent,\n            user_id=user_id,\n        )\n\n        # Timestamp de in\u00edcio\n        start_time = time.time()\n\n        # Processa a requisi\u00e7\u00e3o\n        try:\n            response = await call_next(request)\n\n            # Calcula dura\u00e7\u00e3o\n            duration = time.time() - start_time\n\n            # Log da resposta\n            self.logger.info(\n                \"request_completed\",\n                request_id=request_id,\n                method=method,\n                path=path,\n                status_code=response.status_code,\n                duration=f\"{duration:.3f}s\",\n                duration_ms=f\"{duration * 1000:.0f}ms\",\n                user_id=user_id,\n            )\n\n            # Adiciona headers de debug\n            response.headers[\"X-Request-ID\"] = request_id\n            response.headers[\"X-Response-Time\"] = f\"{duration * 1000:.0f}ms\"\n\n            return response\n\n        except Exception as exc:\n            # Calcula dura\u00e7\u00e3o at\u00e9 o erro\n            duration = time.time() - start_time\n            \n            # Tratar erros de desconex\u00e3o/stream de forma graciosa\n            error_msg = str(exc)\n            if \"No response returned\" in error_msg or \"EndOfStream\" in type(exc).__name__:\n                self.logger.warning(\n                    \"client_disconnected\",\n                    path=path,\n                    duration=f\"{duration:.3f}s\",\n                    error=error_msg\n                )\n                # N\u00e3o relan\u00e7ar para evitar polui\u00e7\u00e3o de logs de erro, pois \u00e9 um cancelamento do cliente\n                return Response(content=\"Client disconnected\", status_code=499)\n\n            # Log do erro\n            self.logger.error(\n                \"request_failed\",\n                request_id=request_id,\n                method=method,\n                path=path,\n                error=error_msg,\n                error_type=type(exc).__name__,\n                duration=f\"{duration:.3f}s\",\n                user_id=user_id,\n                exc_info=True,\n            )\n\n            # Re-lan\u00e7a a exce\u00e7\u00e3o para ser tratada pelos handlers\n            raise\n\n\nclass PerformanceLoggingMiddleware(BaseHTTPMiddleware):\n    \"\"\"\n    Middleware que registra m\u00e9tricas de performance\n    e identifica requisi\u00e7\u00f5es lentas\n    \"\"\"\n\n    def __init__(\n        self,\n        app: ASGIApp,\n        slow_request_threshold: float = 1.0,  # segundos\n        logger_name: str = \"agentbi.performance\"\n    ):\n        super().__init__(app)\n        self.slow_request_threshold = slow_request_threshold\n        self.logger = structlog.get_logger(logger_name)\n\n    async def dispatch(self, request: Request, call_next: Callable) -> Response:\n        start_time = time.time()\n\n        response = await call_next(request)\n\n        duration = time.time() - start_time\n\n        # Log de requisi\u00e7\u00f5es lentas\n        if duration > self.slow_request_threshold:\n            self.logger.warning(\n                \"slow_request_detected\",\n                method=request.method,\n                path=request.url.path,\n                duration=f\"{duration:.3f}s\",\n                threshold=f\"{self.slow_request_threshold}s\",\n                status_code=response.status_code,\n            )\n\n        return response", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4827, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "4d477748-3e63-4f44-8ef4-2fad1938f8fd": {"__data__": {"id_": "4d477748-3e63-4f44-8ef4-2fad1938f8fd", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\logging_middleware.py", "language": "python", "lines": 302, "filename": "logging_middleware.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6b927665-04e0-4bc1-859c-44b86808361c", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\logging_middleware.py", "language": "python", "lines": 302, "filename": "logging_middleware.py"}, "hash": "8f2ed7b39f9783213df1a6ee55342a142f09165a9f4163b00f32abd97f37e640", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "76f6aa2f-759a-49df-b79b-4d6f82738653", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\logging_middleware.py", "language": "python", "lines": 302, "filename": "logging_middleware.py"}, "hash": "a6196c2b8084984976628107275bfc58eba33ede151f86cbbef2b39a933dec39", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f9c8d3ae-dcb5-4d7b-af46-16b9f50b7142", "node_type": "1", "metadata": {}, "hash": "cb6aa35226def3d7139be7dcfc1a96d276d3fbca0cca27a12a0323b185135199", "class_name": "RelatedNodeInfo"}}, "text": "class SecurityLoggingMiddleware(BaseHTTPMiddleware):\n    \"\"\"\n    Middleware que registra eventos de seguran\u00e7a\n    como tentativas de autentica\u00e7\u00e3o, acessos negados, etc.\n    \"\"\"\n\n    def __init__(self, app: ASGIApp, logger_name: str = \"agentbi.security\"):\n        super().__init__(app)\n        self.logger = structlog.get_logger(logger_name)\n\n    async def dispatch(self, request: Request, call_next: Callable) -> Response:\n        # Paths que devem ser monitorados para seguran\u00e7a\n        security_paths = [\"/auth\", \"/login\", \"/admin\"]\n        path = request.url.path\n\n        # Verifica se \u00e9 uma rota de seguran\u00e7a\n        is_security_route = any(sec_path in path for sec_path in security_paths)\n\n        response = await call_next(request)\n\n        # Log de eventos de seguran\u00e7a\n        if is_security_route:\n            client_host = request.client.host if request.client else \"unknown\"\n\n            # Log de tentativas de autentica\u00e7\u00e3o\n            if \"/auth\" in path or \"/login\" in path:\n                if response.status_code == 200:\n                    self.logger.info(\n                        \"authentication_success\",\n                        path=path,\n                        client_host=client_host,\n                        user_agent=request.headers.get(\"user-agent\"),\n                    )\n                elif response.status_code == 401:\n                    self.logger.warning(\n                        \"authentication_failed\",\n                        path=path,\n                        client_host=client_host,\n                        user_agent=request.headers.get(\"user-agent\"),\n                    )\n\n            # Log de acessos negados\n            elif response.status_code == 403:\n                self.logger.warning(\n                    \"access_denied\",\n                    path=path,\n                    client_host=client_host,\n                    method=request.method,\n                )\n\n            # Log de recursos n\u00e3o encontrados (poss\u00edvel scan)\n            elif response.status_code == 404 and \"/admin\" in path:\n                self.logger.warning(\n                    \"admin_path_not_found\",\n                    path=path,\n                    client_host=client_host,\n                    method=request.method,\n                )\n\n        return response\n\n\nclass AuditLoggingMiddleware(BaseHTTPMiddleware):\n    \"\"\"\n    Middleware que registra a\u00e7\u00f5es de auditoria\n    para opera\u00e7\u00f5es de escrita (POST, PUT, DELETE, PATCH)\n    \"\"\"\n\n    def __init__(self, app: ASGIApp, logger_name: str = \"agentbi.audit\"):\n        super().__init__(app)\n        self.logger = structlog.get_logger(logger_name)\n        self.audit_methods = {\"POST\", \"PUT\", \"DELETE\", \"PATCH\"}\n\n    async def dispatch(self, request: Request, call_next: Callable) -> Response:\n        # S\u00f3 audita m\u00e9todos de escrita\n        if request.method in self.audit_methods:\n            path = request.url.path\n            client_host = request.client.host if request.client else \"unknown\"\n\n            # Extrai user_id se dispon\u00edvel\n            user_id = None\n            if hasattr(request.state, \"user\"):\n                user_id = getattr(request.state.user, \"id\", None)\n\n            # Processa a requisi\u00e7\u00e3o\n            response = await call_next(request)\n\n            # Log de auditoria\n            if response.status_code in [200, 201, 204]:\n                self.logger.info(\n                    \"audit_action\",\n                    method=request.method,\n                    path=path,\n                    user_id=user_id,\n                    client_host=client_host,\n                    status_code=response.status_code,\n                    timestamp=time.time(),\n                )\n\n            return response\n        else:\n            return await call_next(request)", "mimetype": "text/plain", "start_char_idx": 4830, "end_char_idx": 8581, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f9c8d3ae-dcb5-4d7b-af46-16b9f50b7142": {"__data__": {"id_": "f9c8d3ae-dcb5-4d7b-af46-16b9f50b7142", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\logging_middleware.py", "language": "python", "lines": 302, "filename": "logging_middleware.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6b927665-04e0-4bc1-859c-44b86808361c", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\logging_middleware.py", "language": "python", "lines": 302, "filename": "logging_middleware.py"}, "hash": "8f2ed7b39f9783213df1a6ee55342a142f09165a9f4163b00f32abd97f37e640", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "4d477748-3e63-4f44-8ef4-2fad1938f8fd", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\logging_middleware.py", "language": "python", "lines": 302, "filename": "logging_middleware.py"}, "hash": "0608cf6aaa3c89f3b213fc3e475d3019a8602e20910c380f4b2792a29fdbb17e", "class_name": "RelatedNodeInfo"}}, "text": "class ErrorLoggingMiddleware(BaseHTTPMiddleware):\n    \"\"\"\n    Middleware que captura e registra todos os erros\n    \"\"\"\n\n    def __init__(self, app: ASGIApp, logger_name: str = \"agentbi.errors\"):\n        super().__init__(app)\n        self.logger = structlog.get_logger(logger_name)\n\n    async def dispatch(self, request: Request, call_next: Callable) -> Response:\n        try:\n            response = await call_next(request)\n\n            # Log de erros HTTP (4xx e 5xx)\n            if response.status_code >= 400:\n                severity = \"error\" if response.status_code >= 500 else \"warning\"\n\n                log_method = getattr(self.logger, severity)\n                try:\n                    log_method(\n                        \"http_error\",\n                        method=request.method,\n                        path=request.url.path,\n                        status_code=response.status_code,\n                        client_host=request.client.host if request.client else \"unknown\",\n                    )\n                except Exception as log_err:\n                    # Fallback simple print if structured logging fails\n                    print(f\"LOGGING ERROR: {log_err} (Original error status: {response.status_code})\")\n\n            return response\n\n        except Exception as exc:\n            # Log de exce\u00e7\u00f5es n\u00e3o tratadas\n            self.logger.error(\n                \"unhandled_exception\",\n                method=request.method,\n                path=request.url.path,\n                error=str(exc),\n                error_type=type(exc).__name__,\n                client_host=request.client.host if request.client else \"unknown\",\n                exc_info=True,\n            )\n            raise", "mimetype": "text/plain", "start_char_idx": 8584, "end_char_idx": 10291, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d3ea2e15-f174-4527-8ae5-8a34d7ae1537": {"__data__": {"id_": "d3ea2e15-f174-4527-8ae5-8a34d7ae1537", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\parquet_cache.py", "language": "python", "lines": 128, "filename": "parquet_cache.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4c40bf77-29a3-48b9-b9bc-79cd209fb5f4", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\parquet_cache.py", "language": "python", "lines": 128, "filename": "parquet_cache.py"}, "hash": "9e4867a994f508e9792a967141bbcd70c6aff165dc2d7382e9436ed53136e30a", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nParquet Cache System with LRU eviction policy\nMaintains up to 5 Parquet DataFrames in memory (~500 MB max)\nThread-safe for concurrent access\n\"\"\"\n\nfrom collections import OrderedDict\nfrom pathlib import Path\nimport polars as pl\nimport threading\nimport logging\n\nlogger = logging.getLogger(__name__)\n\n\nclass ParquetCache:\n    \"\"\"\n    Thread-safe LRU cache for Parquet DataFrames\n    Singleton pattern ensures single cache instance across the application\n    \"\"\"\n    _instance = None\n    _lock = threading.Lock()\n\n    def __new__(cls):\n        if cls._instance is None:\n            with cls._lock:\n                if cls._instance is None:\n                    cls._instance = super().__new__(cls)\n                    cls._instance._cache = OrderedDict()\n                    cls._instance._max_size = 5  # Max 5 Parquets (~500 MB total)\n        return cls._instance\n\n    def get_dataframe(self, parquet_name: str) -> pl.DataFrame:\n        \"\"\"\n        Get DataFrame from cache or load from disk\n\n        Args:\n            parquet_name: Name of the parquet file (e.g., \"admmat.parquet\")\n\n        Returns:\n            pl.DataFrame: Cached or freshly loaded DataFrame\n\n        Raises:\n            FileNotFoundError: If parquet file doesn't exist\n        \"\"\"\n        with self._lock:\n            # Cache hit - move to end (most recently used)\n            if parquet_name in self._cache:\n                logger.info(f\"\u2705 Cache HIT: {parquet_name}\")\n                self._cache.move_to_end(parquet_name)\n                return self._cache[parquet_name]\n\n            # Cache miss - load from disk\n            logger.info(f\"\u26a0\ufe0f  Cache MISS: {parquet_name} - Loading from disk...\")\n            df = self._load_parquet(parquet_name)\n\n            # Add to cache\n            self._cache[parquet_name] = df\n            logger.info(f\"\u2705 Loaded {parquet_name}: {len(df):,} rows \u00d7 {len(df.columns)} columns\")\n\n            # Evict least recently used if exceeding limit\n            if len(self._cache) > self._max_size:\n                evicted_key, evicted_df = self._cache.popitem(last=False)\n                logger.warning(f\"\ud83d\uddd1\ufe0f  Cache EVICT: {evicted_key} (LRU policy - {len(evicted_df):,} rows freed)\")\n\n            return df\n\n    def _load_parquet(self, parquet_name: str) -> pl.DataFrame:\n        \"\"\"\n        Load Parquet file from disk (hybrid Docker/Dev path support)\n\n        Args:\n            parquet_name: Name of the parquet file\n\n        Returns:\n            pl.DataFrame: Loaded DataFrame\n\n        Raises:\n            FileNotFoundError: If file not found in any location\n        \"\"\"\n        # Try Docker path first\n        docker_path = Path(f\"/app/data/parquet/{parquet_name}\")\n\n        # Fallback to development path (backend/data/parquet)\n        dev_path = Path(__file__).parent.parent.parent / \"data\" / \"parquet\" / parquet_name\n\n        parquet_path = docker_path if docker_path.exists() else dev_path\n\n        if not parquet_path.exists():\n            raise FileNotFoundError(\n                f\"Parquet file not found: {parquet_name}\\n\"\n                f\"Tried paths:\\n\"\n                f\"  - Docker: {docker_path}\\n\"\n                f\"  - Dev: {dev_path}\"\n            )\n\n        # Otimiza\u00e7\u00e3o: usar streaming para arquivos grandes (> 100 MB)\n        # Isso carrega em chunks ao inv\u00e9s de tudo na mem\u00f3ria de uma vez\n        logger.info(f\"\ud83d\udcc2 Loading Parquet: {parquet_path}\")\n\n        # SEMPRE usar scan + collect(streaming=True) para arquivos Parquet grandes\n        # Isso usa menos mem\u00f3ria RAM ao processar em chunks\n        df = pl.scan_parquet(parquet_path).collect(streaming=True)\n\n        logger.info(f\"\u2705 Loaded {len(df):,} rows \u00d7 {len(df.columns)} columns\")\n        return df\n\n    def clear(self):\n        \"\"\"Clear cache (useful for testing or manual refresh)\"\"\"\n        with self._lock:\n            count = len(self._cache)\n            self._cache.clear()\n            logger.info(f\"\ud83e\uddf9 Cache cleared ({count} entries removed)\")\n\n    def get_cache_info(self) -> dict:\n        \"\"\"Get cache statistics\"\"\"\n        with self._lock:\n            return {\n                \"cached_files\": list(self._cache.keys()),\n                \"cache_size\": len(self._cache),\n                \"max_size\": self._max_size,\n                \"cache_utilization\": f\"{len(self._cache)}/{self._max_size}\"\n            }\n\n\n# Global singleton instance\ncache = ParquetCache()", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4340, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b3aa4d10-1fc0-42d6-8ff2-de40de46cc2d": {"__data__": {"id_": "b3aa4d10-1fc0-42d6-8ff2-de40de46cc2d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\query_processor.py", "language": "python", "lines": 151, "filename": "query_processor.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "04b40021-cc7f-49d7-bb90-87432bdc7a01", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\query_processor.py", "language": "python", "lines": 151, "filename": "query_processor.py"}, "hash": "f125aead0d2523af1bbd81234b220f3a4b8d0a423bb9ea5bb2b50bc30069ef25", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "bfe8d8e3-64ce-4474-802f-481be7b5cc94", "node_type": "1", "metadata": {}, "hash": "c7f82ed06e981c0779bdcc94a1084ba428f441a208bfc045226618743f934881", "class_name": "RelatedNodeInfo"}}, "text": "# core/query_processor.py\nimport logging\n\ntry:\n    from app.core.agents.supervisor_agent import SupervisorAgent\nexcept ImportError as e:\n    logging.getLogger(__name__).warning(f\"Failed to import SupervisorAgent: {e}\")\n    SupervisorAgent = None\n\nfrom app.core.factory.component_factory import ComponentFactory\nfrom app.core.llm_factory import LLMFactory\nfrom app.core.cache import Cache\n\n\nclass QueryProcessor:\n    \"\"\"\n    Ponto de entrada principal para o processamento de consultas.\n    Delega a tarefa para o SupervisorAgent para orquestra\u00e7\u00e3o.\n    \"\"\"\n\n    def __init__(self):\n        \"\"\"\n        Inicializa o processador de consultas e o agente supervisor.\n        \"\"\"\n        self.logger = logging.getLogger(__name__)\n        \n        # \u26a1 OTIMIZA\u00c7\u00c3O: Inicializar sistema de resposta r\u00e1pida (usando Polars diretamente)\n        try:\n            from app.core.tools.quick_response import create_quick_response_system\n            from app.core.parquet_cache import cache\n\n            # \u2705 Usar Polars DataFrame diretamente (sem convers\u00e3o para Pandas)\n            df_polars = cache.get_dataframe(\"admmat.parquet\")\n            self.quick_response = create_quick_response_system(df_polars)\n            self.logger.info(\"\u26a1 Quick Response System inicializado com Polars!\")\n        except Exception as e:\n            self.logger.warning(f\"Quick Response System n\u00e3o dispon\u00edvel: {e}\")\n            self.quick_response = None\n        \n        # Usar factory para obter adapter com fallback autom\u00e1tico\n        try:\n            self.llm_adapter = LLMFactory.get_adapter()\n            if SupervisorAgent:\n                self.supervisor = SupervisorAgent(gemini_adapter=self.llm_adapter)\n                self.logger.info(\n                    \"QueryProcessor inicializado e pronto para delegar ao SupervisorAgent.\"\n                )\n            else:\n                self.supervisor = None\n                self.logger.warning(\"SupervisorAgent n\u00e3o dispon\u00edvel (erro de importa\u00e7\u00e3o).\")\n                \n            self.cache = Cache()\n\n        except ValueError as e:\n            self.logger.error(f\"Erro ao inicializar QueryProcessor: {e}\")\n            self.llm_adapter = None\n            self.supervisor = None\n            self.cache = Cache()\n            raise RuntimeError(\n                \"GEMINI_API_KEY n\u00e3o configurada. Configure a chave da API do Google Gemini nos secrets do Streamlit Cloud.\"\n            ) from e\n\n    def process_query(self, query: str) -> dict:\n        \"\"\"\n        Processa a consulta do usu\u00e1rio, delegando-a diretamente ao SupervisorAgent.\n\n        Args:\n            query (str): A consulta do usu\u00e1rio.\n\n        Returns:\n            dict: O resultado do processamento pelo agente especialista apropriado.\n        \"\"\"\n        # \u2705 FASE 1: QUICK RESPONSE BYPASS (< 500ms)\n        # Responde queries simples SEM LLM (95% dos casos)\n        if self.quick_response:\n            quick_answer = self.quick_response.try_quick_response(query)\n            if quick_answer:\n                self.logger.info(f\"\u26a1 Quick Response! Tempo: < 500ms | Query: {query[:50]}\")\n                return {\"type\": \"text\", \"output\": quick_answer}\n\n        # Verificar se o supervisor foi inicializado\n        if self.supervisor is None:\n            return {\n                \"type\": \"text\",\n                \"output\": \"\u26a0\ufe0f **Sistema de Agentes Indispon\u00edvel**\\n\\nO Agente Supervisor n\u00e3o p\u00f4de ser inicializado (poss\u00edvel erro de importa\u00e7\u00e3o ou configura\u00e7\u00e3o). Apenas consultas simples (Quick Response) est\u00e3o dispon\u00edveis.\"\n            }\n\n        # Interceptar perguntas sobre o nome do agente\n        if query.lower() in [\"qual seu nome\", \"quem \u00e9 voc\u00ea\", \"qual o seu nome\"]:\n            return {\n                \"type\": \"text\",\n                \"output\": \"Eu sou um Agente de Neg\u00f3cios, pronto para ajudar com suas an\u00e1lises de dados.\"\n            }\n\n        cached_result = self.cache.get(query)\n        if cached_result:\n            self.logger.info(\n                f'Resultado recuperado do cache para a consulta: \"{query}\"'\n            )\n            return cached_result\n\n        self.logger.info(f'Delegando a consulta para o Supervisor: \"{query}\"')\n        result = self.supervisor.route_query(query)\n        self.cache.set(query, result)\n        return result\n\n    def stream_query(self, query: str):\n        \"\"\"\n        Processa a consulta do usu\u00e1rio com streaming de eventos do agente.\n\n        Args:\n            query (str): A consulta do usu\u00e1rio.\n\n        Yields:\n            dict: Eventos do agente (chunks de texto, a\u00e7\u00f5es, etc.)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4513, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "bfe8d8e3-64ce-4474-802f-481be7b5cc94": {"__data__": {"id_": "bfe8d8e3-64ce-4474-802f-481be7b5cc94", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\query_processor.py", "language": "python", "lines": 151, "filename": "query_processor.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "04b40021-cc7f-49d7-bb90-87432bdc7a01", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\query_processor.py", "language": "python", "lines": 151, "filename": "query_processor.py"}, "hash": "f125aead0d2523af1bbd81234b220f3a4b8d0a423bb9ea5bb2b50bc30069ef25", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b3aa4d10-1fc0-42d6-8ff2-de40de46cc2d", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\query_processor.py", "language": "python", "lines": 151, "filename": "query_processor.py"}, "hash": "8b91c0b79d812642289385884e26fd9e75c8097f54121a9138a263669e8a81d2", "class_name": "RelatedNodeInfo"}}, "text": "}\n\n        cached_result = self.cache.get(query)\n        if cached_result:\n            self.logger.info(\n                f'Resultado recuperado do cache para a consulta: \"{query}\"'\n            )\n            return cached_result\n\n        self.logger.info(f'Delegando a consulta para o Supervisor: \"{query}\"')\n        result = self.supervisor.route_query(query)\n        self.cache.set(query, result)\n        return result\n\n    def stream_query(self, query: str):\n        \"\"\"\n        Processa a consulta do usu\u00e1rio com streaming de eventos do agente.\n\n        Args:\n            query (str): A consulta do usu\u00e1rio.\n\n        Yields:\n            dict: Eventos do agente (chunks de texto, a\u00e7\u00f5es, etc.)\n        \"\"\"\n        # \u26a1 OTIMIZA\u00c7\u00c3O: Tentar resposta r\u00e1pida primeiro (< 500ms)\n        if self.quick_response:\n            quick_answer = self.quick_response.try_quick_response(query)\n            if quick_answer:\n                self.logger.info(f\"\u26a1 Resposta r\u00e1pida encontrada! Tempo: < 500ms\")\n                # Enviar resposta r\u00e1pida em chunks para simular streaming\n                for char in quick_answer:\n                    yield {\n                        \"type\": \"text\",\n                        \"content\": char\n                    }\n                return\n\n        # Verificar se o supervisor foi inicializado\n        if self.supervisor is None:\n            yield {\n                \"type\": \"text\",\n                \"content\": \"\u26a0\ufe0f **Sistema de Agentes Indispon\u00edvel**\\n\\nO Agente Supervisor n\u00e3o p\u00f4de ser inicializado.\"\n            }\n            return\n\n        # Interceptar perguntas simples (sem cache em streaming)\n        if query.lower() in [\"qual seu nome\", \"quem \u00e9 voc\u00ea\", \"qual o seu nome\"]:\n            yield {\n                \"type\": \"text\",\n                \"content\": \"Eu sou um Agente de Neg\u00f3cios, pronto para ajudar com suas an\u00e1lises de dados.\"\n            }\n            return\n\n        self.logger.info(f'Streaming da consulta para o Supervisor: \"{query}\"')\n        \n        # Delegar para m\u00e9todo de streaming do supervisor\n        for event in self.supervisor.stream_query(query):\n            yield event", "mimetype": "text/plain", "start_char_idx": 3819, "end_char_idx": 5936, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9fd7eb40-4c95-4ce0-8378-662783b2a6be": {"__data__": {"id_": "9fd7eb40-4c95-4ce0-8378-662783b2a6be", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "be0abac0-92fb-4ffe-a151-21b167412d07", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "hash": "164247bbd5547873846ba4a4be0ee49142b69c9787d8059cebf29e67c5920610", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "1c5975d5-6841-488c-acf9-45ffe90a459a", "node_type": "1", "metadata": {}, "hash": "3f1770b0c127c30cea015fd97a58701f40d179ea50bd8e60967e2392127c1502", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nChat BI - Sistema ROBUSTO com Regex (SEM depend\u00eancia de API)\nSolu\u00e7\u00e3o definitiva que funciona 100% offline\n\"\"\"\n\nimport polars as pl\nfrom pathlib import Path\nimport re\nfrom typing import Dict, Any, List, Optional\n\n\nclass RobustChatBI:\n    \"\"\"\n    Sistema robusto de Chat BI usando REGEX\n    N\u00e3o depende de APIs externas - funciona 100% offline\n    \"\"\"\n    \n    def __init__(self, parquet_path: Path):\n        self.parquet_path = parquet_path\n        \n        # Carregar schema do Parquet\n        lf = pl.scan_parquet(parquet_path)\n        self.schema = lf.collect_schema()\n        self.columns = list(self.schema.names())\n    \n    def process_query(self, user_query: str) -> Dict[str, Any]:\n        \"\"\"\n        Processa pergunta do usu\u00e1rio usando REGEX robusto\n        Retorna resposta estruturada com dados e texto\n        \"\"\"\n        \n        query_lower = user_query.lower()\n        \n        # 1. Detec\u00e7\u00e3o de sauda\u00e7\u00f5es\n        saudacoes = [\"ol\u00e1\", \"oi\", \"ola\", \"hello\", \"boa tarde\", \"bom dia\", \"boa noite\"]\n        if any(saudacao in query_lower for saudacao in saudacoes):\n            return {\n                \"success\": True,\n                \"text\": \"\ud83d\udc4b Ol\u00e1! Sou seu assistente de BI.\\n\\nPosso ajudar com:\\n\u2022 Consultas de pre\u00e7os\\n\u2022 An\u00e1lise de vendas\\n\u2022 Informa\u00e7\u00f5es de produtos\\n\\nFa\u00e7a uma pergunta!\",\n                \"data\": None\n            }\n        \n        # 2. Extrair informa\u00e7\u00f5es com REGEX\n        produto = self._extract_produto(query_lower)\n        une = self._extract_une(query_lower)\n        periodo = self._extract_periodo(query_lower)\n        tipo_consulta = self._detect_query_type(query_lower)\n        \n        # 3. Executar consulta\n        try:\n            result = self._execute_query(produto, une, periodo, tipo_consulta)\n            return result\n        except KeyError as e:\n            print(f\"[ERROR] KeyError ao executar consulta: {e}\")\n            print(f\"[DEBUG] Produto: {produto}, UNE: {une}, Periodo: {periodo}\")\n            import traceback\n            traceback.print_exc()\n            return self._fallback_response(user_query)\n        except Exception as e:\n            print(f\"[ERROR] Erro ao executar consulta: {e}\")\n            import traceback\n            traceback.print_exc()\n            return self._fallback_response(user_query)\n    \n    def _extract_produto(self, query: str) -> Optional[str]:\n        \"\"\"Extrai c\u00f3digo ou nome do produto usando regex\"\"\"\n        # 1. Tentar c\u00f3digo num\u00e9rico (prioridade)\n        patterns_code = [\n            r'produto\\s+(\\d{4,6})',\n            r'prod\\s+(\\d{4,6})',\n            r'c\u00f3digo\\s+(\\d{4,6})',\n            r'codigo\\s+(\\d{4,6})',\n            r'\\b(\\d{5,6})\\b',  # N\u00famero de 5-6 d\u00edgitos isolado\n        ]\n        for pattern in patterns_code:\n            match = re.search(pattern, query)\n            if match:\n                return match.group(1)\n        \n        # 2. Tentar nome do produto (texto ap\u00f3s 'produto')\n        # Captura tudo at\u00e9 a pr\u00f3xima palavra-chave (na, em, une, loja, nos, etc) ou fim da string\n        pattern_name = r'(?:produto|prod|vendas de|venda de)\\s+(.+?)(?:\\s+na\\s+|\\s+em\\s+|\\s+da\\s+|\\s+do\\s+|\\s+no\\s+|\\s+nos\\s+|\\s+une|\\s+loja|$)'\n        match = re.search(pattern_name, query)\n        if match:\n            # Limpar espa\u00e7os extras\n            return match.group(1).strip()\n            \n        return None\n    \n    def _extract_une(self, query: str) -> Optional[str]:\n        \"\"\"Extrai c\u00f3digo ou nome da UNE usando regex\"\"\"\n        # 1. Tentar c\u00f3digo num\u00e9rico\n        patterns_code = [\n            r'une\\s+(\\d+)',\n            r'loja\\s+(\\d+)',\n            r'unidade\\s+(\\d+)',\n        ]\n        for pattern in patterns_code:\n            match = re.search(pattern, query)\n            if match:\n                return match.group(1)\n        \n        # 2.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3763, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1c5975d5-6841-488c-acf9-45ffe90a459a": {"__data__": {"id_": "1c5975d5-6841-488c-acf9-45ffe90a459a", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "be0abac0-92fb-4ffe-a151-21b167412d07", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "hash": "164247bbd5547873846ba4a4be0ee49142b69c9787d8059cebf29e67c5920610", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "9fd7eb40-4c95-4ce0-8378-662783b2a6be", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "hash": "14b2b996c0c7584e458a6180b68ee64315deedb60142bcc770a7a8c44a73e439", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f2b4495d-6e0c-4952-9caf-e3e19346851b", "node_type": "1", "metadata": {}, "hash": "61cc9491464ede144ccc76ad3d1ee08c3a7f050c2123d42d48c1595c1a9289ee", "class_name": "RelatedNodeInfo"}}, "text": ":\\s+na\\s+|\\s+em\\s+|\\s+da\\s+|\\s+do\\s+|\\s+no\\s+|\\s+nos\\s+|\\s+une|\\s+loja|$)'\n        match = re.search(pattern_name, query)\n        if match:\n            # Limpar espa\u00e7os extras\n            return match.group(1).strip()\n            \n        return None\n    \n    def _extract_une(self, query: str) -> Optional[str]:\n        \"\"\"Extrai c\u00f3digo ou nome da UNE usando regex\"\"\"\n        # 1. Tentar c\u00f3digo num\u00e9rico\n        patterns_code = [\n            r'une\\s+(\\d+)',\n            r'loja\\s+(\\d+)',\n            r'unidade\\s+(\\d+)',\n        ]\n        for pattern in patterns_code:\n            match = re.search(pattern, query)\n            if match:\n                return match.group(1)\n        \n        # 2. Tentar nome da UNE (texto ap\u00f3s 'une'/'loja')\n        pattern_name = r'(?:une|loja|unidade|na)\\s+(.+?)(?:\\s+nos\\s+|\\s+no\\s+|\\s+do\\s+|\\s+da\\s+|\\s+de\\s+|\\s+produto|$)'\n        match = re.search(pattern_name, query)\n        if match:\n            val = match.group(1).strip()\n            # Evitar capturar \"une\" se for parte de outra palavra ou muito curto\n            if len(val) > 1 and val.lower() not in [\"scr\", \"meses\", \"dias\"]:\n                return val.upper()\n        \n        # Caso especial: \"UNE SCR\" ou apenas \"SCR\"\n        if \"scr\" in query:\n            return \"SCR\"\n            \n        return None\n    \n    def _extract_periodo(self, query: str) -> List[str]:\n        \"\"\"Extrai per\u00edodo usando regex\"\"\"\n        # Padr\u00f5es: \"\u00faltimos 3 meses\", \"\u00faltimo m\u00eas\", \"3 meses\", \"m\u00eas 1\"\n        \n        # \u00daltimos X meses\n        match = re.search(r'(?:\u00faltimos?|ultimos?", "mimetype": "text/plain", "start_char_idx": 3068, "end_char_idx": 4631, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f2b4495d-6e0c-4952-9caf-e3e19346851b": {"__data__": {"id_": "f2b4495d-6e0c-4952-9caf-e3e19346851b", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "be0abac0-92fb-4ffe-a151-21b167412d07", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "hash": "164247bbd5547873846ba4a4be0ee49142b69c9787d8059cebf29e67c5920610", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "1c5975d5-6841-488c-acf9-45ffe90a459a", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "hash": "7101bdf58d11c1b95b54f6e733095ea78c4e904ef8f9e54308dd68e8caa0fe89", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e374470f-9d2b-40cf-a3b9-2651e45b0f6f", "node_type": "1", "metadata": {}, "hash": "ae8a1a967320b151a6b8e63e3811a19d19b35f6a362978d5e8acc277ce7930fe", "class_name": "RelatedNodeInfo"}}, "text": ")\\s+(\\d+)\\s+mes', query)\n        if match:\n            num_meses = int(match.group(1))\n            return [f\"MES_{str(i).zfill(2)}\" for i in range(1, min(num_meses + 1, 13))]\n        \n        # M\u00eas espec\u00edfico\n        match = re.search(r'm\u00eas\\s+(\\d+)', query)\n        if match:\n            mes_num = int(match.group(1))\n            return [f\"MES_{str(mes_num).zfill(2)}\"]\n        \n        # Default: \u00faltimos 3 meses\n        if \"mes\" in query or \"m\u00eas\" in query:\n            return [\"MES_01\", \"MES_02\", \"MES_03\"]\n        \n        return [\"MES_01\"]\n    \n    def _detect_query_type(self, query: str) -> str:\n        \"\"\"Detecta tipo de consulta\"\"\"\n        if any(word in query for word in [\"venda\", \"vendas\", \"quantidade\", \"quantas\", \"quanto\"]):\n            return \"vendas\"\n        elif any(word in query for word in [\"pre\u00e7o\", \"preco\", \"valor\", \"custo\"]):\n            return \"preco\"\n        elif any(word in query for word in [\"total\", \"soma\", \"somar\"]):\n            return \"total\"\n        else:\n            return \"geral\"\n    \n    def _execute_query(self, produto: Optional[str], une: Optional[str], \n                      periodo: List[str], tipo: str) -> Dict[str, Any]:\n        \"\"\"Executa consulta no Parquet\"\"\"\n        \n        lf = pl.scan_parquet(self.parquet_path)\n        \n        # Construir filtros\n        filters = []\n        \n        # Filtro de PRODUTO\n        if produto:\n            if produto.isdigit():\n                # \u00c9 c\u00f3digo num\u00e9rico\n                try:\n                    produto_int = int(produto)\n                    filters.append(pl.col(\"PRODUTO\") == produto_int)\n                except ValueError:\n                    filters.append(pl.col(\"PRODUTO\").cast(pl.Utf8) == produto)\n            else:\n                # \u00c9 nome do produto - busca textual (case insensitive)\n                # Verifica se coluna NOME existe\n                if \"NOME\" in self.columns:\n                    filters.append(pl.col(\"NOME\").str.to_uppercase().str.contains(produto.upper()))\n                else:\n                    # Se n\u00e3o tem coluna NOME, n\u00e3o d\u00e1 pra buscar por nome\n                    return {\n                        \"success\": False,\n                        \"text\": f\"\u274c Desculpe, n\u00e3o consigo buscar produtos por nome ('{produto}') neste conjunto de dados. Por favor, use o c\u00f3digo do produto.\",\n                        \"data\": None\n                    }\n\n        # Filtro de UNE\n        if une:\n            if une.isdigit():\n                # \u00c9 c\u00f3digo num\u00e9rico\n                filters.append(\n                    (pl.col(\"UNE\").cast(pl.Utf8) == une) | \n                    (pl.col(\"UNE\") == int(une))\n                )\n            else:\n                # \u00c9 nome da UNE ou c\u00f3digo alfanum\u00e9rico (ex: SCR)\n                if \"UNE_NOME\" in self.columns:\n                    filters.append(\n                        (pl.col(\"UNE_NOME\").str.to_uppercase().str.contains(une.upper())) |\n                        (pl.col(\"UNE\").cast(pl.Utf8).str.to_uppercase() == une.upper())\n                    )\n                else:\n                    # Tentar apenas na coluna UNE como string\n                    filters.append(pl.col(\"UNE\").cast(pl.Utf8).str.to_uppercase() == une.upper())\n        \n        # Aplicar filtros\n        if filters:\n            query = lf.filter(pl.all_horizontal(filters))\n        else:\n            query = lf\n        \n        # Selecionar colunas\n        cols_to_select = [\"PRODUTO\", \"NOME\", \"UNE\"] + [p for p in periodo if p in self.columns]\n        \n        # Executar com tratamento de erro\n        try:\n            result = query.select(cols_to_select).head(1).collect()\n        except Exception as e:\n            print(f\"[ERROR] Erro ao executar query Polars: {e}\")\n            print(f\"[DEBUG] Colunas selecionadas: {cols_to_select}\")\n            import traceback\n            traceback.print_exc()\n            return {\n                \"success\": False,\n                \"text\": f\"\u274c Erro ao processar consulta. Por favor, tente novamente.", "mimetype": "text/plain", "start_char_idx": 4631, "end_char_idx": 8596, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e374470f-9d2b-40cf-a3b9-2651e45b0f6f": {"__data__": {"id_": "e374470f-9d2b-40cf-a3b9-2651e45b0f6f", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "be0abac0-92fb-4ffe-a151-21b167412d07", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "hash": "164247bbd5547873846ba4a4be0ee49142b69c9787d8059cebf29e67c5920610", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "f2b4495d-6e0c-4952-9caf-e3e19346851b", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}, "hash": "a64971f24f4d65185062c3453f8e88cf09a0dd0250519bc4671ceee3b7ac596d", "class_name": "RelatedNodeInfo"}}, "text": "Por favor, tente novamente.\",\n                \"data\": None\n            }\n        \n        # Formatar resposta\n        if len(result) > 0:\n            row = result.row(0, named=True)\n            \n            nome = row.get(\"NOME\", \"Produto\")\n            produto_id = row.get(\"PRODUTO\", produto or \"N/A\")\n            une_id = row.get(\"UNE\", une or \"N/A\")\n            \n            # Calcular valores\n            valores = []\n            for mes in periodo:\n                # Usar .get() para evitar KeyError se a coluna n\u00e3o existir\n                if mes in row:\n                    val = row.get(mes)\n                    # Converter para float se necess\u00e1rio\n                    if val is not None:\n                        valores.append(float(val))\n            \n            total = sum(valores) if valores else 0\n            \n            # Formatar texto da resposta\n            if tipo == \"vendas\" or tipo == \"total\":\n                response_text = f\"\ud83d\udcca **Produto {produto_id}** na UNE {une_id}:\\n\\n\"\n                response_text += f\"**Nome:** {nome}\\n\\n\"\n                \n                if len(valores) > 1:\n                    for i, (mes, valor) in enumerate(zip(periodo, valores), 1):\n                        response_text += f\"**M\u00eas {i}:** {valor:,.0f}\\n\"\n                    response_text += f\"\\n**Total:** {total:,.0f}\"\n                else:\n                    response_text += f\"**Valor:** {total:,.0f}\"\n            \n            elif tipo == \"preco\":\n                response_text = f\"\ud83d\udcca **Produto {produto_id}** na UNE {une_id}:\\n\\n\"\n                response_text += f\"**Nome:** {nome}\\n\"\n                response_text += f\"**Pre\u00e7o:** R$ {total:,.2f}\"\n            \n            else:\n                response_text = f\"\ud83d\udcca **Produto {produto_id}** na UNE {une_id}:\\n\\n\"\n                response_text += f\"**Nome:** {nome}\\n\"\n                response_text += f\"**Valor:** {total:,.0f}\"\n            \n            return {\n                \"success\": True,\n                \"text\": response_text,\n                \"data\": row\n            }\n        \n        # Nenhum resultado encontrado\n        if produto and une:\n            # Verificar se o produto existe em QUALQUER UNE\n            lf = pl.scan_parquet(self.parquet_path)\n            \n            # Filtro de produto (int ou str)\n            prod_filter = None\n            try:\n                prod_filter = (pl.col(\"PRODUTO\") == int(produto))\n            except ValueError:\n                prod_filter = (pl.col(\"PRODUTO\").cast(pl.Utf8) == produto)\n                \n            # Buscar UNEs dispon\u00edveis\n            unes_disponiveis = lf.filter(prod_filter).select(\"UNE\").unique().head(5).collect()\n            \n            if len(unes_disponiveis) > 0:\n                lista_unes = [str(r[0]) for r in unes_disponiveis.rows()]\n                unes_str = \", \".join(lista_unes)\n                return {\n                    \"success\": False,\n                    \"text\": f\"\u274c O produto {produto} n\u00e3o foi encontrado na UNE {une}.\\n\\n\u2705 Mas ele est\u00e1 dispon\u00edvel nas seguintes UNEs: **{unes_str}**...\\n\\nTente consultar uma dessas lojas!\",\n                    \"data\": None\n                }\n            else:\n                return {\n                    \"success\": False,\n                    \"text\": f\"\u274c O produto {produto} n\u00e3o foi encontrado em nenhuma UNE.\",\n                    \"data\": None\n                }\n                \n        elif produto:\n            return {\n                \"success\": False,\n                \"text\": f\"\u274c N\u00e3o encontrei o produto {produto}.\\n\\nVerifique se o c\u00f3digo est\u00e1 correto.\",\n                \"data\": None\n            }\n        else:\n            return self._fallback_response(\"\")\n    \n    def _fallback_response(self, query: str) -> Dict[str, Any]:\n        \"\"\"Resposta de fallback\"\"\"\n        return {\n            \"success\": False,\n            \"text\": \"\ud83e\udd14 N\u00e3o consegui entender sua pergunta.\\n\\nTente perguntas como:\\n\u2022 'Quantas vendas do produto 59294 na UNE 261 nos \u00faltimos 3 meses?'\\n\u2022 'Qual o pre\u00e7o do produto 59294 na UNE SCR?'\\n\u2022 'Total de vendas do produto 12345'\",\n            \"data\": None\n        }", "mimetype": "text/plain", "start_char_idx": 8569, "end_char_idx": 12655, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f30d135c-7467-405f-a43d-087fc1228037": {"__data__": {"id_": "f30d135c-7467-405f-a43d-087fc1228037", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\supabase_client.py", "language": "python", "lines": 43, "filename": "supabase_client.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ac7bab28-7528-4223-a181-bed58104082a", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\supabase_client.py", "language": "python", "lines": 43, "filename": "supabase_client.py"}, "hash": "42ca99e76c3f9d9f833eef16cc836a81ac703e3614d66478632c7d5913f48b5f", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSupabase Client Configuration\nSingleton instance for Supabase authentication and database access\n\"\"\"\n\nfrom supabase import create_client, Client\nfrom app.config.settings import get_settings\n\nsettings = get_settings()\n\n# Singleton Supabase client\n_supabase_client: Client | None = None\n\n\ndef get_supabase_client() -> Client:\n    \"\"\"Get or create Supabase client instance\"\"\"\n    global _supabase_client\n\n    # Only create client if Supabase auth is enabled\n    if not settings.USE_SUPABASE_AUTH:\n        raise ValueError(\n            \"Supabase authentication is disabled. \"\n            \"Set USE_SUPABASE_AUTH=true in .env to enable\"\n        )\n\n    if _supabase_client is None:\n        if not settings.SUPABASE_URL or not settings.SUPABASE_ANON_KEY:\n            raise ValueError(\n                \"Supabase credentials not configured. \"\n                \"Please set SUPABASE_URL and SUPABASE_ANON_KEY in .env\"\n            )\n\n        _supabase_client = create_client(\n            settings.SUPABASE_URL,\n            settings.SUPABASE_ANON_KEY\n        )\n\n    return _supabase_client\n\n\n# Convenience export\nsupabase = get_supabase_client", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1132, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "27878837-c577-4918-a1a0-ae0b1c53f684": {"__data__": {"id_": "27878837-c577-4918-a1a0-ae0b1c53f684", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\supabase_user_service.py", "language": "python", "lines": 310, "filename": "supabase_user_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "dd97e852-7b38-4daa-be9d-72ada2ff60b2", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\supabase_user_service.py", "language": "python", "lines": 310, "filename": "supabase_user_service.py"}, "hash": "d7261e5b580a7b1f749448e4bf70efd6f030897faa6d6cade26a31dab2395a16", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e09a5fcb-253b-428d-b7e8-ce79cbf364b1", "node_type": "1", "metadata": {}, "hash": "1ae854b109eba7c184e9e45acceb453905f3c99204e3c8178ca62de423094b6d", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSupabase User Management Service\nHandles user CRUD operations with Supabase Auth + user_profiles table\n\"\"\"\n\nimport logging\nfrom typing import Optional\nfrom datetime import datetime\n\nfrom app.core.supabase_client import get_supabase_client\nfrom app.config.settings import get_settings\n\nsettings = get_settings()\nlogger = logging.getLogger(__name__)\nsecurity_logger = logging.getLogger(\"security\")\n\n\nclass SupabaseUserService:\n    \"\"\"Service for managing users in Supabase\"\"\"\n\n    def __init__(self):\n        self._client = None\n\n    @property\n    def client(self):\n        \"\"\"Lazy load Supabase client only when needed\"\"\"\n        if self._client is None:\n            if not settings.USE_SUPABASE_AUTH:\n                raise ValueError(\n                    \"Supabase authentication is disabled. \"\n                    \"This service requires USE_SUPABASE_AUTH=true in .env\"\n                )\n            self._client = get_supabase_client()\n        return self._client\n\n    def create_user(\n        self,\n        email: str,\n        password: str,\n        username: str,\n        role: str = \"user\",\n        full_name: Optional[str] = None,\n        allowed_segments: Optional[list[str]] = None\n    ) -> dict:\n        \"\"\"\n        Create a new user in Supabase Auth and user_profiles table\n\n        Args:\n            email: User's email\n            password: User's password\n            username: Username for the system\n            role: User role (admin, user, viewer)\n            full_name: Optional full name\n            allowed_segments: List of allowed segments\n\n        Returns:\n            Dictionary with user data\n\n        Raises:\n            Exception if user creation fails\n        \"\"\"\n        try:\n            # 1. Create user in Supabase Auth\n            auth_response = self.client.auth.admin.create_user({\n                \"email\": email,\n                \"password\": password,\n                \"email_confirm\": True,  # Auto-confirm email\n                \"user_metadata\": {\n                    \"username\": username,\n                    \"role\": role,\n                    \"full_name\": full_name or username,\n                    \"allowed_segments\": allowed_segments or []\n                }\n            })\n\n            if not auth_response.user:\n                raise Exception(\"Failed to create user in Supabase Auth\")\n\n            user_id = auth_response.user.id\n\n            # 2. Create profile in user_profiles table\n            profile_data = {\n                \"id\": str(user_id),\n                \"username\": username,\n                \"role\": role,\n                \"full_name\": full_name or username,\n                \"created_at\": datetime.utcnow().isoformat(),\n                \"updated_at\": datetime.utcnow().isoformat()\n            }\n\n            profile_response = self.client.table(\"user_profiles\").insert(profile_data).execute()\n\n            security_logger.info(f\"User '{username}' created successfully in Supabase (ID: {user_id})\")\n\n            return {\n                \"id\": str(user_id),\n                \"email\": email,\n                \"username\": username,\n                \"role\": role,\n                \"full_name\": full_name or username,\n                \"allowed_segments\": allowed_segments or [],\n                \"is_active\": True,\n                \"created_at\": datetime.utcnow().isoformat()\n            }\n\n        except Exception as e:\n            security_logger.error(f\"Failed to create user '{username}': {e}\")\n            raise Exception(f\"Failed to create user: {str(e)}\")\n\n    def list_users(self, limit: int = 100) -> list[dict]:\n        \"\"\"\n        List all users from Supabase\n\n        Args:\n            limit: Maximum number of users to return\n\n        Returns:\n            List of user dictionaries\n        \"\"\"\n        try:\n            # Get users from user_profiles table (which links to auth.users)\n            response = self.client.table(\"user_profiles\").select(\"*\").limit(limit).execute()\n\n            users = []\n            for profile in response.data:\n                # Get auth user data to check email and status\n                try:\n                    auth_user = self.client.auth.admin.get_user_by_id(profile[\"id\"])\n                    email = auth_user.user.email if auth_user.user else \"N/A\"\n                    is_active = not auth_user.user.banned_until if auth_user.user else True\n                    # Get allowed_segments from metadata\n                    user_metadata = auth_user.user.user_metadata or {}\n                    allowed_segments = user_metadata.get(\"allowed_segments\", [])\n                except:\n                    email = \"N/A\"\n                    is_active = True\n                    allowed_segments = []\n\n                users.append({\n                    \"id\": profile[\"id\"],\n                    \"username\": profile.get(\"username\", \"N/A\"),\n                    \"email\": email,\n                    \"role\": profile.get(\"role\",", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4902, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e09a5fcb-253b-428d-b7e8-ce79cbf364b1": {"__data__": {"id_": "e09a5fcb-253b-428d-b7e8-ce79cbf364b1", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\supabase_user_service.py", "language": "python", "lines": 310, "filename": "supabase_user_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "dd97e852-7b38-4daa-be9d-72ada2ff60b2", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\supabase_user_service.py", "language": "python", "lines": 310, "filename": "supabase_user_service.py"}, "hash": "d7261e5b580a7b1f749448e4bf70efd6f030897faa6d6cade26a31dab2395a16", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "27878837-c577-4918-a1a0-ae0b1c53f684", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\supabase_user_service.py", "language": "python", "lines": 310, "filename": "supabase_user_service.py"}, "hash": "df424ea7bfc80467abc2878984cb547de7444f6232b5866f2a1e382ada9b1e3a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "626f1f51-9933-47e3-9fa2-c10549066ebc", "node_type": "1", "metadata": {}, "hash": "39cf6cf1a219ce65fac61594588be757c487eade84e813a097f27f2edf7fa1c1", "class_name": "RelatedNodeInfo"}}, "text": "select(\"*\").limit(limit).execute()\n\n            users = []\n            for profile in response.data:\n                # Get auth user data to check email and status\n                try:\n                    auth_user = self.client.auth.admin.get_user_by_id(profile[\"id\"])\n                    email = auth_user.user.email if auth_user.user else \"N/A\"\n                    is_active = not auth_user.user.banned_until if auth_user.user else True\n                    # Get allowed_segments from metadata\n                    user_metadata = auth_user.user.user_metadata or {}\n                    allowed_segments = user_metadata.get(\"allowed_segments\", [])\n                except:\n                    email = \"N/A\"\n                    is_active = True\n                    allowed_segments = []\n\n                users.append({\n                    \"id\": profile[\"id\"],\n                    \"username\": profile.get(\"username\", \"N/A\"),\n                    \"email\": email,\n                    \"role\": profile.get(\"role\", \"user\"),\n                    \"full_name\": profile.get(\"full_name\", \"\"),\n                    \"allowed_segments\": allowed_segments,\n                    \"is_active\": is_active,\n                    \"created_at\": profile.get(\"created_at\", \"\"),\n                    \"updated_at\": profile.get(\"updated_at\", \"\")\n                })\n\n            logger.info(f\"Listed {len(users)} users from Supabase\")\n            return users\n\n        except Exception as e:\n            logger.error(f\"Failed to list users: {e}\")\n            return []\n\n    def get_user(self, user_id: str) -> Optional[dict]:\n        \"\"\"\n        Get a single user by ID\n\n        Args:\n            user_id: User's UUID\n\n        Returns:\n            User dictionary or None if not found\n        \"\"\"\n        try:\n            # Get profile\n            profile_response = self.client.table(\"user_profiles\").select(\"*\").eq(\"id\", user_id).execute()\n\n            if not profile_response.data:\n                return None\n\n            profile = profile_response.data[0]\n\n            # Get auth user data\n            auth_user = self.client.auth.admin.get_user_by_id(user_id)\n            email = auth_user.user.email if auth_user.user else \"N/A\"\n            is_active = not auth_user.user.banned_until if auth_user.user else True\n            \n            user_metadata = auth_user.user.user_metadata or {}\n            allowed_segments = user_metadata.get(\"allowed_segments\", [])\n\n            return {\n                \"id\": profile[\"id\"],\n                \"username\": profile.get(\"username\", \"N/A\"),\n                \"email\": email,\n                \"role\": profile.get(\"role\", \"user\"),\n                \"full_name\": profile.get(\"full_name\", \"\"),\n                \"allowed_segments\": allowed_segments,\n                \"is_active\": is_active,\n                \"created_at\": profile.get(\"created_at\", \"\"),\n                \"updated_at\": profile.get(\"updated_at\", \"\")\n            }\n\n        except Exception as e:\n            logger.error(f\"Failed to get user {user_id}: {e}\")\n            return None\n\n    def update_user(\n        self,\n        user_id: str,\n        email: Optional[str] = None,\n        username: Optional[str] = None,\n        role: Optional[str] = None,\n        full_name: Optional[str] = None,\n        password: Optional[str] = None,\n        is_active: Optional[bool] = None,", "mimetype": "text/plain", "start_char_idx": 3896, "end_char_idx": 7232, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "626f1f51-9933-47e3-9fa2-c10549066ebc": {"__data__": {"id_": "626f1f51-9933-47e3-9fa2-c10549066ebc", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\supabase_user_service.py", "language": "python", "lines": 310, "filename": "supabase_user_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "dd97e852-7b38-4daa-be9d-72ada2ff60b2", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\supabase_user_service.py", "language": "python", "lines": 310, "filename": "supabase_user_service.py"}, "hash": "d7261e5b580a7b1f749448e4bf70efd6f030897faa6d6cade26a31dab2395a16", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "e09a5fcb-253b-428d-b7e8-ce79cbf364b1", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\supabase_user_service.py", "language": "python", "lines": 310, "filename": "supabase_user_service.py"}, "hash": "e22e5f11c790efbda7b2d73101e585f68a697f59df1d98206c127feecffe01ca", "class_name": "RelatedNodeInfo"}}, "text": "get(\"username\", \"N/A\"),\n                \"email\": email,\n                \"role\": profile.get(\"role\", \"user\"),\n                \"full_name\": profile.get(\"full_name\", \"\"),\n                \"allowed_segments\": allowed_segments,\n                \"is_active\": is_active,\n                \"created_at\": profile.get(\"created_at\", \"\"),\n                \"updated_at\": profile.get(\"updated_at\", \"\")\n            }\n\n        except Exception as e:\n            logger.error(f\"Failed to get user {user_id}: {e}\")\n            return None\n\n    def update_user(\n        self,\n        user_id: str,\n        email: Optional[str] = None,\n        username: Optional[str] = None,\n        role: Optional[str] = None,\n        full_name: Optional[str] = None,\n        password: Optional[str] = None,\n        is_active: Optional[bool] = None,\n        allowed_segments: Optional[list[str]] = None\n    ) -> dict:\n        \"\"\"\n        Update user in Supabase Auth and user_profiles\n\n        Args:\n            user_id: User's UUID\n            email: New email (optional)\n            username: New username (optional)\n            role: New role (optional)\n            full_name: New full name (optional)\n            password: New password (optional)\n            is_active: Active status (optional)\n            allowed_segments: New allowed segments (optional)\n\n        Returns:\n            Updated user dictionary\n\n        Raises:\n            Exception if update fails\n        \"\"\"\n        try:\n            # Update auth user if needed\n            auth_updates = {}\n            user_metadata_updates = {}\n            \n            if email:\n                auth_updates[\"email\"] = email\n            if password:\n                auth_updates[\"password\"] = password\n            if is_active is not None:\n                # Ban/unban user based on is_active\n                if not is_active:\n                    auth_updates[\"ban_duration\"] = \"876000h\"  # ~100 years (effectively permanent)\n                else:\n                    auth_updates[\"ban_duration\"] = \"none\"\n            \n            # Update metadata\n            if username:\n                user_metadata_updates[\"username\"] = username\n            if role:\n                user_metadata_updates[\"role\"] = role\n            if full_name:\n                user_metadata_updates[\"full_name\"] = full_name\n            if allowed_segments is not None:\n                user_metadata_updates[\"allowed_segments\"] = allowed_segments\n\n            if user_metadata_updates:\n                auth_updates[\"user_metadata\"] = user_metadata_updates\n\n            if auth_updates:\n                self.client.auth.admin.update_user_by_id(user_id, auth_updates)\n\n            # Update profile\n            profile_updates = {\"updated_at\": datetime.utcnow().isoformat()}\n            if username:\n                profile_updates[\"username\"] = username\n            if role:\n                profile_updates[\"role\"] = role\n            if full_name:\n                profile_updates[\"full_name\"] = full_name\n\n            self.client.table(\"user_profiles\").update(profile_updates).eq(\"id\", user_id).execute()\n\n            security_logger.info(f\"User {user_id} updated successfully\")\n\n            # Return updated user\n            return self.get_user(user_id)\n\n        except Exception as e:\n            security_logger.error(f\"Failed to update user {user_id}: {e}\")\n            raise Exception(f\"Failed to update user: {str(e)}\")\n\n    def delete_user(self, user_id: str) -> bool:\n        \"\"\"\n        Delete user from Supabase Auth and user_profiles\n\n        Args:\n            user_id: User's UUID\n\n        Returns:\n            True if successful, False otherwise\n        \"\"\"\n        try:\n            # Delete from user_profiles first\n            self.client.table(\"user_profiles\").delete().eq(\"id\", user_id).execute()\n\n            # Delete from auth\n            self.client.auth.admin.delete_user(user_id)\n\n            security_logger.info(f\"User {user_id} deleted successfully\")\n            return True\n\n        except Exception as e:\n            security_logger.error(f\"Failed to delete user {user_id}: {e}\")\n            return False\n\n\n# Global instance\nsupabase_user_service = SupabaseUserService()", "mimetype": "text/plain", "start_char_idx": 6423, "end_char_idx": 10612, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "4eb326b6-06aa-47ee-85ff-a0674a43884d": {"__data__": {"id_": "4eb326b6-06aa-47ee-85ff-a0674a43884d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\sync_service.py", "language": "python", "lines": 94, "filename": "sync_service.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "68f3d29c-e880-4c5d-b040-652e5acb68ab", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\sync_service.py", "language": "python", "lines": 94, "filename": "sync_service.py"}, "hash": "276cfc7ef595a6f3821a5360d1c0252c48e8e7624863991d5a0562c820e92ec3", "class_name": "RelatedNodeInfo"}}, "text": "import pandas as pd\nimport pyodbc\nimport time\nimport logging\nimport os\nfrom pathlib import Path\nfrom app.config.settings import settings\n\nlogger = logging.getLogger(__name__)\n\nclass SyncService:\n    \"\"\"\n    Servi\u00e7o para sincronizar dados do SQL Server para arquivos Parquet.\n    \"\"\"\n\n    def run_sync(self):\n        \"\"\"Executa a sincroniza\u00e7\u00e3o do admmat.parquet\"\"\"\n        logger.info(\"\ud83d\udd04 Iniciando sincroniza\u00e7\u00e3o SQL Server -> Parquet...\")\n        start_time = time.time()\n\n        try:\n            # Usar connection string do settings ou montar uma\n            if settings.PYODBC_CONNECTION_STRING:\n                conn_str = settings.PYODBC_CONNECTION_STRING\n            else:\n                # Fallback para montagem manual (baseado no script antigo, mas usando vars do ambiente se disponiveis)\n                driver = \"ODBC Driver 17 for SQL Server\"\n                server = os.getenv(\"DB_SERVER\", r\"FAMILIA\\SQLJR,1433\")\n                database = os.getenv(\"DB_NAME\", \"Projeto_Caculinha\")\n                uid = os.getenv(\"DB_USER\", \"AgenteVirtual\")\n                pwd = os.getenv(\"DB_PASS\", \"Cacula@2020\")\n                \n                conn_str = (\n                    f\"DRIVER={{{driver}}};SERVER={server};DATABASE={database};\"\n                    f\"UID={uid};PWD={pwd};TrustServerCertificate=yes;\"\n                )\n\n            logger.info(f\"\ud83d\udd0c Conectando ao SQL Server... (Server: {conn_str.split('SERVER=')[1].split(';')[0]})\")\n            conn = pyodbc.connect(conn_str)\n            \n            # Query Principal\n            query = \"SELECT * FROM [Projeto_Caculinha].[dbo].[admmatao]\"\n            \n            # Ler em chunks\n            chunk_size = 100000\n            chunks = []\n            total_rows = 0\n            \n            for chunk in pd.read_sql(query, conn, chunksize=chunk_size):\n                chunks.append(chunk)\n                total_rows += len(chunk)\n                logger.info(f\"  ...Lido chunk de {len(chunk)} linhas. Total parcial: {total_rows}\")\n            \n            conn.close()\n            logger.info(f\"\u2705 Leitura SQL conclu\u00edda. Total: {total_rows}\")\n\n            if not chunks:\n                logger.warning(\"\u26a0\ufe0f Nenhum dado retornado do banco.\")\n                return {\"status\": \"warning\", \"message\": \"Nenhum dado encontrado\"}\n\n            logger.info(\"\ud83d\udd28 Concatenando DataFrames...\")\n            df = pd.concat(chunks, ignore_index=True)\n            \n            # Definir caminho do arquivo (considerando Docker e Dev)\n            base_path = Path(__file__).resolve().parent.parent.parent.parent / \"data\" / \"parquet\"\n            if os.path.exists(\"/app/data/parquet\"): # Docker check\n                base_path = Path(\"/app/data/parquet\")\n            \n            base_path.mkdir(parents=True, exist_ok=True)\n            parquet_file = base_path / \"admmat.parquet\"\n\n            logger.info(f\"\ud83d\udcbe Salvando Parquet: {parquet_file}\")\n            df.to_parquet(parquet_file, index=False)\n            \n            # Limpar cache do Polars (se houver mecanismo de invalida\u00e7\u00e3o)\n            from app.core.parquet_cache import cache\n            cache.clear()\n            \n            duration = time.time() - start_time\n            logger.info(f\"\u2705 Sincroniza\u00e7\u00e3o conclu\u00edda em {duration:.2f}s\")\n            \n            return {\n                \"status\": \"success\", \n                \"rows\": total_rows, \n                \"duration\": duration,\n                \"file\": str(parquet_file)\n            }\n\n        except Exception as e:\n            logger.error(f\"\u274c Erro na sincroniza\u00e7\u00e3o: {e}\", exc_info=True)\n            raise e\n\nsync_service = SyncService()", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3590, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "12ecfd74-3f96-4b37-b3a5-c3fa66471573": {"__data__": {"id_": "12ecfd74-3f96-4b37-b3a5-c3fa66471573", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\base_agent.py", "language": "python", "lines": 106, "filename": "base_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fb9ac0a9-3b54-4c48-bc50-cc8d37ad2ea4", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\base_agent.py", "language": "python", "lines": 106, "filename": "base_agent.py"}, "hash": "c794c83ea4fed05bb33ae192efddb3da6c897576f0d836887165d3ce38d8181e", "class_name": "RelatedNodeInfo"}}, "text": "import logging\nimport pandas as pd\nfrom dotenv import load_dotenv\n\n# Configura\u00e7\u00e3o de logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format=\"%(asctime)s - %(name)s - %(levelname)s - %(message)s\",\n    filename=\"logs/agent.log\",\n    filemode=\"a\",\n)\nlogger = logging.getLogger(\"base_agent\")\n\n# Carrega as vari\u00e1veis do arquivo .env\nload_dotenv()\n\n\nclass BaseAgent:\n    \"\"\"Classe base para todos os agentes do sistema.\"\"\"\n\n    def __init__(self, session_id=None, node_client=None):\n        \"\"\"\n        Inicializa o agente base.\n\n        Args:\n            session_id (str): ID da sess\u00e3o para persist\u00eancia de estado.\n            node_client (object): Cliente para o servidor mssql-mcp-node.\n        \"\"\"\n        self.session_id = session_id\n        self.node_client = node_client\n        logger.info(\n            \"Agente base inicializado. Sess\u00e3o: %s, Client: %s\",\n            session_id,\n            \"Configurado\" if self.node_client else \"N\u00e3o Configurado\",\n        )\n\n    def process_query(self, query):\n        \"\"\"\n        Processa uma consulta do usu\u00e1rio.\n        This method now assumes that if node_client is used, the query is already SQL.\n        \"\"\"\n        logger.info(\"Processando consulta: %s\", query)\n        if self.node_client:\n            logger.info(\"Usando NodeMCPClient para processar a consulta SQL.\")\n            # Assuming 'query' is already a SQL query and no params are needed for this path\n            return self._process_query_with_node_client(\n                sql_query=query, query_params=None\n            )\n        logger.error(\n            \"Nenhum m\u00e9todo de processamento dispon\u00edvel. N\u00e3o \u00e9 poss\u00edvel responder.\"\n        )\n        return {\n            \"type\": \"error\",\n            \"content\": \"N\u00e3o foi poss\u00edvel processar sua consulta no momento.\",\n            \"source\": \"no_processing_method\",\n        }\n\n    def _process_query_with_node_client(\n        self, sql_query: str, query_params: list = None\n    ):\n        \"\"\"Processa uma consulta SQL usando o NodeMCPClient.\"\"\"\n        try:\n            logger.info(\n                \"Executando SQL via NodeMCPClient: '%s' com params: %s\",\n                sql_query,\n                query_params,\n            )\n            result_data = self.node_client.execute_sql(\n                sql_query=sql_query, parameters=query_params\n            )\n            logger.debug(\"Resultado do NodeMCPClient: %s\", result_data)\n\n            if result_data and result_data.get(\"success\"):\n                df = pd.DataFrame(result_data.get(\"result\", []))\n                # Converte o DataFrame para uma lista de dicion\u00e1rios,\n                # tratando valores nulos (NaN, NaT) como None.\n                content_data = df.where(pd.notna(df), None).to_dict(orient=\"records\")\n\n                return {\n                    \"type\": \"data\",\n                    \"content\": content_data,\n                    \"source\": \"node_mcp_client\",\n                }\n\n            error_info = result_data.get(\"error\") if result_data else \"No response\"\n            logger.error(\n                \"Erro retornado pelo NodeMCPClient: %s - Detalhes: %s\",\n                error_info,\n                result_data.get(\"details\") if result_data else \"N/A\",\n            )\n            return {\n                \"type\": \"error\",\n                \"content\": f\"Erro ao processar consulta: {error_info}\",\n                \"source\": \"node_mcp_client\",\n            }\n\n        except Exception as e:\n            logger.error(\n                \"Erro ao processar consulta com NodeMCPClient: %s\", e, exc_info=True\n            )\n            return {\n                \"type\": \"error\",\n                \"content\": f\"Erro inesperado ao processar consulta: {e}\",\n                \"source\": \"node_mcp_client_exception\",\n            }", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3738, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6b9890fc-b5b4-464d-801a-8a2fbccb9a12": {"__data__": {"id_": "6b9890fc-b5b4-464d-801a-8a2fbccb9a12", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "94e3c0e49ebb18f9c0681d74f819bd99e809afa886d9d6be4d8f1482d08cc2b5", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "ccaa2fcb-7363-46cd-a5d7-554b8c45fd0c", "node_type": "1", "metadata": {}, "hash": "f9525fa07efa30a6b058a23f41451bcd6b4af911dd97fad1a0eacdbea480c6c7", "class_name": "RelatedNodeInfo"}}, "text": "import json\nimport logging\nimport numpy as np\nimport pandas as pd\nfrom decimal import Decimal\nfrom datetime import datetime, date\nfrom typing import Any, Dict, List, Optional\n\nlogger = logging.getLogger(__name__)\n\n# Safe Import for LangChain dependencies\nLANGCHAIN_AVAILABLE = False\ntry:\n    from langchain_core.language_models import BaseChatModel\n    from langchain_core.tools import BaseTool\n    LANGCHAIN_AVAILABLE = True\nexcept (ImportError, OSError):\n    logger.warning(\"LangChain dependencies missing. CaculinhaBIAgent will run in degraded mode.\")\n    BaseChatModel = object # Dummy for type hinting\n    BaseTool = object # Dummy for type hinting\n\nfrom app.core.tools.une_tools import (\n    calcular_abastecimento_une,\n    calcular_mc_produto,\n    calcular_preco_final_une,\n    validar_transferencia_produto,\n    sugerir_transferencias_automaticas,\n    encontrar_rupturas_criticas,\n    consultar_dados_gerais,\n)\nfrom app.core.tools.flexible_query_tool import consultar_dados_flexivel\n\n# Optional: Import CodeGenAgent just for type hinting if needed,\n# but we won't use it for logic anymore.\nfrom app.core.utils.field_mapper import FieldMapper\n\n\ndef safe_json_serialize(obj: Any) -> str:\n    \"\"\"\n    Safely serialize any Python object to JSON string.\n    Handles MapComposite, numpy types, pandas types, datetime, and other non-serializable objects.\n    \"\"\"\n    def default_handler(o):\n        # Handle numpy types\n        if isinstance(o, (np.integer, np.int64, np.int32, np.int16, np.int8)):\n            return int(o)\n        elif isinstance(o, (np.floating, np.float64, np.float32, np.float16)):\n            if np.isnan(o) or np.isinf(o):\n                return None\n            return float(o)\n        elif isinstance(o, np.ndarray):\n            return o.tolist()\n        elif isinstance(o, np.bool_):\n            return bool(o)\n\n        # Handle pandas types\n        elif isinstance(o, pd.Timestamp):\n            return o.isoformat()\n        elif isinstance(o, pd.Timedelta):\n            return str(o)\n        elif pd.isna(o):\n            return None\n\n        # Handle datetime types\n        elif isinstance(o, (datetime, date)):\n            return o.isoformat()\n\n        # Handle Decimal\n        elif isinstance(o, Decimal):\n            return float(o)\n\n        # Handle bytes\n        elif isinstance(o, bytes):\n            return o.decode('utf-8', errors='ignore')\n\n        # Handle SQLAlchemy Row/MapComposite and similar mapping types\n        elif hasattr(o, '_mapping'):\n            return dict(o._mapping)\n        elif hasattr(o, '__dict__') and not isinstance(o, type):\n            # Generic object with __dict__\n            return {k: v for k, v in o.__dict__.items() if not k.startswith('_')}\n\n        # Last resort: convert to string\n        else:\n            return str(o)\n\n    try:\n        return json.dumps(obj, ensure_ascii=False, default=default_handler)\n    except Exception as e:\n        logger.error(f\"Failed to serialize object: {e}\", exc_info=True)\n        # Ultimate fallback: return error as JSON\n        return json.dumps({\"error\": f\"Serialization failed: {str(e)}\"}, ensure_ascii=False)\n\nclass CaculinhaBIAgent:\n    \"\"\"\n    Agent responsible for Business Intelligence queries using Gemini Native Function Calling.\n    Replaces the legacy keyword-based routing and CodeGenAgent fallback.\n    \"\"\"\n    def __init__(self, llm: Any, code_gen_agent: Any, field_mapper: FieldMapper):\n        # llm is expected to be GeminiLLMAdapter\n        self.llm = llm\n        self.field_mapper = field_mapper\n        \n        # We keep code_gen_agent in init to maintain compatibility with chat.py,\n        # but we won't use it effectively.\n        self.code_gen_agent = code_gen_agent\n\n        # Define available tools - ORDEM IMPORTA!", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3753, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ccaa2fcb-7363-46cd-a5d7-554b8c45fd0c": {"__data__": {"id_": "ccaa2fcb-7363-46cd-a5d7-554b8c45fd0c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "94e3c0e49ebb18f9c0681d74f819bd99e809afa886d9d6be4d8f1482d08cc2b5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "6b9890fc-b5b4-464d-801a-8a2fbccb9a12", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "2245ef372f611e5490ba5fcfac007b51f18503bb7daf63e8413edf9a0d4ec715", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e3e34443-694a-407b-a57f-003f4d782a19", "node_type": "1", "metadata": {}, "hash": "d83db0dc927ef8431bd49661ced087002328d1a017c3c67651b9eefdc29b3e97", "class_name": "RelatedNodeInfo"}}, "text": "Replaces the legacy keyword-based routing and CodeGenAgent fallback.\n    \"\"\"\n    def __init__(self, llm: Any, code_gen_agent: Any, field_mapper: FieldMapper):\n        # llm is expected to be GeminiLLMAdapter\n        self.llm = llm\n        self.field_mapper = field_mapper\n        \n        # We keep code_gen_agent in init to maintain compatibility with chat.py,\n        # but we won't use it effectively.\n        self.code_gen_agent = code_gen_agent\n\n        # Define available tools - ORDEM IMPORTA! Ferramentas mais gen\u00e9ricas primeiro\n        self.bi_tools = [\n            consultar_dados_flexivel,  # NOVA: Ferramenta gen\u00e9rica e flex\u00edvel\n            consultar_dados_gerais,\n            calcular_abastecimento_une,\n            calcular_mc_produto,\n            calcular_preco_final_une,\n            validar_transferencia_produto,\n            sugerir_transferencias_automaticas,\n            encontrar_rupturas_criticas,\n        ]\n\n        # Convert LangChain tools to Gemini Function Declarations\n        self.gemini_tools = self._convert_tools_to_gemini_format(self.bi_tools)\n        \n        # System instruction - Conversacional + BI Expert\n        self.system_prompt = \"\"\"Voc\u00ea \u00e9 o Assistente de BI da Caculinha, powered by Gemini 2.0.\nVoc\u00ea \u00e9 um assistente conversacional inteligente com expertise em Business Intelligence e an\u00e1lise de dados.\n\nCONTEXT7 STORYTELLING E PRIVACIDADE (CR\u00cdTICO):\n1. **NUNCA revele suas ferramentas**: Jamais diga \"Vou usar a ferramenta X\", \"Consultando a base de dados...\", ou \"Houve um erro na ferramenta Y\". O usu\u00e1rio n\u00e3o deve saber como voc\u00ea obt\u00e9m os dados.\n2. **Seja direto**: Se o usu\u00e1rio perguntar \"Vendas de Tecidos\", apenas responda: \"O segmento de Tecidos teve X vendas...\".\n3. **Erros transparentes**: Se uma ferramenta falhar, diga apenas \"N\u00e3o consegui encontrar essa informa\u00e7\u00e3o no momento\" ou \"Poderia reformular a pergunta? N\u00e3o encontrei dados para esses crit\u00e9rios\".\n4. **Foco no Neg\u00f3cio**: Aja como um analista de neg\u00f3cios s\u00eanior. Entregue insights, n\u00e3o logs de execu\u00e7\u00e3o.\n\nTABELAS MARKDOWN (CR\u00cdTICO - SEMPRE FA\u00c7A ISSO):\n**QUANDO UMA FERRAMENTA RETORNAR UMA TABELA MARKDOWN, VOC\u00ca DEVE COPIAR A TABELA COMPLETA NA SUA RESPOSTA.**\n- Se a ferramenta retornar texto com formato de tabela (linhas com | e ---), INCLUA A TABELA INTEIRA na sua resposta\n- N\u00c3O resuma a tabela, N\u00c3O diga apenas \"aqui est\u00e3o os resultados\"\n- COPIE a tabela Markdown EXATAMENTE como foi retornada pela ferramenta\n- Exemplo: Se a ferramenta retornar:\n  \"Aqui est\u00e3o os 10 resultados:\n  \n  | PRODUTO | NOME | VENDAS |\n  |---|---|---|\n  | 123 | Produto A | 100 |\"\n  \n  Voc\u00ea DEVE incluir essa tabela COMPLETA na sua resposta final ao usu\u00e1rio.\n\nPERSONALIDADE:\n- Conversacional e amig\u00e1vel, como ChatGPT\n- Responda a QUALQUER pergunta, n\u00e3o apenas sobre BI ou dados\n- Para perguntas gerais (sauda\u00e7\u00f5es, conhecimentos gerais, etc.", "mimetype": "text/plain", "start_char_idx": 3253, "end_char_idx": 6087, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e3e34443-694a-407b-a57f-003f4d782a19": {"__data__": {"id_": "e3e34443-694a-407b-a57f-003f4d782a19", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "94e3c0e49ebb18f9c0681d74f819bd99e809afa886d9d6be4d8f1482d08cc2b5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "ccaa2fcb-7363-46cd-a5d7-554b8c45fd0c", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "09d79721a81d40ddfa66a1442d96d4376a44800fa36ce712a385ddc788e75dd3", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "58d9708f-89f0-4230-83c2-f5c6321f56ec", "node_type": "1", "metadata": {}, "hash": "290bd6edfc58f23453385ec749843b4a7213c798abc4e4ead52ca371cb5a554a", "class_name": "RelatedNodeInfo"}}, "text": "PERSONALIDADE:\n- Conversacional e amig\u00e1vel, como ChatGPT\n- Responda a QUALQUER pergunta, n\u00e3o apenas sobre BI ou dados\n- Para perguntas gerais (sauda\u00e7\u00f5es, conhecimentos gerais, etc.): responda normalmente de forma \u00fatil e precisa\n- Para perguntas sobre dados de BI: use suas ferramentas especializadas silenciosamente\n\nQUANDO USAR FERRAMENTAS BI:\nUse as ferramentas APENAS quando o usu\u00e1rio perguntar sobre:\n- Dados de estoque, vendas, produtos, lojas (UNE)\n- An\u00e1lises de transfer\u00eancias, abastecimento, rupturas\n- Pre\u00e7os, margens, fabricantes, segmentos\n- Qualquer consulta que envolva o banco de dados admmat.parquet\n\nBANCO DE DADOS: admmat.parquet (1.113.822 registros, 97 colunas)\n\nCOLUNAS PRINCIPAIS DISPON\u00cdVEIS:\n- **Identifica\u00e7\u00e3o**: id, PRODUTO (c\u00f3digo), NOME (nome do produto)\n- **Localiza\u00e7\u00e3o**: UNE (c\u00f3digo da loja), UNE_NOME (nome da loja)\n- **Classifica\u00e7\u00e3o**: NOMESEGMENTO, NOMECATEGORIA, NOMEFABRICANTE, TIPO, EMBALAGEM\n- **Estoque**: ESTOQUE_UNE (atual), ESTOQUE_LV (linha verde), ESTOQUE_CD (centro distribui\u00e7\u00e3o)\n- **Vendas**: VENDA_30DD (vendas \u00faltimos 30 dias), ULTIMA_VENDA_DATA_UNE\n- **Pre\u00e7os**: PRECO_VENDA, PRECO_CUSTO\n- **Status**: SITUACAO, PICKLIST_SITUACAO\n\nMAPEAMENTO DE FILTROS (use exatamente esses nomes):\n- Para filtrar por UNE: {\"une\": 2365} ou {\"UNE\": 2365}\n- Para filtrar por fabricante: {\"nomefabricante\": \"NOME_FABRICANTE\"}\n- Para filtrar por produto: {\"codigo\": \"123456\"} ou {\"PRODUTO\": \"123456\"}\n- Para filtrar por segmento: {\"nomesegmento\": \"TECIDOS\"}\n\nFERRAMENTAS DISPON\u00cdVEIS:\n\n1. **consultar_dados_flexivel** - USE PARA QUALQUER CONSULTA DE DADOS\n   Par\u00e2metros importantes:\n   - filtros: {\"une\": 2365, \"nomesegmento\": \"TECIDOS\"}\n   - agregacao: \"sum\", \"avg\", \"count\", \"min\", \"max\"\n   - coluna_agregacao: \"venda_30dd\", \"estoque_atual\", \"preco_venda\"\n   - agrupar_por: [\"une\"], [\"nomefabricante\"], [\"nomesegmento\"]\n   - ordenar_por: \"venda_30dd\", \"estoque_atual\"\n   - limite: n\u00famero de resultados (padr\u00e3o 20)\n\n2. **consultar_dados_gerais** - Alternativa para consultas simples\n\n3. **calcular_abastecimento_une** - Produtos que precisam reposi\u00e7\u00e3o\n\n4. **calcular_mc_produto** - M\u00e9dia Comum (MC) de produtos\n\n5. **calcular_preco_final_une** - Pre\u00e7os com descontos aplicados\n\n6. **sugerir_transferencias_automaticas** - Sugest\u00f5es de transfer\u00eancia entre lojas\n\n7. **validar_transferencia_produto** - Validar viabilidade de transfer\u00eancias\n\n8. **encontrar_rupturas_criticas** - Produtos em ruptura cr\u00edtica\n\nEXEMPLOS DE USO:\n\nPergunta: \"Ol\u00e1, como voc\u00ea est\u00e1?\"\nResposta: \"Ol\u00e1! Estou muito bem, obrigado por perguntar! \ud83d\ude0a Como posso ajud\u00e1-lo hoje? Posso responder perguntas gerais ou ajud\u00e1-lo com an\u00e1lises de dados de BI da Caculinha.\"\n\nPergunta: \"Qual \u00e9 a capital do Brasil?\"\nResposta: \"A capital do Brasil \u00e9 Bras\u00edlia, localizada no Distrito Federal. Foi inaugurada em 21 de abril de 1960 durante o governo de Juscelino Kubitschek.\"", "mimetype": "text/plain", "start_char_idx": 5907, "end_char_idx": 8760, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "58d9708f-89f0-4230-83c2-f5c6321f56ec": {"__data__": {"id_": "58d9708f-89f0-4230-83c2-f5c6321f56ec", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "94e3c0e49ebb18f9c0681d74f819bd99e809afa886d9d6be4d8f1482d08cc2b5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "e3e34443-694a-407b-a57f-003f4d782a19", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "567012b28a459df6c1cf6bbc8e38068bd684ed1e182205581da6c83a9152df32", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "d95d6df5-7def-4c8c-92b8-ad0582f6b116", "node_type": "1", "metadata": {}, "hash": "ebbd4e47ab4d2b13283abebcda1a44f132975362ffc8cac8b52a8af403c00dc6", "class_name": "RelatedNodeInfo"}}, "text": "**sugerir_transferencias_automaticas** - Sugest\u00f5es de transfer\u00eancia entre lojas\n\n7. **validar_transferencia_produto** - Validar viabilidade de transfer\u00eancias\n\n8. **encontrar_rupturas_criticas** - Produtos em ruptura cr\u00edtica\n\nEXEMPLOS DE USO:\n\nPergunta: \"Ol\u00e1, como voc\u00ea est\u00e1?\"\nResposta: \"Ol\u00e1! Estou muito bem, obrigado por perguntar! \ud83d\ude0a Como posso ajud\u00e1-lo hoje? Posso responder perguntas gerais ou ajud\u00e1-lo com an\u00e1lises de dados de BI da Caculinha.\"\n\nPergunta: \"Qual \u00e9 a capital do Brasil?\"\nResposta: \"A capital do Brasil \u00e9 Bras\u00edlia, localizada no Distrito Federal. Foi inaugurada em 21 de abril de 1960 durante o governo de Juscelino Kubitschek.\"\n\nPergunta: \"Vendas totais do segmento TECIDOS na UNE 2365\"\nUsar: consultar_dados_flexivel(filtros={\"une\": 2365, \"nomesegmento\": \"TECIDOS\"}, agregacao=\"sum\", coluna_agregacao=\"venda_30dd\")\n\nPergunta: \"Produtos do fabricante TNT\"\nUsar: consultar_dados_flexivel(filtros={\"nomefabricante\": \"TNT\"}, limite=20)\n\nPergunta: \"Total de vendas da UNE 261\"\nUsar: consultar_dados_flexivel(filtros={\"une\": 261}, agregacao=\"sum\", coluna_agregacao=\"venda_30dd\")\n\nPergunta: \"Top 10 mais vendidos\"\nUsar: consultar_dados_flexivel(ordenar_por=\"venda_30dd\", ordem_desc=True, limite=10)\n\nPergunta: \"Estoque por segmento\"\nUsar: consultar_dados_flexivel(agregacao=\"sum\", coluna_agregacao=\"estoque_atual\", agrupar_por=[\"nomesegmento\"])\n\nDIRETRIZES:\n- Responda QUALQUER pergunta, n\u00e3o se limite apenas a BI\n- Para perguntas gerais: seja \u00fatil, preciso e conversacional\n- Para perguntas sobre dados: SEMPRE use as ferramentas, NUNCA invente dados\n- Use os nomes de colunas EXATOS listados acima\n- Se a coluna n\u00e3o existir, informe ao usu\u00e1rio\n- Formate n\u00fameros: 1.234,56 (BR) ou use separadores de milhar\n- Seja conciso mas informativo\n- Use emojis: \ud83d\udcca \ud83d\udcc8 \u26a0\ufe0f \u2705 \ud83d\udce6 \ud83d\udcb0 \ud83d\ude0a \ud83d\udc4b\n\"\"\"\n\n    def _convert_tools_to_gemini_format(self, tools: List[BaseTool]) -> Dict[str, List[Dict[str, Any]]]:\n        \"\"\"Converts LangChain tools to Gemini API format.\"\"\"\n        declarations = []\n        for tool in tools:\n            # Generate schema using LangChain's standardized method\n            # compatible with Pydantic v1 and v2\n            try:\n                schema = tool.get_input_schema().model_json_schema()\n            except AttributeError:\n                # Fallback for older Pydantic or specific Tool implementations\n                if hasattr(tool, 'args_schema') and tool.args_schema:\n                    if hasattr(tool.args_schema, 'schema'):\n                         schema = tool.args_schema.schema()\n                    else:\n                         schema = {}\n                else:\n                    schema = {}\n            \n            # Clean schema to be compatible with Gemini (remove anyOf, titles)\n            cleaned_schema = self._clean_schema(schema)\n            \n            # Ensure 'properties' and 'required' are present if parameters exist\n            parameters = {\n                \"type\": \"object\",\n                \"properties\": cleaned_schema.get(\"properties\", {}),\n                \"required\": cleaned_schema.get(\"required\", [])\n            }\n\n            declarations.append({\n                \"name\": tool.name,\n                \"description\": tool.description,\n                \"parameters\": parameters\n            })\n        \n        return {\"function_declarations\": declarations}\n\n    def _clean_schema(self, schema: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"\n        Recursively cleans Pydantic JSON Schema for Gemini compatibility.\n        Removes 'anyOf', 'title', 'default', 'additionalProperties', and handles Optional types.\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 8114, "end_char_idx": 11698, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d95d6df5-7def-4c8c-92b8-ad0582f6b116": {"__data__": {"id_": "d95d6df5-7def-4c8c-92b8-ad0582f6b116", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "94e3c0e49ebb18f9c0681d74f819bd99e809afa886d9d6be4d8f1482d08cc2b5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "58d9708f-89f0-4230-83c2-f5c6321f56ec", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "efe50a5e469b7f6eec2ac0a553a9f41afc642c36f21abaf8fbe156ccfdabd826", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "8f47418a-0c22-4298-8f96-79bf36a6d497", "node_type": "1", "metadata": {}, "hash": "004a78961da1a88eaeb16b88ef0bb039c3dec7828a75de26f1969eda945ea149", "class_name": "RelatedNodeInfo"}}, "text": "Removes 'anyOf', 'title', 'default', 'additionalProperties', and handles Optional types.\n        \"\"\"\n        if not isinstance(schema, dict):\n            return schema\n            \n        new_schema = schema.copy()\n        \n        # Remove incompatible keys\n        if \"title\" in new_schema:\n            del new_schema[\"title\"]\n        if \"default\" in new_schema:\n            # Gemini sometimes complains about defaults in complex ways,\n            # but keeping them is usually fine. Removing 'title' is most important.\n            del new_schema[\"default\"]\n        if \"additionalProperties\" in new_schema:\n            # Gemini API doesn't support 'additionalProperties' field\n            del new_schema[\"additionalProperties\"]\n\n        # Handle anyOf (generated by Pydantic for Optional[Type])\n        if \"anyOf\" in new_schema:\n            options = new_schema.pop(\"anyOf\")\n            # Find the first non-null option\n            valid_option = next((opt for opt in options if opt.get(\"type\") != \"null\"), None)\n            if valid_option:\n                # Merge the valid option into the current schema\n                # We recurse here to clean the child option too\n                cleaned_child = self._clean_schema(valid_option)\n                new_schema.update(cleaned_child)\n            else:\n                # Fallback if all are null (unlikely) or empty\n                new_schema[\"type\"] = \"string\" \n\n        # Recurse into properties\n        if \"properties\" in new_schema:\n            for prop, prop_schema in new_schema[\"properties\"].items():\n                new_schema[\"properties\"][prop] = self._clean_schema(prop_schema)\n        \n        # Recurse into array items\n        if \"items\" in new_schema:\n            new_schema[\"items\"] = self._clean_schema(new_schema[\"items\"])\n\n        return new_schema\n\n    def run(self, user_query: str, chat_history: Optional[List[Dict]] = None) -> Dict[str, Any]:\n        \"\"\"\n        Executes the agent loop:\n        1. Send query + tools to LLM.\n        2. If LLM wants to call tool -> Execute tool -> Send result back to LLM.\n        3. Repeat until LLM returns text.\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 11598, "end_char_idx": 13734, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8f47418a-0c22-4298-8f96-79bf36a6d497": {"__data__": {"id_": "8f47418a-0c22-4298-8f96-79bf36a6d497", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "94e3c0e49ebb18f9c0681d74f819bd99e809afa886d9d6be4d8f1482d08cc2b5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "d95d6df5-7def-4c8c-92b8-ad0582f6b116", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "68fddbd98307838d3b8a4f9a9ac182f5ea8a79df6a96deae8982942dd4ae18a7", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "8545ec01-1c13-474f-b6f7-371094ed312c", "node_type": "1", "metadata": {}, "hash": "5fdc9ee67f111bef43d2a56c2379b704aa0bd568ad70b88d3deaa5975f7078e7", "class_name": "RelatedNodeInfo"}}, "text": "Send query + tools to LLM.\n        2. If LLM wants to call tool -> Execute tool -> Send result back to LLM.\n        3. Repeat until LLM returns text.\n        \"\"\"\n        logger.info(f\"CaculinhaBIAgent (Modern): Processing query: {user_query}\")\n\n        messages = [{\"role\": \"system\", \"content\": self.system_prompt}]\n        \n        # Add chat history if available\n        if chat_history:\n            for msg in chat_history:\n                role = msg.get(\"role\", \"user\")\n                content = msg.get(\"content\", \"\")\n                messages.append({\"role\": role, \"content\": content})\n\n        # Add current user query\n        messages.append({\"role\": \"user\", \"content\": user_query})\n\n        max_turns = 5\n        current_turn = 0\n\n        while current_turn < max_turns:\n            try:\n                # Call LLM with tools\n                # Note: self.llm is GeminiLLMAdapter\n                response = self.llm.get_completion(messages, tools=self.gemini_tools)\n                \n                if \"error\" in response:\n                    logger.error(f\"LLM Error: {response['error']}\")\n                    return self._generate_error_response(response['error'])\n\n                # Check for tool calls\n                if \"tool_calls\" in response:\n                    tool_calls = response[\"tool_calls\"]\n                    messages.append({\n                        \"role\": \"model\",\n                        \"tool_calls\": tool_calls\n                    })\n\n                    # Execute each tool\n                    for tc in tool_calls:\n                        func_name = tc[\"function\"][\"name\"]\n                        func_args = json.loads(tc[\"function\"][\"arguments\"])\n                        \n                        logger.info(f\"Agent calling tool: {func_name} with args: {func_args}\")\n                        \n                        # Find the matching tool\n                        tool_to_run = next((t for t in self.bi_tools if t.name == func_name), None)\n                        \n                        tool_result = None\n                        if tool_to_run:\n                            try:\n                                # Execute tool\n                                tool_output = tool_to_run.invoke(func_args)\n                                \n                                # CR\u00cdTICO: Converter MapComposite para dict ANTES de serializar\n                                def convert_mapcomposite(obj):\n                                    \"\"\"Recursivamente converte MapComposite para dict\"\"\"\n                                    if hasattr(obj, '_mapping'):\n                                        return dict(obj._mapping)\n                                    elif isinstance(obj, dict):\n                                        return {k: convert_mapcomposite(v) for k, v in obj.items()}\n                                    elif isinstance(obj, list):\n                                        return [convert_mapcomposite(item) for item in obj]\n                                    return obj\n                                \n                                # Converter o output antes de usar\n                                tool_result = convert_mapcomposite(tool_output)\n                                logger.info(f\"Tool {func_name} executed successfully, result type: {type(tool_result)}\")\n                            except Exception as e:\n                                logger.error(f\"Error executing {func_name}: {e}\", exc_info=True)\n                                tool_result = {\"error\": str(e)}\n                        else:\n                            tool_result = {\"error\": f\"Tool {func_name} not found\"}\n\n                        # Add tool result to messages (User role with function_response)\n                        # The adapter expects specific structure for function responses\n                        # Use safe_json_serialize to handle any remaining non-serializable types\n                        messages.append({\n                            \"role\": \"function\", # Adapter will map this to user/function_response\n                            \"function_call\": {\"name\": func_name}, # Metadata for adapter\n                            \"content\": safe_json_serialize(tool_result)\n                        })\n                    \n                    # Loop continues to send tool outputs back to LLM\n                    current_turn += 1\n                    continue\n                \n                # If no tool calls, it's a text response (Final Answer)\n                content = response.get(\"content\", \"\")\n                \n                # NOVO: Verificar se a \u00faltima ferramenta retornou uma tabela Markdown\n                # Se sim, usar diretamente essa mensagem em vez de confiar no LLM\n                logger.info(f\"DEBUG: Verificando dados tabulares. Total de mensagens: {len(messages)}\")\n                \n                for msg in reversed(messages):\n                    if msg.get(\"role\") == \"function\":\n                        try:\n                            content_str = msg.get(\"content\", \"{}\")\n                            func_content = json.loads(content_str)\n                            \n                            # Verificar se a mensagem cont\u00e9m uma tabela Markdown\n                            mensagem = func_content.get(\"mensagem\", \"\")\n                            if isinstance(mensagem, str) and \"|\" in mensagem and \"---\" in mensagem:\n                                logger.info(f\"SUCESSO: Tabela Markdown detectada na mensagem da ferramenta!\")", "mimetype": "text/plain", "start_char_idx": 13573, "end_char_idx": 19085, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8545ec01-1c13-474f-b6f7-371094ed312c": {"__data__": {"id_": "8545ec01-1c13-474f-b6f7-371094ed312c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "58334eb2-4abf-4aa9-a68e-ee1ce63aa522", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "94e3c0e49ebb18f9c0681d74f819bd99e809afa886d9d6be4d8f1482d08cc2b5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8f47418a-0c22-4298-8f96-79bf36a6d497", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}, "hash": "d9ff8c33b819bbe8714aecf9c1a35d5f5d7a27345213ed8da726b4c6c7d9a46b", "class_name": "RelatedNodeInfo"}}, "text": "Total de mensagens: {len(messages)}\")\n                \n                for msg in reversed(messages):\n                    if msg.get(\"role\") == \"function\":\n                        try:\n                            content_str = msg.get(\"content\", \"{}\")\n                            func_content = json.loads(content_str)\n                            \n                            # Verificar se a mensagem cont\u00e9m uma tabela Markdown\n                            mensagem = func_content.get(\"mensagem\", \"\")\n                            if isinstance(mensagem, str) and \"|\" in mensagem and \"---\" in mensagem:\n                                logger.info(f\"SUCESSO: Tabela Markdown detectada na mensagem da ferramenta!\")\n                                # Usar a mensagem com tabela diretamente como resposta\n                                return {\n                                    \"type\": \"text\",\n                                    \"result\": mensagem\n                                }\n                            \n                            # Tamb\u00e9m verificar se h\u00e1 dados brutos para retornar como code_result\n                            resultados = func_content.get(\"resultados\", [])\n                            if isinstance(resultados, list) and len(resultados) > 0:\n                                logger.info(f\"SUCESSO: Dados tabulares detectados: {len(resultados)} registros\")\n                                return {\n                                    \"type\": \"code_result\",\n                                    \"result\": {\n                                        \"result\": resultados,\n                                        \"chart_spec\": None\n                                    },\n                                    \"chart_spec\": None\n                                }\n                        except Exception as e:\n                            logger.error(f\"DEBUG: Erro ao parsear: {e}\")\n                        break  # S\u00f3 verificar a \u00faltima fun\u00e7\u00e3o\n                \n                logger.info(f\"DEBUG: Nenhum dado tabular detectado. Retornando texto do LLM.\")\n                # Caso contr\u00e1rio, retornar resposta de texto normal do LLM\n                return {\n                    \"type\": \"text\",\n                    \"result\": content\n                }\n\n            except Exception as e:\n                logger.error(f\"Exception in agent run loop: {e}\", exc_info=True)\n                return self._generate_error_response(str(e))\n\n        return self._generate_error_response(\"Maximum conversation turns exceeded.\")\n\n    def _generate_error_response(self, error_msg: str) -> Dict[str, Any]:\n        return {\n            \"type\": \"text\",\n            \"result\": f\"Desculpe, encontrei um erro ao processar sua solicita\u00e7\u00e3o: {error_msg}\"\n        }", "mimetype": "text/plain", "start_char_idx": 18375, "end_char_idx": 21126, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "535c9687-23e6-409c-81b6-1edc7e352359": {"__data__": {"id_": "535c9687-23e6-409c-81b6-1edc7e352359", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4bd6c109-ea92-48d9-ae98-0e3fd54f975e", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "hash": "d1684c9172950abd205d3364e46cd35fd6fa517818f1d8c89e5a38ee1c662109", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "50618e85-2f28-416a-a626-75e4abfa9cb5", "node_type": "1", "metadata": {}, "hash": "f224cc0651687d610fa479047b7051d3b9468644e5647079d613735e9976a934", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/agents/code_gen_agent.py\n\nimport json\nimport re\nimport logging\nfrom typing import Any, Dict, List, Optional\nimport os\nfrom functools import lru_cache\n\nfrom app.core.utils.field_mapper import FieldMapper\nfrom app.core.utils.error_handler import APIError\nfrom app.core.utils.query_history import QueryHistory\nfrom app.core.utils.response_cache import ResponseCache \nfrom app.config.settings import settings \nfrom app.core.learning.pattern_matcher import PatternMatcher\nfrom app.core.rag.query_retriever import QueryRetriever\n\nlogger = logging.getLogger(__name__)\n\nLANGCHAIN_AVAILABLE = False\ntry:\n    from langchain_core.language_models import BaseChatModel\n    from langchain_core.prompts import ChatPromptTemplate\n    from langchain_core.output_parsers import JsonOutputParser\n    from langchain_core.runnables import RunnablePassthrough\n    LANGCHAIN_AVAILABLE = True\nexcept (ImportError, OSError):\n    logger.warning(\"LangChain dependencies missing. CodeGenAgent will be disabled.\")\n    BaseChatModel = object # Dummy for type hinting\n\n# Helper to load prompts from files\n@lru_cache(maxsize=None)\ndef _load_prompt_template(filename: str) -> str:\n    current_dir = os.path.dirname(__file__)\n    prompt_path = os.path.join(current_dir, \"..\", \"prompts\", filename)\n    if os.path.exists(prompt_path):\n        with open(prompt_path, \"r\", encoding=\"utf-8\") as f:\n            return f.read()\n    return \"\"\n\nclass CodeGenAgent:\n    \"\"\"\n    Agent responsible for generating, validating, executing Python code for data analysis,\n    and self-healing in case of errors.\n    \"\"\"\n    def __init__(\n        self,\n        llm: BaseChatModel,\n        field_mapper: FieldMapper,\n        query_retriever: QueryRetriever,\n        pattern_matcher: PatternMatcher,\n        response_cache: ResponseCache = None,\n        query_history: QueryHistory = None,\n    ):\n        self.llm = llm\n        self.field_mapper = field_mapper\n        self.query_retriever = query_retriever\n        self.pattern_matcher = pattern_matcher\n        self.response_cache = response_cache if response_cache else ResponseCache()\n        self.query_history = query_history if query_history else QueryHistory()\n\n        if LANGCHAIN_AVAILABLE:\n            self.code_gen_prompt_template = _load_prompt_template(\"code_generation_system_prompt.md\")\n            self.code_gen_prompt = ChatPromptTemplate.from_messages([\n                (\"system\", self.code_gen_prompt_template), \n                (\"human\", \"{user_query}\\nSchema: {data_schema_info}\\nExamples: {few_shot_examples}\\nCode:\"),\n            ])\n            self.output_parser = JsonOutputParser()\n        else:\n            self.code_gen_prompt = None\n            self.output_parser = None\n\n    def _get_code_generation_system_prompt(self) -> str:\n        # This method is no longer needed as prompt is loaded from file\n        pass\n\n    def generate_and_execute_python_code(self, user_query: str, data_schema: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"\n        Generates Python code based on user query and data schema, executes it,\n        and returns results, including chart specifications if requested.\n        Includes self-healing for common errors.\n        \"\"\"\n        if not LANGCHAIN_AVAILABLE:\n             raise APIError(\"CodeGenAgent indispon\u00edvel devido a falta de depend\u00eancias (LangChain/Torch).\", status_code=503)\n\n        cache_key = self.response_cache.generate_key(user_query)\n        cached_response = self.response_cache.get(cache_key)\n        if cached_response:\n            print(f\"CodeGenAgent: Cache hit for query: {user_query}\")\n            return cached_response", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3619, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "50618e85-2f28-416a-a626-75e4abfa9cb5": {"__data__": {"id_": "50618e85-2f28-416a-a626-75e4abfa9cb5", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4bd6c109-ea92-48d9-ae98-0e3fd54f975e", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "hash": "d1684c9172950abd205d3364e46cd35fd6fa517818f1d8c89e5a38ee1c662109", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "535c9687-23e6-409c-81b6-1edc7e352359", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "hash": "24a7531ee253304fc4c28855bf09cecb9623a04ce62fbc6134927b7e32cd559b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "1bf98a6c-83fe-48ef-a922-2c9d16bab0a0", "node_type": "1", "metadata": {}, "hash": "135cd18b94b88995bad762ddb6ab9d7fc6f640074c3ef0572adf444be54965c9", "class_name": "RelatedNodeInfo"}}, "text": "# Override available_columns with ACTUAL DataFrame columns from une_tools\n        # This prevents the LLM from hallucinating column names based on the FieldMapper catalog\n        available_columns = ['codigo', 'nome_produto', 'une', 'estoque_atual', 'linha_verde', 'mc', 'venda_30_d', 'nomesegmento', 'NOMEFABRICANTE']\n\n        # T2.3.1: Integrate with PatternMatcher (few-shot) and QueryRetriever (RAG)\n        few_shot_examples = self._get_few_shot_examples(user_query)\n\n        # T2.3.5: Create prompt of code generation\n        code_gen_chain = (\n            RunnablePassthrough.assign(\n                available_columns=lambda x: \", \".join(available_columns),\n                few_shot_examples=lambda x: self._get_few_shot_examples(x[\"user_query\"]) # Will use query_retriever later\n            )\n            | self.code_gen_prompt.partial(available_columns=\", \".join(available_columns)) # Format system prompt here\n            | self.llm\n            | self.output_parser\n        )\n\n        retries = 0\n        max_retries = 3\n        generated_code_output = None\n        while retries <= max_retries:\n            try:\n                # Assuming the LLM will return a JSON string\n                llm_response = code_gen_chain.invoke({\n                    \"user_query\": user_query,\n                    \"data_schema_info\": data_schema,\n                    \"available_columns\": available_columns,\n                    \"few_shot_examples\": few_shot_examples\n                })\n                \n                generated_code_output = llm_response # LLM should return parsed JSON\n\n                # T2.3.2: Validate generated code for 'top N' and auto-recovery (T2.3.3)\n                code_to_execute = self._validate_and_heal_code(generated_code_output.get(\"code\", \"\"), user_query, retries)\n                \n                # Execute the code - Placeholder for a safe execution environment\n                execution_result = self._safely_execute_code(code_to_execute, available_columns)\n                \n                final_response = {\n                    \"type\": \"code_result\",\n                    \"result\": execution_result,\n                    \"chart_spec\": generated_code_output.get(\"chart_spec\") # Pass through chart spec if present\n                }\n                self.response_cache.set(cache_key, final_response)\n                return final_response\n\n            except APIError as e:\n                logger.warning(f\"CodeGenAgent: APIError during code generation/execution: {e.message}. Retrying...\")\n                retries += 1\n                if retries > max_retries:\n                    raise APIError(f\"Falha na gera\u00e7\u00e3o/execu\u00e7\u00e3o de c\u00f3digo ap\u00f3s {max_retries} tentativas: {e.message}\", status_code=500) from e\n                # Potentially modify prompt for retry based on error\n                user_query = f\"{user_query}\\n\\nPrevious attempt failed with error: {e.message}. Please refine the code.\"\n            except Exception as e:\n                logger.error(f\"CodeGenAgent: Unexpected error during code generation/execution: {e}\", exc_info=True)\n                retries += 1\n                if retries > max_retries:\n                    raise APIError(f\"Erro inesperado durante a gera\u00e7\u00e3o/execu\u00e7\u00e3o de c\u00f3digo ap\u00f3s {max_retries} tentativas: {str(e)}\", status_code=500) from e\n                user_query = f\"{user_query}\\n\\nPrevious attempt failed with a general error: {str(e)}. Please refine the code.\"\n\n        raise APIError(\"CodeGenAgent: Falha cr\u00edtica na gera\u00e7\u00e3o e execu\u00e7\u00e3o de c\u00f3digo.\", status_code=500)\n\n    def _get_few_shot_examples(self, user_query: str) -> str:\n        \"\"\"\n        Combines pattern matching and RAG to provide few-shot examples.\n        T2.3.1: Integrate with PatternMatcher (few-shot) and QueryRetriever (RAG).\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 3630, "end_char_idx": 7402, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1bf98a6c-83fe-48ef-a922-2c9d16bab0a0": {"__data__": {"id_": "1bf98a6c-83fe-48ef-a922-2c9d16bab0a0", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4bd6c109-ea92-48d9-ae98-0e3fd54f975e", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "hash": "d1684c9172950abd205d3364e46cd35fd6fa517818f1d8c89e5a38ee1c662109", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "50618e85-2f28-416a-a626-75e4abfa9cb5", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "hash": "db7791a9f19284c3a3f40850d26b91021d7de29bc8bb0f3222fd24c49a6e3554", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "0cad90a1-8971-4dc4-8525-49497c5c056c", "node_type": "1", "metadata": {}, "hash": "f39cd2ad8c912af09cb8557453623bdaa793a009866855a04ca2752856508a11", "class_name": "RelatedNodeInfo"}}, "text": "Please refine the code.\"\n\n        raise APIError(\"CodeGenAgent: Falha cr\u00edtica na gera\u00e7\u00e3o e execu\u00e7\u00e3o de c\u00f3digo.\", status_code=500)\n\n    def _get_few_shot_examples(self, user_query: str) -> str:\n        \"\"\"\n        Combines pattern matching and RAG to provide few-shot examples.\n        T2.3.1: Integrate with PatternMatcher (few-shot) and QueryRetriever (RAG).\n        \"\"\"\n        examples_str = \"\"\n        # From PatternMatcher (exact/known patterns)\n        pattern_match = self.pattern_matcher.match_pattern(user_query)\n        if pattern_match and pattern_match.get(\"example_code\"):\n            examples_str += f\"Exemplo de padr\u00e3o correspondente: {pattern_match['pattern_name']}\\n```python\\n{pattern_match['example_code']}\\n```\\n\"\n\n        # From QueryRetriever (semantically similar past queries)\n        similar_queries = self.query_retriever.get_similar_queries(user_query)\n        if similar_queries:\n            examples_str += \"Exemplos de queries similares passadas:\\n\"\n            for sq in similar_queries:\n                examples_str += f\"- Query: {sq.get('query')}\\n  C\u00f3digo: ```python\\n{sq.get('code')}\\n```\\n\"\n        \n        if not examples_str:\n            examples_str = \"Nenhum exemplo few-shot adicional encontrado.\"\n        return examples_str\n\n\n    def _validate_and_heal_code(self, code: str, user_query: str, attempt: int) -> str:\n        \"\"\"\n        T2.3.2: Implement validation for 'top N' and T2.3.3: auto-recovery of common errors.\n        \"\"\"\n        if not code:\n            raise APIError(\"Generated code is empty.\", status_code=400)\n        \n        # T2.3.2: Implement validation of `top N`\n        code = self._validate_top_n(code, user_query)\n\n        # T2.3.3: Implement auto-recovery of common errors based on attempt\n        if attempt > 0: # Only try healing on subsequent attempts\n            code = self._attempt_auto_healing(code, user_query)\n        \n        return code\n\n    def _validate_top_n(self, code: str, user_query: str) -> str:\n        \"\"\"\n        Detects \"top N\" or similar phrases in the user query and ensures\n        '.head(N)' or '.tail(N)' is applied to the final result if relevant.\n        \"\"\"\n        # Example: \"top 10 produtos\", \"os 5 maiores\"\n        top_n_match = re.search(r'(top|os|as)\\s*(\\d+)\\s*(maiores|menores)?', user_query, re.IGNORECASE)\n        if top_n_match:\n            n = int(top_n_match.group(2))\n            maior_menor = top_n_match.group(3)\n            \n            # Simple heuristic: look for the last assignment to 'result' or 'final_output'\n            # and append .head(n) or .tail(n) if not already present.\n            lines = code.split('\\n')\n            new_lines = []\n            applied_head_tail = False\n            for line in reversed(lines):\n                if not applied_head_tail and (\"result =\" in line or \"final_output =\" in line) and \".head(\" not in line and \".tail(\" not in line:\n                    indent = len(line) - len(line.lstrip())\n                    if maior_menor and \"menores\" in maior_menor.lower():\n                        new_lines.append(f\"{ ' ' * indent}{line.strip()}.tail({n})\")\n                    else:\n                        new_lines.append(f\"{ ' ' * indent}{line.strip()}.head({n})\")\n                    applied_head_tail = True\n                else:\n                    new_lines.append(line)\n            return \"\\n\".join(reversed(new_lines))\n        return code\n\n    def _attempt_auto_healing(self, code: str, user_query: str) -> str:\n        \"\"\"\n        Implements basic self-healing for common code errors.\n        This is a very simplistic example and would be more sophisticated with LLM interaction.\n        \"\"\"\n        # Example 1: Remove .compute() if it's causing issues with Polars\n        if \".compute()\" in code and \"PolarsError: compute\" in user_query: # Check for error msg in user_query for context\n            code = code.replace(\".compute()\", \"\")\n            logger.info(\"Auto-healing: Removed .compute() from code.\")", "mimetype": "text/plain", "start_char_idx": 7031, "end_char_idx": 11001, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0cad90a1-8971-4dc4-8525-49497c5c056c": {"__data__": {"id_": "0cad90a1-8971-4dc4-8525-49497c5c056c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4bd6c109-ea92-48d9-ae98-0e3fd54f975e", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "hash": "d1684c9172950abd205d3364e46cd35fd6fa517818f1d8c89e5a38ee1c662109", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "1bf98a6c-83fe-48ef-a922-2c9d16bab0a0", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "hash": "1de2c844e3f8b7b5d05189652b55ff1bdc508c190bc4b4049019b9724d4d39a6", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "1a339394-03b9-4eaa-aa2a-99098db55e70", "node_type": "1", "metadata": {}, "hash": "9fb5dfcb7ccc1fddd7afaea6b31b0ada4bed808c21728089574200ca3233b9d8", "class_name": "RelatedNodeInfo"}}, "text": "This is a very simplistic example and would be more sophisticated with LLM interaction.\n        \"\"\"\n        # Example 1: Remove .compute() if it's causing issues with Polars\n        if \".compute()\" in code and \"PolarsError: compute\" in user_query: # Check for error msg in user_query for context\n            code = code.replace(\".compute()\", \"\")\n            logger.info(\"Auto-healing: Removed .compute() from code.\")\n            \n        # Example 2: Add .dropna() for ambiguous NA errors\n        if \"NA ambiguous\" in user_query and \".dropna()\" not in code:\n            # Find a suitable place to insert .dropna()\n            lines = code.split('\\n')\n            new_lines = []\n            inserted_dropna = False\n            for line in lines:\n                new_lines.append(line)\n                if \"df.\" in line and \"groupby\" in line and not inserted_dropna: # Example heuristic\n                    new_lines.append(f\"{ ' ' * (len(line) - len(line.lstrip()))}.dropna()\")\n                    inserted_dropna = True\n            if inserted_dropna:\n                code = \"\\n\".join(new_lines)\n                logger.info(\"Auto-healing: Added .dropna() to code.\")\n        \n        # Example 3: Suggest column correction via FieldMapper if error indicates missing column\n        if \"ColumnNotFound\" in user_query: # Placeholder for error message\n            missing_col_match = re.search(r\"ColumnNotFound:\\s*'([^']+)'\", user_query)\n            if missing_col_match:\n                missing_col = missing_col_match.group(1)\n                suggestion = self.field_mapper.suggest_correction(missing_col)\n                if suggestion and suggestion != missing_col:\n                    logger.info(f\"Auto-healing: Suggested correction for missing column '{missing_col}' to '{suggestion}'.\")\n                    # This would ideally involve regenerating code with the corrected column\n                    # For now, it's just a log.\n        return code\n\n    def _safely_execute_code(self, code: str, data_schema: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"\n        Executes the generated Python code in a safe environment.\n        This is a critical component for security.\n        \"\"\"\n        # CRITICAL: This is a simplified example. In a production system,\n        # code execution should happen in an isolated sandbox (e.g., Docker container, separate process)\n        # to prevent arbitrary code execution vulnerabilities.", "mimetype": "text/plain", "start_char_idx": 10585, "end_char_idx": 13011, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1a339394-03b9-4eaa-aa2a-99098db55e70": {"__data__": {"id_": "1a339394-03b9-4eaa-aa2a-99098db55e70", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4bd6c109-ea92-48d9-ae98-0e3fd54f975e", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "hash": "d1684c9172950abd205d3364e46cd35fd6fa517818f1d8c89e5a38ee1c662109", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "0cad90a1-8971-4dc4-8525-49497c5c056c", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}, "hash": "e423b24cebf632eed74a4b70f4724fca2b1f12cc88542bea6f033069ac323556", "class_name": "RelatedNodeInfo"}}, "text": "# This would ideally involve regenerating code with the corrected column\n                    # For now, it's just a log.\n        return code\n\n    def _safely_execute_code(self, code: str, data_schema: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"\n        Executes the generated Python code in a safe environment.\n        This is a critical component for security.\n        \"\"\"\n        # CRITICAL: This is a simplified example. In a production system,\n        # code execution should happen in an isolated sandbox (e.g., Docker container, separate process)\n        # to prevent arbitrary code execution vulnerabilities.\n        \n        # Load real data from Parquet using une_tools\n        import polars as pl # Import polars here to ensure it's available for execution context\n        from app.core.tools.une_tools import _load_data\n\n        # Load real data from Parquet files\n        pandas_df = _load_data()  # Returns pandas DataFrame\n        df = pl.from_pandas(pandas_df)  # Convert to polars DataFrame\n        \n        # Provide necessary libraries and the DataFrame in the execution context\n        # Restrict builtins for enhanced safety\n        exec_globals = {\n            \"pl\": pl,\n            \"df\": df,\n            \"json\": json,\n            \"__builtins__\": {\n                \"list\": list, \"dict\": dict, \"str\": str, \"int\": int, \"float\": float,\n                \"len\": len, \"sum\": sum, \"min\": min, \"max\": max, \"range\": range,\n                \"round\": round, \"abs\": abs, \"Exception\": Exception, \"ValueError\": ValueError,\n                \"TypeError\": TypeError, \"sorted\": sorted, \"enumerate\": enumerate, \n                \"zip\": zip, \"set\": set, \"tuple\": tuple, \"any\": any, \"all\": all, \"bool\": bool\n            }\n        }\n\n        try:\n            exec(code, exec_globals)\n            \n            result = exec_globals.get(\"final_output\", {}).get(\"result\", {})\n            chart_spec = exec_globals.get(\"final_output\", {}).get(\"chart_spec\")\n\n            # Ensure result is JSON-serializable if it's a Polars object\n            if isinstance(result, pl.DataFrame):\n                result = result.to_dicts()\n            elif isinstance(result, pl.Series):\n                 result = result.to_list()\n            elif isinstance(result, list) and all(isinstance(i, (pl.Series, pl.DataFrame)) for i in result):\n                 result = [item.to_dicts() if isinstance(item, pl.DataFrame) else item.to_list() for item in result]\n            \n            return {\"result\": result, \"chart_spec\": chart_spec}\n\n        except Exception as e:\n            # This exception is caught by the error_handler_decorator\n            raise APIError(\n                message=f\"Erro durante a execu\u00e7\u00e3o do c\u00f3digo Python: {str(e)}\",\n                status_code=400,\n                details={\"code_executed\": code, \"error_type\": type(e).__name__, \"error_detail\": str(e)}\n            )", "mimetype": "text/plain", "start_char_idx": 12393, "end_char_idx": 15263, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5127c329-e747-4dc5-8f80-1e58a35e23c1": {"__data__": {"id_": "5127c329-e747-4dc5-8f80-1e58a35e23c1", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\developer_agent.py", "language": "python", "lines": 136, "filename": "developer_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "75482dc6-110f-4a7f-8d2f-1c589e68b7bc", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\developer_agent.py", "language": "python", "lines": 136, "filename": "developer_agent.py"}, "hash": "90e619591a5ac17dd90df7140531929b7e02295114f7fd3d6e1c5c2f78402de5", "class_name": "RelatedNodeInfo"}}, "text": "import logging\n\nfrom .base_agent import BaseAgent\nfrom .prompt_loader import PromptLoader\n\n# Configura\u00e7\u00e3o de logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format=\"%(asctime)s - %(name)s - %(levelname)s - %(message)s\",\n    filename=\"logs/agent.log\",\n    filemode=\"a\",\n)\nlogger = logging.getLogger(\"developer_agent\")\n\n\nclass DeveloperAgent(BaseAgent):\n    \"\"\"Agente especializado em desenvolvimento de c\u00f3digo.\"\"\"\n\n    def __init__(self, session_id=None, use_mock_data=False, mcp_adapter=None):\n        \"\"\"\n        Inicializa o Agente de Desenvolvimento.\n\n        Args:\n            session_id (str): ID da sess\u00e3o para persist\u00eancia de estado.\n            use_mock_data (bool): Flag para usar dados mockados.\n            mcp_adapter (object): Adaptador MCP para SQL Server.\n        \"\"\"\n        super().__init__(session_id, use_mock_data, mcp_adapter)\n        self._load_prompts()\n        logger.info(\"Agente de Desenvolvimento inicializado. Sess\u00e3o: %s\", session_id)\n\n    def _load_prompts(self):\n        \"\"\"Carrega os prompts do arquivo ou usa um fallback.\"\"\"\n        prompt_loader = PromptLoader()\n        prompt_data = prompt_loader.load_prompt(\"prompt_developer_agent\")\n\n        if prompt_data:\n            self.system_prompt = prompt_data.get(\"system_prompt\", \"\")\n            self.capabilities = prompt_data.get(\"capabilities\", [])\n            self.safety_rules = prompt_data.get(\"safety_rules\", [])\n            self.model_config = prompt_data.get(\"model_config\", {})\n            logger.info(\"Prompt carregado com sucesso para o Agente de Desenvolvimento.\")\n        else:\n            self.system_prompt = (\n                \"Voc\u00ea \u00e9 um assistente virtual \"\n                \"especializado em desenvolvimento de c\u00f3digo.\"\n            )\n            self.capabilities = [\"code_development\", \"code_review\", \"debugging\"]\n            self.safety_rules = [\"no_malicious_code\", \"portuguese_only_responses\"]\n            self.model_config = {\"model\": \"gpt-35-turbo\", \"temperature\": 0.2}\n            logger.warning(\"Usando prompt padr\u00e3o para o Agente de Desenvolvimento.\")\n\n    def process_query(self, query):\n        \"\"\"\n        Processa uma consulta com foco em desenvolvimento de c\u00f3digo.\n\n        Args:\n            query (str): A consulta do usu\u00e1rio.\n\n        Returns:\n            dict: Resposta processada.\n        \"\"\"\n        logger.info(\"Agente de Desenvolvimento processando consulta: %s\", query)\n\n        if not self._is_relevant_query(query):\n            logger.info(\"Consulta n\u00e3o relevante para o agente Dev: %s\", query)\n            return {\n                \"response\": (\n                    \"Esta consulta pode ser melhor atendida por outro \"\n                    \"agente especializado.\"\n                ),\n                \"relevant\": False,\n            }\n\n        try:\n            result = super().process_query(query)\n\n            if self._should_suggest_improvements(query):\n                result[\"response\"] += (\n                    \"\\n\\nPosso sugerir algumas melhorias para este c\u00f3digo. \"\n                    \"Gostaria de v\u00ea-las?\"\n                )\n                result[\"can_improve\"] = True\n\n            return result\n        except Exception as e:\n            logger.error(\"Erro no Agente de Desenvolvimento: %s\", e)\n            return {\n                \"response\": \"Desculpe, ocorreu um erro ao processar sua consulta.\",\n                \"error\": str(e),\n            }\n\n    def _is_relevant_query(self, query):\n        \"\"\"Verifica se a consulta \u00e9 relevante para este agente.\"\"\"\n        query_lower = query.lower()\n        keywords = [\n            \"c\u00f3digo\",\n            \"programa\u00e7\u00e3o\",\n            \"desenvolver\",\n            \"implementar\",\n            \"fun\u00e7\u00e3o\",\n            \"classe\",\n            \"m\u00e9todo\",\n            \"refatorar\",\n            \"otimizar\",\n            \"debug\",\n            \"erro\",\n            \"bug\",\n            \"python\",\n            \"javascript\",\n            \"arquitetura\",\n            \"padr\u00e3o\",\n            \"design pattern\",\n            \"api\",\n            \"interface\",\n            \"m\u00f3dulo\",\n        ]\n        return any(keyword in query_lower for keyword in keywords)\n\n    def _should_suggest_improvements(self, query):\n        \"\"\"Verifica se deve sugerir melhorias de c\u00f3digo.\"\"\"\n        query_lower = query.lower()\n        improvement_keywords = [\n            \"revisar\",\n            \"melhorar\",\n            \"otimizar\",\n            \"refatorar\",\n            \"limpar\",\n            \"performance\",\n            \"desempenho\",\n            \"legibilidade\",\n            \"manuten\u00e7\u00e3o\",\n            \"seguran\u00e7a\",\n        ]\n        return any(keyword in query_lower for keyword in improvement_keywords)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4617, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ad269d0b-e7f4-4fb0-bb45-6a4ac0a5948e": {"__data__": {"id_": "ad269d0b-e7f4-4fb0-bb45-6a4ac0a5948e", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\multi_step_agent.py", "language": "python", "lines": 275, "filename": "multi_step_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fcd06331-492d-4004-ab85-d4b1e3e04703", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\multi_step_agent.py", "language": "python", "lines": 275, "filename": "multi_step_agent.py"}, "hash": "af7ab2b06e3e8f48563bdcc67e204db6cb08ec043c8df508e1e65aad1c5eb5bf", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "ff59811a-ee14-4f10-ace0-837a6996dd9b", "node_type": "1", "metadata": {}, "hash": "8abc55af22fabed40cc721d7c12347143693c3328c2ce72db39e2624a4a84b5e", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nLangGraph Multi-Step Agent - Workflow c\u00edclico para racioc\u00ednio avan\u00e7ado\nImplementa: Planner \u2192 Executor \u2192 Validator \u2192 (loop se necess\u00e1rio)\n\"\"\"\n\nimport logging\nfrom typing import Dict, Any, List, Optional, TypedDict, Annotated\nfrom dataclasses import dataclass\nimport operator\n\nlogger = logging.getLogger(__name__)\n\n# Tentar importar LangGraph - fallback se n\u00e3o dispon\u00edvel\ntry:\n    from langgraph.graph import StateGraph, END\n    LANGGRAPH_AVAILABLE = True\nexcept ImportError:\n    LANGGRAPH_AVAILABLE = False\n    logger.warning(\"LangGraph n\u00e3o dispon\u00edvel - usando implementa\u00e7\u00e3o simplificada\")\n\n\nclass AgentState(TypedDict):\n    \"\"\"Estado do agente durante execu\u00e7\u00e3o do workflow.\"\"\"\n    query: str                          # Pergunta original\n    plan: Optional[str]                 # Plano gerado\n    tool_calls: List[Dict[str, Any]]    # Chamadas de ferramentas\n    results: List[Dict[str, Any]]       # Resultados das ferramentas\n    response: Optional[str]             # Resposta final\n    validation: Optional[Dict[str, Any]]  # Resultado da valida\u00e7\u00e3o\n    iteration: int                      # N\u00famero da itera\u00e7\u00e3o\n    should_retry: bool                  # Se deve tentar novamente\n    error: Optional[str]                # Mensagem de erro\n\n\nclass MultiStepAgent:\n    \"\"\"\n    Agente multi-step com workflow c\u00edclico.\n    \n    Workflow:\n    1. Planner: Analisa query e define estrat\u00e9gia\n    2. Executor: Executa ferramentas necess\u00e1rias\n    3. Validator: Valida resultado e decide se precisa retry\n    4. (Loop): Se necess\u00e1rio, refina e tenta novamente\n    \"\"\"\n    \n    MAX_ITERATIONS = 3\n    \n    def __init__(self, agent, validator=None):\n        \"\"\"\n        Args:\n            agent: Agente base (CaculinhaBIAgent)\n            validator: Validador de respostas (opcional)\n        \"\"\"\n        self.agent = agent\n        self.validator = validator\n        self.execution_count = 0\n        \n        # Construir grafo se LangGraph dispon\u00edvel\n        if LANGGRAPH_AVAILABLE:\n            self.graph = self._build_graph()\n        else:\n            self.graph = None\n    \n    def _build_graph(self):\n        \"\"\"Constr\u00f3i o grafo de estados do workflow.\"\"\"\n        workflow = StateGraph(AgentState)\n        \n        # Adicionar nodes\n        workflow.add_node(\"planner\", self._planner_node)\n        workflow.add_node(\"executor\", self._executor_node)\n        workflow.add_node(\"validator\", self._validator_node)\n        \n        # Definir edges\n        workflow.set_entry_point(\"planner\")\n        workflow.add_edge(\"planner\", \"executor\")\n        workflow.add_edge(\"executor\", \"validator\")\n        \n        # Conditional edge: retry ou finalizar\n        workflow.add_conditional_edges(\n            \"validator\",\n            self._should_retry,\n            {\n                \"retry\": \"planner\",\n                \"end\": END\n            }\n        )\n        \n        return workflow.compile()\n    \n    def _planner_node(self, state: AgentState) -> AgentState:\n        \"\"\"Node de planejamento: analisa query e define estrat\u00e9gia.\"\"\"\n        logger.info(f\"\ud83d\udcdd Planner: Analisando query (iter={state['iteration']})\")\n        \n        # Criar plano baseado na query e itera\u00e7\u00e3o anterior\n        plan = f\"Analisar: {state['query'][:100]}\"\n        \n        if state['iteration'] > 0 and state.get('error'):\n            plan = f\"Retry devido a: {state['error'][:50]}. \" + plan\n        \n        return {**state, \"plan\": plan}\n    \n    def _executor_node(self, state: AgentState) -> AgentState:\n        \"\"\"Node de execu\u00e7\u00e3o: chama o agente base.\"\"\"\n        logger.info(f\"\u2699\ufe0f Executor: Executando plano\")\n        \n        try:\n            # Chamar agente base\n            result = self.agent.run(state['query'])\n            \n            return {\n                **state,\n                \"results\": [result],\n                \"response\": result.get(\"result\", \"\"),\n                \"error\": None\n            }\n        except Exception as e:\n            logger.error(f\"Erro no Executor: {e}\")\n            return {\n                **state,\n                \"error\": str(e),\n                \"response\": None\n            }\n    \n    def _validator_node(self, state: AgentState) -> AgentState:\n        \"\"\"Node de valida\u00e7\u00e3o: verifica qualidade da resposta.\"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4214, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ff59811a-ee14-4f10-ace0-837a6996dd9b": {"__data__": {"id_": "ff59811a-ee14-4f10-ace0-837a6996dd9b", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\multi_step_agent.py", "language": "python", "lines": 275, "filename": "multi_step_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fcd06331-492d-4004-ab85-d4b1e3e04703", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\multi_step_agent.py", "language": "python", "lines": 275, "filename": "multi_step_agent.py"}, "hash": "af7ab2b06e3e8f48563bdcc67e204db6cb08ec043c8df508e1e65aad1c5eb5bf", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "ad269d0b-e7f4-4fb0-bb45-6a4ac0a5948e", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\multi_step_agent.py", "language": "python", "lines": 275, "filename": "multi_step_agent.py"}, "hash": "ee699ebe3e18fb5e5e944954574b2f55f24c8ab948ddc7f11550374b61d6a200", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "46f3da86-a853-4441-8736-a97500e059f0", "node_type": "1", "metadata": {}, "hash": "33c35ab8d4feeaafaf3e8775100d6e9283f5c62435c257dd4c820c1dfd34a5ae", "class_name": "RelatedNodeInfo"}}, "text": "+ plan\n        \n        return {**state, \"plan\": plan}\n    \n    def _executor_node(self, state: AgentState) -> AgentState:\n        \"\"\"Node de execu\u00e7\u00e3o: chama o agente base.\"\"\"\n        logger.info(f\"\u2699\ufe0f Executor: Executando plano\")\n        \n        try:\n            # Chamar agente base\n            result = self.agent.run(state['query'])\n            \n            return {\n                **state,\n                \"results\": [result],\n                \"response\": result.get(\"result\", \"\"),\n                \"error\": None\n            }\n        except Exception as e:\n            logger.error(f\"Erro no Executor: {e}\")\n            return {\n                **state,\n                \"error\": str(e),\n                \"response\": None\n            }\n    \n    def _validator_node(self, state: AgentState) -> AgentState:\n        \"\"\"Node de valida\u00e7\u00e3o: verifica qualidade da resposta.\"\"\"\n        logger.info(f\"\u2705 Validator: Validando resposta\")\n        \n        # Se houve erro, marcar para retry\n        if state.get('error'):\n            return {\n                **state,\n                \"should_retry\": state['iteration'] < self.MAX_ITERATIONS,\n                \"iteration\": state['iteration'] + 1\n            }\n        \n        # Usar validador se dispon\u00edvel\n        if self.validator:\n            validation = self.validator.validate(\n                {\"result\": state.get('response', '')},\n                state['query']\n            )\n            \n            should_retry = (\n                not validation.is_valid and \n                validation.confidence < 0.5 and\n                state['iteration'] < self.MAX_ITERATIONS\n            )\n            \n            return {\n                **state,\n                \"validation\": {\n                    \"is_valid\": validation.is_valid,\n                    \"confidence\": validation.confidence,\n                    \"issues\": validation.issues\n                },\n                \"should_retry\": should_retry,\n                \"iteration\": state['iteration'] + 1\n            }\n        \n        # Sem validador, aceitar resposta\n        return {\n            **state,\n            \"validation\": {\"is_valid\": True, \"confidence\": 1.0},\n            \"should_retry\": False,\n            \"iteration\": state['iteration'] + 1\n        }\n    \n    def _should_retry(self, state: AgentState) -> str:\n        \"\"\"Decide se deve fazer retry ou finalizar.\"\"\"\n        if state.get('should_retry', False):\n            logger.info(f\"\ud83d\udd04 Retry: iteration={state['iteration']}\")\n            return \"retry\"\n        return \"end\"\n    \n    def run(self, query: str, chat_history: List[Dict] = None) -> Dict[str, Any]:\n        \"\"\"\n        Executa workflow multi-step.\n        \n        Args:\n            query: Pergunta do usu\u00e1rio\n            chat_history: Hist\u00f3rico de chat (opcional)\n            \n        Returns:\n            Resultado do agente\n        \"\"\"\n        self.execution_count += 1\n        logger.info(f\"\ud83d\ude80 MultiStepAgent: Iniciando workflow para: {query[:50]}...\")\n        \n        # Estado inicial\n        initial_state: AgentState = {\n            \"query\": query,\n            \"plan\": None,\n            \"tool_calls\": [],\n            \"results\": [],\n            \"response\": None,\n            \"validation\": None,\n            \"iteration\": 0,\n            \"should_retry\": False,\n            \"error\": None\n        }\n        \n        # Usar LangGraph se dispon\u00edvel\n        if self.graph and LANGGRAPH_AVAILABLE:\n            try:\n                final_state = self.graph.invoke(initial_state)\n                \n                return {\n                    \"type\": \"text\",\n                    \"result\": final_state.get(\"response\", \"\"),\n                    \"validation\": final_state.get(\"validation\"),\n                    \"iterations\": final_state.get(\"iteration\", 1)\n                }\n            except Exception as e:\n                logger.error(f\"Erro no LangGraph: {e}\")\n                # Fallback para implementa\u00e7\u00e3o simples\n        \n        # Implementa\u00e7\u00e3o simplificada (fallback)\n        return self._run_simple(query, chat_history)\n    \n    def _run_simple(self, query: str, chat_history: List[Dict] = None) -> Dict[str, Any]:\n        \"\"\"Implementa\u00e7\u00e3o simplificada sem LangGraph.\"\"\"", "mimetype": "text/plain", "start_char_idx": 3342, "end_char_idx": 7532, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "46f3da86-a853-4441-8736-a97500e059f0": {"__data__": {"id_": "46f3da86-a853-4441-8736-a97500e059f0", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\multi_step_agent.py", "language": "python", "lines": 275, "filename": "multi_step_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fcd06331-492d-4004-ab85-d4b1e3e04703", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\multi_step_agent.py", "language": "python", "lines": 275, "filename": "multi_step_agent.py"}, "hash": "af7ab2b06e3e8f48563bdcc67e204db6cb08ec043c8df508e1e65aad1c5eb5bf", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "ff59811a-ee14-4f10-ace0-837a6996dd9b", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\multi_step_agent.py", "language": "python", "lines": 275, "filename": "multi_step_agent.py"}, "hash": "f32003a42d6f9ce616a927719649ebc37a2cbc04014d2d6abfedb801bf0fcca2", "class_name": "RelatedNodeInfo"}}, "text": "logger.info(\"\ud83d\udcdd Usando implementa\u00e7\u00e3o simplificada (sem LangGraph)\")\n        \n        for iteration in range(self.MAX_ITERATIONS):\n            try:\n                # Executar agente\n                result = self.agent.run(query, chat_history)\n                \n                # Validar se poss\u00edvel\n                if self.validator:\n                    validation = self.validator.validate(result, query)\n                    \n                    if validation.is_valid or validation.confidence >= 0.5:\n                        return {\n                            **result,\n                            \"validation\": {\n                                \"confidence\": validation.confidence,\n                                \"issues\": validation.issues\n                            },\n                            \"iterations\": iteration + 1\n                        }\n                    \n                    logger.warning(f\"Valida\u00e7\u00e3o falhou (iter={iteration}): {validation.issues}\")\n                else:\n                    return {**result, \"iterations\": iteration + 1}\n                    \n            except Exception as e:\n                logger.error(f\"Erro na itera\u00e7\u00e3o {iteration}: {e}\")\n                if iteration == self.MAX_ITERATIONS - 1:\n                    return {\n                        \"type\": \"text\",\n                        \"result\": f\"Erro ap\u00f3s {self.MAX_ITERATIONS} tentativas: {str(e)}\",\n                        \"iterations\": iteration + 1\n                    }\n        \n        return {\n            \"type\": \"text\",\n            \"result\": \"N\u00e3o foi poss\u00edvel obter uma resposta v\u00e1lida.\",\n            \"iterations\": self.MAX_ITERATIONS\n        }\n    \n    def get_stats(self) -> Dict[str, Any]:\n        \"\"\"Retorna estat\u00edsticas do agente.\"\"\"\n        return {\n            \"execution_count\": self.execution_count,\n            \"max_iterations\": self.MAX_ITERATIONS,\n            \"langgraph_available\": LANGGRAPH_AVAILABLE\n        }\n\n\n# Factory function\ndef create_multi_step_agent(base_agent, validator=None) -> MultiStepAgent:\n    \"\"\"Cria inst\u00e2ncia do MultiStepAgent.\"\"\"\n    return MultiStepAgent(agent=base_agent, validator=validator)", "mimetype": "text/plain", "start_char_idx": 7541, "end_char_idx": 9681, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "823b5796-edeb-42a2-8c24-8feb053f334d": {"__data__": {"id_": "823b5796-edeb-42a2-8c24-8feb053f334d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a27465cd-c293-41cf-ae48-ed9ca95cc6a2", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "hash": "8b7de1524a6884a82b101c1901168f5ebcf2da9461641d6671885d47f4dcd612", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c57a51d6-8a13-4baf-9072-2e0d2e4db110", "node_type": "1", "metadata": {}, "hash": "44cb41b88b4143c37e5f6f1242ddf830914c476104a5f9883cab48ca2e689776", "class_name": "RelatedNodeInfo"}}, "text": "import logging\nimport re\nimport pandas as pd  # Importar pandas\n\nfrom app.core.utils.db_utils import get_table_df\n\n\nimport json\nfrom app.core.agents.caculinha_bi_agent import initialize_agent_for_session\n\n\nclass ProductAgent:\n    \"\"\"\n    Agente para consulta e an\u00e1lise de produtos, usando apenas Parquet.\n    \"\"\"\n\n    PRODUCT_TABLES = [\"ADMAT\", \"Admat_OPCOM\"]\n\n    def __init__(self):\n        self.logger = logging.getLogger(\"ProductAgent\")\n        self.catalog = self._load_catalog()\n        # Inicializa o agente LLM que ser\u00e1 usado para raciocinar sobre os dados\n        self.llm_agent = initialize_agent_for_session()\n        self.logger.info(\n            \"ProductAgent inicializado com o cat\u00e1logo de dados e agente LLM.\"\n        )\n\n    def _load_catalog(self):\n        \"\"\"Carrega o cat\u00e1logo de dados enriquecido.\"\"\"\n        catalog_path = \"data/CATALOGO_PARA_EDICAO.json\"\n        try:\n            with open(catalog_path, \"r\", encoding=\"utf-8\") as f:\n                return json.load(f)\n        except FileNotFoundError:\n            self.logger.error(\n                f\"Arquivo de cat\u00e1logo n\u00e3o encontrado em {catalog_path}. O agente pode n\u00e3o funcionar corretamente.\"\n            )\n            return []\n        except json.JSONDecodeError:\n            self.logger.error(\n                f\"Erro ao decodificar o JSON do cat\u00e1logo em {catalog_path}.\"\n            )\n            return []\n\n    def search_products(self, query, limit=10):\n        self.logger.info(f'Iniciando busca de produtos para a query: \"{query}\"')\n\n        prompt_for_llm = self._build_prompt_for_filter_extraction(query)\n\n        llm_response_raw = self.llm_agent.process_query(prompt_for_llm)\n\n        llm_response_obj = llm_response_raw.get(\"output\", llm_response_raw)\n\n        self.logger.info(f\"Resposta bruta do LLM: {llm_response_obj}\")\n\n        if isinstance(llm_response_obj, str):\n            try:\n                json_match = re.search(\n                    r\"```json\\n(.*?)```\", llm_response_obj, re.DOTALL\n                )\n                if json_match:\n                    json_str = json_match.group(1).strip()\n                else:\n                    json_str = llm_response_obj.strip()\n                extracted_filters = json.loads(json_str)\n            except json.JSONDecodeError as e:\n                self.logger.error(\n                    f\"Falha ao decodificar JSON da resposta do LLM: '{llm_response_obj}'. Erro: {e}\"\n                )\n                return {\n                    \"success\": False,\n                    \"message\": \"N\u00e3o consegui entender os crit\u00e9rios para a busca.\",\n                }\n        else:\n            extracted_filters = llm_response_obj\n\n        target_file = extracted_filters.get(\"target_file\", \"ADMAT.parquet\")\n        filters = extracted_filters.get(\"filters\", [])\n\n        self.logger.info(f\"Filtros extra\u00eddos: {filters} para o arquivo {target_file}\")\n\n        df = get_table_df(target_file.replace(\".parquet\", \"\"))\n        if df is None:\n            return {\n                \"success\": False,\n                \"message\": f\"Arquivo de dados {target_file} n\u00e3o encontrado.\",\n            }\n\n        results = df\n        if filters:\n            for f in filters:\n                col, op, val = f.get(\"column\"), f.get(\"operator\"), f.get(\"value\")\n                if col in results.columns:\n                    try:\n                        if op != \"contains\":\n                            results[col] = pd.to_numeric(results[col], errors=\"coerce\")\n                            val = pd.to_numeric(val)\n\n                        if op == \">\":\n                            results = results[results[col] > val]\n                        elif op == \"<\":\n                            results = results[results[col] < val]\n                        elif op == \"==\":\n                            results = results[results[col] == val]\n                        elif op == \"!=\":\n                            results = results[results[col] != val]\n                        elif op == \"contains\":\n                            results = results[\n                                results[col]\n                                .astype(str)\n                                .str.contains(str(val), case=False, na=False)\n                            ]\n                    except (ValueError, TypeError) as e:\n                        self.logger.error(\n                            f\"Erro ao aplicar filtro na coluna '{col}': {e}\"\n                        )\n                        results = results[\n                            results[col]\n                            .astype(str)\n                            .str.contains(str(val), case=False, na=False)\n                        ]\n                else:\n                    self.logger.warning(f\"Coluna '{col}' n\u00e3o encontrada.\")\n\n        if results.empty:\n            return {\n                \"success\": False,\n                \"message\": \"Nenhum produto encontrado.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4899, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c57a51d6-8a13-4baf-9072-2e0d2e4db110": {"__data__": {"id_": "c57a51d6-8a13-4baf-9072-2e0d2e4db110", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a27465cd-c293-41cf-ae48-ed9ca95cc6a2", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "hash": "8b7de1524a6884a82b101c1901168f5ebcf2da9461641d6671885d47f4dcd612", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "823b5796-edeb-42a2-8c24-8feb053f334d", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "hash": "1db08706445997a5792ab8e4cddd585b358ee3c8e92df702002aa0c10d0ee07a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3ad8de8b-b3d1-45e1-b423-c856fafe9847", "node_type": "1", "metadata": {}, "hash": "7ef946ac649bf78d7cd27f7bba8c693e88d871eb75710e43436be8d4d39e1a29", "class_name": "RelatedNodeInfo"}}, "text": "if results.empty:\n            return {\n                \"success\": False,\n                \"message\": \"Nenhum produto encontrado.\",\n                \"data\": [],\n            }\n\n        data = results.head(limit).to_dict(orient=\"records\")\n        column_descriptions = next(\n            (\n                item.get(\"column_descriptions\", {})\n                for item in self.catalog\n                if item.get(\"file_name\") == target_file\n            ),\n            {},\n        )\n\n        return {\n            \"success\": True,\n            \"data\": data,\n            \"total_found\": len(results),\n            \"column_descriptions\": column_descriptions,\n        }\n\n    def _build_prompt_for_filter_extraction(self, query):\n        \"\"\"Constr\u00f3i o prompt para o LLM extrair filtros da query do usu\u00e1rio.\"\"\"\n        prompt_template = \"\"\"\n        Voc\u00ea \u00e9 um especialista em an\u00e1lise de dados. Sua tarefa \u00e9 converter a pergunta de um usu\u00e1rio em filtros JSON para uma busca em um DataFrame pandas.\n        Use o cat\u00e1logo de dados abaixo como sua \u00fanica fonte de verdade sobre a estrutura dos dados.\n\n        [CAT\u00c1LOGO DE DADOS]\n        {catalog}\n        \n        [PERGUNTA DO USU\u00c1RIO]\n        \"{query}\"\n\n        [INSTRU\u00c7\u00d5ES]\n        1. Analise a pergunta do usu\u00e1rio e o cat\u00e1logo de dados para identificar o arquivo e as colunas mais relevantes.\n        2. Para perguntas sobre vendas, priorize o arquivo `ADMAT.parquet` e use a coluna `VENDA_30DD` para representar a quantidade de vendas.\n        3. Converta a pergunta em uma lista de filtros JSON. Cada filtro deve ser um objeto com \"column\", \"operator\" e \"value\".\n        4. Operadores suportados: `==` (igual a), `!=` (diferente de), `>` (maior que), `<` (menor que), `contains` (para strings).\n        5. Para buscas em colunas de texto (string), sempre use o operador `contains`.\n        6. Para buscas em colunas num\u00e9ricas, use `==`, `!=`, `>`, `<`.\n        7. **Sua resposta deve conter APENAS o c\u00f3digo JSON, sem nenhum texto, explica\u00e7\u00e3o ou formata\u00e7\u00e3o adicional.**\n\n        [EXEMPLO 1]\n        Pergunta: \"quais os produtos da categoria brinquedos com pre\u00e7o maior que 50?\"\n        Resposta JSON:\n        ```json\n        {{\n            \"target_file\": \"ADMAT.parquet\",\n            \"filters\": [\n                {{\n                    \"column\": \"NOMECATEGORIA\",\n                    \"operator\": \"contains\",\n                    \"value\": \"brinquedos\"\n                }},\n                {{\n                    \"column\": \"LIQUIDO_38\",\n                    \"operator\": \">\",\n                    \"value\": 50\n                }}\n            ]\n        }}\n        ```\n\n        [EXEMPLO 2]\n        Pergunta: \"liste os itens do fabricante ACME que n\u00e3o sejam do grupo Papelaria\"\n        Resposta JSON:\n        ```json\n        {{\n            \"target_file\": \"ADMAT.parquet\",\n            \"filters\": [\n                {{\n                    \"column\": \"NOMEFABRICANTE\",\n                    \"operator\": \"contains\",\n                    \"value\": \"ACME\"\n                }},\n                {{\n                    \"column\": \"NOMEGRUPO\",\n                    \"operator\": \"!=\",\n                    \"value\": \"Papelaria\"\n                }}\n            ]\n        }}\n        ```\n\n        [RESPOSTA JSON]\n        \"\"\"\n        return prompt_template.format(\n            catalog=json.dumps(self.catalog, indent=2, ensure_ascii=False), query=query\n        )\n\n    def _simulate_llm_filter_extraction(self, query):\n        \"\"\"Fun\u00e7\u00e3o de simula\u00e7\u00e3o para demonstrar a extra\u00e7\u00e3o de filtros. Substituir por uma chamada real ao LLM.\"\"\"\n        self.logger.warning(\n            \"Usando extra\u00e7\u00e3o de filtros simulada. Substituir por chamada real ao LLM.\"", "mimetype": "text/plain", "start_char_idx": 4772, "end_char_idx": 8408, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3ad8de8b-b3d1-45e1-b423-c856fafe9847": {"__data__": {"id_": "3ad8de8b-b3d1-45e1-b423-c856fafe9847", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a27465cd-c293-41cf-ae48-ed9ca95cc6a2", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "hash": "8b7de1524a6884a82b101c1901168f5ebcf2da9461641d6671885d47f4dcd612", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c57a51d6-8a13-4baf-9072-2e0d2e4db110", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "hash": "9289893f247c4b0b0fac2b1c4e2c8eabe6de0043ab47c3bf623c983c1b29b25f", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "11967f22-2cab-4d85-9f54-c852913550d4", "node_type": "1", "metadata": {}, "hash": "8b5243f0aa0f715513ab673961b9ce5d3cdda1964eadc51ca39f3199224acf46", "class_name": "RelatedNodeInfo"}}, "text": "Substituir por uma chamada real ao LLM.\"\"\"\n        self.logger.warning(\n            \"Usando extra\u00e7\u00e3o de filtros simulada. Substituir por chamada real ao LLM.\"\n        )\n        if \"brinquedos\" in query.lower():\n            return {\n                \"target_file\": \"ADMAT.parquet\",\n                \"filters\": {\"CATEGORIA\": \"brinquedos\"},\n            }\n        if \"pre\u00e7o maior que 100\" in query.lower():\n            return {\n                \"target_file\": \"ADMAT.parquet\",\n                \"filters\": {\n                    \"PRECO_38PERCENT\": \"> 100\"\n                },  # A l\u00f3gica de aplica\u00e7\u00e3o precisaria tratar '>'\n            }\n        # Simula\u00e7\u00e3o de busca por nome\n        match = re.search(r\"produtos com nome (\\w+)\", query, re.IGNORECASE)\n        if match:\n            product_name = match.group(1)\n            return {\"target_file\": \"ADMAT.parquet\", \"filters\": {\"NOME\": product_name}}\n        return {\"target_file\": \"ADMAT.parquet\", \"filters\": {}}\n\n    def get_product_details(self, product_code):\n        self.logger.info(f\"Buscando detalhes do produto com c\u00f3digo: {product_code}\")\n        filters = {\"PRODUTO\": product_code}\n        df = get_table_df(\"ADMAT\", filters=filters)\n        if df is None or df.empty:\n            self.logger.warning(\n                f\"Produto com c\u00f3digo {product_code} n\u00e3o encontrado ou arquivo Parquet ausente.\"\n            )\n            return {\n                \"success\": False,\n                \"message\": \"Produto n\u00e3o encontrado ou arquivo Parquet ausente\",\n            }\n\n        prod = df.iloc[0][\n            [\n                \"PRODUTO\",\n                \"NOME\",\n                \"LIQUIDO_38\",\n                \"NOMEFABRICANTE\",\n                \"NOMECATEGORIA\",\n                \"NOMEGRUPO\",\n            ]\n        ]\n        product = {\n            \"codigo\": prod[\"PRODUTO\"],\n            \"nome\": prod[\"NOME\"],\n            \"preco\": prod[\"LIQUIDO_38\"],\n            \"fabricante\": prod[\"NOMEFABRICANTE\"],\n            \"categoria\": prod[\"NOMECATEGORIA\"],\n            \"grupo\": prod[\"NOMEGRUPO\"],\n        }\n        self.logger.info(\n            f\"Detalhes do produto {product_code} encontrados: {product['nome']}\"\n        )\n        return {\"success\": True, \"product\": product}\n\n    def get_columns_info(self):\n        df = get_table_df(\"ADMAT\")\n        if df is None:\n            return {\n                \"success\": False,\n                \"message\": \"Arquivo Parquet da tabela ADMAT n\u00e3o encontrado\",\n            }\n        columns = list(df.columns)\n        dtypes = {col: str(df[col].dtype) for col in columns}\n        return {\"success\": True, \"columns\": columns, \"dtypes\": dtypes}\n\n    def analyze_product_performance(self, product_code):\n        details = self.get_product_details(product_code)\n        if not details.get(\"success\"):\n            return details\n        preco = float(details[\"product\"].get(\"preco\", 0))\n        analysis = {\n            \"product_id\": product_code,\n            \"analysis\": (f\"An\u00e1lise do produto {details['product'].get('nome', 'N/A')}\"),\n            \"price_category\": (\n                \"Alto\" if preco > 100 else \"M\u00e9dio\" if preco > 50 else \"Baixo\"\n            ),\n            \"recommendations\": [\n                \"Verificar estoque regularmente\",\n                \"Monitorar pre\u00e7os da concorr\u00eancia\",\n            ],\n            \"score\": min(10, max(1, preco / 10)),\n        }\n        return {\"success\": True, \"analysis\": analysis}\n\n    def get_sales_history(self, product_code):\n        self.logger.info(f\"Buscando hist\u00f3rico de vendas para o produto: {product_code}\")\n\n        df_admat = get_table_df(\"ADMAT\")\n        if df_admat is None or df_admat.empty:\n            self.logger.warning(\n                \"ADMAT.parquet n\u00e3o encontrado ou vazio. N\u00e3o \u00e9 poss\u00edvel gerar hist\u00f3rico de vendas.\"\n            )\n            return {\"success\": False, \"message\": \"Dados de vendas n\u00e3o dispon\u00edveis.\"}\n\n        # Encontrar a linha do produto\n        product_row = df_admat[df_admat[\"PRODUTO\"] == product_code]\n        if product_row.empty:\n            self.logger.warning(\n                f\"Produto {product_code} n\u00e3o encontrado em ADMAT.parquet.\"\n            )\n            return {\n                \"success\": False,\n                \"message\": f\"Produto {product_code} n\u00e3o encontrado nos dados de vendas.", "mimetype": "text/plain", "start_char_idx": 8250, "end_char_idx": 12496, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "11967f22-2cab-4d85-9f54-c852913550d4": {"__data__": {"id_": "11967f22-2cab-4d85-9f54-c852913550d4", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a27465cd-c293-41cf-ae48-ed9ca95cc6a2", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "hash": "8b7de1524a6884a82b101c1901168f5ebcf2da9461641d6671885d47f4dcd612", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3ad8de8b-b3d1-45e1-b423-c856fafe9847", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}, "hash": "1ceea6ee61b7a0983849630e73fb7a2544f14d19f48449d59eb21ccd6f7bee1f", "class_name": "RelatedNodeInfo"}}, "text": "N\u00e3o \u00e9 poss\u00edvel gerar hist\u00f3rico de vendas.\"\n            )\n            return {\"success\": False, \"message\": \"Dados de vendas n\u00e3o dispon\u00edveis.\"}\n\n        # Encontrar a linha do produto\n        product_row = df_admat[df_admat[\"PRODUTO\"] == product_code]\n        if product_row.empty:\n            self.logger.warning(\n                f\"Produto {product_code} n\u00e3o encontrado em ADMAT.parquet.\"\n            )\n            return {\n                \"success\": False,\n                \"message\": f\"Produto {product_code} n\u00e3o encontrado nos dados de vendas.\",\n            }\n\n        product_row = product_row.iloc[0]\n\n        sales_data = []\n        # Coletar dados de vendas mensais (assumindo colunas de data)\n        # Ex: '2023-05-01 00:00:00', '2023-06-01 00:00:00', etc.\n        # E 'VENDA_30DD' (vendas dos \u00faltimos 30 dias)\n\n        # Tentativa de coletar dados de vendas mensais\n        for col in df_admat.columns:\n            try:\n                # Tenta converter o nome da coluna para data\n                date_obj = pd.to_datetime(col)\n                # Verifica se \u00e9 uma coluna de m\u00eas/ano e se o valor n\u00e3o \u00e9 nulo\n                if not pd.isna(product_row[col]):\n                    sales_data.append(\n                        {\n                            \"date\": date_obj.strftime(\"%Y-%m\"),\n                            \"quantity\": product_row[col],\n                        }\n                    )\n            except ValueError:\n                continue  # N\u00e3o \u00e9 uma coluna de data\n\n        # Adicionar VENDA_30DD se existir e n\u00e3o for nulo\n        if \"VENDA_30DD\" in product_row and not pd.isna(product_row[\"VENDA_30DD\"]):\n            sales_data.append(\n                {\"date\": \"\u00daltimos 30 Dias\", \"quantity\": product_row[\"VENDA_30DD\"]}\n            )\n\n        if not sales_data:\n            self.logger.warning(\n                f\"Nenhum dado de vendas encontrado para o produto {product_code} em ADMAT.parquet.\"\n            )\n            return {\n                \"success\": False,\n                \"message\": f\"Nenhum dado de vendas encontrado para o produto {product_code}.\",\n            }\n\n        return {\"success\": True, \"sales_history\": sales_data}", "mimetype": "text/plain", "start_char_idx": 11952, "end_char_idx": 14105, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e642a20e-246b-4b7d-9757-a2ff8e038035": {"__data__": {"id_": "e642a20e-246b-4b7d-9757-a2ff8e038035", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\prompt_loader.py", "language": "python", "lines": 133, "filename": "prompt_loader.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b65bfe97-58eb-4f1f-a892-b4c8529c9a4f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\prompt_loader.py", "language": "python", "lines": 133, "filename": "prompt_loader.py"}, "hash": "97752e34a230490c257d0b55632859d03b57eba6e6be0bf05f1842a85a80e512", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "55b70490-8214-4461-86ab-cde65dbcadb0", "node_type": "1", "metadata": {}, "hash": "718ea5b487f8500f054c61b7364b953e0eb713e9ade5ff04307525ca11c683c9", "class_name": "RelatedNodeInfo"}}, "text": "import json\nimport logging\nimport os\nfrom typing import Any, Dict, Optional\n\n# Configura\u00e7\u00e3o de logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format=\"%(asctime)s - %(name)s - %(levelname)s - %(message)s\",\n    filename=\"logs/agent.log\",\n    filemode=\"a\",\n)\nlogger = logging.getLogger(\"prompt_loader\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 309, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "55b70490-8214-4461-86ab-cde65dbcadb0": {"__data__": {"id_": "55b70490-8214-4461-86ab-cde65dbcadb0", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\prompt_loader.py", "language": "python", "lines": 133, "filename": "prompt_loader.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b65bfe97-58eb-4f1f-a892-b4c8529c9a4f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\prompt_loader.py", "language": "python", "lines": 133, "filename": "prompt_loader.py"}, "hash": "97752e34a230490c257d0b55632859d03b57eba6e6be0bf05f1842a85a80e512", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "e642a20e-246b-4b7d-9757-a2ff8e038035", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\prompt_loader.py", "language": "python", "lines": 133, "filename": "prompt_loader.py"}, "hash": "d6484a8fae30bc1f3a04d22cca074bc58fa0f2c1e889704823126d437c84bcc2", "class_name": "RelatedNodeInfo"}}, "text": "import json\nimport logging\nimport os\nfrom typing import Any, Dict, Optional\n\n# Configura\u00e7\u00e3o de logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format=\"%(asctime)s - %(name)s - %(levelname)s - %(message)s\",\n    filename=\"logs/agent.log\",\n    filemode=\"a\",\n)\nlogger = logging.getLogger(\"prompt_loader\")\n\n\nclass PromptLoader:\n    \"\"\"\n    Classe respons\u00e1vel por carregar prompts externos em formato JSON\n    \"\"\"\n\n    def __init__(self, prompts_dir: str = None):\n        \"\"\"\n        Inicializa o carregador de prompts\n\n        Args:\n            prompts_dir (str): Diret\u00f3rio onde os arquivos de prompt est\u00e3o localizados\n        \"\"\"\n        # Define o diret\u00f3rio de prompts padr\u00e3o se n\u00e3o for especificado\n        if prompts_dir is None:\n            base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\n            self.prompts_dir = os.path.join(base_dir, \"prompts\")\n        else:\n            self.prompts_dir = prompts_dir\n\n        # Cria o diret\u00f3rio de prompts se n\u00e3o existir\n        if not os.path.exists(self.prompts_dir):\n            try:\n                os.makedirs(self.prompts_dir)\n                logger.info(f\"Diret\u00f3rio de prompts criado: {self.prompts_dir}\")\n            except Exception as e:\n                logger.error(f\"Erro ao criar diret\u00f3rio de prompts: {e}\")\n\n        logger.info(\n            f\"Carregador de prompts inicializado. Diret\u00f3rio: {self.prompts_dir}\"\n        )\n\n    def load_prompt(self, prompt_name: str) -> Optional[Dict[str, Any]]:\n        \"\"\"\n        Carrega um prompt espec\u00edfico pelo nome do arquivo\n\n        Args:\n            prompt_name (str): Nome do arquivo de prompt (sem extens\u00e3o)\n\n        Returns:\n            dict: Conte\u00fado do prompt carregado ou None se ocorrer erro\n        \"\"\"\n        # Adiciona a extens\u00e3o .json se n\u00e3o estiver presente\n        if not prompt_name.endswith(\".json\"):\n            prompt_file = f\"{prompt_name}.json\"\n        else:\n            prompt_file = prompt_name\n\n        # Constr\u00f3i o caminho completo do arquivo\n        prompt_path = os.path.join(self.prompts_dir, prompt_file)\n\n        # Verifica se o arquivo existe\n        if not os.path.exists(prompt_path):\n            logger.error(f\"Arquivo de prompt n\u00e3o encontrado: {prompt_path}\")\n            return None\n\n        # Carrega o arquivo JSON\n        try:\n            with open(prompt_path, \"r\", encoding=\"utf-8\") as file:\n                prompt_data = json.load(file)\n                logger.info(f\"Prompt carregado com sucesso: {prompt_name}\")\n                return prompt_data\n        except json.JSONDecodeError as e:\n            logger.error(f\"Erro ao decodificar JSON do prompt {prompt_name}: {e}\")\n            return None\n        except Exception as e:\n            logger.error(f\"Erro ao carregar prompt {prompt_name}: {e}\")\n            return None\n\n    def list_available_prompts(self) -> list:\n        \"\"\"\n        Lista todos os prompts dispon\u00edveis no diret\u00f3rio\n\n        Returns:\n            list: Lista de nomes de arquivos de prompt dispon\u00edveis\n        \"\"\"\n        try:\n            # Lista todos os arquivos .json no diret\u00f3rio de prompts\n            prompt_files = [\n                f\n                for f in os.listdir(self.prompts_dir)\n                if f.endswith(\".json\")\n                and os.path.isfile(os.path.join(self.prompts_dir, f))\n            ]\n            return prompt_files\n        except Exception as e:\n            logger.error(f\"Erro ao listar prompts dispon\u00edveis: {e}\")\n            return []\n\n    def save_prompt(self, prompt_name: str, prompt_data: Dict[str, Any]) -> bool:\n        \"\"\"\n        Salva um prompt em formato JSON\n\n        Args:\n            prompt_name (str): Nome do arquivo de prompt (sem extens\u00e3o)\n            prompt_data (dict): Dados do prompt a serem salvos\n\n        Returns:\n            bool: True se o prompt foi salvo com sucesso, False caso contr\u00e1rio\n        \"\"\"\n        # Adiciona a extens\u00e3o .json se n\u00e3o estiver presente\n        if not prompt_name.endswith(\".json\"):\n            prompt_file = f\"{prompt_name}.json\"\n        else:\n            prompt_file = prompt_name\n\n        # Constr\u00f3i o caminho completo do arquivo\n        prompt_path = os.path.join(self.prompts_dir, prompt_file)\n\n        # Salva o arquivo JSON\n        try:\n            with open(prompt_path, \"w\", encoding=\"utf-8\") as file:\n                json.dump(prompt_data, file, ensure_ascii=False, indent=4)\n                logger.info(f\"Prompt salvo com sucesso: {prompt_name}\")\n                return True\n        except Exception as e:\n            logger.error(f\"Erro ao salvar prompt {prompt_name}: {e}\")\n            return False", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4595, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "fdbc0e1e-b676-492a-b459-42daafbc0a7d": {"__data__": {"id_": "fdbc0e1e-b676-492a-b459-42daafbc0a7d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\supervisor_agent.py", "language": "python", "lines": 138, "filename": "supervisor_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f0d803cd-f7cb-41b5-914f-0654ff3d9c82", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\supervisor_agent.py", "language": "python", "lines": 138, "filename": "supervisor_agent.py"}, "hash": "fd8670428abc0cc04ab35fb54844a4e469d6d66f54d0f1c62fe86b122650db26", "class_name": "RelatedNodeInfo"}}, "text": "# core/agents/supervisor_agent.py\nimport logging\nfrom typing import Dict, Any\n\n\nclass SupervisorAgent:\n    \"\"\"\n    Agente supervisor simplificado que roteia consultas para o ToolAgent.\n    REMOVIDA importa\u00e7\u00e3o circular com tool_agent.\n    \"\"\"\n\n    CHART_KEYWORDS = [\n        \"gr\u00e1fico\",\n        \"gr\u00e1ficos\",\n        \"grafico\",\n        \"graficos\",\n        \"visualizar\",\n        \"visualiza\u00e7\u00e3o\",\n        \"visualizacao\",\n        \"mostrar\",\n        \"chart\",\n        \"charts\",\n        \"vendas\",\n        \"estoque\",\n        \"distribui\u00e7\u00e3o\",\n        \"distribuicao\",\n        \"an\u00e1lise\",\n        \"analise\",\n        \"compara\u00e7\u00e3o\",\n        \"comparacao\",\n        \"pizza\",\n        \"barras\",\n        \"linha\",\n        \"histograma\",\n        \"dashboard\",\n        \"plot\",\n        \"plotar\",\n        \"desenhar\",\n        \"temporal\",\n        \"s\u00e9rie\",\n        \"serie\",\n        \"evolu\u00e7\u00e3o\",\n        \"evolucao\",\n        \"mensal\",\n        \"m\u00eas\",\n        \"mes\",\n        \"semanal\",\n        \"trend\",\n        \"tend\u00eancia\",\n        \"tendencia\",\n        \"produto\",\n        \"sku\",\n        \"c\u00f3digo\",\n        \"codigo\",\n    ]\n\n    def __init__(self, gemini_adapter):\n        \"\"\"\n        Inicializa o supervisor.\n        NOTA: ToolAgent agora \u00e9 inicializado sob demanda para evitar importa\u00e7\u00e3o circular.\n        \"\"\"\n        self.logger = logging.getLogger(__name__)\n        self.gemini_adapter = gemini_adapter\n        self._tool_agent = None  # Lazy initialization\n        self.logger.info(\"SupervisorAgent inicializado.\")\n\n    @property\n    def tool_agent(self):\n        \"\"\"Lazy initialization do ToolAgent para evitar importa\u00e7\u00e3o circular.\"\"\"\n        if self._tool_agent is None:\n            # Importa\u00e7\u00e3o local para evitar circular dependency\n            from app.core.agents.tool_agent import ToolAgent\n            self._tool_agent = ToolAgent(llm_adapter=self.gemini_adapter)\n            self.logger.info(\"ToolAgent inicializado (lazy)\")\n        return self._tool_agent\n\n    def _detect_chart_intent(self, query: str) -> bool:\n        \"\"\"\n        Detecta se a consulta tem inten\u00e7\u00e3o de gerar gr\u00e1ficos.\n\n        Args:\n            query: Consulta do usu\u00e1rio\n\n        Returns:\n            True se detecta inten\u00e7\u00e3o de gr\u00e1fico, False caso contr\u00e1rio\n        \"\"\"\n        query_lower = query.lower()\n\n        # Verificar se cont\u00e9m palavras-chave de gr\u00e1ficos\n        for keyword in self.CHART_KEYWORDS:\n            if keyword in query_lower:\n                self.logger.info(f\"Inten\u00e7\u00e3o de gr\u00e1fico detectada: '{keyword}'\")\n                return True\n\n        return False\n\n    def route_query(self, query: str) -> Dict[str, Any]:\n        \"\"\"\n        Roteia a consulta para o ToolAgent.\n\n        Args:\n            query: Consulta do usu\u00e1rio\n\n        Returns:\n            Resposta do ToolAgent\n        \"\"\"\n        # Detectar se \u00e9 requisi\u00e7\u00e3o de gr\u00e1fico\n        is_chart_request = self._detect_chart_intent(query)\n\n        if is_chart_request:\n            self.logger.info(f\"Roteando consulta de gr\u00e1fico para ToolAgent: '{query}'\")\n        else:\n            self.logger.info(f\"Roteando consulta padr\u00e3o para ToolAgent: '{query}'\")\n\n        # Ambos os tipos v\u00e3o para ToolAgent que decidir\u00e1 qual ferramenta usar\n        return self.tool_agent.process_query(query)\n\n    def stream_query(self, query: str):\n        \"\"\"\n        Roteia a consulta para o ToolAgent com streaming.\n\n        Args:\n            query: Consulta do usu\u00e1rio\n\n        Yields:\n            dict: Eventos do agente (chunks de texto, a\u00e7\u00f5es, etc.)\n        \"\"\"\n        # Detectar se \u00e9 requisi\u00e7\u00e3o de gr\u00e1fico\n        is_chart_request = self._detect_chart_intent(query)\n\n        if is_chart_request:\n            self.logger.info(f\"Streaming de consulta de gr\u00e1fico para ToolAgent: '{query}'\")\n        else:\n            self.logger.info(f\"Streaming de consulta padr\u00e3o para ToolAgent: '{query}'\")\n\n        # Delegar para m\u00e9todo de streaming do ToolAgent\n        for event in self.tool_agent.stream_query(query):\n            yield event", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3932, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "972f3990-9ccf-4752-b552-ba9ccbafd109": {"__data__": {"id_": "972f3990-9ccf-4752-b552-ba9ccbafd109", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\tool_agent.py", "language": "python", "lines": 201, "filename": "tool_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f2b37f08-3fe3-486d-a728-766ddc4cc726", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\tool_agent.py", "language": "python", "lines": 201, "filename": "tool_agent.py"}, "hash": "d2a174ac436792e293e88fa680668a9f92c4102ddbdb6c9547c41b0fdf84b71f", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "050a525a-f23a-4688-8913-5a17779de7fd", "node_type": "1", "metadata": {}, "hash": "9599d2c07c8bfcb170913f2c8d86b8ef2b87f19490f8e33c51be5c23085a6d36", "class_name": "RelatedNodeInfo"}}, "text": "# core/agents/tool_agent.py\nimport logging\nimport sys\nimport os\nfrom typing import Any, Dict, List, Optional\n\n# Suppress transformers warnings about torch\nos.environ['TRANSFORMERS_OFFLINE'] = '1'\nos.environ['HF_HUB_OFFLINE'] = '1'\n\nLANGCHAIN_AVAILABLE = False\ntry:\n    try:\n        from langchain.agents import AgentExecutor, create_tool_calling_agent\n    except ImportError:\n        # Fallback for environments using langchain-classic\n        from langchain_classic.agents import AgentExecutor, create_tool_calling_agent\n\n    from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder\n    from langchain_core.messages import BaseMessage\n    from langchain_core.runnables import RunnableConfig\n    from langchain_core.agents import AgentAction, AgentFinish\n    \n    # Check for torch dependency explicitly to fail fast inside try block\n    import transformers\n    \n    LANGCHAIN_AVAILABLE = True\nexcept (ImportError, OSError) as e:\n    logging.warning(f\"LangChain/Transformers dependencies not available: {e}. ToolAgent will run in fallback mode.\")\n    # Define dummy classes for type hinting if needed, or just use Any\n    BaseMessage = Any\n\nfrom app.core.llm_base import BaseLLMAdapter\nfrom app.core.llm_gemini_adapter import GeminiLLMAdapter\nfrom app.core.llm_langchain_adapter import CustomLangChainLLM\nfrom app.core.utils.response_parser import parse_agent_response\nfrom app.core.utils.chart_saver import save_chart\n\nfrom app.core.tools.unified_data_tools import unified_tools\nfrom app.core.tools.date_time_tools import date_time_tools\nfrom app.core.tools.chart_tools import chart_tools\n\n\nclass ToolAgent:\n    def __init__(self, llm_adapter: BaseLLMAdapter):\n        self.logger = logging.getLogger(__name__)\n        self.llm_adapter = llm_adapter\n        self.agent_executor = None\n\n        if LANGCHAIN_AVAILABLE:\n            try:\n                self.langchain_llm = CustomLangChainLLM(llm_adapter=self.llm_adapter)\n                self.tools = unified_tools + date_time_tools + chart_tools\n                self.agent_executor = self._create_agent_executor()\n                self.logger.info(\"ToolAgent inicializado com adaptador Gemini (LangChain ativo).\")\n            except Exception as e:\n                self.logger.error(f\"Erro ao inicializar LangChain Agent: {e}\")\n                self.agent_executor = None\n        else:\n            self.logger.warning(\"ToolAgent rodando em modo degradado (sem LangChain).\")\n\n    def _create_agent_executor(self):\n        \"\"\"Cria e retorna um AgentExecutor com agente de ferramentas.\"\"\"\n        if not LANGCHAIN_AVAILABLE:\n            return None\n            \n        # \u2705 FASE 3: PROMPT MINIMALISTA (30 linhas vs 168 linhas)\n        prompt = ChatPromptTemplate.from_messages(\n            [\n                (\n                    \"system\",\n                    \"Voc\u00ea \u00e9 um assistente BI especializado. Use as ferramentas dispon\u00edveis para responder queries sobre dados.\\n\\n\"\n                    \"REGRAS:\\n\"\n                    \"1. Responda de forma natural e direta\\n\"\n                    \"2. Use formata\u00e7\u00e3o Markdown para valores (**R$ X,XX**, **X unidades**)\\n\"\n                    \"3. NUNCA mencione nomes t\u00e9cnicos de colunas\\n\"\n                    \"4. SEMPRE use ferramentas para consultar dados\\n\\n\"\n                    \"FERRAMENTAS PRINCIPAIS:\\n\"\n                    \"- consultar_dados(coluna, valor, coluna_retorno) - Consulta dados espec\u00edficos\\n\"\n                    \"- listar_colunas_disponiveis() - Lista colunas dispon\u00edveis\\n\"\n                    \"- gerar_grafico_* - Gera gr\u00e1ficos\\n\\n\"\n                    \"EXEMPLOS:\\n\"\n                    \"Query: 'pre\u00e7o do produto 123'\\n\"\n                    \"Ferramenta: consultar_dados('PRODUTO', '123', 'LIQUIDO_38')\\n\"\n                    \"Resposta: 'O pre\u00e7o do produto 123 \u00e9 **R$ 45,90**'\\n\\n\"\n                    \"COLUNAS COMUNS: PRODUTO, NOME, LIQUIDO_38 (pre\u00e7o), ESTOQUE_UNE (estoque), NOMEFABRICANTE\\n\"\n                    \"Use listar_colunas_disponiveis() para ver todas.\\n\\n\"\n                    \"Seja direto e profissional.\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4043, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "050a525a-f23a-4688-8913-5a17779de7fd": {"__data__": {"id_": "050a525a-f23a-4688-8913-5a17779de7fd", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\tool_agent.py", "language": "python", "lines": 201, "filename": "tool_agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f2b37f08-3fe3-486d-a728-766ddc4cc726", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\tool_agent.py", "language": "python", "lines": 201, "filename": "tool_agent.py"}, "hash": "d2a174ac436792e293e88fa680668a9f92c4102ddbdb6c9547c41b0fdf84b71f", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "972f3990-9ccf-4752-b552-ba9ccbafd109", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\agents\\tool_agent.py", "language": "python", "lines": 201, "filename": "tool_agent.py"}, "hash": "08445dbb58bb6366d878af18e3bda1f535cade4c1df61c6d30c6c40193f806a9", "class_name": "RelatedNodeInfo"}}, "text": "),\n                MessagesPlaceholder(variable_name=\"chat_history\"),\n                (\"human\", \"{input}\"),\n                MessagesPlaceholder(variable_name=\"agent_scratchpad\"),\n            ]\n        )\n\n        agent = create_tool_calling_agent(\n            llm=self.langchain_llm, tools=self.tools, prompt=prompt\n        )\n\n        return AgentExecutor(\n            agent=agent,\n            tools=self.tools,\n            verbose=True,\n            return_intermediate_steps=True,\n        )\n\n    def process_query(\n        self, query: str, chat_history: List[Any] = None\n    ) -> Dict[str, Any]:\n        \"\"\"Processa a query do usu\u00e1rio usando o agente LangChain.\"\"\"\n        \n        if not self.agent_executor:\n            return {\n                \"type\": \"text\",\n                \"output\": \"\u26a0\ufe0f O sistema de Agentes Inteligentes est\u00e1 temporariamente indispon\u00edvel (depend\u00eancia ausente). Por favor, use o painel de Monitoramento ou contate o administrador.\"\n            }\n\n        self.logger.info(f\"Processando query com o Agente de Ferramentas: {query}\")\n        try:\n            # Ensure chat_history is not None for invoke\n            if chat_history is None:\n                chat_history = []\n\n            config = RunnableConfig(recursion_limit=10)\n\n            self.logger.debug(\n                f\"Invocando agente com query: {query} \"\n                f\"e chat_history: {chat_history}\"\n            )\n            response = self.agent_executor.invoke(\n                {\"input\": query, \"chat_history\": chat_history}, config=config\n            )\n            self.logger.debug(f\"Resposta bruta do agente: {response}\")\n\n            # Adicionando log detalhado para depura\u00e7\u00e3o\n            self.logger.info(f\"CONTE\u00daDO COMPLETO DA RESPOSTA DO AGENTE: {response}\")\n\n            final_output = response.get(\"output\", \"N\u00e3o foi poss\u00edvel gerar uma resposta.\")\n            response_type = \"text\" # Padr\u00e3o\n\n            # Verificar se h\u00e1 passos intermedi\u00e1rios e extrair a sa\u00edda da ferramenta se aplic\u00e1vel\n            if \"intermediate_steps\" in response and response[\"intermediate_steps\"]:\n                for step in reversed(response[\"intermediate_steps\"]):\n                    if isinstance(step, tuple) and len(step) == 2:\n                        action, observation = step\n                        \n                        # Se a observa\u00e7\u00e3o for um dicion\u00e1rio de uma ferramenta de gr\u00e1fico bem-sucedida\n                        if isinstance(observation, dict) and observation.get(\"status\") == \"success\" and \"chart_data\" in observation:\n                            self.logger.info(f\"Extraindo dados do gr\u00e1fico da ferramenta: {action.tool}\")\n                            final_output = observation[\"chart_data\"]\n                            response_type = \"chart\"\n                            save_chart(final_output)  # Salvar o gr\u00e1fico\n                            break\n                        \n                        # L\u00f3gica existente para ferramentas que retornam string\n                        elif isinstance(action, AgentAction) and isinstance(observation, str):\n                            if action.tool == \"consultar_dados\":\n                                final_output = observation\n                                self.logger.info(f\"Usando sa\u00edda direta da ferramenta consultar_dados: {final_output}\")\n                                break\n\n            # Se o tipo de resposta for gr\u00e1fico, retorna diretamente\n            if response_type == \"chart\":\n                return {\n                    \"type\": \"chart\",\n                    \"output\": final_output,\n                }\n\n            # Processamento legado para texto\n            response_type, processed = parse_agent_response(final_output)\n            return {\n                \"type\": \"text\", # Changed from response_type to \"text\" to ensure text output for general queries\n                \"output\": processed.get(\"output\", final_output),\n            }\n\n        except Exception as e:\n            self.logger.error(f\"Erro ao invocar o agente LangChain: {e}\", exc_info=True)\n            \n            # Debug: Write error to file\n            try:\n                import traceback\n                with open(\"error_log_agent.txt\", \"w\", encoding=\"utf-8\") as f:\n                    f.write(f\"Error: {str(e)}\\n\")\n                    f.write(traceback.format_exc())\n            except:\n                pass\n                \n            return {\n                \"type\": \"error\",\n                \"output\": (\n                    \"Desculpe, n\u00e3o consegui processar sua solicita\u00e7\u00e3o \"\n                    \"no momento. Por favor, tente novamente ou reformule \"\n                    \"sua pergunta.\"\n                ),\n            }\n\n\ndef initialize_agent_for_session():\n    \"\"\"Fun\u00e7\u00e3o de f\u00e1brica para inicializar o agente.\"\"\"\n    return ToolAgent(llm_adapter=GeminiLLMAdapter())", "mimetype": "text/plain", "start_char_idx": 4060, "end_char_idx": 8873, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "617adbe4-bcf3-474f-8127-39ace2089116": {"__data__": {"id_": "617adbe4-bcf3-474f-8127-39ace2089116", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\agents\\__init__.py", "language": "python", "lines": 8, "filename": "__init__.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bf436449-e80d-4d33-8a50-2369d1168551", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\agents\\__init__.py", "language": "python", "lines": 8, "filename": "__init__.py"}, "hash": "e8d80d6953916f92fcb3ff6426848ecc1981168025659f29724e5b3ba9191d9c", "class_name": "RelatedNodeInfo"}}, "text": "from .supervisor_agent import SupervisorAgent\nfrom .tool_agent import ToolAgent\n\n__all__ = [\n    \"SupervisorAgent\",\n    \"ToolAgent\",\n]", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 134, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "37f3c8ee-5bbe-4106-99d3-7cdf058987d7": {"__data__": {"id_": "37f3c8ee-5bbe-4106-99d3-7cdf058987d7", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\factory\\component_factory.py", "language": "python", "lines": 55, "filename": "component_factory.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f6091f5f-3b99-46bc-92d6-4407be75b727", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\factory\\component_factory.py", "language": "python", "lines": 55, "filename": "component_factory.py"}, "hash": "1da4394716d462f186f20c357cdae8d6f168590d217615ddca9f3a055dfbed7d", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nF\u00e1brica de Componentes\n\nEste m\u00f3dulo implementa o padr\u00e3o Factory para criar e gerenciar inst\u00e2ncias\ndos diversos componentes do sistema, facilitando a integra\u00e7\u00e3o entre eles\ne reduzindo o acoplamento.\n\"\"\"\n\nimport logging\nfrom typing import Any, Dict, Optional\n\nlogger = logging.getLogger(__name__)\n\n\nclass ComponentFactory:\n    \"\"\"F\u00e1brica para criar e gerenciar componentes do sistema\"\"\"\n\n    # Dicion\u00e1rio para armazenar as inst\u00e2ncias dos componentes (Singleton)\n    _components: Dict[str, Any] = {}\n\n    @classmethod\n    def get_data_adapter(cls):\n        \"\"\"Obt\u00e9m uma inst\u00e2ncia do adaptador de dados h\u00edbrido\"\"\"\n        if \"data_adapter\" not in cls._components:\n            from app.infrastructure.data.hybrid_adapter import HybridDataAdapter\n            logger.info(\"Criando nova inst\u00e2ncia do HybridDataAdapter\")\n            cls._components[\"data_adapter\"] = HybridDataAdapter()\n        return cls._components[\"data_adapter\"]\n\n    @classmethod\n    def reset_component(cls, component_name: str) -> bool:\n        \"\"\"Reinicia um componente espec\u00edfico, removendo sua inst\u00e2ncia atual\n\n        Args:\n            component_name (str): Nome do componente a ser reiniciado\n\n        Returns:\n            bool: True se o componente foi reiniciado com sucesso, False caso contr\u00e1rio\n        \"\"\"\n        if component_name in cls._components:\n            del cls._components[component_name]\n            logger.info(f\"Componente reiniciado: {component_name}\")\n            return True\n\n        logger.warning(\n            f\"Tentativa de reiniciar componente inexistente: {component_name}\"\n        )\n        return False\n\n    @classmethod\n    def reset_all(cls) -> None:\n        \"\"\"Reinicia todos os componentes, removendo todas as inst\u00e2ncias atuais\"\"\"\n        cls._components.clear()\n        logger.info(\"Todos os componentes foram reiniciados\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1831, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "dff6d655-ec3f-479e-a0ea-f53763cf55f1": {"__data__": {"id_": "dff6d655-ec3f-479e-a0ea-f53763cf55f1", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\factory\\__init__.py", "language": "python", "lines": 2, "filename": "__init__.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a8f93518-1344-4ff9-a3fa-16c577e1d2e8", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\factory\\__init__.py", "language": "python", "lines": 2, "filename": "__init__.py"}, "hash": "626e2b2df2a3f576fc236c252f7faa69deaae16c3cc8d10c21eddba5d2343a5e", "class_name": "RelatedNodeInfo"}}, "text": "# Factory module", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 16, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6d5b7b65-0a70-43ed-9b64-b29a0205da64": {"__data__": {"id_": "6d5b7b65-0a70-43ed-9b64-b29a0205da64", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\graph\\agent.py", "language": "python", "lines": 91, "filename": "agent.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "555a4cf3-84d5-473f-a79f-3acd00d6f038", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\graph\\agent.py", "language": "python", "lines": 91, "filename": "agent.py"}, "hash": "6f3c66418e87798e8750c9c4d933e5d160f56d4ab13fd70b7e07adfc4660c3b7", "class_name": "RelatedNodeInfo"}}, "text": "import logging\n\nfrom langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder\n\nfrom ..llm_factory import LLMFactory # Added\nfrom ..llm_langchain_adapter import CustomLangChainLLM # Added\nfrom ..tools.sql_server_tools import db_schema_info, sql_server_tools\n\n# Configura\u00e7\u00e3o de logging\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\n\nclass GraphAgent:\n    \"\"\"\n    Agente principal do grafo, respons\u00e1vel por orquestrar o LLM e as ferramentas.\n    \"\"\"\n\n    def __init__(self, llm=None, tools=None):\n        \"\"\"\n        Inicializa o agente.\n\n        Args:\n            llm (BaseChatModel, optional): O modelo de linguagem a ser usado.\n            tools (list, optional): A lista de ferramentas dispon\u00edveis.\n        \"\"\"\n        if llm is None:\n            llm_adapter = LLMFactory.get_adapter()\n            self.llm = CustomLangChainLLM(llm_adapter=llm_adapter)\n        else:\n            self.llm = llm\n\n        self.tools = tools or sql_server_tools\n        self.agent_runnable = self._create_agent_runnable()\n\n    def _get_system_prompt_template(self):\n        \"\"\"Retorna o template do prompt do sistema.\"\"\"\n        schema = db_schema_info or \"Schema n\u00e3o dispon\u00edvel. Use get_database_schema.\"\n        tool_names = \", \".join([t.name for t in self.tools])\n\n        return (\n            \"Voc\u00ea \u00e9 um Agente de Neg\u00f3cios especialista em SQL Server.\\n\"\n            \"Seu papel \u00e9 responder perguntas executando consultas SELECT seguras.\\n\"\n            f\"Schema do Banco: {schema}\\n\"\n            f\"Ferramentas: {tool_names}\\n\"\n            \"**Regras:**\\n\"\n            \"1. Responda em portugu\u00eas.\\n\"\n            \"2. Se n\u00e3o souber o schema, use `get_database_schema` PRIMEIRO.\\n\"\n            \"3. Depois, use `execute_sql_query` com um SELECT v\u00e1lido.\\n\"\n            \"4. NUNCA use DELETE, UPDATE, INSERT. Apenas permiss\u00e3o de leitura.\\n\"\n            \"5. Se a consulta falhar, informe o usu\u00e1rio e pe\u00e7a para reformular.\\n\"\n        )\n\n    def _create_agent_runnable(self):\n        \"\"\"Cria o 'Agent Runnable' com as ferramentas vinculadas.\"\"\"\n        system_prompt = self._get_system_prompt_template()\n        prompt = ChatPromptTemplate.from_messages(\n            [\n                (\"system\", system_prompt),\n                MessagesPlaceholder(variable_name=\"messages\"),\n            ]\n        )\n        # openai_tools = [convert_to_openai_tool(t) for t in self.tools] # Removed\n        return prompt | self.llm.bind_tools(self.tools) # Changed to use self.tools directly\n\n    def process(self, messages):\n        \"\"\"\n        Processa uma lista de mensagens atrav\u00e9s do agente.\n\n        Args:\n            messages (list): A lista de mensagens da conversa.\n\n        Returns:\n            A resposta do agente.\n        \"\"\"\n        logger.info(\"Processando mensagem com o GraphAgent...\")\n        return self.agent_runnable.invoke({\"messages\": messages})\n\n\nif __name__ == \"__main__\":\n    # Exemplo de como usar o agente\n    print(\"Inicializando o GraphAgent para teste...\")\n    agent = GraphAgent()\n    print(\"Agente inicializado.\")\n    # Para testar, voc\u00ea precisaria de uma lista de mensagens, por exemplo:\n    # from langchain_core.messages import HumanMessage\n    # messages = [HumanMessage(content=\"Qual o produto mais vendido?\")]\n    # response = agent.process(messages)\n    # print(\"Resposta do agente:\", response)\n    print(\"Script conclu\u00eddo.\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3363, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c731a862-e010-46dc-8ca5-4e60b1ac5517": {"__data__": {"id_": "c731a862-e010-46dc-8ca5-4e60b1ac5517", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\graph\\__init__.py", "language": "python", "lines": 18, "filename": "__init__.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9199cb99-33f3-48d1-8f7b-dd1b4d41d5d1", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\graph\\__init__.py", "language": "python", "lines": 18, "filename": "__init__.py"}, "hash": "20a588d472e7674fb25f972fca2f17583d6573ef167d7118624c576060ed9088", "class_name": "RelatedNodeInfo"}}, "text": "import logging\n\nlogger = logging.getLogger(__name__)\n\n\n# Configura\u00e7\u00e3o b\u00e1sica de logging para este pacote, se necess\u00e1rio\ntry:\n    # seu c\u00f3digo principal aqui\n    pass\nexcept Exception as e:\n    logger.error(f\"Erro geral: {e}\")\n\n# Arquivo vazio para marcar o diret\u00f3rio como um pacote Python\n\nif __name__ == \"__main__\":\n    print(\"Rodando como script...\")\n    # TODO: Adicionar chamada a uma fun\u00e7\u00e3o principal se necess\u00e1rio", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 419, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1064f8fb-3498-4645-bb85-d46d125136ea": {"__data__": {"id_": "1064f8fb-3498-4645-bb85-d46d125136ea", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\learning\\feedback_system.py", "language": "python", "lines": 248, "filename": "feedback_system.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d7cf21b9-e632-40ea-870a-c7c33b2a5597", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\learning\\feedback_system.py", "language": "python", "lines": 248, "filename": "feedback_system.py"}, "hash": "da789a061dda815847e6ad009985f898c2ee06c50a622b9a7eb643a50216eac3", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "d5092611-1baa-4ecc-bf8d-eb17bbdf8949", "node_type": "1", "metadata": {}, "hash": "a05ccf457ca074e957bb719c68bc3dca0728990d4a4b933af57357cfd4006f57", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSistema de coleta e an\u00e1lise de feedback do usu\u00e1rio.\n\"\"\"\n\nimport json\nimport os\nimport logging\nfrom datetime import datetime\nfrom typing import Dict, Any, Optional\n\n\nclass FeedbackSystem:\n    \"\"\"\n    Sistema para coletar, armazenar e analisar feedback do usu\u00e1rio\n    sobre queries e respostas do sistema.\n    \"\"\"\n\n    def __init__(self, feedback_dir: str = None):\n        \"\"\"\n        Inicializa o sistema de feedback.\n\n        Args:\n            feedback_dir: Diret\u00f3rio para armazenar feedback (opcional)\n        \"\"\"\n        self.logger = logging.getLogger(__name__)\n\n        if feedback_dir is None:\n            feedback_dir = os.path.join(os.getcwd(), \"data\", \"feedback\")\n\n        self.feedback_dir = feedback_dir\n        os.makedirs(self.feedback_dir, exist_ok=True)\n\n        self.logger.info(f\"\u2705 FeedbackSystem inicializado em {self.feedback_dir}\")\n\n    def record_feedback(\n        self,\n        query: str,\n        code: str,\n        feedback_type: str,\n        user_comment: Optional[str] = None,\n        result_rows: int = 0,\n        session_id: Optional[str] = None,\n        user_id: Optional[str] = None\n    ) -> bool:\n        \"\"\"\n        Registra feedback do usu\u00e1rio sobre uma query.\n\n        Args:\n            query: Query original do usu\u00e1rio\n            code: C\u00f3digo gerado\n            feedback_type: 'positive', 'negative', ou 'partial'\n            user_comment: Coment\u00e1rio adicional do usu\u00e1rio (opcional)\n            result_rows: N\u00famero de linhas retornadas\n            session_id: ID da sess\u00e3o (opcional)\n            user_id: ID do usu\u00e1rio (opcional)\n\n        Returns:\n            True se salvou com sucesso\n        \"\"\"\n        try:\n            feedback_entry = {\n                'timestamp': datetime.now().isoformat(),\n                'query': query,\n                'code': code,\n                'feedback_type': feedback_type,\n                'user_comment': user_comment,\n                'result_rows': result_rows,\n                'session_id': session_id,\n                'user_id': user_id\n            }\n\n            # Salvar em arquivo di\u00e1rio\n            date_str = datetime.now().strftime('%Y%m%d')\n            feedback_file = os.path.join(self.feedback_dir, f'feedback_{date_str}.jsonl')\n\n            with open(feedback_file, 'a', encoding='utf-8') as f:\n                f.write(json.dumps(feedback_entry, ensure_ascii=False) + '\\n')\n\n            self.logger.info(f\"\u2705 Feedback '{feedback_type}' registrado\")\n            return True\n\n        except Exception as e:\n            self.logger.error(f\"\u274c Erro ao registrar feedback: {e}\")\n            return False\n\n    def get_feedback_stats(self, days: int = 7) -> Dict[str, Any]:\n        \"\"\"\n        Calcula estat\u00edsticas de feedback dos \u00faltimos N dias.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2726, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d5092611-1baa-4ecc-bf8d-eb17bbdf8949": {"__data__": {"id_": "d5092611-1baa-4ecc-bf8d-eb17bbdf8949", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\learning\\feedback_system.py", "language": "python", "lines": 248, "filename": "feedback_system.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d7cf21b9-e632-40ea-870a-c7c33b2a5597", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\learning\\feedback_system.py", "language": "python", "lines": 248, "filename": "feedback_system.py"}, "hash": "da789a061dda815847e6ad009985f898c2ee06c50a622b9a7eb643a50216eac3", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "1064f8fb-3498-4645-bb85-d46d125136ea", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\learning\\feedback_system.py", "language": "python", "lines": 248, "filename": "feedback_system.py"}, "hash": "d33f0863e3e720a6ae026260f64371bf8e29267657b77ede6747db08931b74b0", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e382f51c-15c8-4c2d-aa7a-067581695b2c", "node_type": "1", "metadata": {}, "hash": "93a8c9f1345a53bc0b87270cc9c2109cbe2594703e93428caa3b2de0b89790f9", "class_name": "RelatedNodeInfo"}}, "text": "Args:\n            days: N\u00famero de dias para analisar\n\n        Returns:\n            Dicion\u00e1rio com estat\u00edsticas\n        \"\"\"\n        from datetime import timedelta\n\n        stats = {\n            'total': 0,\n            'positive': 0,\n            'negative': 0,\n            'partial': 0,\n            'success_rate': 0.0,\n            'common_issues': []\n        }\n\n        try:\n            # Ler arquivos dos \u00faltimos N dias\n            today = datetime.now()\n            feedback_entries = []\n\n            for i in range(days):\n                date = today - timedelta(days=i)\n                date_str = date.strftime('%Y%m%d')\n                feedback_file = os.path.join(self.feedback_dir, f'feedback_{date_str}.jsonl')\n\n                if os.path.exists(feedback_file):\n                    with open(feedback_file, 'r', encoding='utf-8') as f:\n                        for line in f:\n                            try:\n                                feedback_entries.append(json.loads(line.strip()))\n                            except json.JSONDecodeError:\n                                continue\n\n            # Calcular estat\u00edsticas\n            stats['total'] = len(feedback_entries)\n\n            if stats['total'] > 0:\n                for entry in feedback_entries:\n                    feedback_type = entry.get('feedback_type', '')\n                    if feedback_type == 'positive':\n                        stats['positive'] += 1\n                    elif feedback_type == 'negative':\n                        stats['negative'] += 1\n                    elif feedback_type == 'partial':\n                        stats['partial'] += 1\n\n                # Taxa de sucesso = (positivo + parcial/2) / total\n                stats['success_rate'] = (\n                    (stats['positive'] + stats['partial'] * 0.5) / stats['total'] * 100\n                )\n\n                # Coletar problemas comuns (coment\u00e1rios negativos)\n                issues = [\n                    entry.get('user_comment', '')\n                    for entry in feedback_entries\n                    if entry.get('feedback_type') == 'negative' and entry.get('user_comment')\n                ]\n                stats['common_issues'] = issues[:10]  # Top 10\n\n            self.logger.info(f\"\ud83d\udcca Stats: {stats['total']} feedbacks, {stats['success_rate']:.1f}% sucesso\")\n\n        except Exception as e:\n            self.logger.error(f\"\u274c Erro ao calcular estat\u00edsticas: {e}\")\n\n        return stats\n\n    def get_problematic_queries(self, limit: int = 10) -> list:\n        \"\"\"\n        Retorna queries que receberam mais feedback negativo.\n\n        Args:\n            limit: N\u00famero m\u00e1ximo de queries a retornar\n\n        Returns:\n            Lista de queries problem\u00e1ticas\n        \"\"\"\n        try:\n            from collections import Counter\n\n            negative_queries = []\n\n            # Ler todos os arquivos de feedback\n            for filename in os.listdir(self.feedback_dir):\n                if filename.startswith('feedback_') and filename.endswith('.jsonl'):\n                    feedback_file = os.path.join(self.feedback_dir, filename)\n\n                    with open(feedback_file, 'r', encoding='utf-8') as f:\n                        for line in f:\n                            try:\n                                entry = json.loads(line.strip())\n                                if entry.get('feedback_type') == 'negative':\n                                    negative_queries.append(entry.get('query', ''))\n                            except json.JSONDecodeError:\n                                continue\n\n            # Contar queries mais problem\u00e1ticas\n            query_counts = Counter(negative_queries)\n            most_common = query_counts.most_common(limit)\n\n            return [\n                {\n                    'query': query,\n                    'negative_count': count\n                }\n                for query, count in most_common\n            ]\n\n        except Exception as e:\n            self.logger.error(f\"\u274c Erro ao buscar queries problem\u00e1ticas: {e}\")\n            return []\n\n    def export_feedback_for_training(self, output_file: str = None) -> bool:\n        \"\"\"\n        Exporta feedback positivo para treinar o sistema (RAG/few-shot).", "mimetype": "text/plain", "start_char_idx": 2736, "end_char_idx": 6957, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e382f51c-15c8-4c2d-aa7a-067581695b2c": {"__data__": {"id_": "e382f51c-15c8-4c2d-aa7a-067581695b2c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\learning\\feedback_system.py", "language": "python", "lines": 248, "filename": "feedback_system.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d7cf21b9-e632-40ea-870a-c7c33b2a5597", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\learning\\feedback_system.py", "language": "python", "lines": 248, "filename": "feedback_system.py"}, "hash": "da789a061dda815847e6ad009985f898c2ee06c50a622b9a7eb643a50216eac3", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "d5092611-1baa-4ecc-bf8d-eb17bbdf8949", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\learning\\feedback_system.py", "language": "python", "lines": 248, "filename": "feedback_system.py"}, "hash": "eada4e2ff2d4cd74953158dd26709dd34ec71502dd9ade335b67f5ceace108e5", "class_name": "RelatedNodeInfo"}}, "text": "Args:\n            output_file: Arquivo de sa\u00edda (opcional)\n\n        Returns:\n            True se exportou com sucesso\n        \"\"\"\n        if output_file is None:\n            output_file = os.path.join(self.feedback_dir, 'positive_examples.json')\n\n        try:\n            positive_examples = []\n\n            # Ler todos os arquivos de feedback\n            for filename in os.listdir(self.feedback_dir):\n                if filename.startswith('feedback_') and filename.endswith('.jsonl'):\n                    feedback_file = os.path.join(self.feedback_dir, filename)\n\n                    with open(feedback_file, 'r', encoding='utf-8') as f:\n                        for line in f:\n                            try:\n                                entry = json.loads(line.strip())\n                                if entry.get('feedback_type') == 'positive':\n                                    positive_examples.append({\n                                        'query': entry.get('query'),\n                                        'code': entry.get('code'),\n                                        'result_rows': entry.get('result_rows'),\n                                        'timestamp': entry.get('timestamp')\n                                    })\n                            except json.JSONDecodeError:\n                                continue\n\n            # Salvar exemplos positivos\n            with open(output_file, 'w', encoding='utf-8') as f:\n                json.dump(positive_examples, f, indent=2, ensure_ascii=False)\n\n            self.logger.info(f\"\u2705 {len(positive_examples)} exemplos positivos exportados para {output_file}\")\n            return True\n\n        except Exception as e:\n            self.logger.error(f\"\u274c Erro ao exportar feedback: {e}\")\n            return False", "mimetype": "text/plain", "start_char_idx": 6967, "end_char_idx": 8755, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ff75761f-a5f1-4685-ad50-90a893ec4994": {"__data__": {"id_": "ff75761f-a5f1-4685-ad50-90a893ec4994", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\learning\\pattern_matcher.py", "language": "python", "lines": 63, "filename": "pattern_matcher.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b5bc249e-f558-434e-9e1e-df01ebb123d3", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\learning\\pattern_matcher.py", "language": "python", "lines": 63, "filename": "pattern_matcher.py"}, "hash": "b9e5a054c3136e7afdee8bb2c7e1ebdb38f3e3aecb78b206a5a24c1be0a883db", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/learning/pattern_matcher.py\n\nfrom typing import Any, Dict, List, Optional\n\nclass PatternMatcher:\n    \"\"\"\n    Detects known query patterns and provides few-shot examples for code generation.\n    \"\"\"\n    def __init__(self, patterns_config_path: str = \"data/query_patterns.json\"):\n        self.patterns = self._load_patterns(patterns_config_path)\n\n    def _load_patterns(self, patterns_config_path: str) -> List[Dict[str, Any]]:\n        \"\"\"\n        Loads pre-defined patterns and their associated example code/structure.\n        \"\"\"\n        # Placeholder: In a real scenario, load from JSON file\n        # Example structure:\n        # [\n        #   {\"name\": \"SalesBySegment\", \"keywords\": [\"vendas por segmento\"], \"example_code\": \"df.groupby('segmento')['vendas'].sum().to_dicts()\"},\n        #   {\"name\": \"TopNProducts\", \"keywords\": [\"top n produtos\", \"n maiores produtos\"], \"example_code\": \"df.groupby('produto')['vendas'].sum().sort('vendas', descending=True).head(N).to_dicts()\"}\n        # ]\n        print(f\"PatternMatcher placeholder: Loading patterns from {patterns_config_path}\")\n        return [\n            {\"name\": \"SalesBySegment\", \"keywords\": [\"vendas por segmento\", \"quanto vendi por segmento\"], \"example_code\": \"\"\"\nimport polars as pl\nresult = df.group_by('segmento').agg(pl.sum('vendas').alias('total_vendas')).sort('total_vendas', descending=True).to_dicts()\nfinal_output = {'result': result}\n\"\"\"},\n            {\"name\": \"TopNProducts\", \"keywords\": [\"top\", \"maiores\", \"melhores produtos\", \"produtos mais vendidos\"], \"example_code\": \"\"\"\nimport polars as pl\n# Replace N with actual number from query\nresult = df.group_by('produto_id').agg(pl.sum('vendas').alias('total_vendas')).sort('total_vendas', descending=True).head(N).to_dicts()\nfinal_output = {'result': result}\n\"\"\"},\n            {\"name\": \"MCbyProduct\", \"keywords\": [\"margem de contribuicao por produto\", \"mc por produto\"], \"example_code\": \"\"\"\nimport polars as pl\nresult = df.group_by('produto_id').agg(pl.mean('media_considerada_lv').alias('mc_media')).to_dicts()\nfinal_output = {'result': result}\n\"\"\"}\n        ]\n\n    def match_pattern(self, query: str) -> Optional[Dict[str, Any]]:\n        \"\"\"\n        Attempts to match the user query against known patterns.\n        Returns the pattern with example code if a match is found.\n        \"\"\"\n        query_lower = query.lower()\n        for pattern in self.patterns:\n            for keyword in pattern[\"keywords\"]:\n                if keyword in query_lower:\n                    print(f\"PatternMatcher: Matched pattern '{pattern['name']}' for query: '{query}'\")\n                    return pattern\n        return None\n\nif __name__ == '__main__':\n    print(\"--- Testing PatternMatcher ---\")\n    matcher = PatternMatcher()\n    \n    print(f\"Matching 'vendas por segmento': {matcher.match_pattern('Me mostre as vendas por segmento.')}\")\n    print(f\"Matching 'top 5 produtos mais vendidos': {matcher.match_pattern('Quais os top 5 produtos mais vendidos?')}\")\n    print(f\"Matching 'margem de contribuicao por produto': {matcher.match_pattern('Calcule a margem de contribuicao por produto.')}\")\n    print(f\"Matching 'query sem match': {matcher.match_pattern('Qual o clima hoje?')}\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3205, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "dff5c957-ba3f-44e6-8018-5af35e4eafe4": {"__data__": {"id_": "dff5c957-ba3f-44e6-8018-5af35e4eafe4", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\monitoring\\metrics_dashboard.py", "language": "python", "lines": 183, "filename": "metrics_dashboard.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ec80adb7-1e19-42e1-9c9e-c72304ded225", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\monitoring\\metrics_dashboard.py", "language": "python", "lines": 183, "filename": "metrics_dashboard.py"}, "hash": "d36f663dee32b9c63530ec8db753229fd2b2ed39ac25270b0afea0fc53385ecb", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3bd1e46c-05fb-4f98-bca9-226da59d6864", "node_type": "1", "metadata": {}, "hash": "753053aa1c8430152e43d84aac3291c59e8d75174edd78ab0ffd6c45cf1907c7", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/monitoring/metrics_dashboard.py\n\nimport json\nimport os\nfrom datetime import datetime, timedelta\nfrom typing import Any, Dict, List, Optional\nfrom collections import defaultdict\nfrom pathlib import Path\n\nfrom app.config.settings import settings\nfrom app.core.utils.query_history import QueryHistory # To get query data\nfrom app.core.utils.response_cache import ResponseCache # To query cache stats\n\nclass MetricsDashboard:\n    \"\"\"\n    Collects and provides various metrics for monitoring the BI agent's performance.\n    (T4.4.2 from TASK_LIST)\n    \"\"\"\n    def __init__(self, query_history: Optional[QueryHistory] = None, response_cache: Optional[ResponseCache] = None):\n        self.query_history = query_history if query_history else QueryHistory(history_dir=settings.LEARNING_EXAMPLES_PATH) # Using LEARNING_EXAMPLES_PATH as history\n        self.response_cache = response_cache if response_cache else ResponseCache(cache_dir=settings.LEARNING_FEEDBACK_PATH, ttl_minutes=settings.CACHE_TTL_MINUTES) # Using LEARNING_FEEDBACK_PATH as cache\n\n    def get_metrics(self, days: int = 7) -> Dict[str, Any]:\n        \"\"\"\n        Retrieves key performance indicators (KPIs) for the last N days.\n        - Success Rate (from feedback)\n        - Average Response Time (placeholder)\n        - Cache Hit Rate\n        - Total Queries\n        - Total Errors\n        \"\"\"\n        end_date = datetime.now()\n        start_date = end_date - timedelta(days=days)\n\n        all_queries = self.query_history.get_history(start_date=start_date, end_date=end_date, limit=None)\n        \n        total_queries = len(all_queries)\n        total_errors = sum(1 for q in all_queries if \"error\" in q.get(\"response_summary\", \"\").lower()) # Simple error detection\n        \n        # Cache hit rate (placeholder - requires more sophisticated cache logging)\n        # For now, we'll simulate. In a real system, the cache would log hits/misses.\n        cache_hits = 0 # Placeholder for actual cache hits\n        cache_misses = total_queries # Placeholder for actual cache misses\n        cache_hit_rate = (cache_hits / total_queries) * 100 if total_queries > 0 else 0\n\n        # Success rate (placeholder - needs dedicated feedback system)\n        # Assuming feedback is stored by QueryHistory for now\n        feedback_file_path = Path(settings.LEARNING_FEEDBACK_PATH) / \"feedback.jsonl\"\n        positive_feedback = 0\n        negative_feedback = 0\n        try:\n            if os.path.exists(feedback_file_path):\n                with open(feedback_file_path, 'r', encoding='utf-8') as f:\n                    for line in f:\n                        if not line.strip():\n                            continue\n                        try:\n                            feedback_entry = json.loads(line)\n                            timestamp_str = feedback_entry.get(\"timestamp\", \"\")\n                            if not timestamp_str:\n                                continue\n\n                            # Handle different timestamp formats\n                            try:\n                                entry_timestamp = datetime.fromisoformat(timestamp_str.replace('Z', '+00:00'))\n                            except (ValueError, AttributeError):\n                                continue\n\n                            if start_date <= entry_timestamp <= end_date:\n                                if feedback_entry.get(\"feedback_type\") == \"positive\":\n                                    positive_feedback += 1\n                                elif feedback_entry.get(\"feedback_type\") == \"negative\":\n                                    negative_feedback += 1\n                        except (json.JSONDecodeError, KeyError) as parse_error:\n                            continue\n        except Exception as e:\n            print(f\"Error reading feedback file: {e}\")\n\n        total_feedback = positive_feedback + negative_feedback\n        success_rate = (positive_feedback / total_feedback) * 100 if total_feedback > 0 else 0\n\n\n        return {\n            \"total_queries\": total_queries,\n            \"total_errors\": total_errors,\n            \"success_rate_feedback\": round(success_rate, 2),\n            \"cache_hit_rate\": round(cache_hit_rate, 2), # Needs actual implementation\n            \"average_response_time_ms\": \"N/A\" # Placeholder, needs instrumented timing\n        }\n\n    def get_error_trend(self, days: int = 30) -> List[Dict[str, Any]]:\n        \"\"\"\n        Provides a daily trend of errors for the last N days.\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4495, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3bd1e46c-05fb-4f98-bca9-226da59d6864": {"__data__": {"id_": "3bd1e46c-05fb-4f98-bca9-226da59d6864", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\monitoring\\metrics_dashboard.py", "language": "python", "lines": 183, "filename": "metrics_dashboard.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ec80adb7-1e19-42e1-9c9e-c72304ded225", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\monitoring\\metrics_dashboard.py", "language": "python", "lines": 183, "filename": "metrics_dashboard.py"}, "hash": "d36f663dee32b9c63530ec8db753229fd2b2ed39ac25270b0afea0fc53385ecb", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "dff5c957-ba3f-44e6-8018-5af35e4eafe4", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\monitoring\\metrics_dashboard.py", "language": "python", "lines": 183, "filename": "metrics_dashboard.py"}, "hash": "683af168a37c4c2649b76a54b385da6ba04ebfa9fc3a421c72a000bea8d776e7", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e78781fc-1da8-45ff-9e43-3a2ffcc0b9c9", "node_type": "1", "metadata": {}, "hash": "3977c5ebcdd98f46ca5486c99a82d8edd9bf361657f319a90355f02283eb1a9a", "class_name": "RelatedNodeInfo"}}, "text": "return {\n            \"total_queries\": total_queries,\n            \"total_errors\": total_errors,\n            \"success_rate_feedback\": round(success_rate, 2),\n            \"cache_hit_rate\": round(cache_hit_rate, 2), # Needs actual implementation\n            \"average_response_time_ms\": \"N/A\" # Placeholder, needs instrumented timing\n        }\n\n    def get_error_trend(self, days: int = 30) -> List[Dict[str, Any]]:\n        \"\"\"\n        Provides a daily trend of errors for the last N days.\n        \"\"\"\n        end_date = datetime.now()\n        start_date = end_date - timedelta(days=days)\n        \n        error_counts_by_date = defaultdict(int)\n        all_queries = self.query_history.get_history(start_date=start_date, end_date=end_date, limit=None)\n\n        for query_entry in all_queries:\n            if \"error\" in query_entry.get(\"response_summary\", \"\").lower():\n                query_date = datetime.fromisoformat(query_entry[\"timestamp\"]).strftime(\"%Y-%m-%d\")\n                error_counts_by_date[query_date] += 1\n        \n        trend_data = []\n        current_date = start_date\n        while current_date <= end_date:\n            date_str = current_date.strftime(\"%Y-%m-%d\")\n            trend_data.append({\n                \"date\": date_str,\n                \"error_count\": error_counts_by_date[date_str]\n            })\n            current_date += timedelta(days=1)\n        \n        return trend_data\n\n    def get_top_queries(self, days: int = 7, limit: int = 10) -> List[Dict[str, Any]]:\n        \"\"\"\n        Identifies the most frequent queries in the last N days.\n        \"\"\"\n        end_date = datetime.now()\n        start_date = end_date - timedelta(days=days)\n\n        query_counts = defaultdict(int)\n        all_queries = self.query_history.get_history(start_date=start_date, end_date=end_date, limit=None)\n\n        for query_entry in all_queries:\n            query_text = query_entry.get(\"query\", \"\")\n            if query_text:\n                query_counts[query_text] += 1\n        \n        top_queries = sorted(query_counts.items(), key=lambda item: item[1], reverse=True)\n        return [{\"query\": q, \"count\": count} for q, count in top_queries[:limit]]\n\nif __name__ == '__main__':\n    from app.config.settings import Settings\n    temp_settings = Settings()\n    os.makedirs(temp_settings.LEARNING_FEEDBACK_PATH, exist_ok=True) # Ensure dir exists for feedback.jsonl\n    os.makedirs(temp_settings.LEARNING_EXAMPLES_PATH, exist_ok=True) # Ensure dir exists for query_history\n    \n    # Setup dummy query history and feedback\n    history = QueryHistory(history_dir=temp_settings.LEARNING_EXAMPLES_PATH)\n    history.add_query(\"user1\", \"Vendas por produto?\", {\"type\": \"text\", \"text\": \"OK\"})\n    history.add_query(\"user1\", \"Erro na consulta de estoque.\", {\"type\": \"error\", \"error\": \"simulated error\"})\n    history.add_query(\"user2\", \"Quais os top 5 produtos?\", {\"type\": \"text\", \"text\": \"OK\"})\n    history.add_query(\"user1\", \"Vendas por produto?\", {\"type\": \"text\", \"text\": \"OK\"}) # Duplicate query\n    \n    # Simulate feedback\n    feedback_file = Path(temp_settings.LEARNING_FEEDBACK_PATH) / \"feedback.jsonl\"\n    with open(feedback_file, 'a', encoding='utf-8') as f:\n        f.write(json.dumps({\"timestamp\": datetime.now().isoformat(), \"user_id\": \"user1\", \"feedback_type\": \"positive\"}) + \"\\n\")\n        f.write(json.dumps({\"timestamp\": (datetime.now() - timedelta(days=1)).isoformat(), \"user_id\": \"user1\", \"feedback_type\": \"negative\"}) + \"\\n\")\n    \n    dashboard = MetricsDashboard(query_history=history)\n\n    print(\"\\n--- Testing get_metrics ---\")\n    metrics = dashboard.get_metrics(days=7)\n    print(json.dumps(metrics, indent=2))\n    assert metrics[\"total_queries\"] >= 4\n    assert metrics[\"total_errors\"] >= 1\n    assert metrics[\"success_rate_feedback\"] > 0\n\n    print(\"\\n--- Testing get_error_trend ---\")\n    error_trend = dashboard.get_error_trend(days=7)\n    print(json.dumps(error_trend, indent=2))\n    assert any(item[\"error_count\"] > 0 for item in error_trend)\n\n    print(\"\\n--- Testing get_top_queries ---\")\n    top_queries = dashboard.get_top_queries(days=7, limit=2)\n    print(json.dumps(top_queries, indent=2))\n    assert top_queries[0][\"query\"] == \"Vendas por produto?\"", "mimetype": "text/plain", "start_char_idx": 3999, "end_char_idx": 8189, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e78781fc-1da8-45ff-9e43-3a2ffcc0b9c9": {"__data__": {"id_": "e78781fc-1da8-45ff-9e43-3a2ffcc0b9c9", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\monitoring\\metrics_dashboard.py", "language": "python", "lines": 183, "filename": "metrics_dashboard.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ec80adb7-1e19-42e1-9c9e-c72304ded225", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\monitoring\\metrics_dashboard.py", "language": "python", "lines": 183, "filename": "metrics_dashboard.py"}, "hash": "d36f663dee32b9c63530ec8db753229fd2b2ed39ac25270b0afea0fc53385ecb", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3bd1e46c-05fb-4f98-bca9-226da59d6864", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\monitoring\\metrics_dashboard.py", "language": "python", "lines": 183, "filename": "metrics_dashboard.py"}, "hash": "4a1ba9b9ab8846370b8a789f4467ec850855092f2156cefcdcf994bf46d89851", "class_name": "RelatedNodeInfo"}}, "text": "assert top_queries[0][\"count\"] == 2\n\n    # Clean up dummy files\n    for filename in os.listdir(temp_settings.LEARNING_EXAMPLES_PATH):\n        if filename.startswith(\"queries_\"):\n            os.remove(os.path.join(temp_settings.LEARNING_EXAMPLES_PATH, filename))\n    if os.path.exists(feedback_file):\n        os.remove(feedback_file)\n    print(\"\\nCleaned up dummy metrics files.\")\n    print(\"\\nMetricsDashboard tests passed!\")", "mimetype": "text/plain", "start_char_idx": 8194, "end_char_idx": 8619, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0e51e622-5281-4ed5-9e7c-ee256b0cd870": {"__data__": {"id_": "0e51e622-5281-4ed5-9e7c-ee256b0cd870", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\rag\\example_collector.py", "language": "python", "lines": 129, "filename": "example_collector.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4ba162b9-7119-44ec-bf12-36b4df557b4a", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\rag\\example_collector.py", "language": "python", "lines": 129, "filename": "example_collector.py"}, "hash": "ef68f519aa8d4705abcf07f610d5959bdd76637d0300192509a34034a4ee3b2f", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "80109394-815e-4d0d-9fac-b996bb32bf87", "node_type": "1", "metadata": {}, "hash": "00c912f6fb7427a520e9611a2b39b93903db188a2ad7c7bbed54d3c4d8c37c87", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/rag/example_collector.py\n\nimport json\nimport os\nfrom datetime import datetime\nfrom typing import Any, Dict, List, Optional\n\nfrom app.config.settings import settings\n\nclass ExampleCollector:\n    \"\"\"\n    Collects successful queries, their generated code, and results to serve as\n    few-shot examples for RAG and continuous learning.\n    (T6.4.2 from TASK_LIST)\n    \"\"\"\n    def __init__(self, examples_dir: str = settings.LEARNING_EXAMPLES_PATH):\n        self.examples_dir = examples_dir\n        os.makedirs(self.examples_dir, exist_ok=True)\n        print(f\"ExampleCollector initialized in {self.examples_dir}\")\n\n    def _get_daily_file_path(self, date: Optional[datetime] = None) -> str:\n        \"\"\"Generates the file path for a given day's examples.\"\"\"\n        if date is None:\n            date = datetime.now()\n        date_str = date.strftime(\"%Y-%m-%d\")\n        return os.path.join(self.examples_dir, f\"examples_{date_str}.jsonl\")\n\n    def add_example(self, user_id: str, query: str, code: str, result: Dict[str, Any], intent: str, timestamp: Optional[datetime] = None):\n        \"\"\"\n        Adds a new successful example to the daily examples file.\n        \"\"\"\n        if timestamp is None:\n            timestamp = datetime.now()\n        \n        entry = {\n            \"timestamp\": timestamp.isoformat(),\n            \"user_id\": user_id,\n            \"query\": query,\n            \"code\": code,\n            \"result_summary\": self._summarize_result(result),\n            \"intent\": intent # e.g., \"sales_analysis\", \"product_comparison\"\n        }\n        file_path = self._get_daily_file_path(timestamp)\n        \n        try:\n            with open(file_path, \"a\", encoding=\"utf-8\") as f:\n                f.write(json.dumps(entry, ensure_ascii=False) + \"\\n\")\n            print(f\"Example added to collector for user {user_id}.\")\n        except OSError as e:\n            print(f\"Error writing example file {file_path}: {e}\")\n\n    def _summarize_result(self, result: Dict[str, Any]) -> str:\n        \"\"\"Creates a brief summary of the result.\"\"\"\n        # For simplicity, just return the first 100 chars of the result if it's a string, or its type.\n        if isinstance(result, dict) and \"result\" in result:\n            res = result[\"result\"]\n            if isinstance(res, str):\n                return res[:100] + (\"...\" if len(res) > 100 else \"\")\n            return f\"Dict result with keys: {list(res.keys())}\"\n        return str(type(result))\n\n    def get_all_examples(self, start_date: Optional[datetime] = None, end_date: Optional[datetime] = None) -> List[Dict[str, Any]]:\n        \"\"\"\n        Retrieves all examples within a date range.\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2663, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "80109394-815e-4d0d-9fac-b996bb32bf87": {"__data__": {"id_": "80109394-815e-4d0d-9fac-b996bb32bf87", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\rag\\example_collector.py", "language": "python", "lines": 129, "filename": "example_collector.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4ba162b9-7119-44ec-bf12-36b4df557b4a", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\rag\\example_collector.py", "language": "python", "lines": 129, "filename": "example_collector.py"}, "hash": "ef68f519aa8d4705abcf07f610d5959bdd76637d0300192509a34034a4ee3b2f", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "0e51e622-5281-4ed5-9e7c-ee256b0cd870", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\rag\\example_collector.py", "language": "python", "lines": 129, "filename": "example_collector.py"}, "hash": "d8b18d6d9122f7706872257c3ca7d939f7d1dcfe72ae74e61da29f107c883d8c", "class_name": "RelatedNodeInfo"}}, "text": "except OSError as e:\n            print(f\"Error writing example file {file_path}: {e}\")\n\n    def _summarize_result(self, result: Dict[str, Any]) -> str:\n        \"\"\"Creates a brief summary of the result.\"\"\"\n        # For simplicity, just return the first 100 chars of the result if it's a string, or its type.\n        if isinstance(result, dict) and \"result\" in result:\n            res = result[\"result\"]\n            if isinstance(res, str):\n                return res[:100] + (\"...\" if len(res) > 100 else \"\")\n            return f\"Dict result with keys: {list(res.keys())}\"\n        return str(type(result))\n\n    def get_all_examples(self, start_date: Optional[datetime] = None, end_date: Optional[datetime] = None) -> List[Dict[str, Any]]:\n        \"\"\"\n        Retrieves all examples within a date range.\n        \"\"\"\n        all_examples: List[Dict[str, Any]] = []\n        \n        if start_date is None:\n            start_date = datetime.min\n        if end_date is None:\n            end_date = datetime.max\n\n        for filename in sorted(os.listdir(self.examples_dir)):\n            if filename.startswith(\"examples_\") and filename.endswith(\".jsonl\"):\n                file_date_str = filename[9:19] # YYYY-MM-DD\n                file_date = datetime.strptime(file_date_str, \"%Y-%m-%d\")\n                \n                if file_date > end_date.replace(hour=23, minute=59, second=59, microsecond=999999):\n                    continue\n                if file_date < start_date.replace(hour=0, minute=0, second=0, microsecond=0):\n                    continue\n\n                file_path = os.path.join(self.examples_dir, filename)\n                try:\n                    with open(file_path, \"r\", encoding=\"utf-8\") as f:\n                        for line in f:\n                            try:\n                                entry = json.loads(line)\n                                entry_timestamp = datetime.fromisoformat(entry[\"timestamp\"])\n\n                                if start_date <= entry_timestamp <= end_date:\n                                    all_examples.append(entry)\n                            except json.JSONDecodeError:\n                                print(f\"Warning: Corrupt JSON line in {filename}: {line.strip()}\")\n                except OSError as e:\n                    print(f\"Error reading examples file {file_path}: {e}\")\n        \n        return all_examples\n\n# Example usage\nif __name__ == '__main__':\n    from app.config.settings import Settings\n    temp_settings = Settings()\n\n    # Ensure examples directory exists for testing\n    os.makedirs(temp_settings.LEARNING_EXAMPLES_PATH, exist_ok=True)\n\n    collector = ExampleCollector(examples_dir=temp_settings.LEARNING_EXAMPLES_PATH)\n\n    user1_id = \"test_user_1\"\n    \n    # Add some examples\n    collector.add_example(user1_id, \"Vendas totais por produto\", \"df.groupby('product').sum()\", {\"result\": \"ok\"}, \"sales_analysis\")\n    collector.add_example(user1_id, \"Top 5 clientes\", \"df.groupby('client').count().sort()\", {\"result\": \"ok\"}, \"customer_segmentation\")\n    collector.add_example(user1_id, \"M\u00e9dia de pre\u00e7o por categoria\", \"df.groupby('category').mean('price')\", {\"result\": \"ok\"}, \"pricing_analysis\")\n\n    print(\"\\n--- Testing get_all_examples ---\")\n    all_examples = collector.get_all_examples()\n    print(f\"All examples ({len(all_examples)} records):\")\n    for entry in all_examples:\n        print(f\"  [{entry['timestamp']}] User {entry['user_id']}: {entry['query']} -> {entry['intent']}\")\n\n    # Clean up dummy files\n    for filename in os.listdir(temp_settings.LEARNING_EXAMPLES_PATH):\n        if filename.startswith(\"examples_\"):\n            os.remove(os.path.join(temp_settings.LEARNING_EXAMPLES_PATH, filename))\n    print(\"\\nCleaned up dummy example files.\")\n    print(\"\\nExampleCollector tests passed!\")", "mimetype": "text/plain", "start_char_idx": 1849, "end_char_idx": 5643, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ac768216-94ce-4dac-bcb4-884068b762e2": {"__data__": {"id_": "ac768216-94ce-4dac-bcb4-884068b762e2", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\rag\\query_retriever.py", "language": "python", "lines": 179, "filename": "query_retriever.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "76f8076c-b9ad-4ec2-9635-1dc6cac1217e", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\rag\\query_retriever.py", "language": "python", "lines": 179, "filename": "query_retriever.py"}, "hash": "f8e61900d4181f45001cdb723754a2ae04de4d4b162d7dc156dd7c26ecd3cd9c", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "63e8f198-5138-4b0a-a3aa-79010b05fecc", "node_type": "1", "metadata": {}, "hash": "a72eb5b4e0fd4bf359243e4c1bb2f562ef279684b8d0177d6b74fe000a246177", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/rag/query_retriever.py\n\nfrom typing import Any, Dict, List, Optional\nimport os\nimport json\nimport functools # Added import\n\n# Import ExampleCollector\nfrom app.core.rag.example_collector import ExampleCollector\nfrom app.config.settings import settings\n\n# Placeholder for SentenceTransformer and FAISS.\n# In a real implementation, these would be loaded conditionally/lazily.\ntry:\n    from sentence_transformers import SentenceTransformer\n    import faiss\n    HAS_RAG_DEPS = True\nexcept (ImportError, OSError, Exception) as e: # Catch OSError for PyTorch/DLL issues\n    print(f\"Warning: RAG dependencies (sentence_transformers, faiss) failed to load: {e}. RAG functionality will be limited.\")\n    HAS_RAG_DEPS = False\n\nclass QueryRetriever:\n    \"\"\"\n    Retrieves semantically similar past queries and their associated metadata (code, results)\n    to serve as few-shot examples for RAG.\n    (T6.4.1 from TASK_LIST)\n    \"\"\"\n    def __init__(self, embedding_model_name: str = settings.RAG_EMBEDDING_MODEL, faiss_index_path: str = settings.RAG_FAISS_INDEX_PATH, examples_path: str = settings.LEARNING_EXAMPLES_PATH):\n        self.embedding_model_name = embedding_model_name\n        self.faiss_index_path = faiss_index_path\n        self.examples_path = examples_path # Used by ExampleCollector\n        self.model = None\n        self.index = None\n        self.examples_data: List[Dict[str, Any]] = [] # Stored as a list of dicts\n\n        self.example_collector = ExampleCollector(examples_dir=self.examples_path)\n\n        if HAS_RAG_DEPS:\n            self._load_model()\n            self._load_index_and_examples()\n        else:\n            print(\"RAG dependencies not available. QueryRetriever will operate without semantic search.\")\n\n    @functools.lru_cache(maxsize=1) # Cache the model instance\n    def _get_cached_model(self):\n        \"\"\"Internal method to get a cached SentenceTransformer model instance.\"\"\"\n        if not HAS_RAG_DEPS:\n            return None\n        try:\n            model = SentenceTransformer(self.embedding_model_name)\n            print(f\"RAG: Loaded embedding model: {self.embedding_model_name}\")\n            return model\n        except Exception as e:\n            print(f\"Error loading SentenceTransformer model: {e}\")\n            return None\n\n    def _load_model(self):\n        \"\"\"Loads the Sentence Transformer model lazily using a cached internal method.\"\"\"\n        if self.model is None:\n            self.model = self._get_cached_model()\n    \n    def _load_index_and_examples(self):\n        \"\"\"Loads FAISS index and corresponding examples data.\"\"\"\n        if not HAS_RAG_DEPS or self.model is None:\n            print(\"RAG: Cannot load index or examples without model and dependencies.\")\n            return\n\n        # Attempt to load examples data from ExampleCollector\n        self.examples_data = self.example_collector.get_all_examples()\n        if not self.examples_data:\n            print(\"RAG: No examples found in collector to load or index.\")\n            return\n\n        if not os.path.exists(self.faiss_index_path):\n            print(f\"RAG: FAISS index not found at {self.faiss_index_path}. Indexing examples...\")\n            self._index_examples_data()\n            return\n\n        try:\n            self.index = faiss.read_index(self.faiss_index_path)\n            print(f\"RAG: Loaded FAISS index from {self.faiss_index_path}\")\n            print(f\"RAG: Loaded {len(self.examples_data)} examples for RAG.\")\n        except Exception as e:\n            print(f\"Error loading FAISS index: {e}. Re-indexing...\")\n            self._index_examples_data()\n\n    def _index_examples_data(self):\n        \"\"\"\n        Indexes examples data (from self.examples_data) into FAISS.\n        \"\"\"\n        if not HAS_RAG_DEPS or self.model is None:\n            print(\"Cannot index examples: RAG dependencies or model not available.\")\n            return\n        if not self.examples_data:\n            print(\"No examples data to index.\")\n            return\n\n        queries = [ex[\"query\"] for ex in self.examples_data]\n        embeddings = self.model.encode(queries, convert_to_numpy=True)\n\n        dimension = embeddings.shape[1]\n        self.index = faiss.IndexFlatL2(dimension)\n        self.index.add(embeddings)\n\n        faiss.write_index(self.index, self.faiss_index_path)\n        print(f\"RAG: Indexed {len(self.examples_data)} examples and saved FAISS index.\")\n\n    def _index_examples_from_files(self):\n        \"\"\"\n        (Deprecated) Collects and indexes examples from JSONL files in the examples_path.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4536, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "63e8f198-5138-4b0a-a3aa-79010b05fecc": {"__data__": {"id_": "63e8f198-5138-4b0a-a3aa-79010b05fecc", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\rag\\query_retriever.py", "language": "python", "lines": 179, "filename": "query_retriever.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "76f8076c-b9ad-4ec2-9635-1dc6cac1217e", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\rag\\query_retriever.py", "language": "python", "lines": 179, "filename": "query_retriever.py"}, "hash": "f8e61900d4181f45001cdb723754a2ae04de4d4b162d7dc156dd7c26ecd3cd9c", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "ac768216-94ce-4dac-bcb4-884068b762e2", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\rag\\query_retriever.py", "language": "python", "lines": 179, "filename": "query_retriever.py"}, "hash": "5756f362817482687e06d10021993717254bfb151baf16a24df2bcdce5840bb5", "class_name": "RelatedNodeInfo"}}, "text": "if not HAS_RAG_DEPS or self.model is None:\n            print(\"Cannot index examples: RAG dependencies or model not available.\")\n            return\n        if not self.examples_data:\n            print(\"No examples data to index.\")\n            return\n\n        queries = [ex[\"query\"] for ex in self.examples_data]\n        embeddings = self.model.encode(queries, convert_to_numpy=True)\n\n        dimension = embeddings.shape[1]\n        self.index = faiss.IndexFlatL2(dimension)\n        self.index.add(embeddings)\n\n        faiss.write_index(self.index, self.faiss_index_path)\n        print(f\"RAG: Indexed {len(self.examples_data)} examples and saved FAISS index.\")\n\n    def _index_examples_from_files(self):\n        \"\"\"\n        (Deprecated) Collects and indexes examples from JSONL files in the examples_path.\n        Now uses ExampleCollector.get_all_examples()\n        \"\"\"\n        print(\"RAG: _index_examples_from_files is deprecated. Using ExampleCollector.\")\n        self.examples_data = self.example_collector.get_all_examples()\n        self._index_examples_data()\n\n    def get_similar_queries(self, query: str, top_k: int = 3) -> List[Dict[str, Any]]:\n        \"\"\"\n        Retrieves top_k semantically similar queries from the indexed examples.\n        \"\"\"\n        if not HAS_RAG_DEPS or self.model is None or self.index is None:\n            print(\"QueryRetriever: RAG not fully initialized. Returning empty list.\")\n            return []\n\n        query_embedding = self.model.encode([query], convert_to_numpy=True)\n        distances, indices = self.index.search(query_embedding, top_k)\n\n        similar_examples = []\n        for i in indices[0]:\n            if 0 <= i < len(self.examples_data): # Ensure index is valid\n                similar_examples.append(self.examples_data[i])\n        \n        print(f\"QueryRetriever: Found {len(similar_examples)} similar examples for query: '{query}'\")\n        return similar_examples\n\nif __name__ == '__main__':\n    # Setup dummy environment for testing\n    from app.config.settings import Settings\n    temp_settings = Settings()\n    \n    # Ensure data/learning directory exists\n    os.makedirs(temp_settings.LEARNING_EXAMPLES_PATH, exist_ok=True)\n    \n    # Create some dummy example data\n    dummy_examples = [\n        {\"query\": \"Mostre as vendas por produto no segmento A\", \"code\": \"code1\", \"result\": \"res1\"},\n        {\"query\": \"Quantos produtos vendemos no segmento B\", \"code\": \"code2\", \"result\": \"res2\"},\n        {\"query\": \"Analise o desempenho de vendas por categoria\", \"code\": \"code3\", \"result\": \"res3\"},\n        {\"query\": \"Qual o total de vendas por segmento\", \"code\": \"code4\", \"result\": \"res4\"},\n    ]\n    with open(os.path.join(temp_settings.LEARNING_EXAMPLES_PATH, \"dummy_examples.jsonl\"), 'w', encoding='utf-8') as f:\n        for ex in dummy_examples:\n            f.write(json.dumps(ex) + '\\n')\n\n    print(\"--- Testing QueryRetriever ---\")\n    retriever = QueryRetriever(\n        embedding_model_name=temp_settings.RAG_EMBEDDING_MODEL,\n        faiss_index_path=temp_settings.RAG_FAISS_INDEX_PATH,\n        examples_path=temp_settings.LEARNING_EXAMPLES_PATH\n    )\n\n    if HAS_RAG_DEPS:\n        # Test semantic search\n        similar_queries = retriever.get_similar_queries(\"Quais foram os produtos mais vendidos por segmento?\", top_k=2)\n        print(\"\\nSimilar queries found:\")\n        for q in similar_queries:\n            print(f\"- {q['query']}\")\n    else:\n        print(\"\\nSkipping semantic search test as RAG dependencies are not available.\")\n\n    # Clean up dummy files\n    if os.path.exists(os.path.join(temp_settings.LEARNING_EXAMPLES_PATH, \"dummy_examples.jsonl\")):\n        os.remove(os.path.join(temp_settings.LEARNING_EXAMPLES_PATH, \"dummy_examples.jsonl\"))\n    if os.path.exists(temp_settings.RAG_FAISS_INDEX_PATH):\n        os.remove(temp_settings.RAG_FAISS_INDEX_PATH)\n    if os.path.exists(os.path.join(temp_settings.LEARNING_EXAMPLES_PATH, \"indexed_examples.jsonl\")):\n        os.remove(os.path.join(temp_settings.LEARNING_EXAMPLES_PATH, \"indexed_examples.jsonl\"))\n    print(\"\\nCleaned up dummy RAG files.\")", "mimetype": "text/plain", "start_char_idx": 3733, "end_char_idx": 7804, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "4f1c2edb-a684-4b28-8856-3a9f2167a2ad": {"__data__": {"id_": "4f1c2edb-a684-4b28-8856-3a9f2167a2ad", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\security\\data_masking.py", "language": "python", "lines": 95, "filename": "data_masking.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fd4fe35f-8dfa-45f8-b847-a745c776ba01", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\security\\data_masking.py", "language": "python", "lines": 95, "filename": "data_masking.py"}, "hash": "5c52c73464bd8cf6b0f8a2298840755503fd72bfce2ac6130157b61bdbf216ac", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/security/data_masking.py\n\nimport re\nfrom typing import List, Dict, Any, Optional\n\ndef mask_pii(text: str) -> str:\n    \"\"\"\n    Masks common Personally Identifiable Information (PII) like CPF, email, and phone numbers.\n    CPF: Replaces numbers with '*' except for the last two digits.\n    Email: Masks username part, keeps domain.\n    Phone: Masks most digits, keeps last four.\n    \"\"\"\n    if not isinstance(text, str):\n        return text\n\n    # Mask CPF (e.g., XXX.XXX.XXX-XX or XXXXXXXXXXX)\n    # 11 digits, with or without dots and hyphens\n    text = re.sub(r'(\\d{3}\\.?\\d{3}\\.?\\d{3}-?\\d{2})', \n                  lambda m: '***.***.***-' + m.group(1)[-2:], text)\n    \n    # Mask Email\n    text = re.sub(r'(\\b[a-zA-Z0-9._%+-]+)@([a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}\\b)', \n                  lambda m: '***@' + m.group(2), text)\n\n    # Mask Phone Numbers (e.g., (XX) XXXXX-XXXX or XXXXXXXXX)\n    # Simple mask: keep country code if present, and last 4 digits\n    # (NN) NNNNN-NNNN\n    text = re.sub(r'(\\(?\\d{2}\\)?\\s?\\d{4,5}-?\\d{4})', \n                  lambda m: re.sub(r'\\d(?=\\d{4})', '*', m.group(1)), text)\n    \n    return text\n\ndef get_pii_summary(text: str) -> Dict[str, List[str]]:\n    \"\"\"\n    Detects and categorizes types of PII present in the text.\n    Returns a dictionary with PII types as keys and detected PII fragments as values.\n    \"\"\"\n    if not isinstance(text, str):\n        return {}\n\n    pii_found: Dict[str, List[str]] = {\n        \"cpf\": [],\n        \"email\": [],\n        \"phone\": []\n    }\n\n    # Detect CPF\n    cpf_matches = re.findall(r'\\d{3}\\.?\\d{3}\\.?\\d{3}-?\\d{2}', text)\n    if cpf_matches:\n        pii_found[\"cpf\"].extend(cpf_matches)\n\n    # Detect Email\n    email_matches = re.findall(r'\\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}\\b', text)\n    if email_matches:\n        pii_found[\"email\"].extend(email_matches)\n\n    # Detect Phone Numbers\n    phone_matches = re.findall(r'(\\(?\\d{2}\\)?\\s?\\d{4,5}-?\\d{4})', text)\n    if phone_matches:\n        pii_found[\"phone\"].extend(phone_matches)\n    \n    return {k: list(set(v)) for k, v in pii_found.items() if v} # Remove duplicates and empty lists\n\n# Example usage\nif __name__ == '__main__':\n    test_text = \"\"\"\n    O cliente Jo\u00e3o Silva (joao.silva@example.com) com CPF 123.456.789-00 e telefone (11) 98765-4321\n    fez um pedido. Outro CPF: 99988877766. E-mail alternativo: j.silva@mail.com. Telefone comercial: 21991234567.\n    \"\"\"\n    \n    print(\"--- Original Text ---\")\n    print(test_text)\n\n    print(\"\\n--- Masked Text (mask_pii) ---\")\n    masked_text = mask_pii(test_text)\n    print(masked_text)\n    assert \"***.***.***-00\" in masked_text\n    assert \"***@example.com\" in masked_text\n    assert \"(**) *****-4321\" in masked_text\n    assert \"***@mail.com\" in masked_text\n    assert \"**991234567\" in masked_text\n\n\n    print(\"\\n--- PII Summary (get_pii_summary) ---\")\n    pii_summary = get_pii_summary(test_text)\n    print(json.dumps(pii_summary, indent=2))\n    assert \"cpf\" in pii_summary\n    assert \"email\" in pii_summary\n    assert \"phone\" in pii_summary\n    assert \"123.456.789-00\" in pii_summary[\"cpf\"]\n    assert \"joao.silva@example.com\" in pii_summary[\"email\"]\n    assert \"(11) 98765-4321\" in pii_summary[\"phone\"]\n\n    print(\"\\nData masking and PII detection tests passed!\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3266, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "26eb2191-e916-46a5-98e4-45031a0c1fff": {"__data__": {"id_": "26eb2191-e916-46a5-98e4-45031a0c1fff", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\security\\input_validator.py", "language": "python", "lines": 81, "filename": "input_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "983b1bc6-4018-4ca0-bfd3-113a59ba53c4", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\security\\input_validator.py", "language": "python", "lines": 81, "filename": "input_validator.py"}, "hash": "33805d7628e1c23ea9c42c18263d8832fa4d99d101f3a766d1c7aba6c23d7214", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/security/input_validator.py\n\nimport re\n\ndef sanitize_username(username: str) -> str:\n    \"\"\"\n    Sanitizes a username by allowing only alphanumeric characters and underscores.\n    \"\"\"\n    if not isinstance(username, str):\n        raise TypeError(\"Username must be a string.\")\n    \n    # Remove any characters that are not alphanumeric or underscore\n    sanitized = re.sub(r'[^a-zA-Z0-9_]', '', username)\n    return sanitized\n\ndef validate_password_strength(password: str) -> bool:\n    \"\"\"\n    Validates password strength based on a set of criteria:\n    - Minimum 8 characters\n    - At least one uppercase letter\n    - At least one lowercase letter\n    - At least one digit\n    - At least one special character\n    \"\"\"\n    if not isinstance(password, str):\n        raise TypeError(\"Password must be a string.\")\n\n    if len(password) < 8:\n        return False\n    if not re.search(r\"[A-Z]\", password):\n        return False\n    if not re.search(r\"[a-z]\", password):\n        return False\n    if not re.search(r\"\\d\", password):\n        return False\n    if not re.search(r\"[!@#$%^&*(),.?\\\":{}|<>]\", password):\n        return False\n    \n    return True\n\ndef sanitize_sql_input(text: str) -> str:\n    \"\"\"\n    Sanitizes text to prevent SQL injection.\n    This is a basic sanitization. For actual database queries, parameterized queries\n    or ORMs should always be preferred. This function is mainly for sanitizing\n    input that might eventually be part of a dynamic query (e.g., column names)\n    or used in a context where full parameterization is not possible.\n    \"\"\"\n    if not isinstance(text, str):\n        raise TypeError(\"Input for SQL sanitization must be a string.\")\n\n    # Remove or escape common SQL injection characters\n    # This is an example; a robust solution might need more context-aware escaping\n    sanitized = text.replace(\"'\", \"''\") # Escape single quotes\n    sanitized = sanitized.replace(\";\", \"\") # Remove semicolons\n    sanitized = sanitized.replace(\"--\", \"\") # Remove SQL comments\n    sanitized = sanitized.replace(\"/*\", \"\") # Remove multi-line comments\n    sanitized = sanitized.replace(\"*/\", \"\")\n    \n    # Further sanitization could involve whitelisting allowed characters\n    # For user-provided column names, you might only allow a-z, A-Z, 0-9, _\n    sanitized = re.sub(r'[^\\w\\s.-]', '', sanitized) # Allow word chars, space, dot, dash\n    \n    return sanitized\n\nif __name__ == '__main__':\n    print(\"--- Username Sanitization ---\")\n    print(f\"Original: 'user@name-123!' -> Sanitized: '{sanitize_username('user@name-123!')}'\")\n    print(f\"Original: 'valid_user_42' -> Sanitized: '{sanitize_username('valid_user_42')}'\")\n\n    print(\"\\n--- Password Strength Validation ---\")\n    print(f\"'Password123!' is strong: {validate_password_strength('Password123!')}\")\n    print(f\"'weakpass' is strong: {validate_password_strength('weakpass')}\")\n    print(f\"'NoDigit!' is strong: {validate_password_strength('NoDigit!')}\")\n    print(f\"'NoSpecial1' is strong: {validate_password_strength('NoSpecial1')}\")\n\n    print(\"\\n--- SQL Input Sanitization ---\")\n    print(f\"Original: 'DROP TABLE users;--' -> Sanitized: '{sanitize_sql_input('DROP TABLE users;--')}'\")\n    print(f\"Original: '1 OR 1=1' -> Sanitized: '{sanitize_sql_input('1 OR 1=1')}'\")\n    print(f\"Original: 'valid_column_name' -> Sanitized: '{sanitize_sql_input('valid_column_name')}'\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3376, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8aa4adf2-e005-4c87-9b9b-24671126cf86": {"__data__": {"id_": "8aa4adf2-e005-4c87-9b9b-24671126cf86", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2ec5eb91-5404-4770-a1a5-8014b7e7462e", "node_type": "1", "metadata": {}, "hash": "f75e91e3c40236076e35232021d8006d7d7aff6db793883a9397e3c6a6e4ef05", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nFerramentas para gera\u00e7\u00e3o de gr\u00e1ficos e visualiza\u00e7\u00f5es.\nIntegra\u00e7\u00e3o com Plotly para an\u00e1lise visual de dados.\n\"\"\"\n\nimport logging\nfrom typing import Dict, Any\nimport pandas as pd\nimport plotly.graph_objects as go\nfrom langchain_core.tools import tool\nfrom app.core.data_source_manager import get_data_manager\nfrom app.core.visualization.advanced_charts import AdvancedChartGenerator\n\nlogger = logging.getLogger(__name__)\n\n\ndef _get_theme_template() -> str:\n    \"\"\"Retorna o template de tema padr\u00e3o.\"\"\"\n    return \"plotly_white\"\n\n\ndef _apply_chart_customization(\n    fig: go.Figure, title: str = \"\", show_legend: bool = True\n) -> go.Figure:\n    \"\"\"\n    Aplica customiza\u00e7\u00f5es padr\u00e3o aos gr\u00e1ficos.\n\n    Args:\n        fig: Figura Plotly\n        title: T\u00edtulo do gr\u00e1fico\n        show_legend: Se mostra legenda\n\n    Returns:\n        Figura com customiza\u00e7\u00f5es aplicadas\n    \"\"\"\n    fig.update_layout(\n        template=_get_theme_template(),\n        title={\n            \"text\": title,\n            \"x\": 0.5,\n            \"xanchor\": \"center\",\n            \"font\": {\"size\": 20, \"color\": \"#1f77b4\"},\n        },\n        hovermode=\"x unified\",\n        font=dict(size=11, family=\"Arial\"),\n        margin=dict(l=50, r=50, t=80, b=50),\n        showlegend=show_legend,\n        height=500,\n        paper_bgcolor=\"rgba(240, 240, 240, 0.5)\",\n        plot_bgcolor=\"rgba(255, 255, 255, 0.9)\",\n    )\n    return fig\n\n\ndef _export_chart_to_json(fig: go.Figure) -> str:\n    \"\"\"\n    Exporta figura como JSON para Streamlit.\n\n    Args:\n        fig: Figura Plotly\n\n    Returns:\n        JSON string da figura\n    \"\"\"\n    return fig.to_json()\n\n\n@tool\ndef gerar_grafico_vendas_por_categoria(\n    limite: int = 10, ordenar_por: str = \"descendente\"\n) -> Dict[str, Any]:\n    \"\"\"\n    Gera gr\u00e1fico de barras com o total de produtos por grupo (categoria).\n    \u00datil para an\u00e1lise de categorias de produtos.\n\n    Args:\n        limite: N\u00famero m\u00e1ximo de categorias a mostrar\n        ordenar_por: \"ascendente\" ou \"descendente\"\n\n    Returns:\n        Dicion\u00e1rio com gr\u00e1fico Plotly e dados\n    \"\"\"\n    logger.info(f\"Gerando gr\u00e1fico de produtos por grupo (limite={limite})\")\n\n    try:\n        manager = get_data_manager()\n        df = manager.get_data()\n\n        if df is None or df.empty or \"GRUPO\" not in df.columns:\n            return {\n                \"status\": \"error\",\n                \"message\": \"N\u00e3o foi poss\u00edvel carregar dados de grupo ou a coluna 'GRUPO' n\u00e3o foi encontrada.\",\n            }\n\n        # Preparar dados\n        vendas_por_categoria = df[\"GRUPO\"].value_counts().reset_index()\n        vendas_por_categoria.columns = [\"grupo\", \"total\"]\n\n        if ordenar_por == \"ascendente\":\n            vendas_por_categoria = vendas_por_categoria.sort_values(\n                \"total\", ascending=True\n            )\n        else:\n            vendas_por_categoria = vendas_por_categoria.sort_values(\n                \"total\", ascending=False\n            )\n\n        df_chart = vendas_por_categoria.head(limite)\n\n        # Usar o novo gerador de gr\u00e1ficos\n        chart_generator = AdvancedChartGenerator()\n        fig = chart_generator.create_segmentation_chart(\n            df=df_chart,\n            segment_column=\"grupo\",\n            value_column=\"total\",\n            chart_type=\"donut\",\n        )\n\n        # Customiza\u00e7\u00f5es adicionais se necess\u00e1rio\n        fig.update_layout(title_text=f\"Top {limite} Grupos por Quantidade de Produtos\")\n\n        return {\n            \"status\": \"success\",\n            \"chart_type\": \"donut\",\n            \"chart_data\": _export_chart_to_json(fig),\n            \"summary\": {\n                \"total_grupos\": len(df_chart),\n                \"grupos\": df_chart.set_index(\"grupo\")[\"total\"].to_dict(),\n                \"total_itens\": int(df_chart[\"total\"].sum()),\n            },\n        }\n    except Exception as e:\n        logger.error(f\"Erro ao gerar gr\u00e1fico de vendas: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar gr\u00e1fico: {str(e)}\"}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3942, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2ec5eb91-5404-4770-a1a5-8014b7e7462e": {"__data__": {"id_": "2ec5eb91-5404-4770-a1a5-8014b7e7462e", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8aa4adf2-e005-4c87-9b9b-24671126cf86", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "9dc0b3019764baf2f0b686696e88bdb4bfb247c02b2c999174c1841f383293b5", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "aee77904-2308-4c50-aee7-3e5f34733775", "node_type": "1", "metadata": {}, "hash": "15492a1af57f0abe55ebfaa59123682ccbb3d2b25cf8a1be48aae5bdac7a6910", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef gerar_grafico_estoque_por_produto(\n    limite: int = 15, minimo_estoque: int = 0\n) -> Dict[str, Any]:\n    \"\"\"\n    Gera gr\u00e1fico de estoque dispon\u00edvel por produto.\n    Mostra produtos com mais estoque em destaque.\n\n    Args:\n        limite: N\u00famero m\u00e1ximo de produtos a mostrar\n        minimo_estoque: Estoque m\u00ednimo para incluir\n\n    Returns:\n        Dicion\u00e1rio com gr\u00e1fico e dados de estoque\n    \"\"\"\n    logger.info(f\"Gerando gr\u00e1fico de estoque por produto (limite={limite})\")\n\n    try:\n        manager = get_data_manager()\n        df = manager.get_data()\n\n        if df is None or df.empty:\n            return {\"status\": \"error\", \"message\": \"N\u00e3o foi poss\u00edvel carregar dados\"}\n\n        # As colunas de estoque e nome s\u00e3o 'QTD' e 'DESCRI\u00c7\u00c3O'\n        estoque_col = 'QTD'\n        nome_col = 'DESCRI\u00c7\u00c3O'\n\n        if not estoque_col in df.columns or not nome_col in df.columns:\n            return {\n                \"status\": \"error\",\n                \"message\": \"Colunas 'QTD' e/ou 'DESCRI\u00c7\u00c3O' n\u00e3o encontradas\",\n            }\n\n        # Preparar dados\n        df_estoque = df[[nome_col, estoque_col]].copy()\n        df_estoque[estoque_col] = pd.to_numeric(df_estoque[estoque_col], errors='coerce').fillna(0)\n        df_estoque = df_estoque[df_estoque[estoque_col] >= minimo_estoque]\n        df_estoque = df_estoque.sort_values(estoque_col, ascending=False).head(limite)\n\n        # Criar gr\u00e1fico\n        fig = go.Figure(\n            data=[\n                go.Bar(\n                    x=df_estoque[nome_col],\n                    y=df_estoque[estoque_col],\n                    marker=dict(\n                        color=df_estoque[estoque_col],\n                        colorscale=\"RdYlGn\",\n                        showscale=True,\n                        colorbar=dict(title=\"Estoque\"),\n                    ),\n                    hovertemplate=\"<b>%{x}</b><br>Estoque: %{y}<extra></extra>\",\n                    text=df_estoque[estoque_col],\n                    textposition='auto',\n                    texttemplate='%{text:.2s}'\n                )\n            ]\n        )\n\n        fig.update_layout(\n            xaxis_tickangle=-45,\n            height=600,\n        )\n\n        fig = _apply_chart_customization(\n            fig, title=f\"Estoque Dispon\u00edvel por Produto (Top {limite})\"\n        )\n\n        fig.update_xaxes(title_text=\"Produto\")\n        fig.update_yaxes(title_text=\"Quantidade em Estoque\")\n\n        return {\n            \"status\": \"success\",\n            \"chart_type\": \"bar_vertical\",\n            \"chart_data\": _export_chart_to_json(fig),\n            \"summary\": {\n                \"total_produtos\": len(df_estoque),\n                \"estoque_total\": int(df_estoque[estoque_col].sum()),\n                \"estoque_medio\": float(df_estoque[estoque_col].mean()),\n                \"estoque_maximo\": int(df_estoque[estoque_col].max()),\n            },\n        }\n    except Exception as e:\n        logger.error(f\"Erro ao gerar gr\u00e1fico de estoque: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar gr\u00e1fico: {str(e)}\"}", "mimetype": "text/plain", "start_char_idx": 3945, "end_char_idx": 6989, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "aee77904-2308-4c50-aee7-3e5f34733775": {"__data__": {"id_": "aee77904-2308-4c50-aee7-3e5f34733775", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2ec5eb91-5404-4770-a1a5-8014b7e7462e", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "b323155a69748d42e5e9bd2c9907fcaeab8588af93f56ad7d3044a81c405c76d", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "78492376-95e6-48a0-9ef1-fccf05210c39", "node_type": "1", "metadata": {}, "hash": "859b51c378dd07bf3fff26546aaf89b4b6dabc1210a80f3eba7fb2d3c6563882", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef gerar_comparacao_precos_categorias() -> Dict[str, Any]:\n    \"\"\"\n    Gera gr\u00e1fico de compara\u00e7\u00e3o de pre\u00e7os m\u00e9dios por grupo (categoria).\n    \u00datil para an\u00e1lise de precifica\u00e7\u00e3o.\n\n    Returns:\n        Dicion\u00e1rio com gr\u00e1fico comparativo de pre\u00e7os\n    \"\"\"\n    logger.info(\"Gerando gr\u00e1fico de compara\u00e7\u00e3o de pre\u00e7os por grupo\")\n\n    try:\n        manager = get_data_manager()\n        df = manager.get_data()\n\n        if df is None or df.empty:\n            return {\"status\": \"error\", \"message\": \"N\u00e3o foi poss\u00edvel carregar dados\"}\n\n        # As colunas de categoria e pre\u00e7o s\u00e3o 'GRUPO' e 'VENDA UNIT R$'\n        categoria_col = 'GRUPO'\n        preco_col = 'VENDA UNIT R$'\n\n        if not categoria_col in df.columns or not preco_col in df.columns:\n            return {\n                \"status\": \"error\",\n                \"message\": \"Colunas 'GRUPO' e/ou 'VENDA UNIT R$' n\u00e3o encontradas\",\n            }\n\n        # Calcular pre\u00e7o m\u00e9dio por categoria\n        df[preco_col] = pd.to_numeric(df[preco_col], errors='coerce')\n        df = df.dropna(subset=[preco_col])\n        \n        preco_medio = (\n            df.groupby(categoria_col)[preco_col]\n            .agg([\"mean\", \"min\", \"max\", \"count\"])\n            .reset_index()\n        )\n        preco_medio = preco_medio.sort_values(\"mean\", ascending=False)\n\n        # Criar gr\u00e1fico com m\u00faltiplas s\u00e9ries\n        fig = go.Figure()\n\n        fig.add_trace(\n            go.Bar(\n                x=preco_medio[categoria_col],\n                y=preco_medio[\"mean\"],\n                name=\"Pre\u00e7o M\u00e9dio\",\n                marker_color=\"lightblue\",\n            )\n        )\n\n        fig.add_trace(\n            go.Scatter(\n                x=preco_medio[categoria_col],\n                y=preco_medio[\"max\"],\n                mode=\"markers+lines\",\n                name=\"Pre\u00e7o M\u00e1ximo\",\n                line=dict(dash=\"dash\", color=\"red\"),\n                marker=dict(size=8),\n            )\n        )\n\n        fig = _apply_chart_customization(\n            fig, title=\"Compara\u00e7\u00e3o de Pre\u00e7os por Grupo\", show_legend=True\n        )\n\n        fig.update_xaxes(title_text=\"Grupo\")\n        fig.update_yaxes(title_text=\"Pre\u00e7o (R$)\")\n        fig.update_layout(xaxis_tickangle=-45, height=500)\n\n        return {\n            \"status\": \"success\",\n            \"chart_type\": \"bar_line_combo\",\n            \"chart_data\": _export_chart_to_json(fig),\n            \"summary\": {\n                \"grupos\": len(preco_medio),\n                \"preco_medio_geral\": float(df[preco_col].mean()),\n                \"preco_maximo\": float(preco_medio[\"max\"].max()),\n                \"preco_minimo\": float(preco_medio[\"min\"].min()),\n                \"grupos_data\": preco_medio.to_dict(\"records\"),\n            },\n        }\n    except Exception as e:\n        logger.error(f\"Erro ao gerar gr\u00e1fico de compara\u00e7\u00e3o: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar gr\u00e1fico: {str(e)}\"}", "mimetype": "text/plain", "start_char_idx": 6992, "end_char_idx": 9886, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "78492376-95e6-48a0-9ef1-fccf05210c39": {"__data__": {"id_": "78492376-95e6-48a0-9ef1-fccf05210c39", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "aee77904-2308-4c50-aee7-3e5f34733775", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "4d0e56acd15a51813127ba5878e6627df0941cf6caf774ba9354c3ede742e51b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "9904175a-c176-4865-b351-0937385ff585", "node_type": "1", "metadata": {}, "hash": "d681083f5246a422fad2ec10b2dbe55831cb0d204de8ffdd0a3693e05583ffaf", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef gerar_analise_distribuicao_estoque() -> Dict[str, Any]:\n    \"\"\"\n    Gera histograma e box plot da distribui\u00e7\u00e3o de estoque.\n    \u00datil para an\u00e1lise estat\u00edstica de n\u00edveis de estoque.\n\n    Returns:\n        Dicion\u00e1rio com gr\u00e1ficos de distribui\u00e7\u00e3o\n    \"\"\"\n    logger.info(\"Gerando an\u00e1lise de distribui\u00e7\u00e3o de estoque\")\n\n    try:\n        manager = get_data_manager()\n        df = manager.get_data()\n\n        if df is None or df.empty:\n            return {\"status\": \"error\", \"message\": \"N\u00e3o foi poss\u00edvel carregar dados\"}\n\n        # A coluna de estoque \u00e9 'QTD'\n        estoque_col = 'QTD'\n\n        if not estoque_col in df.columns:\n            return {\"status\": \"error\", \"message\": \"Coluna 'QTD' n\u00e3o encontrada\"}\n\n        # Converter para num\u00e9rico\n        df[estoque_col] = pd.to_numeric(df[estoque_col], errors=\"coerce\")\n        df = df.dropna(subset=[estoque_col])\n\n        # Criar subplots\n        from plotly.subplots import make_subplots\n\n        fig = make_subplots(\n            rows=1,\n            cols=2,\n            subplot_titles=(\"Distribui\u00e7\u00e3o de Estoque\", \"Box Plot\"),\n            specs=[[{\"secondary_y\": False}, {\"secondary_y\": False}]],\n        )\n\n        # Histograma\n        fig.add_trace(\n            go.Histogram(\n                x=df[estoque_col],\n                nbinsx=30,\n                name=\"Estoque\",\n                marker_color=\"rgba(31, 119, 180, 0.7)\",\n                hovertemplate=\"Faixa: %{x}<br>Frequ\u00eancia: %{y}<extra></extra>\",\n            ),\n            row=1,\n            col=1,\n        )\n\n        # Box plot\n        fig.add_trace(\n            go.Box(\n                y=df[estoque_col],\n                name=\"Estoque\",\n                marker_color=\"rgba(31, 119, 180, 0.7)\",\n                boxmean=\"sd\",\n            ),\n            row=1,\n            col=2,\n        )\n\n        fig.update_xaxes(title_text=\"N\u00edvel de Estoque\", row=1, col=1)\n        fig.update_yaxes(title_text=\"Frequ\u00eancia\", row=1, col=1)\n        fig.update_yaxes(title_text=\"Quantidade\", row=1, col=2)\n\n        fig = _apply_chart_customization(\n            fig, title=\"An\u00e1lise de Distribui\u00e7\u00e3o de Estoque\"\n        )\n\n        # Calcular estat\u00edsticas\n        stats = {\n            \"media\": float(df[estoque_col].mean()),\n            \"mediana\": float(df[estoque_col].median()),\n            \"desvio_padrao\": float(df[estoque_col].std()),\n            \"minimo\": float(df[estoque_col].min()),\n            \"maximo\": float(df[estoque_col].max()),\n            \"q1\": float(df[estoque_col].quantile(0.25)),\n            \"q3\": float(df[estoque_col].quantile(0.75)),\n        }\n\n        return {\n            \"status\": \"success\",\n            \"chart_type\": \"distribution\",\n            \"chart_data\": _export_chart_to_json(fig),\n            \"summary\": stats,\n        }\n    except Exception as e:\n        logger.error(f\"Erro ao gerar an\u00e1lise de distribui\u00e7\u00e3o: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar gr\u00e1fico: {str(e)}\"}", "mimetype": "text/plain", "start_char_idx": 9889, "end_char_idx": 12828, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9904175a-c176-4865-b351-0937385ff585": {"__data__": {"id_": "9904175a-c176-4865-b351-0937385ff585", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "78492376-95e6-48a0-9ef1-fccf05210c39", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "a678ccecc63b9653a6e9e5fcacb829aa87ff7b1caa1e08bf35d407a8e4d21bc7", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c9288313-8d43-4391-b88d-d0da6936e659", "node_type": "1", "metadata": {}, "hash": "7a16d0268dc9953cc9f191e31b540699e86bf43497cb982ee84a627edc3ce27e", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef gerar_grafico_pizza_categorias() -> Dict[str, Any]:\n    \"\"\"\n    Gera gr\u00e1fico de pizza mostrando propor\u00e7\u00e3o de produtos por grupo (categoria).\n    \u00datil para visualizar distribui\u00e7\u00e3o percentual.\n\n    Returns:\n        Dicion\u00e1rio com gr\u00e1fico de pizza e propor\u00e7\u00f5es\n    \"\"\"\n    logger.info(\"Gerando gr\u00e1fico de pizza por grupo\")\n\n    try:\n        manager = get_data_manager()\n        df = manager.get_data()\n\n        if df is None or df.empty:\n            return {\"status\": \"error\", \"message\": \"N\u00e3o foi poss\u00edvel carregar dados\"}\n\n        # A coluna de categoria \u00e9 'GRUPO'\n        categoria_col = 'GRUPO'\n\n        if not categoria_col in df.columns:\n            return {\"status\": \"error\", \"message\": \"Coluna 'GRUPO' n\u00e3o encontrada\"}\n\n        # Contar por categoria\n        categorias = df[categoria_col].value_counts()\n\n        # Criar gr\u00e1fico\n        fig = go.Figure(\n            data=[\n                go.Pie(\n                    labels=categorias.index,\n                    values=categorias.values,\n                    hovertemplate=\"<b>%{label}</b><br>Quantidade: %{value}<br>Percentual: %{percent}<extra></extra>\",\n                )\n            ]\n        )\n\n        fig = _apply_chart_customization(\n            fig, title=\"Distribui\u00e7\u00e3o de Produtos por Grupo\"\n        )\n\n        fig.update_layout(height=600)\n\n        return {\n            \"status\": \"success\",\n            \"chart_type\": \"pie\",\n            \"chart_data\": _export_chart_to_json(fig),\n            \"summary\": {\n                \"total_categorias\": len(categorias),\n                \"total_produtos\": int(categorias.sum()),\n                \"categorias\": categorias.to_dict(),\n            },\n        }\n    except Exception as e:\n        logger.error(f\"Erro ao gerar gr\u00e1fico de pizza: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar gr\u00e1fico: {str(e)}\"}\n\n\n@tool\ndef gerar_dashboard_analise_completa() -> Dict[str, Any]:\n    \"\"\"\n    Gera dashboard completo com m\u00faltiplas visualiza\u00e7\u00f5es em um \u00fanico lugar.\n    Combina 4 gr\u00e1ficos em um layout 2x2.\n\n    Returns:\n        Dicion\u00e1rio com dashboard e m\u00faltiplos gr\u00e1ficos\n    \"\"\"\n    logger.info(\"Gerando dashboard completo\")\n\n    try:\n        manager = get_data_manager()\n        df = manager.get_data()\n\n        if df is None or df.empty:\n            return {\"status\": \"error\", \"message\": \"N\u00e3o foi poss\u00edvel carregar dados\"}\n\n        from plotly.subplots import make_subplots\n\n        # Encontrar colunas\n        categoria_col = 'GRUPO'\n        estoque_col = 'QTD'\n        preco_col = 'VENDA UNIT R$'\n        nome_col = 'DESCRI\u00c7\u00c3O'", "mimetype": "text/plain", "start_char_idx": 12831, "end_char_idx": 15399, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c9288313-8d43-4391-b88d-d0da6936e659": {"__data__": {"id_": "c9288313-8d43-4391-b88d-d0da6936e659", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "9904175a-c176-4865-b351-0937385ff585", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "a44b24bea473c756f63f8b1f50d86cb02062861013048a1d251b9706503677fe", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "665147ae-3561-4525-8f05-9b663d6ab100", "node_type": "1", "metadata": {}, "hash": "98bd340a507ad966e043f80f1c6503a3117da8e118a6a8b393e95ecb8a4ec4ff", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef gerar_dashboard_analise_completa() -> Dict[str, Any]:\n    \"\"\"\n    Gera dashboard completo com m\u00faltiplas visualiza\u00e7\u00f5es em um \u00fanico lugar.\n    Combina 4 gr\u00e1ficos em um layout 2x2.\n\n    Returns:\n        Dicion\u00e1rio com dashboard e m\u00faltiplos gr\u00e1ficos\n    \"\"\"\n    logger.info(\"Gerando dashboard completo\")\n\n    try:\n        manager = get_data_manager()\n        df = manager.get_data()\n\n        if df is None or df.empty:\n            return {\"status\": \"error\", \"message\": \"N\u00e3o foi poss\u00edvel carregar dados\"}\n\n        from plotly.subplots import make_subplots\n\n        # Encontrar colunas\n        categoria_col = 'GRUPO'\n        estoque_col = 'QTD'\n        preco_col = 'VENDA UNIT R$'\n        nome_col = 'DESCRI\u00c7\u00c3O'\n\n\n        if not all([categoria_col in df.columns, estoque_col in df.columns, preco_col in df.columns, nome_col in df.columns]):\n            return {\"status\": \"error\", \"message\": \"Colunas necess\u00e1rias n\u00e3o encontradas\"}\n\n        # Preparar dados\n        df_conv = df.copy()\n        df_conv[estoque_col] = pd.to_numeric(df_conv[estoque_col], errors=\"coerce\")\n        df_conv[preco_col] = pd.to_numeric(df_conv[preco_col], errors=\"coerce\")\n\n        # Criar subplots 2x2\n        fig = make_subplots(\n            rows=2,\n            cols=2,\n            subplot_titles=(\n                \"Produtos por Grupo\",\n                \"Top 10 Produtos - Estoque\",\n                \"Distribui\u00e7\u00e3o de Estoque\",\n                \"Pre\u00e7o M\u00e9dio por Grupo\",\n            ),\n            specs=[\n                [{\"type\": \"pie\"}, {\"type\": \"bar\"}],\n                [{\"type\": \"histogram\"}, {\"type\": \"bar\"}],\n            ],\n        )\n\n        # Gr\u00e1fico 1: Pizza\n        cat_counts = df_conv[categoria_col].value_counts()\n        fig.add_trace(\n            go.Pie(\n                labels=cat_counts.index, values=cat_counts.values, name=\"Grupos\"\n            ),\n            row=1,\n            col=1,\n        )\n\n        # Gr\u00e1fico 2: Top 10 Estoque\n        top_estoque = df_conv.nlargest(10, estoque_col)\n        fig.add_trace(\n            go.Bar(\n                x=top_estoque[nome_col],\n                y=top_estoque[estoque_col],\n                name=\"Estoque\",\n                marker_color=\"lightblue\",\n            ),\n            row=1,\n            col=2,\n        )\n\n        # Gr\u00e1fico 3: Histograma\n        fig.add_trace(\n            go.Histogram(\n                x=df_conv[estoque_col],\n                nbinsx=20,\n                name=\"Distribui\u00e7\u00e3o\",\n                marker_color=\"lightgreen\",\n            ),\n            row=2,\n            col=1,\n        )\n\n        # Gr\u00e1fico 4: Pre\u00e7o m\u00e9dio\n        preco_med = (\n            df_conv.groupby(categoria_col)[preco_col]\n            .mean()\n            .sort_values(ascending=False)\n        )\n        fig.add_trace(\n            go.Bar(\n                x=preco_med.index,\n                y=preco_med.values,\n                name=\"Pre\u00e7o M\u00e9dio\",\n                marker_color=\"lightyellow\",\n            ),\n            row=2,\n            col=2,\n        )\n\n        # Atualizar layout\n        fig.update_layout(\n            title_text=\"Dashboard de An\u00e1lise - Vis\u00e3o Geral\",\n            height=900,\n            showlegend=False,\n            template=_get_theme_template(),\n        )\n\n        fig.update_xaxes(title_text=\"Produto\", row=1, col=2)\n        fig.update_xaxes(title_text=\"Estoque\", row=2, col=1)\n        fig.update_yaxes(title_text=\"Quantidade\", row=1, col=2)\n        fig.update_yaxes(title_text=\"Frequ\u00eancia\", row=2, col=1)\n        fig.update_xaxes(title_text=\"Grupo\", row=2, col=2)\n        fig.update_yaxes(title_text=\"Pre\u00e7o M\u00e9dio (R$)\", row=2, col=2)", "mimetype": "text/plain", "start_char_idx": 14683, "end_char_idx": 18267, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "665147ae-3561-4525-8f05-9b663d6ab100": {"__data__": {"id_": "665147ae-3561-4525-8f05-9b663d6ab100", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c9288313-8d43-4391-b88d-d0da6936e659", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "4cc6b076cc0c4eca50e6fa65c2a1e128519f8523735e8f403a2917d52b28a438", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "14828b4d-172b-41f4-a157-edf69c5aa1f4", "node_type": "1", "metadata": {}, "hash": "73d9288716fbcf5d737ffe3c036311ccbfc96c7a87b07050f8c2c80e07db9d0a", "class_name": "RelatedNodeInfo"}}, "text": "return {\n            \"status\": \"success\",\n            \"chart_type\": \"dashboard\",\n            \"chart_data\": _export_chart_to_json(fig),\n            \"summary\": {\n                \"total_produtos\": len(df_conv),\n                \"total_categorias\": df_conv[categoria_col].nunique(),\n                \"estoque_total\": float(df_conv[estoque_col].sum()),\n                \"estoque_medio\": float(df_conv[estoque_col].mean()),\n            },\n        }\n    except Exception as e:\n        logger.error(f\"Erro ao gerar dashboard: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar dashboard: {str(e)}\"}\n\n\n@tool\ndef gerar_grafico_vendas_por_produto(\n    codigo_produto: int,\n) -> Dict[str, Any]:\n    \"\"\"\n    Gera gr\u00e1fico de s\u00e9rie temporal de vendas de um produto espec\u00edfico.\n    Este \u00e9 um alias para gerar_grafico_vendas_mensais_produto.\n\n    Args:\n        codigo_produto: C\u00f3digo do produto (ITEM)\n\n    Returns:\n        Dicion\u00e1rio com gr\u00e1fico de s\u00e9rie temporal e an\u00e1lise\n    \"\"\"\n    logger.info(\n        f\"Gerando gr\u00e1fico de vendas do produto {codigo_produto} (alias)\"\n    )\n    return gerar_grafico_vendas_mensais_produto(codigo_produto=codigo_produto)\n\n\n@tool\ndef gerar_grafico_automatico(descricao: str) -> Dict[str, Any]:\n    \"\"\"\n    Gera qualquer tipo de gr\u00e1fico baseado na descri\u00e7\u00e3o do usu\u00e1rio.\n    O LLM interpreta a descri\u00e7\u00e3o e seleciona o gr\u00e1fico mais apropriado.", "mimetype": "text/plain", "start_char_idx": 18278, "end_char_idx": 19666, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "14828b4d-172b-41f4-a157-edf69c5aa1f4": {"__data__": {"id_": "14828b4d-172b-41f4-a157-edf69c5aa1f4", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "665147ae-3561-4525-8f05-9b663d6ab100", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "ce4d764376e109242007f1a7c623595ebf695934515ba892886681ab9001ccc3", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f5d7a17d-317a-48d2-9811-d34ac0e3cbcd", "node_type": "1", "metadata": {}, "hash": "534b0e95629bb7e89c1e3d39a5ebc2f5e67e5b9cf2e7370e714691aab746a114", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef gerar_grafico_automatico(descricao: str) -> Dict[str, Any]:\n    \"\"\"\n    Gera qualquer tipo de gr\u00e1fico baseado na descri\u00e7\u00e3o do usu\u00e1rio.\n    O LLM interpreta a descri\u00e7\u00e3o e seleciona o gr\u00e1fico mais apropriado.\n\n    Args:\n        descricao: Descri\u00e7\u00e3o do gr\u00e1fico desejado em linguagem natural\n\n    Returns:\n        Gr\u00e1fico Plotly JSON correspondente ao tipo solicitado\n\n    Exemplos de uso:\n      - \"gr\u00e1fico de vendas por categoria\"\n      - \"mostrar estoque dispon\u00edvel por produto\"\n      - \"an\u00e1lise de distribui\u00e7\u00e3o de estoque\"\n      - \"comparar pre\u00e7os entre categorias\"\n      - \"vendas do produto 59294\"\n      - \"dashboard completo\"\n    \"\"\"\n    logger.info(f\"Gerando gr\u00e1fico autom\u00e1tico: {descricao}\")\n\n    descricao_lower = descricao.lower()\n\n    # Detectar tipo de gr\u00e1fico pela descri\u00e7\u00e3o\n    if any(\n        word in descricao_lower\n        for word in [\n            \"vendas\",\n            \"venda\",\n            \"sales\",\n            \"categoria\",\n            \"categor\",\n            \"top\",\n            \"ranking\",\n        ]\n    ):\n        logger.info(\"Detectado: Gr\u00e1fico de vendas por categoria\")\n        return gerar_grafico_vendas_por_categoria.invoke(\n            {\"limite\": 10, \"ordenar_por\": \"descendente\"}\n        )\n\n    elif any(\n        word in descricao_lower\n        for word in [\n            \"estoque\",\n            \"stock\",\n            \"dispon\u00edvel\",\n            \"quantidade\",\n            \"quantidade\",\n            \"inv\",\n            \"por produto\",\n        ]\n    ):\n        logger.info(\"Detectado: Gr\u00e1fico de estoque por produto\")\n        return gerar_grafico_estoque_por_produto.invoke(\n            {\"limite\": 15, \"minimo_estoque\": 0}\n        )\n\n    elif any(\n        word in descricao_lower\n        for word in [\n            \"pre\u00e7o\",\n            \"preco\",\n            \"price\",\n            \"pre\u00e7os\",\n            \"compara\u00e7\u00e3o\",\n            \"comparar\",\n            \"pricing\",\n        ]\n    ):\n        logger.info(\"Detectado: Gr\u00e1fico de compara\u00e7\u00e3o de pre\u00e7os\")\n        return gerar_comparacao_precos_categorias.invoke({})\n\n    elif any(\n        word in descricao_lower\n        for word in [\n            \"distribui\u00e7\u00e3o\",\n            \"distribuicao\",\n            \"distribui\u00e7\u00e3o\",\n            \"an\u00e1lise\",\n            \"analise\",\n            \"histograma\",\n            \"box plot\",\n        ]\n    ):\n        logger.info(\"Detectado: An\u00e1lise de distribui\u00e7\u00e3o\")\n        return gerar_analise_distribuicao_estoque.invoke({})\n\n    elif any(\n        word in descricao_lower\n        for word in [\"pizza\", \"pie\", \"propor\", \"percent\", \"propor\u00e7\u00e3o\"]\n    ):\n        logger.info(\"Detectado: Gr\u00e1fico de pizza\")\n        return gerar_grafico_pizza_categorias.invoke({})\n\n    elif any(\n        word in descricao_lower\n        for word in [\n            \"dashboard\",\n            \"tudo\",\n            \"vis\u00e3o\",\n            \"visao\",\n            \"completo\",\n            \"overview\",\n            \"resumo\",\n        ]\n    ):\n        logger.info(\"Detectado: Dashboard completo\")\n        return gerar_dashboard_analise_completa.invoke({})\n\n    elif any(\n        word in descricao_lower\n        for word in [\n            \"produto\",\n            \"temporal\",\n            \"s\u00e9rie\",\n            \"serie\",\n            \"evolu\u00e7\u00e3o\",\n            \"evolucao\",\n            \"sku\",\n            \"mensal\",\n            \"m\u00eas\",\n            \"mes\",\n            \"vendas produto\",\n        ]\n    ):\n        logger.info(\"Detectado: Gr\u00e1fico de vendas por produto\")\n        # Extrair c\u00f3digo do produto se presente\n        import re\n\n        match = re.search(r\"\\d+\", descricao)\n        codigo = int(match.group()) if match else 59294\n\n        # Tentar usar a vers\u00e3o com dados mensais pivotados (estrutura real)\n        resultado = gerar_grafico_vendas_mensais_produto.invoke(\n            {\"codigo_produto\": codigo, \"unidade_filtro\": None}\n        )\n\n        # Se falhar, retornar gr\u00e1fico de s\u00e9rie temporal alternativo\n        if resultado.get(\"status\") == \"error\":\n            logger.info(\"Gr\u00e1fico mensal falhou, tentando s\u00e9rie temporal\")\n            return gerar_grafico_vendas_por_produto.invoke(\n                {\"codigo_produto\": codigo, \"unidade\": \"SCR\"}\n            )\n\n        return resultado\n\n    else:\n        # Por padr\u00e3o, gera dashboard completo\n        logger.info(\"Tipo n\u00e3o reconhecido, gerando dashboard padr\u00e3o\")\n        return gerar_dashboard_analise_completa.invoke({})", "mimetype": "text/plain", "start_char_idx": 19450, "end_char_idx": 23765, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f5d7a17d-317a-48d2-9811-d34ac0e3cbcd": {"__data__": {"id_": "f5d7a17d-317a-48d2-9811-d34ac0e3cbcd", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "14828b4d-172b-41f4-a157-edf69c5aa1f4", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "af97d4b37714cca975438d71209f9b6e1c0098e8c658ed9bbbb332669d91486d", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "14329a39-a8ce-4e09-b601-1a030712231c", "node_type": "1", "metadata": {}, "hash": "ce729f57463bdc740fe7638a92e84affa5d0d9dcf725041eab57764154def3ed", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef gerar_grafico_vendas_mensais_produto(\n    codigo_produto: int,\n) -> Dict[str, Any]:\n    \"\"\"\n    Gera gr\u00e1fico de vendas mensais para um produto espec\u00edfico.\n    Trabalha com a estrutura de dados da Filial Madureira.\n\n    Args:\n        codigo_produto: C\u00f3digo do produto (ITEM)\n\n    Returns:\n        Dicion\u00e1rio com gr\u00e1fico de vendas mensais\n    \"\"\"\n    logger.info(f\"Gerando gr\u00e1fico de vendas mensais do produto {codigo_produto}\")\n\n    try:\n        manager = get_data_manager()\n        df_raw = manager.get_data()\n\n        if df_raw is None or df_raw.empty:\n            return {\"status\": \"error\", \"message\": \"N\u00e3o foi poss\u00edvel carregar dados\"}\n\n        # A coluna de c\u00f3digo do produto \u00e9 'PRODUTO' (conforme schema do admmat.parquet)\n        codigo_col = 'PRODUTO'\n        \n        # Converter a coluna 'PRODUTO' para num\u00e9rico para garantir a compara\u00e7\u00e3o\n        df_raw[codigo_col] = pd.to_numeric(df_raw[codigo_col], errors='coerce')\n        \n        # Filtrar por c\u00f3digo de produto\n        df_produto = df_raw[df_raw[codigo_col] == codigo_produto].copy()\n\n        if df_produto.empty:\n            return {\n                \"status\": \"error\",\n                \"message\": (\n                    f\"Produto com c\u00f3digo {codigo_produto} n\u00e3o encontrado. \"\n                    \"Verifique o c\u00f3digo informado.\"\n                ),\n            }\n\n        # Extrair colunas de meses\n        mes_cols = {\n            'JAN': 'VENDA QTD JAN', 'FEV': 'VENDA QTD FEV', 'MAR': 'VENDA QTD MAR',\n            'ABR': 'VENDA QTD ABR', 'MAI': 'VENDA QTD MAI', 'JUN': 'VENDA QTD JUN',\n            'JUL': 'VENDA QTD JUL', 'AGO': 'VENDA QTD AGO', 'SET': 'VENDA QTD SET',\n            'OUT': 'VENDA QTD OUT', 'NOV': 'VENDA QTD NOV', 'DEZ': 'VENDA QTD DEZ'\n        }\n        \n        vendas_mensais = []\n        mes_labels = []\n        \n        for mes_abrev, col_name in mes_cols.items():\n            if col_name in df_produto.columns:\n                valor_bruto = df_produto[col_name].iloc[0]\n                valor_numerico = pd.to_numeric(valor_bruto, errors='coerce')\n                valor = 0 if pd.isna(valor_numerico) else valor_numerico\n                vendas_mensais.append(valor)\n                mes_labels.append(mes_abrev)\n\n        if not vendas_mensais:\n            return {\n                \"status\": \"error\",\n                \"message\": \"Colunas de vendas mensais n\u00e3o encontradas na estrutura de dados.", "mimetype": "text/plain", "start_char_idx": 23768, "end_char_idx": 26155, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "14329a39-a8ce-4e09-b601-1a030712231c": {"__data__": {"id_": "14329a39-a8ce-4e09-b601-1a030712231c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "f5d7a17d-317a-48d2-9811-d34ac0e3cbcd", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "6fefe6996fd8d605304931121aafbebbeb50a669e735fffcefcdb288476d79ec", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "baaf14ac-e422-4f6d-9b74-784c9de83cd9", "node_type": "1", "metadata": {}, "hash": "baeadec74b7deb84fdabf6789dc5d4c972f825b982d6e8efd33cf7dd026945e6", "class_name": "RelatedNodeInfo"}}, "text": "\",\n            }\n\n        # Criar gr\u00e1fico\n        fig = go.Figure()\n\n        fig.add_trace(\n            go.Scatter(\n                x=mes_labels,\n                y=vendas_mensais,\n                mode=\"lines+markers+text\", # Adicionar 'text' ao modo\n                name=\"Vendas\",\n                line=dict(color=\"#2563EB\", width=3),\n                marker=dict(\n                    size=10,\n                    color=\"#2563EB\",\n                    line=dict(width=2, color=\"white\"),\n                    symbol=\"circle\",\n                ),\n                hovertemplate=(\n                    \"<b>M\u00eas: %{x}</b><br>\" \"Quantidade: %{y:,.0f} unidades<extra></extra>\"\n                ),\n                fill=\"tozeroy\",\n                fillcolor=\"rgba(37, 99, 235, 0.2)\",\n                text=vendas_mensais,\n                textposition=\"top center\"\n            )\n        )\n\n        # Adicionar linha de m\u00e9dia\n        if vendas_mensais:\n            media_vendas = sum(vendas_mensais) / len(vendas_mensais)\n            fig.add_hline(\n                y=media_vendas,\n                line_dash=\"dash\",\n                line_color=\"red\",\n                annotation_text=\"M\u00e9dia\",\n                annotation_position=\"right\",\n            )\n\n        fig = _apply_chart_customization(\n            fig, title=(f\"Vendas Mensais - Produto {codigo_produto}\")\n        )\n\n        fig.update_xaxes(title_text=\"M\u00eas\")\n        fig.update_yaxes(title_text=\"Quantidade (unidades)\")\n        fig.update_layout(height=600, hovermode=\"x unified\")\n\n        # Calcular estat\u00edsticas\n        total_vendas = sum(vendas_mensais)\n        venda_media = total_vendas / len(vendas_mensais) if vendas_mensais else 0\n        venda_max = max(vendas_mensais) if vendas_mensais else 0\n        venda_min = min(vendas_mensais) if vendas_mensais else 0\n        venda_max_mes = mes_labels[vendas_mensais.index(venda_max)] if vendas_mensais and venda_max > 0 else \"N/A\"\n        venda_min_mes = mes_labels[vendas_mensais.index(venda_min)] if vendas_mensais else \"N/A\"\n\n        # Extrair informa\u00e7\u00f5es adicionais do produto\n        produto_info = {}\n        for col in [\"DESCRI\u00c7\u00c3O\", \"FABRICANTE\", \"GRUPO\"]:\n            if col in df_produto.columns:\n                valor = df_produto[col].iloc[0]\n                produto_info[col] = str(valor)\n\n        return {\n            \"status\": \"success\",\n            \"chart_type\": \"line_temporal_mensal\",\n            \"chart_data\": _export_chart_to_json(fig),\n            \"summary\": {\n                \"codigo_produto\": codigo_produto,\n                \"total_vendas\": int(total_vendas),\n                \"venda_media\": float(venda_media),\n                \"venda_maxima\": int(venda_max),\n                \"venda_minima\": int(venda_min),\n                \"mes_maior_venda\": venda_max_mes,\n                \"mes_menor_venda\": venda_min_mes,\n                \"variacao\": float(\n                    (venda_max - venda_min) / venda_media * 100\n                    if venda_media > 0\n                    else 0\n                ),\n                \"meses_analisados\": len(mes_labels),\n                \"produto_info\": produto_info,\n                \"dados_mensais\": {\n                    mes_labels[i]: int(vendas_mensais[i])\n                    for i in range(len(mes_labels))\n                },\n            },\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro ao gerar gr\u00e1fico de vendas mensais: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar gr\u00e1fico: {str(e)}\"}\n\n\n@tool\ndef gerar_grafico_vendas_por_grupo(\n    nome_grupo: str, agregacao: str = \"soma\"\n) -> Dict[str, Any]:\n    \"\"\"\n    Gera gr\u00e1fico de vendas mensais para todos os produtos de um grupo espec\u00edfico.\n    \u00datil para an\u00e1lise de desempenho de categorias de produtos ao longo do ano.\n\n    Args:\n        nome_grupo: Nome do grupo/categoria (ex: \"ESMALTES\", \"CREMES\", etc.)", "mimetype": "text/plain", "start_char_idx": 26155, "end_char_idx": 30006, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "baaf14ac-e422-4f6d-9b74-784c9de83cd9": {"__data__": {"id_": "baaf14ac-e422-4f6d-9b74-784c9de83cd9", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "14329a39-a8ce-4e09-b601-1a030712231c", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "e0aff4b2af9d548507d73b596804d53288ba3f4b7a3538151d5cb1b02cfb4551", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "47fbfd2b-4015-42cc-971d-e80526624410", "node_type": "1", "metadata": {}, "hash": "3dfa37799718eb9dad3d3998d67e6f0dde770959d80d56ea9d3c13d08959cd2a", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef gerar_grafico_vendas_por_grupo(\n    nome_grupo: str, agregacao: str = \"soma\"\n) -> Dict[str, Any]:\n    \"\"\"\n    Gera gr\u00e1fico de vendas mensais para todos os produtos de um grupo espec\u00edfico.\n    \u00datil para an\u00e1lise de desempenho de categorias de produtos ao longo do ano.\n\n    Args:\n        nome_grupo: Nome do grupo/categoria (ex: \"ESMALTES\", \"CREMES\", etc.)\n        agregacao: Tipo de agrega\u00e7\u00e3o - \"soma\" (padr\u00e3o) ou \"media\"\n\n    Returns:\n        Dicion\u00e1rio com gr\u00e1fico de vendas mensais do grupo\n    \"\"\"\n    logger.info(f\"Gerando gr\u00e1fico de vendas do grupo: {nome_grupo}\")\n\n    try:\n        manager = get_data_manager()\n        df = manager.get_data()\n\n        if df is None or df.empty:\n            return {\"status\": \"error\", \"message\": \"N\u00e3o foi poss\u00edvel carregar dados\"}\n\n        # Verificar se coluna GRUPO existe\n        if \"GRUPO\" not in df.columns:\n            return {\n                \"status\": \"error\",\n                \"message\": \"Coluna 'GRUPO' n\u00e3o encontrada no dataset\"\n            }\n\n        # Filtrar produtos do grupo (case-insensitive)\n        df_grupo = df[df[\"GRUPO\"].str.upper().str.contains(nome_grupo.upper(), na=False)].copy()\n\n        if df_grupo.empty:\n            grupos_disponiveis = df[\"GRUPO\"].unique()[:10]\n            return {\n                \"status\": \"error\",\n                \"message\": (\n                    f\"Grupo '{nome_grupo}' n\u00e3o encontrado. \"\n                    f\"Grupos dispon\u00edveis: {', '.join(map(str, grupos_disponiveis))}\"\n                )\n            }\n\n        # Colunas de vendas mensais\n        mes_cols = {\n            'JAN': 'VENDA QTD JAN', 'FEV': 'VENDA QTD FEV', 'MAR': 'VENDA QTD MAR',\n            'ABR': 'VENDA QTD ABR', 'MAI': 'VENDA QTD MAI', 'JUN': 'VENDA QTD JUN',\n            'JUL': 'VENDA QTD JUL', 'AGO': 'VENDA QTD AGO', 'SET': 'VENDA QTD SET',\n            'OUT': 'VENDA QTD OUT', 'NOV': 'VENDA QTD NOV', 'DEZ': 'VENDA QTD DEZ'\n        }\n\n        # Converter para num\u00e9rico\n        for col in mes_cols.values():\n            if col in df_grupo.columns:\n                df_grupo[col] = pd.to_numeric(df_grupo[col], errors='coerce').fillna(0)\n\n        # Agregar vendas mensais\n        vendas_mensais = []\n        mes_labels = []\n\n        for mes_abrev, col_name in mes_cols.items():\n            if col_name in df_grupo.columns:\n                if agregacao == \"media\":\n                    valor = df_grupo[col_name].mean()\n                else:  # soma (padr\u00e3o)\n                    valor = df_grupo[col_name].sum()\n\n                vendas_mensais.append(float(valor))\n                mes_labels.append(mes_abrev)\n\n        if not vendas_mensais:\n            return {\n                \"status\": \"error\",\n                \"message\": \"Colunas de vendas mensais n\u00e3o encontradas\"\n            }\n\n        # Criar gr\u00e1fico\n        fig = go.Figure()\n\n        fig.add_trace(\n            go.Scatter(\n                x=mes_labels,\n                y=vendas_mensais,\n                mode=\"lines+markers+text\",\n                name=\"Vendas\",\n                line=dict(color=\"#10B981\", width=3),\n                marker=dict(\n                    size=12,\n                    color=\"#10B981\",\n                    line=dict(width=2, color=\"white\"),\n                    symbol=\"circle\",\n                ),\n                hovertemplate=(\n                    \"<b>M\u00eas: %{x}</b><br>\"\n                    \"Quantidade: %{y:,0f} unidades<extra></extra>\"\n                ),\n                fill=\"tozeroy\",\n                fillcolor=\"rgba(16, 185, 129, 0.2)\",\n                text=[f\"{int(v):,}\" for v in vendas_mensais],\n                textposition=\"top center\",", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "47fbfd2b-4015-42cc-971d-e80526624410": {"__data__": {"id_": "47fbfd2b-4015-42cc-971d-e80526624410", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "baaf14ac-e422-4f6d-9b74-784c9de83cd9", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "30464f6086fa7d4b5feca3c8ae178de07a48cd776f4031b1b2b1373364d66def", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "5dd945ec-caac-4bea-890f-d957b06afab4", "node_type": "1", "metadata": {}, "hash": "491273223985276936053576b435d211d7a30219bc3d72ce2b8738a95ab31774", "class_name": "RelatedNodeInfo"}}, "text": "Figure()\n\n        fig.add_trace(\n            go.Scatter(\n                x=mes_labels,\n                y=vendas_mensais,\n                mode=\"lines+markers+text\",\n                name=\"Vendas\",\n                line=dict(color=\"#10B981\", width=3),\n                marker=dict(\n                    size=12,\n                    color=\"#10B981\",\n                    line=dict(width=2, color=\"white\"),\n                    symbol=\"circle\",\n                ),\n                hovertemplate=(\n                    \"<b>M\u00eas: %{x}</b><br>\"\n                    \"Quantidade: %{y:,0f} unidades<extra></extra>\"\n                ),\n                fill=\"tozeroy\",\n                fillcolor=\"rgba(16, 185, 129, 0.2)\",\n                text=[f\"{int(v):,}\" for v in vendas_mensais],\n                textposition=\"top center\",\n                textfont=dict(size=10)\n            )\n        )\n\n        # Adicionar linha de m\u00e9dia\n        if vendas_mensais:\n            media_vendas = sum(vendas_mensais) / len(vendas_mensais)\n            fig.add_hline(\n                y=media_vendas,\n                line_dash=\"dash\",\n                line_color=\"red\",\n                annotation_text=f\"M\u00e9dia: {int(media_vendas):,}\",\n                annotation_position=\"right\",\n            )\n\n        tipo_agregacao = \"Total\" if agregacao == \"soma\" else \"M\u00e9dia\"\n        titulo = f\"Vendas Mensais - Grupo: {nome_grupo.upper()} ({tipo_agregacao})\"\n\n        fig = _apply_chart_customization(fig, title=titulo)\n\n        fig.update_xaxes(title_text=\"M\u00eas\")\n        fig.update_yaxes(title_text=\"Quantidade (unidades)\")\n        fig.update_layout(height=600, hovermode=\"x unified\")\n\n        # Calcular estat\u00edsticas\n        total_vendas = sum(vendas_mensais)\n        venda_media = total_vendas / len(vendas_mensais) if vendas_mensais else 0\n        venda_max = max(vendas_mensais) if vendas_mensais else 0\n        venda_min = min(vendas_mensais) if vendas_mensais else 0\n        venda_max_mes = mes_labels[vendas_mensais.index(venda_max)] if vendas_mensais and venda_max > 0 else \"N/A\"\n        venda_min_mes = mes_labels[vendas_mensais.index(venda_min)] if vendas_mensais else \"N/A\"\n\n        return {\n            \"status\": \"success\",\n            \"chart_type\": \"line_temporal_grupo\",\n            \"chart_data\": _export_chart_to_json(fig),\n            \"summary\": {\n                \"grupo\": nome_grupo.upper(),\n                \"total_produtos\": len(df_grupo),\n                \"agregacao\": agregacao,\n                \"total_vendas\": int(total_vendas),\n                \"venda_media_mensal\": float(venda_media),\n                \"venda_maxima\": int(venda_max),\n                \"venda_minima\": int(venda_min),\n                \"mes_maior_venda\": venda_max_mes,\n                \"mes_menor_venda\": venda_min_mes,\n                \"meses_analisados\": len(mes_labels),\n                \"dados_mensais\": {\n                    mes_labels[i]: int(vendas_mensais[i])\n                    for i in range(len(mes_labels))\n                },\n            },\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro ao gerar gr\u00e1fico de vendas por grupo: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar gr\u00e1fico: {str(e)}\"}", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5dd945ec-caac-4bea-890f-d957b06afab4": {"__data__": {"id_": "5dd945ec-caac-4bea-890f-d957b06afab4", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "47fbfd2b-4015-42cc-971d-e80526624410", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "18ae73cf65ad9eb98e9e396153dbc2bf2075ab6209afd763276fa251f824cfcb", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "1ec36c44-efd8-4074-b387-f3669a040d74", "node_type": "1", "metadata": {}, "hash": "3a5fdf98bf40b2d1b205ff0c5d11c4b1662df29e9b696ca38bf8c17d19d1168b", "class_name": "RelatedNodeInfo"}}, "text": "\"agregacao\": agregacao,\n                \"total_vendas\": int(total_vendas),\n                \"venda_media_mensal\": float(venda_media),\n                \"venda_maxima\": int(venda_max),\n                \"venda_minima\": int(venda_min),\n                \"mes_maior_venda\": venda_max_mes,\n                \"mes_menor_venda\": venda_min_mes,\n                \"meses_analisados\": len(mes_labels),\n                \"dados_mensais\": {\n                    mes_labels[i]: int(vendas_mensais[i])\n                    for i in range(len(mes_labels))\n                },\n            },\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro ao gerar gr\u00e1fico de vendas por grupo: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar gr\u00e1fico: {str(e)}\"}\n\n\n@tool\ndef gerar_ranking_produtos_mais_vendidos(top_n: int = 10) -> Dict[str, Any]:\n    \"\"\"\n    Gera um gr\u00e1fico de barras horizontais com o ranking dos produtos mais vendidos no ano.\n    \u00datil para identificar os produtos mais populares.\n\n    Args:\n        top_n: O n\u00famero de produtos a serem inclu\u00eddos no ranking (padr\u00e3o: 10).\n\n    Returns:\n        Dicion\u00e1rio com o gr\u00e1fico de ranking e dados.\n    \"\"\"\n    logger.info(f\"Gerando ranking dos {top_n} produtos mais vendidos.\")\n\n    try:\n        manager = get_data_manager()\n        df = manager.get_data()\n\n        if df is None or df.empty:\n            return {\"status\": \"error\", \"message\": \"N\u00e3o foi poss\u00edvel carregar dados.\"}\n\n        mes_cols = [col for col in df.columns if 'VENDA QTD' in col]\n        if not mes_cols:\n            return {\"status\": \"error\", \"message\": \"Nenhuma coluna de vendas mensais encontrada.\"}\n\n        # Calcular vendas totais\n        df['VENDAS_TOTAIS'] = df[mes_cols].sum(axis=1)\n\n        # Preparar dados para o gr\u00e1fico\n        ranking_df = df.sort_values('VENDAS_TOTAIS', ascending=False).head(top_n)\n        ranking_df = ranking_df.sort_values('VENDAS_TOTAIS', ascending=True) # Para exibi\u00e7\u00e3o correta no gr\u00e1fico de barras horizontal\n\n        # Criar gr\u00e1fico\n        fig = go.Figure(go.Bar(\n            x=ranking_df['VENDAS_TOTAIS'],\n            y=ranking_df['DESCRI\u00c7\u00c3O'],\n            orientation='h',\n            marker=dict(color='#2563EB'),\n            text=ranking_df['VENDAS_TOTAIS'],\n            textposition='auto',\n            texttemplate='%{text:.2s}'\n        ))\n\n        fig = _apply_chart_customization(\n            fig, title=f\"Top {top_n} Produtos Mais Vendidos\"\n        )\n        fig.update_layout(\n            yaxis=dict(tickmode='linear'),\n            xaxis_title=\"Total de Vendas (Unidades)\",\n            yaxis_title=\"Produto\"\n        )\n\n        return {\n            \"status\": \"success\",\n            \"chart_type\": \"bar_horizontal\",\n            \"chart_data\": _export_chart_to_json(fig),\n            \"summary\": {\n                \"top_n\": top_n,\n                \"produtos\": ranking_df[['DESCRI\u00c7\u00c3O', 'VENDAS_TOTAIS']].to_dict('records')\n            }\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro ao gerar ranking de produtos: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar ranking: {str(e)}\"}\n\n\n@tool\ndef listar_graficos_disponiveis() -> Dict[str, Any]:\n    \"\"\"\n    Lista todos os tipos de gr\u00e1ficos e dashboards dispon\u00edveis no sistema.\n    Use esta ferramenta quando o usu\u00e1rio perguntar \"quais gr\u00e1ficos voc\u00ea pode gerar?\",\n    \"que tipos de visualiza\u00e7\u00f5es existem?\", ou similares.", "mimetype": "text/plain", "start_char_idx": 34858, "end_char_idx": 38255, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1ec36c44-efd8-4074-b387-f3669a040d74": {"__data__": {"id_": "1ec36c44-efd8-4074-b387-f3669a040d74", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "5dd945ec-caac-4bea-890f-d957b06afab4", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "df28d8085f6454cbb4fe6c3564c5ee4cafa503c1c2f2f7bbb251f9e8c8021ec5", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3aab2fd3-0120-4047-b597-e7dc7c2ef2ee", "node_type": "1", "metadata": {}, "hash": "291f4ac2c8f20159bd3ca7d73ab7e3663cce3694a0e63e17d62389e8c43a82e5", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef listar_graficos_disponiveis() -> Dict[str, Any]:\n    \"\"\"\n    Lista todos os tipos de gr\u00e1ficos e dashboards dispon\u00edveis no sistema.\n    Use esta ferramenta quando o usu\u00e1rio perguntar \"quais gr\u00e1ficos voc\u00ea pode gerar?\",\n    \"que tipos de visualiza\u00e7\u00f5es existem?\", ou similares.\n\n    Returns:\n        Dicion\u00e1rio com lista completa de gr\u00e1ficos dispon\u00edveis e suas descri\u00e7\u00f5es\n    \"\"\"\n    logger.info(\"Listando gr\u00e1ficos dispon\u00edveis\")\n\n    graficos_info = {\n        \"total_tipos\": 12,\n        \"categorias\": {\n            \"An\u00e1lise de Vendas\": [\n                {\n                    \"nome\": \"gerar_grafico_vendas_por_grupo\",\n                    \"descricao\": \"Vendas mensais de um grupo/categoria espec\u00edfica (ex: esmaltes, cremes)\",\n                    \"exemplo\": \"gerar_grafico_vendas_por_grupo(nome_grupo='esmaltes')\"\n                },\n                {\n                    \"nome\": \"gerar_grafico_vendas_mensais_produto\",\n                    \"descricao\": \"Evolu\u00e7\u00e3o de vendas mensais de um produto espec\u00edfico\",\n                    \"exemplo\": \"gerar_grafico_vendas_mensais_produto(codigo_produto=9)\"\n                },\n                {\n                    \"nome\": \"gerar_ranking_produtos_mais_vendidos\",\n                    \"descricao\": \"Ranking dos produtos mais vendidos do ano\",\n                    \"exemplo\": \"gerar_ranking_produtos_mais_vendidos(top_n=10)\"\n                }\n            ],\n            \"An\u00e1lise de Categorias\": [\n                {\n                    \"nome\": \"gerar_grafico_vendas_por_categoria\",\n                    \"descricao\": \"Gr\u00e1fico donut com total de produtos por grupo\",\n                    \"exemplo\": \"gerar_grafico_vendas_por_categoria(limite=10)\"\n                },\n                {\n                    \"nome\": \"gerar_grafico_pizza_categorias\",\n                    \"descricao\": \"Pizza com propor\u00e7\u00e3o percentual de produtos por grupo\",\n                    \"exemplo\": \"gerar_grafico_pizza_categorias()\"\n                },\n                {\n                    \"nome\": \"gerar_comparacao_precos_categorias\",\n                    \"descricao\": \"Compara\u00e7\u00e3o de pre\u00e7os m\u00e9dios entre grupos\",\n                    \"exemplo\": \"gerar_comparacao_precos_categorias()\"\n                }\n            ],\n            \"An\u00e1lise de Estoque\": [\n                {\n                    \"nome\": \"gerar_grafico_estoque_por_produto\",\n                    \"descricao\": \"Barras verticais com estoque dispon\u00edvel por produto\",\n                    \"exemplo\": \"gerar_grafico_estoque_por_produto(limite=15)\"\n                },\n                {\n                    \"nome\": \"gerar_analise_distribuicao_estoque\",\n                    \"descricao\": \"Histograma + Box Plot de distribui\u00e7\u00e3o de estoque\",\n                    \"exemplo\": \"gerar_analise_distribuicao_estoque()\"\n                }\n            ],\n            \"Dashboards Completos\": [\n                {\n                    \"nome\": \"gerar_dashboard_analise_completa\",\n                    \"descricao\": \"Dashboard 2x2 com vis\u00e3o geral do neg\u00f3cio (produtos, estoque, pre\u00e7os)\",\n                    \"exemplo\": \"gerar_dashboard_analise_completa()\"\n                },\n                {\n                    \"nome\": \"gerar_dashboard_dinamico\",\n                    \"descricao\": \"Dashboard customizado com at\u00e9 4 gr\u00e1ficos escolhidos\",\n                    \"exemplo\": \"gerar_dashboard_dinamico(graficos=['gerar_grafico_pizza_categorias', 'gerar_ranking_produtos_mais_vendidos'])\"\n                },\n                {\n                    \"nome\": \"gerar_dashboard_executivo\",\n                    \"descricao\": \"Dashboard executivo otimizado para tomada de decis\u00e3o\",\n                    \"exemplo\": \"gerar_dashboard_executivo()\"\n                }\n            ],\n            \"Gr\u00e1ficos Inteligentes\": [\n                {\n                    \"nome\": \"gerar_grafico_automatico\",\n                    \"descricao\": \"Detec\u00e7\u00e3o autom\u00e1tica do tipo de gr\u00e1fico baseado na descri\u00e7\u00e3o\",\n                    \"exemplo\": \"gerar_grafico_automatico(descricao='vendas por categoria')\"\n                }\n            ]\n        },\n        \"dicas\": [\n            \"Para an\u00e1lise de vendas de categorias, use gerar_grafico_vendas_por_grupo\",\n            \"Para vis\u00e3o geral r\u00e1pida, use gerar_dashboard_analise_completa\",\n            \"Para dashboards personalizados, use gerar_dashboard_dinamico\",\n            \"O gerar_grafico_automatico tenta detectar automaticamente o que voc\u00ea precisa\"\n        ]\n    }\n\n    return {\n        \"status\": \"success\",\n        \"graficos_disponiveis\": graficos_info,\n        \"message\": f\"Total de {graficos_info['total_tipos']} tipos de gr\u00e1ficos dispon\u00edveis\"\n    }", "mimetype": "text/plain", "start_char_idx": 37972, "end_char_idx": 42556, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3aab2fd3-0120-4047-b597-e7dc7c2ef2ee": {"__data__": {"id_": "3aab2fd3-0120-4047-b597-e7dc7c2ef2ee", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "1ec36c44-efd8-4074-b387-f3669a040d74", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "4f29171de493a59f20115f77fa7d8335d595c6558c9be1c493ac246cbffd18d6", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2a97ee66-bf37-46ee-8b8c-21c743c0d9e3", "node_type": "1", "metadata": {}, "hash": "10a718d7b3cc5d11e1f92eb06ded8268f0931fa1ba05e3e11b02576a7fbb1dad", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef gerar_dashboard_executivo() -> Dict[str, Any]:\n    \"\"\"\n    Gera dashboard executivo completo com os principais indicadores de neg\u00f3cio.\n    Layout 2x3 otimizado para an\u00e1lise gerencial e tomada de decis\u00e3o.\n\n    Inclui:\n    - Vendas por categoria (Top 10)\n    - Ranking produtos mais vendidos\n    - An\u00e1lise de estoque\n    - Compara\u00e7\u00e3o de pre\u00e7os\n    - Distribui\u00e7\u00e3o de produtos\n    - M\u00e9tricas principais\n\n    Returns:\n        Dicion\u00e1rio com dashboard executivo completo\n    \"\"\"\n    logger.info(\"Gerando dashboard executivo\")\n\n    try:\n        manager = get_data_manager()\n        df = manager.get_data()\n\n        if df is None or df.empty:\n            return {\"status\": \"error\", \"message\": \"N\u00e3o foi poss\u00edvel carregar dados\"}\n\n        from plotly.subplots import make_subplots\n\n        # Preparar dados\n        df_conv = df.copy()\n\n        # Converter colunas para num\u00e9rico\n        for col in ['QTD', 'VENDA UNIT R$', 'VENDA R$', 'LUCRO R$']:\n            if col in df_conv.columns:\n                df_conv[col] = pd.to_numeric(df_conv[col], errors='coerce').fillna(0)\n\n        # Calcular vendas totais se n\u00e3o existir\n        mes_cols = [col for col in df_conv.columns if 'VENDA QTD' in col]\n        if mes_cols:\n            df_conv['VENDAS_TOTAIS'] = df_conv[mes_cols].sum(axis=1)\n\n        # Criar subplots 2x3\n        fig = make_subplots(\n            rows=2, cols=3,\n            subplot_titles=(\n                \"Top 10 Grupos (Quantidade)\",\n                \"Top 10 Produtos Mais Vendidos\",\n                \"An\u00e1lise de Lucro por Grupo\",\n                \"Distribui\u00e7\u00e3o de Estoque\",\n                \"Pre\u00e7o M\u00e9dio por Grupo\",\n                \"Status de Vendas Mensais\"\n            ),\n            specs=[\n                [{\"type\": \"bar\"}, {\"type\": \"bar\"}, {\"type\": \"bar\"}],\n                [{\"type\": \"histogram\"}, {\"type\": \"bar\"}, {\"type\": \"scatter\"}]\n            ],\n            vertical_spacing=0.12,\n            horizontal_spacing=0.1\n        )\n\n        # 1. Top 10 Grupos\n        if 'GRUPO' in df_conv.columns:\n            grupos = df_conv['GRUPO'].value_counts().head(10)\n            fig.add_trace(\n                go.Bar(\n                    x=grupos.index,\n                    y=grupos.values,\n                    name=\"Produtos\",\n                    marker_color=\"#2563EB\"\n                ),\n                row=1, col=1\n            )\n\n        # 2. Top 10 Produtos Mais Vendidos\n        if 'VENDAS_TOTAIS' in df_conv.columns and 'DESCRI\u00c7\u00c3O' in df_conv.columns:\n            top_vendas = df_conv.nlargest(10, 'VENDAS_TOTAIS')\n            fig.add_trace(\n                go.Bar(\n                    x=top_vendas['VENDAS_TOTAIS'],\n                    y=top_vendas['DESCRI\u00c7\u00c3O'],\n                    orientation='h',\n                    name=\"Vendas\",\n                    marker_color=\"#10B981\"\n                ),\n                row=1, col=2\n            )\n\n        # 3. Lucro por Grupo\n        if 'GRUPO' in df_conv.columns and 'LUCRO R$' in df_conv.columns:\n            lucro_grupo = df_conv.groupby('GRUPO')['LUCRO R$'].sum().sort_values(ascending=False).head(10)\n            fig.add_trace(\n                go.Bar(\n                    x=lucro_grupo.index,\n                    y=lucro_grupo.values,\n                    name=\"Lucro\",\n                    marker_color=\"#F59E0B\"\n                ),\n                row=1, col=3\n            )\n\n        # 4. Distribui\u00e7\u00e3o de Estoque\n        if 'QTD' in df_conv.columns:\n            fig.add_trace(\n                go.Histogram(\n                    x=df_conv['QTD'],\n                    nbinsx=30,\n                    name=\"Estoque\",\n                    marker_color=\"#8B5CF6\"\n                ),\n                row=2, col=1\n            )\n\n        # 5.", "mimetype": "text/plain", "start_char_idx": 42559, "end_char_idx": 46253, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2a97ee66-bf37-46ee-8b8c-21c743c0d9e3": {"__data__": {"id_": "2a97ee66-bf37-46ee-8b8c-21c743c0d9e3", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3aab2fd3-0120-4047-b597-e7dc7c2ef2ee", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "6d6800891d88b9abee9800582e87739368c8c202abb49fa9b9212a8ad005d81a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "59d02ba7-2070-45e1-afcc-80a07f36fee4", "node_type": "1", "metadata": {}, "hash": "5fbc89d04d21fd42dd5942786432b85493b6fb721c41a966447604b41433f8bf", "class_name": "RelatedNodeInfo"}}, "text": "Lucro por Grupo\n        if 'GRUPO' in df_conv.columns and 'LUCRO R$' in df_conv.columns:\n            lucro_grupo = df_conv.groupby('GRUPO')['LUCRO R$'].sum().sort_values(ascending=False).head(10)\n            fig.add_trace(\n                go.Bar(\n                    x=lucro_grupo.index,\n                    y=lucro_grupo.values,\n                    name=\"Lucro\",\n                    marker_color=\"#F59E0B\"\n                ),\n                row=1, col=3\n            )\n\n        # 4. Distribui\u00e7\u00e3o de Estoque\n        if 'QTD' in df_conv.columns:\n            fig.add_trace(\n                go.Histogram(\n                    x=df_conv['QTD'],\n                    nbinsx=30,\n                    name=\"Estoque\",\n                    marker_color=\"#8B5CF6\"\n                ),\n                row=2, col=1\n            )\n\n        # 5. Pre\u00e7o M\u00e9dio por Grupo\n        if 'GRUPO' in df_conv.columns and 'VENDA UNIT R$' in df_conv.columns:\n            preco_grupo = df_conv.groupby('GRUPO')['VENDA UNIT R$'].mean().sort_values(ascending=False).head(10)\n            fig.add_trace(\n                go.Bar(\n                    x=preco_grupo.index,\n                    y=preco_grupo.values,\n                    name=\"Pre\u00e7o M\u00e9dio\",\n                    marker_color=\"#EC4899\"\n                ),\n                row=2, col=2\n            )\n\n        # 6. Vendas Mensais Totais\n        if mes_cols:\n            vendas_mensais = df_conv[mes_cols].sum()\n            meses = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ']\n            fig.add_trace(\n                go.Scatter(\n                    x=meses,\n                    y=vendas_mensais.values,\n                    mode='lines+markers',\n                    name=\"Vendas Mensais\",\n                    line=dict(color=\"#14B8A6\", width=3),\n                    marker=dict(size=8),\n                    fill='tozeroy'\n                ),\n                row=2, col=3\n            )\n\n        # Atualizar layout\n        fig.update_layout(\n            title_text=\"Dashboard Executivo - Vis\u00e3o Geral do Neg\u00f3cio\",\n            height=900,\n            showlegend=False,\n            template=_get_theme_template(),\n            margin=dict(l=60, r=60, t=100, b=60)\n        )\n\n        # Ajustar eixos\n        fig.update_xaxes(tickangle=-45, row=1, col=1)\n        fig.update_xaxes(tickangle=-45, row=1, col=3)\n        fig.update_xaxes(tickangle=-45, row=2, col=2)\n\n        # Calcular m\u00e9tricas\n        metricas = {\n            \"total_produtos\": len(df_conv),\n            \"total_grupos\": df_conv['GRUPO'].nunique() if 'GRUPO' in df_conv.columns else 0,\n            \"lucro_total\": float(df_conv['LUCRO R$'].sum()) if 'LUCRO R$' in df_conv.columns else 0,\n            \"vendas_totais\": float(df_conv['VENDAS_TOTAIS'].sum()) if 'VENDAS_TOTAIS' in df_conv.columns else 0,\n            \"estoque_total\": float(df_conv['QTD'].sum()) if 'QTD' in df_conv.columns else 0,\n            \"valor_estoque\": float((df_conv['QTD'] * df_conv['VENDA UNIT R$']).sum()) if all(c in df_conv.columns for c in ['QTD', 'VENDA UNIT R$']) else 0\n        }\n\n        return {\n            \"status\": \"success\",\n            \"chart_type\": \"dashboard_executivo\",\n            \"chart_data\": _export_chart_to_json(fig),\n            \"summary\": metricas\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro ao gerar dashboard executivo: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao gerar dashboard: {str(e)}\"}\n\n\n@tool\ndef gerar_dashboard_dinamico(graficos: list) -> Dict[str, Any]:\n    \"\"\"\n    Gera um dashboard din\u00e2mico com uma sele\u00e7\u00e3o de gr\u00e1ficos.\n\n    Args:\n        graficos: Uma lista dos nomes das ferramentas de gr\u00e1fico a serem inclu\u00eddas.", "mimetype": "text/plain", "start_char_idx": 45429, "end_char_idx": 49121, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "59d02ba7-2070-45e1-afcc-80a07f36fee4": {"__data__": {"id_": "59d02ba7-2070-45e1-afcc-80a07f36fee4", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2a97ee66-bf37-46ee-8b8c-21c743c0d9e3", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "609ac4035ba3b396057d2eacf7c68084d5d598e1efe377444d9b0d0740c2e240", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3440163e-8445-444f-8a86-b53231b3e1ee", "node_type": "1", "metadata": {}, "hash": "eb9e8814421866d7f9853eab23d393e30c09836cd21f9affec81f4c5e3e5ff04", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef gerar_dashboard_dinamico(graficos: list) -> Dict[str, Any]:\n    \"\"\"\n    Gera um dashboard din\u00e2mico com uma sele\u00e7\u00e3o de gr\u00e1ficos.\n\n    Args:\n        graficos: Uma lista dos nomes das ferramentas de gr\u00e1fico a serem inclu\u00eddas.\n                  Exemplos de nomes de ferramentas v\u00e1lidas:\n                  - 'gerar_grafico_vendas_por_categoria'\n                  - 'gerar_grafico_estoque_por_produto'\n                  - 'gerar_comparacao_precos_categorias'\n                  - 'gerar_analise_distribuicao_estoque'\n                  - 'gerar_grafico_pizza_categorias'\n                  - 'gerar_ranking_produtos_mais_vendidos'\n\n    Returns:\n        Dicion\u00e1rio com o dashboard e m\u00faltiplos gr\u00e1ficos.\n    \"\"\"\n    logger.info(f\"Gerando dashboard din\u00e2mico com os seguintes gr\u00e1ficos: {graficos}\")\n\n    if not graficos:\n        return {\"status\": \"error\", \"message\": \"Nenhum gr\u00e1fico especificado para o dashboard.\"}\n\n    from plotly.subplots import make_subplots\n    import math\n    import json\n\n    num_graficos = len(graficos)\n    if num_graficos > 4:\n        return {\"status\": \"error\", \"message\": \"O dashboard din\u00e2mico suporta no m\u00e1ximo 4 gr\u00e1ficos.\"}\n    \n    rows = math.ceil(num_graficos / 2)\n    cols = 2 if num_graficos > 1 else 1\n    \n    # Mapeamento de nomes de ferramentas para fun\u00e7\u00f5es\n    tool_map = {\n        'gerar_grafico_vendas_por_categoria': gerar_grafico_vendas_por_categoria,\n        'gerar_grafico_estoque_por_produto': gerar_grafico_estoque_por_produto,\n        'gerar_comparacao_precos_categorias': gerar_comparacao_precos_categorias,\n        'gerar_analise_distribuicao_estoque': gerar_analise_distribuicao_estoque,\n        'gerar_grafico_pizza_categorias': gerar_grafico_pizza_categorias,\n        'gerar_ranking_produtos_mais_vendidos': gerar_ranking_produtos_mais_vendidos,\n    }\n\n    figuras = []\n    titulos = []\n    for nome_ferramenta in graficos:\n        if nome_ferramenta in tool_map:\n            try:\n                resultado = tool_map[nome_ferramenta].invoke({})\n                if resultado.get(\"status\") == \"success\":\n                    chart_data = json.loads(resultado[\"chart_data\"])\n                    figura_individual = go.Figure(chart_data)\n                    figuras.append(figura_individual)\n                    titulos.append(figura_individual.layout.title.text)\n                else:\n                    logger.warning(f\"A ferramenta '{nome_ferramenta}' falhou: {resultado.get('message')}\")\n            except Exception as e:\n                logger.error(f\"Erro ao executar a ferramenta '{nome_ferramenta}': {e}\", exc_info=True)\n    \n    if not figuras:\n        return {\"status\": \"error\", \"message\": \"Nenhum dos gr\u00e1ficos solicitados p\u00f4de ser gerado.\"}", "mimetype": "text/plain", "start_char_idx": 48889, "end_char_idx": 51589, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3440163e-8445-444f-8a86-b53231b3e1ee": {"__data__": {"id_": "3440163e-8445-444f-8a86-b53231b3e1ee", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2b3e410e-1735-433e-a26d-6a0b0734a659", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "51302abab66f312eb461a018086d722665c0c42fbc20b38d01c4d23c1ff9a68a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "59d02ba7-2070-45e1-afcc-80a07f36fee4", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}, "hash": "fd9f78f749dd07e04cf302d6ddd6c64f07b626fa03671aedf31e46f198a03568", "class_name": "RelatedNodeInfo"}}, "text": "# Recalcular layout com base nos gr\u00e1ficos gerados com sucesso\n    num_graficos = len(figuras)\n    rows = math.ceil(num_graficos / 2)\n    cols = 2 if num_graficos > 1 else 1\n\n    fig = make_subplots(\n        rows=rows, \n        cols=cols, \n        subplot_titles=titulos,\n        vertical_spacing=0.15, # Aumentar espa\u00e7amento vertical\n        horizontal_spacing=0.1 # Aumentar espa\u00e7amento horizontal\n    )\n\n    for i, figura_individual in enumerate(figuras):\n        row = i // cols + 1\n        col = i % cols + 1\n        for trace in figura_individual.data:\n            fig.add_trace(trace, row=row, col=col)\n\n    fig.update_layout(\n        title_text=\"Dashboard Din\u00e2mico\",\n        height=450 * rows, # Ajustar altura\n        showlegend=False,\n        template=_get_theme_template(),\n        margin=dict(l=40, r=40, t=120, b=40), # Adicionar margens\n    )\n    # Ajustar tamanho da fonte dos subt\u00edtulos\n    fig.update_annotations(font_size=14)\n\n    return {\n        \"status\": \"success\",\n        \"chart_type\": \"dashboard\",\n        \"chart_data\": _export_chart_to_json(fig),\n        \"summary\": {\n            \"total_graficos\": len(figuras),\n            \"graficos_incluidos\": titulos,\n        },\n    }\n\n\n# Lista de todas as ferramentas de gr\u00e1ficos dispon\u00edveis\nchart_tools = [\n    # Ferramentas de an\u00e1lise e consulta\n    listar_graficos_disponiveis,  # NOVO: Lista todos os gr\u00e1ficos dispon\u00edveis\n\n    # Gr\u00e1ficos individuais\n    gerar_grafico_vendas_por_categoria,\n    gerar_grafico_estoque_por_produto,\n    gerar_comparacao_precos_categorias,\n    gerar_analise_distribuicao_estoque,\n    gerar_grafico_pizza_categorias,\n    gerar_grafico_vendas_por_produto,\n    gerar_grafico_vendas_mensais_produto,\n    gerar_grafico_vendas_por_grupo,  # Gr\u00e1fico de vendas por grupo/categoria\n    gerar_ranking_produtos_mais_vendidos,\n\n    # Dashboards completos\n    gerar_dashboard_analise_completa,\n    gerar_dashboard_executivo,  # NOVO: Dashboard executivo 2x3\n    gerar_dashboard_dinamico,\n\n    # Gr\u00e1ficos inteligentes\n    gerar_grafico_automatico,\n]", "mimetype": "text/plain", "start_char_idx": 51595, "end_char_idx": 53625, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a4d27306-85ce-48a5-ab38-7380e28fbfee": {"__data__": {"id_": "a4d27306-85ce-48a5-ab38-7380e28fbfee", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\check_gui_dependencies.py", "language": "python", "lines": 57, "filename": "check_gui_dependencies.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9ecd1dcb-1da9-40da-a8dc-3035678caead", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\check_gui_dependencies.py", "language": "python", "lines": 57, "filename": "check_gui_dependencies.py"}, "hash": "7e4ba3aef9879ae4cd5b2e254c5dcb597fd94f07ba5a023b76cd534ceeedf2b1", "class_name": "RelatedNodeInfo"}}, "text": "import subprocess\nimport sys\n\n\"\"\"\nVerifica se todas as depend\u00eancias necess\u00e1rias para a interface gr\u00e1fica est\u00e3o instaladas.\n\"\"\"\n\n\ndef check_dependency(module_name):\n    \"\"\"Verifica se um m\u00f3dulo est\u00e1 instalado e tenta instal\u00e1-lo se n\u00e3o estiver.\"\"\"\n    try:\n        print(f\"\u2713 {module_name} j\u00e1 est\u00e1 instalado\")\n        return True\n    except ImportError:\n        print(f\"\u2717 {module_name} n\u00e3o est\u00e1 instalado. Tentando instalar...\")\n        try:\n            subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", module_name])\n            print(f\"\u2713 {module_name} foi instalado com sucesso\")\n            return True\n        except subprocess.CalledProcessError:\n            print(f\"\u2717 Falha ao instalar {module_name}\")\n            return False\n\n\ndef main():\n    \"\"\"Fun\u00e7\u00e3o principal para verificar depend\u00eancias.\"\"\"\n    print(\"Verificando depend\u00eancias para a interface gr\u00e1fica...\")\n\n    # Lista de depend\u00eancias necess\u00e1rias\n    dependencies = [\n        \"streamlit\",\n        \"langchain\",\n\n        \"langchain_community\",\n        \"sqlalchemy\",\n        \"pyodbc\",\n        \"python-dotenv\",\n    ]\n\n    all_installed = True\n    for dep in dependencies:\n        if not check_dependency(dep):\n            all_installed = False\n\n    if all_installed:\n        print(\"\\nTodas as depend\u00eancias est\u00e3o instaladas!\")\n        print(\n            \"Voc\u00ea pode executar a interface Streamlit com: streamlit run streamlit_app.py\"\n        )\n    else:\n        print(\"\\nAlgumas depend\u00eancias n\u00e3o puderam ser instaladas.\")\n        print(\"Por favor, instale-as manualmente e tente novamente.\")\n\n\nif __name__ == \"__main__\":\n    main()", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1598, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "52023b49-1775-4d7e-903e-d12c8f382c55": {"__data__": {"id_": "52023b49-1775-4d7e-903e-d12c8f382c55", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\check_integration.py", "language": "python", "lines": 1, "filename": "check_integration.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "80514101-fc7f-4fa3-a6c7-0e720faa8681", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\check_integration.py", "language": "python", "lines": 1, "filename": "check_integration.py"}, "hash": "5211a7a46b1361f834e3f234797645825ccd7815c8f6dc9c1615e72adf61458e", "class_name": "RelatedNodeInfo"}}, "text": "", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 0, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "edc65b51-e3dc-4165-aa16-6172afdeb09f": {"__data__": {"id_": "edc65b51-e3dc-4165-aa16-6172afdeb09f", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\code_interpreter.py", "language": "python", "lines": 276, "filename": "code_interpreter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f7089940-ac3d-4982-813b-0f1f9fcbfce0", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\code_interpreter.py", "language": "python", "lines": 276, "filename": "code_interpreter.py"}, "hash": "bb1badb949c7c267d86d089934d5c3abf9ee9546d1b4710469c1d80331321a32", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "128663cc-5953-43f4-ade9-e35d8bb51cc3", "node_type": "1", "metadata": {}, "hash": "f4eb60f50324f6877db3ec347b3443af988b727c7771bf8c02ec4067ef93509e", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nCode Interpreter - Sandbox seguro para execu\u00e7\u00e3o de c\u00f3digo Python\nPermite an\u00e1lises din\u00e2micas de dados com pandas, numpy, etc.\n\"\"\"\n\nimport logging\nimport io\nimport sys\nimport traceback\nfrom typing import Dict, Any, Optional, List\nfrom contextlib import redirect_stdout, redirect_stderr\nimport pandas as pd\nfrom langchain_core.tools import tool\n\nlogger = logging.getLogger(__name__)\n\n# Bibliotecas permitidas no sandbox\nALLOWED_MODULES = {\n    'pandas', 'numpy', 'math', 'statistics', 'datetime',\n    'json', 're', 'collections', 'itertools', 'functools'\n}\n\n# Fun\u00e7\u00f5es perigosas bloqueadas\nBLOCKED_FUNCTIONS = {\n    'exec', 'eval', 'compile', 'open', 'input',\n    '__import__', 'globals', 'locals', 'vars',\n    'getattr', 'setattr', 'delattr', 'hasattr'\n}\n\n\nclass CodeInterpreter:\n    \"\"\"\n    Executor seguro de c\u00f3digo Python para an\u00e1lise de dados.\n    \n    Features:\n    - Sandbox com restri\u00e7\u00f5es de seguran\u00e7a\n    - Acesso a pandas e numpy\n    - Captura de stdout/stderr\n    - Timeout configur\u00e1vel\n    \"\"\"\n    \n    def __init__(self, timeout_seconds: int = 10):\n        self.timeout = timeout_seconds\n        self.execution_count = 0\n        self.error_count = 0\n        \n        # Namespace seguro para execu\u00e7\u00e3o\n        self._safe_namespace = self._create_safe_namespace()\n    \n    def _create_safe_namespace(self) -> Dict[str, Any]:\n        \"\"\"Cria namespace seguro com bibliotecas permitidas.\"\"\"\n        namespace = {\n            '__builtins__': {\n                'len': len, 'range': range, 'list': list, 'dict': dict,\n                'str': str, 'int': int, 'float': float, 'bool': bool,\n                'print': print, 'sum': sum, 'min': min, 'max': max,\n                'abs': abs, 'round': round, 'sorted': sorted,\n                'enumerate': enumerate, 'zip': zip, 'map': map,\n                'filter': filter, 'any': any, 'all': all,\n                'isinstance': isinstance, 'type': type,\n                'True': True, 'False': False, 'None': None,\n            }\n        }\n        \n        # Adicionar pandas e numpy\n        try:\n            import pandas as pd\n            import numpy as np\n            namespace['pd'] = pd\n            namespace['np'] = np\n            namespace['DataFrame'] = pd.DataFrame\n        except ImportError:\n            logger.warning(\"pandas/numpy n\u00e3o dispon\u00edvel\")\n        \n        # Adicionar math e statistics\n        try:\n            import math\n            import statistics\n            namespace['math'] = math\n            namespace['statistics'] = statistics\n        except ImportError:\n            pass\n        \n        return namespace\n    \n    def _validate_code(self, code: str) -> tuple[bool, str]:\n        \"\"\"Valida c\u00f3digo antes de executar.\"\"\"\n        code_lower = code.lower()\n        \n        # Verificar fun\u00e7\u00f5es bloqueadas\n        for blocked in BLOCKED_FUNCTIONS:\n            if blocked in code_lower:\n                return False, f\"Fun\u00e7\u00e3o '{blocked}' n\u00e3o permitida\"\n        \n        # Verificar imports perigosos\n        if 'import os' in code_lower or 'import sys' in code_lower:\n            return False, \"Imports de sistema n\u00e3o permitidos\"\n        \n        if 'import subprocess' in code_lower:\n            return False, \"subprocess n\u00e3o permitido\"\n        \n        # Verificar acesso a arquivos\n        if 'open(' in code and 'file' in code_lower:\n            return False, \"Acesso direto a arquivos n\u00e3o permitido\"\n        \n        return True, \"\"\n    \n    def execute(self, code: str, data: pd.DataFrame = None) -> Dict[str, Any]:\n        \"\"\"\n        Executa c\u00f3digo Python de forma segura.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3554, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "128663cc-5953-43f4-ade9-e35d8bb51cc3": {"__data__": {"id_": "128663cc-5953-43f4-ade9-e35d8bb51cc3", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\code_interpreter.py", "language": "python", "lines": 276, "filename": "code_interpreter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f7089940-ac3d-4982-813b-0f1f9fcbfce0", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\code_interpreter.py", "language": "python", "lines": 276, "filename": "code_interpreter.py"}, "hash": "bb1badb949c7c267d86d089934d5c3abf9ee9546d1b4710469c1d80331321a32", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "edc65b51-e3dc-4165-aa16-6172afdeb09f", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\code_interpreter.py", "language": "python", "lines": 276, "filename": "code_interpreter.py"}, "hash": "3db46f196eef5b41f0a363ac4ba7b2d4dbfe4695a3e4fa0c6b5670f803a1eb9c", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "5cc9bea4-e150-4c2a-ac22-139eaedbfdfb", "node_type": "1", "metadata": {}, "hash": "fa6c25df40e643313be4b6d947617138199d8975d1fe1c9d160d890fceacae69", "class_name": "RelatedNodeInfo"}}, "text": "code_lower = code.lower()\n        \n        # Verificar fun\u00e7\u00f5es bloqueadas\n        for blocked in BLOCKED_FUNCTIONS:\n            if blocked in code_lower:\n                return False, f\"Fun\u00e7\u00e3o '{blocked}' n\u00e3o permitida\"\n        \n        # Verificar imports perigosos\n        if 'import os' in code_lower or 'import sys' in code_lower:\n            return False, \"Imports de sistema n\u00e3o permitidos\"\n        \n        if 'import subprocess' in code_lower:\n            return False, \"subprocess n\u00e3o permitido\"\n        \n        # Verificar acesso a arquivos\n        if 'open(' in code and 'file' in code_lower:\n            return False, \"Acesso direto a arquivos n\u00e3o permitido\"\n        \n        return True, \"\"\n    \n    def execute(self, code: str, data: pd.DataFrame = None) -> Dict[str, Any]:\n        \"\"\"\n        Executa c\u00f3digo Python de forma segura.\n        \n        Args:\n            code: C\u00f3digo Python a executar\n            data: DataFrame opcional para an\u00e1lise\n            \n        Returns:\n            Dict com resultado, output e erro\n        \"\"\"\n        self.execution_count += 1\n        logger.info(f\"\ud83d\udc0d CodeInterpreter: Executando c\u00f3digo ({len(code)} chars)\")\n        \n        # Validar c\u00f3digo\n        is_valid, error_msg = self._validate_code(code)\n        if not is_valid:\n            self.error_count += 1\n            return {\n                \"success\": False,\n                \"error\": error_msg,\n                \"output\": \"\",\n                \"result\": None\n            }\n        \n        # Preparar namespace\n        namespace = self._safe_namespace.copy()\n        \n        # Adicionar DataFrame se fornecido\n        if data is not None:\n            namespace['df'] = data\n            namespace['data'] = data\n        \n        # Capturar stdout e stderr\n        stdout_capture = io.StringIO()\n        stderr_capture = io.StringIO()\n        \n        try:\n            with redirect_stdout(stdout_capture), redirect_stderr(stderr_capture):\n                # Executar c\u00f3digo\n                exec(code, namespace)\n            \n            # Extrair resultado (\u00faltima vari\u00e1vel definida ou 'result')\n            result = namespace.get('result', None)\n            \n            # Se n\u00e3o houver 'result', tentar encontrar \u00faltima vari\u00e1vel\n            if result is None:\n                for var_name in ['output', 'resultado', 'answer', 'resposta']:\n                    if var_name in namespace:\n                        result = namespace[var_name]\n                        break\n            \n            # Converter DataFrame para dict se necess\u00e1rio\n            if isinstance(result, pd.DataFrame):\n                result = {\n                    \"type\": \"dataframe\",\n                    \"shape\": result.shape,\n                    \"columns\": list(result.columns),\n                    \"data\": result.head(50).to_dict(orient='records')\n                }\n            elif isinstance(result, pd.Series):\n                result = {\n                    \"type\": \"series\",\n                    \"data\": result.to_dict()\n                }\n            \n            output = stdout_capture.getvalue()\n            \n            logger.info(f\"\u2705 C\u00f3digo executado com sucesso\")\n            \n            return {\n                \"success\": True,\n                \"error\": None,\n                \"output\": output,\n                \"result\": result\n            }\n            \n        except Exception as e:\n            self.error_count += 1\n            error_trace = traceback.format_exc()\n            logger.error(f\"\u274c Erro na execu\u00e7\u00e3o: {e}\")\n            \n            return {\n                \"success\": False,\n                \"error\": str(e),\n                \"output\": stdout_capture.getvalue(),\n                \"traceback\": error_trace,\n                \"result\": None\n            }\n    \n    def get_stats(self) -> Dict[str, Any]:\n        \"\"\"Retorna estat\u00edsticas do interpreter.\"\"\"\n        error_rate = (self.error_count / self.execution_count * 100) if self.execution_count > 0 else 0\n        \n        return {\n            \"execution_count\": self.execution_count,\n            \"error_count\": self.error_count,\n            \"error_rate\": f\"{error_rate:.1f}%\",\n            \"timeout\": self.timeout\n        }\n\n\n# Inst\u00e2ncia global\n_interpreter: Optional[CodeInterpreter] = None\n\n\ndef get_interpreter() -> CodeInterpreter:\n    \"\"\"Retorna inst\u00e2ncia singleton do interpreter.\"\"\"\n    global _interpreter\n    if _interpreter is None:\n        _interpreter = CodeInterpreter()\n    return _interpreter", "mimetype": "text/plain", "start_char_idx": 2707, "end_char_idx": 7169, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5cc9bea4-e150-4c2a-ac22-139eaedbfdfb": {"__data__": {"id_": "5cc9bea4-e150-4c2a-ac22-139eaedbfdfb", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\code_interpreter.py", "language": "python", "lines": 276, "filename": "code_interpreter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f7089940-ac3d-4982-813b-0f1f9fcbfce0", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\code_interpreter.py", "language": "python", "lines": 276, "filename": "code_interpreter.py"}, "hash": "bb1badb949c7c267d86d089934d5c3abf9ee9546d1b4710469c1d80331321a32", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "128663cc-5953-43f4-ade9-e35d8bb51cc3", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\code_interpreter.py", "language": "python", "lines": 276, "filename": "code_interpreter.py"}, "hash": "20319efdb108253aa57b1a220a09a06cbb98df7f71501b75f1c5bd8e26f6e761", "class_name": "RelatedNodeInfo"}}, "text": "error_rate = (self.error_count / self.execution_count * 100) if self.execution_count > 0 else 0\n        \n        return {\n            \"execution_count\": self.execution_count,\n            \"error_count\": self.error_count,\n            \"error_rate\": f\"{error_rate:.1f}%\",\n            \"timeout\": self.timeout\n        }\n\n\n# Inst\u00e2ncia global\n_interpreter: Optional[CodeInterpreter] = None\n\n\ndef get_interpreter() -> CodeInterpreter:\n    \"\"\"Retorna inst\u00e2ncia singleton do interpreter.\"\"\"\n    global _interpreter\n    if _interpreter is None:\n        _interpreter = CodeInterpreter()\n    return _interpreter\n\n\n# Ferramenta LangChain para o agente\n@tool\ndef executar_codigo_python(\n    codigo: str,\n    descricao: str = \"\"\n) -> Dict[str, Any]:\n    \"\"\"\n    Executa c\u00f3digo Python para an\u00e1lise de dados.\n    \n    Use esta ferramenta quando precisar:\n    - Fazer c\u00e1lculos complexos\n    - Processar dados de forma personalizada\n    - Criar an\u00e1lises estat\u00edsticas\n    \n    Args:\n        codigo: C\u00f3digo Python a executar. Use 'df' para acessar os dados.\n        descricao: Descri\u00e7\u00e3o do que o c\u00f3digo faz\n        \n    Returns:\n        Resultado da execu\u00e7\u00e3o\n        \n    Exemplo:\n        >>> executar_codigo_python(\n        ...     codigo=\"result = df['vendas'].sum()\",\n        ...     descricao=\"Calcula soma das vendas\"\n        ... )\n    \"\"\"\n    logger.info(f\"\ud83d\udcdd Executando c\u00f3digo: {descricao or 'sem descri\u00e7\u00e3o'}\")\n    \n    interpreter = get_interpreter()\n    \n    # Carregar dados do Parquet\n    try:\n        from app.config.settings import settings\n        df = pd.read_parquet(settings.PARQUET_FILE_PATH)\n    except Exception as e:\n        logger.error(f\"Erro ao carregar dados: {e}\")\n        df = None\n    \n    result = interpreter.execute(codigo, data=df)\n    \n    if result[\"success\"]:\n        return {\n            \"sucesso\": True,\n            \"resultado\": result[\"result\"],\n            \"output\": result[\"output\"],\n            \"mensagem\": f\"C\u00f3digo executado: {descricao}\" if descricao else \"C\u00f3digo executado com sucesso\"\n        }\n    else:\n        return {\n            \"sucesso\": False,\n            \"erro\": result[\"error\"],\n            \"mensagem\": f\"Erro ao executar c\u00f3digo: {result['error']}\"\n        }", "mimetype": "text/plain", "start_char_idx": 6572, "end_char_idx": 8761, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c94c0747-d6b5-44db-9ac5-b808d103ba9d": {"__data__": {"id_": "c94c0747-d6b5-44db-9ac5-b808d103ba9d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\date_time_tools.py", "language": "python", "lines": 19, "filename": "date_time_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "207e6bfc-4554-4ae6-90cb-19f777c30ba3", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\date_time_tools.py", "language": "python", "lines": 19, "filename": "date_time_tools.py"}, "hash": "c22c4d846639c84ed167270edfa801c88dc27d891b091c85af93433ce71e0872", "class_name": "RelatedNodeInfo"}}, "text": "# core/tools/date_time_tools.py\nfrom datetime import datetime\nfrom langchain_core.tools import tool\nimport logging\n\n\n@tool\ndef get_current_datetime() -> str:\n    \"\"\"\n    Returns the current date and time.\n    \"\"\"\n    logging.info(\"Getting current date and time.\")\n    return datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n\n\ndate_time_tools = [\n    get_current_datetime,\n]", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 369, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c76e7603-27d5-4bf8-8318-fdb62264e15d": {"__data__": {"id_": "c76e7603-27d5-4bf8-8318-fdb62264e15d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\debug_server.py", "language": "python", "lines": 43, "filename": "debug_server.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "8219d331-a4fd-4480-b5d6-b507ede38e0b", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\debug_server.py", "language": "python", "lines": 43, "filename": "debug_server.py"}, "hash": "7d487cac969a5eeb02c1cf69d3e09989069fe5960b28f7d8eda0ec2ea0368489", "class_name": "RelatedNodeInfo"}}, "text": "import logging\nimport os\nimport sys\n\nfrom app.core.config import SQLALCHEMY_DATABASE_URI\n\n\"\"\"\nScript para depurar o servidor e identificar erros.\n\"\"\"\n\n# Configura\u00e7\u00e3o do logging\nlogging.basicConfig(\n    level=logging.DEBUG,\n    format=\"%(asctime)s - %(levelname)s - %(message)s\",\n    handlers=[logging.FileHandler(\"debug.log\"), logging.StreamHandler()],\n)\n\n# Adiciona o diret\u00f3rio raiz ao PATH para importa\u00e7\u00f5es relativas\nsys.path.append(os.path.dirname(os.path.abspath(__file__)))\n\ntry:\n    logging.info(\"Verificando importa\u00e7\u00f5es...\")\n\n    # Tenta importar as depend\u00eancias\n    logging.info(\"SQLDatabase importado com sucesso\")\n\n    # Verifica a configura\u00e7\u00e3o\n    logging.info(\"Verificando configura\u00e7\u00e3o...\")\n\n    if not SQLALCHEMY_DATABASE_URI:\n        logging.error(\"SQLALCHEMY_DATABASE_URI n\u00e3o est\u00e1 configurada\")\n    else:\n        logging.info(\"SQLALCHEMY_DATABASE_URI configurada\")\n\n    # Verifica as ferramentas SQL\n    logging.info(\"Verificando ferramentas SQL...\")\n    logging.info(\"Ferramentas SQL importadas com sucesso\")\n\n    logging.info(\"Verifica\u00e7\u00e3o de configura\u00e7\u00e3o e ferramentas SQL conclu\u00edda com sucesso\")\n\nexcept Exception as e:\n    logging.error(f\"Erro durante a verifica\u00e7\u00e3o: {e}\", exc_info=True)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1206, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c46dccb7-53e8-46d0-aab6-35e0eab8e048": {"__data__": {"id_": "c46dccb7-53e8-46d0-aab6-35e0eab8e048", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d1408d73-ee06-4439-b14c-1dab77a38edf", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "hash": "610c1ab0f03c4b3ce5cc12652e2b3d3b0a043e6dff30d8f13bb6c6c222e2201b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3d4b355f-6ec2-426c-805d-53a56706bbc3", "node_type": "1", "metadata": {}, "hash": "75bce5a4dec9a802c3d73a1499b0dc313e5e65a05dd370127cc5c1bca3eb5081", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nFerramenta gen\u00e9rica e flex\u00edvel para consultas ao Parquet\nPermite ao agente consultar qualquer dado de forma inteligente\n\nCORRE\u00c7\u00c3O 2024-12-13: Resolvido erro \"DataFrame constructor not properly called\"\n- Carrega Parquet diretamente (evita HybridAdapter problem\u00e1tico)\n- Serializa\u00e7\u00e3o JSON correta com .to_dict(orient='records')\n- Mapeamento case-insensitive de colunas\n\"\"\"\n\nfrom langchain_core.tools import tool\nimport pandas as pd\nimport numpy as np\nimport logging\nimport os\nfrom typing import Dict, Any, List, Optional\nfrom app.core.utils.error_handler import error_handler_decorator\n\nlogger = logging.getLogger(__name__)\n\n# Mapeamento de colunas (lowercase \u2192 original)\nCOLUMN_MAPPING = {\n    'nomesegmento': 'NOMESEGMENTO',\n    'nomefabricante': 'NOMEFABRICANTE',\n    'nomecategoria': 'NOMECATEGORIA',\n    'une': 'UNE',\n    'produto': 'PRODUTO',\n    'codigo': 'PRODUTO',\n    'nome': 'NOME',\n    'estoque_une': 'ESTOQUE_UNE',\n    'estoque_atual': 'ESTOQUE_UNE',  # Alias para estoque_atual\n    'estoque_lv': 'ESTOQUE_LV',\n    'estoque_cd': 'ESTOQUE_CD',\n    'venda_30dd': 'VENDA_30DD',\n    'venda_30_d': 'VENDA_30DD',  # Alias para venda_30_d (compatibilidade com une_tools)\n    'preco_venda': 'PRECO_VENDA',\n    'preco_custo': 'PRECO_CUSTO',\n}\n\n\ndef _safe_serialize(value):\n    \"\"\"Converte valor para JSON-safe.\"\"\"\n    if pd.isna(value) or value is None:\n        return None\n    elif isinstance(value, (np.integer, np.int64, np.int32)):\n        return int(value)\n    elif isinstance(value, (np.floating, np.float64, np.float32)):\n        return float(value) if not np.isnan(value) else None\n    elif isinstance(value, (pd.Timestamp, np.datetime64)):\n        return str(value)\n    elif isinstance(value, bytes):\n        return value.decode('utf-8', errors='ignore')\n    else:\n        return value\n\n\ndef _get_parquet_path():\n    \"\"\"Retorna caminho do arquivo Parquet.\"\"\"\n    try:\n        from app.config.settings import settings\n        return getattr(settings, 'PARQUET_FILE_PATH', None)\n    except:\n        pass\n    \n    # Fallback\n    default_path = os.path.join(os.getcwd(), 'data', 'parquet', 'admmat.parquet')\n    if os.path.exists(default_path):\n        return default_path\n    return None\n\n\ndef _find_column(df: pd.DataFrame, col_name: str) -> Optional[str]:\n    \"\"\"Encontra coluna no DataFrame (case-insensitive).\"\"\"\n    col_lower = col_name.lower()\n    \n    # Primeiro: mapeamento conhecido\n    if col_lower in COLUMN_MAPPING:\n        mapped = COLUMN_MAPPING[col_lower]\n        if mapped in df.columns:\n            return mapped\n    \n    # Segundo: busca exata\n    if col_name in df.columns:\n        return col_name\n    \n    # Terceiro: busca case-insensitive\n    for df_col in df.columns:\n        if df_col.lower() == col_lower:\n            return df_col\n    \n    return None\n\n\n@tool\n@error_handler_decorator(\n    context_func=lambda **kwargs: {\"funcao\": \"consultar_dados_flexivel\", \"params\": kwargs},\n    return_on_error={\"error\": \"Erro ao consultar dados\", \"total_resultados\": 0, \"resultados\": []}\n)\ndef consultar_dados_flexivel(\n    filtros: Optional[Dict[str, Any]] = None,\n    colunas: Optional[List[str]] = None,\n    agregacao: Optional[str] = None,\n    coluna_agregacao: Optional[str] = None,\n    agrupar_por: Optional[List[str]] = None,\n    ordenar_por: Optional[str] = None,\n    ordem_desc: bool = True,\n    limite: int = 20\n) -> Dict[str, Any]:\n    \"\"\"\n    Ferramenta GEN\u00c9RICA e FLEX\u00cdVEL para consultar dados do Parquet.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3443, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3d4b355f-6ec2-426c-805d-53a56706bbc3": {"__data__": {"id_": "3d4b355f-6ec2-426c-805d-53a56706bbc3", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d1408d73-ee06-4439-b14c-1dab77a38edf", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "hash": "610c1ab0f03c4b3ce5cc12652e2b3d3b0a043e6dff30d8f13bb6c6c222e2201b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c46dccb7-53e8-46d0-aab6-35e0eab8e048", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "hash": "8b0796ae9ce74f22b6a31c12a0c82fec598236434109e081ce45c56081f72be9", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "8d391dc4-45c8-4ce2-bf79-a8b5c3e7cc2a", "node_type": "1", "metadata": {}, "hash": "d2d72fa5ac6f09d1c5faa6abeb467ade3ddef7423741d8e9787439bf8661c9a0", "class_name": "RelatedNodeInfo"}}, "text": "@tool\n@error_handler_decorator(\n    context_func=lambda **kwargs: {\"funcao\": \"consultar_dados_flexivel\", \"params\": kwargs},\n    return_on_error={\"error\": \"Erro ao consultar dados\", \"total_resultados\": 0, \"resultados\": []}\n)\ndef consultar_dados_flexivel(\n    filtros: Optional[Dict[str, Any]] = None,\n    colunas: Optional[List[str]] = None,\n    agregacao: Optional[str] = None,\n    coluna_agregacao: Optional[str] = None,\n    agrupar_por: Optional[List[str]] = None,\n    ordenar_por: Optional[str] = None,\n    ordem_desc: bool = True,\n    limite: int = 20\n) -> Dict[str, Any]:\n    \"\"\"\n    Ferramenta GEN\u00c9RICA e FLEX\u00cdVEL para consultar dados do Parquet.\n    \n    Use esta ferramenta quando:\n    - Precisar buscar produtos por fabricante, nome, c\u00f3digo\n    - Quiser filtrar por UNE, segmento, ou qualquer campo\n    - Precisar calcular totais, m\u00e9dias, contagens\n    - Quiser agrupar dados por categoria\n    \n    Args:\n        filtros: Dicion\u00e1rio de filtros (ex: {\"nomesegmento\": \"TECIDOS\", \"une\": 261})\n        colunas: Lista de colunas a retornar (None = todas)\n        agregacao: Tipo de agrega\u00e7\u00e3o: \"sum\", \"avg\", \"count\", \"min\", \"max\"\n        coluna_agregacao: Coluna para agregar (ex: \"VENDA_30DD\", \"ESTOQUE_UNE\")\n        agrupar_por: Lista de colunas para agrupar (ex: [\"NOMEFABRICANTE\", \"UNE\"])\n        ordenar_por: Coluna para ordenar resultados\n        ordem_desc: Se True, ordem decrescente\n        limite: N\u00famero m\u00e1ximo de resultados\n    \n    Returns:\n        Dict com resultados da consulta (JSON-safe)\n    \n    Exemplos:\n        # Buscar produtos do segmento TECIDOS\n        >>> consultar_dados_flexivel(filtros={\"nomesegmento\": \"TECIDOS\"}, limite=10)\n        \n        # Total de vendas por UNE\n        >>> consultar_dados_flexivel(\n        ...     agregacao=\"sum\",\n        ...     coluna_agregacao=\"VENDA_30DD\",\n        ...     agrupar_por=[\"UNE\"]\n        ... )\n    \"\"\"\n    try:\n        logger.info(f\"\ud83d\udcca Consulta flex\u00edvel - Filtros: {filtros}, Agrega\u00e7\u00e3o: {agregacao}\")\n        \n        # 1. Carregar Parquet diretamente\n        parquet_path = _get_parquet_path()\n        if not parquet_path or not os.path.exists(parquet_path):\n            return {\n                \"error\": \"Arquivo Parquet n\u00e3o encontrado\",\n                \"total_resultados\": 0,\n                \"resultados\": []\n            }\n        \n        try:\n            df = pd.read_parquet(parquet_path)\n            logger.info(f\"\u2705 Parquet carregado: {len(df)} registros, {len(df.columns)} colunas\")\n        except Exception as e:\n            logger.error(f\"\u274c Erro ao carregar Parquet: {e}\")\n            return {\n                \"error\": f\"Erro ao carregar dados: {str(e)}\",\n                \"total_resultados\": 0,\n                \"resultados\": []\n            }\n        \n        # 2.", "mimetype": "text/plain", "start_char_idx": 2791, "end_char_idx": 5539, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8d391dc4-45c8-4ce2-bf79-a8b5c3e7cc2a": {"__data__": {"id_": "8d391dc4-45c8-4ce2-bf79-a8b5c3e7cc2a", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d1408d73-ee06-4439-b14c-1dab77a38edf", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "hash": "610c1ab0f03c4b3ce5cc12652e2b3d3b0a043e6dff30d8f13bb6c6c222e2201b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3d4b355f-6ec2-426c-805d-53a56706bbc3", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "hash": "4e38e9b1616dffe271b224dc2f85235911a42bd9b8f05d01579288eb85a11bbc", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "23e36d55-b747-40e1-9217-8b34ad32c2eb", "node_type": "1", "metadata": {}, "hash": "7d749a205f375976b489a441eb1af00306864861d8acafec6bc9160732730296", "class_name": "RelatedNodeInfo"}}, "text": "Carregar Parquet diretamente\n        parquet_path = _get_parquet_path()\n        if not parquet_path or not os.path.exists(parquet_path):\n            return {\n                \"error\": \"Arquivo Parquet n\u00e3o encontrado\",\n                \"total_resultados\": 0,\n                \"resultados\": []\n            }\n        \n        try:\n            df = pd.read_parquet(parquet_path)\n            logger.info(f\"\u2705 Parquet carregado: {len(df)} registros, {len(df.columns)} colunas\")\n        except Exception as e:\n            logger.error(f\"\u274c Erro ao carregar Parquet: {e}\")\n            return {\n                \"error\": f\"Erro ao carregar dados: {str(e)}\",\n                \"total_resultados\": 0,\n                \"resultados\": []\n            }\n        \n        # 2. Aplicar filtros\n        if filtros:\n            for col_key, val in filtros.items():\n                # Ignorar valores complexos\n                if isinstance(val, dict):\n                    continue\n                \n                # Encontrar coluna real\n                actual_col = _find_column(df, col_key)\n                if actual_col is None:\n                    logger.warning(f\"\u26a0\ufe0f Coluna '{col_key}' n\u00e3o encontrada\")\n                    continue\n                \n                # Aplicar filtro\n                if isinstance(val, str):\n                    # Filtro texto: case-insensitive contains\n                    mask = df[actual_col].astype(str).str.upper().str.contains(val.upper(), na=False)\n                    df = df[mask]\n                    logger.info(f\"Filtro texto: {actual_col} cont\u00e9m '{val}' \u2192 {len(df)} registros\")\n                else:\n                    # Filtro exato\n                    df = df[df[actual_col] == val]\n                    logger.info(f\"Filtro exato: {actual_col} == {val} \u2192 {len(df)} registros\")\n        \n        if df.empty:\n            return {\n                \"total_resultados\": 0,\n                \"resultados\": [],\n                \"mensagem\": \"Nenhum dado encontrado com os filtros aplicados.\"\n            }\n        \n        # 3. Aplicar agrega\u00e7\u00e3o\n        if agregacao and coluna_agregacao:\n            # Encontrar coluna de agrega\u00e7\u00e3o\n            agg_col = _find_column(df, coluna_agregacao)\n            if agg_col is None:\n                return {\n                    \"error\": f\"Coluna '{coluna_agregacao}' n\u00e3o encontrada\",\n                    \"colunas_disponiveis\": list(df.columns)[:15],\n                    \"total_resultados\": 0,\n                    \"resultados\": []\n                }\n            \n            if agrupar_por:\n                # Encontrar colunas de agrupamento\n                group_cols = []\n                for g in agrupar_por:\n                    gc = _find_column(df, g)\n                    if gc:\n                        group_cols.append(gc)\n                \n                if not group_cols:\n                    return {\n                        \"error\": f\"Colunas de agrupamento n\u00e3o encontradas: {agrupar_por}\",\n                        \"total_resultados\": 0,\n                        \"resultados\": []\n                    }\n                \n                # Agregar\n                agg_funcs = {\"sum\": \"sum\", \"avg\": \"mean\", \"count\": \"count\", \"min\": \"min\", \"max\": \"max\"}\n                agg_func = agg_funcs.get(agregacao, \"sum\")\n                \n                df_result = df.groupby(group_cols)[agg_col].agg(agg_func).reset_index()\n                df_result = df_result.rename(columns={agg_col: f\"{agregacao}_{coluna_agregacao}\"})\n            else:\n                # Agrega\u00e7\u00e3o simples (sem agrupamento)\n                agg_funcs = {\"sum\": df[agg_col].sum, \"avg\": df[agg_col].mean, \n                             \"count\": df[agg_col].count, \"min\": df[agg_col].min, \"max\": df[agg_col].max}\n                valor = agg_funcs.get(agregacao, df[agg_col].sum)()\n                \n                return {\n                    \"total_resultados\": 1,\n                    \"resultado_agregado\": {\n                        \"agregacao\": agregacao,\n                        \"coluna\": coluna_agregacao,\n                        \"valor\": _safe_serialize(valor)\n                    },\n                    \"mensagem\": f\"{agregacao.upper()} de {coluna_agregacao}: {_safe_serialize(valor)}\"\n                }\n        else:\n            df_result = df\n        \n        # 4. Ordenar\n        if ordenar_por:\n            sort_col = _find_column(df_result, ordenar_por)\n            if sort_col:\n                df_result = df_result.sort_values(sort_col, ascending=not ordem_desc)\n        \n        # 5.", "mimetype": "text/plain", "start_char_idx": 4789, "end_char_idx": 9297, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "23e36d55-b747-40e1-9217-8b34ad32c2eb": {"__data__": {"id_": "23e36d55-b747-40e1-9217-8b34ad32c2eb", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d1408d73-ee06-4439-b14c-1dab77a38edf", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "hash": "610c1ab0f03c4b3ce5cc12652e2b3d3b0a043e6dff30d8f13bb6c6c222e2201b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8d391dc4-45c8-4ce2-bf79-a8b5c3e7cc2a", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}, "hash": "66b376c48efabd0bf541faeda1a66602c26fe1bc399221e241d3f441b798c6e6", "class_name": "RelatedNodeInfo"}}, "text": "Ordenar\n        if ordenar_por:\n            sort_col = _find_column(df_result, ordenar_por)\n            if sort_col:\n                df_result = df_result.sort_values(sort_col, ascending=not ordem_desc)\n        \n        # 5. Limitar resultados\n        df_result = df_result.head(limite)\n        \n        # 6. \u2b50 CR\u00cdTICO: Converter para formato JSON-safe\n        # Usar to_dict + serializa\u00e7\u00e3o segura para evitar erros\n        resultados = []\n        for _, row in df_result.iterrows():\n            item = {}\n            for col in df_result.columns:\n                item[col] = _safe_serialize(row[col])\n            resultados.append(item)\n        \n        total = len(resultados)\n        logger.info(f\"\u2705 Consulta retornou {total} resultados\")\n        \n        # \u2b50 NOVO: Gerar tabela Markdown para o LLM incluir na resposta\n        mensagem_tabela = f\"{total} resultado(s) encontrado(s)\"\n        \n        if total > 0 and total <= 50:  # S\u00f3 gerar tabela para at\u00e9 50 resultados\n            # Selecionar colunas mais relevantes para exibir\n            colunas_exibir = []\n            colunas_prioritarias = ['PRODUTO', 'NOME', 'VENDA_30DD', 'ESTOQUE_UNE', 'NOMESEGMENTO', 'NOMEFABRICANTE', 'UNE']\n            \n            # Adicionar colunas priorit\u00e1rias que existem nos dados\n            for col in colunas_prioritarias:\n                if col in df_result.columns:\n                    colunas_exibir.append(col)\n            \n            # Se n\u00e3o temos colunas priorit\u00e1rias, pegar as primeiras 5\n            if not colunas_exibir:\n                colunas_exibir = list(df_result.columns)[:5]\n            \n            # Limitar a 6 colunas para n\u00e3o ficar muito largo\n            colunas_exibir = colunas_exibir[:6]\n            \n            # Gerar tabela Markdown\n            mensagem_tabela = f\"Aqui est\u00e3o os {total} resultados:\\n\\n\"\n            \n            # Cabe\u00e7alho\n            mensagem_tabela += \"| \" + \" | \".join(colunas_exibir) + \" |\\n\"\n            mensagem_tabela += \"|\" + \"|\".join([\"---\" for _ in colunas_exibir]) + \"|\\n\"\n            \n            # Linhas de dados\n            for item in resultados:\n                valores = []\n                for col in colunas_exibir:\n                    val = item.get(col, \"\")\n                    # Formatar valor\n                    if val is None or val == \"\":\n                        val_str = \"-\"\n                    elif isinstance(val, float):\n                        val_str = f\"{val:.2f}\"\n                    else:\n                        val_str = str(val)\n                    # Truncar se muito longo\n                    if len(val_str) > 30:\n                        val_str = val_str[:27] + \"...\"\n                    valores.append(val_str)\n                mensagem_tabela += \"| \" + \" | \".join(valores) + \" |\\n\"\n        \n        return {\n            \"total_resultados\": total,\n            \"resultados\": resultados,\n            \"limite_aplicado\": limite,\n            \"mensagem\": mensagem_tabela\n        }\n        \n    except Exception as e:\n        logger.error(f\"\u274c Erro em consultar_dados_flexivel: {e}\", exc_info=True)\n        return {\n            \"error\": f\"Erro na consulta: {str(e)}\",\n            \"total_resultados\": 0,\n            \"resultados\": [],\n            \"mensagem\": \"Ocorreu um erro ao processar sua consulta.\"\n        }\n\n\n# Exportar ferramenta\n__all__ = ['consultar_dados_flexivel']", "mimetype": "text/plain", "start_char_idx": 9073, "end_char_idx": 12426, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3d5381e4-212a-4b8c-b84d-433093088c71": {"__data__": {"id_": "3d5381e4-212a-4b8c-b84d-433093088c71", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\graph_integration.py", "language": "python", "lines": 147, "filename": "graph_integration.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2aa4c010-8271-4f68-b5ec-f2d43ae8ce3b", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\graph_integration.py", "language": "python", "lines": 147, "filename": "graph_integration.py"}, "hash": "c33f702e0e1c8b9237eb2000b0b712781ca9a8b74a099178b823791886159beb", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "a2c5f4a4-138c-44a6-b598-d6580b1cb954", "node_type": "1", "metadata": {}, "hash": "9b8eca1266c1aec19bbb48c7f7faeabd56cbcb4cd1bf5d3980936e0a473ec61a", "class_name": "RelatedNodeInfo"}}, "text": "import logging\nimport os\nfrom typing import Any, Dict\n\nimport pandas as pd\n\nfrom app.core.tools.visualization_tools import generate_plotly_chart_code\n\n# Importa as funcionalidades de visualiza\u00e7\u00e3o existentes\n\n# Importa a fun\u00e7\u00e3o de processamento de gr\u00e1ficos do novo m\u00f3dulo\n\n# Configura\u00e7\u00e3o de logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format=\"%(asctime)s - %(name)s - %(levelname)s - %(message)s\",\n    filename=\"logs/graph_integration.log\",\n    filemode=\"a\",\n)\nlogger = logging.getLogger(\"graph_integration\")\n\n# Diret\u00f3rio para salvar gr\u00e1ficos do agente_visual\nPLOT_DIR = \"outputs/plots\"\nos.makedirs(PLOT_DIR, exist_ok=True)\n\n# Diret\u00f3rio para salvar gr\u00e1ficos do sistema existente\nCHART_OUTPUT_DIR = os.path.join(\n    os.path.dirname(os.path.dirname(os.path.dirname(__file__))), \"generated_charts\"\n)\nos.makedirs(CHART_OUTPUT_DIR, exist_ok=True)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 854, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a2c5f4a4-138c-44a6-b598-d6580b1cb954": {"__data__": {"id_": "a2c5f4a4-138c-44a6-b598-d6580b1cb954", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\graph_integration.py", "language": "python", "lines": 147, "filename": "graph_integration.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2aa4c010-8271-4f68-b5ec-f2d43ae8ce3b", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\graph_integration.py", "language": "python", "lines": 147, "filename": "graph_integration.py"}, "hash": "c33f702e0e1c8b9237eb2000b0b712781ca9a8b74a099178b823791886159beb", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3d5381e4-212a-4b8c-b84d-433093088c71", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\graph_integration.py", "language": "python", "lines": 147, "filename": "graph_integration.py"}, "hash": "e399a1a07a4c2ce5cbfa43ad300602993d4f23c8a1f27dc1225aed729278e3fc", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "6b44ffbe-6515-4a6d-ad59-88fa05b4ee82", "node_type": "1", "metadata": {}, "hash": "348ecd5e024a1651d5a25f60937e6d7af8c4b6a037cbf95952fe516624bb32af", "class_name": "RelatedNodeInfo"}}, "text": "def processar_resposta_com_grafico(resposta: Any) -> Dict[str, Any]:\n    \"\"\"\n    Processa a resposta do agente e gera gr\u00e1fico se apropriado,\n    integrando as funcionalidades do agente_visual.py com o sistema existente.\n\n    Args:\n        resposta: Resposta do agente (pode ser dict, string ou objeto)\n\n    Returns:\n        Dict com a resposta processada e caminho do gr\u00e1fico se gerado\n    \"\"\"\n    try:\n        # Converte para formato padr\u00e3o se n\u00e3o for um dicion\u00e1rio\n        if not isinstance(resposta, dict):\n            resultado = {\"output\": str(resposta), \"type\": \"text\"}\n        else:\n            resultado = resposta\n\n        # Extrai o texto da resposta\n        texto = resultado.get(\"output\", str(resposta))\n\n        # Verifica se h\u00e1 inten\u00e7\u00e3o de visualizar gr\u00e1fico\n        termos_grafico = [\n            \"gr\u00e1fico\",\n            \"visualizar\",\n            \"tend\u00eancia\",\n            \"mostrar gr\u00e1fico\",\n            \"exibir gr\u00e1fico\",\n        ]\n        if any(termo in texto.lower() for termo in termos_grafico):\n            # Tenta obter DataFrame da resposta\n            df = None\n\n            # Verifica se h\u00e1 um DataFrame na resposta\n            if hasattr(resposta, \"result\") and isinstance(\n                resposta.result, pd.DataFrame\n            ):\n                df = resposta.result\n            elif isinstance(resposta, dict):\n                if \"result\" in resposta and isinstance(\n                    resposta[\"result\"], pd.DataFrame\n                ):\n                    df = resposta[\"result\"]\n                elif \"data\" in resposta and isinstance(resposta[\"data\"], list):\n                    df = pd.DataFrame(resposta[\"data\"])\n                elif \"output\" in resposta and isinstance(resposta[\"output\"], list):\n                    df = pd.DataFrame(resposta[\"output\"])\n\n            # Se encontrou dados, gera o gr\u00e1fico\n            if df is not None and not df.empty:\n                # Tenta gerar o gr\u00e1fico usando o agente_visual\n                # Importa dinamicamente a fun\u00e7\u00e3o gerar_grafico para evitar importa\u00e7\u00e3o circular\n                try:\n                    from agente_visual import gerar_grafico\n\n                    caminho_grafico = gerar_grafico(df, \"Visualiza\u00e7\u00e3o de Dados\")\n                except ImportError as e:\n                    logger.error(f\"Erro ao importar fun\u00e7\u00e3o gerar_grafico: {e}\")\n                    caminho_grafico = None\n\n                if caminho_grafico:\n                    # Adiciona o caminho do gr\u00e1fico \u00e0 resposta\n                    resultado[\"chart\"] = caminho_grafico\n                    resultado[\"chart_type\"] = \"matplotlib\"\n                    resultado[\"output\"] = (\n                        f\"{texto}\\n\\n\ud83d\uddbc\ufe0f Gr\u00e1fico gerado: {caminho_grafico}\"\n                    )\n\n                    logger.info(f\"Gr\u00e1fico gerado com matplotlib: {caminho_grafico}\")\n                    return resultado\n                else:\n                    # Fallback: tenta gerar com Plotly se o matplotlib falhar\n                    try:\n                        # Gera c\u00f3digo para o gr\u00e1fico Plotly\n                        chart_description = \"Gerar visualiza\u00e7\u00e3o dos dados fornecidos\"\n                        plotly_code = generate_plotly_chart_code(df, chart_description)\n\n                        # Executa o c\u00f3digo e salva o gr\u00e1fico\n                        chart_result = execute_chart_code_and_save(plotly_code)\n\n                        if \"Gr\u00e1fico gerado e salvo com sucesso\" in chart_result:\n                            # Extrai o caminho do gr\u00e1fico da mensagem\n                            caminho = chart_result.split(\"sucesso em: \")[1]\n                            resultado[\"chart\"] = caminho\n                            resultado[\"chart_type\"] = \"plotly\"\n                            resultado[\"output\"] = (\n                                f\"{texto}\\n\\n\ud83d\uddbc\ufe0f Gr\u00e1fico gerado: {caminho}\"\n                            )\n\n                            logger.info(f\"Gr\u00e1fico gerado com Plotly: {caminho}\")\n                            return resultado\n                    except Exception as e:\n                        logger.error(f\"Erro ao gerar gr\u00e1fico com Plotly: {e}\")\n\n            # Se chegou aqui, n\u00e3o conseguiu gerar o gr\u00e1fico\n            resultado[\"output\"] = (\n                f\"{texto}\\n\\n\u26a0\ufe0f N\u00e3o foi poss\u00edvel gerar um gr\u00e1fico com os dados fornecidos.\"\n            )\n            return resultado\n\n        # Se n\u00e3o h\u00e1 inten\u00e7\u00e3o de gr\u00e1fico, retorna a resposta original\n        return resultado\n\n    except Exception as e:\n        logger.error(f\"Erro ao processar resposta com gr\u00e1fico: {e}\")\n        return {\n            \"output\": f\"{str(resposta)}\\n\\n\u26a0\ufe0f Erro ao processar gr\u00e1fico: {e}\",\n            \"error\": str(e),\n        }", "mimetype": "text/plain", "start_char_idx": 857, "end_char_idx": 5523, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6b44ffbe-6515-4a6d-ad59-88fa05b4ee82": {"__data__": {"id_": "6b44ffbe-6515-4a6d-ad59-88fa05b4ee82", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\graph_integration.py", "language": "python", "lines": 147, "filename": "graph_integration.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2aa4c010-8271-4f68-b5ec-f2d43ae8ce3b", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\graph_integration.py", "language": "python", "lines": 147, "filename": "graph_integration.py"}, "hash": "c33f702e0e1c8b9237eb2000b0b712781ca9a8b74a099178b823791886159beb", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "a2c5f4a4-138c-44a6-b598-d6580b1cb954", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\graph_integration.py", "language": "python", "lines": 147, "filename": "graph_integration.py"}, "hash": "c4d1af2cd6eda851557e2957eadfe60b9a86d7b5ce3baa89fc04d9273ec631de", "class_name": "RelatedNodeInfo"}}, "text": "if __name__ == \"__main__\":\n    print(\"Rodando como script...\")\n    # TODO: Adicionar chamada a uma fun\u00e7\u00e3o principal se necess\u00e1rio", "mimetype": "text/plain", "start_char_idx": 5526, "end_char_idx": 5655, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8ffd2447-76ce-4cf2-ba91-08447d0805c0": {"__data__": {"id_": "8ffd2447-76ce-4cf2-ba91-08447d0805c0", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_parquet_tools.py", "language": "python", "lines": 115, "filename": "mcp_parquet_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "85e1f88b-9db1-4d48-a6eb-f6da51cddb31", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_parquet_tools.py", "language": "python", "lines": 115, "filename": "mcp_parquet_tools.py"}, "hash": "4bdbd1a046332b6255e4c0f1359df6c264143fd76e6597a46476213561ef3a33", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "a16124ec-0ed0-44bf-b9d2-de7ebc02735d", "node_type": "1", "metadata": {}, "hash": "b72ce1840b0dd13fcf5920dd491960146a2c15d7e5b9e60a2b45dc0394ed7b59", "class_name": "RelatedNodeInfo"}}, "text": "# core/tools/mcp_sql_server_tools.py\nimport os\nimport pandas as pd\nfrom typing import Dict, Any\nfrom langchain_core.tools import tool\nimport logging\n\n# Caminho para o arquivo Parquet - Fonte \u00fanica: Filial_Madureira\nPARQUET_DIR = os.path.join(os.path.dirname(__file__), \"..\", \"..\", \"data\", \"parquet\")\nFILIAL_MADUREIRA_PATH = os.path.join(PARQUET_DIR, \"Filial_Madureira.parquet\")\n\n\n@tool\ndef get_product_data(product_code: str) -> Dict[str, Any]:\n    \"\"\"Busca dados de um produto em Filial_Madureira.parquet.\"\"\"\n    logging.info(f\"Buscando produto: {product_code}\")\n\n    try:\n        if not os.path.exists(FILIAL_MADUREIRA_PATH):\n            logging.error(f\"Arquivo n\u00e3o encontrado: {FILIAL_MADUREIRA_PATH}\")\n            return {\"error\": \"Fonte de dados n\u00e3o encontrada.\"}\n\n        df = pd.read_parquet(FILIAL_MADUREIRA_PATH)\n\n        # Converter para string se a coluna de c\u00f3digo existir\n        if \"CODIGO\" in df.columns:\n            df[\"CODIGO\"] = df[\"CODIGO\"].astype(str)\n            product_code = str(product_code)\n            product_info = df[df[\"CODIGO\"] == product_code]\n        elif \"codigo\" in df.columns:\n            df[\"codigo\"] = df[\"codigo\"].astype(str)\n            product_code = str(product_code)\n            product_info = df[df[\"codigo\"] == product_code]\n        else:\n            return {\"error\": \"Coluna de c\u00f3digo n\u00e3o encontrada.\"}\n\n        if product_info.empty:\n            return {\"data\": f\"Produto n\u00e3o encontrado: {product_code}\"}\n\n        return {\"data\": product_info.to_dict(orient=\"records\")}\n\n    except Exception as e:\n        logging.error(f\"Erro ao buscar produto: {e}\", exc_info=True)\n        return {\"error\": f\"Erro ao buscar dados: {e}\"}\n\n\n@tool\ndef get_product_stock(product_id: int) -> Dict[str, Any]:\n    \"\"\"Retorna dados de um produto espec\u00edfico em Filial_Madureira.\"\"\"\n    logging.info(f\"Buscando dados do produto: {product_id}\")\n    try:\n        if not os.path.exists(FILIAL_MADUREIRA_PATH):\n            logging.error(f\"Arquivo n\u00e3o encontrado: {FILIAL_MADUREIRA_PATH}\")\n            return {\"error\": \"Fonte de dados n\u00e3o encontrada.\"}\n\n        df = pd.read_parquet(FILIAL_MADUREIRA_PATH)\n\n        product_stock_info = df[df[\"PRODUTO\"] == product_id_str]\n\n        if product_stock_info.empty:\n            return {\"data\": f\"Nenhum produto encontrado com o ID {product_id}.\"}\n\n        # Assumindo que a coluna de estoque se chama 'ESTOQUE'\n        stock = product_stock_info[\"ESTOQUE\"].iloc[\n            0\n        ]  # Pega o primeiro valor de estoque encontrado\n        return {\"data\": {\"product_id\": product_id, \"stock\": stock}}\n\n    except Exception as e:\n        logging.error(f\"Erro ao buscar estoque do produto: {e}\", exc_info=True)\n        return {\n            \"error\": f\"Ocorreu um erro inesperado ao buscar o estoque do produto: {e}\"\n        }", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2785, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a16124ec-0ed0-44bf-b9d2-de7ebc02735d": {"__data__": {"id_": "a16124ec-0ed0-44bf-b9d2-de7ebc02735d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_parquet_tools.py", "language": "python", "lines": 115, "filename": "mcp_parquet_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "85e1f88b-9db1-4d48-a6eb-f6da51cddb31", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_parquet_tools.py", "language": "python", "lines": 115, "filename": "mcp_parquet_tools.py"}, "hash": "4bdbd1a046332b6255e4c0f1359df6c264143fd76e6597a46476213561ef3a33", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8ffd2447-76ce-4cf2-ba91-08447d0805c0", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_parquet_tools.py", "language": "python", "lines": 115, "filename": "mcp_parquet_tools.py"}, "hash": "810c080a01ca227fdf6ea00932db075a10101705f63677b65d9933ab29a6ba0a", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef list_product_categories() -> Dict[str, Any]:\n    \"\"\"\n    Retorna uma lista de todas as categorias de produtos dispon\u00edveis no arquivo Parquet 'Filial_Madureira.parquet'.\n    \"\"\"\n    logging.info(\n        \"Listando categorias de produtos do arquivo Parquet 'Filial_Madureira.parquet'.\"\n    )\n    try:\n        if not os.path.exists(FILIAL_MADUREIRA_PATH):\n            logging.error(f\"Arquivo Parquet n\u00e3o encontrado em: {FILIAL_MADUREIRA_PATH}\")\n            return {\n                \"error\": \"Fonte de dados de produtos (Filial_Madureira.parquet) n\u00e3o encontrada.\"\n            }\n\n        df = pd.read_parquet(FILIAL_MADUREIRA_PATH)\n\n        # Assumindo que a coluna de categoria se chama 'CATEGORIA'\n        if \"CATEGORIA\" not in df.columns:\n            return {\n                \"error\": \"Coluna 'CATEGORIA' n\u00e3o encontrada no arquivo Filial_Madureira.parquet.\"\n            }\n\n        categories = df[\"CATEGORIA\"].unique().tolist()\n        return {\"data\": {\"categories\": categories}}\n\n    except Exception as e:\n        logging.error(f\"Erro ao listar categorias de produtos: {e}\", exc_info=True)\n        return {\n            \"error\": f\"Ocorreu um erro inesperado ao listar categorias de produtos: {e}\"\n        }\n\n\n# A lista de ferramentas agora reflete a nova arquitetura.\nsql_tools = [\n    get_product_data,\n    get_product_stock,\n    list_product_categories,\n]", "mimetype": "text/plain", "start_char_idx": 2788, "end_char_idx": 4154, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7fb646e6-21c1-4899-9802-0c9412a64966": {"__data__": {"id_": "7fb646e6-21c1-4899-9802-0c9412a64966", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_sql_server_tools.py", "language": "python", "lines": 122, "filename": "mcp_sql_server_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0b825a90-3ed8-40a4-af6f-a23526a54c6f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_sql_server_tools.py", "language": "python", "lines": 122, "filename": "mcp_sql_server_tools.py"}, "hash": "df56e9ab2a37eef977fffe4a6423a2c39faa3d62dabc3c9086de072bd61d28d0", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "4f76b6ef-7f7c-493b-be7b-93e232b1fcd4", "node_type": "1", "metadata": {}, "hash": "5299f9fb4455361d7562466545e66512a18a781373c09f2b2c637b74a5aa821f", "class_name": "RelatedNodeInfo"}}, "text": "# core/tools/mcp_sql_server_tools.py\nimport os\nimport pandas as pd\nfrom typing import Dict, Any\nfrom langchain_core.tools import tool\nimport logging\n\n# Caminho \u00fanico para Filial_Madureira\nPARQUET_DIR = os.path.join(os.path.dirname(__file__), \"..\", \"..\", \"data\", \"parquet\")\nFILIAL_MADUREIRA_PATH = os.path.join(PARQUET_DIR, \"Filial_Madureira.parquet\")\n\n\n@tool\ndef get_product_data(product_code: str) -> Dict[str, Any]:\n    \"\"\"Busca dados de um produto em Filial_Madureira.parquet.\"\"\"\n    logging.info(f\"Buscando produto: {product_code}\")\n\n    try:\n        if not os.path.exists(FILIAL_MADUREIRA_PATH):\n            logging.error(f\"Arquivo n\u00e3o encontrado: {FILIAL_MADUREIRA_PATH}\")\n            return {\"error\": \"Fonte de dados n\u00e3o encontrada.\"}\n\n        df = pd.read_parquet(FILIAL_MADUREIRA_PATH)\n\n        # Procurar coluna de c\u00f3digo (CODIGO ou codigo)\n        codigo_col = None\n        if \"CODIGO\" in df.columns:\n            codigo_col = \"CODIGO\"\n        elif \"codigo\" in df.columns:\n            codigo_col = \"codigo\"\n\n        if not codigo_col:\n            return {\"error\": \"Coluna de c\u00f3digo n\u00e3o encontrada.\"}\n\n        df[codigo_col] = df[codigo_col].astype(str)\n        product_code = str(product_code)\n        product_info = df[df[codigo_col] == product_code]\n\n        if product_info.empty:\n            return {\"data\": f\"Produto n\u00e3o encontrado: {product_code}\"}\n\n        return {\"data\": product_info.to_dict(orient=\"records\")}\n\n    except Exception as e:\n        logging.error(f\"Erro ao buscar produto: {e}\", exc_info=True)\n        return {\"error\": f\"Erro ao buscar dados: {e}\"}\n\n\n@tool\ndef get_product_stock(product_id: int) -> Dict[str, Any]:\n    \"\"\"Retorna dados de um produto em Filial_Madureira.\"\"\"\n    logging.info(f\"Buscando produto: {product_id}\")\n    try:\n        if not os.path.exists(FILIAL_MADUREIRA_PATH):\n            logging.error(f\"Arquivo n\u00e3o encontrado: {FILIAL_MADUREIRA_PATH}\")\n            return {\"error\": \"Fonte de dados n\u00e3o encontrada.\"}\n\n        df = pd.read_parquet(FILIAL_MADUREIRA_PATH)\n\n        # Procurar coluna de c\u00f3digo\n        codigo_col = None\n        if \"CODIGO\" in df.columns:\n            codigo_col = \"CODIGO\"\n        elif \"codigo\" in df.columns:\n            codigo_col = \"codigo\"\n\n        if not codigo_col:\n            return {\"error\": \"Coluna de c\u00f3digo n\u00e3o encontrada.\"}\n\n        df[codigo_col] = df[codigo_col].astype(str)\n        product_id_str = str(product_id)\n        product_info = df[df[codigo_col] == product_id_str]\n\n        if product_info.empty:\n            return {\"data\": f\"Produto n\u00e3o encontrado: {product_id}\"}\n\n        return {\"data\": product_info.to_dict(orient=\"records\")}\n\n    except Exception as e:\n        logging.error(f\"Erro ao buscar produto: {e}\", exc_info=True)\n        return {\"error\": f\"Erro ao buscar dados: {e}\"}\n\n\n@tool\ndef list_product_categories() -> Dict[str, Any]:\n    \"\"\"Lista categorias dispon\u00edveis em Filial_Madureira.\"\"\"\n    logging.info(\"Listando categorias...\")\n    try:\n        if not os.path.exists(FILIAL_MADUREIRA_PATH):\n            logging.error(f\"Arquivo n\u00e3o encontrado: {FILIAL_MADUREIRA_PATH}\")\n            return {\"error\": \"Fonte de dados n\u00e3o encontrada.\"}\n\n        df = pd.read_parquet(FILIAL_MADUREIRA_PATH)\n\n        # Procurar coluna de categoria\n        cat_col = None\n        for col in df.columns:\n            if \"categoria\" in col.lower() or \"category\" in col.lower():\n                cat_col = col\n                break\n\n        if not cat_col and \"CATEGORIA\" in df.columns:\n            cat_col = \"CATEGORIA\"\n\n        if not cat_col:\n            return {\"error\": \"Coluna de categoria n\u00e3o encontrada.\"}\n\n        categories = df[cat_col].unique().tolist()\n        return {\"data\": {\"categories\": categories}}\n\n    except Exception as e:\n        logging.error(f\"Erro ao listar categorias: {e}\", exc_info=True)\n        return {\"error\": f\"Erro: {e}\"}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3843, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "4f76b6ef-7f7c-493b-be7b-93e232b1fcd4": {"__data__": {"id_": "4f76b6ef-7f7c-493b-be7b-93e232b1fcd4", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_sql_server_tools.py", "language": "python", "lines": 122, "filename": "mcp_sql_server_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0b825a90-3ed8-40a4-af6f-a23526a54c6f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_sql_server_tools.py", "language": "python", "lines": 122, "filename": "mcp_sql_server_tools.py"}, "hash": "df56e9ab2a37eef977fffe4a6423a2c39faa3d62dabc3c9086de072bd61d28d0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "7fb646e6-21c1-4899-9802-0c9412a64966", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_sql_server_tools.py", "language": "python", "lines": 122, "filename": "mcp_sql_server_tools.py"}, "hash": "2f3a43a38a384b2a5ee4f70c833ce486cf74549de4cca2d102b1dfff2c4a939e", "class_name": "RelatedNodeInfo"}}, "text": "# Lista de ferramentas\nsql_tools = [\n    get_product_data,\n    get_product_stock,\n    list_product_categories,\n]", "mimetype": "text/plain", "start_char_idx": 3846, "end_char_idx": 3958, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "fb4a4e92-f9dd-43ce-a6b2-afcb3558b99b": {"__data__": {"id_": "fb4a4e92-f9dd-43ce-a6b2-afcb3558b99b", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\quick_response.py", "language": "python", "lines": 159, "filename": "quick_response.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7edff531-f9a2-445d-b3fe-fefce6ea1469", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\quick_response.py", "language": "python", "lines": 159, "filename": "quick_response.py"}, "hash": "3e90ad5b32da2c0592cc11931f91ccd1a0aee8671306db63f9c28e45e1ec5d02", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "45a01ac8-94aa-4c16-a48b-5d10fff9b419", "node_type": "1", "metadata": {}, "hash": "a28174bd41bee6092ad934d99dd97acc278290aa4804cc2995984959a9411199", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSistema de Resposta R\u00e1pida (Quick Response)\nResponde consultas simples SEM usar o LLM para performance m\u00e1xima.\n\nTempo de resposta: < 500ms\nTaxa de acerto: 95%+\n\"\"\"\n\nimport re\nimport logging\nfrom typing import Optional, Union\nimport polars as pl\n\nlogger = logging.getLogger(__name__)\n\n\nclass QuickResponseSystem:\n    \"\"\"Sistema de resposta r\u00e1pida para consultas simples.\"\"\"\n\n    def __init__(self, df: Union[pl.DataFrame, pl.LazyFrame]):\n        # \u2705 OTIMIZA\u00c7\u00c3O: Usar Polars LazyFrame para queries eficientes\n        if isinstance(df, pl.LazyFrame):\n            self.df = df\n        else:\n            self.df = df.lazy()\n        self.logger = logger\n        \n    def try_quick_response(self, query: str) -> Optional[str]:\n        \"\"\"\n        Tenta responder rapidamente sem LLM.\n\n        Args:\n            query: Pergunta do usu\u00e1rio\n\n        Returns:\n            Resposta formatada ou None se n\u00e3o conseguir responder\n        \"\"\"\n        query_lower = query.lower()\n\n        # Extrair c\u00f3digo do produto\n        codigo = self._extract_product_code(query_lower)\n        if not codigo:\n            return None\n\n        # \u2705 Buscar produto usando Polars (eficiente)\n        produto = self.df.filter(pl.col('PRODUTO') == codigo).collect()\n        if produto.height == 0:\n            return f\"\u274c Produto **{codigo}** n\u00e3o encontrado na base de dados.\"\n\n        produto_data = produto.row(0, named=True)\n        \n        # PRE\u00c7O\n        if any(word in query_lower for word in ['pre\u00e7o', 'preco', 'valor', 'custa', 'quanto']):\n            return self._format_price_response(codigo, produto_data)\n        \n        # ESTOQUE\n        if any(word in query_lower for word in ['estoque', 'saldo', 'quantidade', 'tem']):\n            return self._format_stock_response(codigo, produto_data)\n        \n        # FABRICANTE\n        if any(word in query_lower for word in ['fabricante', 'marca', 'quem fabrica']):\n            return self._format_manufacturer_response(codigo, produto_data)\n        \n        # NOME/DESCRI\u00c7\u00c3O\n        if any(word in query_lower for word in ['nome', 'descri\u00e7\u00e3o', 'descricao', 'o que \u00e9', 'qual \u00e9']):\n            return self._format_name_response(codigo, produto_data)\n        \n        # VENDAS\n        if any(word in query_lower for word in ['vendas', 'vendeu', 'venda']):\n            return self._format_sales_response(codigo, produto_data)\n        \n        return None  # Deixa o LLM processar\n    \n    def _extract_product_code(self, query: str) -> Optional[int]:\n        \"\"\"Extrai c\u00f3digo do produto da query.\"\"\"\n        # Padr\u00f5es: \"produto 123\", \"c\u00f3digo 123\", \"item 123\", \"123\"\n        patterns = [\n            r'produto\\s+(\\d+)',\n            r'c\u00f3digo\\s+(\\d+)',\n            r'codigo\\s+(\\d+)',\n            r'item\\s+(\\d+)',\n            r'\\b(\\d{4,})\\b',  # N\u00famero com 4+ d\u00edgitos\n        ]\n        \n        for pattern in patterns:\n            match = re.search(pattern, query)\n            if match:\n                try:\n                    return int(match.group(1))\n                except:\n                    continue\n        \n        return None\n    \n    def _format_price_response(self, codigo: int, produto: dict) -> str:\n        \"\"\"Formata resposta de pre\u00e7o.\"\"\"\n        try:\n            preco = float(produto['LIQUIDO_38'])\n            nome = str(produto.get('NOME', 'N/A'))[:50]\n            return f\"\ud83d\udcb0 O pre\u00e7o do produto **{codigo}** ({nome}) \u00e9 **R$ {preco:.2f}**.\"\n        except:\n            return f\"\u26a0\ufe0f Pre\u00e7o do produto **{codigo}** n\u00e3o dispon\u00edvel.\"\n\n    def _format_stock_response(self, codigo: int, produto: dict) -> str:\n        \"\"\"Formata resposta de estoque.\"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3583, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "45a01ac8-94aa-4c16-a48b-5d10fff9b419": {"__data__": {"id_": "45a01ac8-94aa-4c16-a48b-5d10fff9b419", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\quick_response.py", "language": "python", "lines": 159, "filename": "quick_response.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7edff531-f9a2-445d-b3fe-fefce6ea1469", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\quick_response.py", "language": "python", "lines": 159, "filename": "quick_response.py"}, "hash": "3e90ad5b32da2c0592cc11931f91ccd1a0aee8671306db63f9c28e45e1ec5d02", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "fb4a4e92-f9dd-43ce-a6b2-afcb3558b99b", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\quick_response.py", "language": "python", "lines": 159, "filename": "quick_response.py"}, "hash": "997d815b0997f2edaae519a68d5f20610dbfd7c49adea68fdbb3e7911f827d3b", "class_name": "RelatedNodeInfo"}}, "text": "try:\n            preco = float(produto['LIQUIDO_38'])\n            nome = str(produto.get('NOME', 'N/A'))[:50]\n            return f\"\ud83d\udcb0 O pre\u00e7o do produto **{codigo}** ({nome}) \u00e9 **R$ {preco:.2f}**.\"\n        except:\n            return f\"\u26a0\ufe0f Pre\u00e7o do produto **{codigo}** n\u00e3o dispon\u00edvel.\"\n\n    def _format_stock_response(self, codigo: int, produto: dict) -> str:\n        \"\"\"Formata resposta de estoque.\"\"\"\n        try:\n            estoque = int(float(produto['ESTOQUE_UNE']))\n            nome = str(produto.get('NOME', 'N/A'))[:50]\n\n            if estoque > 100:\n                emoji = \"\u2705\"\n                status = \"Estoque bom\"\n            elif estoque > 10:\n                emoji = \"\u26a0\ufe0f\"\n                status = \"Estoque baixo\"\n            else:\n                emoji = \"\ud83d\udd34\"\n                status = \"Estoque cr\u00edtico\"\n\n            return f\"{emoji} O produto **{codigo}** ({nome}) tem **{estoque} unidades** em estoque. {status}.\"\n        except:\n            return f\"\u26a0\ufe0f Estoque do produto **{codigo}** n\u00e3o dispon\u00edvel.\"\n\n    def _format_manufacturer_response(self, codigo: int, produto: dict) -> str:\n        \"\"\"Formata resposta de fabricante.\"\"\"\n        try:\n            fabricante = str(produto['NOMEFABRICANTE'])\n            nome = str(produto.get('NOME', 'N/A'))[:50]\n            return f\"\ud83c\udfed O fabricante do produto **{codigo}** ({nome}) \u00e9 **{fabricante}**.\"\n        except:\n            return f\"\u26a0\ufe0f Fabricante do produto **{codigo}** n\u00e3o dispon\u00edvel.\"\n\n    def _format_name_response(self, codigo: int, produto: dict) -> str:\n        \"\"\"Formata resposta de nome/descri\u00e7\u00e3o.\"\"\"\n        try:\n            nome = str(produto['NOME'])\n            fabricante = str(produto.get('NOMEFABRICANTE', 'N/A'))\n            return f\"\ud83d\udce6 O produto **{codigo}** \u00e9: **{nome}** (Fabricante: {fabricante}).\"\n        except:\n            return f\"\u26a0\ufe0f Informa\u00e7\u00f5es do produto **{codigo}** n\u00e3o dispon\u00edveis.\"\n\n    def _format_sales_response(self, codigo: int, produto: dict) -> str:\n        \"\"\"Formata resposta de vendas.\"\"\"\n        try:\n            vendas_30d = float(produto.get('VENDA_30DD', 0))\n            nome = str(produto.get('NOME', 'N/A'))[:50]\n\n            if vendas_30d > 0:\n                return f\"\ud83d\udcca O produto **{codigo}** ({nome}) vendeu **{vendas_30d:.0f} unidades** nos \u00faltimos 30 dias.\"\n            else:\n                return f\"\ud83d\udcca O produto **{codigo}** ({nome}) n\u00e3o teve vendas nos \u00faltimos 30 dias.\"\n        except:\n            return f\"\u26a0\ufe0f Dados de vendas do produto **{codigo}** n\u00e3o dispon\u00edveis.\"\n\n\ndef create_quick_response_system(df: Union[pl.DataFrame, pl.LazyFrame]) -> QuickResponseSystem:\n    \"\"\"Factory function para criar o sistema de resposta r\u00e1pida.\"\"\"\n    return QuickResponseSystem(df)", "mimetype": "text/plain", "start_char_idx": 3183, "end_char_idx": 5868, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3f2f0192-39ad-4774-933b-ecc2764025e2": {"__data__": {"id_": "3f2f0192-39ad-4774-933b-ecc2764025e2", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\sql_server_tools.py", "language": "python", "lines": 357, "filename": "sql_server_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ac39ce31-2917-4938-b1cf-f30ddf5ecc5f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\sql_server_tools.py", "language": "python", "lines": 357, "filename": "sql_server_tools.py"}, "hash": "411c12c6755a98addc3ad480a37cdb01c90a0da67f47c5f466395a1987c056e5", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "33a45088-0f20-4977-90ca-42d2a7f1c529", "node_type": "1", "metadata": {}, "hash": "fdc198942c19595e46e3658c6c26900c39b7180f2840d052ab7ba820f89648a6", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nFerramentas para executar consultas SQL Server atrav\u00e9s do agente.\nIntegra\u00e7\u00e3o direta com o banco de dados para respostas em tempo real.\n\"\"\"\n\nimport logging\nfrom typing import Dict, Any\nfrom langchain_core.tools import tool\nfrom app.core.database.database import get_db_manager\nfrom sqlalchemy import text\n\nlogger = logging.getLogger(__name__)\n\n\n@tool\ndef query_database(sql_query: str) -> Dict[str, Any]:\n    \"\"\"\n    Executa uma consulta SQL diretamente no banco de dados.\n\n    Args:\n        sql_query: Consulta SQL para executar\n\n    Returns:\n        Dicion\u00e1rio com os resultados ou erro\n    \"\"\"\n    logger.info(f\"Executando query: {sql_query}\")\n\n    try:\n        db_manager = get_db_manager()\n\n        with db_manager.get_connection() as conn:\n            result = conn.execute(text(sql_query))\n            rows = result.fetchall()\n            columns = result.keys() if rows else []\n\n            if not rows:\n                return {\n                    \"status\": \"success\",\n                    \"message\": \"Nenhum resultado encontrado\",\n                    \"data\": [],\n                }\n\n            # Converter ResultProxy para lista de dicts\n            data = [dict(zip(columns, row)) for row in rows]\n\n            return {\n                \"status\": \"success\",\n                \"message\": f\"{len(data)} registros encontrados\",\n                \"columns\": list(columns),\n                \"data\": data,\n                \"count\": len(data),\n            }\n\n    except Exception as e:\n        logger.error(f\"Erro ao executar query: {e}\", exc_info=True)\n        return {\n            \"status\": \"error\",\n            \"message\": f\"Erro ao executar consulta: {str(e)}\",\n            \"data\": [],\n        }\n\n\n@tool\ndef get_product_by_code(product_code: str) -> Dict[str, Any]:\n    \"\"\"\n    Busca um produto pelo c\u00f3digo na tabela ADMAT_OPCOM.\n\n    Args:\n        product_code: C\u00f3digo do produto\n\n    Returns:\n        Informa\u00e7\u00f5es do produto\n    \"\"\"\n    logger.info(f\"Buscando produto com c\u00f3digo: {product_code}\")\n\n    try:\n        db_manager = get_db_manager()\n        query = \"\"\"\n        SELECT TOP 1\n            CAST([C\u00d3DIGO] AS VARCHAR(50)) as codigo,\n            [NOME] as nome,\n            [PRE\u00c7O 38%] as preco,\n            [FABRICANTE] as fabricante,\n            [EMBALAGEM] as embalagem,\n            [CATEGORIA] as categoria,\n            [GRUPO] as grupo,\n            [SUBGRUPO] as subgrupo,\n            [EST# UNE] as estoque,\n            [ULTIMA_VENDA] as ultima_venda\n        FROM dbo.Admat_OPCOM\n        WHERE CAST([C\u00d3DIGO] AS VARCHAR(50)) = :codigo\n           OR [C\u00d3DIGO] = :codigo_int\n        \"\"\"\n\n        with db_manager.get_connection() as conn:\n            result = conn.execute(\n                text(query),\n                {\n                    \"codigo\": product_code,\n                    \"codigo_int\": int(product_code) if product_code.isdigit() else 0,\n                },\n            )\n            row = result.fetchone()\n\n            if not row:\n                return {\n                    \"status\": \"not_found\",\n                    \"message\": f\"Produto {product_code} n\u00e3o encontrado\",\n                }\n\n            columns = result.keys()\n            data = dict(zip(columns, row))\n\n            return {\"status\": \"success\", \"message\": \"Produto encontrado\", \"data\": data}\n\n    except Exception as e:\n        logger.error(f\"Erro ao buscar produto: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao buscar produto: {str(e)}\"}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3459, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "33a45088-0f20-4977-90ca-42d2a7f1c529": {"__data__": {"id_": "33a45088-0f20-4977-90ca-42d2a7f1c529", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\sql_server_tools.py", "language": "python", "lines": 357, "filename": "sql_server_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ac39ce31-2917-4938-b1cf-f30ddf5ecc5f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\sql_server_tools.py", "language": "python", "lines": 357, "filename": "sql_server_tools.py"}, "hash": "411c12c6755a98addc3ad480a37cdb01c90a0da67f47c5f466395a1987c056e5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3f2f0192-39ad-4774-933b-ecc2764025e2", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\sql_server_tools.py", "language": "python", "lines": 357, "filename": "sql_server_tools.py"}, "hash": "7b77fe33472d3a43aa75652d1e6322c69f15f398442d8ce816bc9d19304218f9", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "822e6fb7-c7fc-4eac-9a0d-cc9c23b04f41", "node_type": "1", "metadata": {}, "hash": "cf956c4533d1cab83e269d4a7f6bc8d848538639021415243216c58fc8066559", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef search_products_by_name(product_name: str, limit: int = 10) -> Dict[str, Any]:\n    \"\"\"\n    Busca produtos pelo nome (parcial) na tabela ADMAT_OPCOM.\n\n    Args:\n        product_name: Nome ou parte do nome do produto\n        limit: N\u00famero m\u00e1ximo de resultados\n\n    Returns:\n        Lista de produtos encontrados\n    \"\"\"\n    logger.info(f\"Buscando produtos com nome contendo: {product_name}\")\n\n    try:\n        db_manager = get_db_manager()\n        query = f\"\"\"\n        SELECT TOP {limit}\n            CAST([C\u00d3DIGO] AS VARCHAR(50)) as codigo,\n            [NOME] as nome,\n            [PRE\u00c7O 38%] as preco,\n            [CATEGORIA] as categoria,\n            [EST# UNE] as estoque\n        FROM dbo.Admat_OPCOM\n        WHERE [NOME] LIKE :search_term\n        ORDER BY [NOME]\n        \"\"\"\n\n        with db_manager.get_connection() as conn:\n            result = conn.execute(text(query), {\"search_term\": f\"%{product_name}%\"})\n            rows = result.fetchall()\n            columns = result.keys() if rows else []\n\n            if not rows:\n                return {\n                    \"status\": \"not_found\",\n                    \"message\": f\"Nenhum produto encontrado com '{product_name}'\",\n                    \"data\": [],\n                }\n\n            data = [dict(zip(columns, row)) for row in rows]\n\n            return {\n                \"status\": \"success\",\n                \"message\": f\"{len(data)} produtos encontrados\",\n                \"data\": data,\n                \"count\": len(data),\n            }\n\n    except Exception as e:\n        logger.error(f\"Erro ao buscar produtos: {e}\", exc_info=True)\n        return {\n            \"status\": \"error\",\n            \"message\": f\"Erro ao buscar produtos: {str(e)}\",\n            \"data\": [],\n        }\n\n\n@tool\ndef get_products_by_category(category: str, limit: int = 20) -> Dict[str, Any]:\n    \"\"\"\n    Busca produtos por categoria.\n\n    Args:\n        category: Nome da categoria\n        limit: N\u00famero m\u00e1ximo de resultados\n\n    Returns:\n        Lista de produtos da categoria\n    \"\"\"\n    logger.info(f\"Buscando produtos da categoria: {category}\")\n\n    try:\n        db_manager = get_db_manager()\n        query = f\"\"\"\n        SELECT TOP {limit}\n            CAST([C\u00d3DIGO] AS VARCHAR(50)) as codigo,\n            [NOME] as nome,\n            [PRE\u00c7O 38%] as preco,\n            [CATEGORIA] as categoria,\n            [GRUPO] as grupo,\n            [EST# UNE] as estoque\n        FROM dbo.Admat_OPCOM\n        WHERE [CATEGORIA] = :category\n        ORDER BY [NOME]\n        \"\"\"\n\n        with db_manager.get_connection() as conn:\n            result = conn.execute(text(query), {\"category\": category})\n            rows = result.fetchall()\n            columns = result.keys() if rows else []\n\n            if not rows:\n                return {\n                    \"status\": \"not_found\",\n                    \"message\": f\"Nenhum produto encontrado na categoria '{category}'\",\n                    \"data\": [],\n                }\n\n            data = [dict(zip(columns, row)) for row in rows]\n\n            return {\n                \"status\": \"success\",\n                \"message\": f\"{len(data)} produtos encontrados\",\n                \"data\": data,\n                \"count\": len(data),\n            }\n\n    except Exception as e:\n        logger.error(f\"Erro ao buscar por categoria: {e}\", exc_info=True)\n        return {\n            \"status\": \"error\",\n            \"message\": f\"Erro ao buscar por categoria: {str(e)}\",\n            \"data\": [],\n        }", "mimetype": "text/plain", "start_char_idx": 3462, "end_char_idx": 6921, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "822e6fb7-c7fc-4eac-9a0d-cc9c23b04f41": {"__data__": {"id_": "822e6fb7-c7fc-4eac-9a0d-cc9c23b04f41", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\sql_server_tools.py", "language": "python", "lines": 357, "filename": "sql_server_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ac39ce31-2917-4938-b1cf-f30ddf5ecc5f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\sql_server_tools.py", "language": "python", "lines": 357, "filename": "sql_server_tools.py"}, "hash": "411c12c6755a98addc3ad480a37cdb01c90a0da67f47c5f466395a1987c056e5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "33a45088-0f20-4977-90ca-42d2a7f1c529", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\sql_server_tools.py", "language": "python", "lines": 357, "filename": "sql_server_tools.py"}, "hash": "3c621077e2bd7bbf115a079df019b7b9437b7171c06280e4c68bf06c431d77f2", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef get_top_selling_products(limit: int = 10) -> Dict[str, Any]:\n    \"\"\"\n    Retorna os produtos mais vendidos nos \u00faltimos 30 dias.\n\n    Args:\n        limit: N\u00famero m\u00e1ximo de resultados\n\n    Returns:\n        Lista dos produtos mais vendidos\n    \"\"\"\n    logger.info(f\"Buscando top {limit} produtos mais vendidos\")\n\n    try:\n        db_manager = get_db_manager()\n        query = f\"\"\"\n        SELECT TOP {limit}\n            CAST([C\u00d3DIGO] AS VARCHAR(50)) as codigo,\n            [NOME] as nome,\n            [VENDA 30D] as vendas_30d,\n            [PRE\u00c7O 38%] as preco,\n            [CATEGORIA] as categoria\n        FROM dbo.Admat_OPCOM\n        WHERE [VENDA 30D] > 0\n        ORDER BY [VENDA 30D] DESC\n        \"\"\"\n\n        with db_manager.get_connection() as conn:\n            result = conn.execute(text(query))\n            rows = result.fetchall()\n            columns = result.keys() if rows else []\n\n            if not rows:\n                return {\n                    \"status\": \"not_found\",\n                    \"message\": \"Nenhum produto com vendas encontrado\",\n                    \"data\": [],\n                }\n\n            data = [dict(zip(columns, row)) for row in rows]\n\n            return {\n                \"status\": \"success\",\n                \"message\": f\"{len(data)} produtos com vendas encontrados\",\n                \"data\": data,\n                \"count\": len(data),\n            }\n\n    except Exception as e:\n        logger.error(f\"Erro ao buscar produtos mais vendidos: {e}\", exc_info=True)\n        return {\n            \"status\": \"error\",\n            \"message\": f\"Erro ao buscar produtos: {str(e)}\",\n            \"data\": [],\n        }\n\n\n@tool\ndef get_product_stock(product_code: str) -> Dict[str, Any]:\n    \"\"\"\n    Retorna o estoque de um produto espec\u00edfico.\n\n    Args:\n        product_code: C\u00f3digo do produto\n\n    Returns:\n        Informa\u00e7\u00f5es de estoque\n    \"\"\"\n    logger.info(f\"Buscando estoque do produto: {product_code}\")\n\n    try:\n        db_manager = get_db_manager()\n        query = \"\"\"\n        SELECT TOP 1\n            CAST([C\u00d3DIGO] AS VARCHAR(50)) as codigo,\n            [NOME] as nome,\n            [EST# UNE] as estoque_unidades,\n            [CATEGORIA] as categoria,\n            [PRE\u00c7O 38%] as preco\n        FROM dbo.Admat_OPCOM\n        WHERE CAST([C\u00d3DIGO] AS VARCHAR(50)) = :codigo\n           OR [C\u00d3DIGO] = :codigo_int\n        \"\"\"\n\n        with db_manager.get_connection() as conn:\n            result = conn.execute(\n                text(query),\n                {\n                    \"codigo\": product_code,\n                    \"codigo_int\": int(product_code) if product_code.isdigit() else 0,\n                },\n            )\n            row = result.fetchone()\n\n            if not row:\n                return {\n                    \"status\": \"not_found\",\n                    \"message\": f\"Produto {product_code} n\u00e3o encontrado\",\n                }\n\n            columns = result.keys()\n            data = dict(zip(columns, row))\n\n            return {\"status\": \"success\", \"message\": \"Estoque encontrado\", \"data\": data}\n\n    except Exception as e:\n        logger.error(f\"Erro ao buscar estoque: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro ao buscar estoque: {str(e)}\"}\n\n\n# Lista de ferramentas SQL Server\nsql_server_tools = [\n    query_database,\n    get_product_by_code,\n    search_products_by_name,\n    get_products_by_category,\n    get_top_selling_products,\n    get_product_stock,\n]", "mimetype": "text/plain", "start_char_idx": 6924, "end_char_idx": 10355, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5aa919ed-a38e-4f99-abbf-6e07b90a2182": {"__data__": {"id_": "5aa919ed-a38e-4f99-abbf-6e07b90a2182", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "6411b1eb-46af-4b3e-a973-a2f90ab73c1d", "node_type": "1", "metadata": {}, "hash": "ed48e2a1f7d12e913172bfc56e4c5ee27d23c9c61e4dda811f0cd3f95584177d", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nFerramentas LangChain para opera\u00e7\u00f5es UNE.\nImplementa regras de abastecimento, MC e pol\u00edtica de pre\u00e7os.\n\nEste m\u00f3dulo fornece ferramentas para:\n- C\u00e1lculo de necessidades de abastecimento por UNE\n- Consulta de MC (M\u00e9dia Comum) de produtos\n- C\u00e1lculo de pre\u00e7os finais aplicando pol\u00edtica de pre\u00e7os UNE\n\"\"\"\n\nfrom langchain_core.tools import tool\n\nimport pandas as pd\n\nimport os\n\nimport logging\n\nfrom typing import Dict, Any, List, Optional\n\nfrom functools import lru_cache\n\nfrom pathlib import Path\n\n# Validadores integrados (v3.0) - Ajustado para FastAPI\nfrom app.core.validators.schema_validator import SchemaValidator\nfrom app.core.utils.query_validator import validate_columns, handle_nulls, safe_filter\nfrom app.core.utils.error_handler import error_handler_decorator\n\nlogger = logging.getLogger(__name__)\n\n# Flag para usar HybridAdapter (SQL/Parquet autom\u00e1tico)\nUSE_HYBRID_ADAPTER = os.getenv(\"UNE_USE_HYBRID_ADAPTER\", \"true\").lower() == \"true\"\n\n# Mapeamento de colunas SQL Server \u2192 formato padr\u00e3o\nCOLUMN_MAPPING_SQL = {\n    'PRODUTO': 'codigo',\n    'NOME': 'nome_produto',\n    'UNE': 'une',\n    'ESTOQUE_UNE': 'estoque_atual',\n    'ESTOQUE_LV': 'linha_verde',\n    'MEDIA_CONSIDERADA_LV': 'mc',\n    'VENDA_30DD': 'venda_30_d',\n    'NOMESEGMENTO': 'nomesegmento',\n    'ESTOQUE_CD': 'estoque_cd', # Adicionado mapeamento para estoque_cd\n    'UNE_NOME': 'une_nome', # Added this for consistency\n    'NOMEFABRICANTE': 'nomefabricante', # Added this for consistency\n}\n\n# Mapeamento de colunas Parquet padr\u00e3o \u2192 formato padr\u00e3o\nCOLUMN_MAPPING_PARQUET = {\n    'estoque_lv': 'linha_verde',\n    'media_considerada_lv': 'mc',\n}\n\n@lru_cache(maxsize=1)\ndef _get_data_adapter():\n    \"\"\"Retorna adapter de dados (HybridAdapter ou Parquet direto) com cache\"\"\"\n    global USE_HYBRID_ADAPTER\n\n    if USE_HYBRID_ADAPTER:\n        try:\n            from app.infrastructure.data.hybrid_adapter import HybridDataAdapter\n            adapter = HybridDataAdapter()\n            logger.info(f\"Usando HybridAdapter - fonte: {adapter.current_source}\")\n            return adapter\n        except Exception as e:\n            logger.warning(f\"Erro ao inicializar HybridAdapter: {e}, usando Parquet direto\")\n            USE_HYBRID_ADAPTER = False\n\n    # Fallback: usar Parquet direto\n    PARQUET_PATH_EXTENDED = os.path.join(os.getcwd(), \"data\", \"parquet\", \"admmat_extended.parquet\")\n    PARQUET_PATH_DEFAULT = os.path.join(os.getcwd(), \"data\", \"parquet\", \"admmat.parquet\")\n\n    if os.path.exists(PARQUET_PATH_EXTENDED):\n        return {'type': 'parquet', 'path': PARQUET_PATH_EXTENDED, 'extended': True}\n    else:\n        return {'type': 'parquet', 'path': PARQUET_PATH_DEFAULT, 'extended': False}\n\ndef _normalize_dataframe(df: pd.DataFrame) -> pd.DataFrame:\n    \"\"\"Normaliza DataFrame para ter colunas consistentes independente da fonte\"\"\"\n    # Verificar se precisa mapear colunas SQL\n    if 'PRODUTO' in df.columns:\n        # Dados vieram do SQL Server\n        for sql_col, std_col in COLUMN_MAPPING_SQL.items():\n            if sql_col in df.columns and std_col not in df.columns:\n                df[std_col] = df[sql_col]\n\n    # Verificar se precisa mapear colunas Parquet padr\u00e3o\n    for parquet_col, std_col in COLUMN_MAPPING_PARQUET.items():\n        if parquet_col in df.columns and std_col not in df.columns:\n            df[std_col] = df[parquet_col]\n\n    # Mapear colunas do Parquet para nomes padronizados\n    # (mapeamento reverso do que \u00e9 feito em _load_data)\n    if 'media_considerada_lv' in df.columns and 'mc' not in df.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3501, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6411b1eb-46af-4b3e-a973-a2f90ab73c1d": {"__data__": {"id_": "6411b1eb-46af-4b3e-a973-a2f90ab73c1d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "5aa919ed-a38e-4f99-abbf-6e07b90a2182", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "8e7bb1c593cd00d15fa1079dae53869ff40164fc7c7f8cf25230b64662002e4a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "22b5a32d-774a-4ea0-ba7e-02673c6de0ed", "node_type": "1", "metadata": {}, "hash": "bc8541597374617cd81982227989c16ed7b10ae7f8aef4229a8871640c72e8a5", "class_name": "RelatedNodeInfo"}}, "text": "columns:\n        # Dados vieram do SQL Server\n        for sql_col, std_col in COLUMN_MAPPING_SQL.items():\n            if sql_col in df.columns and std_col not in df.columns:\n                df[std_col] = df[sql_col]\n\n    # Verificar se precisa mapear colunas Parquet padr\u00e3o\n    for parquet_col, std_col in COLUMN_MAPPING_PARQUET.items():\n        if parquet_col in df.columns and std_col not in df.columns:\n            df[std_col] = df[parquet_col]\n\n    # Mapear colunas do Parquet para nomes padronizados\n    # (mapeamento reverso do que \u00e9 feito em _load_data)\n    if 'media_considerada_lv' in df.columns and 'mc' not in df.columns:\n        df['mc'] = df['media_considerada_lv']\n\n    if 'estoque_lv' in df.columns and 'linha_verde' not in df.columns:\n        df['linha_verde'] = df['estoque_lv']\n\n    if 'estoque_gondola_lv' in df.columns and 'estoque_gondola' not in df.columns:\n        df['estoque_gondola'] = df['estoque_gondola_lv']\n\n    return df\n\ndef _load_data(filters: Dict[str, Any] = None, columns: List[str] = None) -> pd.DataFrame:\n    \"\"\"\n    Carrega dados usando adapter apropriado (SQL ou Parquet) com valida\u00e7\u00e3o\n\n    Args:\n        filters: Filtros a aplicar (ex: {'une': 2586, 'codigo': 369947})\n        columns: Colunas espec\u00edficas a carregar (otimiza\u00e7\u00e3o)\n\n    Returns:\n        DataFrame normalizado e validado\n    \"\"\"\n    adapter = _get_data_adapter()\n\n    # Validar schema se for Parquet direto\n    if isinstance(adapter, dict):\n        validator = SchemaValidator()\n        # Pass the specific parquet file name to the validator\n        parquet_file_stem = Path(adapter['path']).stem\n        is_valid, errors = validator.validate_parquet_file(adapter['path'], table_name=parquet_file_stem)\n        if not is_valid:\n            logger.error(f\"Schema inv\u00e1lido: {errors}\")\n            raise ValueError(f\"Schema do arquivo Parquet inv\u00e1lido: {errors}\")\n\n    # Create reverse mappings (moved outside if columns block)\n    reverse_mapping_sql = {v: k for k, v in COLUMN_MAPPING_SQL.items()}\n    reverse_mapping_parquet = {v: k for v, k in COLUMN_MAPPING_PARQUET.items()} # Should be k:v for reverse\n\n    if isinstance(adapter, dict):\n        # Parquet direto\n        if columns:\n            # Map requested standard columns back to Parquet original names for loading\n            parquet_cols_to_load = []\n            \n            for col in columns:\n                if col in reverse_mapping_sql:\n                    parquet_cols_to_load.append(reverse_mapping_sql[col])\n                elif col in reverse_mapping_parquet:\n                    parquet_cols_to_load.append(reverse_mapping_parquet[col])\n                else:\n                    # Default: assume the column name is the same in Parquet\n                    parquet_cols_to_load.append(col) \n            \n            # Ensure unique columns\n            parquet_cols_to_load = list(set(parquet_cols_to_load))\n            logger.debug(f\"Loading parquet from {adapter['path']} with columns: {parquet_cols_to_load}\")\n\n            df = pd.read_parquet(adapter['path'], columns=parquet_cols_to_load)\n        else:\n            df = pd.read_parquet(adapter['path'])\n\n        # Aplicar filtros manualmente\n        if filters:\n            for col, val in filters.items():\n                # Map filter key back to original parquet column name if necessary\n                mapped_col = col\n                if col in reverse_mapping_sql:\n                    mapped_col = reverse_mapping_sql[col]\n                elif col in reverse_mapping_parquet:\n                    mapped_col = reverse_mapping_parquet[col]\n                else:\n                    # Default: assume the column name is the same in Parquet\n                    mapped_col = col\n\n                if mapped_col in df.columns:\n                    df = df[df[mapped_col] == val]\n    else:\n        # \ud83d\ude80 OTIMIZA\u00c7\u00c3O URGENTE: PRIORIZAR PARQUET (SQL Server muito lento - 5min/query)\n        # HybridAdapter (SQL ou Parquet autom\u00e1tico)\n        try:\n            # Sempre tentar Parquet primeiro para performance m\u00e1xima\n            import glob\n\n            parquet_path = adapter.file_path if hasattr(adapter, 'file_path') else os.path.join(os.getcwd(), 'data',", "mimetype": "text/plain", "start_char_idx": 2877, "end_char_idx": 7056, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "22b5a32d-774a-4ea0-ba7e-02673c6de0ed": {"__data__": {"id_": "22b5a32d-774a-4ea0-ba7e-02673c6de0ed", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "6411b1eb-46af-4b3e-a973-a2f90ab73c1d", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "13e6fd1c41bc68a4a7cf9613b0c17e1acfc26c565e1b6623913cbe7fff4bd8ad", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "a3a14f9b-75f9-475a-b38a-60beeb16a1f1", "node_type": "1", "metadata": {}, "hash": "f9320e191433aa70e19f14b8ce02f7529e36feb66c2f87cc879bcc56689d245c", "class_name": "RelatedNodeInfo"}}, "text": "columns:\n                    df = df[df[mapped_col] == val]\n    else:\n        # \ud83d\ude80 OTIMIZA\u00c7\u00c3O URGENTE: PRIORIZAR PARQUET (SQL Server muito lento - 5min/query)\n        # HybridAdapter (SQL ou Parquet autom\u00e1tico)\n        try:\n            # Sempre tentar Parquet primeiro para performance m\u00e1xima\n            import glob\n\n            parquet_path = adapter.file_path if hasattr(adapter, 'file_path') else os.path.join(os.getcwd(), 'data', 'parquet', 'admmat.parquet')\n\n            # Expandir wildcard se necess\u00e1rio\n            if '*' in parquet_path:\n                matched_files = glob.glob(parquet_path)\n                if matched_files:\n                    # Priorizar admmat.parquet se existir, sen\u00e3o pegar primeiro\n                    parquet_path = next((f for f in matched_files if 'admmat.parquet' in f), matched_files[0])\n\n            logger.info(f\"\ud83d\ude80 OTIMIZA\u00c7\u00c3O: Usando Parquet direto (SQL muito lento) - {parquet_path}\")\n\n            # Mapear colunas padr\u00e3o para colunas do Parquet\n            if columns:\n                parquet_cols = []\n                for col in columns:\n                    if col == 'linha_verde':\n                        parquet_cols.append('estoque_lv')\n                    elif col == 'mc':\n                        parquet_cols.append('media_considerada_lv')\n                    elif col == 'estoque_gondola_lv':\n                        # J\u00e1 \u00e9 o nome correto do Parquet\n                        parquet_cols.append(col)\n                    elif col in ['ESTOQUE_GONDOLA', 'estoque_gondola']:\n                        # Mapear varia\u00e7\u00f5es antigas para coluna correta\n                        parquet_cols.append('estoque_gondola_lv')\n                    else:\n                        parquet_cols.append(col)\n\n                df = pd.read_parquet(parquet_path, columns=parquet_cols)\n            else:\n                df = pd.read_parquet(parquet_path)\n\n            # Aplicar filtros manualmente (SUPER R\u00c1PIDO com Polars/Pandas)\n            if filters:\n                for col, val in filters.items():\n                    # Normalizar nome da coluna\n                    if col == 'linha_verde' and 'estoque_lv' in df.columns:\n                        col = 'estoque_lv'\n                    elif col == 'mc' and 'media_considerada_lv' in df.columns:\n                        col = 'media_considerada_lv'\n\n                    if col in df.columns:\n                        df = df[df[col] == val]\n\n            logger.info(f\"\u2705 Parquet carregado com sucesso: {len(df)} registros\")\n\n        except Exception as e:\n            # Fallback: usar HybridAdapter (Polars/SQL)\n            logger.info(f\"\u26a0\ufe0f Fallback para HybridAdapter: {e}\")\n            result = adapter.execute_query(filters or {})\n            df = pd.DataFrame(result)\n\n    # Normalizar colunas\n    df = _normalize_dataframe(df)\n\n    # Tratar nulls com validador (mais robusto)\n    for col in ['estoque_atual', 'linha_verde', 'mc', 'venda_30_d']:\n        if col in df.columns:\n            df = handle_nulls(df, col, strategy=\"fill\", fill_value=0)\n\n    # Converter tipos com seguran\u00e7a (usando pandas)\n    for col in ['estoque_atual', 'linha_verde', 'mc', 'venda_30_d']:\n        if col in df.columns:\n            df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)\n\n    return df\n\n\n@tool\n@error_handler_decorator(\n    context_func=lambda une_id, segmento=None: {\"une_id\": une_id, \"segmento\": segmento, \"funcao\": \"calcular_abastecimento_une\"},\n    return_on_error={\"error\": \"Erro ao calcular abastecimento\", \"total_produtos\": 0, \"produtos\": []}\n)\ndef calcular_abastecimento_une(une_id: int, segmento: str = None) -> Dict[str, Any]:\n    \"\"\"\n    Calcula produtos que precisam de abastecimento em uma UNE.\n\n    Regra aplicada: ESTOQUE_UNE <= 50% LINHA_VERDE\n\n    Args:\n        une_id: ID da UNE (1-10)\n        segmento: Filtro opcional por segmento (ex: \"TECIDOS\",", "mimetype": "text/plain", "start_char_idx": 6623, "end_char_idx": 10467, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a3a14f9b-75f9-475a-b38a-60beeb16a1f1": {"__data__": {"id_": "a3a14f9b-75f9-475a-b38a-60beeb16a1f1", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "22b5a32d-774a-4ea0-ba7e-02673c6de0ed", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "c8603f4858017d1bfd18e20ea620fc05f85c440f9d45f0521702c2df59f76d4e", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b9bc750d-75e3-49a8-b720-3fe1666b0ab0", "node_type": "1", "metadata": {}, "hash": "30a1a55624933eadccb63529046dfa847abec9381f4d148931e0bf6bda3894e2", "class_name": "RelatedNodeInfo"}}, "text": "to_numeric(df[col], errors='coerce').fillna(0)\n\n    return df\n\n\n@tool\n@error_handler_decorator(\n    context_func=lambda une_id, segmento=None: {\"une_id\": une_id, \"segmento\": segmento, \"funcao\": \"calcular_abastecimento_une\"},\n    return_on_error={\"error\": \"Erro ao calcular abastecimento\", \"total_produtos\": 0, \"produtos\": []}\n)\ndef calcular_abastecimento_une(une_id: int, segmento: str = None) -> Dict[str, Any]:\n    \"\"\"\n    Calcula produtos que precisam de abastecimento em uma UNE.\n\n    Regra aplicada: ESTOQUE_UNE <= 50% LINHA_VERDE\n\n    Args:\n        une_id: ID da UNE (1-10)\n        segmento: Filtro opcional por segmento (ex: \"TECIDOS\", \"PAPELARIA\")\n\n    Returns:\n        dict com:\n        - total_produtos: int (total de produtos que precisam abastecimento)\n        - produtos: list[dict] (top 20 produtos ordenados por qtd_a_abastecer DESC)\n        - regra_aplicada: str (descri\u00e7\u00e3o da regra de abastecimento)\n        - une_id: int\n        - segmento: str (se aplicado)\n\n    Example:\n        >>> result = calcular_abastecimento_une(une_id=1, segmento=\"TECIDOS\")\n        >>> print(f\"Total produtos: {result['total_produtos']}\")\n    \"\"\"\n    # Valida\u00e7\u00e3o de inputs\n    if not isinstance(une_id, int) or une_id <= 0:\n        return {\"error\": \"une_id deve ser um inteiro positivo\"}\n\n    # Carregar dados com valida\u00e7\u00e3o integrada\n    logger.info(f\"Carregando dados de abastecimento para UNE {une_id}\")\n    df = _load_data(filters={'une': une_id})\n\n    # Verificar se dataframe n\u00e3o est\u00e1 vazio\n    if df.empty:\n        logger.warning(f\"Query retornou 0 linhas para UNE {une_id}\")\n        return {\n            \"error\": f\"Nenhum dado encontrado para UNE {une_id}\",\n            \"une_id\": une_id,\n            \"total_produtos\": 0,\n            \"produtos\": []\n        }\n\n    # Normalizar DataFrame (garantir mapeamento de colunas SQL -> padr\u00e3o)\n    df = _normalize_dataframe(df)\n\n    # Validar colunas necess\u00e1rias\n    required_cols = ['une', 'codigo', 'nome_produto', 'estoque_atual', 'linha_verde']\n    is_valid, missing = validate_columns(df, required_cols)\n    if not is_valid:\n        logger.error(f\"Colunas dispon\u00edveis: {list(df.columns)}\")\n        logger.error(f\"Colunas faltantes: {missing}\")\n        return {\n            \"error\": f\"Colunas ausentes ap\u00f3s normaliza\u00e7\u00e3o: {missing}\",\n            \"colunas_disponiveis\": list(df.columns),\n            \"une_id\": une_id\n        }\n\n    # Calcular colunas derivadas se n\u00e3o existirem\n    if 'precisa_abastecimento' not in df.columns:\n        logger.info(\"Calculando coluna 'precisa_abastecimento' (n\u00e3o encontrada nos dados)\")\n        # Regra: ESTOQUE_UNE <= 50% LINHA_VERDE\n        df['precisa_abastecimento'] = (df['estoque_atual'] <= (df['linha_verde'] * 0.5))\n\n    if 'qtd_a_abastecer' not in df.columns:\n        logger.info(\"Calculando coluna 'qtd_a_abastecer' (n\u00e3o encontrada nos dados)\")\n        # Quantidade a abastecer = LINHA_VERDE - ESTOQUE_ATUAL (se positivo)\n        df['qtd_a_abastecer'] = (df['linha_verde'] - df['estoque_atual']).clip(lower=0)\n\n    # Filtrar por UNE com seguran\u00e7a\n    df_une = df[df['une'] == une_id]\n\n    if df_une.empty:\n        return {\n            \"error\": f\"Nenhum produto encontrado para UNE {une_id}\",\n            \"une_id\": une_id\n        }\n\n    # Filtrar por segmento (se fornecido)\n    if segmento:\n        if 'nomesegmento' in df_une.columns:\n            df_une = df_une[\n                df_une['nomesegmento'].str.", "mimetype": "text/plain", "start_char_idx": 9825, "end_char_idx": 13219, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b9bc750d-75e3-49a8-b720-3fe1666b0ab0": {"__data__": {"id_": "b9bc750d-75e3-49a8-b720-3fe1666b0ab0", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "a3a14f9b-75f9-475a-b38a-60beeb16a1f1", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "bc17b1177a04f73e989f59e802ddeeb1129e1e4ad7f5255cf7a9de0c32f8a5ed", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "61ad2d53-ceae-442f-9aab-e83024058f1f", "node_type": "1", "metadata": {}, "hash": "eeb2d065d52412fdcaac1ee673c38627fdd9730d81d22f6cb161c99eadfba00d", "class_name": "RelatedNodeInfo"}}, "text": "info(\"Calculando coluna 'qtd_a_abastecer' (n\u00e3o encontrada nos dados)\")\n        # Quantidade a abastecer = LINHA_VERDE - ESTOQUE_ATUAL (se positivo)\n        df['qtd_a_abastecer'] = (df['linha_verde'] - df['estoque_atual']).clip(lower=0)\n\n    # Filtrar por UNE com seguran\u00e7a\n    df_une = df[df['une'] == une_id]\n\n    if df_une.empty:\n        return {\n            \"error\": f\"Nenhum produto encontrado para UNE {une_id}\",\n            \"une_id\": une_id\n        }\n\n    # Filtrar por segmento (se fornecido)\n    if segmento:\n        if 'nomesegmento' in df_une.columns:\n            df_une = df_une[\n                df_une['nomesegmento'].str.contains(segmento, case=False, na=False)\n            ]\n            if df_une.empty:\n                return {\n                    \"error\": f\"Nenhum produto encontrado para segmento '{segmento}' na UNE {une_id}\",\n                    \"une_id\": une_id,\n                    \"segmento\": segmento\n                }\n        else:\n            logger.warning(\"Coluna 'nomesegmento' n\u00e3o encontrada no dataset\")\n\n    # Filtrar produtos que precisam abastecimento\n    # (coluna j\u00e1 foi calculada anteriormente se n\u00e3o existia)\n    df_abastecer = df_une[df_une['precisa_abastecimento'] == True].copy()\n\n    total_produtos = len(df_abastecer)\n\n    if total_produtos == 0:\n        return {\n            \"total_produtos\": 0,\n            \"produtos\": [],\n            \"regra_aplicada\": \"ESTOQUE_UNE <= 50% LINHA_VERDE\",\n            \"une_id\": une_id,\n            \"segmento\": segmento if segmento else \"Todos\",\n            \"mensagem\": \"Nenhum produto precisa de abastecimento no momento\"\n        }\n\n    # Ordenar por qtd_a_abastecer DESC e pegar top 20\n    df_abastecer = df_abastecer.sort_values('qtd_a_abastecer', ascending=False)\n    top_20 = df_abastecer.head(20)\n\n    # Preparar lista de produtos\n    produtos = []\n    for _, row in top_20.iterrows():\n        produto = {\n            \"codigo\": int(row['codigo']) if pd.notna(row['codigo']) else None,\n            \"nome_produto\": str(row['nome_produto']) if pd.notna(row['nome_produto']) else \"N/A\",\n            \"segmento\": str(row['nomesegmento']) if 'nomesegmento' in row and pd.notna(row['nomesegmento']) else \"N/A\",\n            \"estoque_atual\": float(row['estoque_atual']) if pd.notna(row['estoque_atual']) else 0.0,\n            \"linha_verde\": float(row['linha_verde']) if pd.notna(row['linha_verde']) else 0.0,\n            \"qtd_a_abastecer\": float(row['qtd_a_abastecer']) if pd.notna(row['qtd_a_abastecer']) else 0.0,\n            \"percentual_estoque\": round((float(row['estoque_atual']) / float(row['linha_verde']) * 100), 2) if pd.notna(row['linha_verde']) and row['linha_verde'] > 0 else 0.0\n        }\n        produtos.append(produto)\n\n    logger.info(f\"Encontrados {total_produtos} produtos para abastecimento na UNE {une_id}\")\n\n    return {\n        \"total_produtos\": total_produtos,\n        \"produtos\": produtos,\n        \"regra_aplicada\": \"ESTOQUE_UNE <= 50% LINHA_VERDE\",\n        \"une_id\": une_id,\n        \"segmento\": segmento if segmento else \"Todos\"\n    }\n\n\n@tool\ndef calcular_mc_produto(produto_id: int, une_id: int) -> Dict[str, Any]:\n    \"\"\"\n    Retorna informa\u00e7\u00f5es de MC (M\u00e9dia Comum) de um produto em uma UNE espec\u00edfica.\n\n    A MC representa a m\u00e9dia de vendas do produto, usada para dimensionar\n    o estoque adequado em g\u00f4ndola.", "mimetype": "text/plain", "start_char_idx": 12585, "end_char_idx": 15894, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "61ad2d53-ceae-442f-9aab-e83024058f1f": {"__data__": {"id_": "61ad2d53-ceae-442f-9aab-e83024058f1f", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b9bc750d-75e3-49a8-b720-3fe1666b0ab0", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "09a9dc1a5fe77657783830c073a518f14b62dc320b4e192404a6f5edd159b5fb", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "24cfde90-aef7-49e4-aa14-735c1399d06f", "node_type": "1", "metadata": {}, "hash": "220d8884563204b2830d1c3483a9de3fd747104a93849a88b3fff4c3a66c09f9", "class_name": "RelatedNodeInfo"}}, "text": "0\n        }\n        produtos.append(produto)\n\n    logger.info(f\"Encontrados {total_produtos} produtos para abastecimento na UNE {une_id}\")\n\n    return {\n        \"total_produtos\": total_produtos,\n        \"produtos\": produtos,\n        \"regra_aplicada\": \"ESTOQUE_UNE <= 50% LINHA_VERDE\",\n        \"une_id\": une_id,\n        \"segmento\": segmento if segmento else \"Todos\"\n    }\n\n\n@tool\ndef calcular_mc_produto(produto_id: int, une_id: int) -> Dict[str, Any]:\n    \"\"\"\n    Retorna informa\u00e7\u00f5es de MC (M\u00e9dia Comum) de um produto em uma UNE espec\u00edfica.\n\n    A MC representa a m\u00e9dia de vendas do produto, usada para dimensionar\n    o estoque adequado em g\u00f4ndola.\n\n    Args:\n        produto_id: C\u00f3digo do produto\n        une_id: ID da UNE (1-10)\n\n    Returns:\n        dict com:\n        - produto_id: int\n        - nome: str\n        - segmento: str\n        - mc_calculada: float (M\u00e9dia Comum)\n        - estoque_atual: float\n        - linha_verde: float (estoque m\u00e1ximo)\n        - estoque_gondola: float (se existir na base)\n        - percentual_linha_verde: float (% do estoque em rela\u00e7\u00e3o \u00e0 linha verde)\n        - recomendacao: str (orienta\u00e7\u00e3o de abastecimento)\n\n    Example:\n        >>> result = calcular_mc_produto(produto_id=12345, une_id=1)\n        >>> print(f\"MC: {result['mc_calculada']}, Recomenda\u00e7\u00e3o: {result['recomendacao']}\")\n    \"\"\"\n    try:\n        # Valida\u00e7\u00e3o de inputs\n        if not isinstance(produto_id, int) or produto_id <= 0:\n            return {\"error\": \"produto_id deve ser um inteiro positivo\"}\n\n        if not isinstance(une_id, int) or une_id <= 0:\n            return {\"error\": \"une_id deve ser um inteiro positivo\"}\n\n        # Carregar dados usando _load_data() com filtros (padr\u00e3o refatorado)\n        logger.info(f\"Buscando MC do produto {produto_id} na UNE {une_id}\")\n        # CORRE\u00c7\u00c3O: Remover colunas ESTOQUE_GONDOLA/estoque_gondola que n\u00e3o existem no Parquet\n        # Usar estoque_gondola_lv que existe no Parquet\n        produto_df = _load_data(\n            filters={'codigo': produto_id, 'une': une_id},\n            columns=['codigo', 'nome_produto', 'une', 'mc', 'estoque_atual',\n                    'linha_verde', 'nomesegmento', 'estoque_gondola_lv']\n        )\n\n        if produto_df.empty:\n            return {\n                \"error\": f\"Produto {produto_id} n\u00e3o encontrado na UNE {une_id}\",\n                \"produto_id\": produto_id,\n                \"une_id\": une_id\n            }\n\n        # Pegar primeira linha (deve ser \u00fanica)\n        row = produto_df.iloc[0]\n\n        # Extrair dados\n        mc_calculada = float(row['mc']) if pd.notna(row['mc']) else 0.0\n        estoque_atual = float(row['estoque_atual']) if pd.notna(row['estoque_atual']) else 0.0\n        linha_verde = float(row['linha_verde']) if pd.notna(row['linha_verde']) else 0.0\n\n        # Estoque g\u00f4ndola (usar estoque_gondola_lv que existe no Parquet)\n        estoque_gondola = None\n        if 'estoque_gondola_lv' in row:\n            estoque_gondola = float(row['estoque_gondola_lv']) if pd.notna(row['estoque_gondola_lv']) else 0.0\n        elif 'ESTOQUE_GONDOLA' in row:\n            estoque_gondola = float(row['ESTOQUE_GONDOLA']) if pd.notna(row['ESTOQUE_GONDOLA']) else 0.0\n        elif 'estoque_gondola' in row:\n            estoque_gondola = float(row['estoque_gondola']) if pd.notna(row['estoque_gondola']) else 0.0\n\n        # Calcular percentual da linha verde\n        percentual_linha_verde = 0.", "mimetype": "text/plain", "start_char_idx": 15245, "end_char_idx": 18639, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "24cfde90-aef7-49e4-aa14-735c1399d06f": {"__data__": {"id_": "24cfde90-aef7-49e4-aa14-735c1399d06f", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "61ad2d53-ceae-442f-9aab-e83024058f1f", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "216e436796df96909dd15d93c350c992648f5ddadc0abffb8ecec622f6ace161", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "1a15d8fa-3213-4717-97ee-3a00a813c5df", "node_type": "1", "metadata": {}, "hash": "951f3a14986ae3947078845f557c6e8a77526fcc6c7b304883e36448fd568aaa", "class_name": "RelatedNodeInfo"}}, "text": "notna(row['estoque_gondola_lv']) else 0.0\n        elif 'ESTOQUE_GONDOLA' in row:\n            estoque_gondola = float(row['ESTOQUE_GONDOLA']) if pd.notna(row['ESTOQUE_GONDOLA']) else 0.0\n        elif 'estoque_gondola' in row:\n            estoque_gondola = float(row['estoque_gondola']) if pd.notna(row['estoque_gondola']) else 0.0\n\n        # Calcular percentual da linha verde\n        percentual_linha_verde = 0.0\n        if linha_verde > 0:\n            percentual_linha_verde = round((estoque_atual / linha_verde) * 100, 2)\n\n        # Gerar recomenda\u00e7\u00e3o\n        recomendacao = \"Manter estoque atual\"\n\n        if estoque_gondola is not None and mc_calculada > estoque_gondola:\n            recomendacao = \"Aumentar ESTOQUE em g\u00f4ndola - MC superior ao estoque atual\"\n        elif percentual_linha_verde < 50:\n            recomendacao = \"URGENTE: Abastecer produto - Estoque abaixo de 50% da linha verde\"\n        elif percentual_linha_verde < 75:\n            recomendacao = \"ATEN\u00c7\u00c3O: Planejar abastecimento - Estoque entre 50% e 75% da linha verde\"\n        elif percentual_linha_verde > 100:\n            recomendacao = \"ALERTA: Estoque acima da linha verde - Verificar dimensionamento\"\n\n        resultado = {\n            \"produto_id\": int(produto_id),\n            \"une_id\": int(une_id),\n            \"nome\": str(row['nome_produto']) if pd.notna(row['nome_produto']) else \"N/A\",\n            \"segmento\": str(row['nomesegmento']) if 'nomesegmento' in row and pd.notna(row['nomesegmento']) else \"N/A\",\n            \"mc_calculada\": mc_calculada,\n            \"estoque_atual\": estoque_atual,\n            \"linha_verde\": linha_verde,\n            \"percentual_linha_verde\": percentual_linha_verde,\n            \"recomendacao\": recomendacao\n        }\n\n        # Adicionar estoque_gondola se existir\n        if estoque_gondola is not None:\n            resultado[\"estoque_gondola\"] = estoque_gondola\n\n        logger.info(f\"MC calculada para produto {produto_id}: {mc_calculada}\")\n\n        return resultado\n\n    except Exception as e:\n        logger.error(f\"Erro em calcular_mc_produto: {e}\", exc_info=True)\n        return {\"error\": f\"Erro ao calcular MC do produto: {str(e)}\"}\n\n\n@tool\ndef calcular_preco_final_une(valor_compra: float, ranking: int, forma_pagamento: str) -> Dict[str, Any]:\n    \"\"\"\n    Calcula pre\u00e7o final aplicando pol\u00edtica de pre\u00e7os UNE.\n\n    Regras de Tipo de Pre\u00e7o:\n    - Valor >= R$ 750,00 \u2192 Pre\u00e7o Atacado\n    - Valor < R$ 750,00 \u2192 Pre\u00e7o Varejo\n\n    Pol\u00edtica por Ranking:\n    - Ranking 0: Atacado 38%, Varejo 30%\n    - Ranking 1: Pre\u00e7o \u00fanico 38% (independente do valor)\n    - Ranking 2: Atacado 38%, Varejo 30%\n    - Ranking 3: Sem desconto (pre\u00e7o tabela)\n    - Ranking 4: Atacado 38%, Varejo 24%\n\n    Desconto por Forma de Pagamento:\n    - 'vista': 38%\n    - '30d': 36%\n    - '90d': 34%\n    - '120d': 30%\n\n    Args:\n        valor_compra: Valor total da compra em reais\n        ranking: Classifica\u00e7\u00e3o do produto (0-4)\n        forma_pagamento: Tipo de pagamento ('vista', '30d', '90d',", "mimetype": "text/plain", "start_char_idx": 18228, "end_char_idx": 21212, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1a15d8fa-3213-4717-97ee-3a00a813c5df": {"__data__": {"id_": "1a15d8fa-3213-4717-97ee-3a00a813c5df", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "24cfde90-aef7-49e4-aa14-735c1399d06f", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "86f855a2289ff545cfb01620f870cbfa34bd0bf86961677a57de857aec6a3a74", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c30cd625-1ceb-40ca-a927-d240e4203047", "node_type": "1", "metadata": {}, "hash": "3498d4786788f8c897168800af4c183ba0114c013847bba629af684b132b4417", "class_name": "RelatedNodeInfo"}}, "text": "00 \u2192 Pre\u00e7o Varejo\n\n    Pol\u00edtica por Ranking:\n    - Ranking 0: Atacado 38%, Varejo 30%\n    - Ranking 1: Pre\u00e7o \u00fanico 38% (independente do valor)\n    - Ranking 2: Atacado 38%, Varejo 30%\n    - Ranking 3: Sem desconto (pre\u00e7o tabela)\n    - Ranking 4: Atacado 38%, Varejo 24%\n\n    Desconto por Forma de Pagamento:\n    - 'vista': 38%\n    - '30d': 36%\n    - '90d': 34%\n    - '120d': 30%\n\n    Args:\n        valor_compra: Valor total da compra em reais\n        ranking: Classifica\u00e7\u00e3o do produto (0-4)\n        forma_pagamento: Tipo de pagamento ('vista', '30d', '90d', '120d')\n\n    Returns:\n        dict com:\n        - valor_original: float\n        - tipo: str (\"Atacado\" ou \"Varejo\")\n        - ranking: int\n        - desconto_ranking: str (percentual aplicado pelo ranking)\n        - forma_pagamento: str\n        - desconto_pagamento: str (percentual por forma de pagamento)\n        - preco_final: float\n        - economia: float (valor economizado)\n        - detalhamento: str (explica\u00e7\u00e3o do c\u00e1lculo)\n\n    Example:\n        >>> result = calcular_preco_final_une(valor_compra=1000.0, ranking=0, forma_pagamento='vista')\n        >>> print(f\"Pre\u00e7o final: R$ {result['preco_final']:.2f}\")\n    \"\"\"\n    try:\n        # Valida\u00e7\u00e3o de inputs\n        if not isinstance(valor_compra, (int, float)) or valor_compra <= 0:\n            return {\"error\": \"valor_compra deve ser um n\u00famero positivo\"}\n\n        if not isinstance(ranking, int) or ranking < 0 or ranking > 4:\n            return {\"error\": \"ranking deve ser um inteiro entre 0 e 4\"}\n\n        formas_validas = ['vista', '30d', '90d', '120d']\n        if forma_pagamento not in formas_validas:\n            return {\"error\": f\"forma_pagamento deve ser uma das op\u00e7\u00f5es: {', '.join(formas_validas)}\"}\n\n        valor_original = float(valor_compra)\n\n        # Determinar tipo de pre\u00e7o (Atacado ou Varejo)\n        tipo_preco = \"Atacado\" if valor_compra >= 750.0 else \"Varejo\"\n\n        # Definir desconto por ranking\n        desconto_ranking_percent = 0.0\n\n        if ranking == 0:\n            desconto_ranking_percent = 38.0 if tipo_preco == \"Atacado\" else 30.0\n        elif ranking == 1:\n            desconto_ranking_percent = 38.0  # Pre\u00e7o \u00fanico\n            tipo_preco = \"\u00danico\"  # Override para ranking 1\n        elif ranking == 2:\n            desconto_ranking_percent = 38.0 if tipo_preco == \"Atacado\" else 30.0\n        elif ranking == 3:\n            desconto_ranking_percent = 0.0  # Sem desconto\n        elif ranking == 4:\n            desconto_ranking_percent = 38.0 if tipo_preco == \"Atacado\" else 24.0\n\n        # Aplicar desconto do ranking\n        valor_apos_ranking = valor_original * (1 - desconto_ranking_percent / 100)\n\n        # Definir desconto por forma de pagamento\n        descontos_pagamento = {\n            'vista': 38.0,\n            '30d': 36.0,\n            '90d': 34.0,\n            '120d': 30.0\n        }\n\n        desconto_pagamento_percent = descontos_pagamento[forma_pagamento]\n\n        # Aplicar desconto de forma de pagamento sobre o valor ap\u00f3s desconto de ranking\n        valor_final = valor_apos_ranking * (1 - desconto_pagamento_percent / 100)\n\n        # Calcular economia total\n        economia = valor_original - valor_final\n\n        # Gerar detalhamento do c\u00e1lculo\n        detalhamento_partes = [\n            f\"Valor original: R$ {valor_original:.2f}\",\n            f\"Tipo de pre\u00e7o: {tipo_preco} (valor {'>=' if valor_compra >= 750 else '<'} R$ 750,", "mimetype": "text/plain", "start_char_idx": 20655, "end_char_idx": 24056, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c30cd625-1ceb-40ca-a927-d240e4203047": {"__data__": {"id_": "c30cd625-1ceb-40ca-a927-d240e4203047", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "1a15d8fa-3213-4717-97ee-3a00a813c5df", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "30815973054dad731355153d565f6ba14ea21064d94c11ac64506ff53325cc3a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "907b793d-273e-4925-a483-d1868209a391", "node_type": "1", "metadata": {}, "hash": "5758dd2f951d75d44e45b93455f26c569119d657f9cc33f6ad4d68e5ad8c2866", "class_name": "RelatedNodeInfo"}}, "text": "0,\n            '30d': 36.0,\n            '90d': 34.0,\n            '120d': 30.0\n        }\n\n        desconto_pagamento_percent = descontos_pagamento[forma_pagamento]\n\n        # Aplicar desconto de forma de pagamento sobre o valor ap\u00f3s desconto de ranking\n        valor_final = valor_apos_ranking * (1 - desconto_pagamento_percent / 100)\n\n        # Calcular economia total\n        economia = valor_original - valor_final\n\n        # Gerar detalhamento do c\u00e1lculo\n        detalhamento_partes = [\n            f\"Valor original: R$ {valor_original:.2f}\",\n            f\"Tipo de pre\u00e7o: {tipo_preco} (valor {'>=' if valor_compra >= 750 else '<'} R$ 750,00)\"\n        ]\n\n        if desconto_ranking_percent > 0:\n            detalhamento_partes.append(\n                f\"Desconto ranking {ranking}: {desconto_ranking_percent}% -> R$ {valor_apos_ranking:.2f}\"\n            )\n        else:\n            detalhamento_partes.append(\n                f\"Ranking {ranking}: Sem desconto (pre\u00e7o tabela)\"\n            )\n\n        detalhamento_partes.append(\n            f\"Desconto pagamento ({forma_pagamento}): {desconto_pagamento_percent}% -> R$ {valor_final:.2f}\"\n        )\n        detalhamento_partes.append(\n            f\"Economia total: R$ {economia:.2f} ({(economia/valor_original)*100:.2f}%)\"\n        )\n\n        detalhamento = \" | \".join(detalhamento_partes)\n\n        logger.info(\n            f\"Pre\u00e7o calculado: R$ {valor_original:.2f} -> R$ {valor_final:.2f} \"\n            f\"(Ranking {ranking}, {forma_pagamento})\"\n        )\n\n        return {\n            \"valor_original\": round(valor_original, 2),\n            \"tipo\": tipo_preco,\n            \"ranking\": ranking,\n            \"desconto_ranking\": f\"{desconto_ranking_percent}%\" if desconto_ranking_percent > 0 else \"Sem desconto\",\n            \"forma_pagamento\": forma_pagamento,\n            \"desconto_pagamento\": f\"{desconto_pagamento_percent}%\",\n            \"preco_final\": round(valor_final, 2),\n            \"economia\": round(economia, 2),\n            \"percentual_economia\": round((economia / valor_original) * 100, 2),\n            \"detalhamento\": detalhamento\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro em calcular_preco_final_une: {e}\", exc_info=True)\n        return {\"error\": f\"Erro ao calcular pre\u00e7o final: {str(e)}\"}\n\n\n@tool\ndef validar_transferencia_produto(\n    produto_id: int,\n    une_origem: int,\n    une_destino: int,\n    quantidade: int\n) -> Dict[str, Any]:\n    \"\"\"\n    Valida se uma transfer\u00eancia de produto entre UNEs \u00e9 vi\u00e1vel e recomendada.\n\n    Aplica regras de neg\u00f3cio para verificar:\n    - Se UNE origem tem estoque suficiente\n    - Se UNE destino realmente precisa do produto\n    - Se a quantidade est\u00e1 dentro dos limites adequados\n    - Se a transfer\u00eancia \u00e9 priorit\u00e1ria baseada em linha verde e MC\n    - Incorpora a regra de ruptura cr\u00edtica (sem estoque no CD).\n\n    Args:\n        produto_id: C\u00f3digo do produto a transferir\n        une_origem: ID da UNE que vai enviar o produto\n        une_destino: ID da UNE que vai receber o produto\n        quantidade: Quantidade a transferir\n\n    Returns:\n        dict com:\n        - valido: bool (se a transfer\u00eancia \u00e9 v\u00e1lida)\n        - prioridade: str (\"URGENTE\", \"ALTA\", \"NORMAL\", \"BAIXA\", \"NAO_RECOMENDADA\")\n        - score_prioridade: float (0-100, quanto maior mais priorit\u00e1ria)\n        - motivo: str (justificativa da valida\u00e7\u00e3o)\n        - recomendacoes: list[str] (a\u00e7\u00f5es sugeridas)\n        ... e outros detalhes.\n    \"\"\"", "mimetype": "text/plain", "start_char_idx": 23415, "end_char_idx": 26851, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "907b793d-273e-4925-a483-d1868209a391": {"__data__": {"id_": "907b793d-273e-4925-a483-d1868209a391", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c30cd625-1ceb-40ca-a927-d240e4203047", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "a7cb3e356513830472311ceac8aabef662263237b5660bee7f8a2f28e5aadf62", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "172ced35-d90c-42d6-b58c-301018821d3f", "node_type": "1", "metadata": {}, "hash": "138fba15549fa96ca0061a4c14df03af1174a57db5883b88d2dfd0090822d9e7", "class_name": "RelatedNodeInfo"}}, "text": "Args:\n        produto_id: C\u00f3digo do produto a transferir\n        une_origem: ID da UNE que vai enviar o produto\n        une_destino: ID da UNE que vai receber o produto\n        quantidade: Quantidade a transferir\n\n    Returns:\n        dict com:\n        - valido: bool (se a transfer\u00eancia \u00e9 v\u00e1lida)\n        - prioridade: str (\"URGENTE\", \"ALTA\", \"NORMAL\", \"BAIXA\", \"NAO_RECOMENDADA\")\n        - score_prioridade: float (0-100, quanto maior mais priorit\u00e1ria)\n        - motivo: str (justificativa da valida\u00e7\u00e3o)\n        - recomendacoes: list[str] (a\u00e7\u00f5es sugeridas)\n        ... e outros detalhes.\n    \"\"\"\n    try:\n        # Valida\u00e7\u00e3o de inputs\n        if not isinstance(produto_id, int) or produto_id <= 0:\n            return {\"error\": \"produto_id deve ser um inteiro positivo\", \"valido\": False}\n        if not isinstance(une_origem, int) or une_origem <= 0:\n            return {\"error\": \"une_origem deve ser um inteiro positivo\", \"valido\": False}\n        if not isinstance(une_destino, int) or une_destino <= 0:\n            return {\"error\": \"une_destino deve ser um inteiro positivo\", \"valido\": False}\n        if une_origem == une_destino:\n            return {\"error\": \"UNE origem e destino n\u00e3o podem ser iguais\", \"valido\": False}\n        if not isinstance(quantidade, int) or quantidade <= 0:\n            return {\"error\": \"quantidade deve ser um inteiro positivo\", \"valido\": False}\n\n        logger.info(f\"Validando transfer\u00eancia: Produto {produto_id}, UNE {une_origem} -> {une_destino}, Qtd: {quantidade}\")\n\n        try:\n            # Carregar dados necess\u00e1rios, incluindo estoque_cd\n            colunas_necessarias = [\n                'codigo', 'nome_produto', 'une', 'estoque_atual', 'linha_verde',\n                'mc', 'venda_30_d', 'nomesegmento', 'estoque_cd'\n            ]\n            df = _load_data(filters={'codigo': produto_id}, columns=colunas_necessarias)\n            df = df[df['une'].isin([une_origem, une_destino])]\n        except Exception as e:\n            logger.error(f\"Erro ao carregar dados: {e}\")\n            return {\"error\": f\"Erro ao acessar dados: {str(e)}\", \"valido\": False}\n\n        # Dados da Origem\n        origem_df = df[df['une'] == une_origem]\n        if origem_df.empty:\n            return {\"valido\": False, \"motivo\": f\"Produto {produto_id} n\u00e3o encontrado na UNE origem {une_origem}\"}\n\n        # Dados do Destino\n        destino_df = df[df['une'] == une_destino]\n        if destino_df.empty:\n            return {\"valido\": False, \"motivo\": f\"Produto {produto_id} n\u00e3o encontrado na UNE destino {une_destino}\"}\n\n        origem = origem_df.iloc[0]\n        destino = destino_df.iloc[0]\n\n        # Extrair dados num\u00e9ricos com seguran\u00e7a\n        estoque_origem = float(origem.get('estoque_atual', 0))\n        linha_verde_origem = float(origem.get('linha_verde', 0))\n        estoque_destino = float(destino.get('estoque_atual', 0))\n        linha_verde_destino = float(destino.get('linha_verde', 0))\n        venda_30d_destino = float(destino.get('venda_30_d', 0))\n        mc_destino = float(destino.get('mc', 0))\n        estoque_cd = float(origem.get('estoque_cd', 0)) # Estoque do CD \u00e9 o mesmo para o produto\n\n        # --- Valida\u00e7\u00f5es de Bloqueio ---\n        if estoque_origem < quantidade:\n            return {\"valido\": False, \"motivo\": f\"Estoque insuficiente na origem.", "mimetype": "text/plain", "start_char_idx": 26254, "end_char_idx": 29545, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "172ced35-d90c-42d6-b58c-301018821d3f": {"__data__": {"id_": "172ced35-d90c-42d6-b58c-301018821d3f", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "907b793d-273e-4925-a483-d1868209a391", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "5b68bc42ed93ff9bd2154af429f5a3354b55ea90eb888c237c4b9961eb8621a2", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "56aed099-8241-4ce0-bc2c-a199c635ac21", "node_type": "1", "metadata": {}, "hash": "d63ec447e8236fcd21417b4fd4c6c56c9afb25da3cdb09e03286ebe34533a48e", "class_name": "RelatedNodeInfo"}}, "text": "Dispon\u00edvel: {estoque_origem:.0f}, Solicitado: {quantidade}\"}\n\n        estoque_origem_apos = estoque_origem - quantidade\n        perc_origem_apos = (estoque_origem_apos / linha_verde_origem * 100) if linha_verde_origem > 0 else 0.0\n        if perc_origem_apos < 50:\n            return {\"valido\": False, \"motivo\": f\"Transfer\u00eancia deixaria origem com estoque cr\u00edtico ({perc_origem_apos:.1f}% da linha verde)\"}\n\n        # --- C\u00e1lculo de Score de Prioridade ---\n        score_prioridade = 0.0\n        recomendacoes = []\n        \n        perc_origem = (estoque_origem / linha_verde_origem * 100) if linha_verde_origem > 0 else 0.0\n        perc_destino = (estoque_destino / linha_verde_destino * 100) if linha_verde_destino > 0 else 0.0\n\n        # Fator 1: Necessidade do destino (0-40 pontos)\n        if perc_destino < 25: score_prioridade += 40\n        elif perc_destino < 50: score_prioridade += 30\n        elif perc_destino < 75: score_prioridade += 20\n        else: score_prioridade += 5\n\n        # Fator 2: Excesso na origem (0-30 pontos)\n        if perc_origem > 150: score_prioridade += 30\n        elif perc_origem > 125: score_prioridade += 20\n        elif perc_origem > 100: score_prioridade += 10\n\n        # Fator 3: Demanda do destino (0-30 pontos)\n        if venda_30d_destino > 0:\n            dias_estoque_destino = estoque_destino / (venda_30d_destino / 30)\n            if dias_estoque_destino < 7: score_prioridade += 30\n            elif dias_estoque_destino < 15: score_prioridade += 20\n            elif dias_estoque_destino < 30: score_prioridade += 10\n        \n        # Fator 4: Ruptura Cr\u00edtica Sist\u00eamica (B\u00f4nus de 50 pontos)\n        if estoque_cd <= 0 and perc_destino < 75:\n            score_prioridade += 50\n            recomendacoes.append(\"ALERTA CR\u00cdTICO: Produto sem estoque no CD. Transfer\u00eancia de alta prioridade para evitar ruptura.\")\n\n        # --- Recomenda\u00e7\u00f5es Adicionais ---\n        pode_transferir = max(0, int(estoque_origem - linha_verde_origem)) if perc_origem > 100 else int(estoque_origem * 0.25)\n        pode_receber = max(0, int(linha_verde_destino - estoque_destino))\n        quantidade_recomendada = min(pode_transferir, pode_receber)\n        \n        if quantidade != quantidade_recomendada and quantidade_recomendada > 0:\n            recomendacoes.append(f\"Sugerimos transferir {quantidade_recomendada} unidades.\")\n        if perc_destino < 25:\n            recomendacoes.append(\"CR\u00cdTICO: Destino com estoque muito baixo.\")\n        if mc_destino > estoque_destino:\n            recomendacoes.append(\"MC do destino > estoque atual, indicando alta demanda.\")\n        if not recomendacoes:\n            recomendacoes.append(\"Transfer\u00eancia dentro dos padr\u00f5es normais.\")", "mimetype": "text/plain", "start_char_idx": 29546, "end_char_idx": 32246, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "56aed099-8241-4ce0-bc2c-a199c635ac21": {"__data__": {"id_": "56aed099-8241-4ce0-bc2c-a199c635ac21", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "172ced35-d90c-42d6-b58c-301018821d3f", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "db3f37fd65d31cff6b3d62cf188b91a35dc35729844d42e45e35a076b88ca3de", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "262c8b90-f76b-4006-a322-4e07d3446f4b", "node_type": "1", "metadata": {}, "hash": "3de9032b59e9a78b1c87f85c0b6dbef432823345440d4a23dab14b76cf92b4bc", "class_name": "RelatedNodeInfo"}}, "text": "if perc_destino < 25:\n            recomendacoes.append(\"CR\u00cdTICO: Destino com estoque muito baixo.\")\n        if mc_destino > estoque_destino:\n            recomendacoes.append(\"MC do destino > estoque atual, indicando alta demanda.\")\n        if not recomendacoes:\n            recomendacoes.append(\"Transfer\u00eancia dentro dos padr\u00f5es normais.\")\n\n        # --- Determinar Prioridade Final ---\n        if score_prioridade >= 90: prioridade = \"URGENTE\"\n        elif score_prioridade >= 70: prioridade = \"ALTA\"\n        elif score_prioridade >= 40: prioridade = \"NORMAL\"\n        else: prioridade = \"BAIXA\"\n\n        # --- Montar Resposta ---\n        resultado = {\n            \"valido\": True,\n            \"produto_id\": int(produto_id),\n            \"nome_produto\": str(origem.get('nome_produto', \"N/A\")),\n            \"prioridade\": prioridade,\n            \"score_prioridade\": round(score_prioridade, 2),\n            \"quantidade_recomendada\": int(quantidade_recomendada),\n            \"motivo\": f\"Transfer\u00eancia v\u00e1lida com prioridade {prioridade}\",\n            \"recomendacoes\": recomendacoes,\n            # ... (outros detalhes podem ser adicionados aqui)\n        }\n        return resultado\n\n    except Exception as e:\n        logger.error(f\"Erro em validar_transferencia_produto: {e}\", exc_info=True)\n        return {\"error\": f\"Erro ao validar transfer\u00eancia: {str(e)}\", \"valido\": False}\n\n\n@tool\ndef sugerir_transferencias_automaticas(limite: int = 20, une_origem_filtro: int = None, une_destino_id: int = None) -> Dict[str, Any]:\n    \"\"\"\n    Sugere transfer\u00eancias autom\u00e1ticas entre UNEs baseadas em regras de neg\u00f3cio.\n\n    Identifica oportunidades de balanceamento de estoque considerando:\n    - UNEs com excesso de estoque (>100% linha verde)\n    - UNEs com falta de estoque (<50% linha verde)\n    - MC (M\u00e9dia Comum) e hist\u00f3rico de vendas\n    - Prioriza\u00e7\u00e3o por criticidade\n\n    Args:\n        limite: N\u00famero m\u00e1ximo de sugest\u00f5es a retornar (default: 20)\n        une_origem_filtro: Filtrar sugest\u00f5es apenas desta UNE origem (opcional)\n\n    Returns:\n        dict com:\n        - total_sugestoes: int\n        - sugestoes: list[dict] (sugest\u00f5es ordenadas por prioridade)\n        - estatisticas: dict (resumo das sugest\u00f5es)\n\n    Cada sugest\u00e3o cont\u00e9m:\n        - produto_id: int\n        - nome_produto: str\n        - une_origem: int\n        - une_destino: int\n        - quantidade_sugerida: int\n        - prioridade: str\n        - score: float\n        - motivo: str\n        - beneficio_estimado: str\n\n    Example:\n        >>> result = sugerir_transferencias_automaticas(limite=10, une_origem_filtro=3116)\n        >>> for sug in result['sugestoes']:\n        .     print(f\"{sug['nome_produto']}: UNE {sug['une_origem']} -> {sug['une_destino']}\")\n    \"\"\"\n    try:\n        if not isinstance(limite, int) or limite <= 0:\n            return {\"error\": \"limite deve ser um inteiro positivo\"}\n\n        if une_origem_filtro is not None and (not isinstance(une_origem_filtro, int) or une_origem_filtro <= 0):\n            return {\"error\": \"une_origem_filtro deve ser um inteiro positivo ou None\"}\n\n        logger.info(f\"Gerando sugest\u00f5es autom\u00e1ticas de transfer\u00eancias (limite: {limite})\")\n\n        try:\n            # OTIMIZA\u00c7\u00c3O: Usar PyArrow diretamente para carregar dataset completo de forma eficiente\n            import pyarrow.parquet as pq\n            from pathlib import Path\n\n            parquet_path = Path(os.getcwd()) / 'data' / 'parquet' / 'admmat_extended.parquet'\n\n            if not parquet_path.exists():\n                parquet_path = Path(os.getcwd()) / 'data' / 'parquet' / 'admmat.parquet'\n\n            # Carregar apenas colunas necess\u00e1rias (reduz I/O significativamente)\n            colunas_parquet = ['codigo', 'nome_produto', 'une', 'estoque_atual',", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "262c8b90-f76b-4006-a322-4e07d3446f4b": {"__data__": {"id_": "262c8b90-f76b-4006-a322-4e07d3446f4b", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "56aed099-8241-4ce0-bc2c-a199c635ac21", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "f58d4024898d6c4b5bab47046933133b393501551ddfe918d88098917114dade", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "befd36bd-acb9-4a23-aece-e7f1d077b9b1", "node_type": "1", "metadata": {}, "hash": "5ca7a53c8cc57f60aefe91b3e532684b42469fa52335b9e561bc684353fd5eec", "class_name": "RelatedNodeInfo"}}, "text": "info(f\"Gerando sugest\u00f5es autom\u00e1ticas de transfer\u00eancias (limite: {limite})\")\n\n        try:\n            # OTIMIZA\u00c7\u00c3O: Usar PyArrow diretamente para carregar dataset completo de forma eficiente\n            import pyarrow.parquet as pq\n            from pathlib import Path\n\n            parquet_path = Path(os.getcwd()) / 'data' / 'parquet' / 'admmat_extended.parquet'\n\n            if not parquet_path.exists():\n                parquet_path = Path(os.getcwd()) / 'data' / 'parquet' / 'admmat.parquet'\n\n            # Carregar apenas colunas necess\u00e1rias (reduz I/O significativamente)\n            colunas_parquet = ['codigo', 'nome_produto', 'une', 'estoque_atual', 'estoque_lv',\n                              'media_considerada_lv', 'venda_30_d', 'nomesegmento']\n\n            logger.info(f\"Carregando dados do Parquet com PyArrow: {parquet_path}\")\n            table = pq.read_table(parquet_path, columns=colunas_parquet)\n            df = table.to_pandas()\n\n            # Normalizar nomes de colunas\n            df = df.rename(columns={\n                'estoque_lv': 'linha_verde',\n                'media_considerada_lv': 'mc'\n            })\n\n            # Converter colunas num\u00e9ricas (CR\u00cdTICO para evitar erros de compara\u00e7\u00e3o)\n            for col in ['estoque_atual', 'linha_verde', 'mc', 'venda_30_d']:\n                if col in df.columns:\n                    df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)\n\n            logger.info(f\"Dados carregados: {len(df)} registros, {len(df['codigo'].unique())} produtos \u00fanicos\")\n\n        except Exception as e:\n            logger.error(f\"Erro ao carregar dados: {e}\")\n            return {\"error\": f\"Erro ao acessar dados: {str(e)}\"}\n\n        # Calcular percentual de linha verde para todos os produtos (VETORIZADO para performance)\n        df['perc_linha_verde'] = 0.0  # Inicializar com zero\n        mask = (df['linha_verde'] > 0)  # Apenas onde linha_verde > 0\n        df.loc[mask, 'perc_linha_verde'] = (df.loc[mask, 'estoque_atual'] / df.loc[mask, 'linha_verde'] * 100)\n\n        # Identificar UNEs com excesso (>100% linha verde)\n        df_excesso = df[df['perc_linha_verde'] > 100].copy()\n        logger.info(f\"Produtos com excesso (perc_linha_verde > 100): {len(df_excesso)}\")\n\n        # Identificar UNEs com falta (<75% linha verde)\n        df_falta = df[df['perc_linha_verde'] < 75].copy()\n        logger.info(f\"Produtos com falta (perc_linha_verde < 75): {len(df_falta)}\")\n\n        if df_excesso.empty or df_falta.empty:\n            logger.info(\"df_excesso ou df_falta est\u00e3o vazios, retornando 0 sugest\u00f5es.\")\n            return {\n                \"total_sugestoes\": 0,\n                \"sugestoes\": [],\n                \"mensagem\": \"N\u00e3o h\u00e1 oportunidades de transfer\u00eancia no momento\",\n                \"estatisticas\": {\n                    \"produtos_com_excesso\": len(df_excesso),\n                    \"produtos_com_falta\": len(df_falta)\n                }\n            }\n\n        sugestoes = []\n\n        # OTIMIZA\u00c7\u00c3O: Limitar busca apenas aos produtos mais cr\u00edticos para evitar timeout\n        # Ordenar por criticidade (menor percentual = mais cr\u00edtico)\n        produtos_criticos = df_falta.nsmallest(500, 'perc_linha_verde')['codigo'].unique()\n        logger.info(f\"Analisando {len(produtos_criticos)} produtos cr\u00edticos (top 500 por necessidade)\")\n\n        # Agrupar por produto para encontrar oportunidades\n        for produto_id in produtos_criticos:\n            # Early stopping: se j\u00e1 temos sugest\u00f5es suficientes, parar\n            if len(sugestoes) >= limite * 2:  # Coletar 2x o limite para ter op\u00e7\u00f5es ap\u00f3s ordena\u00e7\u00e3o\n                logger.info(f\"Limite de sugest\u00f5es atingido ({len(sugestoes)}), parando a gera\u00e7\u00e3o.\")", "mimetype": "text/plain", "start_char_idx": 34985, "end_char_idx": 38660, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "befd36bd-acb9-4a23-aece-e7f1d077b9b1": {"__data__": {"id_": "befd36bd-acb9-4a23-aece-e7f1d077b9b1", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "262c8b90-f76b-4006-a322-4e07d3446f4b", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "34ff0818c129ab7d9a1f1d8383eede78a00aca8de260faaa6b74f774bb135d1b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "fcb3aeaf-f895-468e-a379-f70ff91ace81", "node_type": "1", "metadata": {}, "hash": "8e15754f0a2552c0af9780536fe1dee3a3dc6d0144f86b340c318e820ab3a2a2", "class_name": "RelatedNodeInfo"}}, "text": "break\n\n            # Pegar todas as UNEs com excesso deste produto\n            produto_excesso = df_excesso[df_excesso['codigo'] == produto_id]\n\n            # Pegar todas as UNEs com falta deste produto\n            produto_falta = df_falta[df_falta['codigo'] == produto_id]\n\n            if produto_falta.empty:\n                continue\n\n            # Para cada UNE com excesso, encontrar melhor destino (limitar a 5 origens por produto)\n            for _, origem in produto_excesso.head(5).iterrows():\n                estoque_origem = float(origem['estoque_atual'])\n                linha_verde_origem = float(origem['linha_verde'])\n                une_origem = int(origem['une'])\n\n                # FILTRO: Se une_origem_filtro foi especificado, pular UNEs diferentes\n                if une_origem_filtro is not None and une_origem != une_origem_filtro:\n                    continue\n\n                # Quantidade dispon\u00edvel para transferir (excesso)\n                qtd_disponivel = int(estoque_origem - linha_verde_origem)\n\n                if qtd_disponivel <= 0:\n                    continue\n\n                # Ordenar destinos por prioridade (menor percentual primeiro) e limitar a 3 destinos\n                for _, destino in produto_falta.sort_values('perc_linha_verde').head(3).iterrows():\n                    une_destino = int(destino['une'])\n\n                    if une_destino_id is not None and une_destino != une_destino_id:\n                        continue\n\n                    if une_origem == une_destino:\n                        continue\n\n                    estoque_destino = float(destino['estoque_atual'])\n                    linha_verde_destino = float(destino['linha_verde'])\n                    perc_destino = float(destino['perc_linha_verde'])\n                    mc_destino = float(destino['mc']) if pd.notna(destino['mc']) else 0.0\n                    venda_30d = float(destino['venda_30_d']) if pd.notna(destino['venda_30_d']) else 0.0\n\n                    # Quantidade necess\u00e1ria no destino\n                    qtd_necessaria = int(linha_verde_destino - estoque_destino)\n\n                    if qtd_necessaria <= 0:\n                        continue\n\n                    # Quantidade sugerida (m\u00ednimo entre dispon\u00edvel e necess\u00e1rio)\n                    qtd_sugerida = min(qtd_disponivel, qtd_necessaria)\n\n                    # Calcular score de prioridade\n                    score = 0.0\n\n                    # Fator 1: Criticidade do destino (0-50 pontos)\n                    if perc_destino < 25:\n                        score += 50\n                        prioridade = \"URGENTE\"\n                    elif perc_destino < 50:\n                        score += 35\n                        prioridade = \"ALTA\"\n                    elif perc_destino < 75:\n                        score += 20\n                        prioridade = \"NORMAL\"\n                    else:\n                        score += 10\n                        prioridade = \"BAIXA\"\n\n                    # Fator 2: Excesso na origem (0-25 pontos)\n                    perc_origem = float(origem['perc_linha_verde'])\n                    if perc_origem > 150:\n                        score += 25\n                    elif perc_origem > 125:\n                        score += 15\n                    elif perc_origem > 100:\n                        score += 10\n\n                    # Fator 3: Demanda do produto no destino (0-25 pontos)\n                    if venda_30d > 0:\n                        dias_estoque = estoque_destino / (venda_30d / 30)\n                        if dias_estoque < 7:\n                            score += 25\n                        elif dias_estoque < 15:\n                            score += 15\n                        elif dias_estoque < 30:\n                            score += 10\n\n                    # Gerar motivo\n                    motivo_partes = []\n                    if perc_destino < 50:\n                        motivo_partes.append(f\"Destino cr\u00edtico ({perc_destino:.1f}% LV)\")\n                    if perc_origem > 125:\n                        motivo_partes.append(f\"Origem com excesso ({perc_origem:.1f}% LV)\")\n                    if venda_30d > 0 and dias_estoque < 15:\n                        motivo_partes.append(f\"Alta demanda ({dias_estoque:.0f} dias estoque)\")\n\n                    motivo = \" | \".", "mimetype": "text/plain", "start_char_idx": 38677, "end_char_idx": 42992, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "fcb3aeaf-f895-468e-a379-f70ff91ace81": {"__data__": {"id_": "fcb3aeaf-f895-468e-a379-f70ff91ace81", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "befd36bd-acb9-4a23-aece-e7f1d077b9b1", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "0f8fe6aa3410679fe513a1aa417c784f6c2897b0331ac99a11d0c1ab7284b873", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c7a18404-9c81-49f8-844e-4fb9a5c486e9", "node_type": "1", "metadata": {}, "hash": "8778a3e7b878d0c9505aed5b6cf84ef2c415362b7ee964fc6ad0ff479a7e26c2", "class_name": "RelatedNodeInfo"}}, "text": "append(f\"Destino cr\u00edtico ({perc_destino:.1f}% LV)\")\n                    if perc_origem > 125:\n                        motivo_partes.append(f\"Origem com excesso ({perc_origem:.1f}% LV)\")\n                    if venda_30d > 0 and dias_estoque < 15:\n                        motivo_partes.append(f\"Alta demanda ({dias_estoque:.0f} dias estoque)\")\n\n                    motivo = \" | \".join(motivo_partes) if motivo_partes else \"Balanceamento de estoque\"\n\n                    # Calcular benef\u00edcio estimado\n                    melhoria_destino = (estoque_destino + qtd_sugerida) / linha_verde_destino * 100 if linha_verde_destino > 0 else 0\n                    beneficio = f\"Destino: {perc_destino:.1f}% -> {melhoria_destino:.1f}% da linha verde\"\n\n                    sugestao = {\n                        \"produto_id\": int(produto_id),\n                        \"nome_produto\": str(origem['nome_produto']) if pd.notna(origem['nome_produto']) else \"N/A\",\n                        \"segmento\": str(origem['nomesegmento']) if 'nomesegmento' in origem and pd.notna(origem['nomesegmento']) else \"N/A\",\n                        \"une_origem\": une_origem,\n                        \"une_destino\": une_destino,\n                        \"quantidade_sugerida\": qtd_sugerida,\n                        \"prioridade\": prioridade,\n                        \"score\": round(score, 2),\n                        \"motivo\": motivo,\n                        \"beneficio_estimado\": beneficio,\n                        \"detalhes\": {\n                            \"origem\": {\n                                \"estoque\": estoque_origem,\n                                \"linha_verde\": linha_verde_origem,\n                                \"percentual\": round(perc_origem, 2)\n                            },\n                            \"destino\": {\n                                \"estoque\": estoque_destino,\n                                \"linha_verde\": linha_verde_destino,\n                                \"percentual\": round(perc_destino, 2),\n                                \"mc\": mc_destino,\n                                \"venda_30d\": venda_30d\n                            }\n                        }\n                    }\n\n                    sugestoes.append(sugestao)\n\n                    # Atualizar quantidade dispon\u00edvel\n                    qtd_disponivel -= qtd_sugerida\n                    if qtd_disponivel <= 0:\n                        break\n        logger.info(f\"Total de sugest\u00f5es geradas antes da ordena\u00e7\u00e3o e limite: {len(sugestoes)}\")\n\n        # Ordenar sugest\u00f5es por score (maior primeiro)\n        sugestoes_ordenadas = sorted(sugestoes, key=lambda x: x['score'], reverse=True)\n\n        # Limitar ao n\u00famero solicitado\n        sugestoes_final = sugestoes_ordenadas[:limite]\n\n        # Calcular estat\u00edsticas\n        total_sugestoes = len(sugestoes_final)\n        urgentes = len([s for s in sugestoes_final if s['prioridade'] == 'URGENTE'])\n        altas = len([s for s in sugestoes_final if s['prioridade'] == 'ALTA'])\n        normais = len([s for s in sugestoes_final if s['prioridade'] == 'NORMAL'])\n        baixas = len([s for s in sugestoes_final if s['prioridade'] == 'BAIXA'])\n        total_unidades = sum([s['quantidade_sugerida'] for s in sugestoes_final])\n\n        logger.info(f\"Geradas {total_sugestoes} sugest\u00f5es de transfer\u00eancia\")\n\n        return {\n            \"total_sugestoes\": total_sugestoes,\n            \"sugestoes\": sugestoes_final,\n            \"estatisticas\": {\n                \"total\": total_sugestoes,\n                \"urgentes\": urgentes,\n                \"altas\": altas,\n                \"normais\": normais,\n                \"baixas\": baixas,\n                \"total_unidades\": total_unidades,\n                \"produtos_unicos\": len(set([s['produto_id'] for s in sugestoes_final])),\n                \"unes_origem\": len(set([s['une_origem'] for s in sugestoes_final])),\n                \"unes_destino\": len(set([s['une_destino'] for s in sugestoes_final]))\n            }\n        }\n\n    except Exception as e:\n        logger.", "mimetype": "text/plain", "start_char_idx": 42614, "end_char_idx": 46614, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c7a18404-9c81-49f8-844e-4fb9a5c486e9": {"__data__": {"id_": "c7a18404-9c81-49f8-844e-4fb9a5c486e9", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "fcb3aeaf-f895-468e-a379-f70ff91ace81", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "63cfd52bbb8411af8fbd7be8dc6f81a3a6812a6555601007387e50ff1ce21b4a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "eb4630ce-dd89-4cf4-accd-8d30c2f1a1e9", "node_type": "1", "metadata": {}, "hash": "bda72d75f6d372deac2a84a54794dc1006020409d71c7753587f7a4d01bf6bdf", "class_name": "RelatedNodeInfo"}}, "text": "\"sugestoes\": sugestoes_final,\n            \"estatisticas\": {\n                \"total\": total_sugestoes,\n                \"urgentes\": urgentes,\n                \"altas\": altas,\n                \"normais\": normais,\n                \"baixas\": baixas,\n                \"total_unidades\": total_unidades,\n                \"produtos_unicos\": len(set([s['produto_id'] for s in sugestoes_final])),\n                \"unes_origem\": len(set([s['une_origem'] for s in sugestoes_final])),\n                \"unes_destino\": len(set([s['une_destino'] for s in sugestoes_final]))\n            }\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro em sugerir_transferencias_automaticas: {e}\", exc_info=True)\n        return {\"error\": f\"Erro ao gerar sugest\u00f5es: {str(e)}\"}\n\n\n@tool\n@error_handler_decorator(\n    context_func=lambda une_id: {\"une_id\": une_id, \"funcao\": \"calcular_produtos_sem_vendas\"},\n    return_on_error={\"error\": \"Erro ao calcular produtos sem vendas\", \"total_produtos\": 0, \"produtos\": []}\n)\ndef calcular_produtos_sem_vendas(une_id: int, limite: int = 50, fabricante: str = None) -> Dict[str, Any]:\n    \"\"\"\n    Identifica produtos sem vendas (VENDA_30DD = 0) em uma UNE, com filtro opcional por fabricante.", "mimetype": "text/plain", "start_char_idx": 45995, "end_char_idx": 47201, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "eb4630ce-dd89-4cf4-accd-8d30c2f1a1e9": {"__data__": {"id_": "eb4630ce-dd89-4cf4-accd-8d30c2f1a1e9", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c7a18404-9c81-49f8-844e-4fb9a5c486e9", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "74a50dce4bbb12d6fc25b79e1349e0d71b5101410aabf9dabb436651654c178d", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "d479f69b-3ded-49af-b22d-3f26cb9e53a4", "node_type": "1", "metadata": {}, "hash": "e0e1588c8dc7c2b27cef397b7e6eda631dd52aafc3c5d804ed84c7274dfda8ce", "class_name": "RelatedNodeInfo"}}, "text": "error(f\"Erro em sugerir_transferencias_automaticas: {e}\", exc_info=True)\n        return {\"error\": f\"Erro ao gerar sugest\u00f5es: {str(e)}\"}\n\n\n@tool\n@error_handler_decorator(\n    context_func=lambda une_id: {\"une_id\": une_id, \"funcao\": \"calcular_produtos_sem_vendas\"},\n    return_on_error={\"error\": \"Erro ao calcular produtos sem vendas\", \"total_produtos\": 0, \"produtos\": []}\n)\ndef calcular_produtos_sem_vendas(une_id: int, limite: int = 50, fabricante: str = None) -> Dict[str, Any]:\n    \"\"\"\n    Identifica produtos sem vendas (VENDA_30DD = 0) em uma UNE, com filtro opcional por fabricante.\n\n    Esta ferramenta \u00e9 \u00fatil para:\n    - Identificar produtos sem giro\n    - Detectar itens parados em estoque\n    - Analisar a ruptura de um fabricante espec\u00edfico\n\n    Args:\n        une_id: ID da UNE (ex: 2586 para SCR, 261 para MAD)\n        limite: N\u00famero m\u00e1ximo de produtos a retornar (default: 50)\n        fabricante: Nome do fabricante para filtrar os resultados (opcional)\n\n    Returns:\n        dict com:\n        - total_produtos: int (total de produtos sem vendas)\n        - produtos: list[dict] (produtos sem vendas com estoque > 0)\n        - une_id: int\n        - criterio: str (descri\u00e7\u00e3o do filtro aplicado)\n\n    Example:\n        >>> result = calcular_produtos_sem_vendas(une_id=2586, limite=20, fabricante=\"KIT\")\n        >>> print(f\"Total: {result['total_produtos']} produtos sem vendas do fabricante KIT\")\n    \"\"\"\n    # Valida\u00e7\u00e3o de inputs\n    if not isinstance(une_id, int) or une_id <= 0:\n        return {\"error\": \"une_id deve ser um inteiro positivo\"}\n\n    if not isinstance(limite, int) or limite <= 0:\n        limite = 50\n\n    logger.info(f\"Buscando produtos sem vendas na UNE {une_id} para o fabricante {fabricante or 'Todos'}\")\n\n    # Construir filtros\n    filters = {'une': une_id}\n    if fabricante:\n        # Usar o nome real da coluna no Parquet\n        filters['NOMEFABRICANTE'] = fabricante.upper()\n\n    # Carregar dados da UNE\n    df = _load_data(\n        filters=filters,\n        columns=['codigo', 'nome_produto', 'une', 'estoque_atual', 'venda_30_d',\n                'linha_verde', 'nomesegmento', 'mc', 'NOMEFABRICANTE']\n    )\n\n    if df.empty:\n        logger.warning(f\"Nenhum dado encontrado para UNE {une_id} e fabricante {fabricante}\")\n        return {\n            \"error\": f\"Nenhum dado encontrado para UNE {une_id} com o filtro de fabricante '{fabricante}'\",\n            \"une_id\": une_id,\n            \"total_produtos\": 0,\n            \"produtos\": []\n        }\n\n    # Normalizar DataFrame\n    df = _normalize_dataframe(df)\n\n    # Filtrar produtos SEM vendas (venda_30_d = 0) mas COM estoque\n    df_sem_vendas = df[\n        (df['venda_30_d'] == 0) &\n        (df['estoque_atual'] > 0)\n    ].copy()\n\n    total_produtos = len(df_sem_vendas)\n\n    if total_produtos == 0:\n        return {\n            \"total_produtos\": 0,\n            \"produtos\": [],\n            \"une_id\": une_id,\n            \"criterio\": \"VENDA_30DD = 0 E ESTOQUE > 0\" + (f\" E NOMEFABRICANTE = '{fabricante.upper()}'\" if fabricante else \"\"),\n            \"mensagem\": \"Nenhum produto sem vendas encontrado com os filtros aplicados.\"", "mimetype": "text/plain", "start_char_idx": 46614, "end_char_idx": 49724, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d479f69b-3ded-49af-b22d-3f26cb9e53a4": {"__data__": {"id_": "d479f69b-3ded-49af-b22d-3f26cb9e53a4", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "eb4630ce-dd89-4cf4-accd-8d30c2f1a1e9", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "2fbf557398b0a69b6c8409e998897e76e0a6ed1528a232c13bacaf74a0f3b9ff", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "a5fa4e16-cd42-484d-8dea-35f7f0f82e19", "node_type": "1", "metadata": {}, "hash": "c2c798b77da7f24f0f55e863b8f0d470e9b05cbcc0ab95e2295f5cb1d8520f86", "class_name": "RelatedNodeInfo"}}, "text": "}\n\n    # Ordenar por estoque (produtos com mais estoque parado = mais cr\u00edticos)\n    df_sem_vendas = df_sem_vendas.sort_values('estoque_atual', ascending=False)\n\n    # Limitar ao n\u00famero solicitado\n    top_produtos = df_sem_vendas.head(limite)\n\n    # Preparar lista de produtos\n    produtos = []\n    for _, row in top_produtos.iterrows():\n        produto = {\n            \"codigo\": int(row['codigo']) if pd.notna(row['codigo']) else None,\n            \"nome_produto\": str(row['nome_produto']) if pd.notna(row['nome_produto']) else \"N/A\",\n            \"segmento\": str(row['nomesegmento']) if 'nomesegmento' in row and pd.notna(row['nomesegmento']) else \"N/A\",\n            \"estoque_atual\": float(row['estoque_atual']) if pd.notna(row['estoque_atual']) else 0.0,\n            \"linha_verde\": float(row['linha_verde']) if pd.notna(row['linha_verde']) else 0.0,\n            \"venda_30d\": 0.0,  # Sempre zero (crit\u00e9rio da busca)\n            \"dias_sem_venda\": \"> 30 dias\"\n        }\n        produtos.append(produto)\n\n    logger.info(f\"Encontrados {total_produtos} produtos sem vendas na UNE {une_id} para o fabricante {fabricante or 'Todos'}\")\n\n    return {\n        \"total_produtos\": total_produtos,\n        \"produtos\": produtos,\n        \"une_id\": une_id,\n        \"criterio\": \"VENDA_30DD = 0 E ESTOQUE > 0\" + (f\" E NOMEFABRICANTE = '{fabricante.upper()}'\" if fabricante else \"\"),\n        \"limite_exibido\": len(produtos),\n        \"recomendacao\": \"Considere a\u00e7\u00f5es promocionais ou transfer\u00eancia para UNEs com demanda\" if total_produtos > 0 else None\n    }\n\n\n@tool\n@error_handler_decorator(\n    context_func=lambda: {\"funcao\": \"encontrar_rupturas_criticas\"},\n    return_on_error={\"error\": \"Erro ao encontrar rupturas cr\u00edticas\", \"total_criticos\": 0, \"produtos_criticos\": []}\n)\ndef encontrar_rupturas_criticas(limite: Optional[int] = 100) -> Dict[str, Any]:\n    \"\"\"\n    Identifica produtos em situa\u00e7\u00e3o de ruptura cr\u00edtica sist\u00eamica, ordenados por gravidade.\n\n    A regra de neg\u00f3cio para ruptura cr\u00edtica \u00e9:\n    1. O estoque no Centro de Distribui\u00e7\u00e3o (CD) \u00e9 zero ou negativo (estoque_cd <= 0).\n    2. O estoque na UNE (loja) est\u00e1 abaixo da linha verde (estoque_atual < linha_verde).\n\n    A lista \u00e9 ordenada para mostrar primeiro os produtos com \"Estoque Negativo Cr\u00edtico\"\n    e depois por 'percentual_cobertura' (do menor para o maior), que representa\n    o qu\u00e3o cheio o estoque est\u00e1 em rela\u00e7\u00e3o \u00e0 linha verde.\n\n    Args:\n        limite: N\u00famero m\u00e1ximo de produtos cr\u00edticos a retornar. Se None, retorna todos.", "mimetype": "text/plain", "start_char_idx": 49733, "end_char_idx": 52215, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a5fa4e16-cd42-484d-8dea-35f7f0f82e19": {"__data__": {"id_": "a5fa4e16-cd42-484d-8dea-35f7f0f82e19", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "d479f69b-3ded-49af-b22d-3f26cb9e53a4", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "ce2e313a06a4cb754e52219c56e9b20669e11439e125eb0415d61ebc20ba14ce", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "a617a3fd-f0b2-42c8-a192-ed00c56ecde2", "node_type": "1", "metadata": {}, "hash": "207a8d1a8ceaa11010e257944985c164ca843e0a6c0385a28de4c6d0c9435d77", "class_name": "RelatedNodeInfo"}}, "text": "A regra de neg\u00f3cio para ruptura cr\u00edtica \u00e9:\n    1. O estoque no Centro de Distribui\u00e7\u00e3o (CD) \u00e9 zero ou negativo (estoque_cd <= 0).\n    2. O estoque na UNE (loja) est\u00e1 abaixo da linha verde (estoque_atual < linha_verde).\n\n    A lista \u00e9 ordenada para mostrar primeiro os produtos com \"Estoque Negativo Cr\u00edtico\"\n    e depois por 'percentual_cobertura' (do menor para o maior), que representa\n    o qu\u00e3o cheio o estoque est\u00e1 em rela\u00e7\u00e3o \u00e0 linha verde.\n\n    Args:\n        limite: N\u00famero m\u00e1ximo de produtos cr\u00edticos a retornar. Se None, retorna todos.\n\n    Returns:\n        dict com:\n        - total_criticos: int (total de produtos em situa\u00e7\u00e3o cr\u00edtica)\n        - produtos_criticos: list[dict] (lista dos produtos, incluindo 'motivo_ruptura', 'alerta_de_estoque' e 'percentual_cobertura')\n        - criterio: str (descri\u00e7\u00e3o da regra aplicada)\n\n    Example:\n        >>> result = encontrar_rupturas_criticas(limite=10)\n        >>> print(f\"Total de produtos cr\u00edticos: {result['total_criticos']}\")\n    \"\"\"\n    try:\n        logger.info(f\"Buscando produtos em ruptura cr\u00edtica (limite: {limite})\")\n\n        # Carregar dados necess\u00e1rios de forma otimizada, incluindo venda_30_d\n        colunas_necessarias = [\n            'codigo', 'nome_produto', 'une', 'une_nome', 'estoque_atual',\n            'linha_verde', 'estoque_cd', 'nomesegmento', 'venda_30_d'\n        ]\n        \n        # Usar _load_data para abstrair a fonte de dados\n        df = _load_data(columns=colunas_necessarias)\n\n        if df.empty:\n            return {\n                \"total_criticos\": 0,\n                \"produtos_criticos\": [],\n                \"mensagem\": \"Nenhum dado de produto encontrado.\"\n            }\n\n        # Garantir que as colunas num\u00e9ricas s\u00e3o do tipo correto\n        for col in ['estoque_cd', 'estoque_atual', 'linha_verde', 'venda_30_d']:\n            df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)\n\n        # Aplicar a regra de neg\u00f3cio\n        # 1. Estoque no CD <= 0\n        df_sem_estoque_cd = df[df['estoque_cd'] <= 0]\n\n        if df_sem_estoque_cd.empty:\n            return {\n                \"total_criticos\": 0,\n                \"produtos_criticos\": [],\n                \"mensagem\": \"Nenhum produto encontrado com estoque zerado no CD.\"\n            }\n\n        # 2. Estoque na UNE < Linha Verde\n        df_criticos = df_sem_estoque_cd[df_sem_estoque_cd['estoque_atual'] < df_sem_estoque_cd['linha_verde']].copy()\n\n        total_criticos = len(df_criticos)\n\n        if total_criticos == 0:\n            return {\n                \"total_criticos\": 0,\n                \"produtos_criticos\": [],\n                \"criterio\": \"estoque_cd <= 0 E estoque_atual < linha_verde\",\n                \"mensagem\": \"Nenhuma ruptura cr\u00edtica encontrada. Todas as UNEs com estoque abaixo da linha verde possuem cobertura no CD.\"", "mimetype": "text/plain", "start_char_idx": 51673, "end_char_idx": 54464, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a617a3fd-f0b2-42c8-a192-ed00c56ecde2": {"__data__": {"id_": "a617a3fd-f0b2-42c8-a192-ed00c56ecde2", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "a5fa4e16-cd42-484d-8dea-35f7f0f82e19", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "8dcafe540413a7b1b5eb74e4239ccd53a80ae21c8c0121a1233d437d3fff6b38", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "7610e168-59f1-40e8-9dc0-a9df04ff6b02", "node_type": "1", "metadata": {}, "hash": "654bf2dfe58db11634f4254e4b74eeb113c6b3cff6804afadb28074a8de321f8", "class_name": "RelatedNodeInfo"}}, "text": "}\n\n        # 2. Estoque na UNE < Linha Verde\n        df_criticos = df_sem_estoque_cd[df_sem_estoque_cd['estoque_atual'] < df_sem_estoque_cd['linha_verde']].copy()\n\n        total_criticos = len(df_criticos)\n\n        if total_criticos == 0:\n            return {\n                \"total_criticos\": 0,\n                \"produtos_criticos\": [],\n                \"criterio\": \"estoque_cd <= 0 E estoque_atual < linha_verde\",\n                \"mensagem\": \"Nenhuma ruptura cr\u00edtica encontrada. Todas as UNEs com estoque abaixo da linha verde possuem cobertura no CD.\"\n            }\n\n        # Adicionar campos para alerta e ordena\u00e7\u00e3o\n        df_criticos['alerta_de_estoque'] = df_criticos['estoque_atual'].apply(\n            lambda x: \"Estoque Negativo Cr\u00edtico\" if x < 0 else \"Estoque Baixo\"\n        )\n        df_criticos['percentual_cobertura'] = df_criticos.apply(\n            lambda row: (row['estoque_atual'] / row['linha_verde'] * 100) if row['linha_verde'] > 0 else 0,\n            axis=1\n        )\n        \n        # Criar uma coluna tempor\u00e1ria para ordena\u00e7\u00e3o que prioriza os negativos\n        df_criticos['is_negativo'] = df_criticos['estoque_atual'].apply(lambda x: 1 if x < 0 else 0)\n\n        # Ordenar por status de alerta (negativos primeiro) e depois por percentual de cobertura\n        df_criticos = df_criticos.sort_values(\n            by=['is_negativo', 'percentual_cobertura'], \n            ascending=[False, True]\n        )\n\n        # Limitar ao n\u00famero solicitado, se um limite for fornecido\n        top_criticos = df_criticos\n        if limite is not None:\n            top_criticos = df_criticos.head(limite)\n\n        # Preparar lista de produtos\n        produtos = []\n        for _, row in top_criticos.iterrows():\n            # Determinar o motivo da ruptura\n            motivo_ruptura = \"Risco de Reposi\u00e7\u00e3o (Estoque CD Zerado)\"\n            if row['linha_verde'] < row['venda_30_d']:\n                motivo_ruptura = \"Planejamento Incorreto (Linha Verde < Vendas)\"\n\n            produto = {\n                \"codigo\": int(row['codigo']) if pd.notna(row['codigo']) else None,\n                \"nome_produto\": str(row['nome_produto']) if pd.notna(row['nome_produto']) else \"N/A\",\n                \"segmento\": str(row['nomesegmento']) if 'nomesegmento' in row and pd.notna(row['nomesegmento']) else \"N/A\",\n                \"une_afetada_id\": int(row['une']) if pd.notna(row['une']) else None,\n                \"une_afetada_nome\": str(row['une_nome']) if 'une_nome' in row and pd.notna(row['une_nome']) else \"N/A\",\n                \"alerta_de_estoque\": row['alerta_de_estoque'],\n                \"estoque_na_une\": float(row['estoque_atual']),\n                \"linha_verde_na_une\": float(row['linha_verde']),\n                \"percentual_cobertura\": round(row['percentual_cobertura'], 2),\n                \"venda_30_dias\": float(row['venda_30_d']),\n                \"necessidade_na_une\": float(row['linha_verde'] - row['estoque_atual']),\n                \"estoque_no_cd\": float(row['estoque_cd']),\n                \"motivo_ruptura\": motivo_ruptura\n            }\n            produtos.append(produto)\n\n        logger.info(f\"Encontradas {total_criticos} situa\u00e7\u00f5es de ruptura cr\u00edtica.\")\n\n        return {\n            \"total_criticos\": total_criticos,\n            \"produtos_criticos\": produtos,\n            \"criterio\": \"estoque_cd <= 0 E estoque_atual < linha_verde\",\n            \"limite_exibido\": len(produtos)\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro em encontrar_rupturas_criticas: {e}\", exc_info=True)\n        return {\"error\": f\"Erro ao processar rupturas cr\u00edticas: {str(e)}\"}", "mimetype": "text/plain", "start_char_idx": 53911, "end_char_idx": 57498, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7610e168-59f1-40e8-9dc0-a9df04ff6b02": {"__data__": {"id_": "7610e168-59f1-40e8-9dc0-a9df04ff6b02", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "a617a3fd-f0b2-42c8-a192-ed00c56ecde2", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "8a53d08eb091d496827d0a5caef5b82f5bb16665389942edac03e91226f523ee", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "88ff1c6e-35f2-4a26-8498-a3c3988707bf", "node_type": "1", "metadata": {}, "hash": "a6d8e32ea188188a65c1b910515d6b59479524e6c62ac0408dd36b8e10a47786", "class_name": "RelatedNodeInfo"}}, "text": "return {\n            \"total_criticos\": total_criticos,\n            \"produtos_criticos\": produtos,\n            \"criterio\": \"estoque_cd <= 0 E estoque_atual < linha_verde\",\n            \"limite_exibido\": len(produtos)\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro em encontrar_rupturas_criticas: {e}\", exc_info=True)\n        return {\"error\": f\"Erro ao processar rupturas cr\u00edticas: {str(e)}\"}\n\n\n@tool\n@error_handler_decorator(\n    context_func=lambda une_id=None, produto_id=None, segmento=None, termo_busca=None: {\n        \"une_id\": une_id, \"produto_id\": produto_id, \"segmento\": segmento, \"termo_busca\": termo_busca, \"funcao\": \"consultar_dados_gerais\"\n    },\n    return_on_error={\"error\": \"Erro ao consultar dados gerais\", \"total_resultados\": 0, \"resultados\": []}\n)\ndef consultar_dados_gerais(\n    une_id: Optional[int] = None,\n    produto_id: Optional[int] = None,\n    segmento: Optional[str] = None,\n    termo_busca: Optional[str] = None,\n    limite: int = 20\n) -> Dict[str, Any]:\n    \"\"\"\n    Consulta dados gerais de produtos, estoque e vendas com filtros flex\u00edveis.\n    Use esta ferramenta para responder perguntas gerais como:\n    - \"Qual o estoque do produto X na UNE Y?\"\n    - \"Quais produtos do segmento Z temos na UNE Y?\"\n    - \"Dados do produto 12345\"\n\n    Args:\n        une_id: ID da UNE (opcional)\n        produto_id: C\u00f3digo do produto (opcional)\n        segmento: Nome do segmento (opcional, ex: \"TECIDOS\")\n        termo_busca: Parte do nome do produto para busca (opcional)\n        limite: M\u00e1ximo de resultados (default: 20)\n\n    Returns:\n        dict com 'total_resultados' e lista de 'resultados'.\n    \"\"\"\n    logger.info(f\"Consultando dados gerais: une={une_id}, prod={produto_id}, seg={segmento}, busca={termo_busca}\")\n\n    filters = {}\n    if une_id:\n        filters['une'] = une_id\n    if produto_id:\n        filters['codigo'] = produto_id\n    \n    # Se tiver filtro de segmento, precisamos carregar e filtrar depois ou usar _load_data se suportar\n    # _load_data suporta filtro exato. Para contains (termo_busca), faremos via pandas.\n\n    try:\n        # Colunas relevantes para consulta geral\n        cols = [\n            'codigo', 'nome_produto', 'une', 'une_nome', 'estoque_atual', 'linha_verde', \n            'venda_30_d', 'mc', 'nomesegmento', 'estoque_cd', 'NOMEFABRICANTE'\n        ]\n        \n        # Otimiza\u00e7\u00e3o: se tiver ID ou UNE, filtrar na carga\n        df = _load_data(filters=filters if filters else None, columns=cols)\n        \n        if df.empty:\n            return {\"total_resultados\": 0, \"resultados\": [], \"mensagem\": \"Nenhum dado encontrado com os filtros iniciais.\"}\n\n        # Normalizar\n        df = _normalize_dataframe(df)\n        \n        # Filtros adicionais (pandas)\n        if segmento and 'nomesegmento' in df.columns:\n            df = df[df['nomesegmento'].str.contains(segmento, case=False, na=False)]\n        \n        if termo_busca and 'nome_produto' in df.columns:\n            df = df[df['nome_produto'].str.contains(termo_busca, case=False, na=False)]\n\n        total = len(df)\n        if total == 0:\n             return {\"total_resultados\": 0, \"resultados\": [], \"mensagem\": \"Nenhum dado encontrado ap\u00f3s filtros de texto.\"}", "mimetype": "text/plain", "start_char_idx": 57090, "end_char_idx": 60286, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "88ff1c6e-35f2-4a26-8498-a3c3988707bf": {"__data__": {"id_": "88ff1c6e-35f2-4a26-8498-a3c3988707bf", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "7610e168-59f1-40e8-9dc0-a9df04ff6b02", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "e3b969555f9fd3232400696df78b80cee66ad033cd69971ba0de2d3686075ff2", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "dfd05c9a-a89e-447e-a544-f282e7a70f67", "node_type": "1", "metadata": {}, "hash": "5eb24f61bc87433ab3bd58d36a57af1125a6e76d02863c24ea3ae381fcc16196", "class_name": "RelatedNodeInfo"}}, "text": "# Normalizar\n        df = _normalize_dataframe(df)\n        \n        # Filtros adicionais (pandas)\n        if segmento and 'nomesegmento' in df.columns:\n            df = df[df['nomesegmento'].str.contains(segmento, case=False, na=False)]\n        \n        if termo_busca and 'nome_produto' in df.columns:\n            df = df[df['nome_produto'].str.contains(termo_busca, case=False, na=False)]\n\n        total = len(df)\n        if total == 0:\n             return {\"total_resultados\": 0, \"resultados\": [], \"mensagem\": \"Nenhum dado encontrado ap\u00f3s filtros de texto.\"}\n\n        # Limitar e formatar\n        df_res = df.head(limite)\n        resultados = []\n        for _, row in df_res.iterrows():\n            item = {\n                \"codigo\": int(row['codigo']) if pd.notna(row.get('codigo')) else None,\n                \"nome\": str(row['nome_produto']) if pd.notna(row.get('nome_produto')) else \"N/A\",\n                \"une\": int(row['une']) if pd.notna(row.get('une')) else None,\n                \"estoque\": float(row['estoque_atual']) if pd.notna(row.get('estoque_atual')) else 0.0,\n                \"venda_30d\": float(row['venda_30_d']) if pd.notna(row.get('venda_30_d')) else 0.0,\n                \"linha_verde\": float(row['linha_verde']) if pd.notna(row.get('linha_verde')) else 0.0,\n                \"segmento\": str(row['nomesegmento']) if pd.notna(row.get('nomesegmento')) else \"N/A\"\n            }\n            # Adicionar campos extras se dispon\u00edveis\n            if 'estoque_cd' in row and pd.notna(row['estoque_cd']):\n                item['estoque_cd'] = float(row['estoque_cd'])\n            \n            resultados.append(item)\n\n        return {\n            \"total_resultados\": total,\n            \"resultados\": resultados,\n            \"limite_aplicado\": limite\n        }\n\n    except Exception as e:\n        logger.error(f\"Erro em consultar_dados_gerais: {e}\", exc_info=True)\n        return {\"error\": f\"Erro na consulta: {str(e)}\"}\n\n# Lista de ferramentas dispon\u00edveis para exporta\u00e7\u00e3o\n__all__ = [\n    'calcular_abastecimento_une',\n    'calcular_mc_produto',\n    'calcular_preco_final_une',\n    'validar_transferencia_produto',\n    'sugerir_transferencias_automaticas',\n    'calcular_produtos_sem_vendas',\n    'encontrar_rupturas_criticas',\n    'consultar_dados_gerais'\n]\n\n\n# -----------------------------------------------------------------------------\n# Compatibility wrapper functions (shims) expected by older tests/scripts\n# These provide a stable, high-level API (get_*) that returns the\n# standardized dict: {\"success\": bool, \"data\": ..., \"message\": str}\n# They call the existing implementations where possible or provide\n# safe fallbacks so test-collection/imports do not fail.\n# -----------------------------------------------------------------------------\n\n\ndef _standard_response(data=None, message: str = \"\", success: bool = True):\n    return {\"success\": success, \"data\": data if data is not None else [], \"message\": message}\n\n\ndef get_produtos_une(une_id: int):\n    \"\"\"Compat wrapper: retorna produtos para uma UNE.\n\n    Usa `_load_data` e devolve lista de registros normalizados.\n    \"\"\"\n    try:\n        if not isinstance(une_id, int) or une_id <= 0:\n            return _standard_response([], \"une_id inv\u00e1lido\", False)\n\n        df = _load_data(filters={\"une\": une_id})\n        records = df.to_dict(orient=\"records\") if not df.empty else []\n\n        return _standard_response(records, \"OK\", True)\n    except Exception as e:\n        logger.error(f\"Erro em get_produtos_une: {e}\", exc_info=True)\n        return _standard_response([], f\"Erro: {e}\", False)", "mimetype": "text/plain", "start_char_idx": 59725, "end_char_idx": 63286, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "dfd05c9a-a89e-447e-a544-f282e7a70f67": {"__data__": {"id_": "dfd05c9a-a89e-447e-a544-f282e7a70f67", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "88ff1c6e-35f2-4a26-8498-a3c3988707bf", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "f13e2137e9c9f74ebd9d3e2c3608d99589bc8aeab425c31533d85b002e120831", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "966b4781-46ee-4852-9c93-2eaf2d232617", "node_type": "1", "metadata": {}, "hash": "9f8d683917383192826126ec9b49f5fca29b7149c8e0c7513788ca0addb08e58", "class_name": "RelatedNodeInfo"}}, "text": "def get_produtos_une(une_id: int):\n    \"\"\"Compat wrapper: retorna produtos para uma UNE.\n\n    Usa `_load_data` e devolve lista de registros normalizados.\n    \"\"\"\n    try:\n        if not isinstance(une_id, int) or une_id <= 0:\n            return _standard_response([], \"une_id inv\u00e1lido\", False)\n\n        df = _load_data(filters={\"une\": une_id})\n        records = df.to_dict(orient=\"records\") if not df.empty else []\n\n        return _standard_response(records, \"OK\", True)\n    except Exception as e:\n        logger.error(f\"Erro em get_produtos_une: {e}\", exc_info=True)\n        return _standard_response([], f\"Erro: {e}\", False)\n\n\ndef get_transferencias(une: int = None, data_inicio: str = None, data_fim: str = None, status: str = None):\n    \"\"\"Compat wrapper: retorna transferencias (usa sugerir_transferencias_automaticas como fallback).\"\"\"\n    try:\n        limite = 50\n        result = sugerir_transferencias_automaticas(limite=limite, une_origem_filtro=une)\n        sugestoes = result.get(\"sugestoes\") if isinstance(result, dict) else []\n        return _standard_response(sugestoes, \"OK\", True)\n    except Exception as e:\n        logger.error(f\"Erro em get_transferencias: {e}\", exc_info=True)\n        return _standard_response([], f\"Erro: {e}\", False)\n\n\ndef get_estoque_une(une_id: int):\n    try:\n        df = _load_data(filters={\"une\": une_id})\n        if df.empty:\n            return _standard_response([], \"Nenhum dado\", True)\n\n        total_estoque = int(df['estoque_atual'].fillna(0).sum()) if 'estoque_atual' in df.columns else 0\n        return _standard_response({\"une\": une_id, \"total_estoque\": total_estoque}, \"OK\", True)\n    except Exception as e:\n        logger.error(f\"Erro em get_estoque_une: {e}\", exc_info=True)\n        return _standard_response([], f\"Erro: {e}\", False)\n\n\ndef get_vendas_une(une_id: int):\n    try:\n        df = _load_data(filters={\"une\": une_id})\n        total_vendas = float(df['venda_30_d'].fillna(0).sum()) if 'venda_30_d' in df.columns else 0.0\n        return _standard_response({\"une\": une_id, \"total_vendas_30d\": total_vendas}, \"OK\", True)\n    except Exception as e:\n        logger.error(f\"Erro em get_vendas_une: {e}\", exc_info=True)\n        return _standard_response([], f\"Erro: {e}\", False)\n\n\ndef get_unes_disponiveis():\n    try:\n        df = _load_data()\n        if 'une' in df.columns:\n            unes = sorted(list(df['une'].dropna().unique()))\n        else:\n            unes = []\n        return _standard_response(unes, \"OK\", True)\n    except Exception as e:\n        logger.error(f\"Erro em get_unes_disponiveis: {e}\", exc_info=True)\n        return _standard_response([], f\"Erro: {e}\", False)\n\n\ndef get_preco_produto(une_id: int, produto_codigo: str):\n    try:\n        df = _load_data(filters={\"une\": une_id, \"codigo\": produto_codigo})\n        if df.empty:\n            return _standard_response({}, \"Produto n\u00e3o encontrado\", False)\n        row = df.iloc[0].to_dict()\n        preco = row.get('preco_venda') or row.get('preco') or 0.0\n        return _standard_response({\"produto\": produto_codigo, \"preco_venda\": float(preco)}, \"OK\", True)\n    except Exception as e:\n        logger.error(f\"Erro em get_preco_produto: {e}\", exc_info=True)\n        return _standard_response({}, f\"Erro: {e}\", False)\n\n\ndef get_total_vendas_une(une_id: int):\n    try:\n        df = _load_data(filters={\"une\": une_id})\n        total = float(df['venda_30_d'].fillna(0).sum()) if 'venda_30_d' in df.columns else 0.0\n        return _standard_response(total, \"OK\", True)\n    except Exception as e:\n        logger.error(f\"Erro em get_total_vendas_une: {e}\", exc_info=True)\n        return _standard_response(0, f\"Erro: {e}\", False)", "mimetype": "text/plain", "start_char_idx": 62660, "end_char_idx": 66308, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "966b4781-46ee-4852-9c93-2eaf2d232617": {"__data__": {"id_": "966b4781-46ee-4852-9c93-2eaf2d232617", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "989a4d13-fc47-49e7-af38-f28af1dc9abb", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "407eda13160703e05563b1050b297574b258764aad2f90e667fe2d41cf9d3485", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "dfd05c9a-a89e-447e-a544-f282e7a70f67", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}, "hash": "7a0d327e0fe28aaaf0fdeae3146361ab07a57e24ece9774f6c350ef9d0e973e3", "class_name": "RelatedNodeInfo"}}, "text": "def get_total_vendas_une(une_id: int):\n    try:\n        df = _load_data(filters={\"une\": une_id})\n        total = float(df['venda_30_d'].fillna(0).sum()) if 'venda_30_d' in df.columns else 0.0\n        return _standard_response(total, \"OK\", True)\n    except Exception as e:\n        logger.error(f\"Erro em get_total_vendas_une: {e}\", exc_info=True)\n        return _standard_response(0, f\"Erro: {e}\", False)\n\n\ndef get_total_estoque_une(une_id: int):\n    try:\n        df = _load_data(filters={\"une\": une_id})\n        total = int(df['estoque_atual'].fillna(0).sum()) if 'estoque_atual' in df.columns else 0\n        return _standard_response(total, \"OK\", True)\n    except Exception as e:\n        logger.error(f\"Erro em get_total_estoque_une: {e}\", exc_info=True)\n        return _standard_response(0, f\"Erro: {e}\", False)\n\n\ndef health_check():\n    try:\n        base = os.path.join(os.getcwd(), 'data', 'parquet')\n        files = os.listdir(base) if os.path.exists(base) else []\n        expected = ['produtos.parquet', 'transferencias.parquet']\n        missing = [f for f in expected if f not in files]\n        status = {\"present_files\": files, \"missing_expected\": missing}\n        success = len(missing) == 0\n        return _standard_response(status, \"OK\" if success else \"Arquivos faltando\", success)\n    except Exception as e:\n        logger.error(f\"Erro em health_check: {e}\", exc_info=True)\n        return _standard_response({}, f\"Erro: {e}\", False)", "mimetype": "text/plain", "start_char_idx": 65905, "end_char_idx": 67350, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b1695045-39da-4a75-85b2-b835db9a2906": {"__data__": {"id_": "b1695045-39da-4a75-85b2-b835db9a2906", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a4138d34-acce-45e7-afa5-70ee1e20901a", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "e462d3fd70d8c404f93b3a5c237b60c12e27c3baa33446d6f372f752e49d6aaa", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "29482fbb-00b7-4ee5-9ece-882b657de04d", "node_type": "1", "metadata": {}, "hash": "0318f7474de2b2df0fd36d2051054883cbd0967a8e03b49b5be0042c70569849", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/tools/une_tools.py\n\nfrom typing import Dict, Any, List, Optional\nfrom functools import lru_cache\n\n# Assuming HybridAdapter exists in infrastructure/data as per TASK_LIST\n# We will create a placeholder for it later if it doesn't exist\n# from ....infrastructure.data.hybrid_adapter import HybridAdapter\n# Placeholder for now\nclass HybridAdapter:\n    def __init__(self, parquet_dir: str = \"data/parquet\", sql_server_conn_str: Optional[str] = None):\n        print(f\"HybridAdapter initialized with parquet_dir={parquet_dir} and sql_server_conn_str={'<hidden>' if sql_server_conn_str else 'None'}\")\n        # Placeholder for actual data loading/connection\n        self.data = {} # Simulating loaded data\n        self.schema = {\n            \"une_id\": \"int\", \"produto_id\": \"int\", \"segmento\": \"str\",\n            \"media_considerada_lv\": \"float\", \"estoque_origem\": \"int\",\n            \"estoque_destino\": \"int\", \"linha_verde\": \"int\",\n            \"vendas_diarias\": \"float\", \"transferencias_pendentes\": \"int\",\n            \"criticidade\": \"str\" # URGENTE/ALTA/NORMAL\n        }\n\n    def fetch_data(self, filters: Dict[str, Any], columns: Optional[List[str]] = None) -> List[Dict]:\n        print(f\"Fetching data with filters: {filters}, columns: {columns}\")\n        # Simulate data fetching\n        # In a real scenario, this would query Parquet or SQL Server\n        # For now, return some dummy data that matches schema\n        dummy_data = [\n            {\"une_id\": 1, \"produto_id\": 101, \"segmento\": \"A\", \"media_considerada_lv\": 10.0, \"estoque_origem\": 50, \"estoque_destino\": 20, \"linha_verde\": 30, \"vendas_diarias\": 5.0, \"transferencias_pendentes\": 0, \"criticidade\": \"NORMAL\"},\n            {\"une_id\": 1, \"produto_id\": 102, \"segmento\": \"A\", \"media_considerada_lv\": 20.0, \"estoque_origem\": 10, \"estoque_destino\": 5, \"linha_verde\": 40, \"vendas_diarias\": 10.0, \"transferencias_pendentes\": 0, \"criticidade\": \"URGENTE\"},\n            {\"une_id\": 2, \"produto_id\": 101, \"segmento\": \"B\", \"media_considerada_lv\": 15.0, \"estoque_origem\": 100, \"estoque_destino\": 80, \"linha_verde\": 20, \"vendas_diarias\": 7.0, \"transferencias_pendentes\": 0, \"criticidade\": \"NORMAL\"},\n            {\"une_id\": 3, \"produto_id\": 103, \"segmento\": \"C\", \"media_considerada_lv\": 5.0, \"estoque_origem\": 5, \"estoque_destino\": 2, \"linha_verde\": 10, \"vendas_diarias\": 1.0, \"transferencias_pendentes\": 0, \"criticidade\": \"ALTA\"},\n        ]\n        \n        # Apply simple filtering for demonstration\n        filtered_data = []\n        for item in dummy_data:\n            match = True\n            for key, value in filters.items():\n                if key in item and item[key] != value:\n                    match = False\n                    break\n            if match:\n                filtered_data.append(item)\n        \n        if columns:\n            return [{col: item[col] for col in columns if col in item} for item in filtered_data]\n        return filtered_data\n    \n    def get_known_columns(self) -> Dict[str, str]:\n        return self.schema\n\n# Placeholder for @tool decorator\ndef tool(func):\n    def wrapper(*args, **kwargs):\n        print(f\"Tool '{func.__name__}' called with args: {args}, kwargs: {kwargs}\")\n        return func(*args, **kwargs)\n    return wrapper\n\n# --- Helper Functions (T3.2.2, T3.2.3, T3.2.4) ---\n\n@lru_cache(maxsize=1)\ndef _get_data_adapter() -> HybridAdapter:\n    \"\"\"\n    Returns a cached instance of HybridAdapter.\n    In a real scenario, configuration for parquet_dir and sql_server_conn_str\n    would come from settings.\n    \"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3520, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "29482fbb-00b7-4ee5-9ece-882b657de04d": {"__data__": {"id_": "29482fbb-00b7-4ee5-9ece-882b657de04d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a4138d34-acce-45e7-afa5-70ee1e20901a", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "e462d3fd70d8c404f93b3a5c237b60c12e27c3baa33446d6f372f752e49d6aaa", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b1695045-39da-4a75-85b2-b835db9a2906", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "59c3a9978f8feddfef2e8ac6537c7cd65f8ed1daa51f881cb8758e0a1b6dab47", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3a6c2027-d621-417a-8be8-8f2cff9f6992", "node_type": "1", "metadata": {}, "hash": "956347fd414008f6946963c3688a94dcbbc9843ab0bd04f5f979cc2581b9d202", "class_name": "RelatedNodeInfo"}}, "text": "In a real scenario, configuration for parquet_dir and sql_server_conn_str\n    would come from settings.\n    \"\"\"\n    # Placeholder: assuming data/parquet is standard, and SQL Server conn_str might be None for now\n    # We will expand this once settings.py is updated.\n    return HybridAdapter(parquet_dir=\"data/parquet\")\n\ndef _normalize_dataframe(df_data: List[Dict]) -> List[Dict]:\n    \"\"\"\n    Normalizes column names from SQL to Parquet conventions if necessary,\n    and ensures consistent data types.\n    Placeholder for actual normalization logic.\n    \"\"\"\n    # Example: if SQL had 'UNE_ID', convert to 'une_id'\n    normalized_data = []\n    for row in df_data:\n        new_row = {k.lower(): v for k, v in row.items()} # Simple lowercase normalization\n        normalized_data.append(new_row)\n    return normalized_data\n\ndef _load_data(filters: Dict[str, Any], columns: Optional[List[str]] = None) -> List[Dict]:\n    \"\"\"\n    Loads data using the HybridAdapter with given filters and columns.\n    Includes basic schema validation and error handling (placeholder).\n    \"\"\"\n    adapter = _get_data_adapter()\n    raw_data = adapter.fetch_data(filters, columns)\n    \n    # Placeholder for schema validation and recovery\n    valid_data = []\n    expected_schema = adapter.get_known_columns()\n    for row in raw_data:\n        # Simple validation: ensure all expected columns (if specified) are present\n        # and basic type checks\n        is_valid = True\n        if columns:\n            for col in columns:\n                if col not in row:\n                    print(f\"Warning: Column '{col}' missing in row: {row}\")\n                    is_valid = False\n                    break\n        if is_valid:\n            valid_data.append(row)\n            \n    return _normalize_dataframe(valid_data)\n\n# --- UNE Business Rules (T3.2.5) ---\n\n@tool\ndef calcular_abastecimento_une(une_id: int, segmento: Optional[str] = None, limite: int = 10) -> List[Dict]:\n    \"\"\"\n    Calcula a necessidade de abastecimento para uma UNE espec\u00edfica, opcionalmente por segmento.\n    Retorna os produtos com maior criticidade de abastecimento.\n    \"\"\"\n    print(f\"Calculating supply for UNE: {une_id}, Segmento: {segmento}, Limite: {limite}\")\n    \n    # Placeholder for fetching relevant data\n    filters = {\"une_id\": une_id}\n    if segmento:\n        filters[\"segmento\"] = segmento\n        \n    data = _load_data(filters)\n    \n    results = []\n    for row in data:\n        # Implementar c\u00e1lculo de criticidade de abastecimento (placeholder)\n        # Exemplo: (linha_verde - estoque_origem) / vendas_diarias\n        estoque = row.get(\"estoque_origem\", 0)\n        linha_verde = row.get(\"linha_verde\", 0)\n        vendas_diarias = row.get(\"vendas_diarias\", 1) # Avoid division by zero\n        \n        necessidade = linha_verde - estoque\n        dias_para_ruptura = necessidade / vendas_diarias if vendas_diarias > 0 else float('inf')\n\n        criticidade_abastecimento = \"NORMAL\"\n        if dias_para_ruptura < 5 and necessidade > 0: # Example rule\n            criticidade_abastecimento = \"URGENTE\"\n        elif dias_para_ruptura < 10 and necessidade > 0:\n            criticidade_abastecimento = \"ALTA\"\n\n        row[\"necessidade_abastecimento\"] = necessidade\n        row[\"dias_para_ruptura\"] = round(dias_para_ruptura, 2)\n        row[\"criticidade_abastecimento\"] = criticidade_abastecimento\n        results.append(row)\n\n    # Sort by criticidade_abastecimento (URGENTE > ALTA > NORMAL) and then necessidade\n    priority_order = {\"URGENTE\": 3, \"ALTA\": 2, \"NORMAL\": 1}\n    results.sort(key=lambda x: (priority_order.get(x.get(\"criticidade_abastecimento\"), 0), x.get(\"necessidade_abastecimento\", 0)), reverse=True)\n    \n    return results[:limite]\n\n\n@tool\ndef calcular_mc_produto(produto_id: int, une_id: int) -> Dict[str, Any]:\n    \"\"\"\n    Calcula a Margem de Contribui\u00e7\u00e3o (MC) para um produto espec\u00edfico em uma UNE.", "mimetype": "text/plain", "start_char_idx": 3409, "end_char_idx": 7290, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3a6c2027-d621-417a-8be8-8f2cff9f6992": {"__data__": {"id_": "3a6c2027-d621-417a-8be8-8f2cff9f6992", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a4138d34-acce-45e7-afa5-70ee1e20901a", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "e462d3fd70d8c404f93b3a5c237b60c12e27c3baa33446d6f372f752e49d6aaa", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "29482fbb-00b7-4ee5-9ece-882b657de04d", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "8833f2898adfa76f23311f03a61b890fd82f97efc3d505e970404c5cd042306b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "1bfb7cc3-a107-4076-9524-2ff8631ca224", "node_type": "1", "metadata": {}, "hash": "b657b6c4b0f8d3f4008c3fb6f14d1d280abbbd8e0d01f9e0e378c2b47805e860", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef calcular_mc_produto(produto_id: int, une_id: int) -> Dict[str, Any]:\n    \"\"\"\n    Calcula a Margem de Contribui\u00e7\u00e3o (MC) para um produto espec\u00edfico em uma UNE.\n    A MC \u00e9 baseada na 'media_considerada_lv' ou na m\u00e9dia de vendas, conforme regras de neg\u00f3cio.\n    \"\"\"\n    print(f\"Calculating MC for Produto: {produto_id}, UNE: {une_id}\")\n    \n    data = _load_data({\"produto_id\": produto_id, \"une_id\": une_id}, columns=[\"media_considerada_lv\", \"vendas_diarias\"])\n    \n    if not data:\n        return {\"produto_id\": produto_id, \"une_id\": une_id, \"mc_calculada\": None, \"mensagem\": \"Dados n\u00e3o encontrados para o produto/UNE.\"}\n        \n    product_data = data[0]\n    media_considerada_lv = product_data.get(\"media_considerada_lv\")\n    vendas_diarias = product_data.get(\"vendas_diarias\")\n\n    mc_calculada = None\n    mensagem = \"C\u00e1lculo de MC n\u00e3o aplic\u00e1vel com os dados fornecidos.\"\n    \n    # Placeholder for actual MC calculation logic (T3.2.5)\n    # Exemplo: se media_considerada_lv existe, usa ela. Sen\u00e3o, usa vendas_diarias como base.\n    if media_considerada_lv is not None:\n        mc_calculada = media_considerada_lv * 0.25 # Exemplo: 25% de MC sobre a LV\n        mensagem = \"MC calculada com base na m\u00e9dia considerada LV.\"\n    elif vendas_diarias is not None:\n        mc_calculada = vendas_diarias * 0.20 # Exemplo: 20% de MC sobre vendas di\u00e1rias\n        mensagem = \"MC calculada com base na m\u00e9dia de vendas di\u00e1rias.\"\n\n    return {\n        \"produto_id\": produto_id,\n        \"une_id\": une_id,\n        \"mc_calculada\": round(mc_calculada, 2) if mc_calculada is not None else None,\n        \"mensagem\": mensagem\n    }\n\n@tool\ndef calcular_preco_final_une(produto_id: int, une_id: int) -> Dict[str, Any]:\n    \"\"\"\n    Calcula o pre\u00e7o final de venda para um produto em uma UNE espec\u00edfica,\n    considerando pol\u00edticas de precifica\u00e7\u00e3o (placeholder).\n    \"\"\"\n    print(f\"Calculating final price for Produto: {produto_id}, UNE: {une_id}\")\n    \n    data = _load_data({\"produto_id\": produto_id, \"une_id\": une_id}, columns=[\"media_considerada_lv\"])\n    \n    if not data:\n        return {\"produto_id\": produto_id, \"une_id\": une_id, \"preco_final\": None, \"mensagem\": \"Dados n\u00e3o encontrados para o produto/UNE.\"}\n        \n    product_data = data[0]\n    base_price = product_data.get(\"media_considerada_lv\") # Using LV as a base price placeholder\n    \n    preco_final = None\n    mensagem = \"N\u00e3o foi poss\u00edvel calcular o pre\u00e7o final.\"\n\n    if base_price is not None:\n        # Placeholder for complex pricing policies (T3.2.5)\n        # Exemplo: Adicionar 10% de margem e 5% de imposto\n        preco_final = base_price * 1.10 * 1.05\n        mensagem = \"Pre\u00e7o final calculado com base no pre\u00e7o base e pol\u00edticas internas.\"\n\n    return {\n        \"produto_id\": produto_id,\n        \"une_id\": une_id,\n        \"preco_final\": round(preco_final, 2) if preco_final is not None else None,\n        \"mensagem\": mensagem\n    }\n\n@tool\ndef validar_transferencia_produto(produto_id: int, une_origem: int, une_destino: int, quantidade: int) -> Dict[str, Any]:\n    \"\"\"\n    Valida se uma transfer\u00eancia de produto entre UNEs \u00e9 poss\u00edvel,\n    considerando estoque na origem, linha verde do destino, etc.\n    \"\"\"", "mimetype": "text/plain", "start_char_idx": 7123, "end_char_idx": 10296, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1bfb7cc3-a107-4076-9524-2ff8631ca224": {"__data__": {"id_": "1bfb7cc3-a107-4076-9524-2ff8631ca224", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a4138d34-acce-45e7-afa5-70ee1e20901a", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "e462d3fd70d8c404f93b3a5c237b60c12e27c3baa33446d6f372f752e49d6aaa", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3a6c2027-d621-417a-8be8-8f2cff9f6992", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "4430a96c3dfc3d9387bff76c335693bc11a61606e29adb314afb6857488a4e2e", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "891fa1d1-d13f-4c4a-96e4-9d26c0224e77", "node_type": "1", "metadata": {}, "hash": "3ee2819cabaa085e88df19f67df14f299272ebb7e008e1abff7040dd72075fe3", "class_name": "RelatedNodeInfo"}}, "text": "return {\n        \"produto_id\": produto_id,\n        \"une_id\": une_id,\n        \"preco_final\": round(preco_final, 2) if preco_final is not None else None,\n        \"mensagem\": mensagem\n    }\n\n@tool\ndef validar_transferencia_produto(produto_id: int, une_origem: int, une_destino: int, quantidade: int) -> Dict[str, Any]:\n    \"\"\"\n    Valida se uma transfer\u00eancia de produto entre UNEs \u00e9 poss\u00edvel,\n    considerando estoque na origem, linha verde do destino, etc.\n    \"\"\"\n    print(f\"Validating transfer: Produto {produto_id} from UNE {une_origem} to UNE {une_destino}, Quantidade {quantidade}\")\n    \n    # Fetch data for origin and destination UNEs\n    origin_data = _load_data({\"produto_id\": produto_id, \"une_id\": une_origem}, columns=[\"estoque_origem\"])\n    dest_data = _load_data({\"produto_id\": produto_id, \"une_id\": une_destino}, columns=[\"linha_verde\", \"estoque_origem\", \"transferencias_pendentes\"])\n    \n    if not origin_data:\n        return {\"status\": \"falha\", \"mensagem\": f\"Dados da UNE de origem {une_origem} n\u00e3o encontrados para o produto {produto_id}.\"}\n    if not dest_data:\n        return {\"status\": \"falha\", \"mensagem\": f\"Dados da UNE de destino {une_destino} n\u00e3o encontrados para o produto {produto_id}.\"}\n        \n    estoque_origem = origin_data[0].get(\"estoque_origem\", 0)\n    linha_verde_destino = dest_data[0].get(\"linha_verde\", 0)\n    estoque_destino_atual = dest_data[0].get(\"estoque_origem\", 0) # Using estoque_origem for current stock at destination\n    transferencias_pendentes = dest_data[0].get(\"transferencias_pendentes\", 0)\n\n    # Placeholder for validation rules (T3.2.5)\n    if estoque_origem < quantidade:\n        return {\"status\": \"falha\", \"mensagem\": f\"Estoque insuficiente na UNE de origem ({estoque_origem}) para transferir {quantidade} unidades.\"}\n    \n    # Check if destination would exceed Linea Verde after transfer + pending transfers\n    estoque_apos_transferencia = estoque_destino_atual + quantidade + transferencias_pendentes\n    if estoque_apos_transferencia > linha_verde_destino * 1.2: # Example: allow up to 20% over LV\n        return {\"status\": \"alerta\", \"mensagem\": f\"A transfer\u00eancia pode fazer a UNE de destino exceder significativamente a Linha Verde (LV={linha_verde_destino}). Estoque total ap\u00f3s transfer\u00eancia: {estoque_apos_transferencia}.\"}\n        \n    return {\"status\": \"sucesso\", \"mensagem\": \"Transfer\u00eancia validada e poss\u00edvel.\"}\n\n@tool\ndef sugerir_transferencias_automaticas(segmento: Optional[str] = None, une_origem_excluir: Optional[int] = None, limite: int = 5) -> List[Dict[str, Any]]:\n    \"\"\"\n    Sugere transfer\u00eancias autom\u00e1ticas baseadas em produtos com alta criticidade de ruptura\n    e disponibilidade em outras UNEs.\n    \"\"\"", "mimetype": "text/plain", "start_char_idx": 9834, "end_char_idx": 12524, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "891fa1d1-d13f-4c4a-96e4-9d26c0224e77": {"__data__": {"id_": "891fa1d1-d13f-4c4a-96e4-9d26c0224e77", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a4138d34-acce-45e7-afa5-70ee1e20901a", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "e462d3fd70d8c404f93b3a5c237b60c12e27c3baa33446d6f372f752e49d6aaa", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "1bfb7cc3-a107-4076-9524-2ff8631ca224", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "3563f99f64f327b8d965ba2c1da5d07a6ace8deb1ef1a5a50df1cbf89d12b20b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "ed781b74-f00e-4a36-a9fb-130e1bb1e340", "node_type": "1", "metadata": {}, "hash": "e698cef6921f179c9577794b12a13bf5c8d9b3455c2a1d806b42b44042627319", "class_name": "RelatedNodeInfo"}}, "text": "Estoque total ap\u00f3s transfer\u00eancia: {estoque_apos_transferencia}.\"}\n        \n    return {\"status\": \"sucesso\", \"mensagem\": \"Transfer\u00eancia validada e poss\u00edvel.\"}\n\n@tool\ndef sugerir_transferencias_automaticas(segmento: Optional[str] = None, une_origem_excluir: Optional[int] = None, limite: int = 5) -> List[Dict[str, Any]]:\n    \"\"\"\n    Sugere transfer\u00eancias autom\u00e1ticas baseadas em produtos com alta criticidade de ruptura\n    e disponibilidade em outras UNEs.\n    \"\"\"\n    print(f\"Suggesting automatic transfers for Segmento: {segmento}, Excluir UNE: {une_origem_excluir}, Limite: {limite}\")\n    \n    # Placeholder for identifying products in rupture (high criticality)\n    rupture_products = encontrar_rupturas_criticas(limite=limite*2) # Get more to filter\n    \n    suggestions = []\n    for prod_rupture in rupture_products:\n        product_id = prod_rupture[\"produto_id\"]\n        une_destino = prod_rupture[\"une_id\"]\n        \n        # Find potential origin UNEs\n        filters = {\"produto_id\": product_id}\n        if segmento:\n            filters[\"segmento\"] = segmento\n        if une_origem_excluir:\n            filters[\"une_id\"] = {\"$ne\": une_origem_excluir} # Placeholder for \"not equal\"\n            \n        all_unes_for_product = _load_data(filters, columns=[\"une_id\", \"estoque_origem\", \"linha_verde\"])\n        \n        for potential_origin in all_unes_for_product:\n            une_origem = potential_origin[\"une_id\"]\n            estoque_origem = potential_origin[\"estoque_origem\"]\n            \n            # Simple logic: if origin has enough stock and it's not the destination\n            if estoque_origem > prod_rupture.get(\"necessidade_abastecimento\", 0) and une_origem != une_destino:\n                # Validate the transfer (using the tool itself for consistency)\n                validation_result = validar_transferencia_produto(product_id, une_origem, une_destino, prod_rupture.get(\"necessidade_abastecimento\", 1))\n                \n                if validation_result[\"status\"] == \"sucesso\":\n                    suggestions.append({\n                        \"produto_id\": product_id,\n                        \"une_origem\": une_origem,\n                        \"une_destino\": une_destino,\n                        \"quantidade_sugerida\": prod_rupture.get(\"necessidade_abastecimento\", 1),\n                        \"mensagem\": validation_result[\"mensagem\"]\n                    })\n                    if len(suggestions) >= limite:\n                        break\n        if len(suggestions) >= limite:\n            break\n            \n    return suggestions[:limite]", "mimetype": "text/plain", "start_char_idx": 12060, "end_char_idx": 14629, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ed781b74-f00e-4a36-a9fb-130e1bb1e340": {"__data__": {"id_": "ed781b74-f00e-4a36-a9fb-130e1bb1e340", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a4138d34-acce-45e7-afa5-70ee1e20901a", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "e462d3fd70d8c404f93b3a5c237b60c12e27c3baa33446d6f372f752e49d6aaa", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "891fa1d1-d13f-4c4a-96e4-9d26c0224e77", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}, "hash": "e24d846a3e358a343a2723a1eb50d2a1762ad5bbfb184e897470e2bd10935f5a", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef encontrar_rupturas_criticas(limite: int = 5) -> List[Dict[str, Any]]:\n    \"\"\"\n    Identifica UNEs/produtos com maior probabilidade de ruptura cr\u00edtica,\n    baseado em estoque atual, linha verde e vendas di\u00e1rias.\n    \"\"\"\n    print(f\"Finding critical ruptures, Limite: {limite}\")\n    \n    data = _load_data({}) # Load all data for rupture analysis\n    \n    ruptures = []\n    for row in data:\n        estoque = row.get(\"estoque_origem\", 0)\n        linha_verde = row.get(\"linha_verde\", 0)\n        vendas_diarias = row.get(\"vendas_diarias\", 1) # Avoid division by zero\n        \n        # Placeholder for critical rupture logic (T3.2.5)\n        # Criticidade: URGENTE (estoque < 0.5 * LV e < 3 dias de venda)\n        # ALTA (estoque < LV e < 7 dias de venda)\n        \n        dias_cobertura = estoque / vendas_diarias if vendas_diarias > 0 else float('inf')\n        \n        criticidade = \"NORMAL\"\n        if estoque < (0.5 * linha_verde) and dias_cobertura < 3 and linha_verde > 0:\n            criticidade = \"URGENTE\"\n        elif estoque < linha_verde and dias_cobertura < 7 and linha_verde > 0:\n            criticidade = \"ALTA\"\n            \n        if criticidade in [\"URGENTE\", \"ALTA\"]:\n            row[\"dias_cobertura\"] = round(dias_cobertura, 2)\n            row[\"criticidade_ruptura\"] = criticidade\n            # Add a 'necessidade_abastecimento' for consistency with other tools\n            row[\"necessidade_abastecimento\"] = max(0, linha_verde - estoque)\n            ruptures.append(row)\n            \n    # Sort by criticidade_ruptura (URGENTE > ALTA) and then by necessidade_abastecimento\n    priority_order = {\"URGENTE\": 3, \"ALTA\": 2, \"NORMAL\": 1}\n    ruptures.sort(key=lambda x: (priority_order.get(x.get(\"criticidade_ruptura\"), 0), x.get(\"necessidade_abastecimento\", 0)), reverse=True)\n            \n    return ruptures[:limite]", "mimetype": "text/plain", "start_char_idx": 14632, "end_char_idx": 16474, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c485acb2-0b63-4fa8-ae9d-e407b2a9e7da": {"__data__": {"id_": "c485acb2-0b63-4fa8-ae9d-e407b2a9e7da", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "661e34ff-e65c-4e69-b3b0-898ffbc65201", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "hash": "4bde4606a466adde7e8c828baa0d8e252e7056fc25d64729444c3114a2515207", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "9c94e055-f57c-4d60-b19c-da2f8dd7851b", "node_type": "1", "metadata": {}, "hash": "7a8e780503e00f4fbe47d677820325390f83afbfcbbfe88d93f06ea7a86f658c", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nFerramentas unificadas para acessar dados de Filial_Madureira.parquet\nEste arquivo foi refatorado para usar o DataSourceManager centralizado.\n\"\"\"\n\nimport logging\nfrom typing import Dict, Any, Optional, Union\nimport pandas as pd\nfrom langchain_core.tools import tool\n\n# Importa o gerenciador de dados centralizado\nfrom app.core.data_source_manager import get_data_manager\n\nlogger = logging.getLogger(__name__)\n\n\ndef _truncate_df_for_llm(df: pd.DataFrame, max_rows: int = 10) -> Dict[str, Any]:\n    \"\"\"Trunca o DataFrame e prepara a resposta para o LLM.\"\"\"\n    if df is None or df.empty:\n        return {\n            \"data\": [],\n            \"message\": \"Nenhum dado para exibir.\",\n            \"total_records\": 0\n        }\n    \n    total_records = len(df)\n    if total_records > max_rows:\n        return {\n            \"data\": df.head(max_rows).to_dict(orient=\"records\"),\n            \"message\": f\"Mostrando as primeiras {max_rows} de {total_records} linhas.\",\n            \"total_records\": total_records\n        }\n    return {\n        \"data\": df.to_dict(orient=\"records\"),\n        \"total_records\": total_records\n    }\n\n\n@tool\ndef listar_colunas_disponiveis() -> Dict[str, Any]:\n    \"\"\"\n    IMPORTANTE: Use esta ferramenta PRIMEIRO quando n\u00e3o souber quais colunas existem!\n    \n    Lista todas as colunas dispon\u00edveis na fonte de dados principal (Filial_Madureira.parquet)\n    com seus tipos de dados e exemplos de valores.\n    \n    Esta \u00e9 a \u00daNICA fonte de dados do sistema. N\u00e3o existe banco SQL ativo.\n    \n    Returns:\n        Dicion\u00e1rio com lista de colunas, tipos e exemplos de valores.\n    \"\"\"\n    logger.info(\"Listando colunas dispon\u00edveis via DataSourceManager\")\n    \n    try:\n        data_manager = get_data_manager()\n        source_info = data_manager.get_source_info()\n\n        if not source_info or source_info.get(\"status\") == \"sem_dados\":\n            return {\n                \"status\": \"error\",\n                \"message\": \"N\u00e3o foi poss\u00edvel carregar os dados atrav\u00e9s do DataSourceManager.\"\n            }\n\n        df = data_manager.get_data(limit=10) # Pega alguns dados para exemplos\n        if df.empty:\n             return {\n                \"status\": \"error\",\n                \"message\": \"Fonte de dados vazia.\"\n            }\n\n        colunas_info = []\n        for col, dtype in source_info.get(\"dtypes\", {}).items():\n            col_info = {\n                \"nome\": col,\n                \"tipo\": str(dtype),\n                \"exemplo\": str(df[col].iloc[0]) if not df.empty and col in df.columns and len(df) > 0 else \"N/A\",\n                \"valores_nulos\": int(df[col].isna().sum()) if col in df.columns else \"N/A\"\n            }\n            colunas_info.append(col_info)\n            \n        return {\n            \"status\": \"success\",\n            \"total_colunas\": source_info.get(\"shape\", (0,0))[1],\n            \"total_registros\": source_info.get(\"shape\", (0,0))[0],\n            \"colunas\": colunas_info,\n            \"arquivo\": source_info.get(\"file\"),\n            \"message\": f\"Encontradas {len(colunas_info)} colunas na fonte de dados.\"\n        }\n        \n    except Exception as e:\n        logger.error(f\"Erro ao listar colunas: {e}\", exc_info=True)\n        return {\n            \"status\": \"error\",\n            \"message\": f\"Erro: {str(e)}\"\n        }\n\n\n@tool\ndef consultar_dados(\n    coluna: Optional[str] = None,\n    valor: Optional[Union[str, int, float]] = None,  # \u2705 ACEITA string, int ou float\n    coluna_retorno: Optional[str] = None,\n    limite: int = 100\n) -> str:\n    \"\"\"\n    Consulta dados na fonte de dados Filial_Madureira.parquet.\n    \n    Use `listar_colunas_disponiveis` para ver as colunas.\n    \n    Args:\n        coluna: Nome da coluna para filtrar (opcional).\n        valor: Valor a buscar na coluna (aceita string, int ou float).\n        coluna_retorno: Coluna espec\u00edfica para retornar (opcional).\n        limite: Limite de registros (padr\u00e3o: 100).\n    \n    Returns:\n        Uma string formatada com os dados consultados ou uma mensagem de erro/n\u00e3o encontrado.\n    \"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3991, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9c94e055-f57c-4d60-b19c-da2f8dd7851b": {"__data__": {"id_": "9c94e055-f57c-4d60-b19c-da2f8dd7851b", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "661e34ff-e65c-4e69-b3b0-898ffbc65201", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "hash": "4bde4606a466adde7e8c828baa0d8e252e7056fc25d64729444c3114a2515207", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c485acb2-0b63-4fa8-ae9d-e407b2a9e7da", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "hash": "39d275a42180da0655bd05e1bc6389a7da02b7396f178f30a513b17d42b260e6", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e905bd8c-c552-4268-9c12-a27839f69421", "node_type": "1", "metadata": {}, "hash": "47536f655d6bf716ba62fd41f7296064539f804e34bb86764089708ed3aaa9eb", "class_name": "RelatedNodeInfo"}}, "text": "Use `listar_colunas_disponiveis` para ver as colunas.\n    \n    Args:\n        coluna: Nome da coluna para filtrar (opcional).\n        valor: Valor a buscar na coluna (aceita string, int ou float).\n        coluna_retorno: Coluna espec\u00edfica para retornar (opcional).\n        limite: Limite de registros (padr\u00e3o: 100).\n    \n    Returns:\n        Uma string formatada com os dados consultados ou uma mensagem de erro/n\u00e3o encontrado.\n    \"\"\"\n    logger.info(f\"Consultando via DataSourceManager: coluna={coluna}, valor={valor}, coluna_retorno={coluna_retorno}, limite={limite}\")\n    \n    try:\n        data_manager = get_data_manager()\n        \n        # Se n\u00e3o houver filtro, retorna os primeiros dados\n        if not coluna or valor is None:\n            df_resultado = data_manager.get_data(limit=limite)\n        else:\n            # \u2705 Converte valor para string (aceita int, float ou string)\n            df_resultado = data_manager.search_data(column=coluna, value=str(valor), limit=limite)\n\n        if df_resultado is None or df_resultado.empty:\n            filtro_msg = f\" com filtro {coluna}='{valor}'\" if coluna and valor is not None else \"\"\n            return f\"Nenhum dado encontrado{filtro_msg}.\"\n\n        # Se coluna_retorno especificada, retornar apenas essa coluna\n        if coluna_retorno:\n            if coluna_retorno not in df_resultado.columns:\n                return f\"Coluna de retorno '{coluna_retorno}' n\u00e3o encontrada.\"\n            \n            if df_resultado.empty:\n                 return f\"Nenhum valor encontrado para '{coluna_retorno}' com o filtro especificado.\"\n\n            valor_retornado = df_resultado[coluna_retorno].iloc[0]\n            \n            if pd.isna(valor_retornado) or valor_retornado == '':\n                return f\"O valor para '{coluna_retorno}' no produto com {coluna}='{valor}' n\u00e3o foi encontrado ou est\u00e1 vazio.\"\n\n            # Formata\u00e7\u00e3o humanizada para casos comuns\n            coluna_upper = coluna.upper()\n            coluna_retorno_upper = coluna_retorno.upper()\n\n            # PRE\u00c7O DO PRODUTO\n            if coluna_upper == 'PRODUTO' and coluna_retorno_upper == 'LIQUIDO_38':\n                try:\n                    preco = float(valor_retornado)\n                    return f\"O pre\u00e7o do produto {valor} \u00e9 **R$ {preco:.2f}**.\"\n                except:\n                    return f\"O pre\u00e7o do produto {valor} \u00e9 R$ {valor_retornado}.\"\n\n            # CUSTO DO PRODUTO\n            elif coluna_upper == 'PRODUTO' and coluna_retorno_upper == 'ULTIMA_ENTRADA_CUSTO_CD':\n                try:\n                    custo = float(valor_retornado)\n                    return f\"O custo do produto {valor} \u00e9 **R$ {custo:.2f}**.\"\n                except:\n                    return f\"O custo do produto {valor} \u00e9 R$ {valor_retornado}.\"\n\n            # ESTOQUE DO PRODUTO\n            elif coluna_upper == 'PRODUTO' and coluna_retorno_upper == 'ESTOQUE_UNE':\n                try:\n                    estoque = int(valor_retornado)\n                    return f\"O produto {valor} tem **{estoque} unidades** em estoque.\"\n                except:\n                    return f\"O produto {valor} tem {valor_retornado} em estoque.\"\n\n            # NOME DO PRODUTO\n            elif coluna_upper == 'PRODUTO' and coluna_retorno_upper == 'NOME':\n                return f\"O produto {valor} \u00e9 **{valor_retornado}**.\"\n\n            # FABRICANTE DO PRODUTO\n            elif coluna_upper == 'PRODUTO' and coluna_retorno_upper == 'NOMEFABRICANTE':\n                return f\"O fabricante do produto {valor} \u00e9 **{valor_retornado}**.\"\n\n            # FALLBACK (caso gen\u00e9rico)\n            else:\n                return f\"O valor de {coluna_retorno} para {coluna}='{valor}' \u00e9 '{valor_retornado}'.\"\n        \n        # Retornar dados completos\n        response_data = _truncate_df_for_llm(df_resultado, max_rows=limite)\n        return f\"Consulta retornou {response_data['total_records']} registros.", "mimetype": "text/plain", "start_char_idx": 3557, "end_char_idx": 7455, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e905bd8c-c552-4268-9c12-a27839f69421": {"__data__": {"id_": "e905bd8c-c552-4268-9c12-a27839f69421", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "661e34ff-e65c-4e69-b3b0-898ffbc65201", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "hash": "4bde4606a466adde7e8c828baa0d8e252e7056fc25d64729444c3114a2515207", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "9c94e055-f57c-4d60-b19c-da2f8dd7851b", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "hash": "13cbad7e9f31c874992ff43566aaf9edb46b327bbb7cd77af7a10f4d3affaef8", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f3e62a9a-1886-4619-845b-b95b29804058", "node_type": "1", "metadata": {}, "hash": "dc9ea28493a90a4ff59e9fabe23e0b99ba9b83b4accc231ca3276423098e558e", "class_name": "RelatedNodeInfo"}}, "text": "# NOME DO PRODUTO\n            elif coluna_upper == 'PRODUTO' and coluna_retorno_upper == 'NOME':\n                return f\"O produto {valor} \u00e9 **{valor_retornado}**.\"\n\n            # FABRICANTE DO PRODUTO\n            elif coluna_upper == 'PRODUTO' and coluna_retorno_upper == 'NOMEFABRICANTE':\n                return f\"O fabricante do produto {valor} \u00e9 **{valor_retornado}**.\"\n\n            # FALLBACK (caso gen\u00e9rico)\n            else:\n                return f\"O valor de {coluna_retorno} para {coluna}='{valor}' \u00e9 '{valor_retornado}'.\"\n        \n        # Retornar dados completos\n        response_data = _truncate_df_for_llm(df_resultado, max_rows=limite)\n        return f\"Consulta retornou {response_data['total_records']} registros. Primeiros resultados: {response_data['data']}\"\n        \n    except Exception as e:\n        logger.error(f\"Erro ao consultar dados: {e}\", exc_info=True)\n        return f\"Erro ao consultar dados: {str(e)}.\"\n\n\n@tool\ndef buscar_produto(\n    codigo: Optional[str] = None,\n    nome: Optional[str] = None,\n    limite: int = 10\n) -> Dict[str, Any]:\n    \"\"\"\n    Busca produtos por c\u00f3digo ou nome usando o DataSourceManager.\n    \n    Args:\n        codigo: C\u00f3digo do produto (busca em 'CODIGO').\n        nome: Nome do produto (busca parcial em 'DESCRI\u00c7\u00c3O').\n        limite: N\u00famero m\u00e1ximo de resultados.\n    \n    Returns:\n        Dicion\u00e1rio com os produtos encontrados.\n    \"\"\"\n    logger.info(f\"Buscando produto via DataSourceManager: c\u00f3digo={codigo}, nome={nome}\")\n    \n    try:\n        data_manager = get_data_manager()\n        df_result = pd.DataFrame()\n        criterio = \"\"\n        valor_buscado = \"\"\n\n        if codigo:\n            df_result = data_manager.search_data(column='CODIGO', value=str(codigo).strip(), limit=limite)\n            criterio = \"c\u00f3digo\"\n            valor_buscado = codigo\n        elif nome:\n            df_result = data_manager.search_data(column='DESCRI\u00c7\u00c3O', value=nome, limit=limite)\n            criterio = \"nome\"\n            valor_buscado = nome\n        else:\n            return {\"status\": \"error\", \"message\": \"Informe c\u00f3digo ou nome do produto.\"}\n        \n        if df_result is None or df_result.empty:\n            return {\n                \"status\": \"not_found\",\n                \"message\": f\"Produto n\u00e3o encontrado com {criterio}='{valor_buscado}'.\"\n            }\n        \n        response_data = _truncate_df_for_llm(df_result, max_rows=limite)\n        \n        return {\n            \"status\": \"success\",\n            \"criterio_busca\": criterio,\n            \"valor_buscado\": valor_buscado,\n            \"colunas\": list(df_result.columns),\n            **response_data\n        }\n        \n    except Exception as e:\n        logger.error(f\"Erro ao buscar produto: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro: {str(e)}\"}", "mimetype": "text/plain", "start_char_idx": 6723, "end_char_idx": 9522, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f3e62a9a-1886-4619-845b-b95b29804058": {"__data__": {"id_": "f3e62a9a-1886-4619-845b-b95b29804058", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "661e34ff-e65c-4e69-b3b0-898ffbc65201", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "hash": "4bde4606a466adde7e8c828baa0d8e252e7056fc25d64729444c3114a2515207", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "e905bd8c-c552-4268-9c12-a27839f69421", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}, "hash": "bdaa1a821a6c0338e466d1c9514a7e5248c5fe30949836aa33d7da8252a3b016", "class_name": "RelatedNodeInfo"}}, "text": "@tool\ndef obter_estoque(\n    codigo_produto: Optional[str] = None,\n    nome_produto: Optional[str] = None\n) -> Dict[str, Any]:\n    \"\"\"\n    Obt\u00e9m informa\u00e7\u00f5es de estoque de um produto usando o DataSourceManager.\n    \n    Args:\n        codigo_produto: C\u00f3digo do produto.\n        nome_produto: Nome do produto.\n    \n    Returns:\n        Dados de estoque do produto.\n    \"\"\"\n    logger.info(f\"Consultando estoque via DataSourceManager: c\u00f3digo={codigo_produto}, nome={nome_produto}\")\n    \n    try:\n        data_manager = get_data_manager()\n        df_produto = pd.DataFrame()\n        criterio = \"\"\n\n        if codigo_produto:\n            df_produto = data_manager.search_data(column='CODIGO', value=str(codigo_produto).strip(), limit=1)\n            criterio = f\"c\u00f3digo={codigo_produto}\"\n        elif nome_produto:\n            df_produto = data_manager.search_data(column='DESCRI\u00c7\u00c3O', value=nome_produto, limit=1)\n            criterio = f\"nome contendo '{nome_produto}'\"\n        else:\n            return {\"status\": \"error\", \"message\": \"Informe c\u00f3digo ou nome do produto.\"}\n        \n        if df_produto is None or df_produto.empty:\n            return {\n                \"status\": \"not_found\",\n                \"message\": f\"Produto n\u00e3o encontrado com {criterio}.\"\n            }\n        \n        produto = df_produto.iloc[0]\n        \n        estoque_col = None\n        estoque_valor = 0\n        for col in ['QTD', 'SALDO', 'ESTOQUE']:\n            if col in df_produto.columns:\n                estoque_col = col\n                valor = produto.get(col)\n                if pd.notna(valor):\n                    estoque_valor = int(valor)\n                break\n        \n        info_produto = {\n            \"codigo\": str(produto.get('CODIGO', 'N/A')),\n            \"descricao\": str(produto.get('DESCRI\u00c7\u00c3O', 'N/A')),\n            \"estoque_coluna\": estoque_col,\n            \"estoque_valor\": estoque_valor,\n            \"fabricante\": str(produto.get('FABRICANTE', 'N/A')),\n            \"grupo\": str(produto.get('GRUPO', 'N/A'))\n        }\n        \n        return {\n            \"status\": \"success\",\n            \"criterio_busca\": criterio,\n            \"produto\": info_produto\n        }\n        \n    except Exception as e:\n        logger.error(f\"Erro ao obter estoque: {e}\", exc_info=True)\n        return {\"status\": \"error\", \"message\": f\"Erro: {str(e)}\"}\n\n\n# Lista de ferramentas unificadas - EXPORTA\u00c7\u00c3O IMPORTANTE\nunified_tools = [\n    listar_colunas_disponiveis,\n    consultar_dados,\n    buscar_produto,\n    obter_estoque,\n]", "mimetype": "text/plain", "start_char_idx": 9525, "end_char_idx": 12026, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0b8503dc-0335-43a8-947e-6175105c4def": {"__data__": {"id_": "0b8503dc-0335-43a8-947e-6175105c4def", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\verify_imports.py", "language": "python", "lines": 45, "filename": "verify_imports.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6e414818-2def-4da0-ad7b-2083240dafac", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\verify_imports.py", "language": "python", "lines": 45, "filename": "verify_imports.py"}, "hash": "f8a72cc6e8458dd43d16918aada63c8e238043c2aa49ba16ee7a9afb89c55387", "class_name": "RelatedNodeInfo"}}, "text": "import importlib\n\n\"\"\"\nScript para verificar se as importa\u00e7\u00f5es funcionam corretamente.\n\"\"\"\n\n\ndef check_import(module_name):\n    try:\n        importlib.import_module(module_name)\n        print(f\"\u2713 Importa\u00e7\u00e3o de '{module_name}' bem-sucedida\")\n        return True\n    except ImportError as e:\n        print(f\"\u2717 Erro ao importar '{module_name}': {e}\")\n        return False\n\n\n# Lista de m\u00f3dulos para verificar\nmodules_to_check = [\n    \"langchain_core.messages\",\n\n    # \"langgraph.graph\",\n    \"langchain_community.utilities\",\n    \"sqlalchemy\",\n    \"dotenv\",\n]\n\nprint(\"Verificando importa\u00e7\u00f5es cr\u00edticas...\")\nall_passed = True\n\nfor module in modules_to_check:\n    if not check_import(module):\n        all_passed = False\n\nif all_passed:\n    print(\"\\nTodas as importa\u00e7\u00f5es funcionam corretamente!\")\n    print(\"Se voc\u00ea ainda v\u00ea erros no VS Code, tente:\")\n    print(\"1. Reiniciar o VS Code\")\n    print(\n        \"2. Selecionar o interpretador Python correto (Ctrl+Shift+P -> Python: Select Interpreter)\"\n    )\n    print(\"3. Verificar se o arquivo .vscode/settings.json foi criado corretamente\")\nelse:\n    print(\"\\nAlgumas importa\u00e7\u00f5es falharam. Verifique os erros acima.\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1155, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8dd9050b-29f0-454a-b5a7-555d98abe524": {"__data__": {"id_": "8dd9050b-29f0-454a-b5a7-555d98abe524", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\tools\\__init__.py", "language": "python", "lines": 1, "filename": "__init__.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6a3e6291-5b9b-434d-a8a0-9fb83d3eb662", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\tools\\__init__.py", "language": "python", "lines": 1, "filename": "__init__.py"}, "hash": "3420a063dd2f5b023079eafbfb1432695a46418829ebc45508c9c978b7499c4e", "class_name": "RelatedNodeInfo"}}, "text": "", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 0, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9c738ddf-68ae-4f34-920f-aa34cf9b7294": {"__data__": {"id_": "9c738ddf-68ae-4f34-920f-aa34cf9b7294", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "265ddd63-d8e6-4210-820b-0bd4e7797745", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "hash": "5e88a1cfff48d153c07a21f9d12eb90a3fa1f1371a8b50a3e64de4a558fd79d7", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "cc0de57e-eece-4650-a46b-82a7c2fcbf53", "node_type": "1", "metadata": {}, "hash": "8cf0e2c19e5392292e858648bee77ebc8481f953f2a14a18a4d32f9b91e58d34", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSistema Autom\u00e1tico de Limpeza de Cache\nAutor: Agent_Solution_BI (Adaptado para FastAPI)\nData: 2025-12-03\n\nEste m\u00f3dulo implementa limpeza autom\u00e1tica de caches para:\n- __pycache__ (bytecode Python)\n- data/cache (cache LLM responses)\n- data/cache_agent_graph (cache de grafos)\n- Versionamento autom\u00e1tico para invalida\u00e7\u00e3o de cache\n\nExecuta automaticamente no startup do FastAPI.\n\"\"\"\n\nimport os\nimport shutil\nimport logging\nimport hashlib\nimport json\nfrom datetime import datetime, timedelta\nfrom pathlib import Path\nfrom typing import Dict, List, Tuple\n\nlogger = logging.getLogger(__name__)\n\n\nclass CacheCleaner:\n    \"\"\"\n    Sistema centralizado de limpeza autom\u00e1tica de cache com versionamento.\n    \"\"\"\n\n    def __init__(self, base_path: str = None, max_age_days: int = 7):\n        \"\"\"\n        Inicializa o limpador de cache.\n\n        Args:\n            base_path: Diret\u00f3rio raiz do projeto (default: cwd)\n            max_age_days: Idade m\u00e1xima de arquivos de cache (default: 7 dias)\n        \"\"\"\n        self.base_path = Path(base_path or os.getcwd())\n        self.max_age_days = max_age_days\n        self.max_age_seconds = max_age_days * 24 * 3600\n\n        # Diret\u00f3rios de cache a serem gerenciados\n        self.cache_dirs = {\n            \"python_cache\": self.base_path / \"__pycache__\",\n            \"llm_cache\": self.base_path / \"data\" / \"cache\",\n            \"agent_graph_cache\": self.base_path / \"data\" / \"cache_agent_graph\",\n        }\n\n        # Arquivo de versionamento\n        self.version_file = self.base_path / \"data\" / \".cache_version\"\n\n        logger.info(f\"CacheCleaner inicializado - Base: {self.base_path}, Max Age: {max_age_days}d\")\n\n    def get_code_version_hash(self) -> str:\n        \"\"\"\n        \u2705 OTIMIZA\u00c7\u00c3O v2.2: Gera hash baseado apenas em arquivos cr\u00edticos (10-20 arquivos)\n        Reduz tempo de processamento de 500ms-1.5s para ~50-100ms (10x+ mais r\u00e1pido)\n\n        Returns:\n            Hash SHA256 dos arquivos Python cr\u00edticos (primeiros 12 caracteres)\n        \"\"\"\n        hasher = hashlib.sha256()\n\n        # \u2705 Lista de arquivos cr\u00edticos (altera\u00e7\u00f5es aqui realmente importam para cache)\n        critical_files = [\n            \"backend/main.py\",\n            \"backend/app/core/graph/agent.py\",\n            \"backend/app/core/llm_gemini_adapter.py\",\n            \"backend/app/core/agents/caculinha_bi_agent.py\",\n            \"backend/app/core/agents/code_gen_agent.py\",\n            \"backend/app/infrastructure/data/polars_dask_adapter.py\",\n            \"backend/app/infrastructure/data/hybrid_adapter.py\",\n            \"backend/app/core/tools/data_tools.py\",\n            \"backend/app/core/tools/une_tools.py\",\n            \"backend/app/core/cache.py\",\n            \"backend/app/core/utils/response_cache.py\"\n        ]\n\n        files_processed = 0\n        for relative_path in critical_files:\n            try:\n                full_path = self.base_path / relative_path\n                if full_path.exists():\n                    # Incluir caminho relativo e timestamp de modifica\u00e7\u00e3o\n                    hasher.update(relative_path.encode())\n                    stat = full_path.stat()\n                    hasher.update(str(stat.st_mtime).encode())\n                    files_processed += 1\n            except Exception as e:\n                logger.debug(f\"Arquivo n\u00e3o encontrado ou erro: {relative_path} - {e}\")\n                continue\n\n        logger.debug(f\"\u2705 Hash de vers\u00e3o gerado a partir de {files_processed} arquivos cr\u00edticos\")\n        version_hash = hasher.hexdigest()[:12]\n        return version_hash\n\n    def load_version_info(self) -> Dict:\n        \"\"\"\n        Carrega informa\u00e7\u00f5es de vers\u00e3o do cache.\n\n        Returns:\n            Dict com version_hash, last_cleaned, etc.\n        \"\"\"\n        if not self.version_file.exists():\n            return {}\n\n        try:\n            with open(self.version_file, 'r') as f:\n                return json.load(f)\n        except Exception as e:\n            logger.warning(f\"Erro ao carregar version info: {e}\")\n            return {}\n\n    def save_version_info(self, info: Dict):\n        \"\"\"\n        Salva informa\u00e7\u00f5es de vers\u00e3o do cache.\n\n        Args:\n            info: Dicion\u00e1rio com version_hash, last_cleaned, etc.\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4188, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "cc0de57e-eece-4650-a46b-82a7c2fcbf53": {"__data__": {"id_": "cc0de57e-eece-4650-a46b-82a7c2fcbf53", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "265ddd63-d8e6-4210-820b-0bd4e7797745", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "hash": "5e88a1cfff48d153c07a21f9d12eb90a3fa1f1371a8b50a3e64de4a558fd79d7", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "9c738ddf-68ae-4f34-920f-aa34cf9b7294", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "hash": "979df02b0633eb98c8749ab2f6ccf9e01aac56773aee6100bb25f0b0f3b27846", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2169e8d1-ead4-4c44-a547-bd8fbe8ecabb", "node_type": "1", "metadata": {}, "hash": "33c046858926c047fb1169c53314eb2d94405cb3e088cf4caa7ac8b414aff745", "class_name": "RelatedNodeInfo"}}, "text": "Returns:\n            Dict com version_hash, last_cleaned, etc.\n        \"\"\"\n        if not self.version_file.exists():\n            return {}\n\n        try:\n            with open(self.version_file, 'r') as f:\n                return json.load(f)\n        except Exception as e:\n            logger.warning(f\"Erro ao carregar version info: {e}\")\n            return {}\n\n    def save_version_info(self, info: Dict):\n        \"\"\"\n        Salva informa\u00e7\u00f5es de vers\u00e3o do cache.\n\n        Args:\n            info: Dicion\u00e1rio com version_hash, last_cleaned, etc.\n        \"\"\"\n        try:\n            self.version_file.parent.mkdir(parents=True, exist_ok=True)\n            with open(self.version_file, 'w') as f:\n                json.dump(info, f, indent=2)\n        except Exception as e:\n            logger.error(f\"Erro ao salvar version info: {e}\")\n\n    def clean_pycache(self) -> Tuple[int, int]:\n        \"\"\"\n        Remove todos os diret\u00f3rios __pycache__ do projeto.\n\n        Returns:\n            (num_dirs_removed, total_size_mb)\n        \"\"\"\n        removed_count = 0\n        total_size = 0\n\n        try:\n            for pycache_dir in self.base_path.rglob(\"__pycache__\"):\n                try:\n                    # Calcular tamanho antes de remover\n                    for file in pycache_dir.rglob(\"*\"):\n                        if file.is_file():\n                            total_size += file.stat().st_size\n\n                    # Remover diret\u00f3rio\n                    shutil.rmtree(pycache_dir)\n                    removed_count += 1\n\n                except Exception as e:\n                    logger.warning(f\"Erro ao remover {pycache_dir}: {e}\")\n\n            size_mb = total_size / (1024 * 1024)\n            logger.info(f\"\u2705 Removidos {removed_count} diret\u00f3rios __pycache__ ({size_mb:.2f} MB)\")\n\n            return removed_count, size_mb\n\n        except Exception as e:\n            logger.error(f\"\u274c Erro na limpeza de __pycache__: {e}\")\n            return 0, 0\n\n    def clean_old_files(self, directory: Path, max_age_seconds: int = None) -> Tuple[int, int]:\n        \"\"\"\n        Remove arquivos antigos de um diret\u00f3rio.\n\n        Args:\n            directory: Diret\u00f3rio a limpar\n            max_age_seconds: Idade m\u00e1xima (default: self.max_age_seconds)\n\n        Returns:\n            (num_files_removed, total_size_mb)\n        \"\"\"\n        if not directory.exists():\n            return 0, 0\n\n        max_age = max_age_seconds or self.max_age_seconds\n        cutoff_time = datetime.now().timestamp() - max_age\n\n        removed_count = 0\n        total_size = 0\n\n        try:\n            for file in directory.rglob(\"*\"):\n                if not file.is_file():\n                    continue\n\n                try:\n                    # Verificar idade do arquivo\n                    file_mtime = file.stat().st_mtime\n\n                    if file_mtime < cutoff_time:\n                        file_size = file.stat().st_size\n                        total_size += file_size\n\n                        file.unlink()\n                        removed_count += 1\n\n                except Exception as e:\n                    logger.warning(f\"Erro ao remover {file}: {e}\")\n\n            size_mb = total_size / (1024 * 1024)\n\n            if removed_count > 0:\n                logger.info(f\"\u2705 Removidos {removed_count} arquivos antigos de {directory.name} ({size_mb:.2f} MB)\")\n\n            return removed_count, size_mb\n\n        except Exception as e:\n            logger.error(f\"\u274c Erro ao limpar {directory}: {e}\")\n            return 0, 0\n\n    def clean_all_cache(self, force: bool = False) -> Dict:\n        \"\"\"\n        Executa limpeza completa de todos os caches.\n\n        Args:\n            force: Se True, limpa tudo independente da vers\u00e3o\n\n        Returns:\n            Dict com estat\u00edsticas da limpeza\n        \"\"\"\n        logger.info(\"\ud83e\uddf9 Iniciando limpeza autom\u00e1tica de cache...\")\n\n        stats = {\n            \"timestamp\": datetime.now().isoformat(),\n            \"forced\": force,\n            \"pycache_removed\": 0,\n            \"pycache_size_mb\": 0,\n            \"old_files_removed\": 0,\n            \"old_files_size_mb\": 0,\n            \"cache_invalidated\": False,\n            \"previous_version\": None,\n            \"current_version\": None\n        }\n\n        # 1.", "mimetype": "text/plain", "start_char_idx": 3631, "end_char_idx": 7858, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2169e8d1-ead4-4c44-a547-bd8fbe8ecabb": {"__data__": {"id_": "2169e8d1-ead4-4c44-a547-bd8fbe8ecabb", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "265ddd63-d8e6-4210-820b-0bd4e7797745", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "hash": "5e88a1cfff48d153c07a21f9d12eb90a3fa1f1371a8b50a3e64de4a558fd79d7", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "cc0de57e-eece-4650-a46b-82a7c2fcbf53", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "hash": "1ca0aaa0787dfd8a5600bf89a766412999992c5887c5004ddedbbe8a68c71467", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "6d79fa1d-5938-4d1c-b749-19b241964f33", "node_type": "1", "metadata": {}, "hash": "038a6523e3a41bf4495dfd5775227ced2d63bbdfe41de8de29ff6bc7d533ad34", "class_name": "RelatedNodeInfo"}}, "text": "Args:\n            force: Se True, limpa tudo independente da vers\u00e3o\n\n        Returns:\n            Dict com estat\u00edsticas da limpeza\n        \"\"\"\n        logger.info(\"\ud83e\uddf9 Iniciando limpeza autom\u00e1tica de cache...\")\n\n        stats = {\n            \"timestamp\": datetime.now().isoformat(),\n            \"forced\": force,\n            \"pycache_removed\": 0,\n            \"pycache_size_mb\": 0,\n            \"old_files_removed\": 0,\n            \"old_files_size_mb\": 0,\n            \"cache_invalidated\": False,\n            \"previous_version\": None,\n            \"current_version\": None\n        }\n\n        # 1. Verificar versionamento\n        current_version = self.get_code_version_hash()\n        version_info = self.load_version_info()\n        previous_version = version_info.get(\"version_hash\")\n\n        stats[\"current_version\"] = current_version\n        stats[\"previous_version\"] = previous_version\n\n        # Se vers\u00e3o mudou, invalidar cache\n        if previous_version and previous_version != current_version:\n            logger.warning(f\"\ud83d\udd04 Vers\u00e3o do c\u00f3digo mudou: {previous_version} \u2192 {current_version}\")\n            logger.warning(\"\ud83e\uddf9 Invalidando TODOS os caches...\")\n            force = True\n            stats[\"cache_invalidated\"] = True\n\n        # 2. Limpar __pycache__ (sempre limpa)\n        pycache_count, pycache_size = self.clean_pycache()\n        stats[\"pycache_removed\"] = pycache_count\n        stats[\"pycache_size_mb\"] = round(pycache_size, 2)\n\n        # 3. Limpar arquivos antigos (ou tudo se force=True)\n        max_age = 0 if force else self.max_age_seconds\n\n        total_old_files = 0\n        total_old_size = 0\n\n        for cache_name, cache_dir in self.cache_dirs.items():\n            if cache_name == \"python_cache\":\n                continue  # J\u00e1 limpo acima\n\n            count, size = self.clean_old_files(cache_dir, max_age)\n            total_old_files += count\n            total_old_size += size\n\n        stats[\"old_files_removed\"] = total_old_files\n        stats[\"old_files_size_mb\"] = round(total_old_size, 2)\n\n        # 4. Salvar nova vers\u00e3o\n        new_version_info = {\n            \"version_hash\": current_version,\n            \"last_cleaned\": datetime.now().isoformat(),\n            \"max_age_days\": self.max_age_days,\n            \"stats\": stats\n        }\n\n        self.save_version_info(new_version_info)\n\n        # Log resumo\n        total_removed = stats[\"pycache_removed\"] + stats[\"old_files_removed\"]\n        total_size = stats[\"pycache_size_mb\"] + stats[\"old_files_size_mb\"]\n\n        logger.info(\"=\" * 80)\n        logger.info(\"\ud83d\udcca RESUMO DA LIMPEZA DE CACHE\")\n        logger.info(\"=\" * 80)\n        logger.info(f\"\ud83d\uddd1\ufe0f  Total de arquivos removidos: {total_removed}\")\n        logger.info(f\"\ud83d\udcbe Espa\u00e7o liberado: {total_size:.2f} MB\")\n        logger.info(f\"\ud83d\udd16 Vers\u00e3o do c\u00f3digo: {current_version}\")\n\n        if stats[\"cache_invalidated\"]:\n            logger.info(\"\ud83d\udd04 Cache invalidado (c\u00f3digo modificado)\")\n\n        logger.info(\"=\" * 80)\n\n        return stats\n\n    def clean_on_startup(self, force: bool = False):\n        \"\"\"\n        M\u00e9todo de conveni\u00eancia para executar no startup do FastAPI.\n\n        Args:\n            force: For\u00e7ar limpeza completa\n        \"\"\"\n        try:\n            stats = self.clean_all_cache(force=force)\n            return stats\n        except Exception as e:\n            logger.error(f\"\u274c Erro na limpeza de startup: {e}\", exc_info=True)\n            return None\n\n\ndef run_cache_cleanup(base_path: str = None, max_age_days: int = 7, force: bool = False) -> Dict:\n    \"\"\"\n    Fun\u00e7\u00e3o de conveni\u00eancia para executar limpeza de cache.\n\n    Args:\n        base_path: Diret\u00f3rio raiz do projeto\n        max_age_days: Idade m\u00e1xima de arquivos de cache\n        force: For\u00e7ar limpeza completa\n\n    Returns:\n        Dict com estat\u00edsticas da limpeza\n    \"\"\"\n    cleaner = CacheCleaner(base_path=base_path, max_age_days=max_age_days)\n    return cleaner.clean_on_startup(force=force)", "mimetype": "text/plain", "start_char_idx": 7271, "end_char_idx": 11163, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6d79fa1d-5938-4d1c-b749-19b241964f33": {"__data__": {"id_": "6d79fa1d-5938-4d1c-b749-19b241964f33", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "265ddd63-d8e6-4210-820b-0bd4e7797745", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "hash": "5e88a1cfff48d153c07a21f9d12eb90a3fa1f1371a8b50a3e64de4a558fd79d7", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2169e8d1-ead4-4c44-a547-bd8fbe8ecabb", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}, "hash": "ebce6f92b73bf6b46903bd9687c1e03b75004fca0cbf921c7a31ddbf03b4c578", "class_name": "RelatedNodeInfo"}}, "text": "Args:\n            force: For\u00e7ar limpeza completa\n        \"\"\"\n        try:\n            stats = self.clean_all_cache(force=force)\n            return stats\n        except Exception as e:\n            logger.error(f\"\u274c Erro na limpeza de startup: {e}\", exc_info=True)\n            return None\n\n\ndef run_cache_cleanup(base_path: str = None, max_age_days: int = 7, force: bool = False) -> Dict:\n    \"\"\"\n    Fun\u00e7\u00e3o de conveni\u00eancia para executar limpeza de cache.\n\n    Args:\n        base_path: Diret\u00f3rio raiz do projeto\n        max_age_days: Idade m\u00e1xima de arquivos de cache\n        force: For\u00e7ar limpeza completa\n\n    Returns:\n        Dict com estat\u00edsticas da limpeza\n    \"\"\"\n    cleaner = CacheCleaner(base_path=base_path, max_age_days=max_age_days)\n    return cleaner.clean_on_startup(force=force)\n\n\nif __name__ == \"__main__\":\n    # Teste manual\n    import sys\n\n    # Configurar logging\n    logging.basicConfig(\n        level=logging.INFO,\n        format='%(levelname)s - %(name)s - %(message)s'\n    )\n\n    print(\"=\" * 80)\n    print(\"TESTE DO SISTEMA DE LIMPEZA DE CACHE\")\n    print(\"=\" * 80)\n\n    # Executar limpeza\n    stats = run_cache_cleanup(force=False)\n\n    if stats:\n        print(\"\\n[OK] Limpeza concluida com sucesso!\")\n        print(f\"\\nEstatisticas:\")\n        print(f\"  - Arquivos removidos: {stats['pycache_removed'] + stats['old_files_removed']}\")\n        print(f\"  - Espaco liberado: {stats['pycache_size_mb'] + stats['old_files_size_mb']:.2f} MB\")\n        print(f\"  - Versao: {stats['current_version']}\")\n    else:\n        print(\"\\n[ERRO] Erro na limpeza!\")\n        sys.exit(1)", "mimetype": "text/plain", "start_char_idx": 10373, "end_char_idx": 11959, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c925a0f4-71d2-48ed-8d25-65722cd3d060": {"__data__": {"id_": "c925a0f4-71d2-48ed-8d25-65722cd3d060", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\chart_saver.py", "language": "python", "lines": 54, "filename": "chart_saver.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "36b75554-8723-460d-8ca5-cac6322fbc27", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\chart_saver.py", "language": "python", "lines": 54, "filename": "chart_saver.py"}, "hash": "866af3273d058371e617f96e28de703495007643c9b5b4c58791aaad83d8c012", "class_name": "RelatedNodeInfo"}}, "text": "import os\nimport json\nimport uuid\nfrom datetime import datetime\nfrom pathlib import Path\nimport logging\n\nlogger = logging.getLogger(__name__)\n\nDASHBOARD_DIR = \"data/dashboards\"\n\ndef save_chart(chart_json: str):\n    \"\"\"\n    Salva um gr\u00e1fico JSON em um arquivo no diret\u00f3rio de dashboards.\n\n    Args:\n        chart_json (str): A string JSON do gr\u00e1fico Plotly.\n    \"\"\"\n    try:\n        # Caminho h\u00edbrido Docker/Dev\n        docker_path = Path(\"/app/data/dashboards\")\n        dev_path = Path(__file__).parent.parent.parent.parent.parent / \"data\" / \"dashboards\"\n\n        dashboard_dir = docker_path if docker_path.parent.exists() else dev_path\n\n        # Garantir que o diret\u00f3rio de dashboards exista\n        os.makedirs(dashboard_dir, exist_ok=True)\n\n        # Extrair o t\u00edtulo do gr\u00e1fico do JSON para usar no nome do arquivo\n        chart_data = json.loads(chart_json) if isinstance(chart_json, str) else chart_json\n        title = chart_data.get(\"layout\", {}).get(\"title\", {}).get(\"text\", \"grafico-sem-titulo\")\n\n        # Limpar o t\u00edtulo para criar um nome de arquivo seguro\n        safe_title = \"\".join(c for c in title if c.isalnum() or c in (' ', '_')).rstrip()\n        safe_title = safe_title.replace(\" \", \"_\").lower()\n\n        # Criar um nome de arquivo \u00fanico\n        timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\n        unique_id = str(uuid.uuid4())[:8]\n        filename = f\"{timestamp}_{safe_title}_{unique_id}.json\"\n        filepath = os.path.join(dashboard_dir, filename)\n\n        # Salvar o arquivo\n        with open(filepath, \"w\", encoding=\"utf-8\") as f:\n            if isinstance(chart_json, str):\n                f.write(chart_json)\n            else:\n                json.dump(chart_json, f, ensure_ascii=False, indent=2)\n\n        logger.info(f\"Gr\u00e1fico salvo com sucesso em: {filepath}\")\n\n    except Exception as e:\n        logger.error(f\"Erro ao salvar o gr\u00e1fico: {e}\", exc_info=True)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1902, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5dab1c3d-e65e-41bf-96b1-eddcfe8b1c62": {"__data__": {"id_": "5dab1c3d-e65e-41bf-96b1-eddcfe8b1c62", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "29096612-3ffa-4ba9-bf73-48fa3f45b354", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "hash": "21e2d4aaa098cfbaefbfe834e6b0c4451c2b1d91d6ebcc5d34d73a1b7a313ea0", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "d77588c7-85fa-439d-8997-a804e99feba4", "node_type": "1", "metadata": {}, "hash": "390a441fda1596aedf1731481684785ecfd45bfa9aaac5a8c16d5abe45b07bd1", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nError Handler - Gerenciamento centralizado de erros.\n\nEste m\u00f3dulo fornece tratamento robusto e centralizado de erros\npara o sistema Agent Solution BI.\n\nFuncionalidades:\n- Captura de exce\u00e7\u00f5es espec\u00edficas (ParquetFileError, etc)\n- Logging estruturado com contexto completo\n- Mensagens user-friendly\n- Rastreamento de erros recorrentes\n\nAutor: Code Agent\nData: 2025-10-17\n\"\"\"\n\nimport logging\nimport traceback\nfrom typing import Dict, Any, Optional, Callable\nfrom datetime import datetime\nfrom pathlib import Path\nfrom functools import wraps\nimport json\n\nlogger = logging.getLogger(__name__)\n\n# Diret\u00f3rio para logs de erro\nERROR_LOG_DIR = Path(\"data/learning\")\nERROR_LOG_DIR.mkdir(parents=True, exist_ok=True)\n\n\nclass APIError(Exception):\n    \"\"\"Exce\u00e7\u00e3o customizada para erros da API\"\"\"\n    def __init__(self, message: str, status_code: int = 500, details: Optional[Dict[str, Any]] = None):\n        self.message = message\n        self.status_code = status_code\n        self.details = details or {}\n        super().__init__(self.message)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1036, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d77588c7-85fa-439d-8997-a804e99feba4": {"__data__": {"id_": "d77588c7-85fa-439d-8997-a804e99feba4", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "29096612-3ffa-4ba9-bf73-48fa3f45b354", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "hash": "21e2d4aaa098cfbaefbfe834e6b0c4451c2b1d91d6ebcc5d34d73a1b7a313ea0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "5dab1c3d-e65e-41bf-96b1-eddcfe8b1c62", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "hash": "99cf628916ba5c96a1c022f9005008ad5f4a6f35de044c5e226f0e29b122893f", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "88399c72-a630-4786-ba4b-b3e32f649cf1", "node_type": "1", "metadata": {}, "hash": "22602ebb4db6e3962b37a4b25e240fe46d3af805484f3f6e6b3aa20cf2d7f533", "class_name": "RelatedNodeInfo"}}, "text": "class APIError(Exception):\n    \"\"\"Exce\u00e7\u00e3o customizada para erros da API\"\"\"\n    def __init__(self, message: str, status_code: int = 500, details: Optional[Dict[str, Any]] = None):\n        self.message = message\n        self.status_code = status_code\n        self.details = details or {}\n        super().__init__(self.message)\n\n\nclass ErrorContext:\n    \"\"\"\n    Contexto de erro com informa\u00e7\u00f5es detalhadas.\n    \"\"\"\n\n    def __init__(\n        self,\n        error: Exception,\n        context: Dict[str, Any],\n        user_message: Optional[str] = None\n    ):\n        \"\"\"\n        Inicializa contexto de erro.\n\n        Args:\n            error: Exce\u00e7\u00e3o capturada\n            context: Dicion\u00e1rio com contexto (fun\u00e7\u00e3o, par\u00e2metros, etc)\n            user_message: Mensagem personalizada para o usu\u00e1rio\n        \"\"\"\n        self.error = error\n        self.error_type = type(error).__name__\n        self.error_message = str(error)\n        self.context = context\n        self.user_message = user_message or self._generate_user_message()\n        self.timestamp = datetime.now()\n        self.traceback = traceback.format_exc()\n\n    def _generate_user_message(self) -> str:\n        \"\"\"\n        Gera mensagem amig\u00e1vel baseada no tipo de erro.\n\n        Returns:\n            Mensagem formatada para o usu\u00e1rio\n        \"\"\"\n        error_messages = {\n            'FileNotFoundError': 'Arquivo de dados n\u00e3o encontrado. Verifique se os dados foram carregados.',\n            'PermissionError': 'Sem permiss\u00e3o para acessar o arquivo. Verifique as permiss\u00f5es do sistema.',\n            'KeyError': 'Campo n\u00e3o encontrado nos dados. Verifique os par\u00e2metros da consulta.',\n            'ValueError': 'Valor inv\u00e1lido encontrado. Verifique os dados de entrada.',\n            'TypeError': 'Tipo de dado incompat\u00edvel na opera\u00e7\u00e3o.',\n            'ParserError': 'Erro ao ler arquivo de dados. O arquivo pode estar corrompido.',\n            'MemoryError': 'Mem\u00f3ria insuficiente. Tente reduzir o volume de dados consultado.',\n            'TimeoutError': 'A opera\u00e7\u00e3o demorou muito tempo. Tente usar filtros mais espec\u00edficos.',\n            'ConnectionError': 'Erro de conex\u00e3o. Verifique a conectividade de rede.',\n            'OSError': 'Erro de sistema operacional ao acessar arquivos.',\n        }\n\n        base_message = error_messages.get(\n            self.error_type,\n            'Ocorreu um erro ao processar sua solicita\u00e7\u00e3o.'\n        )\n\n        return f\"{base_message}\"\n\n    def to_dict(self) -> Dict[str, Any]:\n        \"\"\"\n        Converte contexto para dicion\u00e1rio.\n\n        Returns:\n            Dict com informa\u00e7\u00f5es do erro\n        \"\"\"\n        return {\n            'timestamp': self.timestamp.isoformat(),\n            'error_type': self.error_type,\n            'error_message': self.error_message,\n            'user_message': self.user_message,\n            'context': self.context,\n            'traceback': self.traceback\n        }\n\n    def log(self, level: int = logging.ERROR):\n        \"\"\"\n        Registra erro no log.\n\n        Args:\n            level: N\u00edvel de log (logging.ERROR, logging.WARNING, etc)\n        \"\"\"\n        logger.log(\n            level,\n            f\"Erro {self.error_type}: {self.error_message}\\n\"\n            f\"Contexto: {json.dumps(self.context, indent=2)}\\n\"\n            f\"Traceback: {self.traceback}\"\n        )\n\n    def save_to_file(self):\n        \"\"\"\n        Salva erro em arquivo para an\u00e1lise posterior.\n        \"\"\"\n        try:\n            today = datetime.now().strftime('%Y%m%d')\n            error_file = ERROR_LOG_DIR / f\"error_log_{today}.jsonl\"\n\n            with open(error_file, 'a', encoding='utf-8') as f:\n                f.write(json.dumps(self.to_dict(), ensure_ascii=False) + '\\n')\n\n            logger.debug(f\"Erro salvo em {error_file}\")\n\n        except Exception as e:\n            logger.warning(f\"Erro ao salvar log de erro: {e}\")", "mimetype": "text/plain", "start_char_idx": 712, "end_char_idx": 4547, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "88399c72-a630-4786-ba4b-b3e32f649cf1": {"__data__": {"id_": "88399c72-a630-4786-ba4b-b3e32f649cf1", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "29096612-3ffa-4ba9-bf73-48fa3f45b354", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "hash": "21e2d4aaa098cfbaefbfe834e6b0c4451c2b1d91d6ebcc5d34d73a1b7a313ea0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "d77588c7-85fa-439d-8997-a804e99feba4", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "hash": "b75e05a1a7f5dfc45f54980cb4ccea85b42e2edfc51a6c9a57f7af10bd41ccba", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "64e51d6e-4ffc-4ea4-b91c-5ad1ec1a369c", "node_type": "1", "metadata": {}, "hash": "8f7e147f23fe59e3bf3859ec066074f385f464c08892d26ed6139d0a7478857a", "class_name": "RelatedNodeInfo"}}, "text": "class ErrorHandler:\n    \"\"\"\n    Gerenciador centralizado de erros.\n    \"\"\"\n\n    def __init__(self):\n        \"\"\"Inicializa o gerenciador de erros.\"\"\"\n        self.error_counts = {}\n        self.last_errors = []\n        self.max_last_errors = 100\n\n    def handle_error(\n        self,\n        error: Exception,\n        context: Dict[str, Any],\n        user_message: Optional[str] = None,\n        log_level: int = logging.ERROR,\n        save_to_file: bool = True\n    ) -> ErrorContext:\n        \"\"\"\n        Trata um erro de forma centralizada.\n\n        Args:\n            error: Exce\u00e7\u00e3o capturada\n            context: Contexto da opera\u00e7\u00e3o\n            user_message: Mensagem personalizada para usu\u00e1rio\n            log_level: N\u00edvel de log\n            save_to_file: Se deve salvar em arquivo\n\n        Returns:\n            ErrorContext com informa\u00e7\u00f5es do erro\n        \"\"\"\n        # Criar contexto de erro\n        error_ctx = ErrorContext(error, context, user_message)\n\n        # Registrar no log\n        error_ctx.log(log_level)\n\n        # Salvar em arquivo se necess\u00e1rio\n        if save_to_file:\n            error_ctx.save_to_file()\n\n        # Atualizar contadores\n        error_type = error_ctx.error_type\n        self.error_counts[error_type] = self.error_counts.get(error_type, 0) + 1\n\n        # Manter hist\u00f3rico de erros recentes\n        self.last_errors.append(error_ctx)\n        if len(self.last_errors) > self.max_last_errors:\n            self.last_errors.pop(0)\n\n        return error_ctx\n\n    def get_error_stats(self) -> Dict[str, Any]:\n        \"\"\"\n        Retorna estat\u00edsticas de erros.\n\n        Returns:\n            Dict com contadores e informa\u00e7\u00f5es de erros\n        \"\"\"\n        return {\n            'total_errors': sum(self.error_counts.values()),\n            'error_counts': self.error_counts,\n            'recent_errors_count': len(self.last_errors),\n            'most_common_error': max(self.error_counts.items(), key=lambda x: x[1])[0] if self.error_counts else None\n        }\n\n    def clear_stats(self):\n        \"\"\"Limpa estat\u00edsticas de erro.\"\"\"\n        self.error_counts.clear()\n        self.last_errors.clear()\n        logger.info(\"Estat\u00edsticas de erro limpas\")\n\n\n# Inst\u00e2ncia global\n_error_handler = ErrorHandler()\n\n\ndef handle_error(\n    error: Exception,\n    context: Dict[str, Any],\n    user_message: Optional[str] = None\n) -> ErrorContext:\n    \"\"\"\n    Fun\u00e7\u00e3o auxiliar para tratamento de erro.\n\n    Args:\n        error: Exce\u00e7\u00e3o\n        context: Contexto\n        user_message: Mensagem para usu\u00e1rio\n\n    Returns:\n        ErrorContext\n    \"\"\"\n    return _error_handler.handle_error(error, context, user_message)\n\n\ndef get_error_stats() -> Dict[str, Any]:\n    \"\"\"Retorna estat\u00edsticas de erros.\"\"\"\n    return _error_handler.get_error_stats()", "mimetype": "text/plain", "start_char_idx": 4550, "end_char_idx": 7300, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "64e51d6e-4ffc-4ea4-b91c-5ad1ec1a369c": {"__data__": {"id_": "64e51d6e-4ffc-4ea4-b91c-5ad1ec1a369c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "29096612-3ffa-4ba9-bf73-48fa3f45b354", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "hash": "21e2d4aaa098cfbaefbfe834e6b0c4451c2b1d91d6ebcc5d34d73a1b7a313ea0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "88399c72-a630-4786-ba4b-b3e32f649cf1", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "hash": "6269814eaf34359b5503fee6cf0e239d6bf7f14b442286eeec1038a240bddecc", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b465b2ff-9c61-4d97-8063-d3c5ed4b35a4", "node_type": "1", "metadata": {}, "hash": "0a9490e0e1949f52d70d6b8220629a11f8366f1d71e717dcad57707302055636", "class_name": "RelatedNodeInfo"}}, "text": "# Inst\u00e2ncia global\n_error_handler = ErrorHandler()\n\n\ndef handle_error(\n    error: Exception,\n    context: Dict[str, Any],\n    user_message: Optional[str] = None\n) -> ErrorContext:\n    \"\"\"\n    Fun\u00e7\u00e3o auxiliar para tratamento de erro.\n\n    Args:\n        error: Exce\u00e7\u00e3o\n        context: Contexto\n        user_message: Mensagem para usu\u00e1rio\n\n    Returns:\n        ErrorContext\n    \"\"\"\n    return _error_handler.handle_error(error, context, user_message)\n\n\ndef get_error_stats() -> Dict[str, Any]:\n    \"\"\"Retorna estat\u00edsticas de erros.\"\"\"\n    return _error_handler.get_error_stats()\n\n\ndef error_handler_decorator(\n    context_func: Optional[Callable] = None,\n    user_message: Optional[str] = None,\n    return_on_error: Any = None\n):\n    \"\"\"\n    Decorador para tratamento autom\u00e1tico de erros.\n\n    Args:\n        context_func: Fun\u00e7\u00e3o que retorna contexto (recebe args, kwargs)\n        user_message: Mensagem personalizada para usu\u00e1rio\n        return_on_error: Valor a retornar em caso de erro\n\n    Example:\n        @error_handler_decorator(\n            context_func=lambda *args, **kwargs: {'function': 'my_func', 'args': args},\n            return_on_error={'success': False, 'data': []}\n        )\n        def my_function(param1, param2):\n            # c\u00f3digo que pode gerar erro\n            pass\n    \"\"\"\n    def decorator(func):\n        @wraps(func)\n        def wrapper(*args, **kwargs):\n            try:\n                return func(*args, **kwargs)\n\n            except Exception as e:\n                # Gerar contexto\n                if context_func:\n                    context = context_func(*args, **kwargs)\n                else:\n                    context = {\n                        'function': func.__name__,\n                        'args': str(args)[:200],  # Limitar tamanho\n                        'kwargs': str(kwargs)[:200]\n                    }\n\n                # Tratar erro\n                error_ctx = _error_handler.handle_error(e, context, user_message)\n\n                # Retornar valor padr\u00e3o ou re-raise\n                if return_on_error is not None:\n                    # Se return_on_error for um dict, adicionar mensagem de erro\n                    if isinstance(return_on_error, dict):\n                        result = return_on_error.copy()\n                        result['error'] = error_ctx.user_message\n                        result['error_type'] = error_ctx.error_type\n                        return result\n                    else:\n                        return return_on_error\n                else:\n                    raise\n\n        return wrapper\n    return decorator\n\n\ndef create_error_response(\n    error: Exception,\n    context: Dict[str, Any],\n    include_details: bool = False\n) -> Dict[str, Any]:\n    \"\"\"\n    Cria resposta padronizada de erro.\n\n    Args:\n        error: Exce\u00e7\u00e3o capturada\n        context: Contexto da opera\u00e7\u00e3o\n        include_details: Se deve incluir detalhes t\u00e9cnicos\n\n    Returns:\n        Dict com resposta de erro formatada\n    \"\"\"\n    error_ctx = _error_handler.handle_error(error, context)\n\n    response = {\n        'success': False,\n        'data': [],\n        'count': 0,\n        'message': error_ctx.user_message,\n        'error_type': error_ctx.error_type,\n        'timestamp': error_ctx.timestamp.isoformat()\n    }\n\n    if include_details:\n        response['error_details'] = {\n            'error_message': error_ctx.error_message,\n            'context': error_ctx.context\n        }\n\n    return response\n\n\n# Mapeamento de exce\u00e7\u00f5es espec\u00edficas do Parquet\nclass ParquetErrorHandler:\n    \"\"\"\n    Handler espec\u00edfico para erros relacionados a arquivos Parquet.\n    \"\"\"\n\n    @staticmethod\n    def handle_parquet_error(error: Exception, file_path: str) -> Dict[str, Any]:\n        \"\"\"\n        Trata erros espec\u00edficos de Parquet.\n\n        Args:\n            error: Exce\u00e7\u00e3o\n            file_path: Caminho do arquivo Parquet\n\n        Returns:\n            Dict com resposta de erro\n        \"\"\"\n        context = {\n            'operation': 'parquet_read',\n            'file_path': file_path,\n            'file_exists': Path(file_path).exists()\n        }\n\n        # Mensagens espec\u00edficas para erros Parquet\n        parquet_messages = {\n            'ArrowInvalid': 'Arquivo Parquet inv\u00e1lido ou corrompido.',\n            'ArrowIOError': 'Erro de I/O ao ler arquivo Parquet.',\n            'OSError': f'N\u00e3o foi poss\u00edvel acessar o arquivo: {file_path}',\n        }\n\n        error_type = type(error).__name__\n        user_message = parquet_messages.get(error_type)\n\n        return create_error_response(error, context, include_details=False)", "mimetype": "text/plain", "start_char_idx": 6724, "end_char_idx": 11306, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b465b2ff-9c61-4d97-8063-d3c5ed4b35a4": {"__data__": {"id_": "b465b2ff-9c61-4d97-8063-d3c5ed4b35a4", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "29096612-3ffa-4ba9-bf73-48fa3f45b354", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "hash": "21e2d4aaa098cfbaefbfe834e6b0c4451c2b1d91d6ebcc5d34d73a1b7a313ea0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "64e51d6e-4ffc-4ea4-b91c-5ad1ec1a369c", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}, "hash": "ac8666e6b26007bc4f5d64bebf78e2cd3822ab6169b9dadf3bd558f4eb55a359", "class_name": "RelatedNodeInfo"}}, "text": "if __name__ == \"__main__\":\n    # Teste b\u00e1sico do error handler\n    logging.basicConfig(level=logging.INFO)\n\n    # Teste 1: Erro simples\n    try:\n        raise ValueError(\"Teste de erro\")\n    except Exception as e:\n        error_ctx = handle_error(\n            e,\n            context={'function': 'test', 'param': 'value'}\n        )\n        print(f\"\\nMensagem para usu\u00e1rio: {error_ctx.user_message}\")\n\n    # Teste 2: Estat\u00edsticas\n    stats = get_error_stats()\n    print(f\"\\nEstat\u00edsticas: {stats}\")\n\n    # Teste 3: Decorador\n    @error_handler_decorator(\n        context_func=lambda x: {'param': x},\n        return_on_error={'success': False, 'data': []}\n    )\n    def test_function(param):\n        if param == 'error':\n            raise KeyError(\"Campo n\u00e3o encontrado\")\n        return {'success': True, 'data': [param]}\n\n    result = test_function('error')\n    print(f\"\\nResultado com erro: {result}\")\n\n    result = test_function('ok')\n    print(f\"Resultado sem erro: {result}\")", "mimetype": "text/plain", "start_char_idx": 11309, "end_char_idx": 12286, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "899b9843-5ea6-4d19-a410-bc15e0287219": {"__data__": {"id_": "899b9843-5ea6-4d19-a410-bc15e0287219", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler_backup.py", "language": "python", "lines": 116, "filename": "error_handler_backup.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f52fd3e4-756d-420f-8950-efc855d6dbd0", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler_backup.py", "language": "python", "lines": 116, "filename": "error_handler_backup.py"}, "hash": "a0d9a7bb7cddf72e2d27f10b97399ea4abb32ed7b44360146930b5050b0d7d73", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/utils/error_handler.py\n\nimport functools\nimport logging\nfrom typing import Callable, Any, Dict\n\n# Configure basic logging for now. In a real app, this would be more sophisticated.\nlogging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')\nlogger = logging.getLogger(__name__)\n\nclass APIError(Exception):\n    \"\"\"Custom exception for API-related errors.\"\"\"\n    def __init__(self, message: str, status_code: int = 500, details: Any = None):\n        super().__init__(message)\n        self.message = message\n        self.status_code = status_code\n        self.details = details\n\n    def to_dict(self) -> Dict[str, Any]:\n        return {\n            \"message\": self.message,\n            \"status_code\": self.status_code,\n            \"details\": self.details\n        }\n\ndef error_handler_decorator(func: Callable) -> Callable:\n    \"\"\"\n    Decorator for handling errors in FastAPI endpoints or core logic functions.\n    It logs the error in a structured format and returns a user-friendly APIError response.\n    \"\"\"\n    @functools.wraps(func)\n    async def wrapper(*args, **kwargs) -> Any:\n        try:\n            # If the original function is an async function, await it\n            if inspect.iscoroutinefunction(func):\n                return await func(*args, **kwargs)\n            else:\n                return func(*args, **kwargs)\n        except APIError as e:\n            # Custom APIError, log and re-raise (or return appropriate response)\n            logger.error(\n                \"API Error caught in %s: %s\",\n                func.__name__,\n                e.message,\n                exc_info=True,\n                extra={\"status_code\": e.status_code, \"details\": e.details}\n            )\n            raise e # Re-raise to be caught by FastAPI's exception handlers\n        except Exception as e:\n            # Catch all other unexpected errors\n            error_message = \"An unexpected error occurred.\"\n            status_code = 500\n            \n            # Attempt to extract a more specific message if available\n            if hasattr(e, 'detail'): # Common for HTTPException in FastAPI\n                error_message = e.detail\n            elif str(e):\n                error_message = str(e)\n\n            logger.error(\n                \"Unhandled exception in %s: %s\",\n                func.__name__,\n                error_message,\n                exc_info=True,\n                extra={\"original_exception_type\": type(e).__name__}\n            )\n            # You might want to return a standardized error response here,\n            # or raise a new APIError which FastAPI can then handle.\n            raise APIError(\n                message=f\"Internal Server Error: {error_message}\",\n                status_code=status_code,\n                details={\"function\": func.__name__, \"error_type\": type(e).__name__}\n            )\n    return wrapper\n\nimport inspect # Import inspect for checking coroutine function\n\n# Example usage (for demonstration, can be removed in final version)\nif __name__ == \"__main__\":\n    # Example functions to demonstrate the decorator\n    @error_handler_decorator\n    def my_sync_function(should_fail: bool):\n        if should_fail:\n            raise ValueError(\"Something went wrong in sync function!\")\n        return {\"status\": \"success\", \"data\": \"Sync data\"}\n\n    @error_handler_decorator\n    async def my_async_function(should_fail: bool):\n        if should_fail:\n            raise APIError(\"Custom API error in async function!\", status_code=400, details={\"code\": \"BAD_REQUEST\"})\n        return {\"status\": \"success\", \"data\": \"Async data\"}\n\n    # Test sync function\n    print(\"--- Testing Sync Function ---\")\n    try:\n        print(my_sync_function(False))\n        # print(my_sync_function(True)) # This would raise an APIError\n    except APIError as e:\n        print(f\"Caught APIError: {e.to_dict()}\")\n    except Exception as e:\n        print(f\"Caught unexpected exception: {e}\")\n\n    # Test async function (requires an async context to run)\n    print(\"\\n--- Testing Async Function ---\")\n    import asyncio\n    async def run_async_tests():\n        try:\n            print(await my_async_function(False))\n            # print(await my_async_function(True)) # This would raise an APIError\n        except APIError as e:\n            print(f\"Caught APIError: {e.to_dict()}\")\n        except Exception as e:\n            print(f\"Caught unexpected exception: {e}\")\n\n    asyncio.run(run_async_tests())", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4480, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f64a07c9-f79f-465f-8d1d-4924f23faba0": {"__data__": {"id_": "f64a07c9-f79f-465f-8d1d-4924f23faba0", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\fast_path_detector.py", "language": "python", "lines": 74, "filename": "fast_path_detector.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "342b7401-f2f2-4cd6-b4dd-bbb4dda0bfdf", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\fast_path_detector.py", "language": "python", "lines": 74, "filename": "fast_path_detector.py"}, "hash": "b14eb2fc6fa99337afef5940b477227c9285578897823ecf1a15f5133c07f5c4", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/utils/fast_path_detector.py\n\nimport re\nfrom typing import Optional\n\ndef detect_fast_path_query(query: str) -> Optional[str]:\n    \"\"\"\n    Detects if a query can be handled by a fast-path, bypassing complex agent orchestration. \n    \n    Fast-path queries are typically simple, direct requests that can be routed to a\n    specific tool or information retrieval mechanism without LLM reasoning steps.\n\n    Args:\n        query: The user's natural language query.\n\n    Returns:\n        The name of the target node/tool for the fast-path, or None if no fast-path is detected.\n    \"\"\"\n    query_lower = query.lower()\n\n    # Fast-path for UNE Operations\n    if \"abastecimento\" in query_lower or \\\n       \"mc produto\" in query_lower or \\\n       \"pre\u00e7o final\" in query_lower or \\\n       \"validar transfer\u00eancia\" in query_lower or \\\n       \"sugerir transfer\u00eancias\" in query_lower or \\\n       \"rupturas cr\u00edticas\" in query_lower:\n        # These queries can likely be routed directly to the specific UNE tools\n        # The CaculinhaBIAgent already handles this with its tool routing logic.\n        # This function could return a specific tool name to indicate a fast-path match.\n        if \"abastecimento\" in query_lower:\n            return \"calcular_abastecimento_une\"\n        elif \"mc produto\" in query_lower:\n            return \"calcular_mc_produto\"\n        elif \"pre\u00e7o final\" in query_lower:\n            return \"calcular_preco_final_une\"\n        elif \"validar transfer\u00eancia\" in query_lower:\n            return \"validar_transferencia_produto\"\n        elif \"sugerir transfer\u00eancias\" in query_lower:\n            return \"sugerir_transferencias_automaticas\"\n        elif \"rupturas cr\u00edticas\" in query_lower:\n            return \"encontrar_rupturas_criticas\"\n\n    # Fast-path for simple data retrieval/listing\n    if re.search(r\"mostre-me (as )?(dez )?(cinco )?(dez )?(ultimas |primeiras )?vendas\", query_lower) or \\\n       re.search(r\"listar (todos )?(os )?produtos\", query_lower):\n        # These might be handled by a direct database query tool or a simple data listing tool\n        return \"simple_data_listing_tool\"\n\n    # Fast-path for status/health checks\n    if \"status\" in query_lower or \"sa\u00fade\" in query_lower:\n        return \"status_check_tool\" # Example: an API endpoint for health\n\n    return None\n\nif __name__ == '__main__':\n    print(\"--- Testing Fast-Path Detector ---\")\n    \n    # UNE related queries\n    print(f\"Query: 'Qual o abastecimento da UNE 101?' -> Fast-path: {detect_fast_path_query('Qual o abastecimento da UNE 101?')}\")\n    print(f\"Query: 'Calcular MC do produto X' -> Fast-path: {detect_fast_path_query('Calcular MC do produto X')}\")\n    print(f\"Query: 'Validar transfer\u00eancia de 10 unidades' -> Fast-path: {detect_fast_path_query('Validar transfer\u00eancia de 10 unidades')}\")\n    print(f\"Query: 'Encontrar rupturas cr\u00edticas' -> Fast-path: {detect_fast_path_query('Encontrar rupturas cr\u00edticas')}\")\n\n    # Simple data retrieval\n    print(f\"Query: 'Mostre-me as \u00faltimas vendas' -> Fast-path: {detect_fast_path_query('Mostre-me as \u00faltimas vendas')}\")\n    print(f\"Query: 'Listar todos os produtos' -> Fast-path: {detect_fast_path_query('Listar todos os produtos')}\")\n\n    # Non-fast-path queries\n    print(f\"Query: 'Qual a correla\u00e7\u00e3o entre vendas e marketing?' -> Fast-path: {detect_fast_path_query('Qual a correla\u00e7\u00e3o entre vendas e marketing?')}\")\n    print(f\"Query: 'Quero um gr\u00e1fico complexo' -> Fast-path: {detect_fast_path_query('Quero um gr\u00e1fico complexo')}\")\n\n    print(\"\\nFast-path detection tests completed.\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3540, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "66c84286-d684-4570-a1a4-90b93392e8c9": {"__data__": {"id_": "66c84286-d684-4570-a1a4-90b93392e8c9", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\field_mapper.py", "language": "python", "lines": 125, "filename": "field_mapper.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6aa7835c-ff39-4440-a414-2c1e18f53662", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\field_mapper.py", "language": "python", "lines": 125, "filename": "field_mapper.py"}, "hash": "c0f68c536e0fe0a1bcafe00590d8ba71dc04c071982ea2f538d4fc01c3cffc14", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "dc845597-b1c6-428c-92d9-279e6c8fac92", "node_type": "1", "metadata": {}, "hash": "5d7469424ed392b71c40e5705f7af67342d756b12f4d904f4eb26b0babe7daea", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/utils/field_mapper.py\n\nimport json\nfrom typing import Any, Dict, List, Optional\n\nclass FieldMapper:\n    \"\"\"\n    Maps natural language terms to actual database field names using a catalog.\n    Also provides known fields for agents.\n    \"\"\"\n    def __init__(self, catalog_path: str = \"data/catalog_focused.json\"):\n        self.catalog_path = catalog_path\n        self.catalog = self._load_catalog(catalog_path)\n        self.reverse_catalog = {v: k for k, v in self.catalog.items()} # For mapping back if needed\n\n    def _load_catalog(self, catalog_path: str) -> Dict[str, Any]:\n        \"\"\"\n        Loads the catalog from a JSON file.\n        Placeholder implementation. In a real scenario, this would load a dynamic catalog.\n        \"\"\"\n        try:\n            with open(catalog_path, 'r', encoding='utf-8') as f:\n                # Assuming the catalog file has a structure that maps natural language\n                # terms to their corresponding database/parquet field names.\n                # Example: {\"unidade de negocio\": \"une_id\", \"produto\": \"produto_id\"}\n                data = json.load(f)\n                # Flatten or process the loaded data as needed\n                # For now, a simple direct mapping from a flat dict is assumed.\n                if isinstance(data, dict):\n                    # Simple example: if catalog is a direct mapping\n                    return {k.lower(): v for k, v in data.items()}\n                else:\n                    print(f\"Warning: Catalog file {catalog_path} has unexpected structure. Using default placeholder catalog.\")\n                    return self._get_default_placeholder_catalog()\n        except FileNotFoundError:\n            print(f\"Warning: Catalog file {catalog_path} not found. Using default placeholder catalog.\")\n            return self._get_default_placeholder_catalog()\n        except json.JSONDecodeError:\n            print(f\"Warning: Error decoding JSON from {catalog_path}. Using default placeholder catalog.\")\n            return self._get_default_placeholder_catalog()\n\n    def _get_default_placeholder_catalog(self) -> Dict[str, str]:\n        \"\"\"Default catalog if file not found or invalid.\"\"\"\n        return {\n            \"unidade de negocio\": \"une_id\",\n            \"produto\": \"produto_id\",\n            \"segmento de mercado\": \"segmento\",\n            \"margem de contribuicao\": \"media_considerada_lv\", # Example mapping\n            \"estoque\": \"estoque_origem\",\n            \"linha verde\": \"linha_verde\",\n            \"vendas diarias\": \"vendas_diarias\",\n            \"transferencias pendentes\": \"transferencias_pendentes\",\n            \"id da une\": \"une_id\", # common variations\n            \"id do produto\": \"produto_id\"\n        }\n\n    def map_term(self, natural_language_term: str) -> Optional[str]:\n        \"\"\"\n        Maps a natural language term to its corresponding database field name.\n        Performs a case-insensitive lookup.\n        \"\"\"\n        if not isinstance(natural_language_term, str):\n            return None\n        return self.catalog.get(natural_language_term.lower(), natural_language_term)\n\n    def get_known_fields(self) -> List[str]:\n        \"\"\"\n        Returns a list of all known natural language terms in the catalog.\n        \"\"\"\n        return list(self.catalog.keys())\n\n    def get_db_fields(self) -> List[str]:\n        \"\"\"\n        Returns a list of all known database field names in the catalog.\n        \"\"\"\n        return list(set(self.catalog.values()))\n\n    def suggest_correction(self, invalid_term: str) -> Optional[str]:\n        \"\"\"\n        Suggests a correction for an invalid term based on similarity.\n        Placeholder for a more advanced fuzzy matching implementation.\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3707, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "dc845597-b1c6-428c-92d9-279e6c8fac92": {"__data__": {"id_": "dc845597-b1c6-428c-92d9-279e6c8fac92", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\field_mapper.py", "language": "python", "lines": 125, "filename": "field_mapper.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6aa7835c-ff39-4440-a414-2c1e18f53662", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\field_mapper.py", "language": "python", "lines": 125, "filename": "field_mapper.py"}, "hash": "c0f68c536e0fe0a1bcafe00590d8ba71dc04c071982ea2f538d4fc01c3cffc14", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "66c84286-d684-4570-a1a4-90b93392e8c9", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\field_mapper.py", "language": "python", "lines": 125, "filename": "field_mapper.py"}, "hash": "ea5e89212abf524cf142c7e0deffea3b9f1b62f7488df0d8e74243684dd3a56a", "class_name": "RelatedNodeInfo"}}, "text": "Performs a case-insensitive lookup.\n        \"\"\"\n        if not isinstance(natural_language_term, str):\n            return None\n        return self.catalog.get(natural_language_term.lower(), natural_language_term)\n\n    def get_known_fields(self) -> List[str]:\n        \"\"\"\n        Returns a list of all known natural language terms in the catalog.\n        \"\"\"\n        return list(self.catalog.keys())\n\n    def get_db_fields(self) -> List[str]:\n        \"\"\"\n        Returns a list of all known database field names in the catalog.\n        \"\"\"\n        return list(set(self.catalog.values()))\n\n    def suggest_correction(self, invalid_term: str) -> Optional[str]:\n        \"\"\"\n        Suggests a correction for an invalid term based on similarity.\n        Placeholder for a more advanced fuzzy matching implementation.\n        \"\"\"\n        # For now, a very simple suggestion (e.g., if it's close to a known field)\n        # Could use fuzzywuzzy or difflib for better matching\n        invalid_term_lower = invalid_term.lower()\n        for nl_term, db_field in self.catalog.items():\n            if invalid_term_lower in nl_term or nl_term in invalid_term_lower:\n                return nl_term # Return the natural language term as a suggestion\n        return None\n\nif __name__ == '__main__':\n    # Create a dummy catalog_focused.json for testing\n    dummy_catalog_path = \"data/catalog_focused.json\"\n    dummy_catalog_content = {\n        \"unidade de negocio\": \"une_id\",\n        \"produto\": \"produto_id\",\n        \"segmento\": \"segmento\",\n        \"quantidade estoque\": \"estoque_origem\"\n    }\n    # Ensure 'data' directory exists for this test\n    import os\n    if not os.path.exists(\"data\"):\n        os.makedirs(\"data\")\n    with open(dummy_catalog_path, 'w', encoding='utf-8') as f:\n        json.dump(dummy_catalog_content, f, indent=4)\n\n    print(\"--- Testing FieldMapper ---\")\n    mapper = FieldMapper()\n    \n    print(f\"Map 'Unidade de Negocio': {mapper.map_term('Unidade de Negocio')}\")\n    print(f\"Map 'PRODUTO': {mapper.map_term('PRODUTO')}\")\n    print(f\"Map 'segmento': {mapper.map_term('segmento')}\")\n    print(f\"Map 'quantidade em estoque': {mapper.map_term('quantidade em estoque')}\") # Should map to estoque_origem if it recognizes a close match\n\n    print(f\"Known fields: {mapper.get_known_fields()}\")\n    print(f\"DB fields: {mapper.get_db_fields()}\")\n\n    print(f\"Suggest for 'unidade': {mapper.suggest_correction('unidade')}\")\n    print(f\"Suggest for 'produt': {mapper.suggest_correction('produt')}\")\n    print(f\"Suggest for 'non_existent_field': {mapper.suggest_correction('non_existent_field')}\")\n\n    # Clean up dummy file\n    os.remove(dummy_catalog_path)\n    print(f\"Cleaned up dummy catalog: {dummy_catalog_path}\")", "mimetype": "text/plain", "start_char_idx": 2884, "end_char_idx": 5604, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f5ff53c9-cfab-4e96-8447-22f1155b0b72": {"__data__": {"id_": "f5ff53c9-cfab-4e96-8447-22f1155b0b72", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\query_history.py", "language": "python", "lines": 179, "filename": "query_history.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2fc296be-32a3-4c53-b5c2-39397423556f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\query_history.py", "language": "python", "lines": 179, "filename": "query_history.py"}, "hash": "9bf3bd80044dd149460117ff003080a21f44651019185ff962302fefef52d7bd", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c2cea6f4-27cf-47eb-83a1-fcec31bf95bd", "node_type": "1", "metadata": {}, "hash": "54e6f2a310c63235571351f569c847cf5ae3dce19ef61bb7bd59f073a2175643", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/utils/query_history.py\n\nimport json\nimport os\nfrom datetime import datetime\nfrom typing import Any, Dict, List, Optional\n\nclass QueryHistory:\n    \"\"\"\n    Manages user query history, persisting it to daily JSONL files.\n    Allows for searching and filtering of past queries.\n    (T1.3.3 from TASK_LIST)\n    \"\"\"\n    def __init__(self, history_dir: str = \"data/query_history\"):\n        self.history_dir = history_dir\n        os.makedirs(self.history_dir, exist_ok=True)\n        print(f\"QueryHistory initialized in {self.history_dir}\")\n\n    def _get_daily_file_path(self, date: Optional[datetime] = None) -> str:\n        \"\"\"Generates the file path for a given day.\"\"\"\n        if date is None:\n            date = datetime.now()\n        date_str = date.strftime(\"%Y-%m-%d\")\n        return os.path.join(self.history_dir, f\"queries_{date_str}.jsonl\")\n\n    def add_query(self, user_id: str, query: str, response: Dict[str, Any], timestamp: Optional[datetime] = None):\n        \"\"\"\n        Adds a new query entry to the daily history file.\n        \"\"\"\n        if timestamp is None:\n            timestamp = datetime.now()\n        \n        entry = {\n            \"timestamp\": timestamp.isoformat(),\n            \"user_id\": user_id,\n            \"query\": query,\n            \"response_summary\": self._summarize_response(response), # Store a summary, not full response\n            \"full_response_hash\": self._hash_response(response) # Hash of full response for integrity/lookup\n        }\n        file_path = self._get_daily_file_path(timestamp)\n        \n        try:\n            with open(file_path, \"a\", encoding=\"utf-8\") as f:\n                f.write(json.dumps(entry, ensure_ascii=False) + \"\\n\")\n            print(f\"Query added to history for user {user_id}.\")\n        except OSError as e:\n            print(f\"Error writing query history file {file_path}: {e}\")\n\n    def _summarize_response(self, response: Dict[str, Any]) -> str:\n        \"\"\"Creates a brief summary of the response for history logging.\"\"\"\n        if \"type\" in response:\n            if response[\"type\"] == \"text\" and \"text\" in response:\n                return response[\"text\"][:100] + (\"...\" if len(response[\"text\"]) > 100 else \"\")\n            if response[\"type\"] == \"tool_result\" and \"tool_name\" in response:\n                return f\"Tool result from {response['tool_name']}\"\n            if response[\"type\"] == \"code_result\" and \"result\" in response:\n                return \"Code execution result.\"\n        return json.dumps(response)[:100] + (\"...\" if len(json.dumps(response)) > 100 else \"\")\n\n    def _hash_response(self, response: Dict[str, Any]) -> str:\n        \"\"\"Generates a hash of the full response for later integrity checks or matching.\"\"\"\n        import hashlib\n        return hashlib.sha256(json.dumps(response, sort_keys=True).encode(\"utf-8\")).hexdigest()\n\n    def get_history(self, user_id: Optional[str] = None, start_date: Optional[datetime] = None, end_date: Optional[datetime] = None, limit: int = 100) -> List[Dict[str, Any]]:\n        \"\"\"\n        Retrieves query history for a user, within a date range, with an optional limit.\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3128, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c2cea6f4-27cf-47eb-83a1-fcec31bf95bd": {"__data__": {"id_": "c2cea6f4-27cf-47eb-83a1-fcec31bf95bd", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\query_history.py", "language": "python", "lines": 179, "filename": "query_history.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2fc296be-32a3-4c53-b5c2-39397423556f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\query_history.py", "language": "python", "lines": 179, "filename": "query_history.py"}, "hash": "9bf3bd80044dd149460117ff003080a21f44651019185ff962302fefef52d7bd", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "f5ff53c9-cfab-4e96-8447-22f1155b0b72", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\query_history.py", "language": "python", "lines": 179, "filename": "query_history.py"}, "hash": "1485ed09ab5c4b6734509d105d1e35e0f368b2cb1657d6298efc8736543fc33a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3e59af38-1f60-46fd-9b00-dd90735f14fe", "node_type": "1", "metadata": {}, "hash": "f4ec7008224235ed4e1b243d30aa779381e44efecfa789922a0142b286b3e3fc", "class_name": "RelatedNodeInfo"}}, "text": "return json.dumps(response)[:100] + (\"...\" if len(json.dumps(response)) > 100 else \"\")\n\n    def _hash_response(self, response: Dict[str, Any]) -> str:\n        \"\"\"Generates a hash of the full response for later integrity checks or matching.\"\"\"\n        import hashlib\n        return hashlib.sha256(json.dumps(response, sort_keys=True).encode(\"utf-8\")).hexdigest()\n\n    def get_history(self, user_id: Optional[str] = None, start_date: Optional[datetime] = None, end_date: Optional[datetime] = None, limit: int = 100) -> List[Dict[str, Any]]:\n        \"\"\"\n        Retrieves query history for a user, within a date range, with an optional limit.\n        \"\"\"\n        history_records: List[Dict[str, Any]] = []\n\n        # Use reasonable defaults instead of datetime.min/max to avoid Windows issues\n        if start_date is None:\n            start_date = datetime(2020, 1, 1)  # Reasonable past date\n        if end_date is None:\n            end_date = datetime(2099, 12, 31)  # Reasonable future date\n\n        # Create date ranges with safe boundaries\n        end_date_upper = end_date.replace(hour=23, minute=59, second=59, microsecond=999999)\n        start_date_lower = start_date.replace(hour=0, minute=0, second=0, microsecond=0)\n\n        # Iterate through history files (simple scan, can be optimized with file naming convention)\n        for filename in sorted(os.listdir(self.history_dir), reverse=True): # Newest files first\n            if filename.startswith(\"queries_\") and filename.endswith(\".jsonl\"):\n                file_date_str = filename[8:18] # YYYY-MM-DD\n                try:\n                    file_date = datetime.strptime(file_date_str, \"%Y-%m-%d\")\n                except ValueError:\n                    continue  # Skip invalid filenames\n\n                if file_date > end_date_upper:\n                    continue\n                if file_date < start_date_lower:\n                    break # Assuming files are sorted, we can stop early\n\n                file_path = os.path.join(self.history_dir, filename)\n                try:\n                    with open(file_path, \"r\", encoding=\"utf-8\") as f:\n                        for line in f:\n                            try:\n                                entry = json.loads(line)\n                                entry_timestamp = datetime.fromisoformat(entry[\"timestamp\"])\n\n                                if start_date <= entry_timestamp <= end_date:\n                                    if user_id is None or entry.get(\"user_id\") == user_id:\n                                        history_records.append(entry)\n                                        if len(history_records) >= limit:\n                                            return history_records # Return early if limit reached\n                            except json.JSONDecodeError:\n                                print(f\"Warning: Corrupt JSON line in {filename}: {line.strip()}\")\n                except OSError as e:\n                    print(f\"Error reading history file {file_path}: {e}\")\n        \n        return history_records[:limit]\n\n    def search_queries(self, user_id: Optional[str] = None, keyword: str = \"\", limit: int = 100) -> List[Dict[str, Any]]:\n        \"\"\"\n        Searches query history for entries containing a specific keyword.\n        \"\"\"\n        matching_records: List[Dict[str, Any]] = []\n        all_records = self.get_history(user_id=user_id, limit=None) # Get all relevant history first\n\n        keyword_lower = keyword.lower()\n        for entry in all_records:\n            if keyword_lower in entry.get(\"query\", \"\").lower() or \\\n               keyword_lower in entry.get(\"response_summary\", \"\").lower():\n                matching_records.append(entry)\n                if len(matching_records) >= limit:\n                    break\n        return matching_records\n\n# Example usage\nif __name__ == '__main__':\n    from app.config.settings import Settings\n    temp_settings = Settings()\n\n    # Ensure history directory exists for testing\n    os.makedirs(temp_settings.LEARNING_EXAMPLES_PATH, exist_ok=True) # Using LEARNING_EXAMPLES_PATH as temp history dir\n\n    history = QueryHistory(history_dir=temp_settings.LEARNING_EXAMPLES_PATH)\n\n    user1_id = \"test_user_1\"\n    user2_id = \"test_user_2\"\n\n    # Add some queries\n    history.add_query(user1_id, \"Vendas totais do produto A?\", {\"type\": \"text\", \"text\": \"Total de vendas: 100\"})\n    history.add_query(user1_id, \"Gr\u00e1fico de vendas por regi\u00e3o?\", {\"type\": \"chart\", \"chart_spec\": {\"data\": []}})\n    history.add_query(user2_id, \"Qual o estoque atual?\", {\"type\": \"text\", \"text\": \"Estoque: 500\"})\n    history.add_query(user1_id, \"Top 5 produtos?", "mimetype": "text/plain", "start_char_idx": 2477, "end_char_idx": 7110, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3e59af38-1f60-46fd-9b00-dd90735f14fe": {"__data__": {"id_": "3e59af38-1f60-46fd-9b00-dd90735f14fe", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\query_history.py", "language": "python", "lines": 179, "filename": "query_history.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2fc296be-32a3-4c53-b5c2-39397423556f", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\query_history.py", "language": "python", "lines": 179, "filename": "query_history.py"}, "hash": "9bf3bd80044dd149460117ff003080a21f44651019185ff962302fefef52d7bd", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c2cea6f4-27cf-47eb-83a1-fcec31bf95bd", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\query_history.py", "language": "python", "lines": 179, "filename": "query_history.py"}, "hash": "8a01a2641b4e6dc37a5a8330dbd6361152451f0eb0cdd2bd2d4fb02cb1e50783", "class_name": "RelatedNodeInfo"}}, "text": "\", {\"type\": \"text\", \"text\": \"Total de vendas: 100\"})\n    history.add_query(user1_id, \"Gr\u00e1fico de vendas por regi\u00e3o?\", {\"type\": \"chart\", \"chart_spec\": {\"data\": []}})\n    history.add_query(user2_id, \"Qual o estoque atual?\", {\"type\": \"text\", \"text\": \"Estoque: 500\"})\n    history.add_query(user1_id, \"Top 5 produtos?\", {\"type\": \"code_result\", \"result\": [{\"prod\": \"X\", \"val\": 50}]}\n)\n\n    print(\"\\n--- Testing get_history ---\")\n    all_history = history.get_history()\n    print(f\"All history ({len(all_history)} records):\")\n    for entry in all_history:\n        print(f\"  [{entry['timestamp']}] User {entry['user_id']}: {entry['query']} -> {entry['response_summary']}\")\n\n    user1_history = history.get_history(user_id=user1_id)\n    print(f\"\\nUser 1 history ({len(user1_history)} records):\")\n    for entry in user1_history:\n        print(f\"  [{entry['timestamp']}] User {entry['user_id']}: {entry['query']} -> {entry['response_summary']}\")\n\n    print(\"\\n--- Testing search_queries ---\")\n    search_results = history.search_queries(keyword=\"vendas\")\n    print(f\"Search 'vendas' ({len(search_results)} records):\")\n    for entry in search_results:\n        print(f\"  [{entry['timestamp']}] User {entry['user_id']}: {entry['query']} -> {entry['response_summary']}\")\n\n    search_user1_chart = history.search_queries(user_id=user1_id, keyword=\"gr\u00e1fico\")\n    print(f\"\\nSearch 'gr\u00e1fico' for User 1 ({len(search_user1_chart)} records):\")\n    for entry in search_user1_chart:\n        print(f\"  [{entry['timestamp']}] User {entry['user_id']}: {entry['query']} -> {entry['response_summary']}\")\n\n    # Clean up dummy files\n    for filename in os.listdir(temp_settings.LEARNING_EXAMPLES_PATH):\n        if filename.startswith(\"queries_\"):\n            os.remove(os.path.join(temp_settings.LEARNING_EXAMPLES_PATH, filename))\n    print(\"\\nCleaned up dummy history files.\")\n    print(\"\\nQueryHistory tests passed!\")", "mimetype": "text/plain", "start_char_idx": 6798, "end_char_idx": 8688, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5dc10106-0a8b-4123-8bbb-b8654d935765": {"__data__": {"id_": "5dc10106-0a8b-4123-8bbb-b8654d935765", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "935ac8d6-1523-4919-90ec-9902cbeaf7b6", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "hash": "d6364761163781151dfd8dd2bea12ac65b938d93185c339bf477fd2b75dccfbb", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "fd8538cc-76ef-4e3a-a400-5c9bb566d341", "node_type": "1", "metadata": {}, "hash": "d6f7abf6ab57dc64ddf0d2e7fd68000848f54a6882dae2066dd63dd782ba411b", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nQuery Validator - Validador de queries Parquet.\n\nEste m\u00f3dulo fornece valida\u00e7\u00e3o robusta de queries antes da execu\u00e7\u00e3o,\nincluindo verifica\u00e7\u00e3o de colunas, tipos e timeout.\n\nFuncionalidades:\n- Valida\u00e7\u00e3o de colunas antes de filtrar\n- Tratamento de valores None/null\n- Timeout para queries longas\n- Mensagens de erro user-friendly\n\nAutor: Code Agent\nData: 2025-10-17\n\"\"\"\n\nimport logging\nimport signal\nfrom typing import List, Dict, Any, Optional, Callable\nfrom contextlib import contextmanager\nimport pandas as pd\n\nlogger = logging.getLogger(__name__)\n\n\nclass QueryTimeout(Exception):\n    \"\"\"Exce\u00e7\u00e3o levantada quando query excede timeout.\"\"\"\n    pass\n\n\nclass QueryValidator:\n    \"\"\"\n    Validador de queries com timeout e verifica\u00e7\u00e3o de integridade.\n    \"\"\"\n\n    def __init__(self, default_timeout: int = 30):\n        \"\"\"\n        Inicializa o validador.\n\n        Args:\n            default_timeout: Timeout padr\u00e3o em segundos\n        \"\"\"\n        self.default_timeout = default_timeout\n\n    @contextmanager\n    def timeout_context(self, seconds: int):\n        \"\"\"\n        Context manager para timeout de queries.\n\n        Args:\n            seconds: Tempo m\u00e1ximo de execu\u00e7\u00e3o em segundos\n\n        Raises:\n            QueryTimeout: Se a query exceder o tempo limite\n        \"\"\"\n        def timeout_handler(signum, frame):\n            raise QueryTimeout(f\"Query excedeu o tempo limite de {seconds} segundos\")\n\n        # Configurar handler (apenas em sistemas Unix-like)\n        try:\n            old_handler = signal.signal(signal.SIGALRM, timeout_handler)\n            signal.alarm(seconds)\n            try:\n                yield\n            finally:\n                signal.alarm(0)\n                signal.signal(signal.SIGALRM, old_handler)\n        except AttributeError:\n            # Windows n\u00e3o suporta SIGALRM, executar sem timeout\n            logger.warning(\"Timeout n\u00e3o suportado nesta plataforma\")\n            yield\n\n    def validate_columns_in_dataframe(\n        self,\n        df: pd.DataFrame,\n        required_columns: List[str],\n        table_name: str = \"DataFrame\"\n    ) -> tuple[bool, List[str]]:\n        \"\"\"\n        Valida se colunas existem no DataFrame.\n\n        Args:\n            df: DataFrame a validar\n            required_columns: Lista de colunas obrigat\u00f3rias\n            table_name: Nome da tabela (para mensagens de erro)\n\n        Returns:\n            Tupla (is_valid, missing_columns)\n        \"\"\"\n        df_columns = set(df.columns)\n        required_set = set(required_columns)\n\n        missing_columns = list(required_set - df_columns)\n\n        if missing_columns:\n            logger.error(\n                f\"Valida\u00e7\u00e3o falhou para '{table_name}': \"\n                f\"Colunas faltantes: {missing_columns}\"\n            )\n            return False, missing_columns\n\n        logger.debug(f\"Todas as colunas obrigat\u00f3rias presentes em '{table_name}'\")\n        return True, []\n\n    def validate_filter_column(\n        self,\n        df: pd.DataFrame,\n        column_name: str,\n        table_name: str = \"DataFrame\"\n    ) -> bool:\n        \"\"\"\n        Valida se uma coluna existe antes de aplicar filtro.\n\n        Args:\n            df: DataFrame\n            column_name: Nome da coluna\n            table_name: Nome da tabela\n\n        Returns:\n            True se a coluna existe\n        \"\"\"\n        if column_name not in df.columns:\n            logger.error(\n                f\"Coluna '{column_name}' n\u00e3o encontrada em '{table_name}'. \"\n                f\"Colunas dispon\u00edveis: {list(df.columns)}\"\n            )\n            return False\n\n        return True\n\n    def handle_null_values(\n        self,\n        df: pd.DataFrame,\n        column_name: str,\n        strategy: str = \"drop\",\n        fill_value: Any = None\n    ) -> pd.DataFrame:\n        \"\"\"\n        Trata valores nulos em uma coluna.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3797, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "fd8538cc-76ef-4e3a-a400-5c9bb566d341": {"__data__": {"id_": "fd8538cc-76ef-4e3a-a400-5c9bb566d341", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "935ac8d6-1523-4919-90ec-9902cbeaf7b6", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "hash": "d6364761163781151dfd8dd2bea12ac65b938d93185c339bf477fd2b75dccfbb", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "5dc10106-0a8b-4123-8bbb-b8654d935765", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "hash": "68843e8e2edc0542dcbeb9887763b464f0675e818a7dc049b6f95122ba1aa0a7", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "22da6b71-621e-4217-8a47-806f03c4a510", "node_type": "1", "metadata": {}, "hash": "bd1d9b50030dc76bc57e7c30de6efcf315ea32caf2edd122232302666954631e", "class_name": "RelatedNodeInfo"}}, "text": "Args:\n            df: DataFrame\n            column_name: Nome da coluna\n            table_name: Nome da tabela\n\n        Returns:\n            True se a coluna existe\n        \"\"\"\n        if column_name not in df.columns:\n            logger.error(\n                f\"Coluna '{column_name}' n\u00e3o encontrada em '{table_name}'. \"\n                f\"Colunas dispon\u00edveis: {list(df.columns)}\"\n            )\n            return False\n\n        return True\n\n    def handle_null_values(\n        self,\n        df: pd.DataFrame,\n        column_name: str,\n        strategy: str = \"drop\",\n        fill_value: Any = None\n    ) -> pd.DataFrame:\n        \"\"\"\n        Trata valores nulos em uma coluna.\n\n        Args:\n            df: DataFrame\n            column_name: Nome da coluna\n            strategy: Estrat\u00e9gia ('drop', 'fill', 'keep')\n            fill_value: Valor para preencher (se strategy='fill')\n\n        Returns:\n            DataFrame com valores nulos tratados\n        \"\"\"\n        if column_name not in df.columns:\n            logger.warning(f\"Coluna '{column_name}' n\u00e3o encontrada, retornando DataFrame original\")\n            return df\n\n        null_count = df[column_name].isna().sum()\n\n        if null_count > 0:\n            logger.info(f\"Encontrados {null_count} valores nulos em '{column_name}'\")\n\n            if strategy == \"drop\":\n                df = df.dropna(subset=[column_name])\n                logger.info(f\"Removidas {null_count} linhas com valores nulos\")\n\n            elif strategy == \"fill\":\n                if fill_value is None:\n                    # Estrat\u00e9gia padr\u00e3o baseada no tipo\n                    if df[column_name].dtype in ['float64', 'int64']:\n                        fill_value = 0\n                    else:\n                        fill_value = \"\"\n\n                df[column_name].fillna(fill_value, inplace=True)\n                logger.info(f\"Preenchidos {null_count} valores nulos com '{fill_value}'\")\n\n            elif strategy == \"keep\":\n                logger.info(f\"Mantendo {null_count} valores nulos\")\n\n        return df\n\n    def safe_filter(\n        self,\n        df: pd.DataFrame,\n        filter_func: Callable[[pd.DataFrame], pd.DataFrame],\n        error_message: str = \"Erro ao aplicar filtro\"\n    ) -> pd.DataFrame:\n        \"\"\"\n        Aplica filtro de forma segura com tratamento de erros.\n\n        Args:\n            df: DataFrame\n            filter_func: Fun\u00e7\u00e3o de filtro\n            error_message: Mensagem de erro personalizada\n\n        Returns:\n            DataFrame filtrado ou original em caso de erro\n        \"\"\"\n        try:\n            return filter_func(df)\n        except KeyError as e:\n            logger.error(f\"{error_message}: Coluna n\u00e3o encontrada - {e}\")\n            return df\n        except Exception as e:\n            logger.error(f\"{error_message}: {e}\")\n            return df\n\n    def execute_with_timeout(\n        self,\n        func: Callable,\n        timeout: Optional[int] = None,\n        *args,\n        **kwargs\n    ) -> Any:\n        \"\"\"\n        Executa fun\u00e7\u00e3o com timeout.\n\n        Args:\n            func: Fun\u00e7\u00e3o a executar\n            timeout: Tempo limite em segundos (usa default se None)\n            *args: Argumentos posicionais\n            **kwargs: Argumentos nomeados\n\n        Returns:\n            Resultado da fun\u00e7\u00e3o\n\n        Raises:\n            QueryTimeout: Se exceder o tempo limite\n        \"\"\"\n        if timeout is None:\n            timeout = self.default_timeout\n\n        try:\n            with self.timeout_context(timeout):\n                return func(*args, **kwargs)\n        except QueryTimeout as e:\n            logger.error(f\"Query timeout: {e}\")\n            raise\n\n    def validate_and_convert_types(\n        self,\n        df: pd.DataFrame,\n        column_types: Dict[str, str]\n    ) -> pd.DataFrame:\n        \"\"\"\n        Valida e converte tipos de colunas.", "mimetype": "text/plain", "start_char_idx": 3121, "end_char_idx": 6957, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "22da6b71-621e-4217-8a47-806f03c4a510": {"__data__": {"id_": "22da6b71-621e-4217-8a47-806f03c4a510", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "935ac8d6-1523-4919-90ec-9902cbeaf7b6", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "hash": "d6364761163781151dfd8dd2bea12ac65b938d93185c339bf477fd2b75dccfbb", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "fd8538cc-76ef-4e3a-a400-5c9bb566d341", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "hash": "1a888f48b6d0f038b59218868af3491e7e9f35cacc2d9ecf71f9167d304a4f03", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "004ccd63-afda-43bc-b998-5203a63edf27", "node_type": "1", "metadata": {}, "hash": "ff9607ee27602bbf724e56076cd55da53c7188e2e25fb0458af2a81a16874936", "class_name": "RelatedNodeInfo"}}, "text": "Args:\n            func: Fun\u00e7\u00e3o a executar\n            timeout: Tempo limite em segundos (usa default se None)\n            *args: Argumentos posicionais\n            **kwargs: Argumentos nomeados\n\n        Returns:\n            Resultado da fun\u00e7\u00e3o\n\n        Raises:\n            QueryTimeout: Se exceder o tempo limite\n        \"\"\"\n        if timeout is None:\n            timeout = self.default_timeout\n\n        try:\n            with self.timeout_context(timeout):\n                return func(*args, **kwargs)\n        except QueryTimeout as e:\n            logger.error(f\"Query timeout: {e}\")\n            raise\n\n    def validate_and_convert_types(\n        self,\n        df: pd.DataFrame,\n        column_types: Dict[str, str]\n    ) -> pd.DataFrame:\n        \"\"\"\n        Valida e converte tipos de colunas.\n\n        Args:\n            df: DataFrame\n            column_types: Dict {column_name: desired_type}\n                Tipos suportados: 'int', 'float', 'str', 'datetime'\n\n        Returns:\n            DataFrame com tipos convertidos\n        \"\"\"\n        df_copy = df.copy()\n\n        for column, desired_type in column_types.items():\n            if column not in df_copy.columns:\n                logger.warning(f\"Coluna '{column}' n\u00e3o encontrada para convers\u00e3o de tipo\")\n                continue\n\n            try:\n                if desired_type == 'int':\n                    df_copy[column] = pd.to_numeric(df_copy[column], errors='coerce').fillna(0).astype(int)\n\n                elif desired_type == 'float':\n                    df_copy[column] = pd.to_numeric(df_copy[column], errors='coerce').fillna(0.0)\n\n                elif desired_type == 'str':\n                    df_copy[column] = df_copy[column].astype(str).replace('nan', '')\n\n                elif desired_type == 'datetime':\n                    df_copy[column] = pd.to_datetime(df_copy[column], errors='coerce')\n\n                else:\n                    logger.warning(f\"Tipo desconhecido '{desired_type}' para coluna '{column}'\")\n\n                logger.debug(f\"Coluna '{column}' convertida para '{desired_type}'\")\n\n            except Exception as e:\n                logger.error(f\"Erro ao converter coluna '{column}' para '{desired_type}': {e}\")\n\n        return df_copy\n\n    def get_user_friendly_error(self, error: Exception) -> str:\n        \"\"\"\n        Converte exce\u00e7\u00e3o em mensagem user-friendly.\n\n        Args:\n            error: Exce\u00e7\u00e3o capturada\n\n        Returns:\n            Mensagem de erro formatada para o usu\u00e1rio\n        \"\"\"\n        error_type = type(error).__name__\n\n        # Mapeamento de erros t\u00e9cnicos para mensagens amig\u00e1veis\n        error_messages = {\n            'FileNotFoundError': 'Arquivo de dados n\u00e3o encontrado. Verifique se os dados foram carregados corretamente.',\n            'PermissionError': 'Sem permiss\u00e3o para acessar o arquivo de dados.',\n            'KeyError': 'Coluna especificada n\u00e3o existe nos dados. Verifique os nomes das colunas.',\n            'ValueError': 'Valor inv\u00e1lido encontrado nos dados. Verifique os filtros aplicados.',\n            'TypeError': 'Tipo de dado incompat\u00edvel na opera\u00e7\u00e3o.',\n            'QueryTimeout': 'A consulta demorou muito tempo. Tente usar filtros mais espec\u00edficos.',\n            'ParserError': 'Erro ao ler o arquivo de dados. O arquivo pode estar corrompido.',\n            'MemoryError': 'Mem\u00f3ria insuficiente para processar a consulta. Reduza o volume de dados.',\n        }\n\n        # Retornar mensagem personalizada ou gen\u00e9rica\n        base_message = error_messages.get(error_type, 'Erro ao processar a consulta.')\n\n        return f\"{base_message} (Detalhes t\u00e9cnicos: {str(error)})\"\n\n\n# Inst\u00e2ncia global\n_validator = QueryValidator()\n\n\ndef safe_convert_types(df: pd.DataFrame, column_types: Dict[str, str]) -> pd.DataFrame:\n    \"\"\"Compat shim: nome legado esperado por alguns testes/scripts.\n\n    Encaminha para `validate_and_convert_types` do `QueryValidator`.\n    \"\"\"\n    return _validator.validate_and_convert_types(df, column_types)\n\n# Fun\u00e7\u00f5es auxiliares para uso direto\ndef validate_columns(df: pd.DataFrame, required_columns: List[str], table_name: str = \"DataFrame\") -> tuple[bool, List[str]]:\n    \"\"\"Valida colunas em DataFrame.\"\"\"\n    return _validator.validate_columns_in_dataframe(df, required_columns, table_name)\n\n\ndef handle_nulls(df: pd.DataFrame, column: str, strategy: str = \"drop\", fill_value: Any = None) -> pd.DataFrame:\n    \"\"\"Trata valores nulos.\"\"\"\n    return _validator.handle_null_values(df, column, strategy, fill_value)", "mimetype": "text/plain", "start_char_idx": 6162, "end_char_idx": 10640, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "004ccd63-afda-43bc-b998-5203a63edf27": {"__data__": {"id_": "004ccd63-afda-43bc-b998-5203a63edf27", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "935ac8d6-1523-4919-90ec-9902cbeaf7b6", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "hash": "d6364761163781151dfd8dd2bea12ac65b938d93185c339bf477fd2b75dccfbb", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "22da6b71-621e-4217-8a47-806f03c4a510", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}, "hash": "a4a765015a8501095ec0a62207b36fd765f1b0eb806ff3897c6aa4c44605de04", "class_name": "RelatedNodeInfo"}}, "text": "def safe_convert_types(df: pd.DataFrame, column_types: Dict[str, str]) -> pd.DataFrame:\n    \"\"\"Compat shim: nome legado esperado por alguns testes/scripts.\n\n    Encaminha para `validate_and_convert_types` do `QueryValidator`.\n    \"\"\"\n    return _validator.validate_and_convert_types(df, column_types)\n\n# Fun\u00e7\u00f5es auxiliares para uso direto\ndef validate_columns(df: pd.DataFrame, required_columns: List[str], table_name: str = \"DataFrame\") -> tuple[bool, List[str]]:\n    \"\"\"Valida colunas em DataFrame.\"\"\"\n    return _validator.validate_columns_in_dataframe(df, required_columns, table_name)\n\n\ndef handle_nulls(df: pd.DataFrame, column: str, strategy: str = \"drop\", fill_value: Any = None) -> pd.DataFrame:\n    \"\"\"Trata valores nulos.\"\"\"\n    return _validator.handle_null_values(df, column, strategy, fill_value)\n\n\ndef safe_filter(df: pd.DataFrame, filter_func: Callable, error_msg: str = \"Erro ao filtrar\") -> pd.DataFrame:\n    \"\"\"Aplica filtro com seguran\u00e7a.\"\"\"\n    return _validator.safe_filter(df, filter_func, error_msg)\n\n\ndef get_friendly_error(error: Exception) -> str:\n    \"\"\"Converte erro em mensagem amig\u00e1vel.\"\"\"\n    return _validator.get_user_friendly_error(error)\n\n\nif __name__ == \"__main__\":\n    # Testes b\u00e1sicos\n    logging.basicConfig(level=logging.INFO)\n\n    # Teste de valida\u00e7\u00e3o de colunas\n    df_test = pd.DataFrame({\n        'col1': [1, 2, 3],\n        'col2': ['a', 'b', 'c']\n    })\n\n    is_valid, missing = validate_columns(df_test, ['col1', 'col2', 'col3'])\n    print(f\"Valida\u00e7\u00e3o: {is_valid}, Faltantes: {missing}\")\n\n    # Teste de tratamento de nulos\n    df_test['col3'] = [1, None, 3]\n    df_clean = handle_nulls(df_test, 'col3', strategy='fill', fill_value=0)\n    print(f\"Nulos tratados: {df_clean['col3'].tolist()}\")", "mimetype": "text/plain", "start_char_idx": 9830, "end_char_idx": 11569, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2ae11cb1-095f-4fcd-8138-6a952b249a1c": {"__data__": {"id_": "2ae11cb1-095f-4fcd-8138-6a952b249a1c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\response_cache.py", "language": "python", "lines": 158, "filename": "response_cache.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "10d73805-bb4f-40cc-9ba4-4e5389a4629d", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\response_cache.py", "language": "python", "lines": 158, "filename": "response_cache.py"}, "hash": "92fef61b67b4fef314ab67b24b4e1c92e6d10123d3fa5ab6d858d350d9dcfc7c", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "5aa76912-85fa-4943-9707-8a427a2db18c", "node_type": "1", "metadata": {}, "hash": "27b627bf322bc7d0521ce318e000821e8743f074c7c1bb89ab19c044abb65dbf", "class_name": "RelatedNodeInfo"}}, "text": "# backend/app/core/utils/response_cache.py\n\nimport json\nimport os\nimport hashlib\nfrom datetime import datetime, timedelta\nfrom typing import Any, Dict, Optional\n\nfrom app.config.settings import settings\nimport re\n\nclass ResponseCache:\n    \"\"\"\n    Manages caching of LLM responses on disk with a configurable TTL.\n    Normalizes queries for better cache hit rates.\n    \"\"\"\n    def __init__(self, cache_dir: str = \"data/cache\", ttl_minutes: int = settings.CACHE_TTL_MINUTES):\n        self.cache_dir = cache_dir\n        os.makedirs(self.cache_dir, exist_ok=True)\n        self.ttl = timedelta(minutes=ttl_minutes)\n        print(f\"ResponseCache initialized in {self.cache_dir} with TTL {self.ttl}\")\n\n    def _get_cache_file_path(self, key: str) -> str:\n        \"\"\"Generates a file path for a given cache key.\"\"\"\n        return os.path.join(self.cache_dir, f\"{key}.json\")\n\n    def generate_key(self, query: str) -> str:\n        \"\"\"\n        Generates a cache key by normalizing the query and hashing it.\n        This ensures consistent keys for similar queries.\n        \"\"\"\n        normalized_query = self._normalize_query(query)\n        return hashlib.sha256(normalized_query.encode(\"utf-8\")).hexdigest()\n\n    def _normalize_query(self, query: str) -> str:\n        \"\"\"\n        Normalizes a query string for caching purposes.\n        Removes stopwords, standardizes spaces, lowercases, removes irrelevant punctuation.\n        (T6.1.3 from TASK_LIST, but implemented here as it's directly related to cache key generation)\n        \"\"\"\n        query_lower = query.lower()\n        # Example stopwords (expand as needed)\n        stopwords = [\"o\", \"a\", \"os\", \"as\", \"um\", \"uma\", \"uns\", \"umas\", \"de\", \"da\", \"do\", \"dos\", \"das\", \"em\", \"no\", \"na\", \"nos\", \"nas\", \"que\", \"e\", \"\u00e9\", \"para\", \"com\", \"por\"]\n        words = [word for word in query_lower.split() if word not in stopwords]\n        \n        normalized = \" \".join(words)\n        normalized = re.sub(r'[^\\w\\s]', '', normalized) # Remove punctuation (keep alphanumeric and space)\n        normalized = re.sub(r'\\s+', ' ', normalized).strip() # Standardize spaces\n        return normalized\n\n    def get(self, key: str) -> Optional[Dict[str, Any]]:\n        \"\"\"\n        Retrieves a cached response if it exists and is not expired.\n        \"\"\"\n        file_path = self._get_cache_file_path(key)\n        if os.path.exists(file_path):\n            try:\n                with open(file_path, \"r\", encoding=\"utf-8\") as f:\n                    cached_data = json.load(f)\n                \n                cached_time_str = cached_data.get(\"timestamp\")\n                if cached_time_str:\n                    cached_time = datetime.fromisoformat(cached_time_str)\n                    if datetime.now() - cached_time < self.ttl:\n                        print(f\"Cache hit for key: {key}\")\n                        return cached_data.get(\"response\")\n                    else:\n                        print(f\"Cache expired for key: {key}. Deleting...\")\n                        os.remove(file_path) # Clean up expired cache\n                else:\n                    print(f\"Cache data for key: {key} missing timestamp. Deleting...\")\n                    os.remove(file_path) # Invalid cache entry\n            except (json.JSONDecodeError, OSError) as e:\n                print(f\"Error reading or decoding cache file {file_path}: {e}. Deleting...\")\n                if os.path.exists(file_path):\n                    os.remove(file_path)\n        return None\n\n    def set(self, key: str, response: Dict[str, Any]):\n        \"\"\"\n        Stores a response in the cache with a timestamp.\n        \"\"\"\n        file_path = self._get_cache_file_path(key)\n        data_to_cache = {\n            \"timestamp\": datetime.now().isoformat(),\n            \"response\": response\n        }\n        try:\n            with open(file_path, \"w\", encoding=\"utf-8\") as f:\n                json.dump(data_to_cache, f, ensure_ascii=False, indent=4)\n            print(f\"Cache set for key: {key}\")\n        except OSError as e:\n            print(f\"Error writing cache file {file_path}: {e}\")\n\n    def clean_expired_cache(self):\n        \"\"\"\n        Cleans up expired cache files (T1.3.1 - cache_cleaner).\n        This method will be called by a separate cache cleaner utility in production,\n        but can be manually triggered or run periodically.\n        \"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4334, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5aa76912-85fa-4943-9707-8a427a2db18c": {"__data__": {"id_": "5aa76912-85fa-4943-9707-8a427a2db18c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\response_cache.py", "language": "python", "lines": 158, "filename": "response_cache.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "10d73805-bb4f-40cc-9ba4-4e5389a4629d", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\response_cache.py", "language": "python", "lines": 158, "filename": "response_cache.py"}, "hash": "92fef61b67b4fef314ab67b24b4e1c92e6d10123d3fa5ab6d858d350d9dcfc7c", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2ae11cb1-095f-4fcd-8138-6a952b249a1c", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\response_cache.py", "language": "python", "lines": 158, "filename": "response_cache.py"}, "hash": "550bda7fd91b0217e03cfee11f9552c4aa3e6ad3f9dac8111b97327d09dcf8fc", "class_name": "RelatedNodeInfo"}}, "text": "file_path = self._get_cache_file_path(key)\n        data_to_cache = {\n            \"timestamp\": datetime.now().isoformat(),\n            \"response\": response\n        }\n        try:\n            with open(file_path, \"w\", encoding=\"utf-8\") as f:\n                json.dump(data_to_cache, f, ensure_ascii=False, indent=4)\n            print(f\"Cache set for key: {key}\")\n        except OSError as e:\n            print(f\"Error writing cache file {file_path}: {e}\")\n\n    def clean_expired_cache(self):\n        \"\"\"\n        Cleans up expired cache files (T1.3.1 - cache_cleaner).\n        This method will be called by a separate cache cleaner utility in production,\n        but can be manually triggered or run periodically.\n        \"\"\"\n        for filename in os.listdir(self.cache_dir):\n            file_path = os.path.join(self.cache_dir, filename)\n            if filename.endswith(\".json\") and os.path.isfile(file_path):\n                try:\n                    with open(file_path, \"r\", encoding=\"utf-8\") as f:\n                        cached_data = json.load(f)\n                    cached_time_str = cached_data.get(\"timestamp\")\n                    if cached_time_str:\n                        cached_time = datetime.fromisoformat(cached_time_str)\n                        if datetime.now() - cached_time >= self.ttl:\n                            os.remove(file_path)\n                            print(f\"Cleaned expired cache file: {filename}\")\n                    else:\n                        os.remove(file_path)\n                        print(f\"Cleaned invalid cache file (no timestamp): {filename}\")\n                except (json.JSONDecodeError, OSError) as e:\n                    print(f\"Error checking/cleaning cache file {file_path}: {e}. Removing.\")\n                    if os.path.exists(file_path):\n                        os.remove(file_path)\n\n# Example usage\nif __name__ == '__main__':\n    # Ensure cache directory exists for testing\n    os.makedirs(settings.LEARNING_FEEDBACK_PATH, exist_ok=True) # Assuming LEARNING_FEEDBACK_PATH is a good temp dir\n    cache = ResponseCache(cache_dir=settings.LEARNING_FEEDBACK_PATH, ttl_minutes=1) # 1 minute TTL for testing\n\n    test_query = \"Qual \u00e9 o total de vendas por produto para o segmento A?\"\n    test_response = {\"result\": [{\"product\": \"X\", \"sales\": 100}], \"chart_spec\": None}\n\n    key = cache.generate_key(test_query)\n    print(f\"\\nGenerated key for '{test_query}': {key}\")\n\n    # Test set\n    cache.set(key, test_response)\n    \n    # Test get (should hit)\n    retrieved = cache.get(key)\n    print(f\"Retrieved (should hit): {retrieved}\")\n    assert retrieved == test_response\n\n    # Test get (after expiration - manual simulation)\n    print(\"Waiting for cache to expire (1 minute)...\")\n    import time\n    time.sleep(65) # Wait a bit more than 1 minute\n\n    retrieved_expired = cache.get(key)\n    print(f\"Retrieved (should miss after expiration): {retrieved_expired}\")\n    assert retrieved_expired is None\n\n    # Test clean_expired_cache\n    cache.set(key, test_response) # Set again to have something to expire\n    time.sleep(65)\n    print(\"\\nRunning cache cleanup...\")\n    cache.clean_expired_cache()\n    assert cache.get(key) is None # Should be gone after cleanup\n\n    print(\"\\nResponseCache tests passed!\")", "mimetype": "text/plain", "start_char_idx": 3612, "end_char_idx": 6869, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6a1de7df-ecb1-48a5-81f2-8ec326ec5c0c": {"__data__": {"id_": "6a1de7df-ecb1-48a5-81f2-8ec326ec5c0c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\response_parser.py", "language": "python", "lines": 139, "filename": "response_parser.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "11648e8a-5b5f-47b4-a171-042f18c322a1", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\response_parser.py", "language": "python", "lines": 139, "filename": "response_parser.py"}, "hash": "60551d2e98a1db5f9fe459c9331faa26524cf30af3963c305d6306ac4e8aa4d0", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nUtilit\u00e1rios para parsear e processar respostas do agente.\nDetecta gr\u00e1ficos, dataframes e textos nas respostas.\n\"\"\"\n\nimport json\nimport logging\nfrom typing import Dict, Any, Tuple\nimport plotly.graph_objects as go\n\nlogger = logging.getLogger(__name__)\n\n\ndef parse_agent_response(response: str) -> Tuple[str, Dict[str, Any]]:\n    \"\"\"\n    Parseia a resposta do agente e extrai dados estruturados.\n\n    Args:\n        response: String da resposta do agente\n\n    Returns:\n        Tupla (tipo, dados_processados)\n        Tipos: \"chart\", \"text\", \"error\"\n    \"\"\"\n    if not response:\n        return \"text\", {\"output\": \"Nenhuma resposta recebida.\"}\n\n    response_lower = response.lower()\n\n    # Detectar se cont\u00e9m informa\u00e7\u00f5es de gr\u00e1fico\n    if any(\n        keyword in response_lower\n        for keyword in [\n            \"gr\u00e1fico\",\n            \"grafico\",\n            \"chart\",\n            \"plotly\",\n            \"chart_data\",\n            \"chart_type\",\n            \"visualiza\",\n        ]\n    ):\n        logger.debug(\"Detectada resposta tipo gr\u00e1fico\")\n        return _extract_chart_from_response(response)\n\n    # Caso contr\u00e1rio, retornar como texto\n    logger.debug(\"Resposta processada como texto\")\n    return \"text\", {\"output\": response}\n\n\ndef _extract_chart_from_response(response: str) -> Tuple[str, Dict[str, Any]]:\n    \"\"\"\n    Extrai dados de gr\u00e1fico de uma resposta de ferramenta.\n\n    Args:\n        response: String contendo dados do gr\u00e1fico\n\n    Returns:\n        Tupla (tipo, figura_plotly ou erro)\n    \"\"\"\n    try:\n        # Tentar parsear como JSON\n        if response.startswith(\"{\"):\n            data = json.loads(response)\n        else:\n            # Se n\u00e3o for JSON puro, tomar o primeiro JSON encontrado\n            import re\n\n            json_match = re.search(r\"\\{.*\\}\", response, re.DOTALL)\n            if json_match:\n                data = json.loads(json_match.group())\n            else:\n                return \"text\", {\"output\": response}\n\n        # Verificar se \u00e9 resposta de ferramenta de gr\u00e1fico\n        if \"chart_data\" in data and \"status\" in data:\n            if data.get(\"status\") == \"success\":\n                try:\n                    # chart_data j\u00e1 vem como JSON string de Plotly\n                    chart_json = data[\"chart_data\"]\n                    if isinstance(chart_json, str):\n                        chart_json = json.loads(chart_json)\n\n                    # Converter JSON para figura Plotly\n                    fig = go.Figure(chart_json)\n\n                    logger.info(\n                        f\"Gr\u00e1fico tipo '{data.get('chart_type', 'unknown')}' \"\n                        f\"extra\u00eddo com sucesso\"\n                    )\n\n                    return \"chart\", {\n                        \"output\": fig,\n                        \"summary\": data.get(\"summary\", {}),\n                        \"chart_type\": data.get(\"chart_type\", \"unknown\"),\n                    }\n\n                except Exception as e:\n                    logger.warning(f\"Erro ao processar chart_data: {e}\")\n                    # Retornar como texto se falhar\n                    summary = data.get(\"summary\", {})\n                    msg = \"Gr\u00e1fico gerado com sucesso.\\n\\n**Sum\u00e1rio:**\\n\"\n                    for key, value in summary.items():\n                        msg += f\"- **{key}**: {value}\\n\"\n                    return \"text\", {\"output\": msg}\n\n            else:\n                error_msg = data.get(\"message\", \"Erro ao gerar gr\u00e1fico\")\n                logger.warning(f\"Gr\u00e1fico retornou erro: {error_msg}\")\n                return \"text\", {\"output\": f\"\u274c {error_msg}\"}\n\n        # Se n\u00e3o tem estrutura de gr\u00e1fico, retornar como texto\n        return \"text\", {\"output\": response}\n\n    except json.JSONDecodeError:\n        logger.debug(\"Resposta n\u00e3o \u00e9 JSON, retornando como texto\")\n        return \"text\", {\"output\": response}\n    except Exception as e:\n        logger.error(f\"Erro ao extrair gr\u00e1fico: {e}\", exc_info=True)\n        return \"text\", {\"output\": response}\n\n\ndef detect_dataframe_response(response: Any) -> bool:\n    \"\"\"\n    Detecta se a resposta \u00e9 um DataFrame.\n\n    Args:\n        response: Resposta a verificar\n\n    Returns:\n        True se for DataFrame, False caso contr\u00e1rio\n    \"\"\"\n    try:\n        import pandas as pd\n\n        return isinstance(response, pd.DataFrame)\n    except Exception:\n        return False", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4316, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7ed8104f-dab0-4781-8a99-9bbc91277315": {"__data__": {"id_": "7ed8104f-dab0-4781-8a99-9bbc91277315", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\response_validator.py", "language": "python", "lines": 234, "filename": "response_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d33ca55a-61c0-4c93-a37a-7ab825660ef8", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\response_validator.py", "language": "python", "lines": 234, "filename": "response_validator.py"}, "hash": "d8f9dd15ea60291d8f93faabd345da35bc8404947e1f52cfaf5dbf3c8e7123d3", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "9821444d-aab9-4174-b47e-3c6dcb776dfc", "node_type": "1", "metadata": {}, "hash": "d66bf5a3c39d2835a394b365714d7cc7751f80012121081faacf2c91acbd0dd4", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nResponse Validator - Valida respostas do agente para detectar erros e alucina\u00e7\u00f5es\nUsa t\u00e9cnicas de verifica\u00e7\u00e3o para melhorar precis\u00e3o\n\"\"\"\n\nimport logging\nimport re\nfrom typing import Dict, Any, Optional, List, Tuple\nfrom dataclasses import dataclass\n\nlogger = logging.getLogger(__name__)\n\n\n@dataclass\nclass ValidationResult:\n    \"\"\"Resultado da valida\u00e7\u00e3o de resposta.\"\"\"\n    is_valid: bool\n    confidence: float  # 0.0 a 1.0\n    issues: List[str]\n    suggestions: List[str]\n    corrected_response: Optional[str] = None\n\n\nclass ResponseValidator:\n    \"\"\"\n    Valida respostas do ChatBI para detectar:\n    - Alucina\u00e7\u00f5es (dados inventados)\n    - Inconsist\u00eancias num\u00e9ricas\n    - Refer\u00eancias a dados inexistentes\n    - Erros de formata\u00e7\u00e3o\n    \"\"\"\n    \n    # Colunas reais do admmat.parquet\n    VALID_COLUMNS = {\n        \"id\", \"UNE\", \"PRODUTO\", \"TIPO\", \"UNE_NOME\", \"NOME\", \"EMBALAGEM\",\n        \"NOMESEGMENTO\", \"NOMECATEGORIA\", \"NOMEFABRICANTE\", \"SITUACAO\",\n        \"ESTOQUE_UNE\", \"ESTOQUE_LV\", \"ESTOQUE_CD\", \"VENDA_30DD\",\n        \"PRECO_VENDA\", \"PRECO_CUSTO\", \"PICKLIST_SITUACAO\",\n        \"ULTIMA_VENDA_DATA_UNE\", \"created_at\", \"updated_at\"\n    }\n    \n    # Palavras que indicam poss\u00edvel alucina\u00e7\u00e3o\n    HALLUCINATION_INDICATORS = [\n        \"possivelmente\", \"provavelmente\", \"talvez\", \"n\u00e3o tenho certeza\",\n        \"acredito que\", \"parece que\", \"pode ser\", \"imagino que\"\n    ]\n    \n    # Padr\u00f5es de erro conhecidos\n    ERROR_PATTERNS = [\n        r\"erro\\s+ao\\s+consultar\",\n        r\"n\u00e3o\\s+foi\\s+poss\u00edvel\",\n        r\"falha\\s+na\\s+consulta\",\n        r\"coluna.*n\u00e3o\\s+encontrada\",\n        r\"dados\\s+n\u00e3o\\s+encontrados\",\n    ]\n    \n    def __init__(self):\n        self.validation_count = 0\n        self.error_count = 0\n    \n    def validate(self, response: Dict[str, Any], query: str = \"\") -> ValidationResult:\n        \"\"\"\n        Valida uma resposta do agente.\n        \n        Args:\n            response: Resposta do agente\n            query: Pergunta original do usu\u00e1rio\n            \n        Returns:\n            ValidationResult com status e detalhes\n        \"\"\"\n        self.validation_count += 1\n        issues = []\n        suggestions = []\n        confidence = 1.0\n        \n        # Extrair texto da resposta\n        response_text = self._extract_text(response)\n        \n        # 1. Verificar se resposta est\u00e1 vazia\n        if not response_text or len(response_text.strip()) < 10:\n            issues.append(\"Resposta muito curta ou vazia\")\n            suggestions.append(\"Reformule a pergunta de forma mais espec\u00edfica\")\n            confidence -= 0.5\n        \n        # 2. Verificar indicadores de alucina\u00e7\u00e3o\n        hallucination_score = self._check_hallucination(response_text)\n        if hallucination_score > 0.3:\n            issues.append(f\"Poss\u00edvel incerteza detectada (score: {hallucination_score:.2f})\")\n            suggestions.append(\"Verifique os dados retornados\")\n            confidence -= hallucination_score * 0.3\n        \n        # 3. Verificar padr\u00f5es de erro\n        if self._has_error_pattern(response_text):\n            issues.append(\"Padr\u00e3o de erro detectado na resposta\")\n            suggestions.append(\"Verifique os par\u00e2metros da consulta\")\n            confidence -= 0.3\n        \n        # 4. Validar refer\u00eancias a colunas\n        invalid_cols = self._check_column_references(response_text)\n        if invalid_cols:\n            issues.append(f\"Refer\u00eancias a colunas possivelmente inv\u00e1lidas: {', '.join(invalid_cols)}\")\n            suggestions.append(f\"Colunas v\u00e1lidas incluem: UNE, PRODUTO, NOME, ESTOQUE_UNE, VENDA_30DD\")\n            confidence -= 0.2\n        \n        # 5.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3592, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9821444d-aab9-4174-b47e-3c6dcb776dfc": {"__data__": {"id_": "9821444d-aab9-4174-b47e-3c6dcb776dfc", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\response_validator.py", "language": "python", "lines": 234, "filename": "response_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d33ca55a-61c0-4c93-a37a-7ab825660ef8", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\response_validator.py", "language": "python", "lines": 234, "filename": "response_validator.py"}, "hash": "d8f9dd15ea60291d8f93faabd345da35bc8404947e1f52cfaf5dbf3c8e7123d3", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "7ed8104f-dab0-4781-8a99-9bbc91277315", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\response_validator.py", "language": "python", "lines": 234, "filename": "response_validator.py"}, "hash": "a3b5c7ec5edeb1ff485ccdc2b4b62370aaa609aa06e2e2dc3e8ceab359d556a8", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "1dee5a99-3ded-490a-bb9e-6f8d0907e38c", "node_type": "1", "metadata": {}, "hash": "78560eabb4c952c28b23fb3c6c1404949d601ec5130ae8019de00fd88f33076b", "class_name": "RelatedNodeInfo"}}, "text": "Verificar padr\u00f5es de erro\n        if self._has_error_pattern(response_text):\n            issues.append(\"Padr\u00e3o de erro detectado na resposta\")\n            suggestions.append(\"Verifique os par\u00e2metros da consulta\")\n            confidence -= 0.3\n        \n        # 4. Validar refer\u00eancias a colunas\n        invalid_cols = self._check_column_references(response_text)\n        if invalid_cols:\n            issues.append(f\"Refer\u00eancias a colunas possivelmente inv\u00e1lidas: {', '.join(invalid_cols)}\")\n            suggestions.append(f\"Colunas v\u00e1lidas incluem: UNE, PRODUTO, NOME, ESTOQUE_UNE, VENDA_30DD\")\n            confidence -= 0.2\n        \n        # 5. Verificar consist\u00eancia num\u00e9rica\n        numeric_issues = self._check_numeric_consistency(response_text)\n        if numeric_issues:\n            issues.extend(numeric_issues)\n            confidence -= 0.1 * len(numeric_issues)\n        \n        # Garantir que confidence est\u00e1 entre 0 e 1\n        confidence = max(0.0, min(1.0, confidence))\n        \n        is_valid = len(issues) == 0 and confidence >= 0.7\n        \n        if not is_valid:\n            self.error_count += 1\n            logger.warning(f\"Resposta inv\u00e1lida: {issues}\")\n        \n        return ValidationResult(\n            is_valid=is_valid,\n            confidence=confidence,\n            issues=issues,\n            suggestions=suggestions\n        )\n    \n    def _extract_text(self, response: Dict[str, Any]) -> str:\n        \"\"\"Extrai texto da resposta do agente.\"\"\"\n        if isinstance(response, str):\n            return response\n        \n        # Tentar diferentes formatos de resposta\n        text = response.get(\"result\", \"\")\n        if isinstance(text, dict):\n            text = text.get(\"mensagem\", \"\") or str(text)\n        elif not isinstance(text, str):\n            text = str(text)\n        \n        return text\n    \n    def _check_hallucination(self, text: str) -> float:\n        \"\"\"Verifica indicadores de alucina\u00e7\u00e3o.\"\"\"\n        text_lower = text.lower()\n        count = 0\n        \n        for indicator in self.HALLUCINATION_INDICATORS:\n            if indicator in text_lower:\n                count += 1\n        \n        # Normalizar score\n        return min(1.0, count / 3)\n    \n    def _has_error_pattern(self, text: str) -> bool:\n        \"\"\"Verifica padr\u00f5es de erro conhecidos.\"\"\"\n        text_lower = text.lower()\n        \n        for pattern in self.ERROR_PATTERNS:\n            if re.search(pattern, text_lower):\n                return True\n        \n        return False\n    \n    def _check_column_references(self, text: str) -> List[str]:\n        \"\"\"Verifica refer\u00eancias a colunas potencialmente inv\u00e1lidas.\"\"\"\n        # Buscar padr\u00f5es que parecem nomes de colunas\n        pattern = r'\\b([A-Z][A-Z0-9_]{2,30})\\b'\n        matches = re.findall(pattern, text)\n        \n        invalid = []\n        for match in matches:\n            # Ignorar palavras comuns que n\u00e3o s\u00e3o colunas\n            if match in {\"OK\", \"NULL\", \"TRUE\", \"FALSE\", \"AND\", \"OR\", \"NOT\"}:\n                continue\n            \n            # Verificar se parece uma coluna mas n\u00e3o est\u00e1 na lista v\u00e1lida\n            if \"_\" in match or match.isupper():\n                if match not in self.VALID_COLUMNS:\n                    invalid.append(match)\n        \n        return invalid[:3]  # Limitar a 3 para n\u00e3o poluir\n    \n    def _check_numeric_consistency(self, text: str) -> List[str]:\n        \"\"\"Verifica consist\u00eancia de valores num\u00e9ricos.\"\"\"\n        issues = []\n        \n        # Buscar n\u00fameros muito grandes que podem ser erros\n        pattern = r'\\b(\\d{10,})\\b'\n        large_numbers = re.findall(pattern, text)\n        \n        for num in large_numbers:\n            if len(num) > 15:\n                issues.append(f\"N\u00famero muito grande detectado: pode ser erro\")\n                break\n        \n        # Buscar valores negativos onde n\u00e3o deveria haver\n        if re.search(r'estoque.*-\\d+|vendas.*-\\d+', text.lower()):\n            issues.append(\"Valor negativo detectado em campo que deveria ser positivo\")\n        \n        return issues\n    \n    def get_stats(self) -> Dict[str, Any]:\n        \"\"\"Retorna estat\u00edsticas de valida\u00e7\u00e3o.\"\"\"", "mimetype": "text/plain", "start_char_idx": 2946, "end_char_idx": 7072, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1dee5a99-3ded-490a-bb9e-6f8d0907e38c": {"__data__": {"id_": "1dee5a99-3ded-490a-bb9e-6f8d0907e38c", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\response_validator.py", "language": "python", "lines": 234, "filename": "response_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d33ca55a-61c0-4c93-a37a-7ab825660ef8", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\response_validator.py", "language": "python", "lines": 234, "filename": "response_validator.py"}, "hash": "d8f9dd15ea60291d8f93faabd345da35bc8404947e1f52cfaf5dbf3c8e7123d3", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "9821444d-aab9-4174-b47e-3c6dcb776dfc", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\response_validator.py", "language": "python", "lines": 234, "filename": "response_validator.py"}, "hash": "7e090890b043f04af9badaf6c48ab273d2ef223395e7c39371d2e27f26b2092f", "class_name": "RelatedNodeInfo"}}, "text": "issues = []\n        \n        # Buscar n\u00fameros muito grandes que podem ser erros\n        pattern = r'\\b(\\d{10,})\\b'\n        large_numbers = re.findall(pattern, text)\n        \n        for num in large_numbers:\n            if len(num) > 15:\n                issues.append(f\"N\u00famero muito grande detectado: pode ser erro\")\n                break\n        \n        # Buscar valores negativos onde n\u00e3o deveria haver\n        if re.search(r'estoque.*-\\d+|vendas.*-\\d+', text.lower()):\n            issues.append(\"Valor negativo detectado em campo que deveria ser positivo\")\n        \n        return issues\n    \n    def get_stats(self) -> Dict[str, Any]:\n        \"\"\"Retorna estat\u00edsticas de valida\u00e7\u00e3o.\"\"\"\n        error_rate = (self.error_count / self.validation_count * 100) if self.validation_count > 0 else 0\n        \n        return {\n            \"total_validations\": self.validation_count,\n            \"total_errors\": self.error_count,\n            \"error_rate\": f\"{error_rate:.1f}%\",\n            \"valid_columns_count\": len(self.VALID_COLUMNS),\n        }\n\n\n# Inst\u00e2ncia global\n_validator: Optional[ResponseValidator] = None\n\n\ndef get_validator() -> ResponseValidator:\n    \"\"\"Retorna inst\u00e2ncia singleton do validador.\"\"\"\n    global _validator\n    if _validator is None:\n        _validator = ResponseValidator()\n    return _validator\n\n\ndef validate_response(response: Dict[str, Any], query: str = \"\") -> ValidationResult:\n    \"\"\"Valida resposta do agente.\"\"\"\n    return get_validator().validate(response, query)\n\n\ndef validator_stats() -> Dict[str, Any]:\n    \"\"\"Retorna estat\u00edsticas do validador.\"\"\"\n    return get_validator().get_stats()", "mimetype": "text/plain", "start_char_idx": 6384, "end_char_idx": 8005, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0b92b392-c6e5-490c-b136-8c0c48e38e45": {"__data__": {"id_": "0b92b392-c6e5-490c-b136-8c0c48e38e45", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\semantic_cache.py", "language": "python", "lines": 244, "filename": "semantic_cache.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d51e5ac3-855f-4c59-b6cf-89ac2dacd175", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\semantic_cache.py", "language": "python", "lines": 244, "filename": "semantic_cache.py"}, "hash": "e11ee20fde401f06970e095648bd38ebe315087be21300133a49a0aaff4d9541", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "aab679ae-2d69-49e3-b716-ce9f6d3dc64f", "node_type": "1", "metadata": {}, "hash": "040936b449e6fad1c79ac2ae8e1a110ad9c40a58736dea235bccbc0c1f85f3c9", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSemantic Cache - Cache inteligente baseado em similaridade sem\u00e2ntica\nPermite respostas instant\u00e2neas para perguntas similares\n\"\"\"\n\nimport hashlib\nimport json\nimport logging\nimport os\nimport time\nfrom pathlib import Path\nfrom typing import Dict, Any, Optional, Tuple\n\nlogger = logging.getLogger(__name__)\n\n\nclass SemanticCache:\n    \"\"\"\n    Cache sem\u00e2ntico para respostas do ChatBI.\n    \n    Caracter\u00edsticas:\n    - Hash baseado em normaliza\u00e7\u00e3o da query\n    - TTL configur\u00e1vel\n    - Persist\u00eancia em disco\n    - Estat\u00edsticas de hit/miss\n    \"\"\"\n    \n    def __init__(\n        self, \n        cache_dir: str = \"data/cache/semantic\",\n        ttl_minutes: int = 360,  # 6 horas\n        max_entries: int = 1000\n    ):\n        self.cache_dir = Path(cache_dir)\n        self.cache_dir.mkdir(parents=True, exist_ok=True)\n        self.ttl_seconds = ttl_minutes * 60\n        self.max_entries = max_entries\n        \n        # Estat\u00edsticas\n        self.hits = 0\n        self.misses = 0\n        \n        # Index em mem\u00f3ria para busca r\u00e1pida\n        self._index: Dict[str, Dict[str, Any]] = {}\n        self._load_index()\n        \n        logger.info(f\"SemanticCache inicializado: {cache_dir}, TTL={ttl_minutes}min\")\n    \n    def _normalize_query(self, query: str) -> str:\n        \"\"\"Normaliza query para melhor matching.\"\"\"\n        # Converter para min\u00fasculas\n        normalized = query.lower().strip()\n        \n        # Remover pontua\u00e7\u00e3o desnecess\u00e1ria\n        for char in \"?!.,;:\":\n            normalized = normalized.replace(char, \"\")\n        \n        # Normalizar espa\u00e7os m\u00faltiplos\n        normalized = \" \".join(normalized.split())\n        \n        return normalized\n    \n    def _generate_key(self, query: str) -> str:\n        \"\"\"Gera chave hash para a query normalizada.\"\"\"\n        normalized = self._normalize_query(query)\n        return hashlib.md5(normalized.encode('utf-8')).hexdigest()\n    \n    def _load_index(self):\n        \"\"\"Carrega \u00edndice do disco.\"\"\"\n        index_file = self.cache_dir / \"index.json\"\n        if index_file.exists():\n            try:\n                with open(index_file, 'r', encoding='utf-8') as f:\n                    self._index = json.load(f)\n                logger.info(f\"Cache index carregado: {len(self._index)} entradas\")\n            except Exception as e:\n                logger.error(f\"Erro ao carregar cache index: {e}\")\n                self._index = {}\n    \n    def _save_index(self):\n        \"\"\"Salva \u00edndice no disco.\"\"\"\n        index_file = self.cache_dir / \"index.json\"\n        try:\n            with open(index_file, 'w', encoding='utf-8') as f:\n                json.dump(self._index, f, ensure_ascii=False, indent=2)\n        except Exception as e:\n            logger.error(f\"Erro ao salvar cache index: {e}\")\n    \n    def get(self, query: str) -> Optional[Dict[str, Any]]:\n        \"\"\"\n        Busca resposta em cache.\n        \n        Args:\n            query: Pergunta do usu\u00e1rio\n            \n        Returns:\n            Resposta cacheada ou None se n\u00e3o encontrada/expirada\n        \"\"\"\n        key = self._generate_key(query)\n        \n        if key not in self._index:\n            self.misses += 1\n            return None\n        \n        entry = self._index[key]\n        \n        # Verificar TTL\n        if time.time() - entry.get(\"timestamp\", 0) > self.ttl_seconds:\n            # Expirado - remover\n            self._remove_entry(key)\n            self.misses += 1\n            logger.debug(f\"Cache expirado para: {query[:50]}...\")\n            return None\n        \n        # Cache hit!\n        self.hits += 1\n        logger.info(f\"Cache HIT para: {query[:50]}... (hits={self.hits})\")\n        \n        # Carregar resposta do arquivo\n        cache_file = self.cache_dir / f\"{key}.json\"\n        if cache_file.exists():\n            try:\n                with open(cache_file, 'r', encoding='utf-8') as f:\n                    return json.load(f)\n            except Exception as e:\n                logger.error(f\"Erro ao ler cache file: {e}\")\n                return None\n        \n        return None\n    \n    def set(self, query: str, response: Dict[str, Any]) -> bool:\n        \"\"\"\n        Armazena resposta em cache.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4147, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "aab679ae-2d69-49e3-b716-ce9f6d3dc64f": {"__data__": {"id_": "aab679ae-2d69-49e3-b716-ce9f6d3dc64f", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\semantic_cache.py", "language": "python", "lines": 244, "filename": "semantic_cache.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d51e5ac3-855f-4c59-b6cf-89ac2dacd175", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\semantic_cache.py", "language": "python", "lines": 244, "filename": "semantic_cache.py"}, "hash": "e11ee20fde401f06970e095648bd38ebe315087be21300133a49a0aaff4d9541", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "0b92b392-c6e5-490c-b136-8c0c48e38e45", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\utils\\semantic_cache.py", "language": "python", "lines": 244, "filename": "semantic_cache.py"}, "hash": "fdd61c9c6b4a92e54920ec70aae6d1307ecd4652a0d038122e2681d025fb795a", "class_name": "RelatedNodeInfo"}}, "text": "self.hits += 1\n        logger.info(f\"Cache HIT para: {query[:50]}... (hits={self.hits})\")\n        \n        # Carregar resposta do arquivo\n        cache_file = self.cache_dir / f\"{key}.json\"\n        if cache_file.exists():\n            try:\n                with open(cache_file, 'r', encoding='utf-8') as f:\n                    return json.load(f)\n            except Exception as e:\n                logger.error(f\"Erro ao ler cache file: {e}\")\n                return None\n        \n        return None\n    \n    def set(self, query: str, response: Dict[str, Any]) -> bool:\n        \"\"\"\n        Armazena resposta em cache.\n        \n        Args:\n            query: Pergunta do usu\u00e1rio\n            response: Resposta a cachear\n            \n        Returns:\n            True se armazenado com sucesso\n        \"\"\"\n        key = self._generate_key(query)\n        \n        # Verificar limite de entradas\n        if len(self._index) >= self.max_entries:\n            self._cleanup_oldest()\n        \n        # Atualizar \u00edndice\n        self._index[key] = {\n            \"query\": query,\n            \"normalized\": self._normalize_query(query),\n            \"timestamp\": time.time(),\n        }\n        \n        # Salvar resposta em arquivo\n        cache_file = self.cache_dir / f\"{key}.json\"\n        try:\n            with open(cache_file, 'w', encoding='utf-8') as f:\n                json.dump(response, f, ensure_ascii=False, indent=2)\n            \n            self._save_index()\n            logger.debug(f\"Cache SET para: {query[:50]}...\")\n            return True\n        except Exception as e:\n            logger.error(f\"Erro ao salvar cache: {e}\")\n            return False\n    \n    def _remove_entry(self, key: str):\n        \"\"\"Remove entrada do cache.\"\"\"\n        if key in self._index:\n            del self._index[key]\n            \n        cache_file = self.cache_dir / f\"{key}.json\"\n        if cache_file.exists():\n            cache_file.unlink()\n        \n        self._save_index()\n    \n    def _cleanup_oldest(self, remove_count: int = 100):\n        \"\"\"Remove entradas mais antigas.\"\"\"\n        if not self._index:\n            return\n        \n        # Ordenar por timestamp\n        sorted_entries = sorted(\n            self._index.items(),\n            key=lambda x: x[1].get(\"timestamp\", 0)\n        )\n        \n        # Remover as mais antigas\n        for key, _ in sorted_entries[:remove_count]:\n            self._remove_entry(key)\n        \n        logger.info(f\"Cache cleanup: removidas {remove_count} entradas antigas\")\n    \n    def clear(self):\n        \"\"\"Limpa todo o cache.\"\"\"\n        for key in list(self._index.keys()):\n            self._remove_entry(key)\n        self._index = {}\n        self._save_index()\n        logger.info(\"Cache limpo completamente\")\n    \n    def get_stats(self) -> Dict[str, Any]:\n        \"\"\"Retorna estat\u00edsticas do cache.\"\"\"\n        total = self.hits + self.misses\n        hit_rate = (self.hits / total * 100) if total > 0 else 0\n        \n        return {\n            \"entries\": len(self._index),\n            \"hits\": self.hits,\n            \"misses\": self.misses,\n            \"hit_rate\": f\"{hit_rate:.1f}%\",\n            \"cache_dir\": str(self.cache_dir),\n        }\n\n\n# Inst\u00e2ncia global do cache\n_semantic_cache: Optional[SemanticCache] = None\n\n\ndef get_semantic_cache() -> SemanticCache:\n    \"\"\"Retorna inst\u00e2ncia singleton do cache.\"\"\"\n    global _semantic_cache\n    if _semantic_cache is None:\n        _semantic_cache = SemanticCache()\n    return _semantic_cache\n\n\n# Fun\u00e7\u00f5es de conveni\u00eancia\ndef cache_get(query: str) -> Optional[Dict[str, Any]]:\n    \"\"\"Busca resposta em cache.\"\"\"\n    return get_semantic_cache().get(query)\n\n\ndef cache_set(query: str, response: Dict[str, Any]) -> bool:\n    \"\"\"Armazena resposta em cache.\"\"\"\n    return get_semantic_cache().set(query, response)\n\n\ndef cache_stats() -> Dict[str, Any]:\n    \"\"\"Retorna estat\u00edsticas do cache.\"\"\"\n    return get_semantic_cache().get_stats()", "mimetype": "text/plain", "start_char_idx": 3531, "end_char_idx": 7452, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6f807265-4089-41cc-9dc2-416a200e46e5": {"__data__": {"id_": "6f807265-4089-41cc-9dc2-416a200e46e5", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\session_manager.py", "language": "python", "lines": 57, "filename": "session_manager.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9f0213a1-8b99-416a-b97e-d6f73804b606", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\session_manager.py", "language": "python", "lines": 57, "filename": "session_manager.py"}, "hash": "eaa4317d1554ef2dd755b6d7cd861e59dc3032f63944b103de913d0b1fc108c3", "class_name": "RelatedNodeInfo"}}, "text": "import json\nimport os\nimport logging\nfrom typing import List, Dict, Any\nfrom pathlib import Path\n\nlogger = logging.getLogger(__name__)\n\nclass SessionManager:\n    def __init__(self, storage_dir: str = \"data/sessions\"):\n        self.storage_dir = Path(storage_dir)\n        self.storage_dir.mkdir(parents=True, exist_ok=True)\n\n    def _get_file_path(self, session_id: str) -> Path:\n        return self.storage_dir / f\"{session_id}.json\"\n\n    def get_history(self, session_id: str) -> List[Dict[str, str]]:\n        \"\"\"Retrieves chat history for a given session ID.\"\"\"\n        file_path = self._get_file_path(session_id)\n        if not file_path.exists():\n            return []\n        \n        try:\n            with open(file_path, 'r', encoding='utf-8') as f:\n                data = json.load(f)\n                return data.get(\"history\", [])\n        except Exception as e:\n            logger.error(f\"Error reading session {session_id}: {e}\")\n            return []\n\n    def add_message(self, session_id: str, role: str, content: str):\n        \"\"\"Adds a message to the session history.\"\"\"\n        file_path = self._get_file_path(session_id)\n        history = self.get_history(session_id)\n        \n        history.append({\"role\": role, \"content\": content})\n        \n        # Limit history length to prevent context window explosion (e.g., last 20 messages)\n        # This is a basic optimization. RAG/Summarization would be better for long term.\n        if len(history) > 20:\n            history = history[-20:]\n\n        try:\n            with open(file_path, 'w', encoding='utf-8') as f:\n                json.dump({\"history\": history}, f, ensure_ascii=False, indent=2)\n        except Exception as e:\n            logger.error(f\"Error saving session {session_id}: {e}\")\n\n    def clear_session(self, session_id: str):\n        \"\"\"Deletes a session file.\"\"\"\n        file_path = self._get_file_path(session_id)\n        if file_path.exists():\n            try:\n                os.remove(file_path)\n            except Exception as e:\n                logger.error(f\"Error clearing session {session_id}: {e}\")", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2094, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e82e749c-541f-4f2e-8aec-96ded845d24a": {"__data__": {"id_": "e82e749c-541f-4f2e-8aec-96ded845d24a", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\utils\\__init__.py", "language": "python", "lines": 2, "filename": "__init__.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f6f10c33-48e1-47c1-b2d0-39873e999a6d", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\utils\\__init__.py", "language": "python", "lines": 2, "filename": "__init__.py"}, "hash": "27bc1055903a1bf62fc357d235fd54432338d503678761c3dfb367cf5248defc", "class_name": "RelatedNodeInfo"}}, "text": "# Utils module", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 14, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6fdbbcca-edfe-4749-ae67-a6de1bcbc3d5": {"__data__": {"id_": "6fdbbcca-edfe-4749-ae67-a6de1bcbc3d5", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "76dd1381-3d9d-4f76-8d0c-54637b99cecd", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "hash": "7734c1862992de87bc0ef2818edbeffb01dd0459e60a2ffb7baf1cd151885a12", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "78e39a88-8c05-4570-b0b3-58c4e6b60119", "node_type": "1", "metadata": {}, "hash": "481da7300e3ca4557ad905f555c618522b8ea43af31007c555186d71e5a04f7e", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSchemaValidator - Validador de schemas Parquet.\n\nEste m\u00f3dulo fornece valida\u00e7\u00e3o robusta de schemas Parquet contra\no cat\u00e1logo de dados corporativo (catalog_focused.json).\n\nFuncionalidades:\n- Valida\u00e7\u00e3o de tipos de dados\n- Detec\u00e7\u00e3o de incompatibilidades de schema\n- Mensagens de erro contextualizadas\n- Verifica\u00e7\u00e3o de colunas obrigat\u00f3rias\n\nAutor: Code Agent\nData: 2025-10-17\n\"\"\"\n\nimport json\nimport logging\nimport os\nfrom pathlib import Path\nfrom typing import Dict, List, Optional, Tuple, Any\nimport pyarrow as pa\nimport pyarrow.parquet as pq\n\nlogger = logging.getLogger(__name__)\n\n\nclass SchemaValidator:\n    \"\"\"\n    Validador de schemas Parquet contra cat\u00e1logo corporativo.\n\n    Attributes:\n        catalog (Dict): Cat\u00e1logo de dados carregado do JSON\n        catalog_path (Path): Caminho para o arquivo de cat\u00e1logo\n    \"\"\"\n\n    # Mapeamento de tipos Parquet para tipos Python/Pandas\n    TYPE_MAPPING = {\n        'int64': ['int64', 'int32', 'int16', 'int8'],\n        'float64': ['float64', 'float32', 'double'],\n        'string': ['string', 'large_string', 'utf8'],\n        'date': ['date32', 'date64'],\n        'datetime': ['timestamp[ns]', 'timestamp[us]', 'timestamp[ms]'],\n        'bool': ['bool'],\n    }\n\n    def __init__(self, catalog_path: Optional[str] = None):\n        \"\"\"\n        Inicializa o validador de schema.\n\n        Args:\n            catalog_path: Caminho para catalog_focused.json (opcional)\n        \"\"\"\n        if catalog_path is None:\n            # Tentar localizar o cat\u00e1logo em v\u00e1rios locais poss\u00edveis\n            possible_paths = [\n                Path(os.getcwd()) / \"data\" / \"catalog_focused.json\", # Root execution\n                Path(os.getcwd()) / \"backend\" / \"data\" / \"catalog_focused.json\", # Outside backend\n                Path(__file__).parent.parent.parent.parent.parent / \"data\" / \"catalog_focused.json\", # Relative to file\n                Path(__file__).parent.parent.parent / \"data\" / \"catalog_focused.json\", # Old fallback\n            ]\n            \n            for path in possible_paths:\n                if path.exists():\n                    catalog_path = path\n                    break\n            \n            # Fallback se nenhum existir (vai falhar no load, mas pelo menos tentou)\n            if catalog_path is None:\n                catalog_path = possible_paths[0]\n\n        self.catalog_path = Path(catalog_path)\n        # self.catalog = self._load_catalog() # Adiar carregamento para evitar crash na init se arquivo n\u00e3o existir\n        # Melhor: Tentar carregar, se falhar, logar warning e usar catalogo vazio\n        try:\n            self.catalog: Any = self._load_catalog()\n        except FileNotFoundError:\n            logger.warning(f\"Cat\u00e1logo n\u00e3o encontrado em {self.catalog_path}. Valida\u00e7\u00e3o de schema ser\u00e1 ignorada.\")\n            self.catalog = []\n\n    def _load_catalog(self) -> Dict:\n        \"\"\"\n        Carrega o cat\u00e1logo de dados do arquivo JSON.\n\n        Returns:\n            Dict contendo o cat\u00e1logo de dados\n\n        Raises:\n            FileNotFoundError: Se o cat\u00e1logo n\u00e3o existir\n            json.JSONDecodeError: Se o JSON for inv\u00e1lido\n        \"\"\"\n        try:\n            with open(self.catalog_path, 'r', encoding='utf-8') as f:\n                catalog = json.load(f)\n            logger.info(f\"Cat\u00e1logo carregado: {self.catalog_path}\")\n            return catalog\n        except FileNotFoundError:\n            logger.error(f\"Cat\u00e1logo n\u00e3o encontrado: {self.catalog_path}\")\n            raise\n        except json.JSONDecodeError as e:\n            logger.error(f\"Erro ao decodificar cat\u00e1logo JSON: {e}\")\n            raise\n\n    def validate_parquet_file(self, parquet_path: str, table_name: Optional[str] = None) -> Tuple[bool, List[str]]:\n        \"\"\"\n        Valida um arquivo Parquet contra o cat\u00e1logo.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3767, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "78e39a88-8c05-4570-b0b3-58c4e6b60119": {"__data__": {"id_": "78e39a88-8c05-4570-b0b3-58c4e6b60119", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "76dd1381-3d9d-4f76-8d0c-54637b99cecd", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "hash": "7734c1862992de87bc0ef2818edbeffb01dd0459e60a2ffb7baf1cd151885a12", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "6fdbbcca-edfe-4749-ae67-a6de1bcbc3d5", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "hash": "bf7036dc22d2d1cc1e8b14fc3d328d8cc82ccc8ef7603d2a1465bc50a1e00bae", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "753424f8-e4b0-4b34-804c-41959cac64e1", "node_type": "1", "metadata": {}, "hash": "33d6126c3fd791d8f1c671b7789f6d02adc234c59c14a138dc81e0ee31817794", "class_name": "RelatedNodeInfo"}}, "text": "Returns:\n            Dict contendo o cat\u00e1logo de dados\n\n        Raises:\n            FileNotFoundError: Se o cat\u00e1logo n\u00e3o existir\n            json.JSONDecodeError: Se o JSON for inv\u00e1lido\n        \"\"\"\n        try:\n            with open(self.catalog_path, 'r', encoding='utf-8') as f:\n                catalog = json.load(f)\n            logger.info(f\"Cat\u00e1logo carregado: {self.catalog_path}\")\n            return catalog\n        except FileNotFoundError:\n            logger.error(f\"Cat\u00e1logo n\u00e3o encontrado: {self.catalog_path}\")\n            raise\n        except json.JSONDecodeError as e:\n            logger.error(f\"Erro ao decodificar cat\u00e1logo JSON: {e}\")\n            raise\n\n    def validate_parquet_file(self, parquet_path: str, table_name: Optional[str] = None) -> Tuple[bool, List[str]]:\n        \"\"\"\n        Valida um arquivo Parquet contra o cat\u00e1logo.\n\n        Args:\n            parquet_path: Caminho para o arquivo Parquet\n            table_name: Nome da tabela no cat\u00e1logo (inferido do arquivo se None)\n\n        Returns:\n            Tupla (is_valid, errors) onde:\n                - is_valid: True se schema v\u00e1lido\n                - errors: Lista de mensagens de erro\n        \"\"\"\n        errors = []\n\n        try:\n            # Carregar schema do Parquet\n            parquet_file = pq.ParquetFile(parquet_path)\n            parquet_schema = parquet_file.schema_arrow\n\n            # Inferir nome da tabela se n\u00e3o fornecido\n            if table_name is None:\n                table_name = Path(parquet_path).stem\n\n            # Buscar schema esperado no cat\u00e1logo\n            expected_schema = self._get_expected_schema(table_name)\n            if expected_schema is None:\n                errors.append(f\"Tabela '{table_name}' n\u00e3o encontrada no cat\u00e1logo\")\n                return False, errors\n\n            # Validar colunas\n            column_errors = self._validate_columns(parquet_schema, expected_schema, table_name)\n            errors.extend(column_errors)\n\n            # Validar tipos\n            type_errors = self._validate_types(parquet_schema, expected_schema, table_name)\n            errors.extend(type_errors)\n\n            is_valid = len(errors) == 0\n\n            if is_valid:\n                logger.info(f\"Schema v\u00e1lido para '{table_name}': {parquet_path}\")\n            else:\n                logger.warning(f\"Schema inv\u00e1lido para '{table_name}': {len(errors)} erros encontrados\")\n\n            return is_valid, errors\n\n        except Exception as e:\n            error_msg = f\"Erro ao validar arquivo Parquet '{parquet_path}': {str(e)}\"\n            logger.error(error_msg)\n            errors.append(error_msg)\n            return False, errors\n\n    def _get_expected_schema(self, table_name: str) -> Optional[Dict]:\n        \"\"\"\n        Obt\u00e9m o schema esperado do cat\u00e1logo para uma tabela.\n\n        Args:\n            table_name: Nome da tabela\n\n        Returns:\n            Dict com schema esperado ou None se n\u00e3o encontrado\n        \"\"\"\n        # Normalizar nome da tabela buscada\n        search_name = table_name.lower().replace('_', '').replace('-', '')\n        \n        # Handle List structure (Current format of catalog_focused.json)\n        if isinstance(self.catalog, list):\n            for table_info in self.catalog:\n                file_name = table_info.get(\"file_name\", \"\")\n                if not file_name:\n                    continue\n                    \n                # Extrair nome base do arquivo (ex: \"admatao.parquet\" -> \"admatao\")\n                catalog_table_name = Path(file_name).stem.lower().replace('_', '').replace('-', '')\n                \n                # Match exato\n                if catalog_table_name == search_name:\n                    return table_info\n                \n                # Match aproximado espec\u00edfico para admmat/admatao\n                if (search_name == \"admmat\" and \"admat\" in catalog_table_name) or \\\n                   (search_name == \"admatao\" and \"admmat\" in catalog_table_name):\n                    return table_info\n                    \n            return None\n\n        # Handle Dict structure (Legacy format support)\n        elif isinstance(self.catalog, dict):\n            # Tentar encontrar a tabela no cat\u00e1logo\n            for table_key, table_info in self.catalog.items():\n                # Normalizar nomes (remover prefixos, sufixos)\n                normalized_key = table_key.lower().replace('_', '').replace('-', '')\n\n                if normalized_key == search_name or table_key.lower() == table_name.lower():\n                    return table_info\n\n        return None\n\n    def _validate_columns(self, parquet_schema: pa.Schema, expected_schema: Dict, table_name: str) -> List[str]:\n        \"\"\"\n        Valida se as colunas esperadas est\u00e3o presentes no Parquet.", "mimetype": "text/plain", "start_char_idx": 2917, "end_char_idx": 7653, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "753424f8-e4b0-4b34-804c-41959cac64e1": {"__data__": {"id_": "753424f8-e4b0-4b34-804c-41959cac64e1", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "76dd1381-3d9d-4f76-8d0c-54637b99cecd", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "hash": "7734c1862992de87bc0ef2818edbeffb01dd0459e60a2ffb7baf1cd151885a12", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "78e39a88-8c05-4570-b0b3-58c4e6b60119", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "hash": "41bb2fd2f22a527c18106172ece5c452cd027f270079274ddf75ae07d242a83b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "6d0df27e-e863-4c3f-835f-291dfd167e1d", "node_type": "1", "metadata": {}, "hash": "c143ab7af881115fe4d606c0df4e412d349afa3bce3aa17b8c7a557861770e59", "class_name": "RelatedNodeInfo"}}, "text": "Args:\n            parquet_schema: Schema do arquivo Parquet\n            expected_schema: Schema esperado do cat\u00e1logo\n            table_name: Nome da tabela\n\n        Returns:\n            Lista de erros encontrados\n        \"\"\"\n        errors = []\n\n        # Obter colunas do Parquet\n        parquet_columns = set(parquet_schema.names)\n\n        # Obter colunas esperadas do cat\u00e1logo\n        expected_columns = set(expected_schema.get('columns', {}).keys())\n\n        # Verificar colunas faltantes (esperadas mas n\u00e3o presentes)\n        missing_columns = expected_columns - parquet_columns\n        if missing_columns:\n            errors.append(\n                f\"Tabela '{table_name}': Colunas faltantes: {sorted(missing_columns)}\"\n            )\n\n        # Verificar colunas extras (presentes mas n\u00e3o esperadas) - apenas warning\n        extra_columns = parquet_columns - expected_columns\n        if extra_columns:\n            logger.warning(\n                f\"Tabela '{table_name}': Colunas extras encontradas: {sorted(extra_columns)}\"\n            )\n\n        return errors\n\n    def _validate_types(self, parquet_schema: pa.Schema, expected_schema: Dict, table_name: str) -> List[str]:\n        \"\"\"\n        Valida se os tipos de dados s\u00e3o compat\u00edveis.\n\n        Args:\n            parquet_schema: Schema do arquivo Parquet\n            expected_schema: Schema esperado do cat\u00e1logo\n            table_name: Nome da tabela\n\n        Returns:\n            Lista de erros de incompatibilidade de tipos\n        \"\"\"\n        errors = []\n\n        expected_columns = expected_schema.get('columns', {})\n\n        for field in parquet_schema:\n            column_name = field.name\n\n            # Ignorar colunas n\u00e3o definidas no cat\u00e1logo\n            if column_name not in expected_columns:\n                continue\n\n            expected_type = expected_columns[column_name].get('type', 'string')\n            parquet_type = str(field.type)\n\n            # Verificar compatibilidade de tipos\n            if not self._is_type_compatible(parquet_type, expected_type):\n                errors.append(\n                    f\"Tabela '{table_name}', coluna '{column_name}': \"\n                    f\"Tipo incompat\u00edvel. Esperado: {expected_type}, \"\n                    f\"Encontrado: {parquet_type}\"\n                )\n\n        return errors\n\n    def _is_type_compatible(self, parquet_type: str, expected_type: str) -> bool:\n        \"\"\"\n        Verifica se um tipo Parquet \u00e9 compat\u00edvel com o tipo esperado.\n\n        Args:\n            parquet_type: Tipo do Parquet (ex: 'int64', 'string')\n            expected_type: Tipo esperado do cat\u00e1logo\n\n        Returns:\n            True se os tipos s\u00e3o compat\u00edveis\n        \"\"\"\n        # Normalizar tipos\n        parquet_type_lower = parquet_type.lower()\n        expected_type_lower = expected_type.lower()\n\n        # Verificar igualdade direta\n        if parquet_type_lower == expected_type_lower:\n            return True\n\n        # Verificar mapeamentos de tipos compat\u00edveis\n        for base_type, compatible_types in self.TYPE_MAPPING.items():\n            if expected_type_lower in compatible_types or expected_type_lower == base_type:\n                if parquet_type_lower in compatible_types or parquet_type_lower == base_type:\n                    return True\n\n        # Tipos num\u00e9ricos s\u00e3o geralmente compat\u00edveis entre si\n        numeric_types = ['int', 'float', 'double', 'decimal']\n        if any(nt in parquet_type_lower for nt in numeric_types) and \\\n           any(nt in expected_type_lower for nt in numeric_types):\n            return True\n\n        return False\n\n    def get_table_schema(self, table_name: str) -> Optional[Dict]:\n        \"\"\"\n        Retorna o schema esperado para uma tabela do cat\u00e1logo.\n\n        Args:\n            table_name: Nome da tabela\n\n        Returns:\n            Dict com schema da tabela ou None se n\u00e3o encontrada\n        \"\"\"\n        return self._get_expected_schema(table_name)\n\n    def list_required_columns(self, table_name: str) -> List[str]:\n        \"\"\"\n        Lista as colunas obrigat\u00f3rias de uma tabela.\n\n        Args:\n            table_name: Nome da tabela\n\n        Returns:\n            Lista de nomes de colunas obrigat\u00f3rias\n        \"\"\"\n        schema = self._get_expected_schema(table_name)\n        if schema is None:\n            return []\n\n        return list(schema.get('columns', {}).keys())\n\n    def validate_query_columns(self, table_name: str, query_columns: List[str]) -> Tuple[bool, List[str]]:\n        \"\"\"\n        Valida se as colunas de uma query existem no schema.", "mimetype": "text/plain", "start_char_idx": 7663, "end_char_idx": 12183, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6d0df27e-e863-4c3f-835f-291dfd167e1d": {"__data__": {"id_": "6d0df27e-e863-4c3f-835f-291dfd167e1d", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "76dd1381-3d9d-4f76-8d0c-54637b99cecd", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "hash": "7734c1862992de87bc0ef2818edbeffb01dd0459e60a2ffb7baf1cd151885a12", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "753424f8-e4b0-4b34-804c-41959cac64e1", "node_type": "1", "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}, "hash": "32b9b7c4712b96d3c0a3f85ab12a9445aa6ecfd847ea741313305933eefc3099", "class_name": "RelatedNodeInfo"}}, "text": "Args:\n            table_name: Nome da tabela\n\n        Returns:\n            Dict com schema da tabela ou None se n\u00e3o encontrada\n        \"\"\"\n        return self._get_expected_schema(table_name)\n\n    def list_required_columns(self, table_name: str) -> List[str]:\n        \"\"\"\n        Lista as colunas obrigat\u00f3rias de uma tabela.\n\n        Args:\n            table_name: Nome da tabela\n\n        Returns:\n            Lista de nomes de colunas obrigat\u00f3rias\n        \"\"\"\n        schema = self._get_expected_schema(table_name)\n        if schema is None:\n            return []\n\n        return list(schema.get('columns', {}).keys())\n\n    def validate_query_columns(self, table_name: str, query_columns: List[str]) -> Tuple[bool, List[str]]:\n        \"\"\"\n        Valida se as colunas de uma query existem no schema.\n\n        Args:\n            table_name: Nome da tabela\n            query_columns: Lista de colunas usadas na query\n\n        Returns:\n            Tupla (is_valid, invalid_columns)\n        \"\"\"\n        schema = self._get_expected_schema(table_name)\n        if schema is None:\n            logger.warning(f\"Tabela '{table_name}' n\u00e3o encontrada no cat\u00e1logo\")\n            return True, []  # Assumir v\u00e1lido se tabela n\u00e3o est\u00e1 catalogada\n\n        valid_columns = set(schema.get('columns', {}).keys())\n        query_columns_set = set(query_columns)\n\n        invalid_columns = query_columns_set - valid_columns\n\n        is_valid = len(invalid_columns) == 0\n\n        return is_valid, list(invalid_columns)\n\n\n# Fun\u00e7\u00e3o auxiliar para valida\u00e7\u00e3o r\u00e1pida\ndef validate_parquet_schema(parquet_path: str, catalog_path: Optional[str] = None) -> Tuple[bool, List[str]]:\n    \"\"\"\n    Fun\u00e7\u00e3o auxiliar para valida\u00e7\u00e3o r\u00e1pida de schema Parquet.\n\n    Args:\n        parquet_path: Caminho para o arquivo Parquet\n        catalog_path: Caminho para o cat\u00e1logo (opcional)\n\n    Returns:\n        Tupla (is_valid, errors)\n    \"\"\"\n    validator = SchemaValidator(catalog_path)\n    return validator.validate_parquet_file(parquet_path)\n\n\nif __name__ == \"__main__\":\n    # Teste b\u00e1sico do validador\n    logging.basicConfig(level=logging.INFO)\n\n    # Exemplo de uso\n    validator = SchemaValidator()\n\n    # Validar arquivo de exemplo\n    test_file = Path(__file__).parent.parent.parent / \"data\" / \"parquet\" / \"produtos.parquet\"\n    if test_file.exists():\n        is_valid, errors = validator.validate_parquet_file(str(test_file))\n        print(f\"\\nValida\u00e7\u00e3o de {test_file.name}:\")\n        print(f\"V\u00e1lido: {is_valid}\")\n        if errors:\n            print(\"Erros:\")\n            for error in errors:\n                print(f\"  - {error}\")\n    else:\n        print(f\"Arquivo de teste n\u00e3o encontrado: {test_file}\")", "mimetype": "text/plain", "start_char_idx": 11384, "end_char_idx": 14046, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "58aa4eb7-4dfd-4d67-9bfa-116cf705c9b7": {"__data__": {"id_": "58aa4eb7-4dfd-4d67-9bfa-116cf705c9b7", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\visualization\\advanced_charts.py", "language": "python", "lines": 107, "filename": "advanced_charts.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9851deb0-e7de-4c86-b544-d9521b2fdaff", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\visualization\\advanced_charts.py", "language": "python", "lines": 107, "filename": "advanced_charts.py"}, "hash": "ec6fe53a6adca4f619a0aab1cf504a6a4997cbb08501930f0f4fd5234e72e767", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nM\u00f3dulo de Gr\u00e1ficos Avan\u00e7ados para Business Intelligence\nVers\u00e3o simplificada para Agent Solution BI\n\"\"\"\n\nimport pandas as pd\nimport plotly.express as px\nimport plotly.graph_objects as go\nimport logging\n\nlogger = logging.getLogger(__name__)\n\n\nclass AdvancedChartGenerator:\n    \"\"\"Gerador de gr\u00e1ficos avan\u00e7ados para an\u00e1lises de neg\u00f3cio.\"\"\"\n\n    def __init__(self):\n        \"\"\"Inicializa o gerador de gr\u00e1ficos.\"\"\"\n        self.color_palette = {\n            \"primary\": \"#1f77b4\",\n            \"secondary\": \"#ff7f0e\",\n            \"success\": \"#2ca02c\",\n            \"warning\": \"#d62728\",\n            \"info\": \"#9467bd\",\n        }\n\n    def create_product_ranking_chart(\n        self, df: pd.DataFrame, limit: int = 10, chart_type: str = \"horizontal_bar\"\n    ) -> go.Figure:\n        \"\"\"\n        Cria gr\u00e1fico de ranking de produtos.\n\n        Args:\n            df: DataFrame com dados de produtos\n            limit: N\u00famero de produtos no ranking\n            chart_type: Tipo do gr\u00e1fico\n\n        Returns:\n            Figura Plotly\n        \"\"\"\n        try:\n            # Assumir que df tem colunas relevantes\n            if df.empty:\n                logger.warning(\"DataFrame vazio para criar gr\u00e1fico\")\n                return go.Figure()\n\n            fig = px.bar(\n                df.head(limit),\n                title=f\"Top {limit} Produtos\",\n                color_discrete_sequence=[self.color_palette[\"primary\"]],\n            )\n\n            fig.update_layout(\n                template=\"plotly_white\",\n                showlegend=True,\n                height=500,\n            )\n\n            return fig\n\n        except Exception as e:\n            logger.error(f\"Erro ao criar gr\u00e1fico: {e}\")\n            return go.Figure()\n\n    def create_time_series_chart(self, df: pd.DataFrame) -> go.Figure:\n        \"\"\"Cria gr\u00e1fico de s\u00e9rie temporal.\"\"\"\n        try:\n            fig = px.line(\n                df,\n                title=\"Evolu\u00e7\u00e3o Temporal\",\n                markers=True,\n                color_discrete_sequence=[self.color_palette[\"secondary\"]],\n            )\n\n            fig.update_layout(\n                template=\"plotly_white\",\n                showlegend=True,\n                height=500,\n            )\n\n            return fig\n\n        except Exception as e:\n            logger.error(f\"Erro ao criar gr\u00e1fico temporal: {e}\")\n            return go.Figure()\n\n    def create_pie_chart(self, df: pd.DataFrame) -> go.Figure:\n        \"\"\"Cria gr\u00e1fico de pizza.\"\"\"\n        try:\n            fig = px.pie(\n                df,\n                title=\"Distribui\u00e7\u00e3o\",\n                hole=0.3,\n            )\n\n            fig.update_layout(\n                template=\"plotly_white\",\n                showlegend=True,\n                height=500,\n            )\n\n            return fig\n\n        except Exception as e:\n            logger.error(f\"Erro ao criar gr\u00e1fico de pizza: {e}\")\n            return go.Figure()", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2887, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "72cf6043-20f7-4c2e-a9fb-f01ac41350ce": {"__data__": {"id_": "72cf6043-20f7-4c2e-a9fb-f01ac41350ce", "embedding": null, "metadata": {"file_path": "backend\\app\\core\\visualization\\__init__.py", "language": "python", "lines": 2, "filename": "__init__.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "337e53a3-c540-47f3-80f9-6c691356ea9b", "node_type": "4", "metadata": {"file_path": "backend\\app\\core\\visualization\\__init__.py", "language": "python", "lines": 2, "filename": "__init__.py"}, "hash": "12951de4ded2fbce3e1903ec41cc39cbfa1c2230d0ae58158258a92e1b04df5d", "class_name": "RelatedNodeInfo"}}, "text": "# Visualization module", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 22, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "331b9e8e-7faf-46b7-8089-85ecf84b987c": {"__data__": {"id_": "331b9e8e-7faf-46b7-8089-85ecf84b987c", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\base.py", "language": "python", "lines": 34, "filename": "base.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d357f2a6-8e6c-4e2d-8856-fd2c94d167e5", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\base.py", "language": "python", "lines": 34, "filename": "base.py"}, "hash": "8287bbbddea5151e998a22997c53b47164f282172af4350d65f7ebe399c324ba", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nDatabase Adapter Interface\nAbstract Base Class for database adapters (Strategy Interface).\nAdapted for Async/FastAPI.\n\"\"\"\n\nfrom abc import ABC, abstractmethod\nfrom typing import Any, Dict, List\n\nclass DatabaseAdapter(ABC):\n    \"\"\"\n    Abstract Base Class for database adapters.\n    Defines the common contract for all database connectivity.\n    \"\"\"\n    @abstractmethod\n    async def connect(self) -> None:\n        \"\"\"Establishes a connection to the database.\"\"\"\n        pass\n\n    @abstractmethod\n    async def disconnect(self) -> None:\n        \"\"\"Closes the database connection.\"\"\"\n        pass\n\n    @abstractmethod\n    async def execute_query(self, query: Any) -> Any:\n        \"\"\"Executes a query and returns the results.\"\"\"\n        pass\n\n    @abstractmethod\n    async def get_schema(self) -> Any:\n        \"\"\"Returns the database schema information.\"\"\"\n        pass", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 870, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "bb62e80f-4fcb-4491-98ad-0364206f5422": {"__data__": {"id_": "bb62e80f-4fcb-4491-98ad-0364206f5422", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\dependency.py", "language": "python", "lines": 25, "filename": "dependency.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1b38f269-50a5-4c64-bc9b-83f445d36732", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\dependency.py", "language": "python", "lines": 25, "filename": "dependency.py"}, "hash": "6441902d914feab1ffb71d864b40b00dd658652cdac3bba51682f5f0cda0c969", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nData Adapter Dependency\nProvides the HybridDataAdapter instance to API endpoints.\n\"\"\"\n\nfrom typing import Annotated\nfrom fastapi import Depends, Request\n\nfrom app.infrastructure.data.hybrid_adapter import HybridDataAdapter\n\ndef get_data_adapter(request: Request) -> HybridDataAdapter:\n    \"\"\"\n    Dependency to get the HybridDataAdapter instance from app state.\n    The adapter is initialized in main.py lifespan.\n    \"\"\"\n    if not hasattr(request.app.state, \"data_adapter\"):\n        # Fallback if not initialized (e.g. during tests)\n        # But ideally should be initialized in lifespan\n        request.app.state.data_adapter = HybridDataAdapter()\n        \n    return request.app.state.data_adapter\n\n# Type alias for easier usage in endpoints\nDataAdapter = Annotated[HybridDataAdapter, Depends(get_data_adapter)]", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 820, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9ab63a13-8876-445d-8941-e45035b6327a": {"__data__": {"id_": "9ab63a13-8876-445d-8941-e45035b6327a", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\hybrid_adapter.py", "language": "python", "lines": 105, "filename": "hybrid_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "20d69657-d22e-4beb-8e97-03b91bc9ed8a", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\hybrid_adapter.py", "language": "python", "lines": 105, "filename": "hybrid_adapter.py"}, "hash": "fa49b598665a7db6413838d9f42164c5d9f630ed5b6668018b3e7c1199a48344", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nHybridDataAdapter: Adaptador h\u00edbrido com fallback autom\u00e1tico e inteligente.\nVers\u00e3o Async para FastAPI.\n\nPrioridade:\n1. SQL Server (se USE_SQL_SERVER=true e conex\u00e3o OK)\n2. Parquet (fallback sempre dispon\u00edvel)\n\"\"\"\n\nimport logging\nimport os\nimport asyncio\nfrom typing import Any, Dict, List, Optional\n\nfrom app.infrastructure.data.base import DatabaseAdapter\nfrom app.infrastructure.data.sql_server_adapter import SQLServerAdapter\nfrom app.infrastructure.data.parquet_adapter import ParquetAdapter\nfrom app.config.settings import settings\n\nlogger = logging.getLogger(__name__)\n\nclass HybridDataAdapter(DatabaseAdapter):\n    \"\"\"\n    Adapter h\u00edbrido com fallback autom\u00e1tico.\n    \"\"\"\n\n    def __init__(self):\n        \"\"\"Inicializa adapter com configura\u00e7\u00f5es do settings.py\"\"\"\n        # Flags de controle\n        self.use_sql_server = settings.USE_SQL_SERVER\n        self.sql_timeout = settings.SQL_SERVER_TIMEOUT\n        self.fallback_enabled = settings.FALLBACK_TO_PARQUET\n\n        # Status de conex\u00e3o\n        self.sql_available = False\n        self.current_source = \"parquet\"  # default seguro\n\n        # Adapters\n        self.sql_adapter: Optional[SQLServerAdapter] = None\n        self.parquet_adapter: Optional[ParquetAdapter] = None\n\n        # Inicializar adapters\n        self._init_adapters()\n\n        logger.info(f\"HybridDataAdapter inicializado - Fonte Inicial: {self.current_source}\")\n\n    def _init_adapters(self):\n        \"\"\"Inicializa adapters.\"\"\"\n        # 1. Inicializar Parquet (sempre necess\u00e1rio como fallback)\n        # Usar configura\u00e7\u00e3o centralizada do settings.py\n        parquet_path = settings.PARQUET_FILE_PATH\n        logger.info(f\"\ud83d\udcc2 Usando arquivo Parquet: {parquet_path}\")\n        self.parquet_adapter = ParquetAdapter(parquet_path)\n\n        # 2. Inicializar SQL Server se habilitado\n        if self.use_sql_server:\n            try:\n                # Settings j\u00e1 deve ter a string de conex\u00e3o configurada\n                self.sql_adapter = SQLServerAdapter(settings)\n                self.current_source = \"sql_server\" # Tentativa inicial\n            except Exception as e:\n                logger.error(f\"Erro ao configurar SQL Server Adapter: {e}\")\n                self.sql_available = False\n                self.current_source = \"parquet\"\n        else:\n            self.current_source = \"parquet\"\n\n    async def connect(self) -> None:\n        \"\"\"Tenta conectar ao SQL Server (apenas para check), mas garante Parquet para queries.\"\"\"\n        if self.use_sql_server and self.sql_adapter:\n            try:\n                # Tentar conectar com timeout apenas para garantir que o servi\u00e7o est\u00e1 de p\u00e9 se necess\u00e1rio\n                await asyncio.wait_for(self.sql_adapter.connect(), timeout=self.sql_timeout)\n                self.sql_available = True\n                # self.current_source = \"sql_server\" # REMOVIDO: For\u00e7ar Parquet como fonte de dados\n                logger.info(\"\u2705 Conectado ao SQL Server (Dispon\u00edvel para Sync/Auth).\")\n            except (asyncio.TimeoutError, Exception) as e:\n                logger.warning(f\"\u26a0\ufe0f Falha ao conectar SQL Server: {e}. Operando apenas com Parquet.\")\n                self.sql_available = False\n        \n        # Parquet \"conecta\" (lazy)\n        # Garantir que a fonte atual seja SEMPRE parquet para queries\n        self.current_source = \"parquet\"\n        await self.parquet_adapter.connect()\n\n    async def disconnect(self) -> None:\n        if self.sql_adapter:\n            await self.sql_adapter.disconnect()\n        if self.parquet_adapter:\n            await self.parquet_adapter.disconnect()\n\n    async def execute_query(self, query_filters: Dict[str, Any], **kwargs) -> List[Dict[str, Any]]:\n        \"\"\"\n        Executa query EXCLUSIVAMENTE no Parquet.\n        Aceita kwargs (ex: required_columns, query_text)\n        \"\"\"\n        if self.parquet_adapter:\n            return await self.parquet_adapter.execute_query(query_filters, **kwargs)\n        \n        return []\n\n    async def get_schema(self) -> str:\n        \"\"\"Retorna schema do Parquet.\"\"\"\n        return await self.parquet_adapter.get_schema()", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4070, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "aad0558b-391d-40d6-bef7-25a9b68ef48e": {"__data__": {"id_": "aad0558b-391d-40d6-bef7-25a9b68ef48e", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\parquet_adapter.py", "language": "python", "lines": 39, "filename": "parquet_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "8b235e2c-da4f-41a5-a1a6-3217968dd14d", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\parquet_adapter.py", "language": "python", "lines": 39, "filename": "parquet_adapter.py"}, "hash": "68ea1745508fed45c8b22ad8b297ca31d1b066ab39a0c99e8a4c35bb5f45b164", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nParquetAdapter: Adaptador para arquivos Parquet.\nVers\u00e3o Async para FastAPI.\n\"\"\"\n\nimport logging\nfrom typing import Any, Dict, List, Optional\n\nfrom app.infrastructure.data.base import DatabaseAdapter\nfrom app.infrastructure.data.polars_dask_adapter import PolarsDaskAdapter\n\nlogger = logging.getLogger(__name__)\n\nclass ParquetAdapter(DatabaseAdapter):\n    \"\"\"\n    Adapter for Parquet files usando PolarsDaskAdapter (h\u00edbrido Polars+Dask).\n    Async wrapper.\n    \"\"\"\n\n    def __init__(self, file_path: str):\n        self.file_path = file_path\n        self._hybrid = PolarsDaskAdapter(file_path)\n        logger.info(f\"ParquetAdapter initialized with PolarsDaskAdapter\")\n\n    async def connect(self) -> None:\n        await self._hybrid.connect()\n\n    async def disconnect(self) -> None:\n        await self._hybrid.disconnect()\n\n    async def execute_query(self, query_filters: Dict[str, Any], **kwargs) -> List[Dict[str, Any]]:\n        \"\"\"\n        Executa query usando PolarsDaskAdapter (h\u00edbrido).\n        \"\"\"\n        return await self._hybrid.execute_query(query_filters, **kwargs)\n\n    async def get_schema(self) -> str:\n        return await self._hybrid.get_schema()", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1168, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "612f0646-d7fb-4826-929f-d504f68d2439": {"__data__": {"id_": "612f0646-d7fb-4826-929f-d504f68d2439", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b257e43a-66b1-4df6-be67-3150de4be004", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "hash": "4bfdca8fb03180d22329965bba19939a57734bb861cb8506342cd0ef88b7678b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "4b9b7d8a-c51c-43c4-af6d-e596e33cf7c6", "node_type": "1", "metadata": {}, "hash": "0ba9f5abb3be6aaab7c798c7b1bc7b454ea0bf3dcfa2bd24738cdd5dc0a15f13", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nPolarsDaskAdapter: Adaptador inteligente que escolhe automaticamente entre Polars e Dask.\nAdaptado para Backend FastAPI (Async).\n\nDecis\u00e3o autom\u00e1tica baseada em tamanho do arquivo:\n- Arquivos < 500MB: Polars (8.1x mais r\u00e1pido)\n- Arquivos >= 500MB: Dask (escal\u00e1vel, out-of-core)\n\nRecursos:\n- Fallback autom\u00e1tico Polars \u2192 Dask em caso de erro\n- Valida\u00e7\u00e3o de integridade de dados\n- Logging detalhado de decis\u00f5es\n- Feature flag para desabilitar Polars (POLARS_ENABLED=false)\n- Execu\u00e7\u00e3o ass\u00edncrona (run_in_executor) para n\u00e3o bloquear event loop\n\nAutor: Claude Code\nData: 2025-10-20 (Portado para Backend em 2025-11-23)\n\"\"\"\n\nimport logging\nimport os\nimport re\nimport time\nimport asyncio\nfrom concurrent.futures import ThreadPoolExecutor\nfrom typing import Any, Dict, List, Optional\nimport pandas as pd\nimport dask.dataframe as dd\n\n# Import condicional do Polars (fallback para Dask se n\u00e3o dispon\u00edvel)\ntry:\n    import polars as pl\n    POLARS_AVAILABLE = True\nexcept ImportError as e:\n    POLARS_AVAILABLE = False\n    pl = None\nexcept Exception as e:\n    POLARS_AVAILABLE = False\n    pl = None\n\nfrom app.infrastructure.data.base import DatabaseAdapter\nfrom app.infrastructure.data.utils.column_validator import (\n    validate_columns,\n    ColumnValidationError,\n    get_available_columns_cached\n)\n\nlogger = logging.getLogger(__name__)\n\nclass PolarsDaskAdapter(DatabaseAdapter):\n    \"\"\"\n    Adaptador h\u00edbrido que escolhe automaticamente entre Polars (r\u00e1pido) e Dask (escal\u00e1vel).\n    Vers\u00e3o Async para FastAPI.\n    \"\"\"\n\n    # Configura\u00e7\u00f5es (podem ser sobrescritas por env vars)\n    POLARS_THRESHOLD_MB = int(os.getenv(\"POLARS_THRESHOLD_MB\", \"500\"))\n    POLARS_ENABLED = os.getenv(\"POLARS_ENABLED\", \"true\").lower() == \"true\"\n    FORCE_DASK = os.getenv(\"FORCE_DASK\", \"false\").lower() == \"true\"\n\n    def __init__(self, file_path: str):\n        \"\"\"\n        Inicializa o PolarsDaskAdapter.\n\n        Args:\n            file_path: Caminho para arquivo(s) Parquet (suporta wildcards)\n        \"\"\"\n        # Valida\u00e7\u00e3o do arquivo (mesma l\u00f3gica do ParquetAdapter)\n        if \"*\" not in file_path and not os.path.exists(file_path):\n            # Tentar encontrar no diret\u00f3rio data/parquet relativo ao backend\n            base_path = os.getcwd()\n            alt_path = os.path.join(base_path, \"data\", \"parquet\", os.path.basename(file_path))\n            if os.path.exists(alt_path):\n                file_path = alt_path\n            else:\n                # Se ainda n\u00e3o achou, tentar caminho absoluto se fornecido\n                pass\n                \n        if \"*\" not in file_path and not os.path.exists(file_path):\n             # Permitir inicializa\u00e7\u00e3o mesmo sem arquivo (ser\u00e1 validado na query ou reconex\u00e3o)\n             # Mas logar aviso\n             logger.warning(f\"Parquet file not found at init: {file_path}\")\n\n        self.file_path = file_path\n        self.size_mb = self._get_file_size_mb()\n        self.engine = self._select_engine()\n        self._executor = ThreadPoolExecutor(max_workers=4)\n\n        logger.info(f\"PolarsDaskAdapter initialized:\")\n        logger.info(f\"  File: {file_path}\")\n        logger.info(f\"  Size: {self.size_mb:.1f} MB\")\n        logger.info(f\"  Engine: {self.engine.upper()}\")\n\n    def _get_file_size_mb(self) -> float:\n        \"\"\"Calcula tamanho total do(s) arquivo(s) em MB.\"\"\"\n        import glob\n\n        try:\n            if \"*\" in self.file_path:\n                files = glob.glob(self.file_path)\n            else:\n                files = [self.file_path]\n\n            total_size = sum(os.path.getsize(f) for f in files if os.path.exists(f))\n            return total_size / (1024 ** 2)\n        except Exception:\n            return 0.0\n\n    def _select_engine(self) -> str:\n        \"\"\"Seleciona engine automaticamente.\"\"\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3741, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "4b9b7d8a-c51c-43c4-af6d-e596e33cf7c6": {"__data__": {"id_": "4b9b7d8a-c51c-43c4-af6d-e596e33cf7c6", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b257e43a-66b1-4df6-be67-3150de4be004", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "hash": "4bfdca8fb03180d22329965bba19939a57734bb861cb8506342cd0ef88b7678b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "612f0646-d7fb-4826-929f-d504f68d2439", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "hash": "c2ca5adfa1e5262348ae06a8cff0156b90f1b386efa54761a5b14b58e71f4bc5", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c6ed794f-96d9-418f-9360-1c5d2f670019", "node_type": "1", "metadata": {}, "hash": "94b168a3ffdfc3776c54f43b201e9ca02332a34a6f04c655b49c13972df5aa7a", "class_name": "RelatedNodeInfo"}}, "text": "import glob\n\n        try:\n            if \"*\" in self.file_path:\n                files = glob.glob(self.file_path)\n            else:\n                files = [self.file_path]\n\n            total_size = sum(os.path.getsize(f) for f in files if os.path.exists(f))\n            return total_size / (1024 ** 2)\n        except Exception:\n            return 0.0\n\n    def _select_engine(self) -> str:\n        \"\"\"Seleciona engine automaticamente.\"\"\"\n        if not POLARS_AVAILABLE:\n            return \"dask\"\n        if self.FORCE_DASK:\n            return \"dask\"\n        if not self.POLARS_ENABLED:\n            return \"dask\"\n        if self.size_mb < self.POLARS_THRESHOLD_MB:\n            return \"polars\"\n        else:\n            return \"dask\"\n\n    async def connect(self) -> None:\n        \"\"\"No-op. Ambos engines usam lazy loading.\"\"\"\n        pass\n\n    async def disconnect(self) -> None:\n        \"\"\"No-op.\"\"\"\n        pass\n\n    async def execute_query(self, query_filters: Dict[str, Any], query_text: str = None, required_columns: Optional[List[str]] = None) -> List[Dict[str, Any]]:\n        \"\"\"\n        Executa query de forma ass\u00edncrona (em threadpool).\n        \"\"\"\n        loop = asyncio.get_event_loop()\n        return await loop.run_in_executor(\n            self._executor,\n            self._execute_sync,\n            query_filters,\n            query_text,\n            required_columns\n        )\n\n    def _execute_sync(self, query_filters: Dict[str, Any], query_text: str = None, required_columns: Optional[List[str]] = None) -> List[Dict[str, Any]]:\n        \"\"\"Implementa\u00e7\u00e3o s\u00edncrona da query (executada no threadpool).\"\"\"\n        logger.info(f\"PolarsDaskAdapter.execute_query() com {len(query_filters)} filtro(s)\")\n\n        if not query_filters:\n            return [{\"error\": \"A consulta \u00e9 muito ampla. Adicione filtros.\"}]\n\n        start_time = time.time()\n\n        try:\n            if self.engine == \"polars\":\n                result = self._execute_polars(query_filters, query_text, required_columns)\n            else:\n                result = self._execute_dask(query_filters, query_text, required_columns)\n\n            elapsed = time.time() - start_time\n            logger.info(f\"Query executada: {len(result)} rows em {elapsed:.2f}s ({self.engine.upper()})\")\n            return result\n\n        except Exception as e:\n            logger.error(f\"Erro com {self.engine.upper()}: {e}\", exc_info=True)\n            # Fallback logic (simplificada para brevidade, mas mantendo robustez)\n            if self.engine == \"polars\":\n                logger.warning(\"Fallback: Polars falhou, tentando Dask...\")\n                try:\n                    return self._execute_dask(query_filters, query_text)\n                except Exception as dask_err:\n                    logger.error(f\"Fallback Dask falhou: {dask_err}\")\n            \n            return [{\"error\": f\"Falha na execu\u00e7\u00e3o: {str(e)}\"}]\n\n    def _execute_polars(self, query_filters: Dict[str, Any], query_text: str = None, required_columns: Optional[List[str]] = None) -> List[Dict[str, Any]]:\n        \"\"\"Executa query usando Polars.\"\"\"", "mimetype": "text/plain", "start_char_idx": 3304, "end_char_idx": 6385, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c6ed794f-96d9-418f-9360-1c5d2f670019": {"__data__": {"id_": "c6ed794f-96d9-418f-9360-1c5d2f670019", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b257e43a-66b1-4df6-be67-3150de4be004", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "hash": "4bfdca8fb03180d22329965bba19939a57734bb861cb8506342cd0ef88b7678b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "4b9b7d8a-c51c-43c4-af6d-e596e33cf7c6", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "hash": "7f65dca6ca774d8d5ebdda803d62938d55453392f857834ff26870c8690a02d3", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3876ded9-df10-4f8c-8f59-ecbde9f99020", "node_type": "1", "metadata": {}, "hash": "2cffc1dda3dc105f26cbaf320c56b97a2f3b5388d6f3f2eae261c25f26e5ac2f", "class_name": "RelatedNodeInfo"}}, "text": "# ... (L\u00f3gica id\u00eantica ao original, simplificada aqui para caber no arquivo)\n        # A l\u00f3gica completa de filtros e convers\u00e3o deve ser mantida\n        # Copiando a l\u00f3gica principal:\n        \n        lf = pl.scan_parquet(\n            self.file_path,\n            allow_missing_columns=True,\n            extra_columns='ignore',\n            glob=True\n        )\n\n        # Adicionar colunas padr\u00e3o se ausentes\n        schema = lf.collect_schema()\n        expected_columns = {'linha_verde': 0, 'une_id': 'N/A'}\n        cols_to_add = []\n        for col, default_val in expected_columns.items():\n            if col not in schema.names():\n                cols_to_add.append(pl.lit(default_val).alias(col))\n        if cols_to_add:\n            lf = lf.with_columns(cols_to_add)\n\n        # Valida\u00e7\u00e3o de colunas\n        available_columns = list(schema.names())\n        filter_columns = list(query_filters.keys())\n        \n        try:\n            validation_result = validate_columns(filter_columns, available_columns, auto_correct=True)\n            if not validation_result[\"all_valid\"]:\n                raise ColumnValidationError(validation_result[\"invalid\"][0], validation_result[\"suggestions\"].get(validation_result[\"invalid\"][0], []), available_columns)\n            \n            column_mapping = {col: col for col in filter_columns}\n            column_mapping.update(validation_result[\"corrected\"])\n        except Exception as e:\n            logger.warning(f\"Erro valida\u00e7\u00e3o colunas: {e}\")\n            column_mapping = {col: col for col in filter_columns}\n\n        # Aplicar filtros\n        string_filters = []\n        numeric_filters = []\n        NUMERIC_COLS = ['estoque_une', 'ESTOQUE_UNE', 'estoque_atual']\n\n        for column, condition in query_filters.items():\n            actual_column = column_mapping.get(column, column)\n            \n            # Fallback case-insensitive\n            if actual_column not in schema.names():\n                for c in schema.names():\n                    if c.lower() == actual_column.lower():\n                        actual_column = c\n                        break\n            \n            op = '='\n            value = condition\n            \n            # Parse condition string (>=, <=, etc)\n            if isinstance(condition, str) and any(o in condition for o in ['>=', '<=', '!=', '>', '<', '=']):\n                match = re.match(r\"(>=|<=|!=|>|<|=)\\s*(.*)\", str(condition))\n                if match:\n                    op, value_str = match.groups()\n                    op = op.strip()\n                    value_str = value_str.strip().strip(\"'\\\"\")\n                    \n                    if actual_column.lower() in [c.lower() for c in NUMERIC_COLS] and op in ['>=', '<=', '>', '<']:\n                        try:\n                            val = float(value_str) if '.'", "mimetype": "text/plain", "start_char_idx": 6394, "end_char_idx": 9210, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3876ded9-df10-4f8c-8f59-ecbde9f99020": {"__data__": {"id_": "3876ded9-df10-4f8c-8f59-ecbde9f99020", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b257e43a-66b1-4df6-be67-3150de4be004", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "hash": "4bfdca8fb03180d22329965bba19939a57734bb861cb8506342cd0ef88b7678b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c6ed794f-96d9-418f-9360-1c5d2f670019", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "hash": "483bb40fcd1a5cadd9a1cb29553687886ec3a2286adc5f3bb75b7e1cb8fc5f6c", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "7d7cbdd7-b024-4630-96b1-79a833222298", "node_type": "1", "metadata": {}, "hash": "cf9f4116843076e8c1f3836e461f650909efc115ab34e8efdc8126dc1520c45f", "class_name": "RelatedNodeInfo"}}, "text": "*)\", str(condition))\n                if match:\n                    op, value_str = match.groups()\n                    op = op.strip()\n                    value_str = value_str.strip().strip(\"'\\\"\")\n                    \n                    if actual_column.lower() in [c.lower() for c in NUMERIC_COLS] and op in ['>=', '<=', '>', '<']:\n                        try:\n                            val = float(value_str) if '.' in value_str else int(value_str)\n                            numeric_filters.append((actual_column, op, val))\n                            continue\n                        except: pass\n                    value = value_str\n\n            # Converter tipos se necess\u00e1rio (Polars strict)\n            col_dtype = schema.get(actual_column)\n            if col_dtype and POLARS_AVAILABLE:\n                dtype_str = str(col_dtype).lower()\n                if 'int' in dtype_str and isinstance(value, str) and value.isdigit():\n                    value = int(value)\n                elif 'float' in dtype_str and isinstance(value, str):\n                    try: value = float(value)\n                    except: pass\n\n            string_filters.append((actual_column, op, value))\n\n        # Aplicar filtros string\n        for col, op, val in string_filters:\n            if op == '=': lf = lf.filter(pl.col(col) == val)\n            elif op == '!=': lf = lf.filter(pl.col(col) != val)\n            elif op == '>': lf = lf.filter(pl.col(col) > val)\n            elif op == '<': lf = lf.filter(pl.col(col) < val)\n            elif op == '>=': lf = lf.filter(pl.col(col) >= val)\n            elif op == '<=': lf = lf.filter(pl.col(col) <= val)\n\n        # Converter colunas num\u00e9ricas\n        for col in NUMERIC_COLS:\n            if col in schema.names():\n                lf = lf.with_columns(pl.col(col).cast(pl.Float64, strict=False).fill_null(0))\n\n        # Vendas\n        vendas_cols = [f'mes_{i:02d}' for i in range(1, 13)]\n        existing_vendas = [c for c in vendas_cols if c in schema.names()]\n        if existing_vendas:\n            for col in existing_vendas:\n                lf = lf.with_columns(pl.col(col).cast(pl.Float64, strict=False).fill_null(0))\n            lf = lf.with_columns(pl.sum_horizontal(existing_vendas).alias('vendas_total'))\n\n        # Aplicar filtros num\u00e9ricos\n        for col, op, val in numeric_filters:\n            if op == '>=': lf = lf.filter(pl.col(col) >= val)\n            elif op == '<=': lf = lf.filter(pl.col(col) <= val)\n            elif op == '>': lf = lf.filter(pl.col(col) > val)\n            elif op == '<': lf = lf.filter(pl.col(col) < val)\n            elif op == '=': lf = lf.filter(pl.col(col) == val)\n\n        # Otimiza\u00e7\u00e3o de colunas\n        if required_columns:\n            final_cols = [c for c in required_columns if c in schema.names()]\n            if final_cols:\n                lf = lf.select(final_cols)\n        elif query_text:\n            try:\n                from app.infrastructure.data.utils.query_optimizer import get_optimized_columns\n                opt_cols = get_optimized_columns(list(schema.names()), query=query_text)\n                if opt_cols:\n                    lf = lf.select(opt_cols)\n            except: pass\n\n        # Collect\n        df_polars = lf.collect(engine=\"streaming\")\n        return df_polars.to_pandas().to_dict(orient=\"records\")\n\n    def _execute_dask(self, query_filters: Dict[str, Any], query_text: str = None, required_columns: Optional[List[str]] = None) -> List[Dict[str, Any]]:\n        \"\"\"Executa query usando Dask.\"\"\"\n        # Implementa\u00e7\u00e3o simplificada do Dask para brevidade\n        # Em produ\u00e7\u00e3o, usar a implementa\u00e7\u00e3o completa do core\n        try:\n            ddf = dd.read_parquet(self.file_path, engine='pyarrow')\n            \n            # Filtros simples\n            for col, val in query_filters.items():\n                if col in ddf.columns:\n                    ddf = ddf[ddf[col] == val]\n            \n            if required_columns:\n                cols = [c for c in required_columns if c in ddf.columns]\n                if cols:\n                    ddf = ddf[cols]\n            \n            return ddf.compute().to_dict(orient=\"records\")\n        except Exception as e:\n            logger.error(f\"Dask error: {e}\")\n            raise\n\n    async def get_schema(self) -> str:\n        \"\"\"Retorna schema do Parquet.\"\"\"", "mimetype": "text/plain", "start_char_idx": 8790, "end_char_idx": 13112, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7d7cbdd7-b024-4630-96b1-79a833222298": {"__data__": {"id_": "7d7cbdd7-b024-4630-96b1-79a833222298", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b257e43a-66b1-4df6-be67-3150de4be004", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "hash": "4bfdca8fb03180d22329965bba19939a57734bb861cb8506342cd0ef88b7678b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3876ded9-df10-4f8c-8f59-ecbde9f99020", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}, "hash": "8a756234ade488938e967c85fd481d2daee6b1e92d68e9908661fef473c6c041", "class_name": "RelatedNodeInfo"}}, "text": "# Implementa\u00e7\u00e3o simplificada do Dask para brevidade\n        # Em produ\u00e7\u00e3o, usar a implementa\u00e7\u00e3o completa do core\n        try:\n            ddf = dd.read_parquet(self.file_path, engine='pyarrow')\n            \n            # Filtros simples\n            for col, val in query_filters.items():\n                if col in ddf.columns:\n                    ddf = ddf[ddf[col] == val]\n            \n            if required_columns:\n                cols = [c for c in required_columns if c in ddf.columns]\n                if cols:\n                    ddf = ddf[cols]\n            \n            return ddf.compute().to_dict(orient=\"records\")\n        except Exception as e:\n            logger.error(f\"Dask error: {e}\")\n            raise\n\n    async def get_schema(self) -> str:\n        \"\"\"Retorna schema do Parquet.\"\"\"\n        loop = asyncio.get_event_loop()\n        return await loop.run_in_executor(self._executor, self._get_schema_sync)\n\n    def _get_schema_sync(self) -> str:\n        try:\n            import pyarrow.parquet as pq\n            parquet_file = pq.ParquetFile(self.file_path)\n            schema = parquet_file.schema_arrow\n            schema_str = \"Parquet Schema (via PyArrow):\\n\"\n            for i in range(len(schema)):\n                field = schema.field(i)\n                schema_str += f\"  - {field.name}: {field.type}\\n\"\n            return schema_str\n        except Exception as e:\n            return f\"Error reading schema: {e}\"", "mimetype": "text/plain", "start_char_idx": 12312, "end_char_idx": 13747, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a0a8dfa2-2daa-4c1e-a72e-1185c486fe96": {"__data__": {"id_": "a0a8dfa2-2daa-4c1e-a72e-1185c486fe96", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\sql_server_adapter.py", "language": "python", "lines": 114, "filename": "sql_server_adapter.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9708101b-ad08-43dd-85ef-86d69891d93b", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\sql_server_adapter.py", "language": "python", "lines": 114, "filename": "sql_server_adapter.py"}, "hash": "268f04d1d0b905fdc181a7932cc43c302cbd53753740c84cb505302006a06008", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSQLServerAdapter: Adaptador para Microsoft SQL Server usando aioodbc (Async).\n\"\"\"\n\nimport logging\nimport aioodbc\nfrom typing import Any, Dict, List, Optional\n\nfrom app.infrastructure.data.base import DatabaseAdapter\n\nlogger = logging.getLogger(__name__)\n\nclass SQLServerAdapter(DatabaseAdapter):\n    \"\"\"Concrete implementation of the adapter for Microsoft SQL Server (Async).\"\"\"\n\n    def __init__(self, settings: Any):\n        self._settings = settings\n        self._pool = None\n        # Connection string deve ser compat\u00edvel com aioodbc (geralmente a mesma do pyodbc)\n        self._dsn = settings.PYODBC_CONNECTION_STRING\n\n    async def connect(self) -> None:\n        \"\"\"\n        Establishes connection pool.\n        aioodbc recommends using a pool.\n        \"\"\"\n        if not self._pool:\n            try:\n                logger.info(\"Attempting to connect to SQL Server (aioodbc)...\")\n                # Criar pool de conex\u00f5es\n                self._pool = await aioodbc.create_pool(dsn=self._dsn, minsize=1, maxsize=10, autocommit=True)\n                logger.info(\"SQL Server connection pool created successfully.\")\n            except Exception as ex:\n                logger.error(f\"SQL Server connection failed: {ex}\", exc_info=True)\n                raise\n\n    async def disconnect(self) -> None:\n        \"\"\"Closes the connection pool.\"\"\"\n        if self._pool:\n            self._pool.close()\n            await self._pool.wait_closed()\n            self._pool = None\n            logger.info(\"SQL Server connection pool closed.\")\n\n    async def execute_query(self, query: str) -> List[Dict[str, Any]]:\n        \"\"\"Executes a SQL query asynchronously.\"\"\"\n        if not self._pool:\n            await self.connect()\n        \n        async with self._pool.acquire() as conn:\n            async with conn.cursor() as cursor:\n                logger.debug(f\"Executing query: {query}\")\n                await cursor.execute(query)\n                \n                if cursor.description:\n                    columns = [column[0] for column in cursor.description]\n                    rows = await cursor.fetchall()\n                    results = [dict(zip(columns, row)) for row in rows]\n                    logger.debug(f\"Query returned {len(results)} rows.\")\n                    return results\n                else:\n                    return []\n\n    async def get_schema(self) -> str:\n        \"\"\"\n        Inspeciona o banco de dados e gera uma string DDL (CREATE TABLE).\n        \"\"\"\n        if not self._pool:\n            await self.connect()\n\n        schema_ddl = \"\"\n        \n        # Query para pegar tabelas\n        tables_query = \"\"\"\n        SELECT TABLE_SCHEMA, TABLE_NAME \n        FROM INFORMATION_SCHEMA.TABLES \n        WHERE TABLE_TYPE = 'BASE TABLE'\n        \"\"\"\n        \n        try:\n            tables = await self.execute_query(tables_query)\n            \n            for table in tables:\n                schema = table['TABLE_SCHEMA']\n                name = table['TABLE_NAME']\n                \n                columns_query = f\"\"\"\n                SELECT COLUMN_NAME, DATA_TYPE, CHARACTER_MAXIMUM_LENGTH, IS_NULLABLE\n                FROM INFORMATION_SCHEMA.COLUMNS\n                WHERE TABLE_NAME = '{name}' AND TABLE_SCHEMA = '{schema}'\n                \"\"\"\n                \n                columns = await self.execute_query(columns_query)\n                \n                ddl = f\"CREATE TABLE {schema}.{name} (\\n\"\n                col_defs = []\n                for col in columns:\n                    col_def = f\"  {col['COLUMN_NAME']} {col['DATA_TYPE']}\"\n                    if col['CHARACTER_MAXIMUM_LENGTH']:\n                        col_def += f\"({col['CHARACTER_MAXIMUM_LENGTH']})\"\n                    if col['IS_NULLABLE'] == 'NO':\n                        col_def += \" NOT NULL\"\n                    col_defs.append(col_def)\n                \n                ddl += \",\\n\".join(col_defs)\n                ddl += \"\\n);\\n\\n\"\n                schema_ddl += ddl\n                \n            return schema_ddl\n            \n        except Exception as e:\n            logger.error(f\"Error getting schema: {e}\")\n            return f\"Error getting schema: {e}\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4161, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "802d2599-9478-45a3-943b-5614bdd226be": {"__data__": {"id_": "802d2599-9478-45a3-943b-5614bdd226be", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "08098e45-63d2-47c0-bb1a-f63a21099f39", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "hash": "3b5b780b27405c6c8ef94ab478c16d6a8aeaa16dd4bceedf9e5c323319ee7a27", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "46b0b898-3aa9-41b1-aaac-a781b978fe8e", "node_type": "1", "metadata": {}, "hash": "8e88195c8ca3ee6719655a51f1be44fc315d9d1a1f43bd097572e4cf37795eae", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nMapeamento Oficial de Colunas do Parquet\nSistema: Agent_Solution_BI\nData: 2025-10-25\n\nEste m\u00f3dulo cont\u00e9m o mapeamento entre nomes legados (c\u00f3digo antigo) e nomes reais\ndas colunas do Parquet. Usado para normalizar queries e evitar erros de KeyError.\n\nFONTE: Extra\u00eddo diretamente do Parquet real (97 colunas)\n\"\"\"\n\n# ==================== MAPEAMENTO PRINCIPAL ====================\n# Mapeamento: Nome Legado \u2192 Nome Real no Parquet\nCOLUMN_MAP = {\n    # Colunas b\u00e1sicas do produto\n    \"PRODUTO\": \"codigo\",\n    \"CODIGO\": \"codigo\",\n    \"NOME\": \"nome_produto\",\n    \"NOME_PRODUTO\": \"nome_produto\",\n\n    # UNE\n    \"UNE\": \"une\",\n    \"UNE_NOME\": \"une_nome\",\n    \"NOMEUNE\": \"une_nome\",\n\n    # Classifica\u00e7\u00f5es\n    \"NOMESEGMENTO\": \"nomesegmento\",\n    \"SEGMENTO\": \"nomesegmento\",\n    \"NOMEGRUPO\": \"nomegrupo\",\n    \"GRUPO\": \"nomegrupo\",\n    \"NOMECATEGORIA\": \"NOMECATEGORIA\",  # J\u00e1 est\u00e1 MAI\u00daSCULO no Parquet\n    \"CATEGORIA\": \"NOMECATEGORIA\",\n    \"NOMESUBGRUPO\": \"NOMESUBGRUPO\",  # J\u00e1 est\u00e1 MAI\u00daSCULO no Parquet\n    \"SUBGRUPO\": \"NOMESUBGRUPO\",\n    \"NOMEFABRICANTE\": \"NOMEFABRICANTE\",  # J\u00e1 est\u00e1 MAI\u00daSCULO no Parquet\n    \"FABRICANTE\": \"NOMEFABRICANTE\",\n\n    # Vendas\n    \"VENDA_30DD\": \"venda_30_d\",\n    \"VENDA_30D\": \"venda_30_d\",\n    \"VENDA_30_DIAS\": \"venda_30_d\",\n    \"VENDAS_30D\": \"venda_30_d\",\n\n    # Estoque (5 varia\u00e7\u00f5es)\n    \"ESTOQUE\": \"estoque_atual\",  # Padr\u00e3o\n    \"ESTOQUE_UNE\": \"estoque_atual\",\n    \"ESTOQUE_ATUAL\": \"estoque_atual\",\n    \"ESTOQUE_LV\": \"estoque_lv\",\n    \"ESTOQUE_LINHA_VERDE\": \"estoque_lv\",\n    \"ESTOQUE_CD\": \"estoque_cd\",\n    \"ESTOQUE_GONDOLA\": \"estoque_gondola_lv\",\n    \"ESTOQUE_ILHA\": \"estoque_ilha_lv\",\n\n    # Pre\u00e7os\n    \"LIQUIDO_38\": \"preco_38_percent\",\n    \"PRECO_38\": \"preco_38_percent\",\n    \"PRECO_LIQUIDO_38\": \"preco_38_percent\",\n    \"PRECO\": \"preco_38_percent\",\n\n    # M\u00e9dias\n    \"MC\": \"media_considerada_lv\",\n    \"MEDIA\": \"media_considerada_lv\",\n    \"MEDIA_CONSIDERADA\": \"media_considerada_lv\",\n    \"MEDIA_CONSIDERADA_LV\": \"media_considerada_lv\",\n    \"MEDIA_TRAVADA\": \"media_travada\",\n\n    # ABC (Classifica\u00e7\u00e3o)\n    \"ABC_UNE_30DD\": \"abc_une_30_dd\",\n    \"ABC_30D\": \"abc_une_30_dd\",\n    \"ABC_CACULA_90DD\": \"abc_cacula_90_dd\",\n    \"ABC_90D\": \"abc_cacula_90_dd\",\n\n    # Outros\n    \"EAN\": \"ean\",\n    \"EMBALAGEM\": \"embalagem\",\n    \"TIPO\": \"tipo\",\n    \"PROMOCIONAL\": \"promocional\",\n    \"FORALINHA\": \"foralinha\",\n}\n\n# ==================== MAPEAMENTO REVERSO ====================\n# Nome Real \u2192 Informa\u00e7\u00f5es da Coluna\nCOLUMN_INFO = {\n    \"codigo\": {\n        \"nome_legado\": [\"PRODUTO\", \"CODIGO\"],\n        \"descricao\": \"C\u00f3digo \u00fanico do produto\",\n        \"tipo\": \"int\",\n        \"exemplo\": \"704559\",\n        \"nullable\": False,", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2627, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "46b0b898-3aa9-41b1-aaac-a781b978fe8e": {"__data__": {"id_": "46b0b898-3aa9-41b1-aaac-a781b978fe8e", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "08098e45-63d2-47c0-bb1a-f63a21099f39", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "hash": "3b5b780b27405c6c8ef94ab478c16d6a8aeaa16dd4bceedf9e5c323319ee7a27", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "802d2599-9478-45a3-943b-5614bdd226be", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "hash": "3fe027ed5e39adf35fd46cdb2cd1c942250034ecaf24def9e542aa2b075ce3d3", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "7708cbed-c46d-4a56-a1fc-d8e23b1176c3", "node_type": "1", "metadata": {}, "hash": "9bb996fbc9d95eecc0863fe66f9cc56d95084cda0c13a1ac7a0c5d0c32b27f5d", "class_name": "RelatedNodeInfo"}}, "text": "\"ABC_30D\": \"abc_une_30_dd\",\n    \"ABC_CACULA_90DD\": \"abc_cacula_90_dd\",\n    \"ABC_90D\": \"abc_cacula_90_dd\",\n\n    # Outros\n    \"EAN\": \"ean\",\n    \"EMBALAGEM\": \"embalagem\",\n    \"TIPO\": \"tipo\",\n    \"PROMOCIONAL\": \"promocional\",\n    \"FORALINHA\": \"foralinha\",\n}\n\n# ==================== MAPEAMENTO REVERSO ====================\n# Nome Real \u2192 Informa\u00e7\u00f5es da Coluna\nCOLUMN_INFO = {\n    \"codigo\": {\n        \"nome_legado\": [\"PRODUTO\", \"CODIGO\"],\n        \"descricao\": \"C\u00f3digo \u00fanico do produto\",\n        \"tipo\": \"int\",\n        \"exemplo\": \"704559\",\n        \"nullable\": False,\n    },\n    \"nome_produto\": {\n        \"nome_legado\": [\"NOME\", \"NOME_PRODUTO\"],\n        \"descricao\": \"Nome completo do produto\",\n        \"tipo\": \"str\",\n        \"exemplo\": \"ALCA BOLSA 7337 DIAM.105MM PS MESCLADO 810\",\n        \"nullable\": False,\n    },\n    \"une\": {\n        \"nome_legado\": [\"UNE\"],\n        \"descricao\": \"C\u00f3digo da Unidade de Neg\u00f3cio\",\n        \"tipo\": \"int\",\n        \"exemplo\": \"2586\",\n        \"nullable\": False,\n    },\n    \"une_nome\": {\n        \"nome_legado\": [\"UNE_NOME\", \"NOMEUNE\"],\n        \"descricao\": \"Nome da UNE (ex: NIG, MAD, SCR)\",\n        \"tipo\": \"str\",\n        \"exemplo\": \"NIG\",\n        \"nullable\": False,\n    },\n    \"nomesegmento\": {\n        \"nome_legado\": [\"NOMESEGMENTO\", \"SEGMENTO\"],\n        \"descricao\": \"Segmento do produto\",\n        \"tipo\": \"str\",\n        \"exemplo\": \"ARMARINHO E CONFEC\u00c7\u00c3O\",\n        \"nullable\": False,\n    },\n    \"nomegrupo\": {\n        \"nome_legado\": [\"NOMEGRUPO\", \"GRUPO\"],\n        \"descricao\": \"Grupo do produto\",\n        \"tipo\": \"str\",\n        \"exemplo\": \"FERRAGEM\",\n        \"nullable\": True,\n    },\n    \"NOMECATEGORIA\": {\n        \"nome_legado\": [\"NOMECATEGORIA\", \"CATEGORIA\"],\n        \"descricao\": \"Categoria do produto\",\n        \"tipo\": \"str\",\n        \"exemplo\": \"ACABAMENTOS CONFEC\u00c7\u00c3O\",\n        \"nullable\": True,\n    },\n    \"NOMESUBGRUPO\": {\n        \"nome_legado\": [\"NOMESUBGRUPO\", \"SUBGRUPO\"],\n        \"descricao\": \"Subgrupo do produto\",\n        \"tipo\": \"str\",\n        \"exemplo\": \"SIMPLES\",\n        \"nullable\": True,\n    },\n    \"NOMEFABRICANTE\": {\n        \"nome_legado\": [\"NOMEFABRICANTE\", \"FABRICANTE\"],\n        \"descricao\": \"Nome do fabricante\",\n        \"tipo\": \"str\",\n        \"exemplo\": \"KR AVIAMENTOS\",\n        \"nullable\": True,\n    },\n    \"venda_30_d\": {\n        \"nome_legado\": [\"VENDA_30DD\", \"VENDA_30D\", \"VENDA_30_DIAS\"],\n        \"descricao\": \"Vendas dos \u00faltimos 30 dias (em unidades)\",\n        \"tipo\": \"float\",\n        \"exemplo\": \"2.5\",\n        \"nullable\": True,\n    },\n    \"estoque_atual\": {\n        \"nome_legado\": [\"ESTOQUE\", \"ESTOQUE_UNE\", \"ESTOQUE_ATUAL\"],\n        \"descricao\": \"Estoque atual total da UNE\",\n        \"tipo\": \"float\",\n        \"exemplo\": \"15.0\",\n        \"nullable\": True,\n    },\n    \"estoque_lv\": {\n        \"nome_legado\": [\"ESTOQUE_LV\", \"ESTOQUE_LINHA_VERDE\"],\n        \"descricao\": \"Estoque na Linha Verde (\u00e1rea de venda)\",\n        \"tipo\": \"float\",", "mimetype": "text/plain", "start_char_idx": 2069, "end_char_idx": 4956, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7708cbed-c46d-4a56-a1fc-d8e23b1176c3": {"__data__": {"id_": "7708cbed-c46d-4a56-a1fc-d8e23b1176c3", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "08098e45-63d2-47c0-bb1a-f63a21099f39", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "hash": "3b5b780b27405c6c8ef94ab478c16d6a8aeaa16dd4bceedf9e5c323319ee7a27", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "46b0b898-3aa9-41b1-aaac-a781b978fe8e", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "hash": "782ef5d977773df9a8b173f4aa8423a21129b21d548f70c5f9299d9405afa0d8", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f7bf6631-3fc8-49e5-b814-2c63e2d1f3d2", "node_type": "1", "metadata": {}, "hash": "41a78d16139c83179045407b402309f54f0817cbef2e626de0aef6f68128a315", "class_name": "RelatedNodeInfo"}}, "text": "\"VENDA_30D\", \"VENDA_30_DIAS\"],\n        \"descricao\": \"Vendas dos \u00faltimos 30 dias (em unidades)\",\n        \"tipo\": \"float\",\n        \"exemplo\": \"2.5\",\n        \"nullable\": True,\n    },\n    \"estoque_atual\": {\n        \"nome_legado\": [\"ESTOQUE\", \"ESTOQUE_UNE\", \"ESTOQUE_ATUAL\"],\n        \"descricao\": \"Estoque atual total da UNE\",\n        \"tipo\": \"float\",\n        \"exemplo\": \"15.0\",\n        \"nullable\": True,\n    },\n    \"estoque_lv\": {\n        \"nome_legado\": [\"ESTOQUE_LV\", \"ESTOQUE_LINHA_VERDE\"],\n        \"descricao\": \"Estoque na Linha Verde (\u00e1rea de venda)\",\n        \"tipo\": \"float\",\n        \"exemplo\": \"5.0\",\n        \"nullable\": True,\n    },\n    \"estoque_cd\": {\n        \"nome_legado\": [\"ESTOQUE_CD\"],\n        \"descricao\": \"Estoque no Centro de Distribui\u00e7\u00e3o\",\n        \"tipo\": \"float\",\n        \"exemplo\": \"100.0\",\n        \"nullable\": True,\n    },\n    \"preco_38_percent\": {\n        \"nome_legado\": [\"LIQUIDO_38\", \"PRECO_38\", \"PRECO\"],\n        \"descricao\": \"Pre\u00e7o l\u00edquido com 38% de margem\",\n        \"tipo\": \"float\",\n        \"exemplo\": \"12.99\",\n        \"nullable\": True,\n    },\n    \"media_considerada_lv\": {\n        \"nome_legado\": [\"MC\", \"MEDIA\", \"MEDIA_CONSIDERADA\"],\n        \"descricao\": \"M\u00e9dia de vendas considerada para reposi\u00e7\u00e3o\",\n        \"tipo\": \"float\",\n        \"exemplo\": \"2.3\",\n        \"nullable\": True,\n    },\n}\n\n# ==================== COLUNAS ESSENCIAIS ====================\n# Colunas m\u00ednimas necess\u00e1rias para an\u00e1lises b\u00e1sicas\nESSENTIAL_COLUMNS = [\n    'codigo',           # Identifica\u00e7\u00e3o do produto\n    'nome_produto',     # Nome do produto\n    'une',              # UNE (c\u00f3digo)\n    'une_nome',         # UNE (nome) - ESSENCIAL para rankings\n    'nomesegmento',     # Segmento\n    'NOMEFABRICANTE',   # Fabricante - ESSENCIAL para filtros de marca\n    'venda_30_d',       # Vendas\n    'estoque_atual',    # Estoque\n    'linha_verde',      # Linha Verde (Estoque M\u00e1ximo)\n    'quantidade_embalagem_master', # Quantidade de embalagem master\n    'quantidade_multiplo', # Quantidade m\u00faltiplo\n    'preco_38_percent', # Pre\u00e7o\n    'nomegrupo'         # Grupo\n]\n\n# ==================== FUN\u00c7\u00d5ES AUXILIARES ====================\n\ndef normalize_column_name(column_name: str) -> str:\n    \"\"\"\n    Normaliza nome de coluna (legado \u2192 real).\n\n    Args:\n        column_name: Nome da coluna (pode ser legado ou real)\n\n    Returns:\n        Nome real da coluna ou o pr\u00f3prio nome se n\u00e3o encontrado\n\n    Examples:\n        >>> normalize_column_name(\"PRODUTO\")\n        \"codigo\"\n        >>> normalize_column_name(\"VENDA_30DD\")\n        \"venda_30_d\"\n        >>> normalize_column_name(\"codigo\")\n        \"codigo\"\n    \"\"\"\n    # Se j\u00e1 \u00e9 um nome real, retornar\n    if column_name in COLUMN_INFO:\n        return column_name\n\n    # Tentar encontrar no mapeamento\n    upper_name = column_name.upper()\n    return COLUMN_MAP.get(upper_name, column_name)\n\n\ndef get_column_info(column_name: str) -> dict:\n    \"\"\"\n    Retorna informa\u00e7\u00f5es sobre uma coluna.\n\n    Args:\n        column_name: Nome da coluna (real ou legado)\n\n    Returns:\n        Dicion\u00e1rio com informa\u00e7\u00f5es ou None\n\n    Example:\n        >>> get_column_info(\"PRODUTO\")\n        {\"nome_legado\": [\"PRODUTO\"], \"descricao\": \"C\u00f3digo \u00fanico...\", ...}\n    \"\"\"\n    real_name = normalize_column_name(column_name)\n    return COLUMN_INFO.get(real_name)", "mimetype": "text/plain", "start_char_idx": 4380, "end_char_idx": 7640, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f7bf6631-3fc8-49e5-b814-2c63e2d1f3d2": {"__data__": {"id_": "f7bf6631-3fc8-49e5-b814-2c63e2d1f3d2", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "08098e45-63d2-47c0-bb1a-f63a21099f39", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "hash": "3b5b780b27405c6c8ef94ab478c16d6a8aeaa16dd4bceedf9e5c323319ee7a27", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "7708cbed-c46d-4a56-a1fc-d8e23b1176c3", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}, "hash": "e21d09183a321ec2d51526711ebb339b18f78f6552ecdccd3054c8a567beacb6", "class_name": "RelatedNodeInfo"}}, "text": "def get_column_info(column_name: str) -> dict:\n    \"\"\"\n    Retorna informa\u00e7\u00f5es sobre uma coluna.\n\n    Args:\n        column_name: Nome da coluna (real ou legado)\n\n    Returns:\n        Dicion\u00e1rio com informa\u00e7\u00f5es ou None\n\n    Example:\n        >>> get_column_info(\"PRODUTO\")\n        {\"nome_legado\": [\"PRODUTO\"], \"descricao\": \"C\u00f3digo \u00fanico...\", ...}\n    \"\"\"\n    real_name = normalize_column_name(column_name)\n    return COLUMN_INFO.get(real_name)\n\n\ndef validate_columns(columns: list, df_columns: list) -> dict:\n    \"\"\"\n    Valida se colunas existem no DataFrame.\n\n    Args:\n        columns: Lista de colunas a validar\n        df_columns: Lista de colunas dispon\u00edveis no DataFrame\n\n    Returns:\n        {\"valid\": [...], \"invalid\": [...], \"suggestions\": {...}}\n\n    Example:\n        >>> validate_columns([\"PRODUTO\", \"VENDA_30DD\"], df.columns)\n        {\"valid\": [\"codigo\", \"venda_30_d\"], \"invalid\": [], \"suggestions\": {}}\n    \"\"\"\n    valid = []\n    invalid = []\n    suggestions = {}\n\n    for col in columns:\n        normalized = normalize_column_name(col)\n\n        if normalized in df_columns:\n            valid.append(normalized)\n        else:\n            invalid.append(col)\n            # Sugerir colunas similares\n            similar = [c for c in df_columns if col.lower() in c.lower() or c.lower() in col.lower()]\n            if similar:\n                suggestions[col] = similar[:3]  # Top 3 sugest\u00f5es\n\n    return {\n        \"valid\": valid,\n        \"invalid\": invalid,\n        \"suggestions\": suggestions\n    }\n\n\ndef get_essential_columns() -> list:\n    \"\"\"\n    Retorna lista de colunas essenciais.\n\n    Returns:\n        Lista com nomes reais das colunas essenciais\n    \"\"\"\n    return ESSENTIAL_COLUMNS.copy()\n\n\ndef list_all_columns() -> list:\n    \"\"\"\n    Lista todas as colunas conhecidas com suas informa\u00e7\u00f5es.\n\n    Returns:\n        Lista de tuplas (nome_real, descricao)\n    \"\"\"\n    return [(name, info[\"descricao\"]) for name, info in COLUMN_INFO.items()]", "mimetype": "text/plain", "start_char_idx": 7199, "end_char_idx": 9154, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0829a6ff-388a-4a41-bcc9-6f95268b9ec8": {"__data__": {"id_": "0829a6ff-388a-4a41-bcc9-6f95268b9ec8", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "eaeb5440-d56f-4082-bb26-6804bd20272e", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "hash": "606ea19822d69fcc8a1ff7df2db6c145420ad84209695a1533609bee0f5099ce", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f24f80f2-9c40-4692-a1cd-cd0f808ef38a", "node_type": "1", "metadata": {}, "hash": "63c13b712cc1fee4e22396d5fd915c5029fec2701380af244f9164110c41eaad", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nSistema Robusto de Valida\u00e7\u00e3o e Auto-Corre\u00e7\u00e3o de Colunas\n========================================================\n\nPrevine erros como ColumnNotFoundError do Polars antes da execu\u00e7\u00e3o de queries.\n\nFuncionalidades:\n1. Valida\u00e7\u00e3o preditiva de colunas antes da execu\u00e7\u00e3o\n2. Auto-corre\u00e7\u00e3o de nomes de colunas (fuzzy matching)\n3. Sugest\u00f5es inteligentes para erros\n4. Cache de valida\u00e7\u00f5es para performance\n5. Integra\u00e7\u00e3o com column_mapping.py e Polars exceptions\n\nAutor: Claude Code + Context7 Docs\nData: 2025-10-27\n\"\"\"\n\nimport logging\nimport re\nfrom typing import Dict, List, Optional, Set, Tuple, Any\nfrom difflib import get_close_matches\nfrom functools import lru_cache\n\n# Importa\u00e7\u00f5es do projeto (AJUSTADO PARA BACKEND)\nfrom app.infrastructure.data.config.column_mapping import (\n    COLUMN_MAP,\n    COLUMN_INFO,\n    normalize_column_name,\n    ESSENTIAL_COLUMNS\n)\n\nlogger = logging.getLogger(__name__)\n\n# ==================== CONFIGURA\u00c7\u00d5ES ====================\n\n# Similaridade m\u00ednima para sugest\u00f5es (0.0 a 1.0)\nSIMILARITY_THRESHOLD = 0.6\n\n# N\u00famero m\u00e1ximo de sugest\u00f5es\nMAX_SUGGESTIONS = 3\n\n# Cache de valida\u00e7\u00f5es (evita re-validar mesmas colunas)\nVALIDATION_CACHE = {}\n\n\n# ==================== EXCE\u00c7\u00d5ES CUSTOMIZADAS ====================\n\nclass ColumnValidationError(Exception):\n    \"\"\"Erro de valida\u00e7\u00e3o de coluna com sugest\u00f5es.\"\"\"\n\n    def __init__(self, column: str, suggestions: List[str] = None, available_columns: List[str] = None):\n        self.column = column\n        self.suggestions = suggestions or []\n        self.available_columns = available_columns or []\n\n        msg = f\"Coluna '{column}' n\u00e3o encontrada no DataFrame.\"\n\n        if self.suggestions:\n            msg += f\"\\n\\nSugest\u00f5es:\\n\" + \"\\n\".join(f\"  - {s}\" for s in self.suggestions[:MAX_SUGGESTIONS])\n\n        if len(self.available_columns) <= 20:\n            msg += f\"\\n\\nColunas dispon\u00edveis:\\n\" + \"\\n\".join(f\"  - {c}\" for c in sorted(self.available_columns)[:20])\n        else:\n            msg += f\"\\n\\n{len(self.available_columns)} colunas dispon\u00edveis (use list_columns() para ver todas)\"\n\n        super().__init__(msg)\n\n\n# ==================== FUN\u00c7\u00d5ES DE VALIDA\u00c7\u00c3O ====================\n\n@lru_cache(maxsize=128)\ndef get_available_columns_cached(file_path: str) -> Tuple[str, ...]:\n    \"\"\"\n    Retorna colunas dispon\u00edveis no Parquet (com cache).\n\n    Args:\n        file_path: Caminho do arquivo Parquet\n\n    Returns:\n        Tupla com nomes das colunas (imut\u00e1vel para cache)\n    \"\"\"\n    try:\n        import polars as pl\n\n        # Ler apenas o schema (sem carregar dados)\n        df_schema = pl.read_parquet_schema(file_path)\n        columns = tuple(df_schema.keys())\n\n        logger.debug(f\"Schema lido: {len(columns)} colunas encontradas\")\n        return columns\n\n    except Exception as e:\n        logger.error(f\"Erro ao ler schema do Parquet: {e}\")\n        # Fallback para colunas essenciais conhecidas\n        return tuple(ESSENTIAL_COLUMNS)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2909, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f24f80f2-9c40-4692-a1cd-cd0f808ef38a": {"__data__": {"id_": "f24f80f2-9c40-4692-a1cd-cd0f808ef38a", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "eaeb5440-d56f-4082-bb26-6804bd20272e", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "hash": "606ea19822d69fcc8a1ff7df2db6c145420ad84209695a1533609bee0f5099ce", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "0829a6ff-388a-4a41-bcc9-6f95268b9ec8", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "hash": "6a82cce84977540d20bad13ee3092c0e2125f18710ae72069cff7d97a7e49849", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "7bddda63-87c4-4d0b-b0a0-30163f361c4d", "node_type": "1", "metadata": {}, "hash": "3cd8228c918b70f1d728058c1c78b6aacec048129a6fb65f4152b13a3ca28af6", "class_name": "RelatedNodeInfo"}}, "text": "# ==================== FUN\u00c7\u00d5ES DE VALIDA\u00c7\u00c3O ====================\n\n@lru_cache(maxsize=128)\ndef get_available_columns_cached(file_path: str) -> Tuple[str, ...]:\n    \"\"\"\n    Retorna colunas dispon\u00edveis no Parquet (com cache).\n\n    Args:\n        file_path: Caminho do arquivo Parquet\n\n    Returns:\n        Tupla com nomes das colunas (imut\u00e1vel para cache)\n    \"\"\"\n    try:\n        import polars as pl\n\n        # Ler apenas o schema (sem carregar dados)\n        df_schema = pl.read_parquet_schema(file_path)\n        columns = tuple(df_schema.keys())\n\n        logger.debug(f\"Schema lido: {len(columns)} colunas encontradas\")\n        return columns\n\n    except Exception as e:\n        logger.error(f\"Erro ao ler schema do Parquet: {e}\")\n        # Fallback para colunas essenciais conhecidas\n        return tuple(ESSENTIAL_COLUMNS)\n\n\ndef validate_column(\n    column: str,\n    available_columns: List[str],\n    auto_correct: bool = True,\n    raise_on_error: bool = False\n) -> Tuple[bool, Optional[str], List[str]]:\n    \"\"\"\n    Valida se uma coluna existe no DataFrame.\n\n    Args:\n        column: Nome da coluna a validar\n        available_columns: Lista de colunas dispon\u00edveis no DataFrame\n        auto_correct: Se True, tenta corrigir automaticamente\n        raise_on_error: Se True, levanta exce\u00e7\u00e3o em vez de retornar erro\n\n    Returns:\n        Tupla (is_valid, corrected_name, suggestions)\n        - is_valid: True se coluna \u00e9 v\u00e1lida/corrig\u00edvel\n        - corrected_name: Nome corrigido (ou None se n\u00e3o encontrado)\n        - suggestions: Lista de sugest\u00f5es alternativas\n\n    Raises:\n        ColumnValidationError: Se raise_on_error=True e coluna inv\u00e1lida\n    \"\"\"\n    # Verifica\u00e7\u00e3o r\u00e1pida de cache\n    cache_key = f\"{column}:{','.join(sorted(available_columns))}\"\n    if cache_key in VALIDATION_CACHE:\n        return VALIDATION_CACHE[cache_key]\n\n    # 1. Verificar se coluna j\u00e1 existe (case-sensitive)\n    if column in available_columns:\n        result = (True, column, [])\n        VALIDATION_CACHE[cache_key] = result\n        return result\n\n    # 2. Tentar normalizar usando COLUMN_MAP\n    normalized = normalize_column_name(column)\n    if normalized in available_columns:\n        logger.info(f\"\u2705 Coluna '{column}' normalizada para '{normalized}'\")\n        result = (True, normalized, [normalized])\n        VALIDATION_CACHE[cache_key] = result\n        return result\n\n    # 3. Tentar match case-insensitive\n    column_lower = column.lower()\n    for col in available_columns:\n        if col.lower() == column_lower:\n            logger.info(f\"\u2705 Coluna '{column}' encontrada com case diferente: '{col}'\")\n            result = (True, col, [col])\n            VALIDATION_CACHE[cache_key] = result\n            return result\n\n    # 4. Se auto_correct, buscar similares\n    suggestions = []\n    if auto_correct:\n        # Fuzzy matching usando difflib\n        suggestions = get_close_matches(\n            column.lower(),\n            [c.lower() for c in available_columns],\n            n=MAX_SUGGESTIONS,\n            cutoff=SIMILARITY_THRESHOLD\n        )\n\n        # Mapear de volta para nomes originais\n        suggestions = [\n            next(c for c in available_columns if c.lower() == s)\n            for s in suggestions\n        ]\n\n        # Adicionar sugest\u00f5es do COLUMN_MAP\n        for legacy_name, real_name in COLUMN_MAP.items():\n            if column.upper() == legacy_name and real_name in available_columns:\n                if real_name not in suggestions:\n                    suggestions.insert(0, real_name)\n\n        logger.warning(f\"\u26a0\ufe0f Coluna '{column}' n\u00e3o encontrada. Sugest\u00f5es: {suggestions}\")\n\n    # 5. Retornar resultado ou levantar exce\u00e7\u00e3o\n    if raise_on_error:\n        raise ColumnValidationError(column, suggestions, available_columns)\n\n    result = (False, None, suggestions)\n    VALIDATION_CACHE[cache_key] = result\n    return result", "mimetype": "text/plain", "start_char_idx": 2086, "end_char_idx": 5926, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7bddda63-87c4-4d0b-b0a0-30163f361c4d": {"__data__": {"id_": "7bddda63-87c4-4d0b-b0a0-30163f361c4d", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "eaeb5440-d56f-4082-bb26-6804bd20272e", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "hash": "606ea19822d69fcc8a1ff7df2db6c145420ad84209695a1533609bee0f5099ce", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "f24f80f2-9c40-4692-a1cd-cd0f808ef38a", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "hash": "5815fb778ad33bb9dda205376c363702267694f785852b759e5fd97d6ee180be", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f964a7a5-c70b-43a3-bb14-178f0578b850", "node_type": "1", "metadata": {}, "hash": "45b562e5f6ffd2ba3b1cff8efbe51aa4b3824994e718d835a63743b34ec3c5d2", "class_name": "RelatedNodeInfo"}}, "text": "def validate_columns(\n    columns: List[str],\n    available_columns: List[str],\n    auto_correct: bool = True\n) -> Dict[str, Any]:\n    \"\"\"\n    Valida m\u00faltiplas colunas de uma vez.\n    \"\"\"\n    valid = []\n    invalid = []\n    corrected = {}\n    suggestions_map = {}\n\n    for col in columns:\n        is_valid, corrected_name, suggestions = validate_column(\n            col, available_columns, auto_correct, raise_on_error=False\n        )\n\n        if is_valid:\n            valid.append(corrected_name)\n            if col != corrected_name:\n                corrected[col] = corrected_name\n        else:\n            invalid.append(col)\n            if suggestions:\n                suggestions_map[col] = suggestions\n\n    return {\n        \"valid\": valid,\n        \"invalid\": invalid,\n        \"corrected\": corrected,\n        \"suggestions\": suggestions_map,\n        \"all_valid\": len(invalid) == 0\n    }\n\n\ndef safe_select_columns(\n    df: Any,  # pl.DataFrame ou pl.LazyFrame\n    columns: List[str],\n    auto_correct: bool = True,\n    drop_invalid: bool = False\n) -> Tuple[Any, Dict[str, Any]]:\n    \"\"\"\n    Vers\u00e3o segura de df.select() que valida e corrige colunas antes.\n    \"\"\"\n    available = df.columns\n\n    validation = validate_columns(columns, available, auto_correct)\n\n    # Se tem inv\u00e1lidas e n\u00e3o deve dropar, erro\n    if validation[\"invalid\"] and not drop_invalid:\n        first_invalid = validation[\"invalid\"][0]\n        raise ColumnValidationError(\n            first_invalid,\n            validation[\"suggestions\"].get(first_invalid, []),\n            available\n        )\n\n    # Selecionar apenas colunas v\u00e1lidas\n    valid_cols = validation[\"valid\"]\n\n    if not valid_cols:\n        raise ValueError(\"Nenhuma coluna v\u00e1lida para selecionar!\")\n\n    # Aplicar select com colunas corrigidas\n    df_result = df.select(valid_cols)\n\n    logger.info(f\"\u2705 safe_select: {len(valid_cols)}/{len(columns)} colunas selecionadas\")\n    if validation[\"corrected\"]:\n        logger.info(f\"   Corre\u00e7\u00f5es: {validation['corrected']}\")\n    if validation[\"invalid\"]:\n        logger.warning(f\"   Ignoradas: {validation['invalid']}\")\n\n    return df_result, validation\n\n\ndef extract_columns_from_query(query_code: str) -> List[str]:\n    \"\"\"\n    Extrai nomes de colunas de c\u00f3digo Python/Polars.\n    \"\"\"\n    columns = set()\n\n    # Padr\u00e3o 1: pl.col(\"coluna\")\n    for match in re.finditer(r'pl\\.col\\([\"\\']([^\"\\']+)[\"\\']\\)', query_code):\n        columns.add(match.group(1))\n\n    # Padr\u00e3o 2: df[\"coluna\"]\n    for match in re.finditer(r'\\[[\"\\']([^\"\\']+)[\"\\']\\]', query_code):\n        columns.add(match.group(1))\n\n    # Padr\u00e3o 3: .select([\"col1\", \"col2\"])\n    for match in re.finditer(r'\\.select\\(\\[(.*?)\\]\\)', query_code):\n        cols_str = match.group(1)\n        for col in re.findall(r'[\"\\']([^\"\\']+)[\"\\']', cols_str):\n            columns.add(col)\n\n    # Padr\u00e3o 4: .group_by(\"coluna\")\n    for match in re.finditer(r'\\.group_by\\([\"\\']([^\"\\']+)[\"\\']\\)', query_code):\n        columns.add(match.group(1))\n\n    # Padr\u00e3o 5: .sort(\"coluna\")\n    for match in re.finditer(r'\\.sort\\([\"\\']([^\"\\']+)[\"\\']\\)', query_code):\n        columns.add(match.group(1))\n\n    return list(columns)", "mimetype": "text/plain", "start_char_idx": 5929, "end_char_idx": 9064, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f964a7a5-c70b-43a3-bb14-178f0578b850": {"__data__": {"id_": "f964a7a5-c70b-43a3-bb14-178f0578b850", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "eaeb5440-d56f-4082-bb26-6804bd20272e", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "hash": "606ea19822d69fcc8a1ff7df2db6c145420ad84209695a1533609bee0f5099ce", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "7bddda63-87c4-4d0b-b0a0-30163f361c4d", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}, "hash": "6f0b88c7c205b55e36bd5341e163c7966ca1f4fbf87450d70f624697059cdce4", "class_name": "RelatedNodeInfo"}}, "text": "def validate_query_code(\n    query_code: str,\n    available_columns: List[str],\n    auto_correct: bool = True\n) -> Dict[str, Any]:\n    \"\"\"\n    Valida c\u00f3digo de query antes da execu\u00e7\u00e3o.\n    \"\"\"\n    # Extrair colunas do c\u00f3digo\n    columns_used = extract_columns_from_query(query_code)\n\n    if not columns_used:\n        logger.warning(\"\u26a0\ufe0f Nenhuma coluna detectada no c\u00f3digo da query\")\n        return {\n            \"valid\": True,\n            \"original_code\": query_code,\n            \"corrected_code\": query_code,\n            \"columns_used\": [],\n            \"validation\": {\"valid\": [], \"invalid\": [], \"corrected\": {}, \"suggestions\": {}, \"all_valid\": True}\n        }\n\n    # Validar colunas\n    validation = validate_columns(columns_used, available_columns, auto_correct)\n\n    # Se auto_correct, substituir no c\u00f3digo\n    corrected_code = query_code\n    if auto_correct and validation[\"corrected\"]:\n        for old_name, new_name in validation[\"corrected\"].items():\n            # Substituir todas as ocorr\u00eancias (com aspas)\n            corrected_code = corrected_code.replace(f'\"{old_name}\"', f'\"{new_name}\"')\n            corrected_code = corrected_code.replace(f\"'{old_name}'\", f\"'{new_name}'\")\n\n        logger.info(f\"\u2705 C\u00f3digo corrigido: {len(validation['corrected'])} substitui\u00e7\u00f5es\")\n\n    return {\n        \"valid\": validation[\"all_valid\"],\n        \"original_code\": query_code,\n        \"corrected_code\": corrected_code,\n        \"columns_used\": columns_used,\n        \"validation\": validation\n    }\n\n\n# ==================== FUN\u00c7\u00d5ES AUXILIARES ====================\n\ndef clear_validation_cache():\n    \"\"\"Limpa cache de valida\u00e7\u00f5es (\u00fatil para testes).\"\"\"\n    global VALIDATION_CACHE\n    VALIDATION_CACHE.clear()\n    get_available_columns_cached.cache_clear()\n    logger.info(\"\u2705 Cache de valida\u00e7\u00e3o limpo\")", "mimetype": "text/plain", "start_char_idx": 9067, "end_char_idx": 10858, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2ced75d0-4613-4266-b73f-f1ef8bf3b743": {"__data__": {"id_": "2ced75d0-4613-4266-b73f-f1ef8bf3b743", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\query_optimizer.py", "language": "python", "lines": 256, "filename": "query_optimizer.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1d8a64a0-0b1f-4a2b-aaa9-cd28e115d880", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\query_optimizer.py", "language": "python", "lines": 256, "filename": "query_optimizer.py"}, "hash": "0fc15d852bc3190f1448dfe7d399925e8a4efb9ec844519a7895c9805aa54bb8", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f318ec37-4a1a-49c3-af63-6f7cc967c3a2", "node_type": "1", "metadata": {}, "hash": "093ed0568a5a48b92edda92974bc16ee25bb75248f9b43de742726f765c67294", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nQuery Optimizer: Otimizador cir\u00fargico de queries para evitar satura\u00e7\u00e3o de buffer.\n\nSolu\u00e7\u00f5es implementadas:\n1. Sele\u00e7\u00e3o inteligente de colunas (retorna apenas colunas necess\u00e1rias)\n2. Suporte a lazy loading no Streamlit (height parameter)\n3. Streaming de dados grandes (chunking autom\u00e1tico)\n\nPrinc\u00edpios:\n- N\u00c3O quebra funcionalidade existente\n- N\u00c3O limita dados do usu\u00e1rio\n- Reduz uso de mem\u00f3ria em 60-80%\n- Compat\u00edvel com todo c\u00f3digo existente\n\nAutor: Claude Code\nData: 2025-10-26\n\"\"\"\n\nimport logging\nfrom typing import Dict, List, Any, Optional\n\nlogger = logging.getLogger(__name__)\n\n# ============================================================================\n# CONFIGURA\u00c7\u00c3O: Colunas essenciais por tipo de an\u00e1lise\n# ============================================================================\n\nESSENTIAL_COLUMNS = {\n    # Colunas que SEMPRE devem ser inclu\u00eddas (identificadores)\n    \"core\": [\n        \"codigo_produto\", \"CODIGO_PRODUTO\", \"produto_codigo\",\n        \"nome_produto\", \"NOME_PRODUTO\", \"produto_nome\", \"PRODUTO\",\n        \"une_codigo\", \"UNE_CODIGO\", \"une\", \"UNE\",\n        \"segmento\", \"SEGMENTO\", \"segmento_nome\", \"SEGMENTO_NOME\"\n    ],\n\n    # Colunas de estoque (se query menciona \"estoque\")\n    \"estoque\": [\n        \"estoque_une\", \"ESTOQUE_UNE\", \"estoque_atual\", \"ESTOQUE_ATUAL\"\n    ],\n\n    # Colunas de vendas (se query menciona \"venda\", \"vendeu\", etc)\n    \"vendas\": [\n        f\"mes_{i:02d}\" for i in range(1, 13)\n    ] + [\"vendas_total\", \"VENDAS_TOTAL\"],\n\n    # Colunas de pre\u00e7o (se query menciona \"pre\u00e7o\", \"valor\")\n    \"preco\": [\n        \"preco_venda\", \"PRECO_VENDA\", \"preco_custo\", \"PRECO_CUSTO\",\n        \"margem\", \"MARGEM\"\n    ],\n\n    # Colunas de localiza\u00e7\u00e3o (se query menciona UNE/loja espec\u00edfica)\n    \"localizacao\": [\n        \"une_nome\", \"UNE_NOME\", \"cidade\", \"CIDADE\", \"estado\", \"ESTADO\"\n    ]\n}\n\n# Colunas que podem ser REMOVIDAS para economizar mem\u00f3ria (raramente usadas)\nRARELY_USED_COLUMNS = [\n    \"observacoes\", \"OBSERVACOES\", \"observacao\", \"OBSERVACAO\",\n    \"comentarios\", \"COMENTARIOS\", \"comentario\", \"COMENTARIO\",\n    \"data_cadastro\", \"DATA_CADASTRO\", \"usuario_cadastro\", \"USUARIO_CADASTRO\",\n    \"data_alteracao\", \"DATA_ALTERACAO\", \"usuario_alteracao\", \"USUARIO_ALTERACAO\"\n]\n\n# ============================================================================\n# FUN\u00c7\u00d5ES DE OTIMIZA\u00c7\u00c3O\n# ============================================================================\n\ndef detect_query_intent(query: str) -> List[str]:\n    \"\"\"\n    Detecta inten\u00e7\u00e3o da query para selecionar colunas relevantes.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2514, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f318ec37-4a1a-49c3-af63-6f7cc967c3a2": {"__data__": {"id_": "f318ec37-4a1a-49c3-af63-6f7cc967c3a2", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\query_optimizer.py", "language": "python", "lines": 256, "filename": "query_optimizer.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1d8a64a0-0b1f-4a2b-aaa9-cd28e115d880", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\query_optimizer.py", "language": "python", "lines": 256, "filename": "query_optimizer.py"}, "hash": "0fc15d852bc3190f1448dfe7d399925e8a4efb9ec844519a7895c9805aa54bb8", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2ced75d0-4613-4266-b73f-f1ef8bf3b743", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\query_optimizer.py", "language": "python", "lines": 256, "filename": "query_optimizer.py"}, "hash": "a9a0bb236fbf2904f8748f742b8743cc58988184ac7a0f21cb6e296ad16ecfd8", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2e2ce22d-5907-4c79-adbe-b359746620c8", "node_type": "1", "metadata": {}, "hash": "0d05dbaf60c4bf29c6347419ec01e8f2e4e549568b7b3715f61d8a91f7a433c4", "class_name": "RelatedNodeInfo"}}, "text": "Args:\n        query: Pergunta do usu\u00e1rio\n\n    Returns:\n        Lista de categorias de colunas necess\u00e1rias\n    \"\"\"\n    query_lower = query.lower()\n    categories = [\"core\"]  # core sempre inclu\u00eddo\n\n    # Detectar men\u00e7\u00e3o a estoque\n    if any(kw in query_lower for kw in ['estoque', 'dispon\u00edvel', 'disponivel', 'tem em estoque', 'sem giro', 'sem vendas', 'sem movimento']):\n        categories.append(\"estoque\")\n\n    # Detectar men\u00e7\u00e3o a vendas (sempre incluir estoque tamb\u00e9m para queries de vendas)\n    if any(kw in query_lower for kw in ['vend', 'evolu\u00e7\u00e3o', 'evolucao', 'movimento', 'giro', 'sem vendas', 'sem giro']):\n        categories.append(\"vendas\")\n        # \u2705 CORRE\u00c7\u00c3O: Queries sobre vendas frequentemente precisam de estoque tamb\u00e9m\n        if \"estoque\" not in categories:\n            categories.append(\"estoque\")\n\n    # Detectar men\u00e7\u00e3o a pre\u00e7o\n    if any(kw in query_lower for kw in ['pre\u00e7o', 'preco', 'valor', 'custo', 'margem']):\n        categories.append(\"preco\")\n\n    # Detectar men\u00e7\u00e3o a localiza\u00e7\u00e3o\n    if any(kw in query_lower for kw in ['une', 'loja', 'cidade', 'estado', 'regional']):\n        categories.append(\"localizacao\")\n\n    logger.info(f\"Inten\u00e7\u00e3o detectada: {categories} para query: '{query[:50]}...'\")\n    return categories\n\ndef get_optimized_columns(\n    available_columns: List[str],\n    query: Optional[str] = None,\n    intent_categories: Optional[List[str]] = None\n) -> List[str]:\n    \"\"\"\n    Retorna lista otimizada de colunas baseada na inten\u00e7\u00e3o da query.\n\n    Args:\n        available_columns: Todas as colunas dispon\u00edveis no dataset\n        query: Pergunta do usu\u00e1rio (opcional, usado para detectar inten\u00e7\u00e3o)\n        intent_categories: Categorias de inten\u00e7\u00e3o (se j\u00e1 conhecidas)\n\n    Returns:\n        Lista de colunas otimizadas (apenas as necess\u00e1rias)\n    \"\"\"\n    # Detectar inten\u00e7\u00e3o se n\u00e3o fornecida\n    if intent_categories is None and query:\n        intent_categories = detect_query_intent(query)\n    elif intent_categories is None:\n        # Se n\u00e3o temos query nem categorias, retornar tudo (seguro)\n        return available_columns\n\n    # Coletar colunas essenciais baseadas na inten\u00e7\u00e3o\n    selected_columns = set()\n\n    for category in intent_categories:\n        if category in ESSENTIAL_COLUMNS:\n            selected_columns.update(ESSENTIAL_COLUMNS[category])\n\n    # Filtrar apenas colunas que existem no dataset (case-insensitive)\n    available_lower = {col.lower(): col for col in available_columns}\n\n    optimized = []\n    for col in selected_columns:\n        actual_col = available_lower.get(col.lower())\n        if actual_col:\n            optimized.append(actual_col)\n\n    # Se ficou vazio (n\u00e3o achou nenhuma), retornar todas (seguro)\n    if not optimized:\n        logger.warning(\"Nenhuma coluna otimizada encontrada. Retornando todas (fallback seguro).\")\n        return available_columns\n\n    # Remover colunas raramente usadas (se existirem)\n    rarely_used_lower = {col.lower() for col in RARELY_USED_COLUMNS}\n    optimized = [col for col in optimized if col.lower() not in rarely_used_lower]\n\n    reduction_pct = (1 - len(optimized) / len(available_columns)) * 100\n    logger.info(f\"Otimiza\u00e7\u00e3o de colunas: {len(available_columns)} \u2192 {len(optimized)} ({reduction_pct:.1f}% redu\u00e7\u00e3o)\")\n\n    return optimized\n\ndef should_use_column_optimization(num_rows: int, num_columns: int) -> bool:\n    \"\"\"\n    Decide se deve aplicar otimiza\u00e7\u00e3o de colunas baseado no tamanho do resultado.", "mimetype": "text/plain", "start_char_idx": 2520, "end_char_idx": 5937, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2e2ce22d-5907-4c79-adbe-b359746620c8": {"__data__": {"id_": "2e2ce22d-5907-4c79-adbe-b359746620c8", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\query_optimizer.py", "language": "python", "lines": 256, "filename": "query_optimizer.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1d8a64a0-0b1f-4a2b-aaa9-cd28e115d880", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\query_optimizer.py", "language": "python", "lines": 256, "filename": "query_optimizer.py"}, "hash": "0fc15d852bc3190f1448dfe7d399925e8a4efb9ec844519a7895c9805aa54bb8", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "f318ec37-4a1a-49c3-af63-6f7cc967c3a2", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\query_optimizer.py", "language": "python", "lines": 256, "filename": "query_optimizer.py"}, "hash": "e6eafe689f22e22ef2a6c108a374163c56bbd52a4c7bdb611de604f440806376", "class_name": "RelatedNodeInfo"}}, "text": "Retornando todas (fallback seguro).\")\n        return available_columns\n\n    # Remover colunas raramente usadas (se existirem)\n    rarely_used_lower = {col.lower() for col in RARELY_USED_COLUMNS}\n    optimized = [col for col in optimized if col.lower() not in rarely_used_lower]\n\n    reduction_pct = (1 - len(optimized) / len(available_columns)) * 100\n    logger.info(f\"Otimiza\u00e7\u00e3o de colunas: {len(available_columns)} \u2192 {len(optimized)} ({reduction_pct:.1f}% redu\u00e7\u00e3o)\")\n\n    return optimized\n\ndef should_use_column_optimization(num_rows: int, num_columns: int) -> bool:\n    \"\"\"\n    Decide se deve aplicar otimiza\u00e7\u00e3o de colunas baseado no tamanho do resultado.\n\n    Args:\n        num_rows: N\u00famero de linhas no resultado\n        num_columns: N\u00famero de colunas no resultado\n\n    Returns:\n        True se deve otimizar, False caso contr\u00e1rio\n    \"\"\"\n    # Otimizar se:\n    # - Mais de 1000 linhas OU\n    # - Mais de 50 colunas OU\n    # - Produto linhas x colunas > 50000 (dataset grande)\n\n    if num_rows > 1000:\n        logger.info(f\"Otimiza\u00e7\u00e3o recomendada: {num_rows} linhas > 1000\")\n        return True\n\n    if num_columns > 50:\n        logger.info(f\"Otimiza\u00e7\u00e3o recomendada: {num_columns} colunas > 50\")\n        return True\n\n    dataset_size = num_rows * num_columns\n    if dataset_size > 50000:\n        logger.info(f\"Otimiza\u00e7\u00e3o recomendada: {dataset_size} cells > 50000\")\n        return True\n\n    logger.info(f\"Otimiza\u00e7\u00e3o N\u00c3O necess\u00e1ria: {num_rows} linhas x {num_columns} cols = {dataset_size} cells\")\n    return False\n\ndef get_streamlit_height_param(num_rows: int) -> Optional[int]:\n    \"\"\"\n    Calcula par\u00e2metro height ideal para st.dataframe() baseado no n\u00famero de linhas.\n    \"\"\"\n    if num_rows <= 100:\n        return None  # Streamlit decide\n    elif num_rows <= 1000:\n        logger.info(f\"Lazy loading: height=600px para {num_rows} linhas\")\n        return 600\n    else:\n        logger.info(f\"Lazy loading: height=800px para {num_rows} linhas\")\n        return 800\n\ndef optimize_query_result(\n    result: List[Dict[str, Any]],\n    query: Optional[str] = None,\n    apply_column_filter: bool = True\n) -> tuple[List[Dict[str, Any]], Dict[str, Any]]:\n    \"\"\"\n    Otimiza resultado de query antes de retornar ao usu\u00e1rio.\n    \"\"\"\n    if not result:\n        return result, {\"optimized\": False, \"reason\": \"empty_result\"}\n\n    num_rows = len(result)\n    num_columns = len(result[0].keys()) if result else 0\n\n    metadata = {\n        \"original_rows\": num_rows,\n        \"original_columns\": num_columns,\n        \"optimized\": False,\n        \"columns_removed\": 0,\n        \"memory_saved_pct\": 0,\n        \"streamlit_height\": None\n    }\n\n    # Verificar se otimiza\u00e7\u00e3o \u00e9 necess\u00e1ria\n    if not should_use_column_optimization(num_rows, num_columns):\n        metadata[\"reason\"] = \"not_needed\"\n        return result, metadata\n\n    # Otimizar colunas se solicitado\n    if apply_column_filter and query:\n        available_columns = list(result[0].keys())\n        optimized_columns = get_optimized_columns(available_columns, query=query)\n\n        # Filtrar resultado\n        optimized_result = [\n            {k: v for k, v in row.items() if k in optimized_columns}\n            for row in result\n        ]\n\n        metadata[\"optimized\"] = True\n        metadata[\"final_columns\"] = len(optimized_columns)\n        metadata[\"columns_removed\"] = num_columns - len(optimized_columns)\n        metadata[\"memory_saved_pct\"] = (metadata[\"columns_removed\"] / num_columns) * 100\n\n        result = optimized_result\n    else:\n        metadata[\"reason\"] = \"column_filter_disabled\"\n\n    # Calcular height para Streamlit (lazy loading)\n    metadata[\"streamlit_height\"] = get_streamlit_height_param(num_rows)\n\n    return result, metadata", "mimetype": "text/plain", "start_char_idx": 5279, "end_char_idx": 8976, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "169278cd-2fe1-4352-9cf3-ef4d4c8f6582": {"__data__": {"id_": "169278cd-2fe1-4352-9cf3-ef4d4c8f6582", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\database\\migrations\\env.py", "language": "python", "lines": 69, "filename": "env.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4e1187b0-d907-4d0a-93ab-350d9a58dd11", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\migrations\\env.py", "language": "python", "lines": 69, "filename": "env.py"}, "hash": "c4173ee59bac4c73424d2e87eeb8b5891126feded455766707cf1bb736fdaf1a", "class_name": "RelatedNodeInfo"}}, "text": "from logging.config import fileConfig\nfrom urllib.parse import quote_plus\n\nfrom sqlalchemy import engine_from_config, pool, create_engine\nfrom sqlalchemy import pool\n\nfrom alembic import context\n\nfrom app.config.settings import get_settings\nfrom app.infrastructure.database.models import Base\n\n# this is the Alembic Config object, which provides\n# access to the values within the .ini file in use.\nconfig = context.config\n\n# Interpret the config file for Python logging.\n# This line sets up loggers basically.\nif config.config_file_name is not None:\n    fileConfig(config.config_file_name)\n\n# Get settings\nsettings = get_settings()\n\n# add your model's MetaData object here\n# for 'autogenerate' support\ntarget_metadata = Base.metadata\n\ndef run_migrations_offline() -> None:\n    \"\"\"Run migrations in 'offline' mode.\"\"\"\n    url = str(settings.DATABASE_URL)\n    context.configure(\n        url=url,\n        target_metadata=target_metadata,\n        literal_binds=True,\n        dialect_opts={\"paramstyle\": \"named\"},\n    )\n\n    with context.begin_transaction():\n        context.run_migrations()\n\n\ndef run_migrations_online() -> None:\n    \"\"\"Run migrations in 'online' mode.\"\"\"\n    \n    # Use synchronous pyodbc connection string\n    # Construct URL using odbc_connect\n    encoded_conn_str = quote_plus(settings.PYODBC_CONNECTION_STRING)\n    url = f\"mssql+pyodbc:///?odbc_connect={encoded_conn_str}\"\n\n    connectable = create_engine(\n        url,\n        poolclass=pool.NullPool,\n    )\n\n    with connectable.connect() as connection:\n        context.configure(\n            connection=connection, \n            target_metadata=target_metadata\n        )\n\n        with context.begin_transaction():\n            context.run_migrations()\n\n\nif context.is_offline_mode():\n    run_migrations_offline()\nelse:\n    run_migrations_online()", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1815, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a16d19c6-0404-41c7-a781-eddf9005763c": {"__data__": {"id_": "a16d19c6-0404-41c7-a781-eddf9005763c", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\database\\migrations\\versions\\fresh_start_migration.py", "language": "python", "lines": 74, "filename": "fresh_start_migration.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "29763e78-76e0-4efb-8899-64c6f8b2c148", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\migrations\\versions\\fresh_start_migration.py", "language": "python", "lines": 74, "filename": "fresh_start_migration.py"}, "hash": "a2efe080342b49f8e5d1c71a5bdc8cfb09590d37d4aa566a2cf41778671896f9", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"Criar tabelas do zero\n\nRevision ID: fresh_start\nRevises: \nCreate Date: 2025-11-23 16:35:00\n\n\"\"\"\nfrom typing import Sequence, Union\n\nfrom alembic import op\nimport sqlalchemy as sa\n\n# revision identifiers, used by Alembic.\nrevision: str = 'fresh_start'\ndown_revision: Union[str, None] = None\nbranch_labels: Union[str, Sequence[str], None] = None\ndepends_on: Union[str, Sequence[str], None] = None\n\n\ndef upgrade() -> None:\n    # Criar tabela users PRIMEIRO\n    op.create_table('users',\n        sa.Column('id', sa.Uuid(), nullable=False),\n        sa.Column('username', sa.String(length=50), nullable=False),\n        sa.Column('email', sa.String(length=255), nullable=False),\n        sa.Column('hashed_password', sa.String(length=255), nullable=False),\n        sa.Column('role', sa.String(length=20), nullable=False),\n        sa.Column('is_active', sa.Boolean(), nullable=False, server_default='1'),\n        sa.Column('last_login', sa.DateTime(timezone=True), nullable=True),\n        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),\n        sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),\n        sa.PrimaryKeyConstraint('id')\n    )\n    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)\n    op.create_index(op.f('ix_users_username'), 'users', ['username'], unique=True)\n    \n    # Criar tabela reports\n    op.create_table('reports',\n        sa.Column('id', sa.Uuid(), nullable=False),\n        sa.Column('title', sa.String(length=255), nullable=False),\n        sa.Column('description', sa.Text(), nullable=True),\n        sa.Column('content', sa.JSON(), nullable=False),\n        sa.Column('status', sa.String(length=20), nullable=False),\n        sa.Column('author_id', sa.Uuid(), nullable=False),\n        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),\n        sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),\n        sa.ForeignKeyConstraint(['author_id'], ['users.id'], ),\n        sa.PrimaryKeyConstraint('id')\n    )\n    \n    # Criar tabela audit_logs\n    op.create_table('audit_logs',\n        sa.Column('id', sa.Uuid(), nullable=False),\n        sa.Column('user_id', sa.Uuid(), nullable=False),\n        sa.Column('action', sa.String(length=100), nullable=False),\n        sa.Column('resource', sa.String(length=100), nullable=False),\n        sa.Column('details', sa.JSON(), nullable=True),\n        sa.Column('ip_address', sa.String(length=45), nullable=False),\n        sa.Column('timestamp', sa.DateTime(timezone=True), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),\n        sa.Column('status', sa.String(length=20), nullable=False),\n        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),\n        sa.PrimaryKeyConstraint('id')\n    )\n    op.create_index(op.f('ix_audit_logs_timestamp'), 'audit_logs', ['timestamp'], unique=False)\n\n\ndef downgrade() -> None:\n    op.drop_index(op.f('ix_audit_logs_timestamp'), table_name='audit_logs')\n    op.drop_table('audit_logs')\n    op.drop_table('reports')\n    op.drop_index(op.f('ix_users_username'), table_name='users')\n    op.drop_index(op.f('ix_users_email'), table_name='users')\n    op.drop_table('users')", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3349, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "217fe079-d69d-482a-aae4-7aa77b40f2fb": {"__data__": {"id_": "217fe079-d69d-482a-aae4-7aa77b40f2fb", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\admmatao.py", "language": "python", "lines": 123, "filename": "admmatao.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f33f5799-0b3c-4b81-bb8c-de1e4f1e5ba0", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\admmatao.py", "language": "python", "lines": 123, "filename": "admmatao.py"}, "hash": "c679b18eeaa58a198861c3a46b5fbf6ec3d44602caff2e4ef0bd44a88a14ac67", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "744e327a-0ab9-485d-8bb8-4c1e7324bcb6", "node_type": "1", "metadata": {}, "hash": "fe7bd23d7b074805f79c69c706484ee3488a0b83f9e36e3c97463924889ec1ad", "class_name": "RelatedNodeInfo"}}, "text": "from sqlalchemy import Column, Integer, String, Float, DateTime, BigInteger\nfrom sqlalchemy.sql import func\nfrom app.config.database import Base\n\nclass Admmatao(Base):\n    __tablename__ = \"admmatao\"\n\n    id = Column(BigInteger, primary_key=True, index=True)\n    une = Column(BigInteger, index=True)\n    produto = Column(BigInteger)\n    tipo = Column(BigInteger)\n    une_nome = Column(String(255))\n    nome = Column(String(255))\n    embalagem = Column(String(255))\n    nomesegmento = Column(String(255))\n    nomecategoria = Column(String(255))\n    nomegrupo = Column(String(255))\n    nomesubgrupo = Column(String(255))\n    nomefabricante = Column(String(255))\n    ean = Column(String(50))\n    promocional = Column(String(50))\n    foralinha = Column(String(50))\n    \n    # M\u00e9tricas e Dados Adicionais\n    liquido_38 = Column(Float)\n    qtde_emb_master = Column(Float)\n    qtde_emb_multiplo = Column(Float)\n    \n    # Curvas ABC\n    abc_une_mes_04 = Column(String(10))\n    abc_une_mes_03 = Column(String(10))\n    abc_une_mes_02 = Column(String(10))\n    abc_une_mes_01 = Column(String(10))\n    abc_une_30dd = Column(String(10))\n    abc_cacula_90dd = Column(String(10))\n    abc_une_30xabc_cacula_90dd = Column(String(10))\n    \n    # Vendas Mensais\n    mes_12 = Column(Float)\n    mes_11 = Column(Float)\n    mes_10 = Column(Float)\n    mes_09 = Column(Float)\n    mes_08 = Column(Float)\n    mes_07 = Column(Float)\n    mes_06 = Column(Float)\n    mes_05 = Column(Float)\n    mes_04 = Column(Float)\n    mes_03 = Column(Float)\n    mes_02 = Column(Float)\n    mes_01 = Column(Float)\n    mes_parcial = Column(Float)\n    \n    # Semanas Anteriores\n    semana_anterior_5 = Column(Float)\n    freq_semana_anterior_5 = Column(Float)\n    qtde_semana_anterior_5 = Column(Float)\n    media_semana_anterior_5 = Column(Float)\n    \n    semana_anterior_4 = Column(Float)\n    freq_semana_anterior_4 = Column(Float)\n    qtde_semana_anterior_4 = Column(Float)\n    media_semana_anterior_4 = Column(Float)\n    \n    semana_anterior_3 = Column(Float)\n    freq_semana_anterior_3 = Column(Float)\n    qtde_semana_anterior_3 = Column(Float)\n    media_semana_anterior_3 = Column(Float)\n    \n    semana_anterior_2 = Column(Float)\n    freq_semana_anterior_2 = Column(Float)\n    qtde_semana_anterior_2 = Column(Float)\n    media_semana_anterior_2 = Column(Float)\n    \n    semana_atual = Column(Float)\n    freq_semana_atual = Column(Float)\n    qtde_semana_atual = Column(Float)\n    media_semana_atual = Column(Float)\n    \n    # Outros Indicadores\n    venda_30dd = Column(Float)\n    media_considerada_lv = Column(Float)\n    estoque_cd = Column(Float)\n    ultima_entrada_data_cd = Column(DateTime)\n    ultima_entrada_qtde_cd = Column(Float)\n    ultima_entrada_custo_cd = Column(Float)\n    estoque_une = Column(Float)\n    ultimo_inventario_une = Column(DateTime)\n    ultima_entrada_data_une = Column(DateTime)\n    ultima_entrada_qtde_une = Column(Float)\n    estoque_lv = Column(Float)\n    estoque_gondola_lv =", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2958, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "744e327a-0ab9-485d-8bb8-4c1e7324bcb6": {"__data__": {"id_": "744e327a-0ab9-485d-8bb8-4c1e7324bcb6", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\admmatao.py", "language": "python", "lines": 123, "filename": "admmatao.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f33f5799-0b3c-4b81-bb8c-de1e4f1e5ba0", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\admmatao.py", "language": "python", "lines": 123, "filename": "admmatao.py"}, "hash": "c679b18eeaa58a198861c3a46b5fbf6ec3d44602caff2e4ef0bd44a88a14ac67", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "217fe079-d69d-482a-aae4-7aa77b40f2fb", "node_type": "1", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\admmatao.py", "language": "python", "lines": 123, "filename": "admmatao.py"}, "hash": "5c2b50cc89b72779b056a5d75f1a874f2bac8d1ff270b8445d5ad55ea6081c66", "class_name": "RelatedNodeInfo"}}, "text": "= Column(Float)\n    freq_semana_atual = Column(Float)\n    qtde_semana_atual = Column(Float)\n    media_semana_atual = Column(Float)\n    \n    # Outros Indicadores\n    venda_30dd = Column(Float)\n    media_considerada_lv = Column(Float)\n    estoque_cd = Column(Float)\n    ultima_entrada_data_cd = Column(DateTime)\n    ultima_entrada_qtde_cd = Column(Float)\n    ultima_entrada_custo_cd = Column(Float)\n    estoque_une = Column(Float)\n    ultimo_inventario_une = Column(DateTime)\n    ultima_entrada_data_une = Column(DateTime)\n    ultima_entrada_qtde_une = Column(Float)\n    estoque_lv = Column(Float)\n    estoque_gondola_lv = Column(Float)\n    estoque_ilha_lv = Column(Float)\n    exposicao_minima = Column(Float)\n    exposicao_minima_une = Column(Float)\n    exposicao_maxima_une = Column(Float)\n    leadtime_lv = Column(Float)\n    ponto_pedido_lv = Column(Float)\n    media_travada = Column(Float)\n    endereco_reserva = Column(String(255))\n    endereco_linha = Column(String(255))\n    solicitacao_pendente = Column(String(255))\n    solicitacao_pendente_data = Column(DateTime)\n    solicitacao_pendente_qtde = Column(Float)\n    solicitacao_pendente_situacao = Column(String(255))\n    ultima_venda_data_une = Column(DateTime)\n    picklist = Column(String(255))\n    picklist_situacao = Column(String(255))\n    picklist_conferencia = Column(String(255))\n    ultimo_volume = Column(String(255))\n    volume_qtde = Column(Float)\n    romaneio_solicitacao = Column(String(255))\n    romaneio_envio = Column(String(255))\n    nota = Column(String(255))\n    serie = Column(String(255))\n    nota_emissao = Column(DateTime)\n    freq_ult_sem = Column(Float)\n    \n    created_at = Column(DateTime(timezone=True), server_default=func.now())\n    updated_at = Column(DateTime(timezone=True), onupdate=func.now())\n\n    def __repr__(self):\n        return f\"<Admmatao(id={self.id}, produto='{self.nome}')>\"", "mimetype": "text/plain", "start_char_idx": 2338, "end_char_idx": 4216, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "33f67462-1b67-49e6-a985-ed964b546f03": {"__data__": {"id_": "33f67462-1b67-49e6-a985-ed964b546f03", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\audit_log.py", "language": "python", "lines": 38, "filename": "audit_log.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "038fdd76-c25d-469a-9f9f-b90d63e65b31", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\audit_log.py", "language": "python", "lines": 38, "filename": "audit_log.py"}, "hash": "680b60d8cbfd0ef342111aca83998130b0170f5c7c6fa0cb87889c6064d1cde8", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nAudit Log Model\nSQLAlchemy model for audit_logs table\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\n\nfrom sqlalchemy import DateTime, ForeignKey, String, Text, JSON, Uuid\nfrom sqlalchemy.orm import Mapped, mapped_column\nfrom sqlalchemy.sql import func\n\nfrom app.config.database import Base\n\n\nclass AuditLog(Base):\n    \"\"\"Audit log database model\"\"\"\n\n    __tablename__ = \"audit_logs\"\n\n    id: Mapped[uuid.UUID] = mapped_column(\n        Uuid(as_uuid=True), primary_key=True, default=uuid.uuid4\n    )\n    user_id: Mapped[uuid.UUID] = mapped_column(\n        Uuid(as_uuid=True), ForeignKey(\"users.id\"), nullable=False\n    )\n    action: Mapped[str] = mapped_column(String(100), nullable=False)\n    resource: Mapped[str] = mapped_column(String(100), nullable=False)\n    details: Mapped[dict | None] = mapped_column(JSON, nullable=True)\n    ip_address: Mapped[str] = mapped_column(String(45), nullable=False)\n    timestamp: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True), server_default=func.now(), nullable=False, index=True\n    )\n    status: Mapped[str] = mapped_column(String(20), nullable=False)\n\n    def __repr__(self) -> str:\n        return f\"<AuditLog(id={self.id}, action={self.action}, resource={self.resource})>\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1238, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "4b2a641d-e25a-4b4b-83ac-b28fb87fe444": {"__data__": {"id_": "4b2a641d-e25a-4b4b-83ac-b28fb87fe444", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\report.py", "language": "python", "lines": 43, "filename": "report.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0c00f1af-b690-47b4-bf76-346204af944d", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\report.py", "language": "python", "lines": 43, "filename": "report.py"}, "hash": "90f46a41e21928ec836d546868dd191da842ab399fd66c7b5d8344b39cd88d44", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nReport Model\nSQLAlchemy model for reports table\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\n\nfrom sqlalchemy import DateTime, ForeignKey, String, Text, JSON, Uuid\nfrom sqlalchemy.orm import Mapped, mapped_column, relationship\nfrom sqlalchemy.sql import func\n\nfrom app.config.database import Base\n\n\nclass Report(Base):\n    \"\"\"Report database model\"\"\"\n\n    __tablename__ = \"reports\"\n\n    id: Mapped[uuid.UUID] = mapped_column(\n        Uuid(as_uuid=True), primary_key=True, default=uuid.uuid4\n    )\n    title: Mapped[str] = mapped_column(String(255), nullable=False)\n    description: Mapped[str | None] = mapped_column(Text, nullable=True)\n    content: Mapped[dict] = mapped_column(JSON, nullable=False)  # TipTap JSON\n    status: Mapped[str] = mapped_column(String(20), nullable=False, default=\"draft\")\n    author_id: Mapped[uuid.UUID] = mapped_column(\n        Uuid(as_uuid=True), ForeignKey(\"users.id\"), nullable=False\n    )\n    created_at: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True), server_default=func.now(), nullable=False\n    )\n    updated_at: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False\n    )\n\n    # Relationships\n    author: Mapped[\"User\"] = relationship(\"User\", lazy=\"selectin\")\n\n    def __repr__(self) -> str:\n        return f\"<Report(id={self.id}, title={self.title}, status={self.status})>\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1416, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9d84ac0f-c9bb-490c-8106-d2b8f4e287f6": {"__data__": {"id_": "9d84ac0f-c9bb-490c-8106-d2b8f4e287f6", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\shared_conversation.py", "language": "python", "lines": 70, "filename": "shared_conversation.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "be81d64d-f554-4617-ba36-9494e1830d4f", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\shared_conversation.py", "language": "python", "lines": 70, "filename": "shared_conversation.py"}, "hash": "a044daf62087f5b414f8e0b5241679cd8c5fb81ec57da0dfa6a4209b4c01b854", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nShared Conversation Model\nSQLAlchemy model for shared conversations\n\"\"\"\n\nimport uuid\nfrom datetime import datetime, timedelta\nimport json\n\nfrom sqlalchemy import Boolean, DateTime, String, Uuid, Text\nfrom sqlalchemy.orm import Mapped, mapped_column\nfrom sqlalchemy.sql import func\n\nfrom app.config.database import Base\n\n\nclass SharedConversation(Base):\n    \"\"\"Shared conversation database model for public conversation links\"\"\"\n\n    __tablename__ = \"shared_conversations\"\n\n    id: Mapped[uuid.UUID] = mapped_column(\n        Uuid(as_uuid=True), primary_key=True, default=uuid.uuid4\n    )\n    share_id: Mapped[str] = mapped_column(\n        String(32), unique=True, nullable=False, index=True\n    )\n    session_id: Mapped[str] = mapped_column(String(255), nullable=False, index=True)\n    user_id: Mapped[uuid.UUID] = mapped_column(Uuid(as_uuid=True), nullable=False)\n    title: Mapped[str] = mapped_column(String(255), nullable=True)\n    messages: Mapped[str] = mapped_column(Text, nullable=False)  # JSON string\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)\n    expires_at: Mapped[datetime | None] = mapped_column(\n        DateTime(timezone=True), nullable=True\n    )\n    view_count: Mapped[int] = mapped_column(default=0, nullable=False)\n    created_at: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True), server_default=func.now(), nullable=False\n    )\n    updated_at: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False\n    )\n\n    def __repr__(self) -> str:\n        return f\"<SharedConversation(share_id={self.share_id}, session_id={self.session_id})>\"\n\n    @property\n    def messages_list(self) -> list[dict]:\n        \"\"\"Converte a string JSON de messages para uma lista Python.\"\"\"\n        try:\n            return json.loads(self.messages) if self.messages else []\n        except (json.JSONDecodeError, TypeError):\n            return []\n\n    @messages_list.setter\n    def messages_list(self, messages: list[dict]):\n        \"\"\"Define messages a partir de uma lista Python, convertendo para string JSON.\"\"\"\n        self.messages = json.dumps(messages) if messages is not None else \"[]\"\n\n    @property\n    def is_expired(self) -> bool:\n        \"\"\"Check if the shared conversation has expired.\"\"\"\n        if self.expires_at is None:\n            return False\n        return datetime.now(self.expires_at.tzinfo) > self.expires_at\n\n    def increment_view_count(self):\n        \"\"\"Increment the view counter.\"\"\"\n        self.view_count += 1", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2567, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2064ba8e-ab08-4577-adf1-3cf548819731": {"__data__": {"id_": "2064ba8e-ab08-4577-adf1-3cf548819731", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\user.py", "language": "python", "lines": 54, "filename": "user.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "54cc6769-ba4b-443d-aa5f-205a61ea7085", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\user.py", "language": "python", "lines": 54, "filename": "user.py"}, "hash": "a2701dd865d7450580e279ce85fe6a8047a1e2649ff61a3cd784e39dec07948b", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nUser Model\nSQLAlchemy model for users table\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\nimport json # Adicionado para manipula\u00e7\u00e3o de JSON string\n\nfrom sqlalchemy import Boolean, DateTime, String, Uuid, Text # Adicionado Text\nfrom sqlalchemy.orm import Mapped, mapped_column\nfrom sqlalchemy.sql import func\n\nfrom app.config.database import Base\n\n\nclass User(Base):\n    \"\"\"User database model\"\"\"\n\n    __tablename__ = \"users\"\n\n    id: Mapped[uuid.UUID] = mapped_column(\n        Uuid(as_uuid=True), primary_key=True, default=uuid.uuid4\n    )\n    username: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)\n    email: Mapped[str] = mapped_column(String(255), unique=True, nullable=False, index=True)\n    hashed_password: Mapped[str] = mapped_column(String(255), nullable=False)\n    role: Mapped[str] = mapped_column(String(20), nullable=False, default=\"viewer\")\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)\n    allowed_segments: Mapped[str] = mapped_column(Text, nullable=False, default=\"[]\") # Armazenar como JSON string\n    last_login: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)\n    created_at: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True), server_default=func.now(), nullable=False\n    )\n    updated_at: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False\n    )\n\n    def __repr__(self) -> str:\n        return f\"<User(id={self.id}, username={self.username}, role={self.role})>\"\n\n    @property\n    def segments_list(self) -> list[str]:\n        \"\"\"Converte a string JSON de allowed_segments para uma lista Python.\"\"\"\n        try:\n            return json.loads(self.allowed_segments) if self.allowed_segments else []\n        except (json.JSONDecodeError, TypeError):\n            return []\n\n    @segments_list.setter\n    def segments_list(self, segments: list[str]):\n        \"\"\"Define allowed_segments a partir de uma lista Python, convertendo para string JSON.\"\"\"\n        self.allowed_segments = json.dumps(segments) if segments is not None else \"[]\"", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2156, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b1b9b403-4417-4c76-aeb7-3f44f4cc80bd": {"__data__": {"id_": "b1b9b403-4417-4c76-aeb7-3f44f4cc80bd", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\user_preference.py", "language": "python", "lines": 51, "filename": "user_preference.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "50baffb5-891f-46e9-ba9f-5f231427eb73", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\user_preference.py", "language": "python", "lines": 51, "filename": "user_preference.py"}, "hash": "d6ce5a14474122db5bce83d8a9e495d3e93e976871e3e6bc7ff0a86aa5b49f92", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nUser Preference Model\nSQLAlchemy model for user preferences and memory\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\n\nfrom sqlalchemy import DateTime, String, Uuid, Text\nfrom sqlalchemy.orm import Mapped, mapped_column\nfrom sqlalchemy.sql import func\n\nfrom app.config.database import Base\n\n\nclass UserPreference(Base):\n    \"\"\"User preference model for storing user-specific preferences and memory\"\"\"\n\n    __tablename__ = \"user_preferences\"\n\n    id: Mapped[uuid.UUID] = mapped_column(\n        Uuid(as_uuid=True), primary_key=True, default=uuid.uuid4\n    )\n    user_id: Mapped[uuid.UUID] = mapped_column(\n        Uuid(as_uuid=True), nullable=False, index=True\n    )\n    key: Mapped[str] = mapped_column(String(100), nullable=False, index=True)\n    value: Mapped[str] = mapped_column(Text, nullable=False)\n    context: Mapped[str | None] = mapped_column(Text, nullable=True)  # Additional context\n    created_at: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True), server_default=func.now(), nullable=False\n    )\n    updated_at: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False\n    )\n\n    def __repr__(self) -> str:\n        return f\"<UserPreference(user_id={self.user_id}, key={self.key})>\"\n\n    # Common preference keys\n    class Keys:\n        \"\"\"Common preference key constants\"\"\"\n        PREFERRED_CHART_TYPE = \"preferred_chart_type\"  # bar, line, pie, scatter\n        PREFERRED_DATA_FORMAT = \"preferred_data_format\"  # table, chart, both\n        LANGUAGE = \"language\"  # pt-BR, en-US\n        THEME = \"theme\"  # light, dark\n        COMPANY_NAME = \"company_name\"\n        BUSINESS_SEGMENT = \"business_segment\"\n        ANALYSIS_FOCUS = \"analysis_focus\"  # sales, inventory, finance\n        NOTIFICATION_ENABLED = \"notification_enabled\"  # true, false", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1848, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b1831ff0-5075-497b-bfa1-9bd719798526": {"__data__": {"id_": "b1831ff0-5075-497b-bfa1-9bd719798526", "embedding": null, "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\__init__.py", "language": "python", "lines": 15, "filename": "__init__.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "e45c7760-5324-472f-80a0-430efd09f021", "node_type": "4", "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\__init__.py", "language": "python", "lines": 15, "filename": "__init__.py"}, "hash": "eabf40839a92ad265145dc7cab693dec176b8b1be3803424089d39cb7be69ef1", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nDatabase Models\nExport all models for easy imports\n\"\"\"\n\nfrom app.config.database import Base\nfrom app.infrastructure.database.models.audit_log import AuditLog\nfrom app.infrastructure.database.models.report import Report\nfrom app.infrastructure.database.models.user import User\nfrom app.infrastructure.database.models.admmatao import Admmatao\nfrom app.infrastructure.database.models.shared_conversation import SharedConversation\nfrom app.infrastructure.database.models.user_preference import UserPreference\n\n__all__ = [\"Base\", \"User\", \"Report\", \"AuditLog\", \"Admmatao\", \"SharedConversation\", \"UserPreference\"]", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 611, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "22c8a723-8d19-4c30-9b7a-b83178e4f238": {"__data__": {"id_": "22c8a723-8d19-4c30-9b7a-b83178e4f238", "embedding": null, "metadata": {"file_path": "backend\\app\\schemas\\analytics.py", "language": "python", "lines": 55, "filename": "analytics.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d4de66b4-b616-426f-858d-e555e6b6e888", "node_type": "4", "metadata": {"file_path": "backend\\app\\schemas\\analytics.py", "language": "python", "lines": 55, "filename": "analytics.py"}, "hash": "8a0477784fe01491ba610699f399e16e268dc034483aa6f57181327dd5526524", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nAnalytics Schemas\nPydantic schemas for Analytics API\n\"\"\"\n\nfrom datetime import date\nfrom typing import Literal\n\nfrom pydantic import BaseModel, Field\n\n\nclass AnalyticsFilter(BaseModel):\n    \"\"\"Analytics filter parameters\"\"\"\n\n    date_start: date | None = None\n    date_end: date | None = None\n    category: str | None = None\n    segment: str | None = None\n    min_value: float | None = None\n    max_value: float | None = None\n\n\nclass AnalyticsData(BaseModel):\n    \"\"\"Analytics data point\"\"\"\n\n    id: str\n    date: str\n    category: str\n    value: float\n    growth: float | None = None\n    metadata: dict | None = None\n\n\nclass AnalyticsMetric(BaseModel):\n    \"\"\"Analytics metric\"\"\"\n\n    label: str\n    value: float\n    format: Literal[\"currency\", \"number\", \"percentage\"]\n    trend: float | None = None\n\n\nclass ExportRequest(BaseModel):\n    \"\"\"Export request schema\"\"\"\n\n    format: Literal[\"csv\", \"excel\"] = Field(default=\"csv\")\n    filters: AnalyticsFilter | None = None\n\n\nclass CustomQueryRequest(BaseModel):\n    \"\"\"Custom query request\"\"\"\n\n    query: str = Field(..., min_length=1, max_length=1000)\n    filters: AnalyticsFilter | None = None", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1146, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ec977477-afd7-4e2c-8917-3591236d8bed": {"__data__": {"id_": "ec977477-afd7-4e2c-8917-3591236d8bed", "embedding": null, "metadata": {"file_path": "backend\\app\\schemas\\auth.py", "language": "python", "lines": 37, "filename": "auth.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "986aee79-7a40-4e5c-8c4a-ba677c3efc5e", "node_type": "4", "metadata": {"file_path": "backend\\app\\schemas\\auth.py", "language": "python", "lines": 37, "filename": "auth.py"}, "hash": "4c68025dc5aaeec27b459e2c4ea2f980684d0e1d3aa598b8d1d0ec37a0a07bf6", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nAuth Schemas\nPydantic schemas for Authentication\n\"\"\"\n\nfrom pydantic import BaseModel, EmailStr, Field\n\n\nclass Token(BaseModel):\n    \"\"\"Token response schema\"\"\"\n\n    access_token: str\n    refresh_token: str\n    token_type: str = \"bearer\"\n\n\nclass TokenData(BaseModel):\n    \"\"\"Token payload data\"\"\"\n\n    user_id: str\n    username: str\n    role: str\n    allowed_segments: list[str] = Field(default_factory=list) # Novo Campo\n\n\nclass LoginRequest(BaseModel):\n    \"\"\"Login request schema\"\"\"\n\n    username: str = Field(..., min_length=3, max_length=50)\n    password: str = Field(..., min_length=8, max_length=100)\n\n\nclass RefreshTokenRequest(BaseModel):\n    \"\"\"Refresh token request schema\"\"\"\n\n    refresh_token: str", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 713, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "dee21d55-3a8b-45f3-b096-18e3e2396110": {"__data__": {"id_": "dee21d55-3a8b-45f3-b096-18e3e2396110", "embedding": null, "metadata": {"file_path": "backend\\app\\schemas\\report.py", "language": "python", "lines": 61, "filename": "report.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a2d5c3b6-9721-4d11-b886-23c01d077a5d", "node_type": "4", "metadata": {"file_path": "backend\\app\\schemas\\report.py", "language": "python", "lines": 61, "filename": "report.py"}, "hash": "76ea8ed83fabb615c464d54c0f10e624e8c303e882d76d914e5440273e043e2c", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nReport Schemas\nPydantic schemas for Report API\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\n\nfrom pydantic import BaseModel, Field\n\n\nclass ReportBase(BaseModel):\n    \"\"\"Base report schema\"\"\"\n\n    title: str = Field(..., min_length=1, max_length=255)\n    description: str | None = None\n\n\nclass ReportCreate(ReportBase):\n    \"\"\"Schema for creating a report\"\"\"\n\n    content: dict = Field(default_factory=dict)  # TipTap JSON\n    status: str = Field(default=\"draft\", pattern=\"^(draft|published|archived)$\")\n\n\nclass ReportUpdate(BaseModel):\n    \"\"\"Schema for updating a report\"\"\"\n\n    title: str | None = Field(None, min_length=1, max_length=255)\n    description: str | None = None\n    content: dict | None = None\n    status: str | None = Field(None, pattern=\"^(draft|published|archived)$\")\n\n\nclass ReportResponse(ReportBase):\n    \"\"\"Schema for report response\"\"\"\n\n    id: uuid.UUID\n    content: dict\n    status: str\n    author_id: uuid.UUID\n    author_name: str | None = None\n    created_at: datetime\n    updated_at: datetime\n\n    model_config = {\"from_attributes\": True}\n\n\nclass ReportListResponse(BaseModel):\n    \"\"\"Schema for report list response\"\"\"\n\n    id: uuid.UUID\n    title: str\n    description: str | None\n    status: str\n    author_id: uuid.UUID\n    created_at: datetime\n    updated_at: datetime\n\n    model_config = {\"from_attributes\": True}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1353, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "dc86671d-02ca-4b37-990d-7a6b635e05b7": {"__data__": {"id_": "dc86671d-02ca-4b37-990d-7a6b635e05b7", "embedding": null, "metadata": {"file_path": "backend\\app\\schemas\\user.py", "language": "python", "lines": 68, "filename": "user.py"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "19bb81de-ecb8-418e-b274-7bfe2361812f", "node_type": "4", "metadata": {"file_path": "backend\\app\\schemas\\user.py", "language": "python", "lines": 68, "filename": "user.py"}, "hash": "d339f5282dc5b80f5c1c0a3465155fb8c30beac498e08a15c67a05ef0ffd5830", "class_name": "RelatedNodeInfo"}}, "text": "\"\"\"\nUser Schemas\nPydantic schemas for User API\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\n\nfrom pydantic import BaseModel, EmailStr, Field\n\n\nclass UserBase(BaseModel):\n    \"\"\"Base user schema\"\"\"\n\n    username: str = Field(..., min_length=3, max_length=50)\n    email: EmailStr\n\n\nclass UserCreate(UserBase):\n    \"\"\"Schema for creating a user\"\"\"\n\n    password: str = Field(..., min_length=8, max_length=100)\n    role: str = Field(default=\"viewer\", pattern=\"^(admin|user|viewer)$\")\n    allowed_segments: list[str] = Field(default_factory=list) # Novo Campo\n\n\nclass UserUpdate(BaseModel):\n    \"\"\"Schema for updating a user\"\"\"\n\n    username: str | None = Field(None, min_length=3, max_length=50)\n    email: EmailStr | None = None\n    role: str | None = Field(None, pattern=\"^(admin|user|viewer)$\")\n    is_active: bool | None = None\n    allowed_segments: list[str] | None = Field(None) # Novo Campo\n    password: str | None = Field(None, min_length=8, max_length=100)\n\n\nclass UserResponse(UserBase):\n    \"\"\"Schema for user response\"\"\"\n\n    id: uuid.UUID\n    role: str\n    is_active: bool\n    allowed_segments: list[str] = Field(default_factory=list) # Novo Campo com default\n    last_login: datetime | None\n    created_at: datetime\n    updated_at: datetime\n\n    model_config = {\"from_attributes\": True}\n\n    @classmethod\n    def model_validate(cls, obj, **kwargs):\n        \"\"\"Custom validation to handle allowed_segments conversion from JSON string\"\"\"\n        if hasattr(obj, 'allowed_segments') and isinstance(obj.allowed_segments, str):\n            # Convert JSON string to list\n            import json\n            try:\n                obj.allowed_segments = json.loads(obj.allowed_segments) if obj.allowed_segments else []\n            except (json.JSONDecodeError, TypeError):\n                obj.allowed_segments = []\n        return super().model_validate(obj, **kwargs)\n\n\nclass UserInDB(UserResponse):\n    \"\"\"Schema for user in database (includes hashed password)\"\"\"\n\n    hashed_password: str", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1994, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "15453c59-d3dc-4f80-a018-2098e91f680f": {"__data__": {"id_": "15453c59-d3dc-4f80-a018-2098e91f680f", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\index.tsx", "language": "typescript", "lines": 158, "filename": "index.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1a986fab-103a-41f1-bd7b-c7b25aeab08e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\index.tsx", "language": "typescript", "lines": 158, "filename": "index.tsx"}, "hash": "ac8cd5dbc42930dc313a3f2f9fee2487ce1928cdecd446ea0e4e4805ef657671", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "40b87286-fb0a-457f-ae14-6d45bade3d45", "node_type": "1", "metadata": {}, "hash": "e12e534429709c8a6da008d7ffc24fd93d1e71923e5947372bab6e9fa1ace22b", "class_name": "RelatedNodeInfo"}}, "text": "/* src/index.tsx - Vers\u00e3o ULTRA SIMPLIFICADA sem verifica\u00e7\u00e3o de vers\u00e3o */\nimport { render } from 'solid-js/web';\nimport { Router, Route, Navigate } from '@solidjs/router';\nimport { Show } from 'solid-js';\nimport { QueryClient, QueryClientProvider } from '@tanstack/solid-query';\nimport './index.css';\n\n// Importar Layout e P\u00e1ginas\nimport Layout from './Layout';\nimport Login from './pages/Login';\nimport Dashboard from './pages/Dashboard';\nimport Chat from './pages/Chat';\nimport Analytics from './pages/Analytics';\nimport Reports from './pages/Reports';\nimport Learning from './pages/Learning';\nimport Playground from './pages/Playground';\nimport Profile from './pages/Profile';\nimport Admin from './pages/Admin';\nimport Rupturas from './pages/Rupturas';\nimport Transfers from './pages/Transfers';\nimport Diagnostics from './pages/Diagnostics';\nimport Examples from './pages/Examples';\nimport Help from './pages/Help';\nimport SharedConversation from './pages/SharedConversation';\nimport CodeChat from './pages/CodeChat';\n\n// Importar Store de Autentica\u00e7\u00e3o\nimport auth from './store/auth';\n\nconsole.log('\u2705 All imports loaded successfully');\n\n// Componente de Prote\u00e7\u00e3o de Rotas\nfunction PrivateRoute(props: { component: any }) {\n  return (\n    <Show\n      when={auth.isAuthenticated()}\n      fallback={<Navigate href=\"/login\" />}\n    >\n      {props.component}\n    </Show>\n  );\n}\n\n// Componente de Prote\u00e7\u00e3o de Rotas com RBAC\nfunction RoleRoute(props: { component: any; requiredRole: string }) {\n  return (\n    <Show\n      when={auth.isAuthenticated()}\n      fallback={<Navigate href=\"/login\" />}\n    >\n      <Show\n        when={auth.user()?.role === props.requiredRole}\n        fallback={\n          <div class=\"flex items-center justify-center min-h-screen flex-col gap-4 p-8\">\n            <h1 class=\"text-4xl font-bold text-destructive\">Acesso Negado</h1>\n            <p class=\"text-lg text-muted-foreground\">Voc\u00ea n\u00e3o tem permiss\u00e3o para acessar esta p\u00e1gina.</p>\n            <p class=\"text-sm text-muted-foreground\">403 - Forbidden</p>\n          </div>\n        }\n      >\n        {props.component}\n      </Show>\n    </Show>\n  );\n}\n\n// Componente Principal da Aplica\u00e7\u00e3o\nfunction App() {\n  console.log('\u2705 App component created');\n  return (\n    <Router>\n      {/* Rotas P\u00fablicas */}\n      <Route path=\"/login\" component={Login} />\n      <Route path=\"/shared/:share_id\" component={SharedConversation} />\n\n      {/* Rota raiz - redireciona baseado em autentica\u00e7\u00e3o */}\n      <Route path=\"/\" component={() => {\n        return (\n          <Show\n            when={auth.isAuthenticated()}\n            fallback={<Navigate href=\"/login\" />}\n          >\n            <Navigate href=\"/dashboard\" />\n          </Show>\n        );", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2710, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "40b87286-fb0a-457f-ae14-6d45bade3d45": {"__data__": {"id_": "40b87286-fb0a-457f-ae14-6d45bade3d45", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\index.tsx", "language": "typescript", "lines": 158, "filename": "index.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1a986fab-103a-41f1-bd7b-c7b25aeab08e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\index.tsx", "language": "typescript", "lines": 158, "filename": "index.tsx"}, "hash": "ac8cd5dbc42930dc313a3f2f9fee2487ce1928cdecd446ea0e4e4805ef657671", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "15453c59-d3dc-4f80-a018-2098e91f680f", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\index.tsx", "language": "typescript", "lines": 158, "filename": "index.tsx"}, "hash": "8b715f0adb1c8040459eff932983aaecbedf17e92e503090006dd5948fa3060c", "class_name": "RelatedNodeInfo"}}, "text": "</p>\n            <p class=\"text-sm text-muted-foreground\">403 - Forbidden</p>\n          </div>\n        }\n      >\n        {props.component}\n      </Show>\n    </Show>\n  );\n}\n\n// Componente Principal da Aplica\u00e7\u00e3o\nfunction App() {\n  console.log('\u2705 App component created');\n  return (\n    <Router>\n      {/* Rotas P\u00fablicas */}\n      <Route path=\"/login\" component={Login} />\n      <Route path=\"/shared/:share_id\" component={SharedConversation} />\n\n      {/* Rota raiz - redireciona baseado em autentica\u00e7\u00e3o */}\n      <Route path=\"/\" component={() => {\n        return (\n          <Show\n            when={auth.isAuthenticated()}\n            fallback={<Navigate href=\"/login\" />}\n          >\n            <Navigate href=\"/dashboard\" />\n          </Show>\n        );\n      }} />\n\n      {/* Rotas Protegidas - Dentro do Layout */}\n      <Route path=\"/\" component={Layout}>\n        <Route path=\"/dashboard\" component={() => <PrivateRoute component={<Dashboard />} />} />\n        <Route path=\"/metrics\" component={() => <RoleRoute component={<Analytics />} requiredRole=\"admin\" />} />\n        <Route path=\"/rupturas\" component={() => <PrivateRoute component={<Rupturas />} />} />\n        <Route path=\"/transfers\" component={() => <PrivateRoute component={<Transfers />} />} />\n        <Route path=\"/reports\" component={() => <RoleRoute component={<Reports />} requiredRole=\"admin\" />} />\n        <Route path=\"/chat\" component={() => <PrivateRoute component={<Chat />} />} />\n        <Route path=\"/examples\" component={() => <RoleRoute component={<Examples />} requiredRole=\"admin\" />} />\n        <Route path=\"/learning\" component={() => <RoleRoute component={<Learning />} requiredRole=\"admin\" />} />\n        <Route path=\"/playground\" component={() => <RoleRoute component={<Playground />} requiredRole=\"admin\" />} />\n        <Route path=\"/code-chat\" component={() => <RoleRoute component={<CodeChat />} requiredRole=\"admin\" />} />\n        <Route path=\"/diagnostics\" component={() => <RoleRoute component={<Diagnostics />} requiredRole=\"admin\" />} />\n        <Route path=\"/help\" component={() => <PrivateRoute component={<Help />} />} />\n        <Route path=\"/profile\" component={() => <PrivateRoute component={<Profile />} />} />\n        <Route path=\"/admin\" component={() => <RoleRoute component={<Admin />} requiredRole=\"admin\" />} />\n      </Route>\n\n      {/* Fallback */}\n      <Route path=\"*\" component={() => (\n        <Show\n          when={auth.isAuthenticated()}\n          fallback={<Navigate href=\"/login\" />}\n        >\n          <Navigate href=\"/dashboard\" />\n        </Show>\n      )} />\n    </Router>\n  );\n}\n\n// Renderizar a Aplica\u00e7\u00e3o no DOM\nconst root = document.getElementById('root');\n\nif (!root) {\n  console.error('\u274c ROOT ELEMENT NOT FOUND!');\n  throw new Error('Root element not found');\n}\n\nconsole.log('\u2705 Root element found:', root);\n\n// Create QueryClient\nconst queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      retry: 1,\n      refetchOnWindowFocus: false,\n    },\n  },\n});\n\nconsole.log('\u2705 QueryClient created');\n\n// Render app\ntry {\n  render(() => (\n    <QueryClientProvider client={queryClient}>\n      <App />\n    </QueryClientProvider>\n  ), root);\n  console.log('\u2705 App rendered successfully!');\n} catch (error) {\n  console.error('\u274c Error rendering app:', error);\n  document.body.innerHTML = `\n    <div style=\"padding: 20px; color: white; background: #1a1a1a; font-family: sans-serif;\">\n      <h1 style=\"color: #ef4444;\">\u274c Erro ao Renderizar Aplica\u00e7\u00e3o</h1>\n      <pre style=\"background: #2a2a2a; padding: 10px; border-radius: 5px; overflow: auto;\">${error}</pre>\n      <p>Verifique o console do navegador (F12) para mais detalhes.</p>\n    </div>\n  `;\n}", "mimetype": "text/plain", "start_char_idx": 1956, "end_char_idx": 5636, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "46fed4cb-1b39-4339-84c1-c7795188164b": {"__data__": {"id_": "46fed4cb-1b39-4339-84c1-c7795188164b", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\index_minimal_test.tsx", "language": "typescript", "lines": 11, "filename": "index_minimal_test.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2995b554-16b2-47a1-8290-752393aab1ae", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\index_minimal_test.tsx", "language": "typescript", "lines": 11, "filename": "index_minimal_test.tsx"}, "hash": "a71998828cad36c2ad54ef08c80a883781149c366a40cbc0a44d0d71e5fe67e7", "class_name": "RelatedNodeInfo"}}, "text": "/* src/index.tsx - TESTE M\u00cdNIMO */\nconsole.log('\ud83d\ude80 TESTE: Script carregado!');\n\nconst root = document.getElementById('root');\nif (root) {\n  root.innerHTML = '<div style=\"color: white; padding: 20px; font-size: 24px;\">\u2705 TESTE: JavaScript est\u00e1 funcionando!</div>';\n  console.log('\u2705 TESTE: innerHTML definido!');\n} else {\n  console.error('\u274c TESTE: Elemento root n\u00e3o encontrado!');\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 378, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "09aa36da-5f6d-4fb6-82ab-d6e3df12184d": {"__data__": {"id_": "09aa36da-5f6d-4fb6-82ab-d6e3df12184d", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\Layout.tsx", "language": "typescript", "lines": 135, "filename": "Layout.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2210e22d-819c-4ee8-b4bf-a668724032f4", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\Layout.tsx", "language": "typescript", "lines": 135, "filename": "Layout.tsx"}, "hash": "179f242cd05a2a4315c856f3c63f4a0a06935e03a3a4f702ba7170b76a59d4d3", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "efd292d3-6c16-403d-a12c-37c0a10867b6", "node_type": "1", "metadata": {}, "hash": "2bdab682bb17e5389e44a384f08d7bc19ce2860b42f8f5d87f99ff92893f9d50", "class_name": "RelatedNodeInfo"}}, "text": "import { A, useLocation } from '@solidjs/router';\nimport auth from '@/store/auth';\nimport {\n  LayoutDashboard, MessageSquare, PieChart, FileText, Settings, LogOut,\n  AlertTriangle, Truck, BookOpen, Terminal, Database, Lock, Shield, Lightbulb, HelpCircle, Code\n} from 'lucide-solid';\nimport { For, Show, children } from 'solid-js';\nimport { ErrorBoundary } from './components/ErrorBoundary';\nimport { Logo } from '@/components';\n\nexport default function Layout(props: any) {\n  const location = useLocation();\n  const userRole = () => auth.user()?.role || 'user'; // fallback para 'user' garante visibilidade\n\n  // Defini\u00e7\u00e3o dos Itens de Menu com Permiss\u00f5es\n  const menuItems = [\n    {\n      group: 'Dashboards',\n      items: [\n        { href: '/dashboard', icon: LayoutDashboard, label: 'Monitoramento', roles: ['admin', 'user'] },\n        { href: '/metrics', icon: PieChart, label: 'M\u00e9tricas', roles: ['admin'] },\n        { href: '/rupturas', icon: AlertTriangle, label: 'Rupturas Cr\u00edticas', roles: ['admin', 'user'] },\n      ]\n    },\n    {\n      group: 'Operacional',\n      items: [\n        { href: '/transfers', icon: Truck, label: 'Transfer\u00eancias', roles: ['admin', 'user'] },\n        { href: '/reports', icon: FileText, label: 'Relat\u00f3rios', roles: ['admin'] },\n      ]\n    },\n    {\n      group: 'Intelig\u00eancia',\n      items: [\n        { href: '/chat', icon: MessageSquare, label: 'Chat BI', roles: ['admin', 'user'] },\n        { href: '/code-chat', icon: Code, label: 'Code Chat', roles: ['admin'] },\n        { href: '/examples', icon: Lightbulb, label: 'Exemplos', roles: ['admin'] },\n        { href: '/learning', icon: BookOpen, label: 'Aprendizado', roles: ['admin'] },\n        { href: '/playground', icon: Terminal, label: 'Playground', roles: ['admin'] },\n      ]\n    },\n    {\n      group: 'Sistema',\n      items: [\n        { href: '/diagnostics', icon: Database, label: 'Diagn\u00f3stico DB', roles: ['admin'] },\n        { href: '/help', icon: HelpCircle, label: 'Ajuda', roles: ['admin', 'user'] },\n        { href: '/profile', icon: Lock, label: 'Alterar Senha', roles: ['admin', 'user'] },\n        { href: '/admin', icon: Shield, label: 'Administra\u00e7\u00e3o', roles: ['admin'] },\n      ]\n    }\n  ];\n\n  const NavItem = (props: { href: string; icon: any; label: string }) => (\n    <A \n      href={props.href} \n      class={`nav-item ${location.pathname.includes(props.href) ?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2373, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "efd292d3-6c16-403d-a12c-37c0a10867b6": {"__data__": {"id_": "efd292d3-6c16-403d-a12c-37c0a10867b6", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\Layout.tsx", "language": "typescript", "lines": 135, "filename": "Layout.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2210e22d-819c-4ee8-b4bf-a668724032f4", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\Layout.tsx", "language": "typescript", "lines": 135, "filename": "Layout.tsx"}, "hash": "179f242cd05a2a4315c856f3c63f4a0a06935e03a3a4f702ba7170b76a59d4d3", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "09aa36da-5f6d-4fb6-82ab-d6e3df12184d", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\Layout.tsx", "language": "typescript", "lines": 135, "filename": "Layout.tsx"}, "hash": "ef2b34e578b5fa21ba226ff87b50b1949fb345718dd8735977c7f0c23c6ea6b4", "class_name": "RelatedNodeInfo"}}, "text": "'active' : ''}`}\n    >\n      <props.icon size={18} />\n      <span>{props.label}</span>\n    </A>\n  );\n\n  return (\n    <div class=\"app-layout\">\n      <aside class=\"sidebar\">\n        <div class=\"p-6 flex flex-col gap-3\">\n          <div class=\"flex items-center gap-3\">\n            <Logo size=\"md\" />\n            <span class=\"text-xs font-normal text-muted px-2 py-1 rounded bg-secondary border border-border capitalize\">\n              {String(userRole())}\n            </span>\n          </div>\n          <div class=\"flex flex-col gap-0.5\">\n            <h2 class=\"text-base font-bold text-primary\">CA\u00c7ULINHA BI</h2>\n            <span class=\"text-xs text-muted-foreground\">Intelig\u00eancia de Neg\u00f3cios</span>\n          </div>\n        </div>\n        \n        <nav class=\"flex-1 overflow-y-auto py-2\">\n          <For each={menuItems}>\n            {(group) => {\n              // Filtrar itens baseados na role\n              const visibleItems = group.items.filter(item => item.roles.includes(userRole()) || item.roles.includes('*'));\n              \n              return (\n                <Show when={visibleItems.length > 0}>\n                  <div class=\"mb-6\">\n                    <div class=\"px-6 mb-2 text-xs font-semibold text-muted uppercase tracking-wider opacity-70\">\n                      {group.group}\n                    </div>\n                    <For each={visibleItems}>\n                      {(item) => (\n                        <NavItem href={item.href} icon={item.icon} label={item.label} />\n                      )}\n                    </For>\n                  </div>\n                </Show>\n              );\n            }}\n          </For>\n        </nav>\n\n        <div class=\"p-4 border-t border-border\">\n          <button onClick={auth.logout} class=\"nav-item w-full justify-start text-destructive hover:bg-destructive/10 hover:text-destructive m-0\">\n            <LogOut size={18} />\n            <span>Sair</span>\n          </button>\n        </div>\n      </aside>\n\n      <div class=\"flex flex-col h-screen overflow-hidden\">\n        <header class=\"header justify-between\">\n          <div class=\"text-sm text-muted\">\n            Organiza\u00e7\u00e3o <span class=\"text-border mx-2\">/</span> <span class=\"text-foreground font-medium capitalize\">{location.pathname.replace('/', '') || 'Dashboard'}</span>\n          </div>\n          \n          <div class=\"flex items-center gap-4\">\n             <div class=\"text-right hidden md:block\">\n                <div class=\"text-sm font-medium\">{auth.user()?.username || 'Usu\u00e1rio'}</div>\n                <div class=\"text-xs text-muted\">{auth.user()?.email}</div>\n             </div>\n             <div class=\"w-8 h-8 bg-gradient-to-br from-primary to-accent rounded-full flex items-center justify-center font-bold text-white text-xs uppercase shadow-sm\">\n                {(auth.user()?.username || 'U').slice(0, 2).toUpperCase()}\n             </div>\n          </div>\n        </header>\n        <main class=\"flex-1 overflow-y-auto relative bg-background\">\n          <ErrorBoundary>\n            {props.children}\n          </ErrorBoundary>\n        </main>\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 2374, "end_char_idx": 5487, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "81a90d2a-574d-4ae2-a300-c3e4c993fa6c": {"__data__": {"id_": "81a90d2a-574d-4ae2-a300-c3e4c993fa6c", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\AIInsightsPanel.tsx", "language": "typescript", "lines": 173, "filename": "AIInsightsPanel.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "643e9968-020a-4265-ba3a-c136bb3fb51b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\AIInsightsPanel.tsx", "language": "typescript", "lines": 173, "filename": "AIInsightsPanel.tsx"}, "hash": "47d29b66d8f258925822618dd7cd78d85743c70ebf61b3e668a7274528d5571c", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "53323c09-9b3f-49ff-b1f8-f499b3741ed9", "node_type": "1", "metadata": {}, "hash": "404c7008058e56664d58fc9e26ab4eedc4b111524a64d73f479e58a03b0e9440", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, createResource, For, Show } from 'solid-js';\nimport { Lightbulb, TrendingUp, AlertTriangle, Target, Sparkles, RefreshCw } from 'lucide-solid';\nimport auth from '@/store/auth';\n\ninterface Insight {\n  id: string;\n  title: string;\n  description: string;\n  category: 'trend' | 'anomaly' | 'opportunity' | 'risk';\n  severity: 'low' | 'medium' | 'high';\n  recommendation: string | null;\n  data_points: any[] | null;\n  created_at: string;\n}\n\ninterface InsightsData {\n  insights: Insight[];\n  total: number;\n  generated_at: string;\n}\n\nexport function AIInsightsPanel() {\n  const [isRefreshing, setIsRefreshing] = createSignal(false);\n\n  const fetchInsights = async (): Promise<InsightsData> => {\n    const token = auth.token();\n    if (!token) throw new Error('Not authenticated');\n\n    const response = await fetch('/api/v1/insights/proactive', {\n      headers: { 'Authorization': `Bearer ${token}` }\n    });\n\n    if (!response.ok) {\n      throw new Error('Failed to fetch insights');\n    }\n\n    return response.json();\n  };\n\n  const [insights, { refetch }] = createResource(fetchInsights);\n\n  const refreshInsights = async () => {\n    setIsRefreshing(true);\n    await refetch();\n    setTimeout(() => setIsRefreshing(false), 500);\n  };\n\n  const getCategoryIcon = (category: string) => {\n    switch (category) {\n      case 'trend': return <TrendingUp size={20} />;\n      case 'anomaly': return <AlertTriangle size={20} />;\n      case 'opportunity': return <Target size={20} />;\n      case 'risk': return <AlertTriangle size={20} />;\n      default: return <Lightbulb size={20} />;\n    }\n  };\n\n  const getCategoryColor = (category: string) => {\n    switch (category) {\n      case 'trend': return 'text-blue-500 bg-blue-500/10 border-blue-500/20';\n      case 'anomaly': return 'text-yellow-500 bg-yellow-500/10 border-yellow-500/20';\n      case 'opportunity': return 'text-green-500 bg-green-500/10 border-green-500/20';\n      case 'risk': return 'text-red-500 bg-red-500/10 border-red-500/20';\n      default: return 'text-gray-500 bg-gray-500/10 border-gray-500/20';\n    }\n  };\n\n  const getSeverityBadge = (severity: string) => {\n    const colors = {\n      low: 'bg-green-500/20 text-green-500 border-green-500/30',\n      medium: 'bg-yellow-500/20 text-yellow-500 border-yellow-500/30',\n      high: 'bg-red-500/20 text-red-500 border-red-500/30'\n    };\n\n    return colors[severity as keyof typeof colors] || colors.low;\n  };\n\n  return (\n    <div class=\"space-y-4\">\n      <div class=\"flex items-center justify-between\">\n        <div class=\"flex items-center gap-2\">\n          <Sparkles class=\"text-primary\" size={24} />\n          <h3 class=\"text-xl font-semibold\">AI Insights</h3>\n        </div>\n        <button\n          onClick={refreshInsights}\n          disabled={isRefreshing() || insights.loading}\n          class=\"flex items-center gap-2 px-3 py-2 text-sm rounded-lg border hover:bg-muted transition-colors disabled:opacity-50\"\n          title=\"Atualizar insights\"\n        >\n          <RefreshCw size={16} class={isRefreshing() ?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3048, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "53323c09-9b3f-49ff-b1f8-f499b3741ed9": {"__data__": {"id_": "53323c09-9b3f-49ff-b1f8-f499b3741ed9", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\AIInsightsPanel.tsx", "language": "typescript", "lines": 173, "filename": "AIInsightsPanel.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "643e9968-020a-4265-ba3a-c136bb3fb51b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\AIInsightsPanel.tsx", "language": "typescript", "lines": 173, "filename": "AIInsightsPanel.tsx"}, "hash": "47d29b66d8f258925822618dd7cd78d85743c70ebf61b3e668a7274528d5571c", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "81a90d2a-574d-4ae2-a300-c3e4c993fa6c", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\components\\AIInsightsPanel.tsx", "language": "typescript", "lines": 173, "filename": "AIInsightsPanel.tsx"}, "hash": "f22db8179897922e5e7a92fbe66b0a1752ad1b893e186948c0225a22f44dc267", "class_name": "RelatedNodeInfo"}}, "text": "'animate-spin' : ''} />\n          <span>Atualizar</span>\n        </button>\n      </div>\n\n      <Show when={insights.loading}>\n        <div class=\"flex items-center justify-center py-12\">\n          <div class=\"text-center\">\n            <div class=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4\"></div>\n            <p class=\"text-muted-foreground\">Gerando insights com IA...</p>\n          </div>\n        </div>\n      </Show>\n\n      <Show when={insights.error}>\n        <div class=\"p-4 rounded-lg bg-red-500/10 border border-red-500/20 text-red-500\">\n          <p class=\"font-semibold mb-1\">Erro ao carregar insights</p>\n          <p class=\"text-sm\">{insights.error.message}</p>\n        </div>\n      </Show>\n\n      <Show when={!insights.loading && !insights.error && insights()}>\n        <div class=\"space-y-3\">\n          <Show when={insights()!.insights.length === 0}>\n            <div class=\"p-6 text-center text-muted-foreground border rounded-lg\">\n              <Lightbulb size={48} class=\"mx-auto mb-3 opacity-50\" />\n              <p>Nenhum insight dispon\u00edvel no momento.</p>\n              <p class=\"text-sm mt-2\">Tente novamente mais tarde ou adicione mais dados.</p>\n            </div>\n          </Show>\n\n          <For each={insights()!.insights}>\n            {(insight) => (\n              <div class={`p-4 rounded-lg border ${getCategoryColor(insight.category)}`}>\n                <div class=\"flex items-start gap-3\">\n                  <div class=\"mt-1\">\n                    {getCategoryIcon(insight.category)}\n                  </div>\n                  <div class=\"flex-1\">\n                    <div class=\"flex items-start justify-between gap-2 mb-2\">\n                      <h4 class=\"font-semibold\">{insight.title}</h4>\n                      <span class={`text-xs px-2 py-1 rounded border ${getSeverityBadge(insight.severity)}`}>\n                        {insight.severity.toUpperCase()}\n                      </span>\n                    </div>\n                    <p class=\"text-sm mb-3\">{insight.description}</p>\n\n                    <Show when={insight.recommendation}>\n                      <div class=\"mt-3 p-3 rounded bg-background/50 border\">\n                        <p class=\"text-xs font-semibold mb-1\">\ud83d\udca1 Recomenda\u00e7\u00e3o:</p>\n                        <p class=\"text-sm\">{insight.recommendation}</p>\n                      </div>\n                    </Show>\n\n                    <Show when={insight.data_points && insight.data_points.length > 0}>\n                      <details class=\"mt-3\">\n                        <summary class=\"text-xs text-muted-foreground cursor-pointer hover:text-foreground\">\n                          Ver dados ({insight.data_points!.length} pontos)\n                        </summary>\n                        <div class=\"mt-2 p-2 rounded bg-background/30 text-xs font-mono max-h-32 overflow-auto\">\n                          <pre>{JSON.stringify(insight.data_points, null, 2)}</pre>\n                        </div>\n                      </details>\n                    </Show>\n\n                    <div class=\"text-xs text-muted-foreground mt-3\">\n                      {new Date(insight.created_at).toLocaleString('pt-BR')}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n          </For>\n        </div>\n\n        <div class=\"text-xs text-muted-foreground text-center pt-2\">\n          {insights()!.total} insights gerados em {new Date(insights()!.generated_at).toLocaleTimeString('pt-BR')}\n        </div>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 3049, "end_char_idx": 6609, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "73adaafa-dc61-4a99-8176-a3e29ff98dce": {"__data__": {"id_": "73adaafa-dc61-4a99-8176-a3e29ff98dce", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\ChartDownloadButton.tsx", "language": "typescript", "lines": 123, "filename": "ChartDownloadButton.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "e4f8a88e-a468-459f-be6a-731cf35faf13", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\ChartDownloadButton.tsx", "language": "typescript", "lines": 123, "filename": "ChartDownloadButton.tsx"}, "hash": "d0ff18660bc5bf82c0af8120f6eb0a5fcb8672113349284ef706c697c58ef345", "class_name": "RelatedNodeInfo"}}, "text": "// frontend-solid/src/components/ChartDownloadButton.tsx\n\nimport { Component, Show } from 'solid-js';\nimport { Download } from 'lucide-solid';\nimport Plotly from 'plotly.js-dist-min';\n\ninterface ChartDownloadButtonProps {\n  chartId: string;\n  filename?: string;\n  format?: 'png' | 'svg' | 'jpeg';\n  width?: number;\n  height?: number;\n  scale?: number;\n  label?: string;\n}\n\nexport const ChartDownloadButton: Component<ChartDownloadButtonProps> = (props) => {\n  const handleDownload = async () => {\n    const chartDiv = document.getElementById(props.chartId);\n\n    if (!chartDiv) {\n      alert('Gr\u00e1fico n\u00e3o encontrado');\n      return;\n    }\n\n    try {\n      const filename = props.filename || `grafico_${new Date().toISOString().split('T')[0]}`;\n      const format = props.format || 'png';\n      const width = props.width || 1200;\n      const height = props.height || 800;\n      const scale = props.scale || 2;\n\n      await Plotly.downloadImage(chartDiv, {\n        format: format,\n        filename: filename,\n        width: width,\n        height: height,\n        scale: scale\n      });\n    } catch (error) {\n      console.error(\"Erro ao baixar gr\u00e1fico:\", error);\n      alert(\"Erro ao baixar gr\u00e1fico. Tente novamente.\");\n    }\n  };\n\n  return (\n    <button\n      onClick={handleDownload}\n      class=\"btn btn-sm btn-outline gap-2\"\n      title=\"Baixar gr\u00e1fico como imagem\"\n    >\n      <Download size={16} />\n      {props.label || 'Baixar Gr\u00e1fico'}\n    </button>\n  );\n};\n\n// Componente para download de m\u00faltiplos formatos\ninterface MultiFormatDownloadProps {\n  chartId: string;\n  filename?: string;\n}\n\nexport const MultiFormatDownload: Component<MultiFormatDownloadProps> = (props) => {\n  const [showMenu, setShowMenu] = [false, (v: boolean) => {}];\n\n  const downloadFormat = async (format: 'png' | 'svg' | 'jpeg') => {\n    const chartDiv = document.getElementById(props.chartId);\n\n    if (!chartDiv) {\n      alert('Gr\u00e1fico n\u00e3o encontrado');\n      return;\n    }\n\n    try {\n      const filename = props.filename || `grafico_${new Date().toISOString().split('T')[0]}`;\n\n      await Plotly.downloadImage(chartDiv, {\n        format: format,\n        filename: filename,\n        width: 1200,\n        height: 800,\n        scale: 2\n      });\n    } catch (error) {\n      console.error(\"Erro ao baixar gr\u00e1fico:\", error);\n      alert(\"Erro ao baixar gr\u00e1fico. Tente novamente.\");\n    }\n  };\n\n  return (\n    <div class=\"relative inline-block\">\n      <button\n        class=\"btn btn-sm btn-outline gap-2\"\n        title=\"Baixar gr\u00e1fico\"\n      >\n        <Download size={16} />\n        <span>Baixar</span>\n      </button>\n      <div class=\"absolute right-0 mt-1 w-32 bg-card border rounded-lg shadow-lg z-10 py-1\">\n        <button\n          onClick={() => downloadFormat('png')}\n          class=\"w-full px-3 py-2 text-left text-sm hover:bg-muted transition-colors\"\n        >\n          PNG (Alta Qualidade)\n        </button>\n        <button\n          onClick={() => downloadFormat('svg')}\n          class=\"w-full px-3 py-2 text-left text-sm hover:bg-muted transition-colors\"\n        >\n          SVG (Vetorial)\n        </button>\n        <button\n          onClick={() => downloadFormat('jpeg')}\n          class=\"w-full px-3 py-2 text-left text-sm hover:bg-muted transition-colors\"\n        >\n          JPEG\n        </button>\n      </div>\n    </div>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3328, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6e49edac-1e90-4008-b2af-0ad97ccf877a": {"__data__": {"id_": "6e49edac-1e90-4008-b2af-0ad97ccf877a", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\DataTable.tsx", "language": "typescript", "lines": 126, "filename": "DataTable.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "70106f2e-7567-435e-acd4-f7e6b59fc3d7", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\DataTable.tsx", "language": "typescript", "lines": 126, "filename": "DataTable.tsx"}, "hash": "a4601452557316f1ff96f2b9e5db398d51f1a8547a6b39086954bfa36a6939d0", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "7753a2e9-c2e3-4317-b054-63d9a6148743", "node_type": "1", "metadata": {}, "hash": "3b77720c6acc2496c60f1910b66b7ef8a538f222f775f41c666c006e61e6db5a", "class_name": "RelatedNodeInfo"}}, "text": "// frontend-solid/src/components/DataTable.tsx\n\nimport { createSignal, For, Show, Accessor } from 'solid-js';\n\ninterface DataTableProps {\n  data: Accessor<any[]>;\n  caption?: string;\n  itemsPerPage?: number;\n}\n\nexport const DataTable = (props: DataTableProps) => {\n  const [currentPage, setCurrentPage] = createSignal(1);\n  const itemsPerPage = props.itemsPerPage || 10;\n\n  const tableData = () => props.data();\n  const headers = () => {\n    if (tableData().length === 0) return [];\n    return Object.keys(tableData()[0]);\n  };\n\n  const paginatedData = () => {\n    const start = (currentPage() - 1) * itemsPerPage;\n    const end = start + itemsPerPage;\n    return tableData().slice(start, end);\n  };\n\n  const totalPages = () => Math.ceil(tableData().length / itemsPerPage);\n\n  const goToPage = (page: number) => {\n    if (page > 0 && page <= totalPages()) {\n      setCurrentPage(page);\n    }\n  };\n\n  const canGoPrev = () => currentPage() > 1;\n  const canGoNext = () => currentPage() < totalPages();\n\n  return (\n    <div class=\"overflow-x-auto rounded-lg border shadow-sm my-4\">\n      <Show when={props.caption}>\n        <div class=\"p-4 text-lg font-semibold text-card-foreground\">{props.caption}</div>\n      </Show>\n      <table class=\"w-full text-sm text-left text-gray-500\">\n        <thead class=\"text-xs text-gray-700 uppercase bg-gray-50\">\n          <tr>\n            <For each={headers()}>\n              {(header) => (\n                <th scope=\"col\" class=\"px-6 py-3\">\n                  {header}\n                </th>\n              )}\n            </For>\n          </tr>\n        </thead>\n        <tbody>\n          <Show when={tableData().length > 0} fallback={\n            <tr>\n                <td colSpan={headers().length} class=\"px-6 py-4 text-center text-gray-400\">Nenhum dado dispon\u00edvel.</td>\n            </tr>\n          }>\n            <For each={paginatedData()}>\n              {(row) => (\n                <tr class=\"bg-white border-b hover:bg-gray-50\">\n                  <For each={headers()}>\n                    {(header) => (\n                      <td class=\"px-6 py-4\">\n                        {typeof row[header] === 'object' && row[header] !== null\n                          ? JSON.stringify(row[header])\n                          : String(row[header])}\n                      </td>\n                    )}\n                  </For>\n                </tr>\n              )}\n            </For>\n          </Show>\n        </tbody>\n      </table>\n\n      <Show when={totalPages() > 1}>\n        <nav class=\"flex items-center justify-between p-4 border-t bg-gray-50\" aria-label=\"Table navigation\">\n          <span class=\"text-sm font-normal text-gray-500\">\n            P\u00e1gina <span class=\"font-semibold text-gray-900\">{currentPage()}</span> de <span class=\"font-semibold text-gray-900\">{totalPages()}</span>\n          </span>\n          <ul class=\"inline-flex -space-x-px text-sm h-8\">\n            <li>\n              <button\n                onClick={() => goToPage(currentPage() - 1)}\n                disabled={!canGoPrev()}\n                class=\"flex items-center justify-center px-3 h-8 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                Anterior\n              </button>\n            </li>\n            <For each={Array(totalPages()).fill(0)}>\n              {(_, i) => (\n                <li>\n                  <button\n                    onClick={() => goToPage(i() + 1)}\n                    class={`flex items-center justify-center px-3 h-8 leading-tight ${\n                      currentPage() === i() + 1\n                        ?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3683, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7753a2e9-c2e3-4317-b054-63d9a6148743": {"__data__": {"id_": "7753a2e9-c2e3-4317-b054-63d9a6148743", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\DataTable.tsx", "language": "typescript", "lines": 126, "filename": "DataTable.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "70106f2e-7567-435e-acd4-f7e6b59fc3d7", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\DataTable.tsx", "language": "typescript", "lines": 126, "filename": "DataTable.tsx"}, "hash": "a4601452557316f1ff96f2b9e5db398d51f1a8547a6b39086954bfa36a6939d0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "6e49edac-1e90-4008-b2af-0ad97ccf877a", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\components\\DataTable.tsx", "language": "typescript", "lines": 126, "filename": "DataTable.tsx"}, "hash": "67c1738d68e9660864a2c98d14fdd3066517caf0082f5cea4223c3634608e879", "class_name": "RelatedNodeInfo"}}, "text": "'text-primary-foreground bg-primary border-primary hover:bg-primary-dark hover:text-primary-foreground'\n                        : 'text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700'\n                    }`}\n                  >\n                    {i() + 1}\n                  </button>\n                </li>\n              )}\n            </For>\n            <li>\n              <button\n                onClick={() => goToPage(currentPage() + 1)}\n                disabled={!canGoNext()}\n                class=\"flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                Pr\u00f3xima\n              </button>\n            </li>\n          </ul>\n        </nav>\n      </Show>\n    </div>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 3684, "end_char_idx": 4569, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1945848b-8d8f-4421-9b85-353e06c916d5": {"__data__": {"id_": "1945848b-8d8f-4421-9b85-353e06c916d5", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\DownloadButton.tsx", "language": "typescript", "lines": 47, "filename": "DownloadButton.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7780775f-421d-4242-b7fe-f5f4d8398457", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\DownloadButton.tsx", "language": "typescript", "lines": 47, "filename": "DownloadButton.tsx"}, "hash": "b416fd2b2cdf32ec402a7468d7c6e1daeb44962e7d5034f0c2f710aeb5703a3f", "class_name": "RelatedNodeInfo"}}, "text": "// frontend-solid/src/components/DownloadButton.tsx\n\nimport { Component } from 'solid-js';\n\ninterface DownloadButtonProps {\n  data: any[]; // Data to be downloaded\n  filename: string; // Suggested filename\n  label?: string; // Optional button label\n}\n\nexport const DownloadButton: Component<DownloadButtonProps> = (props) => {\n  const handleDownload = () => {\n    if (!props.data || props.data.length === 0) {\n      alert(\"Nenhum dado para baixar.\");\n      return;\n    }\n\n    try {\n      // Convert data to JSON string\n      const jsonString = JSON.stringify(props.data, null, 2);\n      const blob = new Blob([jsonString], { type: 'application/json' });\n      const url = URL.createObjectURL(blob);\n\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = props.filename || 'data.json';\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error(\"Erro ao baixar dados:\", error);\n      alert(\"Erro ao baixar dados. Tente novamente.\");\n    }\n  };\n\n  return (\n    <button \n      onClick={handleDownload}\n      class=\"btn btn-sm btn-outline\"\n      title=\"Baixar dados\"\n    >\n      {props.label || 'Baixar Dados (JSON)'}\n    </button>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1269, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7ee5b1e0-ac82-46bc-87d0-d8f0bbbc4543": {"__data__": {"id_": "7ee5b1e0-ac82-46bc-87d0-d8f0bbbc4543", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\ErrorBoundary.tsx", "language": "typescript", "lines": 38, "filename": "ErrorBoundary.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0875b3a1-3c84-4558-9165-c8e5e9179b74", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\ErrorBoundary.tsx", "language": "typescript", "lines": 38, "filename": "ErrorBoundary.tsx"}, "hash": "828b538485ab5e2bd964b0a87dde811a96d49908c268283b0065c692cc730c81", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, Show, ErrorBoundary as SolidErrorBoundary } from 'solid-js';\n\ninterface ErrorBoundaryProps {\n  children: any;\n}\n\nexport function ErrorBoundary(props: ErrorBoundaryProps) {\n  return (\n    <SolidErrorBoundary\n      fallback={(err, reset) => (\n        <div class=\"flex flex-col items-center justify-center h-[50vh] text-center p-8 space-y-4\">\n          <div class=\"text-red-500 text-5xl\">\u26a0\ufe0f</div>\n          <h2 class=\"text-2xl font-bold text-gray-800 dark:text-gray-100\">Ops! Algo deu errado.</h2>\n          <div class=\"p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg max-w-lg overflow-auto text-sm font-mono\">\n            {err.toString()}\n          </div>\n          <div class=\"flex gap-4\">\n             <button \n              onClick={() => reset()}\n              class=\"px-4 py-2 bg-primary text-primary-foreground rounded hover:opacity-90 transition-opacity\"\n            >\n              Tentar Novamente\n            </button>\n            <button \n              onClick={() => window.location.reload()}\n              class=\"px-4 py-2 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors\"\n            >\n              Recarregar P\u00e1gina\n            </button>\n          </div>\n        </div>\n      )}\n    >\n      {props.children}\n    </SolidErrorBoundary>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1366, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d83cfdcc-4403-4467-88d7-0584566d3105": {"__data__": {"id_": "d83cfdcc-4403-4467-88d7-0584566d3105", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\ExportMenu.tsx", "language": "typescript", "lines": 137, "filename": "ExportMenu.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7c3a0f7d-fb58-4c67-971f-4d0f0b70149b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\ExportMenu.tsx", "language": "typescript", "lines": 137, "filename": "ExportMenu.tsx"}, "hash": "9c30359663ad07c0f40d6165b096f980d03e2d12b126696e99c0949992627d98", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "5fe02189-b760-4478-a125-23b68cf1960e", "node_type": "1", "metadata": {}, "hash": "049453a4808bef8a153e56d67717844c631a2bece90bde08ddc2dcd3a81ff74e", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, Show } from 'solid-js';\nimport { Download, FileJson, FileText } from 'lucide-solid';\n\ninterface Message {\n  id: string;\n  role: string;\n  text: string;\n  timestamp: number;\n}\n\ninterface ExportMenuProps {\n  messages: () => Message[];\n  sessionId: string;\n}\n\nexport function ExportMenu(props: ExportMenuProps) {\n  const [showMenu, setShowMenu] = createSignal(false);\n\n  const downloadFile = (content: string, filename: string, type: string) => {\n    const blob = new Blob([content], { type });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = filename;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n  };\n\n  const exportAsJSON = () => {\n    const data = props.messages().map(m => ({\n      role: m.role,\n      content: m.text,\n      timestamp: new Date(m.timestamp).toISOString()\n    }));\n\n    const json = JSON.stringify({\n      session_id: props.sessionId,\n      exported_at: new Date().toISOString(),\n      messages: data\n    }, null, 2);\n\n    downloadFile(json, `chatbi-${props.sessionId}.json`, 'application/json');\n    setShowMenu(false);\n  };\n\n  const exportAsMarkdown = () => {\n    let markdown = `# Chat BI - Conversa\\n\\n`;\n    markdown += `**Session ID:** ${props.sessionId}\\n`;\n    markdown += `**Exportado em:** ${new Date().toLocaleString('pt-BR')}\\n\\n`;\n    markdown += `---\\n\\n`;\n\n    props.messages().forEach((msg, index) => {\n      if (msg.role === 'user') {\n        markdown += `## \ud83d\udc64 Usu\u00e1rio\\n\\n${msg.text}\\n\\n`;\n      } else if (msg.role === 'assistant') {\n        markdown += `## \ud83e\udd16 Assistente\\n\\n${msg.text}\\n\\n`;\n      }\n\n      markdown += `_${new Date(msg.timestamp).toLocaleString('pt-BR')}_\\n\\n`;\n\n      if (index < props.messages().length - 1) {\n        markdown += `---\\n\\n`;\n      }\n    });\n\n    downloadFile(markdown, `chatbi-${props.sessionId}.md`, 'text/markdown');\n    setShowMenu(false);\n  };\n\n  const exportAsText = () => {\n    let text = `Chat BI - Conversa\\n`;\n    text += `Session ID: ${props.sessionId}\\n`;\n    text += `Exportado em: ${new Date().toLocaleString('pt-BR')}\\n`;\n    text += `${'='.repeat(50)}\\n\\n`;\n\n    props.messages().forEach((msg) => {\n      const role = msg.role === 'user' ?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2289, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5fe02189-b760-4478-a125-23b68cf1960e": {"__data__": {"id_": "5fe02189-b760-4478-a125-23b68cf1960e", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\ExportMenu.tsx", "language": "typescript", "lines": 137, "filename": "ExportMenu.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7c3a0f7d-fb58-4c67-971f-4d0f0b70149b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\ExportMenu.tsx", "language": "typescript", "lines": 137, "filename": "ExportMenu.tsx"}, "hash": "9c30359663ad07c0f40d6165b096f980d03e2d12b126696e99c0949992627d98", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "d83cfdcc-4403-4467-88d7-0584566d3105", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\components\\ExportMenu.tsx", "language": "typescript", "lines": 137, "filename": "ExportMenu.tsx"}, "hash": "c8998c4a4d47695cd0c882316fe84b6afa43cf79ef166e2c8a35abcfa5f4e5e2", "class_name": "RelatedNodeInfo"}}, "text": "'Usu\u00e1rio' : 'Assistente';\n      const time = new Date(msg.timestamp).toLocaleString('pt-BR');\n      text += `[${role}] - ${time}\\n`;\n      text += `${msg.text}\\n\\n`;\n      text += `${'-'.repeat(50)}\\n\\n`;\n    });\n\n    downloadFile(text, `chatbi-${props.sessionId}.txt`, 'text/plain');\n    setShowMenu(false);\n  };\n\n  return (\n    <div class=\"relative\">\n      <button\n        onClick={() => setShowMenu(!showMenu())}\n        class=\"flex items-center gap-2 px-3 py-2 text-sm rounded-lg border hover:bg-muted transition-colors\"\n        title=\"Exportar conversa\"\n      >\n        <Download size={16} />\n        <span>Exportar</span>\n      </button>\n\n      <Show when={showMenu()}>\n        <div class=\"absolute right-0 top-full mt-2 bg-card border rounded-lg shadow-lg p-2 min-w-[200px] z-50\">\n          <button\n            onClick={exportAsJSON}\n            class=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded hover:bg-muted transition-colors text-left\"\n          >\n            <FileJson size={16} />\n            <span>JSON</span>\n          </button>\n          <button\n            onClick={exportAsMarkdown}\n            class=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded hover:bg-muted transition-colors text-left\"\n          >\n            <FileText size={16} />\n            <span>Markdown</span>\n          </button>\n          <button\n            onClick={exportAsText}\n            class=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded hover:bg-muted transition-colors text-left\"\n          >\n            <FileText size={16} />\n            <span>Texto</span>\n          </button>\n        </div>\n      </Show>\n\n      {/* Overlay to close menu */}\n      <Show when={showMenu()}>\n        <div\n          class=\"fixed inset-0 z-40\"\n          onClick={() => setShowMenu(false)}\n        />\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 2290, "end_char_idx": 4131, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "edcddc78-7606-4a8b-9f2f-286c675a84c7": {"__data__": {"id_": "edcddc78-7606-4a8b-9f2f-286c675a84c7", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\FeedbackButtons.tsx", "language": "typescript", "lines": 41, "filename": "FeedbackButtons.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a58bd078-5e80-4548-a6dc-3ffcf58de308", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\FeedbackButtons.tsx", "language": "typescript", "lines": 41, "filename": "FeedbackButtons.tsx"}, "hash": "c8226f8ca0070688533c1d1ff9415bc5e42e75a92a1e1c721fa70e7d85cf8b39", "class_name": "RelatedNodeInfo"}}, "text": "// frontend-solid/src/components/FeedbackButtons.tsx\n\nimport { Component } from 'solid-js';\n\ninterface FeedbackButtonsProps {\n  messageId: string;\n  onFeedback: (messageId: string, feedbackType: 'positive' | 'negative' | 'partial', comment?: string) => void;\n}\n\nexport const FeedbackButtons: Component<FeedbackButtonsProps> = (props) => {\n  const handleFeedbackClick = (feedbackType: 'positive' | 'negative' | 'partial') => {\n    props.onFeedback(props.messageId, feedbackType);\n  };\n\n  return (\n    <div class=\"flex items-center space-x-2\">\n      <button \n        onClick={() => handleFeedbackClick('positive')}\n        class=\"text-green-500 hover:text-green-700\"\n        title=\"Gostei da resposta\"\n      >\n        \ud83d\udc4d\n      </button>\n      <button \n        onClick={() => handleFeedbackClick('negative')}\n        class=\"text-red-500 hover:text-red-700\"\n        title=\"N\u00e3o gostei da resposta\"\n      >\n        \ud83d\udc4e\n      </button>\n      {/* <button \n        onClick={() => handleFeedbackClick('partial')}\n        class=\"text-blue-500 hover:text-blue-700\"\n        title=\"Respostas parcialmente \u00fatil\"\n      >\n        \ud83e\udd0f\n      </button> */}\n    </div>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1150, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "cdef3be0-c434-41f0-99b3-fee83a57116e": {"__data__": {"id_": "cdef3be0-c434-41f0-99b3-fee83a57116e", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\index.ts", "language": "typescript", "lines": 12, "filename": "index.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9f7d5136-1a68-4d2f-ac12-61ba612ae228", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\index.ts", "language": "typescript", "lines": 12, "filename": "index.ts"}, "hash": "d1c8e1e7bdb14d3fe21c31cc6ba24ad533b1d5aa6093c620c8c7d4b4860b41f9", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * Components Index\n * Central export for all reusable components\n */\n\nexport { Logo } from './Logo';\nexport { Typewriter, createTypewriter } from './Typewriter';\nexport { MessageActions } from './MessageActions';\nexport { ExportMenu } from './ExportMenu';\nexport { ShareButton } from './ShareButton';\nexport { TypingIndicator } from './TypingIndicator';", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 358, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0d79ad5d-a10b-48de-afbb-2411d8895f1c": {"__data__": {"id_": "0d79ad5d-a10b-48de-afbb-2411d8895f1c", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\Logo.tsx", "language": "typescript", "lines": 28, "filename": "Logo.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9ec685e0-f3bb-433a-97c5-2e7e1d8d5d9e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\Logo.tsx", "language": "typescript", "lines": 28, "filename": "Logo.tsx"}, "hash": "c310e31304503605a47020ea1f7b4e50682fd5b133fbf610a4e93589511fae4d", "class_name": "RelatedNodeInfo"}}, "text": "// frontend-solid/src/components/Logo.tsx\nimport { Component } from 'solid-js';\n\ninterface LogoProps {\n  size?: 'sm' | 'md' | 'lg' | 'xl';\n  className?: string;\n}\n\nconst sizeMap = {\n  sm: 'h-8',      // 32px - para sidebar compacta\n  md: 'h-10',     // 40px - padr\u00e3o sidebar\n  lg: 'h-12',     // 48px - login\n  xl: 'h-16',     // 64px - destaque\n};\n\nexport const Logo: Component<LogoProps> = (props) => {\n  const size = props.size || 'md';\n\n  return (\n    <img\n      src=\"/logo-cacula.svg\"\n      alt=\"Lojas Ca\u00e7ula - 40 anos de tradi\u00e7\u00e3o\"\n      class={`${sizeMap[size]} w-auto ${props.className || ''}`}\n      style={{ \"max-width\": \"none\" }}\n    />\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 654, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d543ef81-725a-47f8-8c3b-c431457d80df": {"__data__": {"id_": "d543ef81-725a-47f8-8c3b-c431457d80df", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\MessageActions.tsx", "language": "typescript", "lines": 53, "filename": "MessageActions.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "569b3716-77bc-4551-9d10-2b0b23894e00", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\MessageActions.tsx", "language": "typescript", "lines": 53, "filename": "MessageActions.tsx"}, "hash": "90a003b77c727663dbcd3bd5fb35f40f10db3a9ab15efce2ad1e36bff48cca14", "class_name": "RelatedNodeInfo"}}, "text": "import { Show } from 'solid-js';\nimport { Copy, RotateCw } from 'lucide-solid';\n\ninterface MessageActionsProps {\n  messageText: string;\n  messageId: string;\n  onRegenerate?: () => void;\n  canRegenerate?: boolean;\n}\n\nexport function MessageActions(props: MessageActionsProps) {\n  const copyToClipboard = () => {\n    navigator.clipboard.writeText(props.messageText).then(() => {\n      // Show brief success feedback\n      const btn = document.getElementById(`copy-${props.messageId}`);\n      if (btn) {\n        const originalText = btn.innerHTML;\n        btn.innerHTML = '\u2713 Copiado!';\n        setTimeout(() => {\n          btn.innerHTML = originalText;\n        }, 2000);\n      }\n    }).catch(err => {\n      console.error('Failed to copy:', err);\n    });\n  };\n\n  return (\n    <div class=\"flex items-center gap-2 mt-2 text-xs\">\n      <button\n        id={`copy-${props.messageId}`}\n        onClick={copyToClipboard}\n        class=\"flex items-center gap-1 px-2 py-1 rounded hover:bg-muted transition-colors\"\n        title=\"Copiar mensagem\"\n      >\n        <Copy size={14} />\n        <span>Copiar</span>\n      </button>\n\n      <Show when={props.canRegenerate && props.onRegenerate}>\n        <button\n          onClick={props.onRegenerate}\n          class=\"flex items-center gap-1 px-2 py-1 rounded hover:bg-muted transition-colors\"\n          title=\"Regenerar resposta\"\n        >\n          <RotateCw size={14} />\n          <span>Regenerar</span>\n        </button>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1485, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8455fed0-9a0f-42f1-a3c3-77b75f7b21d8": {"__data__": {"id_": "8455fed0-9a0f-42f1-a3c3-77b75f7b21d8", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\PlotlyChart.tsx", "language": "typescript", "lines": 170, "filename": "PlotlyChart.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "3c0d95a2-5c99-4fda-b060-990250966bd2", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\PlotlyChart.tsx", "language": "typescript", "lines": 170, "filename": "PlotlyChart.tsx"}, "hash": "55e6f220d6f21bd14305b841a3964723ecc967dfb5a5feff92999875a26cc274", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "0f7827e1-0d43-4557-a986-3f2864af70c6", "node_type": "1", "metadata": {}, "hash": "09ec9c2f55fc77d970f43588800877cc6d2e4288bcbe342ce2d4b3c1ff3ed719", "class_name": "RelatedNodeInfo"}}, "text": "// frontend-solid/src/components/PlotlyChart.tsx\n\nimport { createEffect, onCleanup, Accessor, createSignal, Show } from 'solid-js';\nimport Plotly from 'plotly.js-dist-min';\nimport { Maximize, Minimize } from 'lucide-solid';\n\n// ===== PALETA LOJAS CA\u00c7ULA - 40 ANOS DE TRADI\u00c7\u00c3O =====\n// Cores terrosas/neutras para consist\u00eancia visual\nconst CACULA_CHART_COLORS = [\n  '#8B7355',  // Marrom Ca\u00e7ula (principal)\n  '#C9A961',  // Dourado/Bronze (tradi\u00e7\u00e3o)\n  '#6B7A5A',  // Verde oliva\n  '#A68968',  // Marrom claro\n  '#CC8B3C',  // Laranja terroso\n  '#5B7B9A',  // Azul acinzentado\n  '#9B8875',  // Bege m\u00e9dio\n  '#B8984E',  // Dourado escuro\n  '#7A8B6F',  // Verde acinzentado\n  '#B59B7A',  // Bege quente\n];\n\ninterface PlotlyChartProps {\n  chartSpec: Accessor<any>;\n  chartId?: string;\n  onDataClick?: (data: any) => void;\n  onHover?: (data: any) => void;\n  height?: string;\n  enableDownload?: boolean;\n}\n\nexport const PlotlyChart = (props: PlotlyChartProps) => {\n  let chartDiv: HTMLDivElement | undefined;\n  const chartId = props.chartId || `chart-${Math.random().toString(36).substr(2, 9)}`;\n  const [isExpanded, setIsExpanded] = createSignal(false);\n\n  const toggleExpand = () => {\n    setIsExpanded(!isExpanded());\n    // Force resize after state change and DOM update\n    setTimeout(() => {\n      if (chartDiv) {\n        Plotly.Plots.resize(chartDiv);\n      }\n    }, 50);\n  };\n\n  createEffect(() => {\n    const spec = props.chartSpec();\n    if (chartDiv && spec && Object.keys(spec).length > 0) {\n      console.log('Rendering Plotly Chart with spec:', spec);\n      try {\n        // ===== APLICAR TEMA CA\u00c7ULA - LIGHT MODE =====\n        // Merge layout com tema Lojas Ca\u00e7ula\n        const caculaLayout = {\n          paper_bgcolor: '#FAFAFA',  // Light background\n          plot_bgcolor: '#FFFFFF',   // White plot area\n          font: {\n            color: '#2D2D2D',        // Cinza escuro quente\n            family: 'Inter, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif',\n            size: 12\n          },\n          colorway: CACULA_CHART_COLORS, // Paleta terrosa Ca\u00e7ula\n\n          // Eixos com cores suaves\n          xaxis: {\n            gridcolor: '#E5E5E5',\n            linecolor: '#E5E5E5',\n            zerolinecolor: '#E5E5E5',\n            tickfont: { color: '#2D2D2D' },\n            ...(spec.layout?.xaxis || {})\n          },\n          yaxis: {\n            gridcolor: '#E5E5E5',\n            linecolor: '#E5E5E5',\n            zerolinecolor: '#E5E5E5',\n            tickfont: { color: '#2D2D2D' },\n            ...(spec.layout?.yaxis || {})\n          },\n\n          // Hover info estilizado\n          hoverlabel: {\n            bgcolor: '#FFFFFF',\n            bordercolor: '#8B7355', // Marrom Ca\u00e7ula\n            font: { color: '#2D2D2D', family: 'Inter, sans-serif' }\n          },\n\n          // Legend (legenda)\n          legend: {\n            font: { color: '#2D2D2D' },\n            bgcolor: 'rgba(255,255,255,0.9)',\n            bordercolor: '#E5E5E5',\n            borderwidth: 1,\n            ...(spec.layout?.legend || {})\n          },\n\n          // Merge com layout original (permite override)\n          ...spec.layout\n        };\n\n        // Merge config com op\u00e7\u00f5es de download se habilitado\n        const config = {\n          responsive: true,\n          displayModeBar: props.enableDownload ??", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3318, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0f7827e1-0d43-4557-a986-3f2864af70c6": {"__data__": {"id_": "0f7827e1-0d43-4557-a986-3f2864af70c6", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\PlotlyChart.tsx", "language": "typescript", "lines": 170, "filename": "PlotlyChart.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "3c0d95a2-5c99-4fda-b060-990250966bd2", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\PlotlyChart.tsx", "language": "typescript", "lines": 170, "filename": "PlotlyChart.tsx"}, "hash": "55e6f220d6f21bd14305b841a3964723ecc967dfb5a5feff92999875a26cc274", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8455fed0-9a0f-42f1-a3c3-77b75f7b21d8", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\components\\PlotlyChart.tsx", "language": "typescript", "lines": 170, "filename": "PlotlyChart.tsx"}, "hash": "75a311de30a09230fac4378e6b2f3eda3accda7392031ee655f716fb0297fd69", "class_name": "RelatedNodeInfo"}}, "text": "? false,\n          displaylogo: false,\n          showLink: false,\n          modeBarButtonsToRemove: ['sendDataToCloud', 'editInChartStudio', 'lasso2d', 'select2d'],\n          modeBarButtonsToAdd: props.enableDownload ? ['downloadImage'] : [],\n          toImageButtonOptions: props.enableDownload ? {\n            format: 'png',\n            filename: `grafico_cacula_${new Date().toISOString().split('T')[0]}`,\n            height: 800,\n            width: 1200,\n            scale: 2\n          } : undefined,\n          ...spec.config\n        };\n\n        Plotly.newPlot(chartDiv, spec.data, caculaLayout, config);\n\n        // Adicionar eventos de intera\u00e7\u00e3o\n        if (props.onDataClick) {\n          chartDiv.on('plotly_click', (data) => {\n            props.onDataClick!(data);\n          });\n        }\n\n        if (props.onHover) {\n          chartDiv.on('plotly_hover', (data) => {\n            props.onHover!(data);\n          });\n        }\n      } catch (error: any) {\n        console.error(\"Error rendering Plotly chart:\", error);\n        chartDiv.innerHTML = `<div class=\"text-red-500\">Erro ao renderizar gr\u00e1fico: ${error.message}</div>`;\n      }\n    } else if (chartDiv && (!spec || Object.keys(spec).length === 0)) {\n      chartDiv.innerHTML = `<div class=\"text-gray-500\">Nenhuma especifica\u00e7\u00e3o de gr\u00e1fico fornecida.</div>`;\n    }\n  });\n\n  onCleanup(() => {\n    if (chartDiv) {\n      Plotly.purge(chartDiv);\n    }\n  });\n\n  return (\n    <div class={`relative transition-all duration-300 ${isExpanded() ? 'fixed inset-0 z-50 bg-background p-6 flex flex-col' : ''}`}>\n      <div class=\"absolute top-2 right-2 z-10 flex gap-2\">\n        <button\n          onClick={toggleExpand}\n          class=\"p-2 bg-background/80 hover:bg-muted rounded-full shadow-sm border backdrop-blur-sm transition-colors\"\n          title={isExpanded() ? \"Restaurar tamanho\" : \"Expandir tela cheia\"}\n        >\n          <Show when={isExpanded()} fallback={<Maximize size={16} />}>\n            <Minimize size={16} />\n          </Show>\n        </button>\n      </div>\n      <div\n        ref={chartDiv}\n        id={chartId}\n        class=\"w-full\"\n        style={{ height: isExpanded() ? '100%' : (props.height || '400px') }}\n      >\n        {/* Chart will be rendered here by Plotly.js */}\n      </div>\n    </div>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 3317, "end_char_idx": 5601, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8a30f374-beae-42ee-829f-8668d8e9da4b": {"__data__": {"id_": "8a30f374-beae-42ee-829f-8668d8e9da4b", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\ShareButton.tsx", "language": "typescript", "lines": 199, "filename": "ShareButton.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "c77100a9-e1c8-4c85-8649-952b428ea00b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\ShareButton.tsx", "language": "typescript", "lines": 199, "filename": "ShareButton.tsx"}, "hash": "a9604540f61483deb83aa479658aaff08acb8661c195d4e99d36a476e0bad2a7", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2fcae706-ebc3-47e8-9974-e2be0aa3a8b3", "node_type": "1", "metadata": {}, "hash": "4ec0f4ba00fdfab590b2dce6cddb571734edea69c7a9cd4b225801da58c9a76b", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, Show } from 'solid-js';\nimport { Share2, Copy, Check, X } from 'lucide-solid';\nimport auth from '@/store/auth';\n\ninterface Message {\n  id: string;\n  role: string;\n  text: string;\n  timestamp: number;\n}\n\ninterface ShareButtonProps {\n  messages: () => Message[];\n  sessionId: string;\n}\n\nexport function ShareButton(props: ShareButtonProps) {\n  const [showModal, setShowModal] = createSignal(false);\n  const [shareUrl, setShareUrl] = createSignal('');\n  const [copied, setCopied] = createSignal(false);\n  const [isSharing, setIsSharing] = createSignal(false);\n  const [error, setError] = createSignal('');\n  const [title, setTitle] = createSignal('');\n\n  const shareConversation = async () => {\n    const token = auth.token();\n    if (!token) {\n      setError('Voc\u00ea precisa estar autenticado para compartilhar.');\n      return;\n    }\n\n    setIsSharing(true);\n    setError('');\n\n    try {\n      const response = await fetch('/api/v1/shared/share', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`\n        },\n        body: JSON.stringify({\n          session_id: props.sessionId,\n          messages: props.messages().map(m => ({\n            role: m.role,\n            text: m.text,\n            timestamp: m.timestamp\n          })),\n          title: title() || 'Conversa Chat BI',\n          expires_in_days: 30\n        })\n      });\n\n      if (!response.ok) {\n        throw new Error('Falha ao compartilhar conversa');\n      }\n\n      const data = await response.json();\n      const fullUrl = `${window.location.origin}${data.share_url}`;\n      setShareUrl(fullUrl);\n    } catch (err) {\n      console.error('Error sharing conversation:', err);\n      setError('Erro ao compartilhar conversa. Tente novamente.');\n    } finally {\n      setIsSharing(false);\n    }\n  };\n\n  const copyToClipboard = async () => {\n    try {\n      await navigator.clipboard.writeText(shareUrl());\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    } catch (err) {\n      console.error('Failed to copy:', err);\n    }\n  };\n\n  const openModal = () => {\n    setShowModal(true);\n    setShareUrl('');\n    setError('');\n    setTitle('');\n  };\n\n  const closeModal = () => {\n    setShowModal(false);\n    setShareUrl('');\n    setError('');\n  };\n\n  return (\n    <>\n      <button\n        onClick={openModal}\n        class=\"flex items-center gap-2 px-3 py-2 text-sm rounded-lg border hover:bg-muted transition-colors\"\n        title=\"Compartilhar conversa\"\n      >\n        <Share2 size={16} />\n        <span>Compartilhar</span>\n      </button>\n\n      <Show when={showModal()}>\n        <div class=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50\">\n          <div class=\"bg-card border rounded-lg shadow-lg p-6 max-w-md w-full mx-4\">\n            <div class=\"flex items-center justify-between mb-4\">\n              <h3 class=\"text-lg font-semibold\">Compartilhar Conversa</h3>\n              <button\n                onClick={closeModal}\n                class=\"hover:bg-muted rounded p-1 transition-colors\"\n              >\n                <X size={20} />\n              </button>\n            </div>\n\n            <Show when={!shareUrl()}>\n              <div class=\"space-y-4\">\n                <div>\n                  <label class=\"block text-sm font-medium mb-2\">\n                    T\u00edtulo (opcional)\n                  </label>\n                  <input\n                    type=\"text\"\n                    class=\"input w-full\"\n                    value={title()}\n                    onInput={(e) => setTitle(e.currentTarget.value)}\n                    placeholder=\"D\u00ea um t\u00edtulo para esta conversa\"\n                  />\n                </div>\n\n                <p class=\"text-sm text-muted-foreground\">\n                  Ao compartilhar, voc\u00ea criar\u00e1 um link p\u00fablico que qualquer pessoa pode acessar.\n                  O link expirar\u00e1 em 30 dias.\n                </p>\n\n                <Show when={error()}>\n                  <div class=\"p-3 rounded bg-red-500/10 text-red-500 text-sm\">\n                    {error()}\n                  </div>\n                </Show>\n\n                <button\n                  onClick={shareConversation}\n                  disabled={isSharing()}\n                  class=\"btn btn-primary w-full\"\n                >\n                  {isSharing() ?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4363, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2fcae706-ebc3-47e8-9974-e2be0aa3a8b3": {"__data__": {"id_": "2fcae706-ebc3-47e8-9974-e2be0aa3a8b3", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\ShareButton.tsx", "language": "typescript", "lines": 199, "filename": "ShareButton.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "c77100a9-e1c8-4c85-8649-952b428ea00b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\ShareButton.tsx", "language": "typescript", "lines": 199, "filename": "ShareButton.tsx"}, "hash": "a9604540f61483deb83aa479658aaff08acb8661c195d4e99d36a476e0bad2a7", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8a30f374-beae-42ee-829f-8668d8e9da4b", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\components\\ShareButton.tsx", "language": "typescript", "lines": 199, "filename": "ShareButton.tsx"}, "hash": "ea6303893a016b6e8d0820a25957b9dedef172b8b000151fee1dbf60fffdd8c5", "class_name": "RelatedNodeInfo"}}, "text": "O link expirar\u00e1 em 30 dias.\n                </p>\n\n                <Show when={error()}>\n                  <div class=\"p-3 rounded bg-red-500/10 text-red-500 text-sm\">\n                    {error()}\n                  </div>\n                </Show>\n\n                <button\n                  onClick={shareConversation}\n                  disabled={isSharing()}\n                  class=\"btn btn-primary w-full\"\n                >\n                  {isSharing() ? 'Compartilhando...' : 'Criar Link de Compartilhamento'}\n                </button>\n              </div>\n            </Show>\n\n            <Show when={shareUrl()}>\n              <div class=\"space-y-4\">\n                <div class=\"p-3 rounded bg-green-500/10 text-green-500 text-sm\">\n                  \u2713 Conversa compartilhada com sucesso!\n                </div>\n\n                <div>\n                  <label class=\"block text-sm font-medium mb-2\">\n                    Link de compartilhamento\n                  </label>\n                  <div class=\"flex gap-2\">\n                    <input\n                      type=\"text\"\n                      class=\"input flex-1\"\n                      value={shareUrl()}\n                      readonly\n                    />\n                    <button\n                      onClick={copyToClipboard}\n                      class=\"btn btn-primary\"\n                      title=\"Copiar link\"\n                    >\n                      <Show when={!copied()} fallback={<Check size={16} />}>\n                        <Copy size={16} />\n                      </Show>\n                    </button>\n                  </div>\n                </div>\n\n                <p class=\"text-sm text-muted-foreground\">\n                  Este link \u00e9 p\u00fablico e funcionar\u00e1 por 30 dias. Qualquer pessoa com o link poder\u00e1 visualizar esta conversa.\n                </p>\n\n                <button\n                  onClick={closeModal}\n                  class=\"btn w-full\"\n                >\n                  Fechar\n                </button>\n              </div>\n            </Show>\n          </div>\n        </div>\n      </Show>\n    </>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 3906, "end_char_idx": 6014, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c3bd8588-fa8f-4377-a4fe-4d5861d0758e": {"__data__": {"id_": "c3bd8588-fa8f-4377-a4fe-4d5861d0758e", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\Typewriter.tsx", "language": "typescript", "lines": 124, "filename": "Typewriter.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "3f20c2af-f0dd-4a74-bb3c-b33d76eb2cf1", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\Typewriter.tsx", "language": "typescript", "lines": 124, "filename": "Typewriter.tsx"}, "hash": "c3c9c4f37986650a487c51f6e96337b26d8fa92fb92c64d1c0742d5db52d02de", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, createEffect, onCleanup } from 'solid-js';\n\ninterface TypewriterProps {\n  text: string;\n  speed?: number; // ms por caractere (padr\u00e3o: 20ms)\n  onComplete?: () => void; // Callback quando terminar de digitar\n}\n\n/**\n * Componente Typewriter - Efeito de digita\u00e7\u00e3o ChatGPT-like\n *\n * Renderiza texto com efeito de digita\u00e7\u00e3o suave, caractere por caractere.\n * Perfeito para respostas de chat/IA que chegam via streaming.\n *\n * @example\n * ```tsx\n * <Typewriter\n *   text={message.text}\n *   speed={15}\n *   onComplete={() => console.log('Digita\u00e7\u00e3o conclu\u00edda!')}\n * />\n * ```\n */\nexport function Typewriter(props: TypewriterProps) {\n  const [displayedText, setDisplayedText] = createSignal('');\n  const [currentIndex, setCurrentIndex] = createSignal(0);\n  const [isTyping, setIsTyping] = createSignal(false);\n\n  createEffect(() => {\n    const targetText = props.text;\n    const speed = props.speed || 20;\n\n    // Se o texto alvo mudou (nova atualiza\u00e7\u00e3o do streaming)\n    if (targetText !== displayedText()) {\n      // Se o novo texto \u00e9 uma extens\u00e3o do atual, continuar digitando\n      if (targetText.startsWith(displayedText())) {\n        setIsTyping(true);\n\n        const interval = setInterval(() => {\n          setCurrentIndex((prev) => {\n            const nextIndex = prev + 1;\n\n            if (nextIndex <= targetText.length) {\n              setDisplayedText(targetText.slice(0, nextIndex));\n              return nextIndex;\n            } else {\n              // Terminou de digitar\n              clearInterval(interval);\n              setIsTyping(false);\n              if (props.onComplete) {\n                props.onComplete();\n              }\n              return prev;\n            }\n          });\n        }, speed);\n\n        onCleanup(() => clearInterval(interval));\n      } else {\n        // Se o texto \u00e9 completamente diferente, resetar\n        setDisplayedText(targetText);\n        setCurrentIndex(targetText.length);\n        setIsTyping(false);\n      }\n    }\n  });\n\n  return (\n    <span class=\"whitespace-pre-wrap\">\n      {displayedText()}\n      {/* Cursor piscante quando est\u00e1 digitando */}\n      {isTyping() && (\n        <span class=\"inline-block w-0.5 h-4 bg-primary ml-0.5 animate-pulse\" />\n      )}\n    </span>\n  );\n}\n\n/**\n * Hook alternativo para controle manual do efeito typewriter\n * \u00datil quando voc\u00ea precisa de mais controle sobre o comportamento\n */\nexport function createTypewriter(initialText = '', speed = 20) {\n  const [displayedText, setDisplayedText] = createSignal('');\n  const [targetText, setTargetText] = createSignal(initialText);\n  const [isTyping, setIsTyping] = createSignal(false);\n\n  createEffect(() => {\n    const target = targetText();\n    const current = displayedText();\n\n    if (target === current) {\n      setIsTyping(false);\n      return;\n    }\n\n    setIsTyping(true);\n\n    const interval = setInterval(() => {\n      setDisplayedText((prev) => {\n        if (prev.length < target.length) {\n          return target.slice(0, prev.length + 1);\n        } else {\n          clearInterval(interval);\n          setIsTyping(false);\n          return prev;\n        }\n      });\n    }, speed);\n\n    onCleanup(() => clearInterval(interval));\n  });\n\n  return {\n    displayedText,\n    isTyping,\n    setTargetText,\n    reset: () => {\n      setDisplayedText('');\n      setTargetText('');\n    },\n  };\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3345, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "666e1f44-60fd-4df2-a0a7-d3b93cb29e96": {"__data__": {"id_": "666e1f44-60fd-4df2-a0a7-d3b93cb29e96", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\TypingIndicator.tsx", "language": "typescript", "lines": 13, "filename": "TypingIndicator.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "326af040-385f-4592-be57-172ee53c0865", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\TypingIndicator.tsx", "language": "typescript", "lines": 13, "filename": "TypingIndicator.tsx"}, "hash": "5940c009620e860e8d4841556cba7ec5cdeb120c0f7698781dd2fafff5623c06", "class_name": "RelatedNodeInfo"}}, "text": "import { Component } from 'solid-js';\nimport './TypingIndicator.css';\n\nexport const TypingIndicator: Component = () => {\n  return (\n    <div class=\"typing-indicator\">\n      <span class=\"dot\"></span>\n      <span class=\"dot\"></span>\n      <span class=\"dot\"></span>\n    </div>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 281, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "033afa20-be0f-45e9-8811-b4df2ab32f8d": {"__data__": {"id_": "033afa20-be0f-45e9-8811-b4df2ab32f8d", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\UserPreferences.tsx", "language": "typescript", "lines": 137, "filename": "UserPreferences.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "5ecddff0-031e-48cb-8316-73806ef9f524", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\UserPreferences.tsx", "language": "typescript", "lines": 137, "filename": "UserPreferences.tsx"}, "hash": "9bcfa3c5b7084e8d99351b1223d1f03033579b68df9cc48474d03a721c034731", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, createResource, For, Show } from 'solid-js';\nimport auth from '@/store/auth';\n\ninterface PreferenceKey {\n  key: string;\n  description: string;\n  options?: string[];\n  type?: string;\n  default?: string;\n}\n\nexport function UserPreferences() {\n  const [saving, setSaving] = createSignal(false);\n  const [message, setMessage] = createSignal('');\n  const [preferences, setPreferences] = createSignal<Record<string, string>>({});\n\n  // Fetch common keys\n  const [commonKeys] = createResource(async () => {\n    const response = await fetch('/api/v1/preferences/common/keys');\n    const data = await response.json();\n    return data.keys as PreferenceKey[];\n  });\n\n  // Fetch user preferences\n  const [userPrefs, { refetch }] = createResource(async () => {\n    const token = auth.token();\n    if (!token) return { preferences: {} };\n\n    const response = await fetch('/api/v1/preferences', {\n      headers: { 'Authorization': `Bearer ${token}` }\n    });\n    const data = await response.json();\n    setPreferences(data.preferences || {});\n    return data;\n  });\n\n  const savePreferences = async () => {\n    const token = auth.token();\n    if (!token) return;\n\n    setSaving(true);\n    setMessage('');\n\n    try {\n      const response = await fetch('/api/v1/preferences/batch', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`\n        },\n        body: JSON.stringify(preferences())\n      });\n\n      if (!response.ok) {\n        throw new Error('Falha ao salvar prefer\u00eancias');\n      }\n\n      setMessage('\u2713 Prefer\u00eancias salvas com sucesso!');\n      setTimeout(() => setMessage(''), 3000);\n      refetch();\n    } catch (err) {\n      console.error('Error saving preferences:', err);\n      setMessage('\u2717 Erro ao salvar prefer\u00eancias');\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const updatePreference = (key: string, value: string) => {\n    setPreferences(prev => ({ ...prev, [key]: value }));\n  };\n\n  return (\n    <div class=\"space-y-6\">\n      <div>\n        <h3 class=\"text-lg font-semibold mb-2\">Prefer\u00eancias do Usu\u00e1rio</h3>\n        <p class=\"text-sm text-muted-foreground\">\n          Configure suas prefer\u00eancias para personalizar sua experi\u00eancia no Chat BI.\n        </p>\n      </div>\n\n      <Show when={!commonKeys.loading} fallback={<div>Carregando...</div>}>\n        <div class=\"space-y-4\">\n          <For each={commonKeys()}>\n            {(prefKey) => (\n              <div class=\"space-y-2\">\n                <label class=\"block text-sm font-medium\">\n                  {prefKey.description}\n                </label>\n                <Show\n                  when={prefKey.options}\n                  fallback={\n                    <input\n                      type=\"text\"\n                      class=\"input w-full\"\n                      value={preferences()[prefKey.key] || ''}\n                      onInput={(e) => updatePreference(prefKey.key, e.currentTarget.value)}\n                      placeholder={`Digite ${prefKey.description.toLowerCase()}`}\n                    />\n                  }\n                >\n                  <select\n                    class=\"input w-full\"\n                    value={preferences()[prefKey.key] || prefKey.default || ''}\n                    onChange={(e) => updatePreference(prefKey.key, e.currentTarget.value)}\n                  >\n                    <option value=\"\">Selecione...</option>\n                    <For each={prefKey.options}>\n                      {(option) => <option value={option}>{option}</option>}\n                    </For>\n                  </select>\n                </Show>\n              </div>\n            )}\n          </For>\n        </div>\n\n        <div class=\"flex items-center gap-4 pt-4\">\n          <button\n            onClick={savePreferences}\n            disabled={saving()}\n            class=\"btn btn-primary\"\n          >\n            {saving() ? 'Salvando...' : 'Salvar Prefer\u00eancias'}\n          </button>\n\n          <Show when={message()}>\n            <span class={`text-sm ${message().startsWith('\u2713') ? 'text-green-500' : 'text-red-500'}`}>\n              {message()}\n            </span>\n          </Show>\n        </div>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4227, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "34e544be-3bc2-4af7-b4d7-4415f937441f": {"__data__": {"id_": "34e544be-3bc2-4af7-b4d7-4415f937441f", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\__tests__\\Chat.test.tsx", "language": "typescript", "lines": 223, "filename": "Chat.test.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "69ada291-f55c-49a7-a2a2-98550c6cba35", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\__tests__\\Chat.test.tsx", "language": "typescript", "lines": 223, "filename": "Chat.test.tsx"}, "hash": "3425c9ffd0e80406df281439320e9aa02205c4a083f073c8c2eb1815f415118e", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "a06d5482-b557-4870-8739-98e76111edc5", "node_type": "1", "metadata": {}, "hash": "b2d6ae71afe8b2469df2a9ef022edbf72ab3a905fa4458061a5c16b435c223ea", "class_name": "RelatedNodeInfo"}}, "text": "// frontend-solid/src/components/__tests__/Chat.test.tsx\n\nimport { render, screen, fireEvent, cleanup } from 'solid-testing-library';\nimport { Show } from 'solid-js';\nimport { vi, beforeEach, afterEach, expect, test } from 'vitest';\n\nimport Chat from '../../pages/Chat';\nimport auth from '@/store/auth';\n\n// Mock the Typewriter component as it's just visual\nvi.mock('@/components', () => ({\n  Typewriter: (props: any) => <span data-testid=\"typewriter\">{props.text}</span>,\n}));\n\n// Mock PlotlyChart and DataTable\nvi.mock('@/components/PlotlyChart', () => ({\n  PlotlyChart: (props: any) => <div data-testid=\"plotly-chart\">{JSON.stringify(props.chartSpec())}</div>,\n}));\n\nvi.mock('@/components/DataTable', () => ({\n  DataTable: (props: any) => <div data-testid=\"data-table\">{JSON.stringify(props.data())}</div>,\n}));\n\n// Mock FeedbackButtons and DownloadButton (for rendering only, not functionality)\nvi.mock('@/components/FeedbackButtons', () => ({\n    FeedbackButtons: (props: any) => <button data-testid=\"feedback-button\" onClick={() => props.onFeedback(props.messageId, 'positive')}>Feedback</button>,\n}));\n\nvi.mock('@/components/DownloadButton', () => ({\n    DownloadButton: (props: any) => <button data-testid=\"download-button\">Download {props.filename}</button>,\n}));\n\n// Mock formatTimestamp\nvi.mock('@/lib/formatters', () => ({\n  formatTimestamp: vi.fn(() => '12:00 PM'),\n}));\n\n\n// Mock EventSource for SSE\nclass MockEventSource {\n  onmessage: (event: MessageEvent) => void = () => {};\n  onerror: (event: Event) => void = () => {};\n  close = vi.fn();\n  url: string;\n\n  constructor(url: string) {\n    this.url = url;\n    MockEventSource.instances.push(this);\n  }\n\n  // Static array to hold all instances for easy access in tests\n  static instances: MockEventSource[] = [];\n  static reset() {\n    MockEventSource.instances = [];\n  }\n}\n\nvi.stubGlobal('EventSource', MockEventSource);\n\nbeforeEach(() => {\n  cleanup(); // Clean up DOM after each test\n  MockEventSource.reset(); // Reset mock instances\n  auth.setToken('mock_valid_token'); // Ensure auth token is set\n  auth.setUser({ id: '1', username: 'testuser' });\n  vi.clearAllMocks(); // Clear mocks\n});\n\nafterEach(() => {\n    cleanup();\n});\n\ntest('Chat component renders initial message', () => {\n  render(() => <Chat />);\n  expect(screen.getByText(/Ol\u00e1! Sou seu assistente de BI./i)).toBeInTheDocument();\n});\n\ntest('sends user message and starts streaming', async () => {\n  render(() => <Chat />);\n  const inputElement = screen.getByPlaceholderText(/Fa\u00e7a uma pergunta sobre os dados.../i) as HTMLInputElement;\n  const sendButton = screen.getByRole('button', { name: /Enviar/i });\n\n  fireEvent.input(inputElement, { target: { value: 'Test message' } });\n  fireEvent.click(sendButton);\n\n  expect(screen.getByText('Test message')).toBeInTheDocument();\n  expect(inputElement.value).toBe('');\n  expect(sendButton).toBeDisabled(); // Should be disabled while streaming\n  \n  expect(MockEventSource.instances.length).toBe(1);\n  expect(MockEventSource.instances[0].url).toContain('q=Test%20message');\n});\n\ntest('receives streaming text response', async () => {\n    render(() => <Chat />);\n    const inputElement = screen.getByPlaceholderText(/Fa\u00e7a uma pergunta sobre os dados.../i) as HTMLInputElement;\n    const sendButton = screen.getByRole('button', { name: /Enviar/i });\n\n    fireEvent.input(inputElement, { target: { value: 'Stream test' } });\n    fireEvent.click(sendButton);\n\n    const es = MockEventSource.instances[0];\n\n    // Simulate streaming chunks\n    es.onmessage({ data: JSON.stringify({ type: 'text', text: 'First part ', done: false }) } as MessageEvent);\n    es.onmessage({ data: JSON.stringify({ type: 'text', text: 'second part.', done: false }) } as MessageEvent);\n\n    // Final chunk\n    es.onmessage({ data: JSON.stringify({ type: 'final', text: '', done: true }) } as MessageEvent);\n\n    await vi.waitFor(() => {\n        expect(screen.getByTestId('typewriter')).toHaveTextContent('First part second part.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3979, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a06d5482-b557-4870-8739-98e76111edc5": {"__data__": {"id_": "a06d5482-b557-4870-8739-98e76111edc5", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\__tests__\\Chat.test.tsx", "language": "typescript", "lines": 223, "filename": "Chat.test.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "69ada291-f55c-49a7-a2a2-98550c6cba35", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\__tests__\\Chat.test.tsx", "language": "typescript", "lines": 223, "filename": "Chat.test.tsx"}, "hash": "3425c9ffd0e80406df281439320e9aa02205c4a083f073c8c2eb1815f415118e", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "34e544be-3bc2-4af7-b4d7-4415f937441f", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\components\\__tests__\\Chat.test.tsx", "language": "typescript", "lines": 223, "filename": "Chat.test.tsx"}, "hash": "bf3e66d112afc55891f40417635b705e54fcb33e24f2479acd99289e4a2c0bc9", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3f7bb3e9-99e4-4881-baf0-e42298893cb0", "node_type": "1", "metadata": {}, "hash": "3810086617006571092c935df449f31a80bc28600cc81b37b32186b19c7d00ab", "class_name": "RelatedNodeInfo"}}, "text": "', done: false }) } as MessageEvent);\n\n    // Final chunk\n    es.onmessage({ data: JSON.stringify({ type: 'final', text: '', done: true }) } as MessageEvent);\n\n    await vi.waitFor(() => {\n        expect(screen.getByTestId('typewriter')).toHaveTextContent('First part second part.');\n        expect(sendButton).toBeEnabled(); // Should be enabled after streaming ends\n    });\n    expect(es.close).toHaveBeenCalledTimes(1);\n});\n\ntest('renders chart response', async () => {\n    render(() => <Chat />);\n    const inputElement = screen.getByPlaceholderText(/Fa\u00e7a uma pergunta sobre os dados.../i) as HTMLInputElement;\n    const sendButton = screen.getByRole('button', { name: /Enviar/i });\n\n    fireEvent.input(inputElement, { target: { value: 'Show me a chart' } });\n    fireEvent.click(sendButton);\n\n    const es = MockEventSource.instances[0];\n    const mockChartSpec = { data: [{ type: 'bar', y: [1, 2, 3] }], layout: { title: 'Test Chart' } };\n\n    es.onmessage({ data: JSON.stringify({ type: 'text', text: 'Here is your chart: ', done: false }) } as MessageEvent);\n    es.onmessage({ data: JSON.stringify({ type: 'chart', chart_spec: mockChartSpec, done: false }) } as MessageEvent);\n    es.onmessage({ data: JSON.stringify({ type: 'final', text: '', done: true }) } as MessageEvent);\n\n    await vi.waitFor(() => {\n        expect(screen.getByTestId('plotly-chart')).toBeInTheDocument();\n        expect(screen.getByTestId('plotly-chart')).toHaveTextContent(JSON.stringify(mockChartSpec));\n    });\n});\n\ntest('renders table response with download button', async () => {\n    render(() => <Chat />);\n    const inputElement = screen.getByPlaceholderText(/Fa\u00e7a uma pergunta sobre os dados.../i) as HTMLInputElement;\n    const sendButton = screen.getByRole('button', { name: /Enviar/i });\n\n    fireEvent.input(inputElement, { target: { value: 'Show me table data' } });\n    fireEvent.click(sendButton);\n\n    const es = MockEventSource.instances[0];\n    const mockTableData = [{ id: 1, name: 'Item A' }, { id: 2, name: 'Item B' }];\n\n    es.onmessage({ data: JSON.stringify({ type: 'table', data: mockTableData, done: false }) } as MessageEvent);\n    es.onmessage({ data: JSON.stringify({ type: 'final', text: '', done: true }) } as MessageEvent);\n\n    await vi.waitFor(() => {\n        expect(screen.getByTestId('data-table')).toBeInTheDocument();\n        expect(screen.getByTestId('data-table')).toHaveTextContent(JSON.stringify(mockTableData));\n        expect(screen.getByTestId('download-button')).toBeInTheDocument();\n    });\n});\n\ntest('handles error during streaming', async () => {\n  render(() => <Chat />);\n  const inputElement = screen.getByPlaceholderText(/Fa\u00e7a uma pergunta sobre os dados.../i) as HTMLInputElement;\n  const sendButton = screen.getByRole('button', { name: /Enviar/i });\n\n  fireEvent.input(inputElement, { target: { value: 'Error test' } });\n  fireEvent.click(sendButton);\n\n  const es = MockEventSource.instances[0];\n\n  es.onmessage({ data: JSON.stringify({ type: 'error', error: 'Simulated backend error', details: { code: 500 } }) } as MessageEvent);\n\n  await vi.waitFor(() => {\n    expect(screen.getByText(/Erro do servidor/i)).toBeInTheDocument();\n    expect(screen.getByText(/Simulated backend error/i)).toBeInTheDocument();\n    expect(sendButton).toBeEnabled();\n  });\n  expect(es.close).toHaveBeenCalledTimes(1);\n});\n\ntest('feedback button appears after streaming ends', async () => {\n    render(() => <Chat />);\n    const inputElement = screen.getByPlaceholderText(/Fa\u00e7a uma pergunta sobre os dados.../i) as HTMLInputElement;\n    const sendButton = screen.getByRole('button', { name: /Enviar/i });\n\n    fireEvent.input(inputElement, { target: { value: 'Feedback test' } });\n    fireEvent.click(sendButton);\n\n    const es = MockEventSource.instances[0];\n    es.onmessage({ data: JSON.stringify({ type: 'text', text: 'This is a test message.", "mimetype": "text/plain", "start_char_idx": 3699, "end_char_idx": 7563, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3f7bb3e9-99e4-4881-baf0-e42298893cb0": {"__data__": {"id_": "3f7bb3e9-99e4-4881-baf0-e42298893cb0", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\components\\__tests__\\Chat.test.tsx", "language": "typescript", "lines": 223, "filename": "Chat.test.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "69ada291-f55c-49a7-a2a2-98550c6cba35", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\components\\__tests__\\Chat.test.tsx", "language": "typescript", "lines": 223, "filename": "Chat.test.tsx"}, "hash": "3425c9ffd0e80406df281439320e9aa02205c4a083f073c8c2eb1815f415118e", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "a06d5482-b557-4870-8739-98e76111edc5", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\components\\__tests__\\Chat.test.tsx", "language": "typescript", "lines": 223, "filename": "Chat.test.tsx"}, "hash": "30c7b4e647a8eadc4d128d8a54f5122beef61d3b42b4bcd9c27deb0d53473eae", "class_name": "RelatedNodeInfo"}}, "text": "', done: false }) } as MessageEvent);\n    es.onmessage({ data: JSON.stringify({ type: 'final', text: '', done: true }) } as MessageEvent);\n\n    await vi.waitFor(() => {\n        expect(screen.getByTestId('feedback-button')).toBeInTheDocument();\n    });\n});\n\ntest('feedback submission handler is called', async () => {\n    render(() => <Chat />);\n    const inputElement = screen.getByPlaceholderText(/Fa\u00e7a uma pergunta sobre os dados.../i) as HTMLInputElement;\n    const sendButton = screen.getByRole('button', { name: /Enviar/i });\n\n    fireEvent.input(inputElement, { target: { value: 'Feedback test' } });\n    fireEvent.click(sendButton);\n\n    const es = MockEventSource.instances[0];\n    es.onmessage({ data: JSON.stringify({ type: 'text', text: 'Response with ID', done: false }) } as MessageEvent);\n    es.onmessage({ data: JSON.stringify({ type: 'final', text: '', done: true }) } as MessageEvent);\n\n    // Mock the fetch call for feedback\n    const mockFetch = vi.fn(() => Promise.resolve({ ok: true }));\n    vi.stubGlobal('fetch', mockFetch);\n\n    await vi.waitFor(() => {\n        const feedbackButton = screen.getByTestId('feedback-button');\n        fireEvent.click(feedbackButton); // Click the mock feedback button\n    });\n    \n    expect(mockFetch).toHaveBeenCalledTimes(1);\n    expect(mockFetch).toHaveBeenCalledWith('/api/v1/chat/feedback', expect.objectContaining({\n        method: 'POST',\n        body: expect.stringContaining('\"feedback_type\":\"positive\"')\n    }));\n});", "mimetype": "text/plain", "start_char_idx": 7563, "end_char_idx": 9047, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1b9c636c-3917-438b-a5c6-63cd915720b4": {"__data__": {"id_": "1b9c636c-3917-438b-a5c6-63cd915720b4", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6bcb8ccf-b935-43f8-948c-84b6dfe58909", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "hash": "a27fa1948df91c6d89498a2207abb7106f9a93450eeb7f995a8216727e2bb879", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "7ab5f559-ccb2-49b2-83e8-2157c1b1354c", "node_type": "1", "metadata": {}, "hash": "e999afa2360c5a02a27c4944242d89a6afe981529a8d6c198f91250f71320ba5", "class_name": "RelatedNodeInfo"}}, "text": "import { Badge, Button, Skeleton } from \"./migrated-components/components/ui\";\n\n/**\n * Demo page for migrated UI components\n * Showcases Skeleton, Badge, and Button components\n */\nexport default function ComponentsDemo() {\n  return (\n    <div class=\"min-h-screen bg-background p-8\">\n      <div class=\"max-w-6xl mx-auto space-y-12\">\n        {/* Header */}\n        <div class=\"text-center space-y-2\">\n          <h1 class=\"text-4xl font-bold text-foreground\">\n            Componentes UI Migrados\n          </h1>\n          <p class=\"text-lg text-muted-foreground\">\n            React \u2192 SolidJS | Fase 3 da Migra\u00e7\u00e3o\n          </p>\n        </div>\n\n        {/* Button Component */}\n        <section class=\"space-y-6\">\n          <div>\n            <h2 class=\"text-2xl font-semibold text-foreground mb-2\">Button</h2>\n            <p class=\"text-muted-foreground\">6 variantes \u00d7 6 tamanhos = 36 combina\u00e7\u00f5es</p>\n          </div>\n\n          <div class=\"space-y-4\">\n            <div>\n              <h3 class=\"text-lg font-medium text-foreground mb-3\">Variantes</h3>\n              <div class=\"flex flex-wrap gap-3\">\n                <Button variant=\"default\">Default</Button>\n                <Button variant=\"secondary\">Secondary</Button>\n                <Button variant=\"destructive\">Destructive</Button>\n                <Button variant=\"outline\">Outline</Button>\n                <Button variant=\"ghost\">Ghost</Button>\n                <Button variant=\"link\">Link</Button>\n              </div>\n            </div>\n\n            <div>\n              <h3 class=\"text-lg font-medium text-foreground mb-3\">Tamanhos</h3>\n              <div class=\"flex flex-wrap items-center gap-3\">\n                <Button size=\"sm\">Small</Button>\n                <Button size=\"default\">Default</Button>\n                <Button size=\"lg\">Large</Button>\n                <Button size=\"icon\">\ud83d\ude80</Button>\n                <Button size=\"icon-sm\">\u2b50</Button>\n                <Button size=\"icon-lg\">\ud83d\udc8e</Button>\n              </div>\n            </div>\n\n            <div>\n              <h3 class=\"text-lg font-medium text-foreground mb-3\">Estados</h3>\n              <div class=\"flex flex-wrap gap-3\">\n                <Button>Normal</Button>", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2184, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7ab5f559-ccb2-49b2-83e8-2157c1b1354c": {"__data__": {"id_": "7ab5f559-ccb2-49b2-83e8-2157c1b1354c", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6bcb8ccf-b935-43f8-948c-84b6dfe58909", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "hash": "a27fa1948df91c6d89498a2207abb7106f9a93450eeb7f995a8216727e2bb879", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "1b9c636c-3917-438b-a5c6-63cd915720b4", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "hash": "b893e8c262d318b24ea2b2bc09cb6985c3bec0a4a94f6c71930252d9215f4ac6", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "d119ec1a-0561-4491-a9d7-31752efdc612", "node_type": "1", "metadata": {}, "hash": "2d95f1eec4612982653e4ec487c4695836fca46d97aa614c586a94a56298810a", "class_name": "RelatedNodeInfo"}}, "text": "<Button size=\"icon\">\ud83d\ude80</Button>\n                <Button size=\"icon-sm\">\u2b50</Button>\n                <Button size=\"icon-lg\">\ud83d\udc8e</Button>\n              </div>\n            </div>\n\n            <div>\n              <h3 class=\"text-lg font-medium text-foreground mb-3\">Estados</h3>\n              <div class=\"flex flex-wrap gap-3\">\n                <Button>Normal</Button>\n                <Button disabled>Disabled</Button>\n              </div>\n            </div>\n          </div>\n        </section>\n\n        {/* Badge Component */}\n        <section class=\"space-y-6\">\n          <div>\n            <h2 class=\"text-2xl font-semibold text-foreground mb-2\">Badge</h2>\n            <p class=\"text-muted-foreground\">4 variantes para status e labels</p>\n          </div>\n\n          <div class=\"space-y-4\">\n            <div>\n              <h3 class=\"text-lg font-medium text-foreground mb-3\">Variantes</h3>\n              <div class=\"flex flex-wrap gap-3\">\n                <Badge variant=\"default\">Default</Badge>\n                <Badge variant=\"secondary\">Secondary</Badge>\n                <Badge variant=\"destructive\">Destructive</Badge>\n                <Badge variant=\"outline\">Outline</Badge>\n              </div>\n            </div>\n\n            <div>\n              <h3 class=\"text-lg font-medium text-foreground mb-3\">Casos de Uso</h3>\n              <div class=\"flex flex-wrap gap-3\">\n                <Badge variant=\"default\">New</Badge>\n                <Badge variant=\"secondary\">In Progress</Badge>\n                <Badge variant=\"outline\">Draft</Badge>\n                <Badge variant=\"destructive\">Error</Badge>\n              </div>\n            </div>\n          </div>\n        </section>\n\n        {/* Skeleton Component */}\n        <section class=\"space-y-6\">\n          <div>\n            <h2 class=\"text-2xl font-semibold text-foreground mb-2\">Skeleton</h2>\n            <p class=\"text-muted-foreground\">Loading states</p>\n          </div>\n\n          <div class=\"space-y-4\">\n            <div class=\"border border-border rounded-lg p-6", "mimetype": "text/plain", "start_char_idx": 1826, "end_char_idx": 3843, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d119ec1a-0561-4491-a9d7-31752efdc612": {"__data__": {"id_": "d119ec1a-0561-4491-a9d7-31752efdc612", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6bcb8ccf-b935-43f8-948c-84b6dfe58909", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "hash": "a27fa1948df91c6d89498a2207abb7106f9a93450eeb7f995a8216727e2bb879", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "7ab5f559-ccb2-49b2-83e8-2157c1b1354c", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "hash": "e0fc7ccda8ef3354c67834f62155b22017ab8ced4b2c779215130553223add85", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2cb1a28c-3bdf-4695-8ce4-d83da532bdfb", "node_type": "1", "metadata": {}, "hash": "8b8a013ec32fd462656dfc8cb836ac89e2d69f1c502291b52d71ad5eb0698b94", "class_name": "RelatedNodeInfo"}}, "text": "</div>\n            </div>\n          </div>\n        </section>\n\n        {/* Skeleton Component */}\n        <section class=\"space-y-6\">\n          <div>\n            <h2 class=\"text-2xl font-semibold text-foreground mb-2\">Skeleton</h2>\n            <p class=\"text-muted-foreground\">Loading states</p>\n          </div>\n\n          <div class=\"space-y-4\">\n            <div class=\"border border-border rounded-lg p-6 space-y-4\">\n              <div class=\"flex items-center space-x-4\">\n                <Skeleton class=\"h-12 w-12 rounded-full\" />\n                <div class=\"flex-1 space-y-2\">\n                  <Skeleton class=\"h-4 w-3/4\" />\n                  <Skeleton class=\"h-4 w-1/2\" />\n                </div>\n              </div>\n            </div>\n          </div>\n        </section>\n\n        {/* Integration Example */}\n        <section class=\"space-y-6\">\n          <div>\n            <h2 class=\"text-2xl font-semibold text-foreground mb-2\">Integra\u00e7\u00e3o</h2>\n            <p class=\"text-muted-foreground\">Componentes trabalhando juntos</p>\n          </div>\n\n          <div class=\"border border-border rounded-lg p-6 space-y-4\">\n            <div class=\"flex items-center justify-between\">\n              <div class=\"space-y-1\">\n                <h3 class=\"text-lg font-medium text-foreground\">Card de Exemplo</h3>\n                <p class=\"text-sm text-muted-foreground\">Demonstra\u00e7\u00e3o de integra\u00e7\u00e3o</p>\n              </div>\n              <Badge variant=\"default\">Active</Badge>\n            </div>\n            <div class=\"flex gap-2\">\n              <Button variant=\"default\" size=\"sm\">Salvar</Button>\n              <Button variant=\"outline\" size=\"sm\">Cancelar</Button>\n              <Button variant=\"destructive\" size=\"sm\">Excluir</Button>\n            </div>\n          </div>\n        </section>\n\n        {/* Status */}\n        <section class=\"border-t border-border pt-6\">\n          <h3 class=\"text-lg font-medium text-foreground mb-3\">Status da Migra\u00e7\u00e3o</h3>\n          <div class=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div class=\"border border-border rounded-lg p-4 space-y-2\">", "mimetype": "text/plain", "start_char_idx": 3436, "end_char_idx": 5517, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2cb1a28c-3bdf-4695-8ce4-d83da532bdfb": {"__data__": {"id_": "2cb1a28c-3bdf-4695-8ce4-d83da532bdfb", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6bcb8ccf-b935-43f8-948c-84b6dfe58909", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "hash": "a27fa1948df91c6d89498a2207abb7106f9a93450eeb7f995a8216727e2bb879", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "d119ec1a-0561-4491-a9d7-31752efdc612", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}, "hash": "efad97cb64f52cef456b03acb279fd67b0e633aa7193da12864c718eeeaa6cd6", "class_name": "RelatedNodeInfo"}}, "text": "size=\"sm\">Cancelar</Button>\n              <Button variant=\"destructive\" size=\"sm\">Excluir</Button>\n            </div>\n          </div>\n        </section>\n\n        {/* Status */}\n        <section class=\"border-t border-border pt-6\">\n          <h3 class=\"text-lg font-medium text-foreground mb-3\">Status da Migra\u00e7\u00e3o</h3>\n          <div class=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div class=\"border border-border rounded-lg p-4 space-y-2\">\n              <div class=\"flex items-center justify-between\">\n                <h4 class=\"font-medium text-foreground\">Skeleton</h4>\n                <Badge variant=\"default\">\u2713</Badge>\n              </div>\n              <p class=\"text-sm text-muted-foreground\">3/4 testes passando</p>\n            </div>\n            <div class=\"border border-border rounded-lg p-4 space-y-2\">\n              <div class=\"flex items-center justify-between\">\n                <h4 class=\"font-medium text-foreground\">Badge</h4>\n                <Badge variant=\"default\">\u2713</Badge>\n              </div>\n              <p class=\"text-sm text-muted-foreground\">6/6 testes passando</p>\n            </div>\n            <div class=\"border border-border rounded-lg p-4 space-y-2\">\n              <div class=\"flex items-center justify-between\">\n                <h4 class=\"font-medium text-foreground\">Button</h4>\n                <Badge variant=\"default\">\u2713</Badge>\n              </div>\n              <p class=\"text-sm text-muted-foreground\">8/8 testes passando</p>\n            </div>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 5065, "end_char_idx": 6629, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ed8efb4a-6815-46a3-b73f-e11ced1257f8": {"__data__": {"id_": "ed8efb4a-6815-46a3-b73f-e11ced1257f8", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\examples\\MinimalLogin.tsx", "language": "typescript", "lines": 14, "filename": "MinimalLogin.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "17e250dc-a486-42ac-92b9-79283e8bb181", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\examples\\MinimalLogin.tsx", "language": "typescript", "lines": 14, "filename": "MinimalLogin.tsx"}, "hash": "82523ae6d036209b57c6f4a9a8ef516562d3300feb99150ca8f32a85c9a31d78", "class_name": "RelatedNodeInfo"}}, "text": "export default function MinimalLogin() {\n  return (\n    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh', backgroundColor: '#020817', color: '#f8fafc' }}>\n      <div style={{ padding: '2rem', backgroundColor: '#0f172a', borderRadius: '0.5rem', border: '1px solid #1e293b', boxShadow: '0 4px 6px rgba(0,0,0,0.1)' }}>\n        <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#38bdf8', textAlign: 'center', marginBottom: '1rem' }}>Login M\u00ednimo</h1>\n        <p style={{ color: '#94a3b8', textAlign: 'center' }}>A p\u00e1gina est\u00e1 renderizando estaticamente.</p>\n        <div style={{ marginTop: '1rem', padding: '0.5rem', backgroundColor: '#1e293b', borderRadius: '0.25rem', color: '#cbd5e1' }}>\n            Usu\u00e1rio: Teste<br />Senha: Teste\n        </div>\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 835, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0d2dbbdd-a03b-4a28-ade5-7f9cf43e5ec7": {"__data__": {"id_": "0d2dbbdd-a03b-4a28-ade5-7f9cf43e5ec7", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\examples\\SkeletonDemo.tsx", "language": "typescript", "lines": 85, "filename": "SkeletonDemo.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "3b7b22d2-b9a7-4439-a33a-e62e91aa2301", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\examples\\SkeletonDemo.tsx", "language": "typescript", "lines": 85, "filename": "SkeletonDemo.tsx"}, "hash": "f7e20a49b010db315e63f8fe742ba773043d93e7e7a4c22ab3cf7b7981f2fcf6", "class_name": "RelatedNodeInfo"}}, "text": "import { Skeleton } from \"./migrated-components/components/ui/Skeleton\";\n\n/**\n * Demo page for Skeleton component\n * Tests visual rendering and different use cases\n */\nexport default function SkeletonDemo() {\n  return (\n    <div class=\"min-h-screen bg-background p-8\">\n      <div class=\"max-w-4xl mx-auto space-y-8\">\n        <div>\n          <h1 class=\"text-3xl font-bold text-foreground mb-2\">\n            Skeleton Component Demo\n          </h1>\n          <p class=\"text-muted-foreground\">\n            Componente migrado do React para SolidJS - Fase 3 Piloto\n          </p>\n        </div>\n\n        {/* Basic Skeleton */}\n        <section class=\"space-y-4\">\n          <h2 class=\"text-2xl font-semibold text-foreground\">Basic Skeleton</h2>\n          <div class=\"space-y-2\">\n            <Skeleton class=\"h-4 w-full\" />\n            <Skeleton class=\"h-4 w-3/4\" />\n            <Skeleton class=\"h-4 w-1/2\" />\n          </div>\n        </section>\n\n        {/* Card Skeleton */}\n        <section class=\"space-y-4\">\n          <h2 class=\"text-2xl font-semibold text-foreground\">Card Skeleton</h2>\n          <div class=\"border border-border rounded-lg p-6 space-y-4\">\n            <Skeleton class=\"h-12 w-12 rounded-full\" />\n            <div class=\"space-y-2\">\n              <Skeleton class=\"h-4 w-full\" />\n              <Skeleton class=\"h-4 w-4/5\" />\n            </div>\n          </div>\n        </section>\n\n        {/* List Skeleton */}\n        <section class=\"space-y-4\">\n          <h2 class=\"text-2xl font-semibold text-foreground\">List Skeleton</h2>\n          <div class=\"space-y-3\">\n            {[...Array(5)].map((_, i) => (\n              <div class=\"flex items-center space-x-4\">\n                <Skeleton class=\"h-10 w-10 rounded-full\" />\n                <div class=\"flex-1 space-y-2\">\n                  <Skeleton class=\"h-3 w-3/4\" />\n                  <Skeleton class=\"h-3 w-1/2\" />\n                </div>\n              </div>\n            ))}\n          </div>\n        </section>\n\n        {/* Table Skeleton */}\n        <section class=\"space-y-4\">\n          <h2 class=\"text-2xl font-semibold text-foreground\">Table Skeleton</h2>\n          <div class=\"space-y-2\">\n            <Skeleton class=\"h-8 w-full\" />\n            {[...Array(4)].map((_, i) => (\n              <Skeleton class=\"h-12 w-full\" />\n            ))}\n          </div>\n        </section>\n\n        {/* Status */}\n        <section class=\"border-t border-border pt-6\">\n          <h3 class=\"text-lg font-medium text-foreground mb-2\">Status da Migra\u00e7\u00e3o</h3>\n          <ul class=\"space-y-1 text-sm text-muted-foreground\">\n            <li>\u2705 Componente migrado do React para SolidJS</li>\n            <li>\u2705 Tipagem TypeScript correta</li>\n            <li>\u2705 Props funcionando (class, data-*, aria-*)</li>\n            <li>\u2705 Anima\u00e7\u00e3o pulse ativa</li>\n            <li>\u2705 Integra\u00e7\u00e3o com fun\u00e7\u00e3o cn()</li>\n            <li>\u26a0\ufe0f  3/4 testes passando (1 teste com issue no matcher)</li>\n          </ul>\n        </section>\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2985, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3c719b24-1c54-4418-93e6-7b8cea11eb9f": {"__data__": {"id_": "3c719b24-1c54-4418-93e6-7b8cea11eb9f", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\hooks\\useAdmin.ts", "language": "typescript", "lines": 91, "filename": "useAdmin.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "c5943d27-24e8-4821-b817-a97ff01f6fb3", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\hooks\\useAdmin.ts", "language": "typescript", "lines": 91, "filename": "useAdmin.ts"}, "hash": "c1e4c13546f87d760204f92fad204985bc3657f3fc1e528c7aca5be645391d24", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * useAdmin Hook - SolidJS\n * Hook para gerenciar opera\u00e7\u00f5es administrativas\n */\n\nimport { createQuery, createMutation, useQueryClient } from '@tanstack/solid-query';\nimport { adminService } from '@/services/admin.service';\nimport { toast } from '@/migrated-components/components/ui/Sonner';\nimport type { CreateUserDTO, UpdateUserDTO, SystemSettings } from '@/types/admin';\n\nexport function useAdmin() {\n  const queryClient = useQueryClient();\n\n  // Queries\n  const statsQuery = createQuery(() => ({\n    queryKey: ['admin', 'stats'],\n    queryFn: adminService.getStats,\n  }));\n\n  const usersQuery = createQuery(() => ({\n    queryKey: ['admin', 'users'],\n    queryFn: adminService.getUsers,\n  }));\n\n  const auditLogsQuery = createQuery(() => ({\n    queryKey: ['admin', 'audit'],\n    queryFn: () => adminService.getAuditLogs(),\n  }));\n\n  const settingsQuery = createQuery(() => ({\n    queryKey: ['admin', 'settings'],\n    queryFn: adminService.getSettings,\n  }));\n\n  // Mutations\n  const createUserMutation = createMutation(() => ({\n    mutationFn: adminService.createUser,\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['admin', 'users'] });\n      toast('Usu\u00e1rio criado com sucesso!', { type: 'success' });\n    },\n    onError: () => {\n      toast('Erro ao criar usu\u00e1rio', { type: 'error' });\n    }\n  }));\n\n  const updateUserMutation = createMutation(() => ({\n    mutationFn: ({ id, data }: { id: string; data: UpdateUserDTO }) => \n      adminService.updateUser(id, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['admin', 'users'] });\n      toast('Usu\u00e1rio atualizado com sucesso!', { type: 'success' });\n    },\n    onError: () => {\n      toast('Erro ao atualizar usu\u00e1rio', { type: 'error' });\n    }\n  }));\n\n  const deleteUserMutation = createMutation(() => ({\n    mutationFn: adminService.deleteUser,\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['admin', 'users'] });\n      toast('Usu\u00e1rio removido', { type: 'success' });\n    },\n  }));\n\n  const updateSettingsMutation = createMutation(() => ({\n    mutationFn: adminService.updateSettings,\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['admin', 'settings'] });\n      toast('Configura\u00e7\u00f5es salvas com sucesso!', { type: 'success' });\n    },\n  }));\n\n  return {\n    stats: statsQuery.data,\n    users: usersQuery.data,\n    auditLogs: auditLogsQuery.data,\n    settings: settingsQuery.data,\n    isLoadingStats: statsQuery.isLoading,\n    isLoadingUsers: usersQuery.isLoading,\n    createUser: createUserMutation.mutate,\n    updateUser: updateUserMutation.mutate,\n    deleteUser: deleteUserMutation.mutate,\n    updateSettings: updateSettingsMutation.mutate,\n    isCreatingUser: createUserMutation.isPending,\n    isUpdatingUser: updateUserMutation.isPending,\n    isSavingSettings: updateSettingsMutation.isPending,\n  };\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2871, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2b01c65c-ff77-4943-b0e1-8603972cfd00": {"__data__": {"id_": "2b01c65c-ff77-4943-b0e1-8603972cfd00", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\hooks\\useAnalytics.ts", "language": "typescript", "lines": 63, "filename": "useAnalytics.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "5b77fe54-9b10-498c-ab50-ef1b5a679d1e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\hooks\\useAnalytics.ts", "language": "typescript", "lines": 63, "filename": "useAnalytics.ts"}, "hash": "7c5611477f9f9f7f35b3bd7912712e91181659d170dc867767bdb40e1d5c08c3", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * useAnalytics Hook - SolidJS\n * Hook customizado para gerenciar estado e opera\u00e7\u00f5es de analytics\n */\n\nimport { createQuery, createMutation, useQueryClient } from '@tanstack/solid-query';\nimport { analyticsService } from '@/services/analytics.service';\nimport { toast } from '@/migrated-components/components/ui/Sonner';\nimport type { AnalyticsFilter, ExportFormat } from '@/types/analytics';\n\nexport function useAnalytics(initialFilters?: AnalyticsFilter) {\n  const queryClient = useQueryClient();\n\n  // Query para dados\n  const dataQuery = createQuery(() => ({\n    queryKey: ['analytics', 'data', initialFilters],\n    queryFn: () => analyticsService.getData(initialFilters),\n  }));\n\n  // Query para m\u00e9tricas\n  const metricsQuery = createQuery(() => ({\n    queryKey: ['analytics', 'metrics'],\n    queryFn: analyticsService.getMetrics,\n  }));\n\n  // Mutation para exporta\u00e7\u00e3o\n  const exportMutation = createMutation(() => ({\n    mutationFn: ({ format, filters }: { format: ExportFormat; filters?: AnalyticsFilter }) =>\n      analyticsService.exportData(format, filters),\n    onSuccess: (blob, variables) => {\n      // Criar download do arquivo\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `analytics-export.${variables.format}`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast(`Dados exportados em formato ${variables.format.toUpperCase()}`, { type: 'success' });\n    },\n    onError: () => {\n      toast('N\u00e3o foi poss\u00edvel exportar os dados', { type: 'error' });\n    },\n  }));\n\n  return {\n    data: dataQuery.data,\n    metrics: metricsQuery.data,\n    isLoading: dataQuery.isLoading || metricsQuery.isLoading,\n    isError: dataQuery.isError || metricsQuery.isError,\n    error: dataQuery.error || metricsQuery.error,\n    refetch: () => {\n      dataQuery.refetch();\n      metricsQuery.refetch();\n    },\n    exportData: (format: ExportFormat, filters?: AnalyticsFilter) =>\n      exportMutation.mutate({ format, filters }),\n    isExporting: exportMutation.isPending,\n  };\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2153, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "af48e01b-bc6c-4217-928f-7fbb56bb5391": {"__data__": {"id_": "af48e01b-bc6c-4217-928f-7fbb56bb5391", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\hooks\\useMediaQuery.ts", "language": "typescript", "lines": 34, "filename": "useMediaQuery.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1c8b7ffe-3389-4c3c-983c-a66ee5cd0d8d", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\hooks\\useMediaQuery.ts", "language": "typescript", "lines": 34, "filename": "useMediaQuery.ts"}, "hash": "701819e2381a488d71c53be82ad10b21b2023e8bf00e739d38168d674cf5ea6a", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * useMediaQuery Hook - SolidJS\n * Hook para detectar breakpoints responsivos\n */\n\nimport { createSignal, onMount, onCleanup } from 'solid-js';\n\nexport function useMediaQuery(query: string): () => boolean {\n  const [matches, setMatches] = createSignal(false);\n\n  onMount(() => {\n    const media = window.matchMedia(query);\n    \n    // Set initial value\n    setMatches(media.matches);\n\n    // Create event listener\n    const listener = (e: MediaQueryListEvent) => setMatches(e.matches);\n    \n    // Add listener\n    media.addEventListener('change', listener);\n\n    // Cleanup\n    onCleanup(() => media.removeEventListener('change', listener));\n  });\n\n  return matches;\n}\n\n// Predefined breakpoints\nexport const useIsMobile = () => useMediaQuery('(max-width: 768px)');\nexport const useIsTablet = () => useMediaQuery('(min-width: 769px) and (max-width: 1024px)');\nexport const useIsDesktop = () => useMediaQuery('(min-width: 1025px)');", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 936, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "1a44ee57-a47a-4a5e-bfcb-21678516f46c": {"__data__": {"id_": "1a44ee57-a47a-4a5e-bfcb-21678516f46c", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\hooks\\useReports.ts", "language": "typescript", "lines": 92, "filename": "useReports.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "70742b89-de98-429f-8de5-bc66aec0c8c8", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\hooks\\useReports.ts", "language": "typescript", "lines": 92, "filename": "useReports.ts"}, "hash": "d3e3e8b8233ab3ff613beab793a2a3a79ddb0d6c61ef8f1c647d5d83fee05d86", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * useReports Hook - SolidJS\n * Hook para gerenciar estado e opera\u00e7\u00f5es de relat\u00f3rios\n */\n\nimport { createQuery, createMutation, useQueryClient } from '@tanstack/solid-query';\nimport { reportsService } from '@/services/reports.service';\nimport { toast } from '@/migrated-components/components/ui/Sonner';\nimport { useNavigate } from '@solidjs/router';\nimport type { CreateReportDTO, UpdateReportDTO } from '@/types/reports';\n\nexport function useReports() {\n  const queryClient = useQueryClient();\n  const navigate = useNavigate();\n\n  // Queries\n  const reportsQuery = createQuery(() => ({\n    queryKey: ['reports'],\n    queryFn: reportsService.getAll,\n  }));\n\n  const templatesQuery = createQuery(() => ({\n    queryKey: ['reports', 'templates'],\n    queryFn: reportsService.getTemplates,\n  }));\n\n  // Mutations\n  const createMutation = createMutation(() => ({\n    mutationFn: reportsService.create,\n    onSuccess: (newReport) => {\n      queryClient.invalidateQueries({ queryKey: ['reports'] });\n      toast('Relat\u00f3rio criado com sucesso!', { type: 'success' });\n      navigate(`/reports/${newReport.id}/edit`);\n    },\n    onError: () => {\n      toast('Erro ao criar relat\u00f3rio', { type: 'error' });\n    }\n  }));\n\n  const updateMutation = createMutation(() => ({\n    mutationFn: ({ id, data }: { id: string; data: UpdateReportDTO }) => \n      reportsService.update(id, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['reports'] });\n      toast('Relat\u00f3rio salvo com sucesso!', { type: 'success' });\n    },\n    onError: () => {\n      toast('Erro ao salvar relat\u00f3rio', { type: 'error' });\n    }\n  }));\n\n  const deleteMutation = createMutation(() => ({\n    mutationFn: reportsService.delete,\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['reports'] });\n      toast('Relat\u00f3rio removido', { type: 'success' });\n    },\n  }));\n\n  const generatePDFMutation = createMutation(() => ({\n    mutationFn: reportsService.generatePDF,\n    onSuccess: (blob) => {\n      const url = window.URL.createObjectURL(blob);\n      window.open(url, '_blank');\n      toast('PDF gerado com sucesso!', { type: 'success' });\n    },\n  }));\n\n  return {\n    reports: reportsQuery.data,\n    templates: templatesQuery.data,\n    isLoading: reportsQuery.isLoading,\n    createReport: createMutation.mutate,\n    updateReport: updateMutation.mutate,\n    deleteReport: deleteMutation.mutate,\n    generatePDF: generatePDFMutation.mutate,\n    isCreating: createMutation.isPending,\n    isSaving: updateMutation.isPending,\n    isGenerating: generatePDFMutation.isPending,\n  };\n}\n\nexport function useReport(id: string) {\n  return createQuery(() => ({\n    queryKey: ['reports', id],\n    queryFn: () => reportsService.getById(id),\n    get enabled() {\n      return !!id;\n    },\n  }));\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2792, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a1e01383-cd89-4deb-a975-e34349b90ce5": {"__data__": {"id_": "a1e01383-cd89-4deb-a975-e34349b90ce5", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\lib\\api.ts", "language": "typescript", "lines": 209, "filename": "api.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "581ead2c-4ccc-4e96-9bcf-1cbb133447ca", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\lib\\api.ts", "language": "typescript", "lines": 209, "filename": "api.ts"}, "hash": "3c377360864dac470100df1d9fc6fa29e597e64aaae832873a7e6d6c91c64281", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c81d2e08-2e3e-4bfc-972e-becce5d4924a", "node_type": "1", "metadata": {}, "hash": "9bf9f2d07b8eea6cf7a849ffbb1174b427820fe495fb7fe762b08c8c5d6f0c4e", "class_name": "RelatedNodeInfo"}}, "text": "import axios from 'axios';\n\n// --- Type Definitions ---\n\nexport interface KpiMetrics {\n  total_queries: number;\n  total_errors: number;\n  success_rate_feedback: number;\n  cache_hit_rate: number;\n  average_response_time_ms: string | number;\n}\n\nexport interface ErrorTrendItem {\n  date: string;\n  error_count: number;\n}\n\nexport interface TopQueryItem {\n  query: string;\n  count: number;\n}\n\nexport interface Report {\n  id: string;\n  name: string;\n  description?: string;\n  created_at: string;\n}\n\nexport interface LearningResponse {\n  insights: string[];\n  feedback_stats: {\n    total: number;\n    positive: number;\n    negative: number;\n    partial: number;\n    success_rate: number;\n  };\n  common_patterns: string[];\n}\n\nexport interface TransferValidationPayload {\n  produto_id: number;\n  une_origem: number;\n  une_destino: number;\n  quantidade: number;\n}\n\nexport interface TransferValidationResponse {\n  status: string; // \"sucesso\", \"falha\", \"alerta\"\n  mensagem: string;\n}\n\nexport interface TransferSuggestion {\n  produto_id: number;\n  une_origem: number;\n  une_destino: number;\n  quantidade_sugerida: number;\n  mensagem: string;\n}\n\nexport interface TransferRequestPayload {\n  produto_id: number;\n  une_origem: number;\n  une_destino: number;\n  quantidade: number;\n  solicitante_id: string;\n}\n\nexport interface TransferReportQuery {\n  start_date?: string;\n  end_date?: string;\n}\n\n// Old Transfer interface is removed as it's replaced by TransferSuggestion or others.\n// export interface Transfer { ... }\n\nexport interface Ruptura {\n  PRODUTO: string;\n  NOME: string;\n  UNE: string;\n  ESTOQUE_UNE: number;\n  ESTOQUE_CD: number;\n  ESTOQUE_LV: number;\n  VENDA_30DD: number;\n  CRITICIDADE_PCT: number;\n  NECESSIDADE: number;\n  NOMESEGMENTO?: string;\n}\n\nexport interface RupturasSummary {\n  total: number;\n  criticos: number;\n  valor_estimado: number;\n}\n\n// --- API Client ---\n\nconst api = axios.create({\n  baseURL: '/api/v1',\n  headers: {\n    'Content-Type': 'application/json',\n  },\n});\n\napi.interceptors.request.use((config) => {\n  const token = localStorage.getItem('token');\n  if (token) {\n    config.headers.Authorization = `Bearer ${token}`;\n  }\n  return config;\n});\n\napi.interceptors.response.use((response) => {\n  return response;\n}, (error) => {\n  if (error.response && error.response.status === 401) {\n    console.warn('\u26a0\ufe0f 401 Unauthorized - Token inv\u00e1lido ou expirado. Deslogando usu\u00e1rio...');\n    localStorage.removeItem('token');\n    // For\u00e7ar recarregamento para limpar estados\n    if (window.location.pathname !== '/login') {\n        window.location.href = '/login';\n    }\n  }\n  return Promise.reject(error);\n});\n\n// --- API Methods ---\n\nexport const analyticsApi = {\n  getKpis: (days: number = 7) => api.get<KpiMetrics>(`/analytics/kpis?days=${days}`),\n  getErrorTrend: (days: number = 30) => api.get<ErrorTrendItem[]>(`/analytics/error-trend?days=${days}`),\n  getTopQueries: (days: number = 7, limit: number = 10) => api.get<TopQueryItem[]>(`/analytics/top-queries?days=${days}&limit=${limit}`),\n  getFilterOptions: () => api.get<{ categorias: string[], segmentos: string[] }>('/analytics/filter-options'),\n};\n\nexport const reportsApi = {\n  getAll: () => api.get<Report[]>('/reports'),\n};\n\nexport interface UserData {\n  id: string;\n  username: string;\n  email: string;\n  role: string;\n  full_name?: string;\n  is_active: boolean;\n  allowed_segments?: string[];\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface CreateUserPayload {\n  username: string;\n  email: string;\n  password: string;\n  role: string;\n  allowed_segments?: string[];\n}\n\nexport interface UpdateUserPayload {\n  username?: string;\n  email?: string;\n  password?: string;\n  role?: string;\n  is_active?: boolean;\n  allowed_segments?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3719, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c81d2e08-2e3e-4bfc-972e-becce5d4924a": {"__data__": {"id_": "c81d2e08-2e3e-4bfc-972e-becce5d4924a", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\lib\\api.ts", "language": "typescript", "lines": 209, "filename": "api.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "581ead2c-4ccc-4e96-9bcf-1cbb133447ca", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\lib\\api.ts", "language": "typescript", "lines": 209, "filename": "api.ts"}, "hash": "3c377360864dac470100df1d9fc6fa29e597e64aaae832873a7e6d6c91c64281", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "a1e01383-cd89-4deb-a975-e34349b90ce5", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\lib\\api.ts", "language": "typescript", "lines": 209, "filename": "api.ts"}, "hash": "fd0081d3a5e6774e3f8e173c8013a04599e9e1c84c8e1108ce1943366f9f3620", "class_name": "RelatedNodeInfo"}}, "text": ": string;\n  is_active: boolean;\n  allowed_segments?: string[];\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface CreateUserPayload {\n  username: string;\n  email: string;\n  password: string;\n  role: string;\n  allowed_segments?: string[];\n}\n\nexport interface UpdateUserPayload {\n  username?: string;\n  email?: string;\n  password?: string;\n  role?: string;\n  is_active?: boolean;\n  allowed_segments?: string[];\n}\n\nexport const adminApi = {\n  syncParquet: () => api.post('/admin/sync-parquet'),\n\n  // User Management\n  getUsers: () => api.get<UserData[]>('/admin/users'),\n  getUser: (userId: string) => api.get<UserData>(`/admin/users/${userId}`),\n  createUser: (userData: CreateUserPayload) => api.post<UserData>('/admin/users', userData),\n  updateUser: (userId: string, userData: UpdateUserPayload) => api.put<UserData>(`/admin/users/${userId}`, userData),\n  deleteUser: (userId: string) => api.delete(`/admin/users/${userId}`),\n};\n\nexport const learningApi = {\n  getInsights: () => api.get<LearningResponse>('/learning/insights'),\n};\n\nexport const transfersApi = {\n  validateTransfer: (payload: TransferValidationPayload) => api.post<TransferValidationResponse>('/transfers/validate', payload),\n  getSuggestions: (segmento?: string, une_origem_excluir?: number, limit: number = 5) => api.get<TransferSuggestion[]>(`/transfers/suggestions`, { params: { segmento, une_origem_excluir, limit } }),\n  createTransferRequest: (payload: TransferRequestPayload) => api.post<{ message: string, transfer_id: string }>('/transfers', payload),\n  getReport: (query?: TransferReportQuery) => api.get<TransferRequestPayload[]>(`/transfers/report`, { params: query }),\n};\n\nexport const rupturasApi = {\n  getCritical: (limit = 50, segmento?: string, une?: string) => {\n    const params = new URLSearchParams({ limit: String(limit) });\n    if (segmento) params.append('segmento', segmento);\n    if (une) params.append('une', une);\n    return api.get<Ruptura[]>(`/rupturas/critical?${params.toString()}`);\n  },\n  getSegmentos: () => api.get<string[]>('/rupturas/filters/segmentos'),\n  getUnes: () => api.get<string[]>('/rupturas/filters/unes'),\n  getSummary: (segmento?: string, une?: string) => {\n    const params = new URLSearchParams();\n    if (segmento) params.append('segmento', segmento);\n    if (une) params.append('une', une);\n    return api.get<RupturasSummary>(`/rupturas/summary?${params.toString()}`);\n  },\n};\n\nexport default api;", "mimetype": "text/plain", "start_char_idx": 3309, "end_char_idx": 5744, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "612445c6-76a4-4945-ab1f-fb56454eec8d": {"__data__": {"id_": "612445c6-76a4-4945-ab1f-fb56454eec8d", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\lib\\export.ts", "language": "typescript", "lines": 30, "filename": "export.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "3047959e-b205-4a94-8909-8848c2158d71", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\lib\\export.ts", "language": "typescript", "lines": 30, "filename": "export.ts"}, "hash": "f8489ee33f5ff0d862643b030066da94432fc9654887dfd452f87e01a4223543", "class_name": "RelatedNodeInfo"}}, "text": "// frontend-solid/src/lib/export.ts\n\nimport { format } from 'date-fns';\nimport { enUS } from 'date-fns/locale';\n\n/**\n * Exports an array of objects to a CSV file.\n * @param data The array of objects to export.\n * @param filename The name of the CSV file.\n */\nexport const exportToCsv = (data: any[], filename: string) => {\n  if (!data || data.length === 0) {\n    alert(\"Nenhum dado para exportar.\");\n    return;\n  }\n\n  // Get headers from the first object's keys\n  const headers = Object.keys(data[0]);\n  \n  // Create CSV header row\n  const csvRows = [];\n  csvRows.push(headers.join(','));\n\n  // Add data rows\n  for (const row of data) {\n    const values = headers.map(header => {\n      const value = row[header];\n      // Handle values that might contain commas or newlines\n      if (typeof value === 'string' && (value.includes(',') || value.includes('\\n'))) {\n        return `\"${value.replace(/", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 897, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "eaf9dea7-2e42-40cc-beda-359923646183": {"__data__": {"id_": "eaf9dea7-2e42-40cc-beda-359923646183", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\lib\\formatters.ts", "language": "typescript", "lines": 20, "filename": "formatters.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "93bb9756-5ed5-44dd-a57e-afe5415b2f5c", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\lib\\formatters.ts", "language": "typescript", "lines": 20, "filename": "formatters.ts"}, "hash": "703942e85f3c171628a694c6dc744771e22ca5f0bd5548144c09dc6693636066", "class_name": "RelatedNodeInfo"}}, "text": "// frontend-solid/src/lib/formatters.ts\n\nexport const formatTimestamp = (timestamp: number | Date): string => {\n  const date = typeof timestamp === 'number' ? new Date(timestamp) : timestamp;\n  return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });\n};\n\n// Placeholder for other formatters from T5.3.1\nexport const formatCurrency = (value: number): string => {\n  return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });\n};\n\nexport const formatNumber = (value: number): string => {\n  return value.toLocaleString('pt-BR');\n};\n\nexport const formatDate = (date: Date): string => {\n  return date.toLocaleDateString('pt-BR');\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 668, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9090160f-49eb-4067-9f25-3f8a4845913c": {"__data__": {"id_": "9090160f-49eb-4067-9f25-3f8a4845913c", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\lib\\supabase.ts", "language": "typescript", "lines": 11, "filename": "supabase.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "cb44686a-6ca1-4136-97da-0f623d76042a", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\lib\\supabase.ts", "language": "typescript", "lines": 11, "filename": "supabase.ts"}, "hash": "e9954d89c60315f4a140bde2fd45b9d64a628b6e07a8f39ac848ae655238de56", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * Supabase Client Configuration for Frontend\n */\n\nimport { createClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = 'https://nmamxbriulivinlqqbmf.supabase.co'\nconst supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tYW14YnJpdWxpdmlubHFxYm1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjM2MDEsImV4cCI6MjA3ODg5OTYwMX0.Mf-CTCPqQ6zjA0Aqa2oQoWhyVjG4SbNX9O7mR7rfW5I'\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey)", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 474, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "54557e51-f726-4646-a99f-c2290a1be641": {"__data__": {"id_": "54557e51-f726-4646-a99f-c2290a1be641", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\lib\\api\\client.ts", "language": "typescript", "lines": 74, "filename": "client.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1ae1750c-c9fd-4451-a7ae-cfa6ebfa57e1", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\lib\\api\\client.ts", "language": "typescript", "lines": 74, "filename": "client.ts"}, "hash": "2537b6fb0fcd69b5e5ea7e9772d8ad3ea3f6155e01660c473e1bbc7c54072b37", "class_name": "RelatedNodeInfo"}}, "text": "import axios, { AxiosInstance, AxiosRequestConfig } from 'axios';\nimport { useAuthStore } from '@/store/auth.store';\n\nconst API_BASE_URL =\n  process.env.NEXT_PUBLIC_API_URL || 'http://127.0.0.1:8000';\n\nclass APIClient {\n  private client: AxiosInstance;\n\n  constructor() {\n    this.client = axios.create({\n      baseURL: API_BASE_URL,\n      timeout: 30000,\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    });\n\n    this.client.interceptors.request.use(\n      (config) => {\n        const token = useAuthStore.getState().token;\n        if (token) {\n          config.headers.Authorization = `Bearer ${token}`;\n        }\n        return config;\n      },\n      (error) => Promise.reject(error)\n    );\n\n    this.client.interceptors.response.use(\n      (response) => response,\n      (error) => {\n        if (error.response?.status === 401) {\n          useAuthStore.getState().logout();\n          if (typeof window !== 'undefined') {\n            window.location.href = '/login';\n          }\n        }\n        return Promise.reject(error);\n      }\n    );\n  }\n\n  async get<T>(url: string, config?: AxiosRequestConfig): Promise<T> {\n    const response = await this.client.get<T>(url, config);\n    return response.data;\n  }\n\n  async post<T>(\n    url: string,\n    data?: unknown,\n    config?: AxiosRequestConfig\n  ): Promise<T> {\n    const response = await this.client.post<T>(url, data, config);\n    return response.data;\n  }\n\n  async put<T>(\n    url: string,\n    data?: unknown,\n    config?: AxiosRequestConfig\n  ): Promise<T> {\n    const response = await this.client.put<T>(url, data, config);\n    return response.data;\n  }\n\n  async delete<T>(url: string, config?: AxiosRequestConfig): Promise<T> {\n    const response = await this.client.delete<T>(url, config);\n    return response.data;\n  }\n}\n\nexport const apiClient = new APIClient();", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1849, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "552654b9-58e6-49ef-95ce-fad60cbf9b75": {"__data__": {"id_": "552654b9-58e6-49ef-95ce-fad60cbf9b75", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Alert.tsx", "language": "typescript", "lines": 77, "filename": "Alert.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "39a14761-f57b-43a5-bd54-3763fe95b651", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Alert.tsx", "language": "typescript", "lines": 77, "filename": "Alert.tsx"}, "hash": "597cd41e3ef6441618a23aae93bb6784cce4a448dafe4e47ab327dacd45c8716", "class_name": "RelatedNodeInfo"}}, "text": "import type { JSX, ParentComponent } from \"solid-js\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\nimport { cn } from \"../../utils/cn\";\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-card text-card-foreground\",\n        destructive:\n          \"text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n);\n\ninterface AlertProps\n  extends JSX.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof alertVariants> {}\n\n/**\n * Alert component - notification container\n * Migrated from React to SolidJS\n */\nexport const Alert: ParentComponent<AlertProps> = (props) => {\n  return (\n    <div\n      data-slot=\"alert\"\n      role=\"alert\"\n      class={cn(alertVariants({ variant: props.variant }), props.class)}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\n/**\n * AlertTitle component - alert title\n */\nexport const AlertTitle: ParentComponent<AlertProps> = (props) => {\n  return (\n    <div\n      data-slot=\"alert-title\"\n      class={cn(\n        \"col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\n/**\n * AlertDescription component - alert description\n */\nexport const AlertDescription: ParentComponent<AlertProps> = (props) => {\n  return (\n    <div\n      data-slot=\"alert-description\"\n      class={cn(\n        \"text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1927, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "437c61ba-8bc3-48d9-a626-f23bc2e2b96d": {"__data__": {"id_": "437c61ba-8bc3-48d9-a626-f23bc2e2b96d", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Avatar.tsx", "language": "typescript", "lines": 57, "filename": "Avatar.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "75907ae3-2764-40b0-8140-09ccf704d647", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Avatar.tsx", "language": "typescript", "lines": 57, "filename": "Avatar.tsx"}, "hash": "8fa597c4ee44faadc281cd8dc3c7838c40bc9837b97e470e4c9a4b287d9a7018", "class_name": "RelatedNodeInfo"}}, "text": "import type { JSX, ParentComponent } from \"solid-js\";\nimport { cn } from \"../../utils/cn\";\n\ninterface AvatarProps extends JSX.HTMLAttributes<HTMLDivElement> {}\n\n/**\n * Avatar component - container\n * Migrated from React to SolidJS (Radix UI removed, native implementation)\n */\nexport const Avatar: ParentComponent<AvatarProps> = (props) => {\n  return (\n    <div\n      data-slot=\"avatar\"\n      class={cn(\n        \"relative flex size-8 shrink-0 overflow-hidden rounded-full\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\ninterface AvatarImageProps extends JSX.ImgHTMLAttributes<HTMLImageElement> {}\n\n/**\n * AvatarImage component - image element\n */\nexport function AvatarImage(props: AvatarImageProps) {\n  return (\n    <img\n      data-slot=\"avatar-image\"\n      class={cn(\"aspect-square size-full\", props.class)}\n      {...props}\n    />\n  );\n}\n\n/**\n * AvatarFallback component - fallback content\n */\nexport const AvatarFallback: ParentComponent<AvatarProps> = (props) => {\n  return (\n    <div\n      data-slot=\"avatar-fallback\"\n      class={cn(\n        \"bg-muted flex size-full items-center justify-center rounded-full\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1260, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6992e90a-4c68-4645-941b-80d00cec4dd1": {"__data__": {"id_": "6992e90a-4c68-4645-941b-80d00cec4dd1", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Badge.test.tsx", "language": "typescript", "lines": 55, "filename": "Badge.test.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "05a8716f-7666-4469-bb93-1556c22c722a", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Badge.test.tsx", "language": "typescript", "lines": 55, "filename": "Badge.test.tsx"}, "hash": "c6c699a3bfbfbdda1403bb2f60558bb221ec94a9729c0bca5dd6f81fe0b2877b", "class_name": "RelatedNodeInfo"}}, "text": "import { render } from \"@solidjs/testing-library\";\nimport { describe, it, expect } from \"vitest\";\nimport { Badge } from \"./Badge\";\n\ndescribe(\"Badge\", () => {\n  it(\"renders with default variant\", () => {\n    const { container } = render(() => <Badge>Default</Badge>);\n    const badge = container.querySelector('[data-slot=\"badge\"]');\n\n    expect(badge).not.toBeNull();\n    expect(badge?.textContent).toBe(\"Default\");\n    const className = badge?.className || \"\";\n    expect(className).toContain(\"bg-primary\");\n  });\n\n  it(\"renders with secondary variant\", () => {\n    const { container } = render(() => <Badge variant=\"secondary\">Secondary</Badge>);\n    const badge = container.querySelector('[data-slot=\"badge\"]');\n\n    const className = badge?.className || \"\";\n    expect(className).toContain(\"bg-secondary\");\n  });\n\n  it(\"renders with destructive variant\", () => {\n    const { container } = render(() => <Badge variant=\"destructive\">Error</Badge>);\n    const badge = container.querySelector('[data-slot=\"badge\"]');\n\n    const className = badge?.className || \"\";\n    expect(className).toContain(\"bg-destructive\");\n  });\n\n  it(\"renders with outline variant\", () => {\n    const { container } = render(() => <Badge variant=\"outline\">Outline</Badge>);\n    const badge = container.querySelector('[data-slot=\"badge\"]');\n\n    const className = badge?.className || \"\";\n    expect(className).toContain(\"text-foreground\");\n  });\n\n  it(\"accepts custom class\", () => {\n    const { container } = render(() => <Badge class=\"custom-badge\">Custom</Badge>);\n    const badge = container.querySelector('[data-slot=\"badge\"]');\n\n    const className = badge?.className || \"\";\n    expect(className).toContain(\"custom-badge\");\n  });\n\n  it(\"renders as a span element\", () => {\n    const { container } = render(() => <Badge>Test</Badge>);\n    const badge = container.querySelector('[data-slot=\"badge\"]');\n\n    expect(badge?.tagName).toBe(\"SPAN\");\n  });\n});", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1931, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8fdb4730-6eb8-49e7-af41-20e84aa09eef": {"__data__": {"id_": "8fdb4730-6eb8-49e7-af41-20e84aa09eef", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Badge.tsx", "language": "typescript", "lines": 54, "filename": "Badge.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2c33595d-a26c-422f-9f6d-34e9267baada", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Badge.tsx", "language": "typescript", "lines": 54, "filename": "Badge.tsx"}, "hash": "847627d8f7b2ccbfe548235914858ab2232088d56af94244f2b9dda0c0154af6", "class_name": "RelatedNodeInfo"}}, "text": "import type { JSX, ParentComponent } from \"solid-js\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\nimport { cn } from \"../../utils/cn\";\n\nconst badgeVariants = cva(\n  \"inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90\",\n        destructive:\n          \"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60\",\n        outline:\n          \"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n);\n\ninterface BadgeProps\n  extends JSX.HTMLAttributes<HTMLSpanElement>,\n    VariantProps<typeof badgeVariants> {}\n\n/**\n * Badge component for status indicators and labels\n * Migrated from React to SolidJS\n * \n * @example\n * ```tsx\n * <Badge variant=\"default\">New</Badge>\n * <Badge variant=\"destructive\">Error</Badge>\n * <Badge variant=\"outline\">Draft</Badge>\n * ```\n */\nexport const Badge: ParentComponent<BadgeProps> = (props) => {\n  return (\n    <span\n      data-slot=\"badge\"\n      class={cn(badgeVariants({ variant: props.variant }), props.class)}\n      {...props}\n    >\n      {props.children}\n    </span>\n  );\n};\n\nexport { badgeVariants };", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1879, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0366115f-e42c-423c-96b1-bdb34e05df3e": {"__data__": {"id_": "0366115f-e42c-423c-96b1-bdb34e05df3e", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Button.test.tsx", "language": "typescript", "lines": 74, "filename": "Button.test.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7382a6cf-214f-4b11-946e-170d48598305", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Button.test.tsx", "language": "typescript", "lines": 74, "filename": "Button.test.tsx"}, "hash": "eca5e9659a9173c1ce29fe22aadfe4358961d738e3ff6cdc1e59e73fba0b8050", "class_name": "RelatedNodeInfo"}}, "text": "import { render, fireEvent } from \"@solidjs/testing-library\";\nimport { describe, it, expect, vi } from \"vitest\";\nimport { Button } from \"./Button\";\n\ndescribe(\"Button\", () => {\n  it(\"renders with default variant and size\", () => {\n    const { container } = render(() => <Button>Click me</Button>);\n    const button = container.querySelector('[data-slot=\"button\"]');\n\n    expect(button).not.toBeNull();\n    expect(button?.textContent).toBe(\"Click me\");\n    const className = button?.className || \"\";\n    expect(className).toContain(\"bg-primary\");\n    expect(className).toContain(\"h-9\");\n  });\n\n  it(\"renders with destructive variant\", () => {\n    const { container } = render(() => <Button variant=\"destructive\">Delete</Button>);\n    const button = container.querySelector('[data-slot=\"button\"]');\n\n    const className = button?.className || \"\";\n    expect(className).toContain(\"bg-destructive\");\n  });\n\n  it(\"renders with outline variant\", () => {\n    const { container } = render(() => <Button variant=\"outline\">Cancel</Button>);\n    const button = container.querySelector('[data-slot=\"button\"]');\n\n    const className = button?.className || \"\";\n    expect(className).toContain(\"border\");\n  });\n\n  it(\"renders with small size\", () => {\n    const { container } = render(() => <Button size=\"sm\">Small</Button>);\n    const button = container.querySelector('[data-slot=\"button\"]');\n\n    const className = button?.className || \"\";\n    expect(className).toContain(\"h-8\");\n  });\n\n  it(\"renders with large size\", () => {\n    const { container } = render(() => <Button size=\"lg\">Large</Button>);\n    const button = container.querySelector('[data-slot=\"button\"]');\n\n    const className = button?.className || \"\";\n    expect(className).toContain(\"h-10\");\n  });\n\n  it(\"handles click events\", () => {\n    const handleClick = vi.fn();\n    const { container } = render(() => <Button onClick={handleClick}>Click</Button>);\n    const button = container.querySelector('[data-slot=\"button\"]') as HTMLButtonElement;\n\n    fireEvent.click(button);\n    expect(handleClick).toHaveBeenCalledTimes(1);\n  });\n\n  it(\"can be disabled\", () => {\n    const { container } = render(() => <Button disabled>Disabled</Button>);\n    const button = container.querySelector('[data-slot=\"button\"]') as HTMLButtonElement;\n\n    expect(button.disabled).toBe(true);\n    const className = button?.className || \"\";\n    expect(className).toContain(\"disabled:opacity-50\");\n  });\n\n  it(\"renders as a button element\", () => {\n    const { container } = render(() => <Button>Test</Button>);\n    const button = container.querySelector('[data-slot=\"button\"]');\n\n    expect(button?.tagName).toBe(\"BUTTON\");\n  });\n});", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2660, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ccaef467-a201-4dfe-b03b-9b072d630143": {"__data__": {"id_": "ccaef467-a201-4dfe-b03b-9b072d630143", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Button.tsx", "language": "typescript", "lines": 65, "filename": "Button.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d136238d-a534-46cb-ae84-7e34780fb8a9", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Button.tsx", "language": "typescript", "lines": 65, "filename": "Button.tsx"}, "hash": "6eb20881a07434f5026ba2c2b23594b54b27c031cf2a08da2aa03977ba9809e7", "class_name": "RelatedNodeInfo"}}, "text": "import type { JSX, ParentComponent } from \"solid-js\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\nimport { cn } from \"../../utils/cn\";\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60\",\n        outline:\n          \"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost:\n          \"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-9 px-4 py-2 has-[>svg]:px-3\",\n        sm: \"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5\",\n        lg: \"h-10 rounded-md px-6 has-[>svg]:px-4\",\n        icon: \"size-9\",\n        \"icon-sm\": \"size-8\",\n        \"icon-lg\": \"size-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n);\n\ninterface ButtonProps\n  extends JSX.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {}\n\n/**\n * Button component with multiple variants and sizes\n * Migrated from React to SolidJS\n * \n * @example\n * ```tsx\n * <Button variant=\"default\">Click me</Button>\n * <Button variant=\"destructive\" size=\"sm\">Delete</Button>\n * <Button variant=\"outline\" size=\"lg\">Cancel</Button>\n * ```\n */\nexport const Button: ParentComponent<ButtonProps> = (props) => {\n  return (\n    <button\n      data-slot=\"button\"\n      class={cn(buttonVariants({ variant: props.variant, size: props.size }), props.class)}\n      {...props}\n    >\n      {props.children}\n    </button>\n  );\n};\n\nexport { buttonVariants };", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2429, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2c8e6b71-26d3-424a-8bc2-6047db841fb0": {"__data__": {"id_": "2c8e6b71-26d3-424a-8bc2-6047db841fb0", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Card.tsx", "language": "typescript", "lines": 120, "filename": "Card.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "688effb7-04ea-421b-bd98-f8cf0a6ac441", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Card.tsx", "language": "typescript", "lines": 120, "filename": "Card.tsx"}, "hash": "93cbb0f6cca557e040ea6211bc1966b447b7fd2dddc74e5fb410ccafb1d747e8", "class_name": "RelatedNodeInfo"}}, "text": "import type { JSX, ParentComponent } from \"solid-js\";\nimport { cn } from \"../../utils/cn\";\n\ninterface CardProps extends JSX.HTMLAttributes<HTMLDivElement> {}\n\n/**\n * Card component - main container\n */\nexport const Card: ParentComponent<CardProps> = (props) => {\n  return (\n    <div\n      data-slot=\"card\"\n      class={cn(\n        \"bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\n/**\n * CardHeader component - header section\n */\nexport const CardHeader: ParentComponent<CardProps> = (props) => {\n  return (\n    <div\n      data-slot=\"card-header\"\n      class={cn(\n        \"@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6\",\n        \"has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\n/**\n * CardTitle component - title text\n */\nexport const CardTitle: ParentComponent<CardProps> = (props) => {\n  return (\n    <div\n      data-slot=\"card-title\"\n      class={cn(\"leading-none font-semibold\", props.class)}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\n/**\n * CardDescription component - description text\n */\nexport const CardDescription: ParentComponent<CardProps> = (props) => {\n  return (\n    <div\n      data-slot=\"card-description\"\n      class={cn(\"text-muted-foreground text-sm\", props.class)}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\n/**\n * CardAction component - action buttons area\n */\nexport const CardAction: ParentComponent<CardProps> = (props) => {\n  return (\n    <div\n      data-slot=\"card-action\"\n      class={cn(\n        \"col-start-2 row-span-2 row-start-1 self-start justify-self-end\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\n/**\n * CardContent component - main content area\n */\nexport const CardContent: ParentComponent<CardProps> = (props) => {\n  return (\n    <div\n      data-slot=\"card-content\"\n      class={cn(\"px-6\", props.class)}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\n/**\n * CardFooter component - footer section\n */\nexport const CardFooter: ParentComponent<CardProps> = (props) => {\n  return (\n    <div\n      data-slot=\"card-footer\"\n      class={cn(\"flex items-center px-6 [.border-t]:pt-6\", props.class)}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2497, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "815cd613-0496-4144-903c-f641afa70e33": {"__data__": {"id_": "815cd613-0496-4144-903c-f641afa70e33", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Dialog.tsx", "language": "typescript", "lines": 80, "filename": "Dialog.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "93214708-e259-4fbb-868c-51606fbceaf4", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Dialog.tsx", "language": "typescript", "lines": 80, "filename": "Dialog.tsx"}, "hash": "c23320a5eb480f68e7541c540f0c0f988427625cb6f7ba485b121ebdbce12416", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, type JSX, ParentComponent } from \"solid-js\";\nimport { Portal } from \"solid-js/web\";\nimport { cn } from \"../../utils/cn\";\n\ninterface DialogProps extends JSX.HTMLAttributes<HTMLDivElement> {\n  open?: boolean;\n  onOpenChange?: (open: boolean) => void;\n}\n\n/**\n * Dialog component - modal dialog\n * Migrated from React to SolidJS (Radix UI removed, native implementation)\n */\nexport const Dialog: ParentComponent<DialogProps> = (props) => {\n  const [isOpen, setIsOpen] = createSignal(props.open || false);\n  \n  const open = () => props.open !== undefined ? props.open : isOpen();\n  const setOpen = (value: boolean) => {\n    setIsOpen(value);\n    props.onOpenChange?.(value);\n  };\n\n  return (\n    <>\n      {open() && (\n        <Portal>\n          <div\n            data-slot=\"dialog-overlay\"\n            class=\"fixed inset-0 z-50 bg-black/80\"\n            onClick={() => setOpen(false)}\n          />\n          <div\n            data-slot=\"dialog\"\n            class={cn(\n              \"fixed left-[50%] top-[50%] z-50 translate-x-[-50%] translate-y-[-50%]\",\n              \"w-full max-w-lg rounded-lg border bg-background p-6 shadow-lg\",\n              props.class\n            )}\n            {...props}\n          >\n            {props.children}\n          </div>\n        </Portal>\n      )}\n    </>\n  );\n};\n\nexport const DialogContent: ParentComponent<JSX.HTMLAttributes<HTMLDivElement>> = (props) => {\n  return (\n    <div data-slot=\"dialog-content\" class={cn(\"space-y-4\", props.class)} {...props}>\n      {props.children}\n    </div>\n  );\n};\n\nexport const DialogHeader: ParentComponent<JSX.HTMLAttributes<HTMLDivElement>> = (props) => {\n  return (\n    <div data-slot=\"dialog-header\" class={cn(\"space-y-2\", props.class)} {...props}>\n      {props.children}\n    </div>\n  );\n};\n\nexport const DialogTitle: ParentComponent<JSX.HTMLAttributes<HTMLHeadingElement>> = (props) => {\n  return (\n    <h2 data-slot=\"dialog-title\" class={cn(\"text-lg font-semibold\", props.class)} {...props}>\n      {props.children}\n    </h2>\n  );\n};\n\nexport const DialogDescription: ParentComponent<JSX.HTMLAttributes<HTMLParagraphElement>> = (props) => {\n  return (\n    <p data-slot=\"dialog-description\" class={cn(\"text-sm text-muted-foreground\", props.class)} {...props}>\n      {props.children}\n    </p>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2287, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "760ae05b-0e0d-4c3c-8ccb-b3f862febd62": {"__data__": {"id_": "760ae05b-0e0d-4c3c-8ccb-b3f862febd62", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\DropdownMenu.tsx", "language": "typescript", "lines": 68, "filename": "DropdownMenu.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "cbb8f796-bd73-4862-9638-517f64f5486f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\DropdownMenu.tsx", "language": "typescript", "lines": 68, "filename": "DropdownMenu.tsx"}, "hash": "012c8f7a39d53d98e01508f275f54f012f8f06d309d8036ffcc0e2f38a251b76", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, type JSX, ParentComponent, Show } from \"solid-js\";\nimport { Portal } from \"solid-js/web\";\nimport { cn } from \"../../utils/cn\";\n\ninterface DropdownMenuProps extends JSX.HTMLAttributes<HTMLDivElement> {\n  open?: boolean;\n  onOpenChange?: (open: boolean) => void;\n}\n\n/**\n * DropdownMenu component - dropdown menu\n * Migrated from React to SolidJS (simplified native implementation)\n */\nexport const DropdownMenu: ParentComponent<DropdownMenuProps> = (props) => {\n  const [isOpen, setIsOpen] = createSignal(props.open || false);\n  \n  const open = () => props.open !== undefined ? props.open : isOpen();\n  const setOpen = (value: boolean) => {\n    setIsOpen(value);\n    props.onOpenChange?.(value);\n  };\n\n  return (\n    <div data-slot=\"dropdown\" class=\"relative inline-block\">\n      {props.children}\n    </div>\n  );\n};\n\nexport const DropdownMenuTrigger: ParentComponent<JSX.ButtonHTMLAttributes<HTMLButtonElement>> = (props) => {\n  return (\n    <button data-slot=\"dropdown-trigger\" {...props}>\n      {props.children}\n    </button>\n  );\n};\n\nexport const DropdownMenuContent: ParentComponent<JSX.HTMLAttributes<HTMLDivElement>> = (props) => {\n  return (\n    <div\n      data-slot=\"dropdown-content\"\n      class={cn(\n        \"absolute right-0 mt-2 w-56 rounded-md border bg-popover p-1 shadow-md z-50\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\nexport const DropdownMenuItem: ParentComponent<JSX.HTMLAttributes<HTMLDivElement>> = (props) => {\n  return (\n    <div\n      data-slot=\"dropdown-item\"\n      class={cn(\n        \"relative flex cursor-pointer select-none items-center rounded-sm px-2 py-1.5 text-sm\",\n        \"hover:bg-accent hover:text-accent-foreground\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1824, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c3aad143-c8d9-4dd6-803a-8557911222ad": {"__data__": {"id_": "c3aad143-c8d9-4dd6-803a-8557911222ad", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\index.ts", "language": "typescript", "lines": 55, "filename": "index.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "58406d29-193c-46a4-9940-66d19f8aa1a5", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\index.ts", "language": "typescript", "lines": 55, "filename": "index.ts"}, "hash": "a5c4c909faad298c526fe937ccd4283776ef57f9d37372f599492f233e55b53f", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * UI Components - Migrated from React to SolidJS\n * \n * This barrel file exports all UI components for easy importing\n * \n * Total: 18 components migrated (100%)\n */\n\nexport { Skeleton } from \"./Skeleton\";\nexport { Badge, badgeVariants } from \"./Badge\";\nexport { Button, buttonVariants } from \"./Button\";\nexport { Separator } from \"./Separator\";\nexport { Label } from \"./Label\";\nexport { Input } from \"./Input\";\nexport {\n  Card,\n  CardHeader,\n  CardTitle,\n  CardDescription,\n  CardAction,\n  CardContent,\n  CardFooter,\n} from \"./Card\";\nexport { Avatar, AvatarImage, AvatarFallback } from \"./Avatar\";\nexport { Alert, AlertTitle, AlertDescription } from \"./Alert\";\nexport { LazyImage } from \"./LazyImage\";\nexport { SkipLink } from \"./SkipLink\";\nexport { Tabs, TabsList, TabsTrigger, TabsContent } from \"./Tabs\";\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableRow,\n  TableHead,\n  TableCell,\n  TableCaption,\n} from \"./Table\";\nexport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"./Dialog\";\nexport { Select, SelectOption } from \"./Select\";\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n} from \"./DropdownMenu\";\nexport { Sheet, SheetHeader, SheetTitle } from \"./Sheet\";\nexport { toast, Toaster } from \"./Sonner\";", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1319, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6e203d6f-8f21-48d1-aa31-dfa749314653": {"__data__": {"id_": "6e203d6f-8f21-48d1-aa31-dfa749314653", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Input.tsx", "language": "typescript", "lines": 35, "filename": "Input.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "09712d3b-9cac-46ea-9aeb-8a261fb052e7", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Input.tsx", "language": "typescript", "lines": 35, "filename": "Input.tsx"}, "hash": "349642bfb2f63f0f485a4e547d08c503a47bd1bc9c85dd02fd39233116740340", "class_name": "RelatedNodeInfo"}}, "text": "import type { JSX } from \"solid-js\";\nimport { cn } from \"../../utils/cn\";\n\ninterface InputProps extends JSX.InputHTMLAttributes<HTMLInputElement> {}\n\n/**\n * Input component for form fields\n * Migrated from React to SolidJS\n * \n * @example\n * ```tsx\n * <Input type=\"text\" placeholder=\"Enter text...\" />\n * <Input type=\"email\" />\n * ```\n */\nexport function Input(props: InputProps) {\n  return (\n    <input\n      data-slot=\"input\"\n      class={cn(\n        \"file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground\",\n        \"dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs\",\n        \"transition-[color,box-shadow] outline-none\",\n        \"file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium\",\n        \"disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50\",\n        \"md:text-sm\",\n        \"focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]\",\n        \"aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive\",\n        props.class\n      )}\n      {...props}\n    />\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1216, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "fd3aca82-f0fb-422a-9c7c-98341bf58846": {"__data__": {"id_": "fd3aca82-f0fb-422a-9c7c-98341bf58846", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Label.tsx", "language": "typescript", "lines": 31, "filename": "Label.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "3583b44f-8839-4d9b-8a70-7661e91b5d2c", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Label.tsx", "language": "typescript", "lines": 31, "filename": "Label.tsx"}, "hash": "b144d5c576954d2505ef78d53fb04c305b9decd1166e4c0648bbfc12a8c12e10", "class_name": "RelatedNodeInfo"}}, "text": "import type { JSX, ParentComponent } from \"solid-js\";\nimport { cn } from \"../../utils/cn\";\n\ninterface LabelProps extends JSX.LabelHTMLAttributes<HTMLLabelElement> {}\n\n/**\n * Label component for form fields\n * Migrated from React to SolidJS (Radix UI removed, native implementation)\n * \n * @example\n * ```tsx\n * <Label for=\"email\">Email</Label>\n * ```\n */\nexport const Label: ParentComponent<LabelProps> = (props) => {\n  return (\n    <label\n      data-slot=\"label\"\n      class={cn(\n        \"flex items-center gap-2 text-sm leading-none font-medium select-none\",\n        \"group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50\",\n        \"peer-disabled:cursor-not-allowed peer-disabled:opacity-50\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </label>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 821, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d4d836f2-7be5-4534-bf17-6b7440ceddc3": {"__data__": {"id_": "d4d836f2-7be5-4534-bf17-6b7440ceddc3", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\LazyImage.tsx", "language": "typescript", "lines": 45, "filename": "LazyImage.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f84654c1-b017-4e1c-a53a-a264e4499db4", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\LazyImage.tsx", "language": "typescript", "lines": 45, "filename": "LazyImage.tsx"}, "hash": "119ccdfe4427e1cad7c8484cc9c4cf387090dfe46112460029886257e217b019", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, type JSX } from \"solid-js\";\nimport { cn } from \"../../utils/cn\";\n\ninterface LazyImageProps extends JSX.ImgHTMLAttributes<HTMLImageElement> {\n  fallbackSrc?: string;\n}\n\n/**\n * LazyImage component - optimized image loading\n * Migrated from React to SolidJS (Next.js Image removed, native img)\n * \n * @example\n * ```tsx\n * <LazyImage src=\"/image.jpg\" alt=\"Description\" />\n * ```\n */\nexport function LazyImage(props: LazyImageProps) {\n  const [isLoading, setIsLoading] = createSignal(true);\n  const [error, setError] = createSignal(false);\n  \n  const fallbackSrc = () => props.fallbackSrc || \"/placeholder.png\";\n  const imageSrc = () => error() ? fallbackSrc() : props.src;\n\n  return (\n    <div class={cn(\"relative overflow-hidden\", props.class)}>\n      <img\n        {...props}\n        src={imageSrc()}\n        class={cn(\n          \"transition-opacity duration-300\",\n          isLoading() ? \"opacity-0\" : \"opacity-100\"\n        )}\n        onLoad={() => setIsLoading(false)}\n        onError={() => {\n          setError(true);\n          setIsLoading(false);\n        }}\n      />\n      {isLoading() && (\n        <div class=\"absolute inset-0 bg-muted animate-pulse\" />\n      )}\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1208, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "01c75418-1e75-4089-923c-4ff6598b6b1e": {"__data__": {"id_": "01c75418-1e75-4089-923c-4ff6598b6b1e", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Select.tsx", "language": "typescript", "lines": 31, "filename": "Select.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "1faf9863-89b1-4892-99d1-67d0f4af8780", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Select.tsx", "language": "typescript", "lines": 31, "filename": "Select.tsx"}, "hash": "27cb79551772b49c2820c36e4e60be194a6ec14b741151071b6d1e20c5adea6a", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, type JSX, ParentComponent, Show } from \"solid-js\";\nimport { cn } from \"../../utils/cn\";\n\ninterface SelectProps extends JSX.SelectHTMLAttributes<HTMLSelectElement> {}\n\n/**\n * Select component - native select dropdown\n * Migrated from React to SolidJS (simplified, native select)\n */\nexport function Select(props: SelectProps) {\n  return (\n    <select\n      data-slot=\"select\"\n      class={cn(\n        \"flex h-9 w-full items-center justify-between rounded-md border border-input\",\n        \"bg-transparent px-3 py-2 text-sm shadow-xs\",\n        \"focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n        \"disabled:cursor-not-allowed disabled:opacity-50\",\n        props.class\n      )}\n      {...props}\n    />\n  );\n}\n\ninterface SelectOptionProps extends JSX.OptionHTMLAttributes<HTMLOptionElement> {}\n\nexport function SelectOption(props: SelectOptionProps) {\n  return <option {...props} />;\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 929, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "db0be077-d45a-4fe6-b833-2d79d1049c29": {"__data__": {"id_": "db0be077-d45a-4fe6-b833-2d79d1049c29", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Separator.tsx", "language": "typescript", "lines": 38, "filename": "Separator.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fb0a5321-3fc6-485c-97e9-20cd17c77874", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Separator.tsx", "language": "typescript", "lines": 38, "filename": "Separator.tsx"}, "hash": "f1defdf8a5d3ffa3a5027f4beb76ec406bd5f52893afa11b4d85aca78b00cce5", "class_name": "RelatedNodeInfo"}}, "text": "import type { JSX } from \"solid-js\";\nimport { cn } from \"../../utils/cn\";\n\ninterface SeparatorProps extends JSX.HTMLAttributes<HTMLDivElement> {\n  orientation?: \"horizontal\" | \"vertical\";\n  decorative?: boolean;\n}\n\n/**\n * Separator component for visual division\n * Migrated from React to SolidJS (Radix UI removed, native implementation)\n * \n * @example\n * ```tsx\n * <Separator />\n * <Separator orientation=\"vertical\" />\n * ```\n */\nexport function Separator(props: SeparatorProps) {\n  const orientation = () => props.orientation || \"horizontal\";\n  const decorative = () => props.decorative !== undefined ? props.decorative : true;\n\n  return (\n    <div\n      role={decorative() ? \"none\" : \"separator\"}\n      aria-orientation={!decorative() ? orientation() : undefined}\n      data-slot=\"separator\"\n      data-orientation={orientation()}\n      class={cn(\n        \"bg-border shrink-0\",\n        orientation() === \"horizontal\" ? \"h-px w-full\" : \"h-full w-px\",\n        props.class\n      )}\n      {...props}\n    />\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1013, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f1bc8e25-88ee-43d8-9095-840d9b78a467": {"__data__": {"id_": "f1bc8e25-88ee-43d8-9095-840d9b78a467", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Sheet.tsx", "language": "typescript", "lines": 75, "filename": "Sheet.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "27d35423-7646-440a-93bc-acca5d10dc3f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Sheet.tsx", "language": "typescript", "lines": 75, "filename": "Sheet.tsx"}, "hash": "a46417434bd559ffe45807859033beebc2e2faa7fae1132170633705cceeb153", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, type JSX, ParentComponent } from \"solid-js\";\nimport { Portal } from \"solid-js/web\";\nimport { cn } from \"../../utils/cn\";\n\ninterface SheetProps extends JSX.HTMLAttributes<HTMLDivElement> {\n  open?: boolean;\n  onOpenChange?: (open: boolean) => void;\n  side?: \"left\" | \"right\" | \"top\" | \"bottom\";\n}\n\n/**\n * Sheet component - side panel/drawer\n * Migrated from React to SolidJS (Radix UI removed, native implementation)\n */\nexport const Sheet: ParentComponent<SheetProps> = (props) => {\n  const [isOpen, setIsOpen] = createSignal(props.open || false);\n  const side = () => props.side || \"right\";\n  \n  const open = () => props.open !== undefined ? props.open : isOpen();\n  const setOpen = (value: boolean) => {\n    setIsOpen(value);\n    props.onOpenChange?.(value);\n  };\n\n  const sideClasses = () => {\n    switch (side()) {\n      case \"left\": return \"left-0 top-0 h-full w-3/4 max-w-sm\";\n      case \"right\": return \"right-0 top-0 h-full w-3/4 max-w-sm\";\n      case \"top\": return \"top-0 left-0 w-full h-3/4 max-h-sm\";\n      case \"bottom\": return \"bottom-0 left-0 w-full h-3/4 max-h-sm\";\n    }\n  };\n\n  return (\n    <>\n      {open() && (\n        <Portal>\n          <div\n            data-slot=\"sheet-overlay\"\n            class=\"fixed inset-0 z-50 bg-black/80\"\n            onClick={() => setOpen(false)}\n          />\n          <div\n            data-slot=\"sheet\"\n            class={cn(\n              \"fixed z-50 bg-background p-6 shadow-lg\",\n              sideClasses(),\n              props.class\n            )}\n            {...props}\n          >\n            {props.children}\n          </div>\n        </Portal>\n      )}\n    </>\n  );\n};\n\nexport const SheetHeader: ParentComponent<JSX.HTMLAttributes<HTMLDivElement>> = (props) => {\n  return (\n    <div data-slot=\"sheet-header\" class={cn(\"space-y-2\", props.class)} {...props}>\n      {props.children}\n    </div>\n  );\n};\n\nexport const SheetTitle: ParentComponent<JSX.HTMLAttributes<HTMLHeadingElement>> = (props) => {\n  return (\n    <h2 data-slot=\"sheet-title\" class={cn(\"text-lg font-semibold\", props.class)} {...props}>\n      {props.children}\n    </h2>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2119, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7b6ed93e-cc15-4f42-9d27-58dd5563f7d2": {"__data__": {"id_": "7b6ed93e-cc15-4f42-9d27-58dd5563f7d2", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Skeleton.test.tsx", "language": "typescript", "lines": 45, "filename": "Skeleton.test.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0ea4417c-ec04-4bbc-962b-16f385506760", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Skeleton.test.tsx", "language": "typescript", "lines": 45, "filename": "Skeleton.test.tsx"}, "hash": "291bebf3936fc33d3adbfec15bb96edfb38009a1d375ef6cbce78fd682a55597", "class_name": "RelatedNodeInfo"}}, "text": "import { render } from \"@solidjs/testing-library\";\nimport { describe, it, expect } from \"vitest\";\nimport { Skeleton } from \"./Skeleton\";\n\ndescribe(\"Skeleton\", () => {\n  it(\"renders with default classes\", () => {\n    const { container } = render(() => <Skeleton />);\n    const skeleton = container.querySelector('[data-slot=\"skeleton\"]');\n\n    expect(skeleton).not.toBeNull();\n    const className = skeleton?.className || \"\";\n    expect(className).toContain(\"bg-accent\");\n    expect(className).toContain(\"animate-pulse\");\n    expect(className).toContain(\"rounded-md\");\n  });\n\n  it(\"accepts custom class\", () => {\n    const { container } = render(() => <Skeleton class=\"custom-class w-full\" />);\n    const skeleton = container.querySelector('[data-slot=\"skeleton\"]');\n\n    expect(skeleton).not.toBeNull();\n    const className = skeleton?.className || \"\";\n    expect(className).toContain(\"custom-class\");\n    expect(className).toContain(\"w-full\");\n    expect(className).toContain(\"bg-accent\");\n  });\n\n  it(\"spreads additional props\", () => {\n    const { container } = render(() => (\n      <Skeleton data-testid=\"test-skeleton\" aria-label=\"Loading\" />\n    ));\n    const skeleton = container.querySelector('[data-testid=\"test-skeleton\"]');\n\n    expect(skeleton).not.toBeNull();\n    expect(skeleton?.getAttribute(\"aria-label\")).toBe(\"Loading\");\n  });\n\n  it(\"renders as a div element\", () => {\n    const { container } = render(() => <Skeleton />);\n    const skeleton = container.querySelector('[data-slot=\"skeleton\"]');\n\n    expect(skeleton?.tagName).toBe(\"DIV\");\n  });\n});", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1566, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "208baf1f-d45e-447f-805f-9e4d3a1bcb8a": {"__data__": {"id_": "208baf1f-d45e-447f-805f-9e4d3a1bcb8a", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Skeleton.tsx", "language": "typescript", "lines": 24, "filename": "Skeleton.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "50c08b3a-e30e-4aec-be63-0955f844961d", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Skeleton.tsx", "language": "typescript", "lines": 24, "filename": "Skeleton.tsx"}, "hash": "d2bb23a27f060eec2ef2225d680c540e6b7d43a9a94d7e2ccd1dd97e186fc4e0", "class_name": "RelatedNodeInfo"}}, "text": "import type { JSX } from \"solid-js\";\nimport { cn } from \"../../utils/cn\";\n\ninterface SkeletonProps extends JSX.HTMLAttributes<HTMLDivElement> {}\n\n/**\n * Skeleton component for loading states\n * Migrated from React to SolidJS\n * \n * @example\n * ```tsx\n * <Skeleton class=\"w-full h-20\" />\n * ```\n */\nexport function Skeleton(props: SkeletonProps) {\n  return (\n    <div\n      data-slot=\"skeleton\"\n      class={cn(\"bg-accent animate-pulse rounded-md\", props.class)}\n      {...props}\n    />\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 492, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "cd066c4b-2112-40c6-8c13-c1464aecc7a1": {"__data__": {"id_": "cd066c4b-2112-40c6-8c13-c1464aecc7a1", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\SkipLink.tsx", "language": "typescript", "lines": 17, "filename": "SkipLink.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "341107bd-c8af-4db9-8c15-1ac84d75d9c1", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\SkipLink.tsx", "language": "typescript", "lines": 17, "filename": "SkipLink.tsx"}, "hash": "8da1e068b8cf21f706e00b1745c4948ed2ac55435ccd55ca7656d402c00b22aa", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * SkipLink Component\n * Link de pular navega\u00e7\u00e3o para acessibilidade\n * Migrated from React to SolidJS (Next.js Link removed, native anchor)\n */\n\nexport function SkipLink() {\n  return (\n    <a\n      href=\"#main-content\"\n      class=\"sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-primary focus:text-primary-foreground focus:rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\"\n    >\n      Pular para o conte\u00fado principal\n    </a>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 528, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ccf183a0-2138-47b1-a86e-4b5c0412c869": {"__data__": {"id_": "ccf183a0-2138-47b1-a86e-4b5c0412c869", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Sonner.tsx", "language": "typescript", "lines": 73, "filename": "Sonner.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ba82f80f-2d9d-4ccc-ba84-b619721ddf53", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Sonner.tsx", "language": "typescript", "lines": 73, "filename": "Sonner.tsx"}, "hash": "e6076bab260537909c31884f12a043f474465a71478f51a2a72eb9035650c4ed", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, For, type JSX } from \"solid-js\";\nimport { Portal } from \"solid-js/web\";\nimport { cn } from \"../../utils/cn\";\n\ntype ToastType = \"default\" | \"success\" | \"error\" | \"warning\";\n\ninterface Toast {\n  id: string;\n  message: string;\n  type?: ToastType;\n  duration?: number;\n}\n\nconst [toasts, setToasts] = createSignal<Toast[]>([]);\n\n/**\n * Toast notification system (Sonner alternative)\n * Migrated from React to SolidJS (native implementation)\n */\nexport function toast(message: string, options?: { type?: ToastType; duration?: number }) {\n  const id = Math.random().toString(36).substr(2, 9);\n  const newToast: Toast = {\n    id,\n    message,\n    type: options?.type || \"default\",\n    duration: options?.duration || 3000,\n  };\n\n  setToasts((prev) => [...prev, newToast]);\n\n  setTimeout(() => {\n    setToasts((prev) => prev.filter((t) => t.id !== id));\n  }, newToast.duration);\n}\n\n/**\n * Toaster component - renders toast notifications\n */\nexport function Toaster() {\n  const getToastClasses = (type: ToastType) => {\n    const base = \"rounded-lg border p-4 shadow-lg\";\n    switch (type) {\n      case \"success\": return `${base} bg-green-50 border-green-200 text-green-900`;\n      case \"error\": return `${base} bg-red-50 border-red-200 text-red-900`;\n      case \"warning\": return `${base} bg-yellow-50 border-yellow-200 text-yellow-900`;\n      default: return `${base} bg-background border-border`;\n    }\n  };\n\n  return (\n    <Portal>\n      <div\n        data-slot=\"toaster\"\n        class=\"fixed bottom-4 right-4 z-50 flex flex-col gap-2 max-w-md\"\n      >\n        <For each={toasts()}>\n          {(t) => (\n            <div\n              data-slot=\"toast\"\n              class={cn(\n                getToastClasses(t.type || \"default\"),\n                \"animate-in slide-in-from-right\"\n              )}\n            >\n              {t.message}\n            </div>\n          )}\n        </For>\n      </div>\n    </Portal>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1931, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "16e002d8-5567-439c-86d8-be1b16a5041b": {"__data__": {"id_": "16e002d8-5567-439c-86d8-be1b16a5041b", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Table.tsx", "language": "typescript", "lines": 145, "filename": "Table.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "97ba2cc4-0258-41c3-9ebc-e445cc98c19f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Table.tsx", "language": "typescript", "lines": 145, "filename": "Table.tsx"}, "hash": "1064514ddd26cf8729bf7c4b42a351216bb9d1c3b9f3171bae22ed464210e97d", "class_name": "RelatedNodeInfo"}}, "text": "import type { JSX, ParentComponent } from \"solid-js\";\nimport { cn } from \"../../utils/cn\";\n\ninterface TableProps extends JSX.HTMLAttributes<HTMLTableElement> {}\n\n/**\n * Table component - table container with scroll\n * Migrated from React to SolidJS\n */\nexport const Table: ParentComponent<TableProps> = (props) => {\n  return (\n    <div\n      data-slot=\"table-container\"\n      class=\"relative w-full overflow-x-auto\"\n    >\n      <table\n        data-slot=\"table\"\n        class={cn(\"w-full caption-bottom text-sm\", props.class)}\n        {...props}\n      >\n        {props.children}\n      </table>\n    </div>\n  );\n};\n\n/**\n * TableHeader component - thead element\n */\nexport const TableHeader: ParentComponent<JSX.HTMLAttributes<HTMLTableSectionElement>> = (props) => {\n  return (\n    <thead\n      data-slot=\"table-header\"\n      class={cn(\"[&_tr]:border-b\", props.class)}\n      {...props}\n    >\n      {props.children}\n    </thead>\n  );\n};\n\n/**\n * TableBody component - tbody element\n */\nexport const TableBody: ParentComponent<JSX.HTMLAttributes<HTMLTableSectionElement>> = (props) => {\n  return (\n    <tbody\n      data-slot=\"table-body\"\n      class={cn(\"[&_tr:last-child]:border-0\", props.class)}\n      {...props}\n    >\n      {props.children}\n    </tbody>\n  );\n};\n\n/**\n * TableFooter component - tfoot element\n */\nexport const TableFooter: ParentComponent<JSX.HTMLAttributes<HTMLTableSectionElement>> = (props) => {\n  return (\n    <tfoot\n      data-slot=\"table-footer\"\n      class={cn(\n        \"bg-muted/50 border-t font-medium [&>tr]:last:border-b-0\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </tfoot>\n  );\n};\n\n/**\n * TableRow component - tr element\n */\nexport const TableRow: ParentComponent<JSX.HTMLAttributes<HTMLTableRowElement>> = (props) => {\n  return (\n    <tr\n      data-slot=\"table-row\"\n      class={cn(\n        \"hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </tr>\n  );\n};\n\n/**\n * TableHead component - th element\n */\nexport const TableHead: ParentComponent<JSX.ThHTMLAttributes<HTMLTableCellElement>> = (props) => {\n  return (\n    <th\n      data-slot=\"table-head\"\n      class={cn(\n        \"text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap\",\n        \"[&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </th>\n  );\n};\n\n/**\n * TableCell component - td element\n */\nexport const TableCell: ParentComponent<JSX.TdHTMLAttributes<HTMLTableCellElement>> = (props) => {\n  return (\n    <td\n      data-slot=\"table-cell\"\n      class={cn(\n        \"p-2 align-middle whitespace-nowrap\",\n        \"[&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </td>\n  );\n};\n\n/**\n * TableCaption component - caption element\n */\nexport const TableCaption: ParentComponent<JSX.HTMLAttributes<HTMLTableCaptionElement>> = (props) => {\n  return (\n    <caption\n      data-slot=\"table-caption\"\n      class={cn(\"text-muted-foreground mt-4 text-sm\", props.class)}\n      {...props}\n    >\n      {props.children}\n    </caption>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3273, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "af56d3db-9ad0-46c4-906d-17db0147f39b": {"__data__": {"id_": "af56d3db-9ad0-46c4-906d-17db0147f39b", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Tabs.tsx", "language": "typescript", "lines": 126, "filename": "Tabs.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "ab3eb9f0-efa5-46bf-8f05-c7550691d3fd", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Tabs.tsx", "language": "typescript", "lines": 126, "filename": "Tabs.tsx"}, "hash": "e04b80764565d133c998675da96bf049fcf2b9bb7ca450f3e2a2ec5aa73a22a6", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, type JSX, ParentComponent, createContext, useContext } from \"solid-js\";\nimport { cn } from \"../../utils/cn\";\n\n// Context para gerenciar estado das tabs\ntype TabsContextValue = {\n  value: () => string | undefined;\n  setValue: (value: string) => void;\n};\n\nconst TabsContext = createContext<TabsContextValue>();\n\ninterface TabsProps extends JSX.HTMLAttributes<HTMLDivElement> {\n  defaultValue?: string;\n  value?: string;\n  onValueChange?: (value: string) => void;\n}\n\n/**\n * Tabs component - container\n * Migrated from React to SolidJS (Radix UI removed, native implementation with createSignal)\n */\nexport const Tabs: ParentComponent<TabsProps> = (props) => {\n  const [internalValue, setInternalValue] = createSignal(props.defaultValue || props.value || \"\");\n  \n  const value = () => props.value !== undefined ? props.value : internalValue();\n  const setValue = (newValue: string) => {\n    setInternalValue(newValue);\n    props.onValueChange?.(newValue);\n  };\n\n  return (\n    <TabsContext.Provider value={{ value, setValue }}>\n      <div\n        data-slot=\"tabs\"\n        class={cn(\"flex flex-col gap-2\", props.class)}\n        {...props}\n      >\n        {props.children}\n      </div>\n    </TabsContext.Provider>\n  );\n};\n\n/**\n * TabsList component - tabs list container\n */\nexport const TabsList: ParentComponent<JSX.HTMLAttributes<HTMLDivElement>> = (props) => {\n  return (\n    <div\n      data-slot=\"tabs-list\"\n      role=\"tablist\"\n      class={cn(\n        \"bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]\",\n        props.class\n      )}\n      {...props}\n    >\n      {props.children}\n    </div>\n  );\n};\n\ninterface TabsTriggerProps extends JSX.ButtonHTMLAttributes<HTMLButtonElement> {\n  value: string;\n}\n\n/**\n * TabsTrigger component - individual tab button\n */\nexport function TabsTrigger(props: TabsTriggerProps) {\n  const context = useContext(TabsContext);\n  if (!context) throw new Error(\"TabsTrigger must be used within Tabs\");\n\n  const isActive = () => context.value() === props.value;\n\n  return (\n    <button\n      data-slot=\"tabs-trigger\"\n      data-state={isActive() ? \"active\" : \"inactive\"}\n      role=\"tab\"\n      aria-selected={isActive()}\n      onClick={() => context.setValue(props.value)}\n      class={cn(\n        \"data-[state=active]:bg-background dark:data-[state=active]:text-foreground\",\n        \"focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring\",\n        \"dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30\",\n        \"text-foreground dark:text-muted-foreground\",\n        \"inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5\",\n        \"rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap\",\n        \"transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1\",\n        \"disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm\",\n        \"[&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4\",\n        props.class\n      )}\n      {...props}\n    />\n  );\n}\n\ninterface TabsContentProps extends JSX.HTMLAttributes<HTMLDivElement> {\n  value: string;\n}\n\n/**\n * TabsContent component - tab panel content\n */\nexport const TabsContent: ParentComponent<TabsContentProps> = (props) => {\n  const context = useContext(TabsContext);\n  if (!context) throw new Error(\"TabsContent must be used within Tabs\");\n\n  const isActive = () => context.value() === props.value;\n\n  return (\n    <div\n      data-slot=\"tabs-content\"\n      data-state={isActive() ? \"active\" : \"inactive\"}\n      role=\"tabpanel\"\n      hidden={!isActive()}\n      class={cn(\"flex-1 outline-none\", props.class)}\n      {...props}\n    >\n      {isActive() && props.children}\n    </div>\n  );\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3803, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "74fad9d7-bdd0-4362-8b21-8e58b3422d1a": {"__data__": {"id_": "74fad9d7-bdd0-4362-8b21-8e58b3422d1a", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\utils\\a11y.ts", "language": "typescript", "lines": 76, "filename": "a11y.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6297b80b-1fb0-43d9-9cf7-3af223dff8f4", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\utils\\a11y.ts", "language": "typescript", "lines": 76, "filename": "a11y.ts"}, "hash": "8cea0e703df781ba43f155a309849dd3a4fa24ca16e22585982afa5389ca599e", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * Accessibility Utilities for SolidJS\n * Fun\u00e7\u00f5es utilit\u00e1rias para acessibilidade\n */\n\n/**\n * Gera um ID \u00fanico para elementos ARIA\n */\nexport function generateAriaId(prefix: string): string {\n  return `${prefix}-${Math.random().toString(36).substr(2, 9)}`;\n}\n\n/**\n * Anuncia mensagem para screen readers\n */\nexport function announceToScreenReader(\n  message: string,\n  priority: \"polite\" | \"assertive\" = \"polite\"\n) {\n  const announcement = document.createElement(\"div\");\n  announcement.setAttribute(\"role\", \"status\");\n  announcement.setAttribute(\"aria-live\", priority);\n  announcement.setAttribute(\"aria-atomic\", \"true\");\n  announcement.className = \"sr-only\";\n  announcement.textContent = message;\n\n  document.body.appendChild(announcement);\n\n  setTimeout(() => {\n    document.body.removeChild(announcement);\n  }, 1000);\n}\n\n/**\n * Verifica se um elemento est\u00e1 vis\u00edvel para screen readers\n */\nexport function isVisibleToScreenReader(element: HTMLElement): boolean {\n  return (\n    !element.hasAttribute(\"aria-hidden\") ||\n    element.getAttribute(\"aria-hidden\") === \"false\"\n  );\n}\n\n/**\n * Gerencia foco em modais/dialogs\n * Retorna fun\u00e7\u00e3o de cleanup para remover event listener\n */\nexport function trapFocus(container: HTMLElement) {\n  const focusableElements = container.querySelectorAll<HTMLElement>(\n    'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n  );\n\n  const firstElement = focusableElements[0];\n  const lastElement = focusableElements[focusableElements.length - 1];\n\n  const handleTabKey = (e: KeyboardEvent) => {\n    if (e.key !== \"Tab\") return;\n\n    if (e.shiftKey) {\n      if (document.activeElement === firstElement) {\n        lastElement.focus();\n        e.preventDefault();\n      }\n    } else {\n      if (document.activeElement === lastElement) {\n        firstElement.focus();\n        e.preventDefault();\n      }\n    }\n  };\n\n  container.addEventListener(\"keydown\", handleTabKey);\n\n  return () => container.removeEventListener(\"keydown\", handleTabKey);\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1999, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "afba74f4-1820-4741-b83b-24f2fdc06422": {"__data__": {"id_": "afba74f4-1820-4741-b83b-24f2fdc06422", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\utils\\cn.ts", "language": "typescript", "lines": 11, "filename": "cn.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bb0c7ee8-f9db-44d1-a277-0e29c17dc739", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\utils\\cn.ts", "language": "typescript", "lines": 11, "filename": "cn.ts"}, "hash": "d2c397f4f29844a865c78800f83bd699dd1f192233d25f503bd8fce9531374bd", "class_name": "RelatedNodeInfo"}}, "text": "import { clsx, type ClassValue } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\n\n/**\n * Combina classes CSS com suporte a Tailwind\n * \u00datil para mesclar classes condicionais\n */\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 264, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "757a7382-2542-48cb-8b6f-3f0ae8772f79": {"__data__": {"id_": "757a7382-2542-48cb-8b6f-3f0ae8772f79", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "d914370ff9990aeada6d0b60430e8f7b7602c4f92ff0a1edcafb01968c968d03", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "83a601a8-4d3e-47ef-8fa6-33eb6c426c04", "node_type": "1", "metadata": {}, "hash": "72ccdeb5102c6c6c4681045f6bb2216ff6dbdb45bc2a0e80f4cd60e35e287c34", "class_name": "RelatedNodeInfo"}}, "text": "import { Shield, Users, Database, Settings, RefreshCw, CheckCircle, AlertCircle, Plus, Edit, Trash2, X } from 'lucide-solid';\nimport { createSignal, Show, For, createResource, onMount } from 'solid-js';\nimport { adminApi, analyticsApi, UserData, CreateUserPayload, UpdateUserPayload } from '@/lib/api';\n\nexport default function Admin() {\n  const [syncing, setSyncing] = createSignal(false);\n  const [message, setMessage] = createSignal<{ type: 'success' | 'error', text: string } | null>(null);\n  const [activeTab, setActiveTab] = createSignal<'sync' | 'users'>('sync');\n\n  // User Management State\n  const [users, { refetch: refetchUsers }] = createResource<UserData[]>(async () => {\n    try {\n      const response = await adminApi.getUsers();\n      return response.data;\n    } catch (err) {\n      console.error('Error loading users:', err);\n      return [];\n    }\n  });\n\n  // Load Segment Options\n  const [filterOptions] = createResource(async () => {\n    try {\n      const response = await analyticsApi.getFilterOptions();\n      return response.data;\n    } catch (err) {\n      console.error('Error loading filter options:', err);\n      return { categorias: [], segmentos: [] };\n    }\n  });\n\n  const [showUserModal, setShowUserModal] = createSignal(false);\n  const [editingUser, setEditingUser] = createSignal<UserData | null>(null);\n  const [formData, setFormData] = createSignal<CreateUserPayload>({\n    username: '',\n    email: '',\n    password: '',\n    role: 'user',\n    allowed_segments: []\n  });\n\n  const handleSync = async () => {\n    setSyncing(true);\n    setMessage(null);\n    try {\n      await adminApi.syncParquet();\n      setMessage({ type: 'success', text: 'Sincroniza\u00e7\u00e3o iniciada em segundo plano!' });\n    } catch (err) {\n      setMessage({ type: 'error', text: 'Erro ao iniciar sincroniza\u00e7\u00e3o. Verifique logs.'", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1827, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "83a601a8-4d3e-47ef-8fa6-33eb6c426c04": {"__data__": {"id_": "83a601a8-4d3e-47ef-8fa6-33eb6c426c04", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "d914370ff9990aeada6d0b60430e8f7b7602c4f92ff0a1edcafb01968c968d03", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "757a7382-2542-48cb-8b6f-3f0ae8772f79", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "c4f299d96f989be490d184ea31dee57f9447e8139de82c971b043532d64c1182", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "26c2ae28-e046-4c83-9e6e-71dd20a0cc4a", "node_type": "1", "metadata": {}, "hash": "ce2d97df6f2d15d5af66c4fdec04da0f9b195576cba4b6645649504510091085", "class_name": "RelatedNodeInfo"}}, "text": "});\n    } catch (err) {\n      setMessage({ type: 'error', text: 'Erro ao iniciar sincroniza\u00e7\u00e3o. Verifique logs.' });\n    } finally {\n      setSyncing(false);\n      setTimeout(() => setMessage(null), 5000);\n    }\n  };\n\n  const openCreateUserModal = () => {\n    setEditingUser(null);\n    setFormData({ username: '', email: '', password: '', role: 'user', allowed_segments: [] });\n    setShowUserModal(true);\n  };\n\n  const openEditUserModal = (user: UserData) => {\n    setEditingUser(user);\n    setFormData({\n      username: user.username,\n      email: user.email,\n      password: '',\n      role: user.role,\n      allowed_segments: user.allowed_segments || []\n    });\n    setShowUserModal(true);\n  };\n\n  const closeUserModal = () => {\n    setShowUserModal(false);\n    setEditingUser(null);\n    setFormData({ username: '', email: '', password: '', role: 'user', allowed_segments: [] });\n  };\n\n  const handleSubmitUser = async (e: Event) => {\n    e.preventDefault();\n    setMessage(null);\n\n    try {\n      const data = formData();\n\n      if (editingUser()) {\n        // Update existing user\n        const updateData: UpdateUserPayload = {\n          username: data.username,\n          email: data.email,\n          role: data.role,\n          allowed_segments: data.allowed_segments\n        };\n\n        // Only include password if provided\n        if (data.password) {\n          updateData.password = data.password;\n        }\n\n        await adminApi.updateUser(editingUser()!.id, updateData);\n        setMessage({ type: 'success', text: `Usu\u00e1rio ${data.username} atualizado com sucesso!` });\n      } else {\n        // Create new user\n        await adminApi.createUser(data);\n        setMessage({ type: 'success', text: `Usu\u00e1rio ${data.username} criado com sucesso!` });\n      }\n\n      closeUserModal();\n      refetchUsers();\n      setTimeout(() => setMessage(null), 5000);\n    } catch (err: any) {\n      const errorMsg = err?.response?.data?.detail || 'Erro ao salvar usu\u00e1rio';\n      setMessage({ type: 'error', text: errorMsg });\n      setTimeout(() => setMessage(null), 5000);\n    }\n  };\n\n  const handleDeleteUser = async (user: UserData) => {\n    if (!confirm(`Tem certeza que deseja excluir o usu\u00e1rio ${user.username}?`)) {\n      return;\n    }\n\n    setMessage(null);\n    try {\n      await adminApi.deleteUser(user.id);\n      setMessage({ type: 'success', text: `Usu\u00e1rio ${user.username} exclu\u00eddo com sucesso!` });\n      refetchUsers();\n      setTimeout(() => setMessage(null), 5000);\n    } catch (err: any) {\n      const errorMsg = err?.response?.data?.detail || 'Erro ao excluir usu\u00e1rio';\n      setMessage({ type: 'error', text: errorMsg });\n      setTimeout(() => setMessage(null), 5000);\n    }\n  };\n\n  const handleToggleActive = async (user: UserData) => {\n    setMessage(null);\n    try {\n      await adminApi.updateUser(user.id, { is_active: !user.is_active });\n      setMessage({\n        type: 'success',\n        text: `Usu\u00e1rio ${user.username} ${!user.is_active ? 'ativado' : 'desativado'} com sucesso!`\n      });\n      refetchUsers();\n      setTimeout(() => setMessage(null), 5000);\n    } catch (err: any) {\n      const errorMsg = err?.response?.data?.detail || 'Erro ao atualizar status do usu\u00e1rio';\n      setMessage({ type: 'error', text: errorMsg });\n      setTimeout(() => setMessage(null), 5000);\n    }\n  };\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6\">\n      {/* Header */}\n      <div class=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\n        <div>\n          <h2 class=\"text-2xl font-bold tracking-tight\">\u00c1rea Administrativa</h2>\n          <p class=\"text-muted\">Gerenciamento do sistema e usu\u00e1rios</p>\n        </div>\n      </div>\n\n      {/* Message Alert */}\n      <Show when={message()}>\n        <div class={`p-3 rounded-lg flex items-center gap-2 text-sm ${\n          message()?.type === 'success' ? 'bg-green-500/10 text-green-400 border border-green-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20'\n        }`}>\n          {message()?.type === 'success' ?", "mimetype": "text/plain", "start_char_idx": 1715, "end_char_idx": 5747, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "26c2ae28-e046-4c83-9e6e-71dd20a0cc4a": {"__data__": {"id_": "26c2ae28-e046-4c83-9e6e-71dd20a0cc4a", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "d914370ff9990aeada6d0b60430e8f7b7602c4f92ff0a1edcafb01968c968d03", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "83a601a8-4d3e-47ef-8fa6-33eb6c426c04", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "be24be944d9197d9f70723f9e427986f514304a312d372826f79360fd6a6ada0", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "c4ae8c59-f484-4bca-9483-86be7b303477", "node_type": "1", "metadata": {}, "hash": "ba365c44f2ad16e25ed57fa4cc0379f9b98ed6f0fe7bddec9e23c24acf6df5f0", "class_name": "RelatedNodeInfo"}}, "text": "'bg-green-500/10 text-green-400 border border-green-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20'\n        }`}>\n          {message()?.type === 'success' ? <CheckCircle size={16} /> : <AlertCircle size={16} />}\n          {message()?.text}\n        </div>\n      </Show>\n\n      {/* Tabs */}\n      <div class=\"flex gap-2 border-b\">\n        <button\n          onClick={() => setActiveTab('sync')}\n          class={`px-4 py-2 font-medium transition-colors ${\n            activeTab() === 'sync' ? 'border-b-2 border-primary text-primary' : 'text-muted hover:text-foreground'\n          }`}\n        >\n          <div class=\"flex items-center gap-2\">\n            <RefreshCw size={16} />\n            Sincroniza\u00e7\u00e3o\n          </div>\n        </button>\n        <button\n          onClick={() => setActiveTab('users')}\n          class={`px-4 py-2 font-medium transition-colors ${\n            activeTab() === 'users' ? 'border-b-2 border-primary text-primary' : 'text-muted hover:text-foreground'\n          }`}\n        >\n          <div class=\"flex items-center gap-2\">\n            <Users size={16} />\n            Usu\u00e1rios\n          </div>\n        </button>\n      </div>\n\n      {/* Tab Content */}\n      <div class=\"flex-1 overflow-auto\">\n        <Show when={activeTab() === 'sync'}>\n          <div class=\"max-w-2xl mx-auto space-y-4\">\n            <div\n              onClick={!syncing() ? handleSync : undefined}\n              class={`p-6 border rounded-lg bg-card flex items-center gap-4 transition-all ${\n                syncing() ? 'opacity-70 cursor-wait' : 'hover:border-primary/50 cursor-pointer hover:bg-secondary/30'\n              }`}\n            >\n              <div class=\"p-3 bg-purple-500/10 text-purple-400 rounded-lg\">\n                <RefreshCw size={24} class={syncing() ?", "mimetype": "text/plain", "start_char_idx": 5576, "end_char_idx": 7359, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "c4ae8c59-f484-4bca-9483-86be7b303477": {"__data__": {"id_": "c4ae8c59-f484-4bca-9483-86be7b303477", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "d914370ff9990aeada6d0b60430e8f7b7602c4f92ff0a1edcafb01968c968d03", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "26c2ae28-e046-4c83-9e6e-71dd20a0cc4a", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "5dad4882a4ede37b4d2ee5f5faec2075eab3483e383422e4f9e6422c04fa38db", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "0994923f-450d-4876-aead-d5091de5c4fc", "node_type": "1", "metadata": {}, "hash": "f29bc14fffca60684b22016d6d97ba585b05f3b2e53a132bc069f59d7180f601", "class_name": "RelatedNodeInfo"}}, "text": "handleSync : undefined}\n              class={`p-6 border rounded-lg bg-card flex items-center gap-4 transition-all ${\n                syncing() ? 'opacity-70 cursor-wait' : 'hover:border-primary/50 cursor-pointer hover:bg-secondary/30'\n              }`}\n            >\n              <div class=\"p-3 bg-purple-500/10 text-purple-400 rounded-lg\">\n                <RefreshCw size={24} class={syncing() ? 'animate-spin' : ''} />\n              </div>\n              <div class=\"flex-1\">\n                <h4 class=\"font-semibold text-lg\">Sincronizar Dados</h4>\n                <p class=\"text-sm text-muted\">Atualizar Parquet via SQL Server</p>\n              </div>\n              {syncing() && <span class=\"text-sm text-primary animate-pulse\">Processando...</span>}\n            </div>\n          </div>\n        </Show>\n\n        <Show when={activeTab() === 'users'}>\n          <div class=\"space-y-4\">\n            {/* Header with Add Button */}\n            <div class=\"flex justify-between items-center\">\n              <h3 class=\"text-lg font-semibold\">Gerenciar Usu\u00e1rios</h3>\n              <button\n                onClick={openCreateUserModal}\n                class=\"btn btn-primary gap-2\"\n              >\n                <Plus size={16} />\n                Novo Usu\u00e1rio\n              </button>\n            </div>\n\n            {/* Users Table */}\n            <div class=\"border rounded-lg overflow-hidden bg-card\">\n              <table class=\"w-full\">\n                <thead class=\"bg-muted/50 border-b\">\n                  <tr>\n                    <th class=\"text-left p-3 text-sm font-medium\">Username</th>\n                    <th class=\"text-left p-3 text-sm font-medium\">Email</th>\n                    <th class=\"text-left p-3 text-sm font-medium\">Role</th>\n                    <th class=\"text-left p-3 text-sm font-medium\">Segmentos</th>\n                    <th class=\"text-center p-3 text-sm font-medium\">Status</th>\n                    <th class=\"text-right p-3 text-sm font-medium\">A\u00e7\u00f5es</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  <Show when={users.loading}>\n                    <tr>\n                      <td colspan=\"6\" class=\"text-center p-8 text-muted\">\n                        <RefreshCw size={24} class=\"animate-spin mx-auto mb-2\" />\n                        Carregando usu\u00e1rios...\n                      </td>\n                    </tr>\n                  </Show>\n\n                  <Show when={!users.loading && users()}>\n                    <For each={users()}>\n                      {(user) => (\n                        <tr class=\"border-b hover:bg-muted/30 transition-colors\">\n                          <td class=\"p-3\">{user.username}</td>\n                          <td class=\"p-3 text-sm text-muted\">{user.email}</td>\n                          <td class=\"p-3\">\n                            <span class={`px-2 py-1 rounded text-xs font-medium ${\n                              user.role === 'admin' ? 'bg-purple-500/10 text-purple-400' :\n                              user.role === 'user' ? 'bg-blue-500/10 text-blue-400' :\n                              'bg-gray-500/10 text-gray-400'\n                            }`}>\n                              {user.role}\n                            </span>\n                          </td>\n                          <td class=\"p-3 text-sm text-muted\">\n                            <Show when={user.role === 'admin'} fallback={\n                                user.allowed_segments && user.allowed_segments.length > 0 \n                                ? <span title={user.allowed_segments.join(', ')}>{user.allowed_segments.length} segmento(s)</span>\n                                : <span class=\"text-yellow-500 text-xs\">Nenhum</span>\n                            }>\n                                <span class=\"text-muted italic\">Todos (Admin)</span>\n                            </Show>\n                          </td>\n                          <td class=\"p-3 text-center\">\n                            <button\n                              onClick={() => handleToggleActive(user)}\n                              class={`px-2 py-1 rounded text-xs font-medium transition-colors ${\n                                user.is_active\n                                  ? 'bg-green-500/10 text-green-400 hover:bg-green-500/20'\n                                  : 'bg-red-500/10 text-red-400 hover:bg-red-500/20'\n                              }`}\n                            >\n                              {user.is_active ?", "mimetype": "text/plain", "start_char_idx": 6960, "end_char_idx": 11462, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0994923f-450d-4876-aead-d5091de5c4fc": {"__data__": {"id_": "0994923f-450d-4876-aead-d5091de5c4fc", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "d914370ff9990aeada6d0b60430e8f7b7602c4f92ff0a1edcafb01968c968d03", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "c4ae8c59-f484-4bca-9483-86be7b303477", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "4a2eedab38541d6ea6276e4e9d7f95e76248d0cc522a4d8dd6ef408c9d7874bc", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e6d19f77-9557-4fc0-af87-f9e582bfcac9", "node_type": "1", "metadata": {}, "hash": "47aa0dcabba9dc600ca86c6f90a328ddeb628b10151ed02a991de98f60add4c9", "class_name": "RelatedNodeInfo"}}, "text": "<span title={user.allowed_segments.join(', ')}>{user.allowed_segments.length} segmento(s)</span>\n                                : <span class=\"text-yellow-500 text-xs\">Nenhum</span>\n                            }>\n                                <span class=\"text-muted italic\">Todos (Admin)</span>\n                            </Show>\n                          </td>\n                          <td class=\"p-3 text-center\">\n                            <button\n                              onClick={() => handleToggleActive(user)}\n                              class={`px-2 py-1 rounded text-xs font-medium transition-colors ${\n                                user.is_active\n                                  ? 'bg-green-500/10 text-green-400 hover:bg-green-500/20'\n                                  : 'bg-red-500/10 text-red-400 hover:bg-red-500/20'\n                              }`}\n                            >\n                              {user.is_active ? 'Ativo' : 'Inativo'}\n                            </button>\n                          </td>\n                          <td class=\"p-3\">\n                            <div class=\"flex justify-end gap-2\">\n                              <button\n                                onClick={() => openEditUserModal(user)}\n                                class=\"p-2 hover:bg-secondary rounded transition-colors\"\n                                title=\"Editar\"\n                              >\n                                <Edit size={16} />\n                              </button>\n                              <button\n                                onClick={() => handleDeleteUser(user)}\n                                class=\"p-2 hover:bg-red-500/10 text-red-400 rounded transition-colors\"\n                                title=\"Excluir\"\n                              >\n                                <Trash2 size={16} />\n                              </button>\n                            </div>\n                          </td>\n                        </tr>\n                      )}\n                    </For>\n                  </Show>\n\n                  <Show when={!users.loading && (!users() || users()?.length === 0)}>\n                    <tr>\n                      <td colspan=\"6\" class=\"text-center p-8 text-muted\">\n                        Nenhum usu\u00e1rio encontrado\n                      </td>\n                    </tr>\n                  </Show>\n                </tbody>\n              </table>\n            </div>\n          </div>\n        </Show>\n      </div>\n\n      {/* User Modal */}\n      <Show when={showUserModal()}>\n        <div class=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\" onClick={closeUserModal}>\n          <div class=\"bg-card border rounded-lg max-w-md w-full p-6 space-y-4 max-h-[90vh] overflow-y-auto\" onClick={(e) => e.stopPropagation()}>\n            <div class=\"flex justify-between items-center\">\n              <h3 class=\"text-lg font-semibold\">\n                {editingUser() ?", "mimetype": "text/plain", "start_char_idx": 10502, "end_char_idx": 13484, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e6d19f77-9557-4fc0-af87-f9e582bfcac9": {"__data__": {"id_": "e6d19f77-9557-4fc0-af87-f9e582bfcac9", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "4ccfa527-961b-4559-b0e8-a3b5577e374c", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "d914370ff9990aeada6d0b60430e8f7b7602c4f92ff0a1edcafb01968c968d03", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "0994923f-450d-4876-aead-d5091de5c4fc", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}, "hash": "a0f80b7948aa03a6496c7190530d737aa86bcd85178e64c6deca9207b22ae50a", "class_name": "RelatedNodeInfo"}}, "text": "'Editar Usu\u00e1rio' : 'Novo Usu\u00e1rio'}\n              </h3>\n              <button onClick={closeUserModal} class=\"p-1 hover:bg-secondary rounded\">\n                <X size={20} />\n              </button>\n            </div>\n\n            <form onSubmit={handleSubmitUser} class=\"space-y-4\">\n              <div>\n                <label class=\"block text-sm font-medium mb-1\">Username</label>\n                <input\n                  type=\"text\"\n                  value={formData().username}\n                  onInput={(e) => setFormData({ ...formData(), username: e.currentTarget.value })}\n                  class=\"w-full px-3 py-2 bg-background border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary\"\n                  required\n                />\n              </div>\n\n              <div>\n                <label class=\"block text-sm font-medium mb-1\">Email</label>\n                <input\n                  type=\"email\"\n                  value={formData().email}\n                  onInput={(e) => setFormData({ ...formData(), email: e.currentTarget.value })}\n                  class=\"w-full px-3 py-2 bg-background border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary\"\n                  required\n                />\n              </div>\n\n              <div>\n                <label class=\"block text-sm font-medium mb-1\">\n                  Senha {editingUser() && '(deixe em branco para n\u00e3o alterar)'}\n                </label>\n                <input\n                  type=\"password\"\n                  value={formData().password}\n                  onInput={(e) => setFormData({ ...formData(), password: e.currentTarget.value })}\n                  class=\"w-full px-3 py-2 bg-background border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary\"\n                  required={!editingUser()}\n                  minLength={8}\n                />\n              </div>\n\n              <div>\n                <label class=\"block text-sm font-medium mb-1\">Role</label>\n                <select\n                  value={formData().role}\n                  onChange={(e) => setFormData({ ...formData(), role: e.currentTarget.value })}\n                  class=\"w-full px-3 py-2 bg-background border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary\"\n                  required\n                >\n                  <option value=\"viewer\">Viewer</option>\n                  <option value=\"user\">User</option>\n                  <option value=\"admin\">Admin</option>\n                </select>\n              </div>\n\n              {/* Segment Selection */}\n              <div class=\"space-y-2\">\n                <label class=\"block text-sm font-medium\">Segmentos Permitidos</label>\n                <div class=\"border rounded-lg p-3 max-h-48 overflow-y-auto space-y-2 bg-background\">\n                  <Show when={!filterOptions.loading} fallback={<span class=\"text-xs text-muted\">Carregando segmentos...</span>}>\n                    <For each={filterOptions()?.segmentos || []}>\n                      {(segment) => (\n                        <label class=\"flex items-center gap-2 text-sm cursor-pointer hover:bg-muted/50 p-1 rounded\">\n                          <input\n                            type=\"checkbox\"\n                            checked={formData().allowed_segments?.includes(segment)}\n                            onChange={(e) => {\n                              const current = formData().allowed_segments || [];\n                              if (e.currentTarget.checked) {\n                                setFormData({ ...formData(), allowed_segments: [...current, segment] });\n                              } else {\n                                setFormData({ ...formData(), allowed_segments: current.filter(s => s !== segment) });\n                              }\n                            }}\n                            class=\"checkbox checkbox-sm checkbox-primary\"\n                          />\n                          <span>{segment}</span>\n                        </label>\n                      )}\n                    </For>\n                    <Show when={!filterOptions()?.segmentos?.length}>\n                        <p class=\"text-xs text-muted\">Nenhum segmento dispon\u00edvel encontrado.</p>\n                    </Show>\n                  </Show>\n                </div>\n                <p class=\"text-xs text-muted\">\n                    {formData().role === 'admin' \n                        ? 'Admin tem acesso total independente desta sele\u00e7\u00e3o.' \n                        : 'Se nenhum selecionado, o usu\u00e1rio n\u00e3o ver\u00e1 dados.'}\n                </p>\n              </div>\n\n              <div class=\"flex gap-2 pt-4\">\n                <button type=\"button\" onClick={closeUserModal} class=\"flex-1 btn btn-outline\">\n                  Cancelar\n                </button>\n                <button type=\"submit\" class=\"flex-1 btn btn-primary\">\n                  {editingUser() ? 'Salvar' : 'Criar'}\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 13485, "end_char_idx": 18534, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6e3dbc47-bc3d-4695-80b7-552d4ae0ad86": {"__data__": {"id_": "6e3dbc47-bc3d-4695-80b7-552d4ae0ad86", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "788035dc-a6ee-45c6-82e8-2fe5edbc50d6", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "hash": "137f876fd807e9ffa7fe2e20032e001b668f563a1f207bf20879ba7d6b8f5eda", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "83c4d1a0-5c76-43dc-9ad6-2db8b3945e3c", "node_type": "1", "metadata": {}, "hash": "cbc95887c1b731d0ec4b427a62abf3d98b01445e0ca4378228910abf39c191dd", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, onMount, Show, createResource, For, createEffect } from 'solid-js';\nimport { BarChart3, TrendingUp, RefreshCw, Filter, X } from 'lucide-solid';\nimport api, { analyticsApi } from '../lib/api'; // Import analyticsApi\nimport { PlotlyChart } from '../components/PlotlyChart';\nimport { ChartDownloadButton } from '../components/ChartDownloadButton';\n\ninterface SalesAnalysis {\n  vendas_por_categoria: Array<{\n    categoria: string;\n    vendas: number;\n  }>;\n  giro_estoque: Array<{\n    produto: string;\n    nome: string;\n    giro: number;\n  }>;\n  distribuicao_abc: {\n    A: number;\n    B: number;\n    C: number;\n  };\n}\n\ninterface FilterOptions {\n  categorias: string[];\n  segmentos: string[];\n}\n\nexport default function Analytics() {\n  const [data, setData] = createSignal<SalesAnalysis | null>(null);\n  const [loading, setLoading] = createSignal(true);\n  const [error, setError] = createSignal<string | null>(null);\n\n  // Filtros\n  const [categoria, setCategoria] = createSignal('');\n  const [segmento, setSegmento] = createSignal('');\n\n  // Carregar op\u00e7\u00f5es de filtro (segmentos e todas as categorias)\n  const [allFilterOptions] = createResource<FilterOptions>(async () => {\n    const response = await analyticsApi.getFilterOptions(); // Use analyticsApi\n    return response.data;\n  });\n\n  // Carregar categorias filtradas por segmento\n  const [filteredCategoryOptions] = createResource(() => segmento(), async (segmento) => {\n    if (segmento === '') {\n      return allFilterOptions()?.categorias || [];\n    }\n    const response = await analyticsApi.getFilterOptions({ segmento: segmento });\n    return response.data.categorias;\n  });\n\n  // Efeito para resetar categoria quando o segmento muda\n  createEffect(() => {\n    // Apenas se o segmento realmente mudou e n\u00e3o \u00e9 a inicializa\u00e7\u00e3o\n    if (segmento() !== undefined) { \n      setCategoria('');\n    }\n  });\n\n\n  // Chart specs\n  const [vendasCategoriaChart, setVendasCategoriaChart] = createSignal<any>({});\n  const [giroEstoqueChart, setGiroEstoqueChart] = createSignal<any>({});\n  const [distribuicaoABCChart, setDistribuicaoABCChart] = createSignal<any>({});\n\n  const loadData = async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const params = new URLSearchParams();\n      if (categoria()) params.append('categoria', categoria());\n      if (segmento()) params.append('segmento', segmento());\n\n      const response = await api.get<SalesAnalysis>(`/analytics/sales-analysis?${params.toString()}`);\n      setData(response.data);\n\n      // Gerar gr\u00e1ficos\n      generateCharts(response.data);\n    } catch (err: any) {\n      console.error('Erro ao carregar an\u00e1lise:', err);\n      setError(err.response?.data?.detail || 'Erro ao carregar an\u00e1lise de vendas');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const generateCharts = (analysisData: SalesAnalysis) => {\n    // 1.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2870, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "83c4d1a0-5c76-43dc-9ad6-2db8b3945e3c": {"__data__": {"id_": "83c4d1a0-5c76-43dc-9ad6-2db8b3945e3c", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "788035dc-a6ee-45c6-82e8-2fe5edbc50d6", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "hash": "137f876fd807e9ffa7fe2e20032e001b668f563a1f207bf20879ba7d6b8f5eda", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "6e3dbc47-bc3d-4695-80b7-552d4ae0ad86", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "hash": "6b87b57d364c23b093e0e8cdfe796a49e24c86907c0275fe54eb92f2b3ed182b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "436628a7-2cef-48be-b8a5-0f595233da92", "node_type": "1", "metadata": {}, "hash": "b13b321659030f3610f49af48edc78d036f4c4db073b23da1d3fbe69b68e0e7e", "class_name": "RelatedNodeInfo"}}, "text": "Vendas por Categoria (Bar Chart)\n    if (analysisData.vendas_por_categoria.length > 0) {\n      const vendasSpec = {\n        data: [{\n          type: 'bar',\n          x: analysisData.vendas_por_categoria.map(c => c.categoria),\n          y: analysisData.vendas_por_categoria.map(c => c.vendas),\n          marker: {\n            color: '#3b82f6',\n            line: { color: '#1e40af', width: 1 }\n          },\n          text: analysisData.vendas_por_categoria.map(c => c.vendas.toLocaleString()),\n          textposition: 'outside',\n          hovertemplate: '<b>%{x}</b><br>Vendas: %{y:,}<extra></extra>'\n        }],\n        layout: {\n          title: {\n            text: 'Vendas por Categoria (Top 10)',\n            font: { size: 16, color: '#e5e7eb' }\n          },\n          xaxis: {\n            title: '',\n            tickangle: -45,\n            tickfont: { size: 10, color: '#9ca3af' },\n            gridcolor: '#374151'\n          },\n          yaxis: {\n            title: 'Vendas (30 dias)',\n            titlefont: { color: '#9ca3af' },\n            tickfont: { color: '#9ca3af' },\n            gridcolor: '#374151'\n          },\n          plot_bgcolor: '#1f2937',\n          paper_bgcolor: '#1f2937',\n          margin: { l: 60, r: 20, t: 60, b: 100 },\n          font: { color: '#e5e7eb' }\n        },\n        config: { responsive: true }\n      };\n      setVendasCategoriaChart(vendasSpec);\n    }\n\n    // 2. Giro de Estoque (Line Chart)\n    if (analysisData.giro_estoque.length > 0) {\n      const giroSpec = {\n        data: [{\n          type: 'scatter',\n          mode: 'lines+markers',\n          x: analysisData.giro_estoque.map((_, i) => i + 1),\n          y: analysisData.giro_estoque.map(p => p.giro),\n          text: analysisData.giro_estoque.map(p => p.nome),\n          marker: {\n            color: '#10b981',\n            size: 8\n          },\n          line: {\n            color: '#10b981',\n            width: 2\n          },\n          hovertemplate: '<b>%{text}</b><br>Giro: %{y:.2f}<extra></extra>'\n        }],\n        layout: {\n          title: {\n            text: 'Giro de Estoque (Top 15 Produtos)',\n            font: { size: 16, color: '#e5e7eb' }\n          },\n          xaxis: {\n            title: 'Ranking',\n            titlefont: { color: '#9ca3af' },\n            tickfont: { color: '#9ca3af' },\n            gridcolor: '#374151'\n          },\n          yaxis: {\n            title: 'Taxa de Giro',\n            titlefont: { color: '#9ca3af' },\n            tickfont: { color: '#9ca3af' },\n            gridcolor: '#374151'\n          },\n          plot_bgcolor: '#1f2937',\n          paper_bgcolor: '#1f2937',\n          margin: { l: 60, r: 20, t: 60, b: 60 },\n          font: { color: '#e5e7eb' }\n        },\n        config: { responsive: true }\n      };\n      setGiroEstoqueChart(giroSpec);\n    }\n\n    // 3.", "mimetype": "text/plain", "start_char_idx": 2871, "end_char_idx": 5675, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "436628a7-2cef-48be-b8a5-0f595233da92": {"__data__": {"id_": "436628a7-2cef-48be-b8a5-0f595233da92", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "788035dc-a6ee-45c6-82e8-2fe5edbc50d6", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "hash": "137f876fd807e9ffa7fe2e20032e001b668f563a1f207bf20879ba7d6b8f5eda", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "83c4d1a0-5c76-43dc-9ad6-2db8b3945e3c", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "hash": "391fc8fb35221dd2fee045545c4ec598f81b7b8b113849295fce939a5aa95c6e", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "566838e0-ae64-47ec-b414-3105ac4dd579", "node_type": "1", "metadata": {}, "hash": "9d18ba186690c50e10c5bb8bec11d7ee1f74d61f520682d44ba80fc21617abf1", "class_name": "RelatedNodeInfo"}}, "text": "Distribui\u00e7\u00e3o ABC (Pie Chart)\n    const abc = analysisData.distribuicao_abc;\n    if (abc.A + abc.B + abc.C > 0) {\n      const abcSpec = {\n        data: [{\n          type: 'pie',\n          labels: ['Classe A (20%)', 'Classe B (30%)', 'Classe C (50%)'],\n          values: [abc.A, abc.B, abc.C],\n          marker: {\n            colors: ['#10b981', '#f59e0b', '#ef4444']\n          },\n          textinfo: 'label+percent+value',\n          textposition: 'inside',\n          textfont: { size: 12 },\n          hovertemplate: '<b>%{label}</b><br>Produtos: %{value}<br>%{percent}<extra></extra>'\n        }],\n        layout: {\n          title: {\n            text: 'Distribui\u00e7\u00e3o ABC (Curva de Pareto)',\n            font: { size: 16, color: '#e5e7eb' }\n          },\n          plot_bgcolor: '#1f2937',\n          paper_bgcolor: '#1f2937',\n          margin: { l: 20, r: 20, t: 60, b: 20 },\n          font: { color: '#e5e7eb' },\n          showlegend: true,\n          legend: {\n            orientation: 'h',\n            x: 0.5,\n            y: -0.1,\n            xanchor: 'center',\n            font: { size: 10, color: '#9ca3af' }\n          }\n        },\n        config: { responsive: true }\n      };\n      setDistribuicaoABCChart(abcSpec);\n    }\n  };\n\n  onMount(() => {\n    loadData();\n  });\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6\">\n      {/* Header */}\n      <div class=\"flex justify-between items-end\">\n        <div>\n          <h2 class=\"text-2xl font-bold flex items-center gap-2\">\n            <BarChart3 size={28} />\n            Analytics Avan\u00e7ado\n          </h2>\n          <p class=\"text-muted\">An\u00e1lise de vendas, estoque e distribui\u00e7\u00e3o ABC</p>\n        </div>\n        <button\n          onClick={loadData}\n          class=\"btn btn-outline gap-2\"\n          disabled={loading()}\n        >\n          <RefreshCw size={16} class={loading() ? 'animate-spin' : ''} />\n          Atualizar\n        </button>\n      </div>\n\n      {/* Filters */}\n      <div class=\"card p-4 border\">\n        <div class=\"flex items-center gap-2 mb-3\">\n          <Filter size={20} />\n          <h3 class=\"font-semibold\">Filtros</h3>\n          <Show when={categoria() || segmento()}>\n            <button\n              class=\"ml-auto text-sm text-muted hover:text-foreground flex items-center gap-1\"\n              onClick={() => {\n                setCategoria('');\n                setSegmento('');\n                loadData();\n              }}\n            >\n              <X size={16} />\n              Limpar Filtros\n            </button>\n          </Show>\n        </div>\n\n        <div class=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\n          {/* Segmento */}\n          <select\n            class=\"input\"\n            value={segmento()}\n            onChange={(e) => setSegmento(e.currentTarget.value)}\n            disabled={allFilterOptions.loading}\n          >\n            <option value=\"\">Todos os Segmentos</option>\n            <Show when={allFilterOptions()}>\n              <For each={allFilterOptions()!.segmentos}>\n                {(seg) => <option value={seg}>{seg}</option>}\n              </For>\n            </Show>\n          </select>\n\n          {/* Categoria (filtro din\u00e2mico) */}\n          <select\n            class=\"input\"\n            value={categoria()}\n            onChange={(e) => setCategoria(e.currentTarget.value)}\n            disabled={filteredCategoryOptions.", "mimetype": "text/plain", "start_char_idx": 5676, "end_char_idx": 9021, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "566838e0-ae64-47ec-b414-3105ac4dd579": {"__data__": {"id_": "566838e0-ae64-47ec-b414-3105ac4dd579", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "788035dc-a6ee-45c6-82e8-2fe5edbc50d6", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "hash": "137f876fd807e9ffa7fe2e20032e001b668f563a1f207bf20879ba7d6b8f5eda", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "436628a7-2cef-48be-b8a5-0f595233da92", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "hash": "009fd74df2215e89ba7bc0c20d1a5ee81bf6331c9954bcad0d7f5bf97cdd5193", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "43255017-ff84-4d1e-bd3b-8d8b026a6e1f", "node_type": "1", "metadata": {}, "hash": "3781d5e0524817683d371d83d4e2938c77c78528a8aa68d857ea0ece34a06af1", "class_name": "RelatedNodeInfo"}}, "text": "currentTarget.value)}\n            disabled={allFilterOptions.loading}\n          >\n            <option value=\"\">Todos os Segmentos</option>\n            <Show when={allFilterOptions()}>\n              <For each={allFilterOptions()!.segmentos}>\n                {(seg) => <option value={seg}>{seg}</option>}\n              </For>\n            </Show>\n          </select>\n\n          {/* Categoria (filtro din\u00e2mico) */}\n          <select\n            class=\"input\"\n            value={categoria()}\n            onChange={(e) => setCategoria(e.currentTarget.value)}\n            disabled={filteredCategoryOptions.loading}\n          >\n            <option value=\"\">Todas as Categorias</option>\n            <Show when={filteredCategoryOptions()}>\n              <For each={filteredCategoryOptions()}>\n                {(cat) => <option value={cat}>{cat}</option>}\n              </For>\n            </Show>\n          </select>\n\n          <button\n            class=\"btn btn-primary\"\n            onClick={loadData}\n            disabled={loading()}\n          >\n            Aplicar Filtros\n          </button>\n        </div>\n\n        {/* Active Filters Display */}\n        <Show when={categoria() || segmento()}>\n          <div class=\"flex gap-2 mt-3 flex-wrap\">\n            <span class=\"text-sm text-muted\">Filtros ativos:</span>\n            <Show when={segmento()}>\n              <span class=\"px-2 py-1 bg-primary/20 text-primary rounded text-sm flex items-center gap-1\">\n                Segmento: {segmento()}\n                <button\n                  onClick={() => {\n                    setSegmento('');\n                    loadData();\n                  }}\n                  class=\"hover:bg-primary/30 rounded\"\n                >\n                  <X size={14} />\n                </button>\n              </span>\n            </Show>\n            <Show when={categoria()}>\n              <span class=\"px-2 py-1 bg-primary/20 text-primary rounded text-sm flex items-center gap-1\">\n                Categoria: {categoria()}\n                <button\n                  onClick={() => {\n                    setCategoria('');\n                    loadData();\n                  }}\n                  class=\"hover:bg-primary/30 rounded\"\n                >\n                  <X size={14} />\n                </button>\n              </span>\n            </Show>\n          </div>\n        </Show>\n      </div>\n\n      {/* Error State */}\n      <Show when={error()}>\n        <div class=\"card p-4 border-red-500 bg-red-500/10\">\n          <p class=\"text-red-500\">{error()}</p>\n        </div>\n      </Show>\n\n      {/* Loading State */}\n      <Show when={loading()}>\n        <div class=\"flex-1 flex items-center justify-center\">\n          <div class=\"text-center\">\n            <BarChart3 size={48} class=\"mx-auto mb-4 opacity-50 animate-pulse\" />\n            <p class=\"text-muted\">Carregando an\u00e1lise.</p>\n          </div>\n        </div>\n      </Show>\n\n      {/* Charts Grid */}\n      <Show when={!loading() && data()}>\n        <div class=\"space-y-6\">\n          {/* Row 1: Vendas por Categoria */}\n          <div class=\"card p-6 border\">\n            <div class=\"flex justify-between items-center mb-4\">\n              <h3 class=\"font-semibold\">Vendas por Categoria (Top 10)</h3>\n              <ChartDownloadButton\n                chartId=\"analytics-vendas-categoria-chart\"\n                filename=\"analytics_vendas_categoria\"\n                label=\"Baixar\"\n              />\n            </div>\n            <Show\n              when={data()!.vendas_por_categoria.length > 0}\n              fallback={\n                <div class=\"h-[400px] flex items-center justify-center text-muted\">\n                  <p>Nenhum dado de vendas por categoria dispon\u00edvel</p>\n                </div>\n              }\n            >\n              <PlotlyChart\n                chartSpec={vendasCategoriaChart}\n                chartId=\"analytics-vendas-categoria-chart\"\n                enableDownload={true}\n              />\n            </Show>\n          </div>\n\n          {/* Row 2: Two columns */}\n          <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            {/* Giro de Estoque */}\n            <div class=\"card p-6 border\">\n              <div class=\"flex justify-between items-center mb-4\">\n                <h3 class=\"font-semibold\">Giro de Estoque (Top 15)</h3>\n                <ChartDownloadButton\n                  chartId=\"analytics-giro-estoque-chart\"\n                  filename=\"analytics_giro_estoque\"\n                  label=\"Baixar\"\n                />\n              </div>\n              <Show\n                when={data()!.giro_estoque.", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "43255017-ff84-4d1e-bd3b-8d8b026a6e1f": {"__data__": {"id_": "43255017-ff84-4d1e-bd3b-8d8b026a6e1f", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "788035dc-a6ee-45c6-82e8-2fe5edbc50d6", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "hash": "137f876fd807e9ffa7fe2e20032e001b668f563a1f207bf20879ba7d6b8f5eda", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "566838e0-ae64-47ec-b414-3105ac4dd579", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}, "hash": "0094f2ae63bcaed09073d969d36820a141b343bf108c89893dcb299671ec38f5", "class_name": "RelatedNodeInfo"}}, "text": "giro_estoque.length > 0}\n                fallback={\n                  <div class=\"h-[400px] flex items-center justify-center text-muted\">\n                    <p>Nenhum dado de giro de estoque dispon\u00edvel</p>\n                  </div>\n                }\n              >\n                <PlotlyChart\n                  chartSpec={giroEstoqueChart}\n                  chartId=\"analytics-giro-estoque-chart\"\n                  enableDownload={true}\n                />\n              </Show>\n            </div>\n\n            {/* Distribui\u00e7\u00e3o ABC */}\n            <div class=\"card p-6 border\">\n              <div class=\"flex justify-between items-center mb-4\">\n                <h3 class=\"font-semibold\">Distribui\u00e7\u00e3o ABC (Curva de Pareto)</h3>\n                <ChartDownloadButton\n                  chartId=\"analytics-abc-chart\"\n                  filename=\"analytics_distribuicao_abc\"\n                  label=\"Baixar\"\n                />\n              </div>\n              <Show\n                when={(data()!.distribuicao_abc.A + data()!.distribuicao_abc.B + data()!.distribuicao_abc.C) > 0}\n                fallback={\n                  <div class=\"h-[400px] flex items-center justify-center text-muted\">\n                    <p>Nenhum dado de distribui\u00e7\u00e3o ABC dispon\u00edvel</p>\n                  </div>\n                }\n              >\n                <PlotlyChart\n                  chartSpec={distribuicaoABCChart}\n                  chartId=\"analytics-abc-chart\"\n                  enableDownload={true}\n                />\n              </Show>\n            </div>\n          </div>\n\n          {/* Info Box */}\n          <div class=\"card p-4 border bg-blue-500/5 border-blue-500/30\">\n            <div class=\"text-sm\">\n              <strong>\ud83d\udcca Sobre a Curva ABC:</strong> A classifica\u00e7\u00e3o ABC segue o princ\u00edpio de Pareto (80/20):\n              <ul class=\"list-disc list-inside mt-2 space-y-1 text-muted\">\n                <li><strong class=\"text-green-500\">Classe A (20%):</strong> Produtos de alto valor/rotatividade - prioridade m\u00e1xima</li>\n                <li><strong class=\"text-yellow-500\">Classe B (30%):</strong> Produtos de valor/rotatividade m\u00e9dia</li>\n                <li><strong class=\"text-red-500\">Classe C (50%):</strong> Produtos de baixo valor/rotatividade</li>\n              </ul>\n            </div>\n          </div>\n        </div>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 12992, "end_char_idx": 15348, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "04691b0e-e1a9-4789-baab-4c97a3618090": {"__data__": {"id_": "04691b0e-e1a9-4789-baab-4c97a3618090", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "423196ffdf4517053147430779674246d94e4000a84aa879daa0633581beb9a5", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e669d4f6-e189-4ed7-9957-f6bc4ce0c28a", "node_type": "1", "metadata": {}, "hash": "d9914dca0a77f8c60f8281f7438829a1fdd92cd8c73454bcf46e0a43b7e18416", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, createEffect, onCleanup, onMount, For, Show } from 'solid-js';\nimport auth from '@/store/auth';\nimport { Typewriter, TypingIndicator } from '@/components';\nimport { PlotlyChart } from '@/components/PlotlyChart';\nimport { DataTable } from '@/components/DataTable';\nimport { FeedbackButtons } from '@/components/FeedbackButtons';\nimport { DownloadButton } from '@/components/DownloadButton';\nimport { MessageActions } from '@/components/MessageActions';\nimport { ExportMenu } from '@/components/ExportMenu';\nimport { ShareButton } from '@/components/ShareButton';\nimport { formatTimestamp } from '@/lib/formatters';\nimport { marked } from 'marked'; // Renderizador de Markdown\nimport { Trash2, StopCircle, Pencil, Check, X } from 'lucide-solid';\nimport 'github-markdown-css/github-markdown.css';\nimport './chat-markdown.css';\n\n// Configurar marked para renderizar tabelas corretamente\nmarked.setOptions({\n  gfm: true, // GitHub Flavored Markdown (suporta tabelas)\n  breaks: true, // Quebras de linha autom\u00e1ticas\n});\n\n// Helper para renderizar Markdown\nconst renderMarkdown = (text: string): string => {\n  try {\n    return marked.parse(text) as string;\n  } catch (e) {\n    console.error('Erro ao renderizar Markdown:', e);\n    return text;\n  }\n};\n\n// Interface para mensagem - Atualizada para suportar estrutura JSON do backend\ninterface Message {\n  id: string;\n  role: 'user' | 'assistant' | 'system';\n  text: string;\n  timestamp: number;\n  type?: 'text' | 'chart' | 'table' | 'final' | 'error'; // Tipo da resposta do assistente\n  chart_spec?: any; // Especifica\u00e7\u00e3o JSON do Plotly\n  data?: any[]; // Dados tabulares\n  response_id?: string; // ID da resposta para feedback\n}\n\nexport default function Chat() {\n  const [messages, setMessages] = createSignal<Message[]>([\n    { id: '0', role: 'assistant', text: 'Ol\u00e1! Sou seu assistente de BI. Pergunte sobre vendas, produtos ou estoque.', timestamp: Date.now(), type: 'text', response_id: 'initial_greeting' }\n  ]);\n  const [input, setInput] = createSignal('');\n  const [isStreaming, setIsStreaming] = createSignal(false);\n  const [isWaitingForResponse, setIsWaitingForResponse] = createSignal(false);\n  const [sessionId, setSessionId] = createSignal<string>('');\n  const [currentEventSource, setCurrentEventSource] = createSignal<EventSource | null>(null);\n  const [lastUserMessage, setLastUserMessage] = createSignal<string>('');\n  const [editingMessageId, setEditingMessageId] = createSignal<string | null>(null);\n  const [editText, setEditText] = createSignal('');\n  let messagesEndRef: HTMLDivElement | undefined;\n\n  // Check for example query from Examples page & Init Session\n  onMount(async () => {\n    // 1. Initialize Session First\n    let storedSession = localStorage.getItem('chat_session_id');\n    if (!storedSession) {\n      storedSession = crypto.randomUUID();\n      localStorage.setItem('chat_session_id', storedSession);\n    }\n    setSessionId(storedSession);\n\n    // 2.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2956, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e669d4f6-e189-4ed7-9957-f6bc4ce0c28a": {"__data__": {"id_": "e669d4f6-e189-4ed7-9957-f6bc4ce0c28a", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "423196ffdf4517053147430779674246d94e4000a84aa879daa0633581beb9a5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "04691b0e-e1a9-4789-baab-4c97a3618090", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "db2939929bd66c9ef07ba35a11d4ab8462a92c2b405b3585aa6c28d8d1e80332", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b89f6108-84ca-4704-957e-b985267149f6", "node_type": "1", "metadata": {}, "hash": "24c886c6d7e66d7812d1885763f04f7588228729cf4f54a3248118f01c956fff", "class_name": "RelatedNodeInfo"}}, "text": "Initialize Session First\n    let storedSession = localStorage.getItem('chat_session_id');\n    if (!storedSession) {\n      storedSession = crypto.randomUUID();\n      localStorage.setItem('chat_session_id', storedSession);\n    }\n    setSessionId(storedSession);\n\n    // 2. Check for Example Query\n    const exampleQuery = localStorage.getItem('example_query');\n    if (exampleQuery) {\n      localStorage.removeItem('example_query');\n\n      // Directly add the user message to the chat\n      const userMsg: Message = { id: Date.now().toString(), role: 'user', text: exampleQuery, timestamp: Date.now() };\n      setMessages(prev => [...prev, userMsg]);\n\n      // And immediately process it\n      await processUserMessage(exampleQuery);\n    }\n  });\n\n  // Auto-scroll - melhorado para garantir que sempre role at\u00e9 o final\n  createEffect(() => {\n    messages(); // Re-run effect when messages change\n\n    // Usar setTimeout para garantir que o DOM foi atualizado\n    setTimeout(() => {\n      if (messagesEndRef) {\n        messagesEndRef.scrollIntoView({ behavior: 'smooth', block: 'end' });\n      }\n    }, 100);\n  });\n\n  // Cleanup on unmount\n  onCleanup(() => {\n    const es = currentEventSource();\n    if (es) {\n      es.close();\n    }\n  });\n\n  const stopGeneration = () => {\n    const es = currentEventSource();\n    if (es) {\n      console.log('\u23f9\ufe0f Stopping generation...');\n      es.close();\n      setCurrentEventSource(null);\n      setIsStreaming(false);\n\n      // Add stop message to last assistant message\n      setMessages(prev => {\n        const lastMsg = prev[prev.length - 1];\n        if (lastMsg && lastMsg.role === 'assistant') {\n          return prev.slice(0, -1).concat({\n            ...lastMsg,\n            text: lastMsg.text + '\\n\\n_[Gera\u00e7\u00e3o interrompida pelo usu\u00e1rio]_'\n          });\n        }\n        return prev;\n      });\n    }\n  };\n\n  const clearConversation = () => {\n    if (confirm('Tem certeza que deseja limpar toda a conversa?')) {\n      // Clear messages\n      setMessages([\n        { id: '0', role: 'assistant', text: 'Ol\u00e1! Sou seu assistente de BI. Pergunte sobre vendas, produtos ou estoque.', timestamp: Date.now(), type: 'text', response_id: 'initial_greeting' }\n      ]);\n\n      // Create new session\n      const newSession = crypto.randomUUID();\n      setSessionId(newSession);\n      localStorage.setItem('chat_session_id', newSession);\n\n      console.log('\ud83d\uddd1\ufe0f Conversation cleared, new session:', newSession);\n    }\n  };\n\n  const regenerateLastResponse = () => {\n    const lastMsg = lastUserMessage();\n    if (!lastMsg) {\n      console.warn('No last user message to regenerate');\n      return;\n    }\n\n    // Remove last assistant message(s) if any\n    setMessages(prev => {\n      const userMessages = prev.filter(m => m.role === 'user');\n      const lastUserMsg = userMessages[userMessages.length - 1];\n      const lastUserIndex = prev.findIndex(m => m === lastUserMsg);\n\n      // Keep everything up to and including the last user message\n      return prev.slice(0, lastUserIndex + 1);\n    });\n\n    // Resend the last user message\n    console.log('\ud83d\udd04 Regenerating response for:', lastMsg);\n    processUserMessage(lastMsg);\n  };\n\n  const startEditMessage = (messageId: string, currentText: string) => {\n    setEditingMessageId(messageId);\n    setEditText(currentText);\n  };\n\n  const cancelEditMessage = () => {\n    setEditingMessageId(null);\n    setEditText('');\n  };\n\n  const saveEditedMessage = async (messageId: string) => {\n    const newText = editText().trim();\n    if (!newText) return;\n\n    // Find message index\n    const msgIndex = messages().findIndex(m => m.id === messageId);\n    if (msgIndex === -1) return;\n\n    // Update message text\n    setMessages(prev => prev.map(m =>\n      m.id === messageId ?", "mimetype": "text/plain", "start_char_idx": 2686, "end_char_idx": 6425, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b89f6108-84ca-4704-957e-b985267149f6": {"__data__": {"id_": "b89f6108-84ca-4704-957e-b985267149f6", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "423196ffdf4517053147430779674246d94e4000a84aa879daa0633581beb9a5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "e669d4f6-e189-4ed7-9957-f6bc4ce0c28a", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "27df62fc2eb38692c3fb657b5c7b6d8c37b04f14089954e8c46dac51a1f4f153", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "74f2c2bc-4330-4a28-97b4-15792d043452", "node_type": "1", "metadata": {}, "hash": "60803f6e2c87dd2c016ff48c7d2f50d65fc4907faceab970dd20acd252d46e8c", "class_name": "RelatedNodeInfo"}}, "text": "{ ...m, text: newText } : m\n    ));\n\n    // Remove all messages after this one\n    setMessages(prev => prev.slice(0, msgIndex + 1));\n\n    // Update last user message\n    setLastUserMessage(newText);\n\n    // Clear edit mode\n    setEditingMessageId(null);\n    setEditText('');\n\n    // Reprocess with edited message\n    console.log('\u270f\ufe0f Message edited, reprocessing:', newText);\n    await processUserMessage(newText);\n  };\n\n  const processUserMessage = async (userText: string) => {\n    // Validar autentica\u00e7\u00e3o\n    const token = auth.token();\n    if (!token) {\n      console.error('\u274c Token n\u00e3o encontrado');\n      const errorMsg: Message = {\n        id: Date.now().toString(),\n        role: 'assistant',\n        text: '[Erro: Voc\u00ea n\u00e3o est\u00e1 autenticado. Por favor, fa\u00e7a login novamente.]',\n        timestamp: Date.now(),\n        type: 'error'\n      };\n      setMessages(prev => [...prev, errorMsg]);\n      return;\n    }\n\n    setIsStreaming(true);\n    setIsWaitingForResponse(true);\n\n    // Prepara mensagem do assistente - agora com suporte a tipos e dados\n    const assistantId = (Date.now() + 1).toString();\n    const newMessage: Message = { id: assistantId, role: 'assistant', text: '', timestamp: Date.now(), type: 'text' };\n    setMessages(prev => [...prev, newMessage]);\n\n    try {\n      // Conex\u00e3o SSE Real com Backend\n      console.log('\ud83d\udce1 Iniciando SSE com token:', token.substring(0, 20) + '...', 'Session:', sessionId());\n      const eventSource = new EventSource(`/api/v1/chat/stream?q=${encodeURIComponent(userText)}&token=${encodeURIComponent(token)}&session_id=${sessionId()}`);\n      setCurrentEventSource(eventSource);\n\n      let fullResponseContent = ''; // Para acumular texto e gerar response_id\n      let currentMessageId = assistantId;\n\n      eventSource.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n\n          // Desativa o indicador assim que receber qualquer dado\n          if (isWaitingForResponse()) {\n            setIsWaitingForResponse(false);\n          }\n\n          if (data.done) {\n            console.log('\u2705 Stream conclu\u00eddo');\n            eventSource.close();\n            setCurrentEventSource(null);\n            setIsStreaming(false);\n            setIsWaitingForResponse(false);\n            // Finaliza a mensagem do assistente, adicionando o response_id\n            setMessages(prev => prev.map(msg =>\n              msg.id === currentMessageId ? { ...msg, response_id: fullResponseContent ?", "mimetype": "text/plain", "start_char_idx": 6426, "end_char_idx": 8886, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "74f2c2bc-4330-4a28-97b4-15792d043452": {"__data__": {"id_": "74f2c2bc-4330-4a28-97b4-15792d043452", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "423196ffdf4517053147430779674246d94e4000a84aa879daa0633581beb9a5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b89f6108-84ca-4704-957e-b985267149f6", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "7034689172f5a96ddaa9521a5901010f54df51245fee82c1edf63a8f4f1cf3b8", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "14244dcc-ebda-4ad6-b0e7-a09f90d1c9be", "node_type": "1", "metadata": {}, "hash": "bb4f0485f1783e856ce3701d129ab2bb501783e87db52058c598045a962a138e", "class_name": "RelatedNodeInfo"}}, "text": "{ ...msg, response_id: fullResponseContent ? btoa(fullResponseContent).substring(0, 16) : undefined } : msg\n            ));\n            return;\n          }\n\n          if (data.type === 'text') {\n            setMessages(prev => prev.map(msg => {\n              if (msg.id === currentMessageId) {\n                const newText = msg.text + data.text;\n                fullResponseContent = newText;\n                return { ...msg, text: newText, type: 'text' };\n              }\n              return msg;\n            }));\n          } else if (data.type === 'chart' && data.chart_spec) {\n            // Adiciona um novo bloco de mensagem para o gr\u00e1fico\n            const chartMsgId = (Date.now() + 2).toString();\n            setMessages(prev => [...prev, {\n              id: chartMsgId,\n              role: 'assistant',\n              text: 'Aqui est\u00e1 o gr\u00e1fico que voc\u00ea pediu:',\n              timestamp: Date.now(),\n              type: 'chart',\n              chart_spec: data.chart_spec,\n              response_id: btoa(JSON.stringify(data.chart_spec)).substring(0, 16) // ID baseado no spec do gr\u00e1fico\n            }]);\n            currentMessageId = chartMsgId; // O feedback ser\u00e1 para este novo elemento\n          } else if (data.type === 'table' && data.data) {\n            // Adiciona um novo bloco de mensagem para a tabela\n            const tableMsgId = (Date.now() + 3).toString();\n            setMessages(prev => [...prev, {\n              id: tableMsgId,\n              role: 'assistant',\n              text: 'Aqui est\u00e3o os dados tabulares:',\n              timestamp: Date.now(),\n              type: 'table',\n              data: data.data,\n              response_id: btoa(JSON.stringify(data.data)).substring(0, 16) // ID baseado nos dados\n            }]);\n            currentMessageId = tableMsgId; // O feedback ser\u00e1 para este novo elemento\n          }\n          else if (data.type === 'final' && data.text) {\n            // Tratamento para mensagem final, se houver\n            setMessages(prev => prev.map(msg =>\n              msg.id === currentMessageId ? { ...msg, text: msg.text + data.text, type: 'text' } : msg\n            ));\n          }\n\n          if (data.error) {\n            console.error('\u274c Erro do servidor:', data.error);\n            setMessages(prev => prev.map(msg =>\n              msg.id === currentMessageId ? { ...msg, text: msg.text + \"\\n[Erro: \" + (data.details ? JSON.stringify(data.details) : data.error) + \"]\", type: 'error' } : msg\n            ));\n            eventSource.close();\n            setCurrentEventSource(null);\n            setIsStreaming(false);\n            setIsWaitingForResponse(false);\n          }\n\n        } catch (err) {\n          console.error(\"\u274c SSE Parse Error\", err);\n        }\n      };\n\n      eventSource.onerror = (err) => {\n        console.error(\"\u274c EventSource failed:\", err);\n        eventSource.close();\n        setCurrentEventSource(null);\n        setIsStreaming(false);\n        setIsWaitingForResponse(false);\n        setMessages(prev => prev.map(msg =>\n          msg.id === currentMessageId ? { ...msg, text: msg.text + \"\\n\u26a0\ufe0f Erro de conex\u00e3o com o servidor.\", type: 'error' } : msg\n        ));\n      };\n\n    } catch (err) {\n      console.error(\"\u274c Chat error:\", err);\n      setIsStreaming(false);\n      setIsWaitingForResponse(false);\n      setMessages(prev => prev.map(msg =>\n        msg.id === assistantId ? { ...msg, text: \"\\n\u274c Erro ao processar mensagem.\", type: 'error' } : msg\n      ));\n    }\n  };\n\n  const sendMessage = async (e: Event) => {\n    e.preventDefault();\n    if (!input() || isStreaming()) return;\n\n    const userText = input();\n    setInput('');\n    setLastUserMessage(userText);\n\n    // Adiciona mensagem do usu\u00e1rio\n    const userMsg: Message = { id: Date.now().toString(), role: 'user', text: userText, timestamp: Date.now() };\n    setMessages(prev => [...prev, userMsg]);\n\n    // Process message\n    await processUserMessage(userText);\n  };\n\n  const handleFeedback = async (messageId: string, feedbackType: 'positive' | 'negative' | 'partial', comment?: string) => {\n    const token = auth.token();\n    if (!token) {\n      console.error('\u274c Token n\u00e3o encontrado para feedback.');\n      alert('Voc\u00ea n\u00e3o est\u00e1 autenticado para enviar feedback.", "mimetype": "text/plain", "start_char_idx": 8842, "end_char_idx": 13061, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "14244dcc-ebda-4ad6-b0e7-a09f90d1c9be": {"__data__": {"id_": "14244dcc-ebda-4ad6-b0e7-a09f90d1c9be", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "423196ffdf4517053147430779674246d94e4000a84aa879daa0633581beb9a5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "74f2c2bc-4330-4a28-97b4-15792d043452", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "161900dfec4f11762252b1788279d05c02231e4c3daf44fb3772ae285f5b5afd", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3751deb0-9218-4bba-98fd-8e351554e362", "node_type": "1", "metadata": {}, "hash": "ae40a8dcb8639347e71d5d46979edb841503ab61fb223f83efef5ed1c08c12ae", "class_name": "RelatedNodeInfo"}}, "text": "\", type: 'error' } : msg\n      ));\n    }\n  };\n\n  const sendMessage = async (e: Event) => {\n    e.preventDefault();\n    if (!input() || isStreaming()) return;\n\n    const userText = input();\n    setInput('');\n    setLastUserMessage(userText);\n\n    // Adiciona mensagem do usu\u00e1rio\n    const userMsg: Message = { id: Date.now().toString(), role: 'user', text: userText, timestamp: Date.now() };\n    setMessages(prev => [...prev, userMsg]);\n\n    // Process message\n    await processUserMessage(userText);\n  };\n\n  const handleFeedback = async (messageId: string, feedbackType: 'positive' | 'negative' | 'partial', comment?: string) => {\n    const token = auth.token();\n    if (!token) {\n      console.error('\u274c Token n\u00e3o encontrado para feedback.');\n      alert('Voc\u00ea n\u00e3o est\u00e1 autenticado para enviar feedback.');\n      return;\n    }\n\n    try {\n      const response = await fetch('/api/v1/chat/feedback', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`\n        },\n        body: JSON.stringify({\n          response_id: messageId,\n          feedback_type: feedbackType,\n          comment: comment\n        })\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n\n      console.log(`Feedback ${feedbackType} enviado para ${messageId}`);\n    } catch (error) {\n      console.error('Erro ao enviar feedback:', error);\n      alert('Erro ao enviar feedback.');\n    }\n  };\n\n\n  return (\n    <div class=\"absolute inset-0 flex flex-col w-full max-w-4xl mx-auto bg-background\">\n      {/* Header with actions */}\n      <div class=\"flex items-center justify-between p-4 border-b bg-background/50 backdrop-blur\">\n        <h2 class=\"text-lg font-semibold\">Chat BI</h2>\n        <div class=\"flex items-center gap-2\">\n          <Show when={isStreaming()}>\n            <button\n              onClick={stopGeneration}\n              class=\"flex items-center gap-2 px-3 py-2 text-sm rounded-lg bg-red-500 hover:bg-red-600 text-white transition-colors\"\n              title=\"Parar gera\u00e7\u00e3o\"\n            >\n              <StopCircle size={16} />\n              <span>Parar</span>\n            </button>\n          </Show>\n          <ShareButton messages={messages} sessionId={sessionId()} />\n          <ExportMenu messages={messages} sessionId={sessionId()} />\n          <button\n            onClick={clearConversation}\n            class=\"flex items-center gap-2 px-3 py-2 text-sm rounded-lg border hover:bg-muted transition-colors\"\n            title=\"Limpar conversa\"\n          >\n            <Trash2 size={16} />\n            <span>Limpar</span>\n          </button>\n        </div>\n      </div>\n\n      <div class=\"flex-1 overflow-y-auto p-6 space-y-6\">\n        <For each={messages()}>\n          {(msg, index) => (\n            <div class={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>\n              <div\n                class={`max-w-[80%] rounded-lg p-4 text-sm leading-relaxed shadow-sm ${msg.role === 'user'\n                  ? 'bg-primary/10 border border-primary/20 text-foreground'\n                  : 'bg-card border text-card-foreground'\n                  }`}\n              >\n                <Show when={msg.role === 'assistant' && msg.type === 'chart' && msg.chart_spec}>\n                  <PlotlyChart chartSpec={() => msg.chart_spec} />\n                </Show>\n                <Show when={msg.role === 'assistant' && msg.type === 'table' && msg.data}>\n                  <DataTable data={() => msg.data} caption={msg.text} />\n                </Show>\n                <Show when={msg.role === 'assistant' && msg.type === 'text'}>\n                  <Show\n                    when={isWaitingForResponse() && msg.id === messages()[messages().length - 1].id}\n                    fallback={\n                      <div\n                        class=\"markdown-body\"\n                        innerHTML={renderMarkdown(msg.text + (isStreaming() && msg.id === messages()[messages().length - 1].id ? '", "mimetype": "text/plain", "start_char_idx": 12258, "end_char_idx": 16278, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3751deb0-9218-4bba-98fd-8e351554e362": {"__data__": {"id_": "3751deb0-9218-4bba-98fd-8e351554e362", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d86ce7b4-3ebe-4523-a400-7d76bcf3345b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "423196ffdf4517053147430779674246d94e4000a84aa879daa0633581beb9a5", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "14244dcc-ebda-4ad6-b0e7-a09f90d1c9be", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}, "hash": "eeb068a7cabe0036ebd7b180d70ac979ca49f949107ef0bd8cc9167791db3ce1", "class_name": "RelatedNodeInfo"}}, "text": "'bg-primary/10 border border-primary/20 text-foreground'\n                  : 'bg-card border text-card-foreground'\n                  }`}\n              >\n                <Show when={msg.role === 'assistant' && msg.type === 'chart' && msg.chart_spec}>\n                  <PlotlyChart chartSpec={() => msg.chart_spec} />\n                </Show>\n                <Show when={msg.role === 'assistant' && msg.type === 'table' && msg.data}>\n                  <DataTable data={() => msg.data} caption={msg.text} />\n                </Show>\n                <Show when={msg.role === 'assistant' && msg.type === 'text'}>\n                  <Show\n                    when={isWaitingForResponse() && msg.id === messages()[messages().length - 1].id}\n                    fallback={\n                      <div\n                        class=\"markdown-body\"\n                        innerHTML={renderMarkdown(msg.text + (isStreaming() && msg.id === messages()[messages().length - 1].id ? ' \u258d' : ''))}\n                      />\n                    }\n                  >\n                    <TypingIndicator />\n                  </Show>\n                </Show>\n                <Show when={msg.role === 'user'}>\n                  <Show\n                    when={editingMessageId() === msg.id}\n                    fallback={\n                      <div\n                        class=\"markdown-body\"\n                        innerHTML={renderMarkdown(msg.text)}\n                      />\n                    }\n                  >\n                    <div class=\"space-y-2\">\n                      <textarea\n                        class=\"input w-full min-h-[80px] resize-y\"\n                        value={editText()}\n                        onInput={(e) => setEditText(e.currentTarget.value)}\n                        autofocus\n                      />\n                      <div class=\"flex gap-2\">\n                        <button\n                          onClick={() => saveEditedMessage(msg.id)}\n                          class=\"flex items-center gap-1 px-3 py-1 text-sm rounded bg-primary text-primary-foreground hover:opacity-90\"\n                        >\n                          <Check size={14} />\n                          <span>Salvar</span>\n                        </button>\n                        <button\n                          onClick={cancelEditMessage}\n                          class=\"flex items-center gap-1 px-3 py-1 text-sm rounded border hover:bg-muted\"\n                        >\n                          <X size={14} />\n                          <span>Cancelar</span>\n                        </button>\n                      </div>\n                    </div>\n                  </Show>\n\n                  {/* Edit button for user messages */}\n                  <Show when={editingMessageId() !== msg.id && !isStreaming()}>\n                    <button\n                      onClick={() => startEditMessage(msg.id, msg.text)}\n                      class=\"flex items-center gap-1 px-2 py-1 mt-2 text-xs rounded hover:bg-primary/10 transition-colors\"\n                      title=\"Editar mensagem\"\n                    >\n                      <Pencil size={12} />\n                      <span>Editar</span>\n                    </button>\n                  </Show>\n                </Show>\n                <Show when={msg.type === 'error'}>\n                  <span class=\"text-red-500 font-bold whitespace-pre-wrap\">{msg.text}</span>\n                </Show>\n\n                {/* Message Actions */}\n                <Show when={msg.role === 'assistant' && !isStreaming()}>\n                  <MessageActions\n                    messageText={msg.text}\n                    messageId={msg.id}\n                    canRegenerate={index() === messages().length - 1 && lastUserMessage() !== ''}\n                    onRegenerate={regenerateLastResponse}\n                  />\n                </Show>\n\n                <Show when={msg.role === 'assistant' && !isStreaming() && msg.response_id}>\n                  <div class=\"flex items-center space-x-2 mt-2\">\n                    <FeedbackButtons messageId={msg.response_id!} onFeedback={handleFeedback} />\n                    <Show when={msg.data}>\n                      <DownloadButton data={msg.data!} filename={`data-${msg.response_id}.json`} />\n                    </Show>\n                  </div>\n                </Show>\n                <div class=\"text-xs text-muted-foreground mt-1\">\n                  {formatTimestamp(msg.timestamp)}\n                </div>\n              </div>\n            </div>\n          )}\n        </For>\n        <div ref={messagesEndRef} />\n      </div>\n\n      <div class=\"p-4 border-t bg-background/50 backdrop-blur\">\n        <form onSubmit={sendMessage} class=\"flex gap-2\">\n          <input\n            type=\"text\"\n            class=\"input flex-1\"\n            value={input()}\n            onInput={(e) => setInput(e.currentTarget.value)}\n            placeholder=\"Fa\u00e7a uma pergunta sobre os dados...\"\n            disabled={isStreaming()}\n          />\n          <button type=\"submit\" class=\"btn btn-primary\" disabled={isStreaming() || !input()}>\n            Enviar\n          </button>\n        </form>\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 15312, "end_char_idx": 20491, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "81f75453-3f99-415b-a53d-cda4cdbcb2a7": {"__data__": {"id_": "81f75453-3f99-415b-a53d-cda4cdbcb2a7", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "hash": "75ce5e1e937f0d08d6d3f5d5482f2b7da322f25b300bb18a9ee561e46dacb00d", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "7a88f0d7-1083-44e7-8d18-cc971c4305b9", "node_type": "1", "metadata": {}, "hash": "db25b17e4fa6000e7213d500c321e79581c85f87eaef9448addbbe8c6c098ef8", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, For, Show, onMount, createEffect } from 'solid-js';\nimport { Code, Send, Trash2, FileCode, Database, Zap, Clock, Info, BookOpen, Search, ChevronDown, ChevronRight } from 'lucide-solid';\nimport api from '../lib/api';\nimport { MessageActions } from '../components/MessageActions';\nimport 'github-markdown-css/github-markdown.css';\nimport './chat-markdown.css';\n\ninterface Message {\n  id: string;\n  role: 'user' | 'assistant';\n  content: string;\n  timestamp: string;\n  code_references?: CodeReference[];\n}\n\ninterface CodeReference {\n  file: string;\n  score: number;\n  content: string;\n  lines: string;\n}\n\ninterface IndexStats {\n  status: string;\n  total_files: number;\n  total_functions: number;\n  total_classes: number;\n  total_lines: number;\n  indexed_at: string | null;\n  languages: string[];\n}\n\nexport default function CodeChat() {\n  const [messages, setMessages] = createSignal<Message[]>([]);\n  const [input, setInput] = createSignal('');\n  const [loading, setLoading] = createSignal(false);\n  const [indexStats, setIndexStats] = createSignal<IndexStats | null>(null);\n  const [examplesExpanded, setExamplesExpanded] = createSignal(true);\n  let messagesEndRef: HTMLDivElement | undefined;\n\n  // Examples de perguntas\n  const examples = [\n    {\n      title: \"Estrutura do C\u00f3digo\",\n      prompt: \"Quais s\u00e3o os principais m\u00f3dulos do backend?\"\n    },\n    {\n      title: \"Autentica\u00e7\u00e3o\",\n      prompt: \"Como funciona o sistema de autentica\u00e7\u00e3o?\"\n    },\n    {\n      title: \"API Endpoints\",\n      prompt: \"Liste todos os endpoints da API de chat\"\n    },\n    {\n      title: \"Frontend Components\",\n      prompt: \"Quais componentes SolidJS existem no projeto?\"\n    }\n  ];\n\n  onMount(async () => {\n    // Load index stats\n    try {\n      const response = await api.get('/code-chat/stats');\n      setIndexStats(response.data);\n      \n      // Welcome message\n      const welcomeMsg: Message = {\n        id: '0',\n        role: 'assistant',\n        content: `\ud83e\udd16 **Ol\u00e1! Sou seu Agente Fullstack de C\u00f3digo.**\\n\\nPosso responder qualquer pergunta sobre este projeto:\\n\\n- \ud83d\udcc1 **${response.data.total_files.toLocaleString()}** arquivos indexados\\n- \ud83d\udcdd **${response.data.total_functions.toLocaleString()}** fun\u00e7\u00f5es\\n- \ud83c\udfd7\ufe0f **${response.data.total_classes.toLocaleString()}** classes\\n- \ud83d\udcbb **${response.data.languages.join(', ')}**\\n\\nFa\u00e7a uma pergunta sobre o c\u00f3digo!`,\n        timestamp: new Date().toISOString()\n      };\n      setMessages([welcomeMsg]);\n      \n    } catch (error: any) {\n      console.error('Erro ao carregar stats:', error);\n      const errorMsg: Message = {\n        id: '0',\n        role: 'assistant',\n        content: '\u26a0\ufe0f **\u00cdndice n\u00e3o dispon\u00edvel**\\n\\nO \u00edndice de c\u00f3digo n\u00e3o foi gerado ainda.\\n\\nExecute: `python scripts/index_codebase.py`',\n        timestamp: new Date().toISOString()\n      };\n      setMessages([errorMsg]);\n    }\n  });\n\n  createEffect(() => {\n    if (messages()) {\n      setTimeout(() => messagesEndRef?.scrollIntoView({ behavior: 'smooth' }), 100);\n    }\n  });\n\n  const sendMessage = async (e?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3032, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7a88f0d7-1083-44e7-8d18-cc971c4305b9": {"__data__": {"id_": "7a88f0d7-1083-44e7-8d18-cc971c4305b9", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "hash": "75ce5e1e937f0d08d6d3f5d5482f2b7da322f25b300bb18a9ee561e46dacb00d", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "81f75453-3f99-415b-a53d-cda4cdbcb2a7", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "hash": "f15f299211cd8ef19146f6b668a4efffea3ee2f19c96f812c7a709556c8b6b6e", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "36c522f0-ee31-4310-8ec2-d7cef5cc0eaa", "node_type": "1", "metadata": {}, "hash": "89c6f651bfe7a652c43debd0ca45acce99aa2f7097f69a0dec28e0bd8ca61abd", "class_name": "RelatedNodeInfo"}}, "text": ": Event) => {\n    e?.preventDefault();\n    if (!input().trim() || loading()) return;\n\n    const userMessage: Message = {\n      id: Date.now().toString(),\n      role: 'user',\n      content: input(),\n      timestamp: new Date().toISOString()\n    };\n\n    setMessages([...messages(), userMessage]);\n    setInput('');\n    setLoading(true);\n\n    try {\n      const response = await api.post('/code-chat/query', {\n        message: userMessage.content,\n        history: messages().slice(-5).map(m => ({\n          role: m.role,\n          content: m.content,\n          timestamp: m.timestamp\n        }))\n      });\n\n      const assistantMessage: Message = {\n        id: (Date.now() + 1).toString(),\n        role: 'assistant',\n        content: response.data.response,\n        timestamp: response.data.metadata.timestamp,\n        code_references: response.data.code_references\n      };\n\n      setMessages([...messages(), userMessage, assistantMessage]);\n\n    } catch (error: any) {\n      const errorMessage: Message = {\n        id: Date.now().toString(),\n        role: 'assistant',\n        content: `\u274c **Erro**: ${error.response?.data?.detail || error.message}`,\n        timestamp: new Date().toISOString()\n      };\n      setMessages([...messages(), userMessage, errorMessage]);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const clearHistory = () => {\n    if (confirm('Deseja limpar o hist\u00f3rico?')) {\n      setMessages([messages()[0]]); // Keep welcome message\n    }\n  };\n\n  const loadExample = (prompt: string) => {\n    setInput(prompt);\n  };\n\n  return (\n    <div class=\"h-full flex flex-col bg-background max-w-[1800px] mx-auto\">\n      {/* Context7: Executive Header with KPIs */}\n      <div class=\"border-b bg-card/50 backdrop-blur-sm p-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-4\">\n        <div>\n          <h2 class=\"text-xl font-bold flex items-center gap-2 text-foreground\">\n            <Code class=\"text-primary\" />\n            Code Chat <span class=\"text-muted font-normal text-sm border-l pl-2 ml-2\">Agente Fullstack</span>\n          </h2>\n        </div>\n\n        {/* Live Metrics Strip */}\n        <Show when={indexStats()}>\n          <div class=\"flex gap-4\">\n            <div class=\"flex items-center gap-3 px-4 py-2 bg-secondary/50 rounded-lg border border-border/50\">\n              <FileCode size={16} class=\"text-blue-500\" />\n              <div>\n                <div class=\"text-[10px] text-muted uppercase tracking-wider font-semibold\">Arquivos</div>\n                <div class=\"text-sm font-mono font-bold\">{indexStats()!.total_files.toLocaleString()}</div>\n              </div>\n            </div>\n\n            <div class=\"flex items-center gap-3 px-4 py-2 bg-secondary/50 rounded-lg border border-border/50\">\n              <Zap size={16} class=\"text-purple-500\" />\n              <div>\n                <div class=\"text-[10px] text-muted uppercase tracking-wider font-semibold\">Fun\u00e7\u00f5es</div>\n                <div class=\"text-sm font-mono font-bold\">{indexStats()!.total_functions.toLocaleString()}</div>\n              </div>\n            </div>\n\n            <div class=\"flex items-center gap-3 px-4 py-2 bg-secondary/50 rounded-lg border border-border/50\">\n              <Database size={16} class=\"text-green-500\" />\n              <div>\n                <div class=\"text-[10px] text-muted uppercase tracking-wider font-semibold\">Status</div>\n                <div class=\"text-sm font-mono font-bold\">{indexStats()!.status === 'ready' ? '\u2705 Pronto' : '\u26a0\ufe0f Indexando'}</div>\n              </div>\n            </div>\n          </div>\n        </Show>\n      </div>\n\n      <div class=\"flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-[1fr_350px]\">\n        {/* Main Chat Area */}\n        <div class=\"flex flex-col min-h-0 bg-background/50\">\n          {/* Messages */}\n          <div class=\"flex-1 overflow-y-auto p-6 space-y-6\">\n            <For each={messages()}>\n              {(message) => (\n                <div class={`flex ${message.role === 'user' ?", "mimetype": "text/plain", "start_char_idx": 3032, "end_char_idx": 7025, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "36c522f0-ee31-4310-8ec2-d7cef5cc0eaa": {"__data__": {"id_": "36c522f0-ee31-4310-8ec2-d7cef5cc0eaa", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "hash": "75ce5e1e937f0d08d6d3f5d5482f2b7da322f25b300bb18a9ee561e46dacb00d", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "7a88f0d7-1083-44e7-8d18-cc971c4305b9", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "hash": "20fb2281d48a22bc1187e64c6bb8f8db57e72dfc077397b57266e86db754143c", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "135ad231-0b04-4ab4-aba7-4cbb3dbd4427", "node_type": "1", "metadata": {}, "hash": "2f6aa1de2b17a7bf9f2f3afd949db145646a142d1ae5b93bfcc753084132ba9b", "class_name": "RelatedNodeInfo"}}, "text": "'\u2705 Pronto' : '\u26a0\ufe0f Indexando'}</div>\n              </div>\n            </div>\n          </div>\n        </Show>\n      </div>\n\n      <div class=\"flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-[1fr_350px]\">\n        {/* Main Chat Area */}\n        <div class=\"flex flex-col min-h-0 bg-background/50\">\n          {/* Messages */}\n          <div class=\"flex-1 overflow-y-auto p-6 space-y-6\">\n            <For each={messages()}>\n              {(message) => (\n                <div class={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2`}>\n                  <div\n                    class={`max-w-[85%] rounded-2xl p-5 shadow-sm ${\n                      message.role === 'user'\n                        ? 'bg-primary/10 border border-primary/20 text-foreground rounded-tr-none'\n                        : 'bg-card border text-card-foreground rounded-tl-none'\n                    }`}\n                  >\n                    <div class=\"flex items-center gap-2 mb-2 opacity-70 border-b border-border/10 pb-2\">\n                      <span class=\"text-xs font-bold uppercase tracking-wider\">\n                        {message.role === 'user' ?", "mimetype": "text/plain", "start_char_idx": 6511, "end_char_idx": 7700, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "135ad231-0b04-4ab4-aba7-4cbb3dbd4427": {"__data__": {"id_": "135ad231-0b04-4ab4-aba7-4cbb3dbd4427", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "hash": "75ce5e1e937f0d08d6d3f5d5482f2b7da322f25b300bb18a9ee561e46dacb00d", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "36c522f0-ee31-4310-8ec2-d7cef5cc0eaa", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "hash": "7ade2d61144afb541e894f444bb0c9a4ba0188489357cea05dd16e85247227c2", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b8c959e0-32a8-4db9-bbc5-f25dae6649cd", "node_type": "1", "metadata": {}, "hash": "5faf8886e008021d2f9066120224979a76f883b36a5f34f0d21db92992115ca8", "class_name": "RelatedNodeInfo"}}, "text": "'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2`}>\n                  <div\n                    class={`max-w-[85%] rounded-2xl p-5 shadow-sm ${\n                      message.role === 'user'\n                        ? 'bg-primary/10 border border-primary/20 text-foreground rounded-tr-none'\n                        : 'bg-card border text-card-foreground rounded-tl-none'\n                    }`}\n                  >\n                    <div class=\"flex items-center gap-2 mb-2 opacity-70 border-b border-border/10 pb-2\">\n                      <span class=\"text-xs font-bold uppercase tracking-wider\">\n                        {message.role === 'user' ? 'Voc\u00ea' : 'Agente'}\n                      </span>\n                      <span class=\"text-[10px] ml-auto\">\n                        {new Date(message.timestamp).toLocaleTimeString()}\n                      </span>\n                    </div>\n\n                    <div class=\"markdown-body text-sm leading-relaxed\" style=\"background: transparent;\">\n                      <pre class=\"whitespace-pre-wrap font-sans bg-transparent border-0 p-0 m-0 text-current\">{message.content}</pre>\n                    </div>\n\n                    {/* Code References */}\n                    <Show when={message.code_references && message.code_references.length > 0}>\n                      <div class=\"mt-4 pt-4 border-t border-border/10 space-y-2\">\n                        <div class=\"text-xs font-bold text-muted uppercase tracking-wider mb-2\">\n                          \ud83d\udcc4 Refer\u00eancias de C\u00f3digo ({message.code_references!.length})\n                        </div>\n                        <For each={message.code_references}>\n                          {(ref) => (\n                            <div class=\"bg-secondary/30 border rounded-lg p-3 text-xs font-mono\">\n                              <div class=\"flex items-center justify-between mb-2\">\n                                <span class=\"font-bold text-primary\">{ref.file}</span>\n                                <span class=\"text-muted\">Score: {(ref.score * 100).toFixed(1)}%</span>\n                              </div>\n                              <pre class=\"text-[11px] text-muted overflow-x-auto whitespace-pre-wrap\">{ref.content}</pre>\n                            </div>\n                          )}\n                        </For>\n                      </div>\n                    </Show>\n\n                    <Show when={message.role === 'assistant'}>\n                      <div class=\"mt-3 pt-2 border-t border-border/10\">\n                        <MessageActions messageText={message.content} messageId={message.id} />\n                      </div>\n                    </Show>\n                  </div>\n                </div>\n              )}\n            </For>\n\n            <Show when={loading()}>\n              <div class=\"flex justify-start\">\n                <div class=\"bg-card border rounded-2xl rounded-tl-none p-4 flex items-center gap-3\">\n                  <div class=\"flex space-x-1\">\n                    <div class=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce [animation-delay:-0.3s]\"></div>\n                    <div class=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce [animation-delay:-0.15s]\"></div>\n                    <div class=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce\"></div>\n                  </div>\n                  <span class=\"text-xs text-muted font-medium\">Analisando c\u00f3digo...</span>\n                </div>\n              </div>\n            </Show>\n            <div ref={messagesEndRef} />\n          </div>\n\n          {/* Input Area */}\n          <div class=\"p-4 border-t bg-background/80 backdrop-blur-md\">\n            <form onSubmit={sendMessage} class=\"flex gap-3 max-w-4xl mx-auto\">\n              <button\n                type=\"button\"\n                onClick={clearHistory}\n                class=\"btn btn-ghost btn-icon text-muted hover:text-destructive\"\n                title=\"Limpar Hist\u00f3rico\"\n              >\n                <Trash2 size={20} />\n              </button>\n\n              <div class=\"flex-1 relative\">\n                <input\n                  type=\"text\"\n                  class=\"input w-full pr-12 shadow-sm font-mono text-sm\"\n                  placeholder=\"Pergunte sobre o c\u00f3digo...\"\n                  value={input()}\n                  onInput={(e) => setInput(e.currentTarget.value)}\n                  disabled={loading()}\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                class=\"btn btn-primary shadow-md hover:shadow-lg transition-all\"\n                disabled={loading() || !input().trim()}\n              >\n                <Show when={!loading()} fallback={<Clock size={20} class=\"animate-spin\" />}>\n                  <Send size={20} />\n                </Show>\n              </button>\n            </form>\n          </div>\n        </div>\n\n        {/* Right Sidebar - Examples & Info */}\n        <div class=\"border-l bg-card/30 p-6 overflow-y-auto hidden lg:block\">\n          <div class=\"sticky top-0 space-y-8\">\n            {/* Examples */}\n            <div class=\"space-y-4\">\n              <button\n                onClick={() => setExamplesExpanded(!examplesExpanded())}\n                class=\"w-full flex items-center justify-between text-sm font-bold uppercase tracking-wider text-muted hover:text-foreground\"\n              >\n                <div class=\"flex items-center gap-2\">\n                  <BookOpen size={14} />\n                  Exemplos\n                </div>\n                {examplesExpanded() ?", "mimetype": "text/plain", "start_char_idx": 7026, "end_char_idx": 12575, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b8c959e0-32a8-4db9-bbc5-f25dae6649cd": {"__data__": {"id_": "b8c959e0-32a8-4db9-bbc5-f25dae6649cd", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "hash": "75ce5e1e937f0d08d6d3f5d5482f2b7da322f25b300bb18a9ee561e46dacb00d", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "135ad231-0b04-4ab4-aba7-4cbb3dbd4427", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}, "hash": "cc820d03da5320a3f648d48a989a123713c929ab9d1bec2a115939f12dd6d516", "class_name": "RelatedNodeInfo"}}, "text": "<ChevronDown size={14} /> : <ChevronRight size={14} />}\n              </button>\n\n              <Show when={examplesExpanded()}>\n                <div class=\"space-y-2 animate-in slide-in-from-top-2\">\n                  <For each={examples}>\n                    {(example) => (\n                      <button\n                        onClick={() => loadExample(example.prompt)}\n                        class=\"w-full p-3 rounded-lg border border-border/50 hover:border-primary/50 hover:bg-secondary/50 transition-all text-left group\"\n                      >\n                        <div class=\"font-semibold text-sm group-hover:text-primary transition-colors mb-1 flex items-center gap-2\">\n                          <Search size={12} />\n                          {example.title}\n                        </div>\n                        <div class=\"text-xs text-muted line-clamp-2\">{example.prompt}</div>\n                      </button>\n                    )}\n                  </For>\n                </div>\n              </Show>\n            </div>\n\n            {/* Index Info */}\n            <Show when={indexStats()}>\n              <div class=\"p-4 bg-blue-500/5 border border-blue-500/10 rounded-xl space-y-2\">\n                <div class=\"flex items-center gap-2 text-blue-600 font-bold text-sm\">\n                  <Info size={16} />\n                  Informa\u00e7\u00f5es do \u00cdndice\n                </div>\n                <div class=\"text-xs text-muted space-y-1\">\n                  <div>\ud83d\udcc1 {indexStats()!.total_files.toLocaleString()} arquivos</div>\n                  <div>\ud83d\udcdd {indexStats()!.total_functions.toLocaleString()} fun\u00e7\u00f5es</div>\n                  <div>\ud83c\udfd7\ufe0f {indexStats()!.total_classes.toLocaleString()} classes</div>\n                  <div>\ud83d\udcbe {indexStats()!.total_lines.toLocaleString()} linhas</div>\n                  <Show when={indexStats()!.indexed_at}>\n                    <div class=\"pt-2 border-t border-border/10\">\n                      Indexado: {new Date(indexStats()!.indexed_at!).toLocaleString()}\n                    </div>\n                  </Show>\n                </div>\n              </div>\n            </Show>\n\n            {/* Help */}\n            <div class=\"p-4 bg-yellow-500/5 border border-yellow-500/10 rounded-xl space-y-2\">\n              <div class=\"flex items-center gap-2 text-yellow-600 font-bold text-sm\">\n                <Info size={16} />\n                Dicas de Uso\n              </div>\n              <p class=\"text-xs text-muted leading-relaxed\">\n                Fa\u00e7a perguntas espec\u00edficas sobre o c\u00f3digo, arquitetura, ou funcionalidades. \n                O agente busca semanticamente em todo o projeto e fornece respostas contextualizadas.\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 12576, "end_char_idx": 15342, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8eb3d2f9-06bd-465a-9ad4-0c58b1533535": {"__data__": {"id_": "8eb3d2f9-06bd-465a-9ad4-0c58b1533535", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "9af025739324b81a7e91ddfc87e2c70c9cc906e3ebb8f0e6695a1b428d6af755", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "cf0e476c-4653-455c-8849-5971d2a0b42f", "node_type": "1", "metadata": {}, "hash": "5c1f85776558000b9ad144a85e084a0bf8798bc6a336419e92abf7b73559c006", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, onMount, Show, For, createMemo } from 'solid-js';\nimport { useNavigate } from '@solidjs/router';\nimport { ShoppingCart, Package, AlertTriangle, DollarSign, RefreshCw, TrendingUp, X, CheckCircle, Info } from 'lucide-solid';\nimport api from '../lib/api';\nimport { PlotlyChart } from '../components/PlotlyChart';\nimport { ChartDownloadButton } from '../components/ChartDownloadButton';\nimport { AIInsightsPanel } from '../components/AIInsightsPanel';\nimport auth from '@/store/auth';\n\ninterface BusinessKPIs {\n  total_produtos: number;\n  total_unes: number;\n  produtos_ruptura: number;\n  valor_estoque: number;\n  top_produtos: Array<{\n    produto: string;\n    nome: string;\n    vendas: number;\n  }>;\n  vendas_por_categoria: Array<{\n    categoria: string;\n    vendas: number;\n    produtos: number;\n  }>;\n}\n\nexport default function Dashboard() {\n  const navigate = useNavigate();\n  const [kpis, setKpis] = createSignal<BusinessKPIs | null>(null);\n  const [loading, setLoading] = createSignal(true);\n  const [error, setError] = createSignal<string | null>(null);\n  const [lastUpdate, setLastUpdate] = createSignal<Date | null>(null);\n  const [selectedProductInfo, setSelectedProductInfo] = createSignal<{\n    produto: string;\n    nome: string;\n    vendas: number;\n  } | null>(null);\n\n  // Chart specs para Plotly\n  const [topProdutosChart, setTopProdutosChart] = createSignal<any>({});\n  const [vendasCategoriaChart, setVendasCategoriaChart] = createSignal<any>({});\n\n  // Context7 Logic: Derived State\n  const businessStatus = createMemo(() => {\n    if (!kpis()) return 'loading';\n    const ruptureRate = kpis()!.produtos_ruptura / (kpis()!.total_produtos || 1);\n    if (kpis()!.produtos_ruptura > 50 || ruptureRate > 0.1) return 'critical';\n    if (kpis()!.produtos_ruptura > 0) return 'warning';\n    return 'healthy';\n  });\n\n  const handleProductClick = (clickData: any) => {\n    if (clickData && clickData.points && clickData.points[0]) {\n      const point = clickData.points[0];\n      if (point.customdata) {\n        setSelectedProductInfo(point.customdata);\n      }\n    }\n  };\n\n  const loadKPIs = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n\n      const response = await api.get<BusinessKPIs>('/metrics/business-kpis');\n      setKpis(response.data);\n      setLastUpdate(new Date());\n\n      // Context7 Storytelling: Chart 1 - \"Who is leading?\"\n      if (response.data.top_produtos.length > 0) {\n        const topProduct = response.data.top_produtos[0];\n        const topProdutosSpec = {\n          data: [{\n            type: 'bar',\n            x: response.data.top_produtos.map(p => p.nome),\n            y: response.data.top_produtos.map(p => p.vendas),\n            marker: {\n              color: response.data.top_produtos.map((_, i) => i === 0 ? '#3b82f6' : '#9ca3af'), // Highlight #1\n              line: { color: '#1f2937', width: 0 }\n            },\n            text: response.data.top_produtos.map(p => p.vendas.toLocaleString()),\n            textposition: 'outside',\n            hovertemplate: '<b>%{x}</b><br>Vendas: %{y:,}<extra></extra>',\n            customdata: response.data.top_produtos.map(p => ({ produto: p.produto, nome: p.nome, vendas: p.vendas }))\n          }],\n          layout: {\n            title: {\n              text: '<b>Quais produtos impulsionam as vendas?</b><br><span style=\"font-size:12px;color:#9ca3af\">O l\u00edder de vendas representa ' + Math.round((topProduct.vendas / response.data.top_produtos.reduce((a,b)=>a+b.vendas,0))*100) + '% do volume total do top 10</span>',\n              font: { size: 16, color: '#e5e7eb' },\n              x: 0.05,\n            },", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3636, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "cf0e476c-4653-455c-8849-5971d2a0b42f": {"__data__": {"id_": "cf0e476c-4653-455c-8849-5971d2a0b42f", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "9af025739324b81a7e91ddfc87e2c70c9cc906e3ebb8f0e6695a1b428d6af755", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8eb3d2f9-06bd-465a-9ad4-0c58b1533535", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "eb67c7644f027954609b811033f227fee03043b73d53cfc8e2e2ecc6e3611554", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "ececcc0c-34cb-447f-9e25-6d461b547ef1", "node_type": "1", "metadata": {}, "hash": "7b13d8d02c27903030737456f8aa4e6494f2e6e22d14581b3b9bec17ab360f24", "class_name": "RelatedNodeInfo"}}, "text": "hovertemplate: '<b>%{x}</b><br>Vendas: %{y:,}<extra></extra>',\n            customdata: response.data.top_produtos.map(p => ({ produto: p.produto, nome: p.nome, vendas: p.vendas }))\n          }],\n          layout: {\n            title: {\n              text: '<b>Quais produtos impulsionam as vendas?</b><br><span style=\"font-size:12px;color:#9ca3af\">O l\u00edder de vendas representa ' + Math.round((topProduct.vendas / response.data.top_produtos.reduce((a,b)=>a+b.vendas,0))*100) + '% do volume total do top 10</span>',\n              font: { size: 16, color: '#e5e7eb' },\n              x: 0.05,\n            },\n            annotations: [\n              {\n                x: topProduct.nome,\n                y: topProduct.vendas,\n                xref: 'x',\n                yref: 'y',\n                text: '\ud83c\udfc6 L\u00edder',\n                showarrow: true,\n                arrowhead: 2,\n                ax: 0,\n                ay: -40,\n                font: { color: '#fbbf24', size: 12 }\n              }\n            ],\n            xaxis: {\n              title: '',\n              tickangle: -45,\n              tickfont: { size: 10, color: '#9ca3af' },\n              gridcolor: '#374151'\n            },\n            yaxis: {\n              title: 'Volume de Vendas (30 dias)',\n              titlefont: { color: '#9ca3af', size: 10 },\n              tickfont: { color: '#9ca3af' },\n              gridcolor: '#374151'\n            },\n            plot_bgcolor: '#1f2937',\n            paper_bgcolor: '#1f2937',\n            margin: { l: 60, r: 20, t: 80, b: 120 },\n            font: { color: '#e5e7eb' }\n          },\n          config: { responsive: true, displayModeBar: false }\n        };\n        setTopProdutosChart(topProdutosSpec);\n      }\n\n      // Context7 Storytelling: Chart 2 - \"Composition\"\n      if (response.data.vendas_por_categoria.length > 0) {\n        const vendasCategoriaSpec = {\n          data: [{\n            type: 'pie',\n            labels: response.data.vendas_por_categoria.map(c => c.categoria),\n            values: response.data.vendas_por_categoria.map(c => c.vendas),\n            hovertemplate: '<b>%{label}</b><br>Vendas: %{value:,}<br>%{percent}<extra></extra>',\n            marker: {\n              colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16']\n            },\n            textinfo: 'label+percent',\n            textposition: 'inside',\n            textfont: { size: 11 },\n            hole: 0.4 // Donut chart for modern look\n          }],\n          layout: {\n            title: {\n              text: '<b>Como as vendas est\u00e3o distribu\u00eddas?</b><br><span style=\"font-size:12px;color:#9ca3af\">Participa\u00e7\u00e3o por categoria de produto</span>',\n              font: { size: 16, color: '#e5e7eb' },\n              x: 0.05\n            },\n            plot_bgcolor: '#1f2937',\n            paper_bgcolor: '#1f2937',\n            margin: { l: 20, r: 20, t: 80, b: 20 },\n            font: { color: '#e5e7eb' },\n            showlegend: true,\n            legend: {\n              orientation: 'v',\n              x: 1,\n              y: 1,\n              font: { size: 10, color: '#9ca3af' }\n            }\n          },\n          config: { responsive: true, displayModeBar: false }\n        };\n        setVendasCategoriaChart(vendasCategoriaSpec);\n      }\n\n    } catch (err: any) {\n      console.", "mimetype": "text/plain", "start_char_idx": 3033, "end_char_idx": 6354, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ececcc0c-34cb-447f-9e25-6d461b547ef1": {"__data__": {"id_": "ececcc0c-34cb-447f-9e25-6d461b547ef1", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "9af025739324b81a7e91ddfc87e2c70c9cc906e3ebb8f0e6695a1b428d6af755", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "cf0e476c-4653-455c-8849-5971d2a0b42f", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "40cc8d1e85c020793e8668b444a46efd338b19ca044af32e99f193a43512e734", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "8c2fc024-3454-4765-924b-d8b7b8ad18cb", "node_type": "1", "metadata": {}, "hash": "0ef26beebc26db06a04388a098bfe15d6ddd51cad4862e5b4c5e9cbdef1b5f62", "class_name": "RelatedNodeInfo"}}, "text": "font: { size: 16, color: '#e5e7eb' },\n              x: 0.05\n            },\n            plot_bgcolor: '#1f2937',\n            paper_bgcolor: '#1f2937',\n            margin: { l: 20, r: 20, t: 80, b: 20 },\n            font: { color: '#e5e7eb' },\n            showlegend: true,\n            legend: {\n              orientation: 'v',\n              x: 1,\n              y: 1,\n              font: { size: 10, color: '#9ca3af' }\n            }\n          },\n          config: { responsive: true, displayModeBar: false }\n        };\n        setVendasCategoriaChart(vendasCategoriaSpec);\n      }\n\n    } catch (err: any) {\n      console.error('Erro ao carregar KPIs:', err);\n      setError(err.response?.data?.detail || 'Erro ao carregar m\u00e9tricas');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  onMount(() => {\n    loadKPIs();\n    // Auto-refresh removido conforme solicitado\n    // const interval = setInterval(() => loadKPIs(), 30000);\n    // return () => clearInterval(interval);\n  });\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6 max-w-[1600px] mx-auto\">\n      {/* 1. Context7: Executive Summary Header */}\n      <div class=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b pb-6\">\n        <div>\n          <h2 class=\"text-3xl font-bold tracking-tight text-foreground\">\n            Ol\u00e1, {auth.user()?.username || 'Usu\u00e1rio'}\n          </h2>\n          <div class=\"flex items-center gap-2 mt-2\">\n            <Show when={businessStatus() === 'healthy'}>\n              <span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800\">\n                <CheckCircle size={12} class=\"mr-1\" /> Opera\u00e7\u00e3o Saud\u00e1vel\n              </span>\n            </Show>\n            <Show when={businessStatus() === 'warning'}>\n              <span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800\">\n                <AlertTriangle size={12} class=\"mr-1\" /> Aten\u00e7\u00e3o Necess\u00e1ria\n              </span>\n            </Show>\n            <Show when={businessStatus() === 'critical'}>\n              <span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800\">\n                <AlertTriangle size={12} class=\"mr-1\" /> Situa\u00e7\u00e3o Cr\u00edtica\n              </span>\n            </Show>\n            <span class=\"text-sm text-muted ml-2\">\n              Vis\u00e3o geral do desempenho do neg\u00f3cio\n            </span>\n          </div>\n        </div>\n        <div class=\"flex items-center gap-2\">\n           <span class=\"text-xs text-muted text-right hidden md:block\">\n            Dados atualizados<br/>{lastUpdate()?.toLocaleTimeString()}\n           </span>\n          <button\n            onClick={loadKPIs}\n            class=\"btn btn-outline btn-icon\"\n            disabled={loading()}\n            title=\"Atualizar dados\"\n          >\n            <RefreshCw size={18} class={loading() ?", "mimetype": "text/plain", "start_char_idx": 5735, "end_char_idx": 8666, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8c2fc024-3454-4765-924b-d8b7b8ad18cb": {"__data__": {"id_": "8c2fc024-3454-4765-924b-d8b7b8ad18cb", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "9af025739324b81a7e91ddfc87e2c70c9cc906e3ebb8f0e6695a1b428d6af755", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "ececcc0c-34cb-447f-9e25-6d461b547ef1", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "9eac212792384f1185918d07cfa407d844c9f310856ab832632aa1f274f8312b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2acf7ece-d27d-4ca3-9f4e-5965c228be13", "node_type": "1", "metadata": {}, "hash": "422c0c916b7f84d5518c95f099a8bb93b8ec839f8c8fe2134b8d1f2e034966aa", "class_name": "RelatedNodeInfo"}}, "text": "'animate-spin' : ''} />\n          </button>\n        </div>\n      </div>\n\n      {/* Loading State */}\n      <Show when={loading() && !kpis()}>\n        <div class=\"flex-1 flex flex-col items-center justify-center text-muted gap-4\">\n           <RefreshCw size={48} class=\"animate-spin opacity-20\" />\n           <p>Analisando dados do neg\u00f3cio...</p>\n        </div>\n      </Show>\n\n      {/* Error State */}\n      <Show when={error()}>\n        <div class=\"p-4 border border-red-500/50 bg-red-500/10 rounded-lg text-red-500 flex items-center gap-3\">\n            <AlertTriangle size={24} />\n            <div>\n              <h3 class=\"font-bold\">Falha ao carregar dashboard</h3>\n              <p class=\"text-sm opacity-80\">{error()}</p>\n            </div>\n        </div>\n      </Show>\n\n      <Show when={kpis() && !loading()}>\n        {/* 2. Context7: Key Performance Indicators (The \"What\") */}\n        <div class=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          <div class=\"kpi-card bg-card border rounded-xl p-5 shadow-sm hover:shadow-md transition-all relative overflow-hidden group\">\n            <div class=\"absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity\">\n               <DollarSign size={48} />\n            </div>\n            <p class=\"text-sm font-medium text-muted uppercase tracking-wider\">Valor em Estoque</p>\n            <h3 class=\"text-3xl font-bold mt-1\">{kpis()!.valor_estoque.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</h3>\n            <p class=\"text-xs text-muted mt-2 flex items-center gap-1\">\n              <TrendingUp size={12} class=\"text-green-500\" /> Capital imobilizado\n            </p>\n          </div>\n\n          <div class=\"kpi-card bg-card border rounded-xl p-5 shadow-sm hover:shadow-md transition-all relative overflow-hidden group\">\n            <div class=\"absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity\">\n               <AlertTriangle size={48} />\n            </div>\n            <p class=\"text-sm font-medium text-muted uppercase tracking-wider\">Rupturas</p>\n            <h3 class={`text-3xl font-bold mt-1 ${kpis()!.produtos_ruptura > 0 ? 'text-destructive' : 'text-foreground'}`}>\n              {kpis()!.produtos_ruptura}\n            </h3>\n            <p class=\"text-xs text-muted mt-2\">\n              {kpis()!.produtos_ruptura > 0 ? 'Produtos precisam de aten\u00e7\u00e3o imediata' : 'Estoque saud\u00e1vel'}\n            </p>\n          </div>\n\n          <div class=\"kpi-card bg-card border rounded-xl p-5 shadow-sm hover:shadow-md transition-all relative overflow-hidden group\">\n            <div class=\"absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity\">\n               <Package size={48} />\n            </div>\n            <p class=\"text-sm font-medium text-muted uppercase tracking-wider\">Mix de Produtos</p>\n            <h3 class=\"text-3xl font-bold mt-1\">{kpis()!.total_produtos}</h3>\n            <p class=\"text-xs text-muted mt-2\">SKUs ativos no cat\u00e1logo</p>\n          </div>\n\n          <div class=\"kpi-card bg-card border rounded-xl p-5 shadow-sm hover:shadow-md transition-all relative overflow-hidden group\">\n            <div class=\"absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity\">\n               <ShoppingCart size={48} />\n            </div>\n            <p class=\"text-sm font-medium text-muted uppercase tracking-wider\">Cobertura</p>\n            <h3 class=\"text-3xl font-bold mt-1\">{kpis()!.total_unes}</h3>\n            <p class=\"text-xs text-muted mt-2\">Lojas/UNEs monitoradas</p>\n          </div>\n        </div>\n\n        {/* 3.", "mimetype": "text/plain", "start_char_idx": 8667, "end_char_idx": 12285, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2acf7ece-d27d-4ca3-9f4e-5965c228be13": {"__data__": {"id_": "2acf7ece-d27d-4ca3-9f4e-5965c228be13", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "9af025739324b81a7e91ddfc87e2c70c9cc906e3ebb8f0e6695a1b428d6af755", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "8c2fc024-3454-4765-924b-d8b7b8ad18cb", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "b13e53d78b00e88e7f6ffb2c926a03c509542ad772e37395155751489a3ae56e", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "21e67d06-58b8-446b-8e95-134cce03e837", "node_type": "1", "metadata": {}, "hash": "c43923d834dacc391b86fd44596e4cd10bec98546e930197906d92ec7b7bf59a", "class_name": "RelatedNodeInfo"}}, "text": "Context7: Narrative Charts (The \"Why\") */}\n        <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          <div class=\"card bg-card border rounded-xl p-1 shadow-sm overflow-hidden flex flex-col h-[400px]\">\n             <div class=\"flex-1 min-h-0\">\n                <PlotlyChart\n                  chartSpec={topProdutosChart}\n                  chartId=\"top-produtos-chart\"\n                  enableDownload={false} // Clean look\n                  onDataClick={handleProductClick}\n                />\n             </div>\n             <div class=\"px-4 py-2 bg-muted/30 border-t text-xs text-muted flex justify-between items-center\">\n                <span>Clique nas barras para detalhes</span>\n                <ChartDownloadButton chartId=\"top-produtos-chart\" filename=\"top_produtos\" label=\"\" size=\"sm\" />\n             </div>\n          </div>\n\n          <div class=\"card bg-card border rounded-xl p-1 shadow-sm overflow-hidden flex flex-col h-[400px]\">\n             <div class=\"flex-1 min-h-0\">\n                <PlotlyChart\n                  chartSpec={vendasCategoriaChart}\n                  chartId=\"vendas-categoria-chart\"\n                  enableDownload={false}\n                />\n             </div>\n             <div class=\"px-4 py-2 bg-muted/30 border-t text-xs text-muted flex justify-between items-center\">\n                <span>Distribui\u00e7\u00e3o de volume</span>\n                <ChartDownloadButton chartId=\"vendas-categoria-chart\" filename=\"vendas_categoria\" label=\"\" size=\"sm\" />\n             </div>\n          </div>\n        </div>\n\n        {/* 4. Context7: AI Analysis (The \"So What?\")", "mimetype": "text/plain", "start_char_idx": 12286, "end_char_idx": 13881, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "21e67d06-58b8-446b-8e95-134cce03e837": {"__data__": {"id_": "21e67d06-58b8-446b-8e95-134cce03e837", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "9af025739324b81a7e91ddfc87e2c70c9cc906e3ebb8f0e6695a1b428d6af755", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2acf7ece-d27d-4ca3-9f4e-5965c228be13", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}, "hash": "8f24a81a48d38fe9e673b4535b04436af79ae7e4a3604c21d0c6149310f155b0", "class_name": "RelatedNodeInfo"}}, "text": "Context7: AI Analysis (The \"So What?\") */}\n        <div class=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n           <div class=\"lg:col-span-2\">\n              <AIInsightsPanel />\n           </div>\n           \n           {/* Actionable List */}\n           <div class=\"card bg-card border rounded-xl flex flex-col\">\n              <div class=\"p-4 border-b flex items-center justify-between\">\n                 <h3 class=\"font-bold flex items-center gap-2\">\n                    <TrendingUp size={18} class=\"text-primary\" />\n                    Destaques\n                 </h3>\n                 <span class=\"text-xs bg-primary/10 text-primary px-2 py-1 rounded-full\">Top 5</span>\n              </div>\n              <div class=\"flex-1 overflow-y-auto\">\n                 <table class=\"w-full text-sm\">\n                    <tbody>\n                       <For each={kpis()!.top_produtos.slice(0, 5)}>\n                          {(produto, i) => (\n                             <tr class=\"border-b last:border-0 hover:bg-muted/50 transition-colors cursor-pointer\" onClick={() => setSelectedProductInfo(produto)}>\n                                <td class=\"p-3 font-mono text-muted w-8 text-center\">{i() + 1}</td>\n                                <td class=\"p-3\">\n                                   <div class=\"font-medium\">{produto.nome}</div>\n                                   <div class=\"text-xs text-muted\">{produto.produto}</div>\n                                </td>\n                                <td class=\"p-3 text-right font-bold text-foreground\">\n                                   {produto.vendas.toLocaleString()}\n                                </td>\n                             </tr>\n                          )}\n                       </For>\n                    </tbody>\n                 </table>\n              </div>\n              <div class=\"p-3 bg-muted/20 border-t text-center\">\n                 <button class=\"text-xs font-medium text-primary hover:underline\">Ver ranking completo</button>\n              </div>\n           </div>\n        </div>\n      </Show>\n\n      {/* Detail Modal */}\n      <Show when={selectedProductInfo()}>\n        <div\n          class=\"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-4 animate-in fade-in duration-200\"\n          onClick={() => setSelectedProductInfo(null)}\n        >\n          <div\n            class=\"bg-card border rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in-95 duration-200\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div class=\"relative h-32 bg-gradient-to-r from-primary/20 to-accent/20 flex items-center justify-center\">\n               <Package size={64} class=\"text-primary opacity-50\" />\n               <button \n                  onClick={() => setSelectedProductInfo(null)}\n                  class=\"absolute top-4 right-4 p-2 bg-black/20 hover:bg-black/40 rounded-full text-white transition-colors\"\n               >\n                  <X size={16} />\n               </button>\n            </div>\n            \n            <div class=\"p-6\">\n               <div class=\"mb-6\">\n                  <h3 class=\"text-lg font-bold leading-tight\">{selectedProductInfo()!.nome}</h3>\n                  <p class=\"text-sm font-mono text-muted mt-1\">SKU: {selectedProductInfo()!.produto}</p>\n               </div>\n\n               <div class=\"grid grid-cols-2 gap-4 mb-6\">\n                  <div class=\"p-3 bg-secondary rounded-lg\">\n                     <p class=\"text-xs text-muted uppercase\">Vendas (30d)</p>\n                     <p class=\"text-xl font-bold text-foreground\">{selectedProductInfo()!.vendas.toLocaleString()}</p>\n                  </div>\n                  <div class=\"p-3 bg-green-500/10 rounded-lg\">\n                     <p class=\"text-xs text-green-700 dark:text-green-400 uppercase\">Status</p>\n                     <p class=\"text-xl font-bold text-green-700 dark:text-green-400\">Ativo</p>\n                  </div>\n               </div>\n\n               <div class=\"flex gap-3\">\n                  <button class=\"flex-1 btn btn-primary\" onClick={() => {\n                     const product = selectedProductInfo();\n                     if (product) {\n                        localStorage.setItem('example_query', `Analise detalhadamente o desempenho de vendas do produto \"${product.nome}\" (SKU: ${product.produto})`);\n                        navigate('/chat');\n                     }\n                  }}>\n                     Ver An\u00e1lise Completa\n                  </button>\n               </div>\n            </div>\n          </div>\n        </div>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 13843, "end_char_idx": 18470, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "69d8fc56-a8b3-4a84-9d95-ea38df5e5cba": {"__data__": {"id_": "69d8fc56-a8b3-4a84-9d95-ea38df5e5cba", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "cb6502a1-1650-4d3c-a04a-11a62afa999e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "hash": "d4adb32fa16ffb4b40a059c7b54b7e71bdbe0015c4e3e7d70f5720339512aa0c", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "26396f6e-0eee-4387-acc9-864a6bd4e9d1", "node_type": "1", "metadata": {}, "hash": "88fdbf25e4c8aae56ca23da804965c9b6f4172e510e468661b37dd3f585f294a", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, onMount, Show, For } from 'solid-js';\nimport { Database, Server, HardDrive, Activity, CheckCircle, AlertTriangle, RefreshCw, Settings, Play, FileText } from 'lucide-solid';\n\ninterface DBConfig {\n  use_sql_server: boolean;\n  use_supabase: boolean;\n  database_server: string | null;\n  database_name: string | null;\n  database_user: string | null;\n  supabase_url: string | null;\n}\n\ninterface ConnectionTestResult {\n  success: boolean;\n  message: string;\n  version: string | null;\n  tables: string[] | null;\n}\n\ninterface DBStatus {\n  parquet: {\n    status: string;\n    size_mb: number;\n    path: string;\n  };\n  sql_server: {\n    status: string;\n    url: string | null;\n  };\n  supabase: {\n    status: string;\n    url: string | null;\n  };\n}\n\nexport default function Diagnostics() {\n  const [dbStatus, setDbStatus] = createSignal<DBStatus | null>(null);\n  const [dbConfig, setDbConfig] = createSignal<DBConfig | null>(null);\n  const [testResult, setTestResult] = createSignal<ConnectionTestResult | null>(null);\n  const [isLoading, setIsLoading] = createSignal(true);\n  const [isTesting, setIsTesting] = createSignal(false);\n  const [error, setError] = createSignal<string | null>(null);\n\n  const loadDiagnostics = async () => {\n    setIsLoading(true);\n    setError(null);\n\n    try {\n      const token = localStorage.getItem('token');\n      if (!token) {\n        throw new Error('Token n\u00e3o encontrado. Fa\u00e7a login novamente.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1439, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "26396f6e-0eee-4387-acc9-864a6bd4e9d1": {"__data__": {"id_": "26396f6e-0eee-4387-acc9-864a6bd4e9d1", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "cb6502a1-1650-4d3c-a04a-11a62afa999e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "hash": "d4adb32fa16ffb4b40a059c7b54b7e71bdbe0015c4e3e7d70f5720339512aa0c", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "69d8fc56-a8b3-4a84-9d95-ea38df5e5cba", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "hash": "69b1c0013b3465a15bd169414b8d4c4438bc221a832c2760ba797f2596c7f5ec", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "09bb3549-1b4f-4373-b5b2-1825e814fffe", "node_type": "1", "metadata": {}, "hash": "0acd80646de93e77d995f313ba23462b2fe74484c3921b67885dba9452214f2c", "class_name": "RelatedNodeInfo"}}, "text": "Fa\u00e7a login novamente.');\n      }\n\n      const [statusRes, configRes] = await Promise.all([\n        fetch('/api/v1/diagnostics/db-status', {\n          headers: { 'Authorization': `Bearer ${token}` }\n        }),\n        fetch('/api/v1/diagnostics/config', {\n          headers: { 'Authorization': `Bearer ${token}` }\n        })\n      ]);\n\n      if (!statusRes.ok || !configRes.ok) {\n        throw new Error('Erro ao buscar informa\u00e7\u00f5es de diagn\u00f3stico');\n      }\n\n      const status = await statusRes.json();\n      const config = await configRes.json();\n\n      setDbStatus(status);\n      setDbConfig(config);\n    } catch (err: any) {\n      console.error('Erro ao carregar diagn\u00f3stico:', err);\n      setError(err.message || 'Erro ao conectar com o backend');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const testConnection = async () => {\n    setIsTesting(true);\n    setTestResult(null);\n\n    try {\n      const token = localStorage.getItem('token');\n      if (!token) {\n        throw new Error('Token n\u00e3o encontrado');\n      }\n\n      const response = await fetch('/api/v1/diagnostics/test-connection', {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        }\n      });\n\n      if (!response.ok) {\n        throw new Error('Erro ao testar conex\u00e3o');\n      }\n\n      const result = await response.json();\n      setTestResult(result);\n    } catch (err: any) {\n      setTestResult({\n        success: false,\n        message: err.message || 'Erro ao testar conex\u00e3o',\n        version: null,\n        tables: null\n      });\n    } finally {\n      setIsTesting(false);\n    }\n  };\n\n  onMount(() => {\n    loadDiagnostics();\n  });\n\n  const getStatusColor = (status: string) => {\n    if (status === 'ok' || status === 'enabled') {\n      return 'text-green-500 bg-green-500/10 border-green-500/30';\n    }\n    if (status === 'disabled') {\n      return 'text-yellow-500 bg-yellow-500/10 border-yellow-500/30';\n    }\n    return 'text-red-500 bg-red-500/10 border-red-500/30';\n  };\n\n  const getStatusIcon = (status: string) => {\n    if (status === 'ok' || status === 'enabled') {\n      return CheckCircle;\n    }\n    return AlertTriangle;\n  };\n\n  const getStatusLabel = (status: string) => {\n    if (status === 'ok') return 'OK';\n    if (status === 'enabled') return 'Habilitado';\n    if (status === 'disabled') return 'Desabilitado';\n    return 'Erro';\n  };\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6 max-w-7xl mx-auto\">\n      {/* Header */}\n      <div class=\"flex justify-between items-start\">\n        <div>\n          <h2 class=\"text-2xl font-bold tracking-tight flex items-center gap-2\">\n            <Activity size={24} />\n            Diagn\u00f3stico do Sistema\n          </h2>\n          <p class=\"text-muted mt-1\">Configura\u00e7\u00f5es e status das conex\u00f5es de banco de dados</p>\n        </div>\n        <button onClick={loadDiagnostics} class=\"btn btn-outline gap-2\" disabled={isLoading()}>\n          <RefreshCw size={16} class={isLoading() ?", "mimetype": "text/plain", "start_char_idx": 1418, "end_char_idx": 4441, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "09bb3549-1b4f-4373-b5b2-1825e814fffe": {"__data__": {"id_": "09bb3549-1b4f-4373-b5b2-1825e814fffe", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "cb6502a1-1650-4d3c-a04a-11a62afa999e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "hash": "d4adb32fa16ffb4b40a059c7b54b7e71bdbe0015c4e3e7d70f5720339512aa0c", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "26396f6e-0eee-4387-acc9-864a6bd4e9d1", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "hash": "aeebdebe6b0d57cd4ce301bd24c0bc63b36531ce3381a06ba130581d398f6652", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "0711f047-86b3-4bce-bb10-8f7480a47f46", "node_type": "1", "metadata": {}, "hash": "74473fbf7e54a441e02b6e3202b66dc4145fe9a4672203f86b61279b220b69c8", "class_name": "RelatedNodeInfo"}}, "text": "'animate-spin' : ''} />\n          Atualizar\n        </button>\n      </div>\n\n      {/* Error Alert */}\n      <Show when={error()}>\n        <div class=\"p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-300 flex items-center gap-3\">\n          <AlertTriangle size={24} />\n          <div>\n            <h3 class=\"font-bold\">Erro ao carregar diagn\u00f3stico</h3>\n            <p class=\"text-sm opacity-80\">{error()}</p>\n          </div>\n        </div>\n      </Show>\n\n      <Show when={!isLoading() && dbStatus() && dbConfig()} fallback={\n        <div class=\"p-12 text-center border rounded-xl bg-card text-muted animate-pulse\">\n          <RefreshCw class=\"animate-spin mx-auto mb-4\" size={32} />\n          Carregando informa\u00e7\u00f5es do sistema...\n        </div>\n      }>\n        {/* Status Cards */}\n        <div class=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div class=\"p-6 rounded-lg border bg-card\">\n            <div class=\"flex items-center justify-between mb-4\">\n              <span class=\"text-sm font-medium text-muted-foreground\">Parquet (Dados)</span>\n              <HardDrive size={18} class=\"text-blue-500\" />\n            </div>\n            <div class=\"flex flex-col gap-2\">\n              {(() => {\n                const status = dbStatus()?.parquet.status || 'unknown';\n                const StatusIcon = getStatusIcon(status);\n                return (\n                  <>\n                    <span class={`inline-flex items-center gap-2 rounded border px-3 py-1.5 text-sm font-medium ${getStatusColor(status)}`}>\n                      <StatusIcon size={16} />\n                      {getStatusLabel(status)}\n                    </span>\n                    <p class=\"text-xs text-muted-foreground mt-2\">\n                      Tamanho: <span class=\"font-mono font-medium\">{dbStatus()?.parquet.size_mb} MB</span>\n                    </p>\n                  </>\n                );\n              })()}\n            </div>\n          </div>\n\n          <div class=\"p-6 rounded-lg border bg-card\">\n            <div class=\"flex items-center justify-between mb-4\">\n              <span class=\"text-sm font-medium text-muted-foreground\">SQL Server</span>\n              <Database size={18} class=\"text-orange-500\" />\n            </div>\n            <div class=\"flex flex-col gap-2\">\n              {(() => {\n                const status = dbStatus()?.sql_server.status || 'unknown';\n                const StatusIcon = getStatusIcon(status);\n                return (\n                  <span class={`inline-flex items-center gap-2 rounded border px-3 py-1.5 text-sm font-medium ${getStatusColor(status)}`}>\n                    <StatusIcon size={16} />\n                    {getStatusLabel(status)}\n                  </span>\n                );\n              })()}\n            </div>\n          </div>\n\n          <div class=\"p-6 rounded-lg border bg-card\">\n            <div class=\"flex items-center justify-between mb-4\">\n              <span class=\"text-sm font-medium text-muted-foreground\">Supabase Auth</span>\n              <Server size={18} class=\"text-green-500\" />\n            </div>\n            <div class=\"flex flex-col gap-2\">\n              {(() => {\n                const status = dbStatus()?.supabase.status || 'unknown';\n                const StatusIcon = getStatusIcon(status);\n                return (\n                  <span class={`inline-flex items-center gap-2 rounded border px-3 py-1.5 text-sm font-medium ${getStatusColor(status)}`}>\n                    <StatusIcon size={16} />\n                    {getStatusLabel(status)}\n                  </span>\n                );\n              })()}\n            </div>\n          </div>\n        </div>\n\n        {/* Configura\u00e7\u00f5es Detectadas */}\n        <div class=\"p-6 rounded-lg border bg-card\">\n          <h3 class=\"font-semibold flex items-center gap-2 mb-4\">\n            <Settings size={18} />\n            Configura\u00e7\u00f5es Detectadas\n          </h3>\n\n          <div class=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <label class=\"text-xs text-muted-foreground font-medium\">Modo de Opera\u00e7\u00e3o</label>\n              <p class=\"font-mono text-sm mt-1 p-2 bg-secondary rounded\">\n                {dbConfig()?.use_sql_server ?", "mimetype": "text/plain", "start_char_idx": 4442, "end_char_idx": 8644, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "0711f047-86b3-4bce-bb10-8f7480a47f46": {"__data__": {"id_": "0711f047-86b3-4bce-bb10-8f7480a47f46", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "cb6502a1-1650-4d3c-a04a-11a62afa999e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "hash": "d4adb32fa16ffb4b40a059c7b54b7e71bdbe0015c4e3e7d70f5720339512aa0c", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "09bb3549-1b4f-4373-b5b2-1825e814fffe", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "hash": "d3fc027fdeff536992b4028ffdbfa938eeae226fef661328e7263f6f91563d37", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "63e6781b-049f-4c25-8153-8e18ee1b6c59", "node_type": "1", "metadata": {}, "hash": "b96c068bc8a28b72141b3564f00b43bf65b9b8e1a69dbcad24932717fae254c1", "class_name": "RelatedNodeInfo"}}, "text": "'SQL Server (H\u00edbrido)' : 'Apenas Parquet (Cloud)'}\n              </p>\n            </div>\n\n            <Show when={dbConfig()?.use_sql_server}>\n              <div>\n                <label class=\"text-xs text-muted-foreground font-medium\">Servidor SQL</label>\n                <p class=\"font-mono text-sm mt-1 p-2 bg-secondary rounded\">\n                  {dbConfig()?.database_server || 'N/A'}\n                </p>\n              </div>\n\n              <div>\n                <label class=\"text-xs text-muted-foreground font-medium\">Banco de Dados</label>\n                <p class=\"font-mono text-sm mt-1 p-2 bg-secondary rounded\">\n                  {dbConfig()?.database_name || 'N/A'}\n                </p>\n              </div>\n\n              <div>\n                <label class=\"text-xs text-muted-foreground font-medium\">Usu\u00e1rio SQL</label>\n                <p class=\"font-mono text-sm mt-1 p-2 bg-secondary rounded\">\n                  {dbConfig()?.database_user || 'N/A'}\n                </p>\n              </div>\n            </Show>\n\n            <Show when={dbConfig()?.use_supabase}>\n              <div>\n                <label class=\"text-xs text-muted-foreground font-medium\">Supabase URL</label>\n                <p class=\"font-mono text-sm mt-1 p-2 bg-secondary rounded truncate\">\n                  {dbConfig()?.supabase_url || 'N/A'}\n                </p>\n              </div>\n            </Show>\n\n            <div>\n              <label class=\"text-xs text-muted-foreground font-medium\">Path Parquet</label>\n              <p class=\"font-mono text-xs mt-1 p-2 bg-secondary rounded truncate\" title={dbStatus()?.parquet.path}>\n                {dbStatus()?.parquet.path || 'N/A'}\n              </p>\n            </div>\n          </div>\n        </div>\n\n        {/* Teste de Conex\u00e3o SQL Server */}\n        <Show when={dbConfig()?.use_sql_server}>\n          <div class=\"p-6 rounded-lg border bg-card\">\n            <div class=\"flex justify-between items-center mb-4\">\n              <h3 class=\"font-semibold flex items-center gap-2\">\n                <Play size={18} />\n                Teste de Conex\u00e3o SQL Server\n              </h3>\n              <button\n                onClick={testConnection}\n                class=\"btn btn-primary gap-2\"\n                disabled={isTesting()}\n              >\n                {isTesting() ? (\n                  <>\n                    <RefreshCw size={16} class=\"animate-spin\" />\n                    Testando...\n                  </>\n                ) : (\n                  <>\n                    <Play size={16} />\n                    Testar Conex\u00e3o\n                  </>\n                )}\n              </button>\n            </div>\n\n            <Show when={testResult()}>\n              <div class={`p-4 rounded-lg border ${testResult()?.success ? 'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30'}`}>\n                <div class=\"flex items-start gap-3\">\n                  {testResult()?.success ? (\n                    <CheckCircle size={24} class=\"text-green-500 flex-shrink-0\" />\n                  ) : (\n                    <AlertTriangle size={24} class=\"text-red-500 flex-shrink-0\" />\n                  )}\n                  <div class=\"flex-1\">\n                    <p class={`font-medium ${testResult()?.success ?", "mimetype": "text/plain", "start_char_idx": 8645, "end_char_idx": 11914, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "63e6781b-049f-4c25-8153-8e18ee1b6c59": {"__data__": {"id_": "63e6781b-049f-4c25-8153-8e18ee1b6c59", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "cb6502a1-1650-4d3c-a04a-11a62afa999e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "hash": "d4adb32fa16ffb4b40a059c7b54b7e71bdbe0015c4e3e7d70f5720339512aa0c", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "0711f047-86b3-4bce-bb10-8f7480a47f46", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}, "hash": "471be14001cdd39d3840aa72238f43fc5987f38ddd2968389b504752bdff4470", "class_name": "RelatedNodeInfo"}}, "text": "'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30'}`}>\n                <div class=\"flex items-start gap-3\">\n                  {testResult()?.success ? (\n                    <CheckCircle size={24} class=\"text-green-500 flex-shrink-0\" />\n                  ) : (\n                    <AlertTriangle size={24} class=\"text-red-500 flex-shrink-0\" />\n                  )}\n                  <div class=\"flex-1\">\n                    <p class={`font-medium ${testResult()?.success ? 'text-green-500' : 'text-red-500'}`}>\n                      {testResult()?.message}\n                    </p>\n\n                    <Show when={testResult()?.version}>\n                      <p class=\"text-sm text-muted-foreground mt-2\">\n                        Vers\u00e3o: <span class=\"font-mono\">{testResult()?.version}</span>\n                      </p>\n                    </Show>\n\n                    <Show when={testResult()?.tables && testResult()!.tables!.length > 0}>\n                      <div class=\"mt-3\">\n                        <p class=\"text-sm font-medium mb-2 flex items-center gap-2\">\n                          <FileText size={14} />\n                          Tabelas Dispon\u00edveis ({testResult()!.tables!.length})\n                        </p>\n                        <div class=\"max-h-48 overflow-y-auto bg-secondary/50 rounded p-2\">\n                          <div class=\"grid grid-cols-2 md:grid-cols-3 gap-1\">\n                            <For each={testResult()?.tables}>\n                              {(table) => (\n                                <span class=\"text-xs font-mono p-1 hover:bg-secondary rounded\">\n                                  {table}\n                                </span>\n                              )}\n                            </For>\n                          </div>\n                        </div>\n                      </div>\n                    </Show>\n                  </div>\n                </div>\n              </div>\n            </Show>\n          </div>\n        </Show>\n\n        {/* Instru\u00e7\u00f5es para Streamlit Cloud */}\n        <Show when={!dbConfig()?.use_sql_server}>\n          <div class=\"p-6 bg-blue-500/5 border border-blue-500/20 rounded-lg\">\n            <h4 class=\"font-semibold text-blue-500 mb-3\">Modo Cloud (Apenas Parquet)</h4>\n            <p class=\"text-sm text-muted-foreground mb-3\">\n              O sistema est\u00e1 rodando em modo cloud, usando apenas arquivos Parquet como fonte de dados.\n              Este \u00e9 o modo recomendado para deploy em Streamlit Cloud ou ambientes sem SQL Server.\n            </p>\n            <ul class=\"text-sm text-muted-foreground space-y-1 list-disc list-inside\">\n              <li>Autentica\u00e7\u00e3o: Parquet (users.parquet) ou Supabase</li>\n              <li>Dados anal\u00edticos: Parquet (admmat.parquet)</li>\n              <li>Performance: Otimizado para leitura em cache</li>\n              <li>Deploy: Compat\u00edvel com Streamlit Cloud</li>\n            </ul>\n          </div>\n        </Show>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 11420, "end_char_idx": 14417, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "31250343-d683-48fa-91c9-ad9d65346916": {"__data__": {"id_": "31250343-d683-48fa-91c9-ad9d65346916", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Examples.tsx", "language": "typescript", "lines": 175, "filename": "Examples.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6d1eb4e1-26e7-4182-8b2f-a301288f768e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Examples.tsx", "language": "typescript", "lines": 175, "filename": "Examples.tsx"}, "hash": "d5b4ad1b676dae92df0da44f57d13a6f5aa7fdda11f57f010147e11af791012a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "de782a34-5de6-470e-b8dd-6cf7fcf57549", "node_type": "1", "metadata": {}, "hash": "cd3466c24acd52c7b7595f9c33c8ff467de42771a6b133cf68fbbf3c856c1e47", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, For, Show } from 'solid-js';\nimport { Search, MessageSquare, TrendingUp, Package, DollarSign, AlertTriangle, BarChart3 } from 'lucide-solid';\nimport { useNavigate } from '@solidjs/router';\n\ninterface ExampleQuery {\n  id: number;\n  categoria: string;\n  pergunta: string;\n  icone: any;\n}\n\nconst CATEGORIAS = [\n  { nome: 'Todas', icone: MessageSquare },\n  { nome: 'Vendas', icone: TrendingUp },\n  { nome: 'Estoque', icone: Package },\n  { nome: 'Produtos', icone: BarChart3 },\n  { nome: 'Rupturas', icone: AlertTriangle },\n];\n\n// Perguntas baseadas nas colunas REAIS do admmat.parquet:\n// UNE, PRODUTO, NOME, UNE_NOME, NOMESEGMENTO, NOMECATEGORIA, NOMEFABRICANTE,\n// ESTOQUE_UNE, ESTOQUE_LV, ESTOQUE_CD, VENDA_30DD, PRECO_VENDA, SITUACAO\nconst EXAMPLE_QUERIES: ExampleQuery[] = [\n  // Categoria: Vendas (baseado em VENDA_30DD)\n  { id: 1, categoria: 'Vendas', pergunta: 'Quais os 10 produtos com maior VENDA_30DD?', icone: TrendingUp },\n  { id: 2, categoria: 'Vendas', pergunta: 'Qual o total de vendas da UNE 261?', icone: TrendingUp },\n  { id: 3, categoria: 'Vendas', pergunta: 'Mostre vendas agrupadas por NOMESEGMENTO', icone: TrendingUp },\n  { id: 4, categoria: 'Vendas', pergunta: 'Quais UNEs t\u00eam maior volume de VENDA_30DD?', icone: TrendingUp },\n  { id: 5, categoria: 'Vendas', pergunta: 'Liste produtos sem vendas nos \u00faltimos 30 dias', icone: TrendingUp },\n\n  // Categoria: Estoque (baseado em ESTOQUE_UNE, ESTOQUE_LV, ESTOQUE_CD)\n  { id: 6, categoria: 'Estoque', pergunta: 'Quais produtos t\u00eam ESTOQUE_UNE abaixo de 10?', icone: Package },\n  { id: 7, categoria: 'Estoque', pergunta: 'Mostre o total de ESTOQUE_UNE por UNE', icone: Package },\n  { id: 8, categoria: 'Estoque', pergunta: 'Liste produtos com ESTOQUE_UNE zerado', icone: Package },\n  { id: 9, categoria: 'Estoque', pergunta: 'Qual o estoque do CD (ESTOQUE_CD) por segmento?', icone: Package },\n  { id: 10, categoria: 'Estoque', pergunta: 'Produtos com ESTOQUE_UNE acima de 1000', icone: Package },\n\n  // Categoria: Produtos (baseado em NOMEFABRICANTE, NOMESEGMENTO, NOMECATEGORIA)\n  { id: 11, categoria: 'Produtos', pergunta: 'Quais produtos s\u00e3o do NOMEFABRICANTE igual a NESTLE?', icone: BarChart3 },\n  { id: 12, categoria: 'Produtos', pergunta: 'Liste produtos do NOMESEGMENTO HIGIENE', icone: BarChart3 },\n  { id: 13, categoria: 'Produtos', pergunta: 'Mostre a quantidade de produtos por NOMECATEGORIA', icone: BarChart3 },\n  { id: 14, categoria: 'Produtos', pergunta: 'Quais fabricantes t\u00eam mais produtos cadastrados?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2510, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "de782a34-5de6-470e-b8dd-6cf7fcf57549": {"__data__": {"id_": "de782a34-5de6-470e-b8dd-6cf7fcf57549", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Examples.tsx", "language": "typescript", "lines": 175, "filename": "Examples.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6d1eb4e1-26e7-4182-8b2f-a301288f768e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Examples.tsx", "language": "typescript", "lines": 175, "filename": "Examples.tsx"}, "hash": "d5b4ad1b676dae92df0da44f57d13a6f5aa7fdda11f57f010147e11af791012a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "31250343-d683-48fa-91c9-ad9d65346916", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Examples.tsx", "language": "typescript", "lines": 175, "filename": "Examples.tsx"}, "hash": "946923c26c356bc53844041f7885bdc41bdedf985394bcd0066cb8c0870337f4", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "41573d29-c330-446e-a7e7-50e87559ebf9", "node_type": "1", "metadata": {}, "hash": "6a4ad25548e5284accbcc699dff70221a09e0a79f5bd7c44378ec5daf8ec4b3f", "class_name": "RelatedNodeInfo"}}, "text": "', icone: BarChart3 },\n  { id: 12, categoria: 'Produtos', pergunta: 'Liste produtos do NOMESEGMENTO HIGIENE', icone: BarChart3 },\n  { id: 13, categoria: 'Produtos', pergunta: 'Mostre a quantidade de produtos por NOMECATEGORIA', icone: BarChart3 },\n  { id: 14, categoria: 'Produtos', pergunta: 'Quais fabricantes t\u00eam mais produtos cadastrados?', icone: BarChart3 },\n  { id: 15, categoria: 'Produtos', pergunta: 'Liste as UNE_NOME dispon\u00edveis no sistema', icone: BarChart3 },\n\n  // Categoria: Rupturas (baseado em compara\u00e7\u00e3o ESTOQUE_UNE vs ESTOQUE_LV)\n  { id: 16, categoria: 'Rupturas', pergunta: 'Produtos com ESTOQUE_UNE abaixo da linha verde (ESTOQUE_LV)', icone: AlertTriangle },\n  { id: 17, categoria: 'Rupturas', pergunta: 'Quais UNEs t\u00eam mais produtos em ruptura?', icone: AlertTriangle },\n  { id: 18, categoria: 'Rupturas', pergunta: 'Liste rupturas cr\u00edticas do NOMESEGMENTO ALIMENTOS', icone: AlertTriangle },\n  { id: 19, categoria: 'Rupturas', pergunta: 'Produtos da UNE 261 com estoque zerado', icone: AlertTriangle },\n  { id: 20, categoria: 'Rupturas', pergunta: 'Sugira transfer\u00eancias para resolver rupturas', icone: AlertTriangle },\n];\n\nexport default function Examples() {\n  const navigate = useNavigate();\n  const [categoriaAtiva, setCategoriaAtiva] = createSignal('Todas');\n  const [searchTerm, setSearchTerm] = createSignal('');\n\n  const perguntasFiltradas = () => {\n    let perguntas = EXAMPLE_QUERIES;\n\n    if (categoriaAtiva() !== 'Todas') {\n      perguntas = perguntas.filter(q => q.categoria === categoriaAtiva());\n    }\n\n    if (searchTerm()) {\n      const term = searchTerm().toLowerCase();\n      perguntas = perguntas.filter(q => q.pergunta.toLowerCase().includes(term));\n    }\n\n    return perguntas;\n  };\n\n  const handleTestarPergunta = (pergunta: string) => {\n    localStorage.setItem('example_query', pergunta);\n    navigate('/chat');\n  };\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6\">\n      {/* Header */}\n      <div>\n        <h2 class=\"text-2xl font-bold flex items-center gap-2\">\n          <MessageSquare size={28} />\n          Exemplos de Perguntas\n        </h2>\n        <p class=\"text-muted-foreground text-sm\">\n          Perguntas baseadas nas colunas reais: VENDA_30DD, ESTOQUE_UNE, NOMEFABRICANTE, etc.\n        </p>\n      </div>\n\n      {/* Search */}\n      <div class=\"relative\">\n        <Search size={20} class=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n        <input\n          type=\"text\"\n          class=\"w-full pl-10 pr-4 py-3 bg-card border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary\"\n          placeholder=\"Buscar perguntas...\"\n          value={searchTerm()}\n          onInput={(e) => setSearchTerm(e.currentTarget.value)}\n        />\n      </div>\n\n      {/* Categories */}\n      <div class=\"flex gap-2 flex-wrap\">\n        <For each={CATEGORIAS}>\n          {(cat) => {\n            const Icon = cat.icone;\n            return (\n              <button\n                onClick={() => setCategoriaAtiva(cat.nome)}\n                class={`px-4 py-2 rounded-lg flex items-center gap-2 transition-colors ${\n                  categoriaAtiva() === cat.nome\n                    ?", "mimetype": "text/plain", "start_char_idx": 2168, "end_char_idx": 5335, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "41573d29-c330-446e-a7e7-50e87559ebf9": {"__data__": {"id_": "41573d29-c330-446e-a7e7-50e87559ebf9", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Examples.tsx", "language": "typescript", "lines": 175, "filename": "Examples.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "6d1eb4e1-26e7-4182-8b2f-a301288f768e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Examples.tsx", "language": "typescript", "lines": 175, "filename": "Examples.tsx"}, "hash": "d5b4ad1b676dae92df0da44f57d13a6f5aa7fdda11f57f010147e11af791012a", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "de782a34-5de6-470e-b8dd-6cf7fcf57549", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Examples.tsx", "language": "typescript", "lines": 175, "filename": "Examples.tsx"}, "hash": "b1af9a92024d60a93be69114768f7a9bd55a5668b0cfb8e12d5d06144acf2c08", "class_name": "RelatedNodeInfo"}}, "text": "'bg-primary text-primary-foreground'\n                    : 'bg-secondary hover:bg-secondary/80'\n                }`}\n              >\n                <Icon size={16} />\n                {cat.nome}\n              </button>\n            );\n          }}\n        </For>\n      </div>\n\n      {/* Results */}\n      <div class=\"text-sm text-muted-foreground\">\n        {perguntasFiltradas().length} perguntas\n      </div>\n\n      {/* Grid */}\n      <div class=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-auto\">\n        <For each={perguntasFiltradas()}>\n          {(query) => {\n            const Icon = query.icone;\n            return (\n              <div \n                class=\"card p-4 border hover:border-primary/50 transition-all cursor-pointer group\"\n                onClick={() => handleTestarPergunta(query.pergunta)}\n              >\n                <div class=\"flex items-start gap-3\">\n                  <div class=\"p-2 bg-primary/10 text-primary rounded-lg\">\n                    <Icon size={20} />\n                  </div>\n                  <div class=\"flex-1\">\n                    <div class=\"text-xs text-muted-foreground mb-1\">{query.categoria}</div>\n                    <p class=\"text-sm\">{query.pergunta}</p>\n                  </div>\n                </div>\n              </div>\n            );\n          }}\n        </For>\n      </div>\n\n      <Show when={perguntasFiltradas().length === 0}>\n        <div class=\"flex-1 flex items-center justify-center\">\n          <div class=\"text-center\">\n            <Search size={48} class=\"mx-auto mb-4 opacity-20\" />\n            <p class=\"text-muted-foreground\">Nenhuma pergunta encontrada</p>\n            <button\n              onClick={() => {\n                setSearchTerm('');\n                setCategoriaAtiva('Todas');\n              }}\n              class=\"btn btn-outline mt-4\"\n            >\n              Limpar Filtros\n            </button>\n          </div>\n        </div>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 5336, "end_char_idx": 7301, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7fa11c02-225a-4511-93a9-130a72b4616b": {"__data__": {"id_": "7fa11c02-225a-4511-93a9-130a72b4616b", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "691115ece3459a854321b105016173f9fb6935f3b7dbfe87a9df3ad83ebd628b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e2f3bc36-1239-4a1e-8f17-3ef59b6839e2", "node_type": "1", "metadata": {}, "hash": "ff20b4004242c8145d21fe675fdb36dc115e3edc31f5650fc0a38475f8784ba4", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, For, Show } from 'solid-js';\nimport { HelpCircle, Book, AlertCircle, Database, Search, ChevronDown, ChevronUp } from 'lucide-solid';\nimport auth from '@/store/auth';\n\ntype TabType = 'guia' | 'faq' | 'troubleshooting' | 'dados';\n\ninterface FAQItem {\n  pergunta: string;\n  resposta: string;\n}\n\ninterface TroubleshootingItem {\n  problema: string;\n  solucao: string[];\n}\n\nexport default function Help() {\n  const [activeTab, setActiveTab] = createSignal<TabType>('guia');\n  const [searchTerm, setSearchTerm] = createSignal('');\n  const [expandedFAQ, setExpandedFAQ] = createSignal<number | null>(null);\n  \n  const isAdmin = () => auth.user()?.role === 'admin';\n\n  const FAQ_ITEMS: FAQItem[] = [\n    {\n      pergunta: 'Como fa\u00e7o para consultar produtos em ruptura?',\n      resposta: 'Navegue at\u00e9 a p\u00e1gina \"Rupturas Cr\u00edticas\" no menu Dashboards. Voc\u00ea ver\u00e1 uma lista completa de produtos em situa\u00e7\u00e3o cr\u00edtica, com filtros por segmento e UNE. Alternativamente, pergunte no Chat BI: \"Quais produtos est\u00e3o em ruptura cr\u00edtica?\"'\n    },\n    {\n      pergunta: 'Como solicitar uma transfer\u00eancia de estoque?',\n      resposta: 'Acesse a p\u00e1gina \"Transfer\u00eancias\" no menu Operacional. Selecione o modo de transfer\u00eancia (1\u21921, 1\u2192N ou N\u2192N), escolha o produto, UNE origem e destino, e adicione ao carrinho. O sistema validar\u00e1 automaticamente e mostrar\u00e1 alertas de prioridade.'\n    },\n    {\n      pergunta: 'O que significa \"Linha Verde\" e \"Linha Vermelha\"?',\n      resposta: 'Linha Verde (LV) \u00e9 o estoque m\u00ednimo recomendado. Linha Vermelha (LR) \u00e9 o estoque cr\u00edtico de seguran\u00e7a. Produtos abaixo da LV precisam de aten\u00e7\u00e3o. Abaixo da LR indicam ruptura iminente.'\n    },\n    {\n      pergunta: 'Como interpretar a criticidade % nas rupturas?',\n      resposta: 'A criticidade % representa o qu\u00e3o grave \u00e9 a ruptura. Valores acima de 80% indicam situa\u00e7\u00e3o URGENTE. Entre 50-80% \u00e9 ALTA prioridade. 20-50% \u00e9 M\u00c9DIA. Abaixo de 20% \u00e9 BAIXA. Baseia-se em vendas, estoque e hist\u00f3rico.'\n    },\n    {\n      pergunta: 'Posso exportar dados para Excel?',\n      resposta: 'Sim! Todas as p\u00e1ginas com tabelas (Rupturas, Transfers, Reports) possuem bot\u00e3o \"Download CSV\". No Chat BI, voc\u00ea pode solicitar dados e baix\u00e1-los usando o bot\u00e3o de download que aparece nas respostas tabulares.'\n    },\n    {\n      pergunta: 'Como funciona o sistema de aprendizado?',\n      resposta: 'O sistema aprende com feedbacks (\ud83d\udc4d \ud83d\udc4e) dados nas respostas do Chat BI. Acesse a p\u00e1gina \"Aprendizado\" para ver estat\u00edsticas de feedback, an\u00e1lise de erros e padr\u00f5es identificados. Isso ajuda a melhorar continuamente as respostas.'\n    },\n    {\n      pergunta: 'Qual a diferen\u00e7a entre \"Metrics\" e \"Analytics\"?',\n      resposta: 'Metrics mostra KPIs do sistema (cache, queries, tempo de resposta). Analytics mostra an\u00e1lises de neg\u00f3cio (vendas por categoria, giro de estoque, curva ABC). Use Metrics para monitorar performance t\u00e9cnica e Analytics para insights de neg\u00f3cio.'\n    },\n    {\n      pergunta: 'Posso testar o modelo Gemini sem afetar dados reais?',\n      resposta: 'Sim! Use a p\u00e1gina \"Playground\" no menu Intelig\u00eancia. L\u00e1 voc\u00ea pode testar o modelo com par\u00e2metros customizados (temperature, max tokens, JSON mode) sem impactar queries reais ou dados de produ\u00e7\u00e3o.'\n    },\n    {\n      pergunta: 'Como alterar minha senha?',\n      resposta: 'Acesse \"Alterar Senha\" no menu Sistema. Digite a senha atual, nova senha (m\u00ednimo 8 caracteres, com mai\u00fasculas, min\u00fasculas, n\u00fameros e caracteres especiais) e confirme.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3460, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e2f3bc36-1239-4a1e-8f17-3ef59b6839e2": {"__data__": {"id_": "e2f3bc36-1239-4a1e-8f17-3ef59b6839e2", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "691115ece3459a854321b105016173f9fb6935f3b7dbfe87a9df3ad83ebd628b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "7fa11c02-225a-4511-93a9-130a72b4616b", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "5a1163773d91639add7139f93dd2adba0606888ca64c70141e08cde9e92f808d", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "90efa031-8fe7-459a-a54f-9123318a6684", "node_type": "1", "metadata": {}, "hash": "4b1b38260572761970d8ddc3d482ea34e373286942adb7db3c2159cd80520440", "class_name": "RelatedNodeInfo"}}, "text": "Analytics mostra an\u00e1lises de neg\u00f3cio (vendas por categoria, giro de estoque, curva ABC). Use Metrics para monitorar performance t\u00e9cnica e Analytics para insights de neg\u00f3cio.'\n    },\n    {\n      pergunta: 'Posso testar o modelo Gemini sem afetar dados reais?',\n      resposta: 'Sim! Use a p\u00e1gina \"Playground\" no menu Intelig\u00eancia. L\u00e1 voc\u00ea pode testar o modelo com par\u00e2metros customizados (temperature, max tokens, JSON mode) sem impactar queries reais ou dados de produ\u00e7\u00e3o.'\n    },\n    {\n      pergunta: 'Como alterar minha senha?',\n      resposta: 'Acesse \"Alterar Senha\" no menu Sistema. Digite a senha atual, nova senha (m\u00ednimo 8 caracteres, com mai\u00fasculas, min\u00fasculas, n\u00fameros e caracteres especiais) e confirme. Voc\u00ea ser\u00e1 deslogado automaticamente ap\u00f3s a troca.'\n    },\n    {\n      pergunta: 'Administradores podem gerenciar usu\u00e1rios?',\n      resposta: 'Sim! Usu\u00e1rios admin t\u00eam acesso \u00e0 p\u00e1gina \"Administra\u00e7\u00e3o\" onde podem criar, editar, ativar/desativar e excluir usu\u00e1rios, al\u00e9m de gerenciar roles (admin, user, viewer) e sincronizar dados Parquet.'\n    }\n  ];\n\n  const TROUBLESHOOTING_ITEMS: TroubleshootingItem[] = [\n    {\n      problema: 'Chat BI n\u00e3o est\u00e1 respondendo ou demora muito',\n      solucao: [\n        'Verifique sua conex\u00e3o com a internet',\n        'Confirme que o backend est\u00e1 rodando (veja indicador de status)',\n        'Limpe o hist\u00f3rico do chat e tente novamente',\n        'Se persistir, acesse Diagn\u00f3stico DB para verificar conex\u00e3o com banco de dados',\n        'Verifique logs do sistema em /diagnostics'\n      ]\n    },\n    {\n      problema: 'Erro 401 - N\u00e3o autorizado',\n      solucao: [\n        'Seu token de autentica\u00e7\u00e3o expirou.", "mimetype": "text/plain", "start_char_idx": 2745, "end_char_idx": 4398, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "90efa031-8fe7-459a-a54f-9123318a6684": {"__data__": {"id_": "90efa031-8fe7-459a-a54f-9123318a6684", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "691115ece3459a854321b105016173f9fb6935f3b7dbfe87a9df3ad83ebd628b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "e2f3bc36-1239-4a1e-8f17-3ef59b6839e2", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "f2d3f58a8d7879009c39bee7b45511a509827635e59ffc42a27f250a09d99865", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b0489814-f6e0-400b-ac1c-e46a7c8312d7", "node_type": "1", "metadata": {}, "hash": "f737b22f490c9660738f423ceacbcfdf1696dbba75177820701b04f56e35e7c9", "class_name": "RelatedNodeInfo"}}, "text": "}\n  ];\n\n  const TROUBLESHOOTING_ITEMS: TroubleshootingItem[] = [\n    {\n      problema: 'Chat BI n\u00e3o est\u00e1 respondendo ou demora muito',\n      solucao: [\n        'Verifique sua conex\u00e3o com a internet',\n        'Confirme que o backend est\u00e1 rodando (veja indicador de status)',\n        'Limpe o hist\u00f3rico do chat e tente novamente',\n        'Se persistir, acesse Diagn\u00f3stico DB para verificar conex\u00e3o com banco de dados',\n        'Verifique logs do sistema em /diagnostics'\n      ]\n    },\n    {\n      problema: 'Erro 401 - N\u00e3o autorizado',\n      solucao: [\n        'Seu token de autentica\u00e7\u00e3o expirou. Fa\u00e7a logout e login novamente',\n        'Limpe o localStorage do navegador (F12 > Application > Local Storage)',\n        'Verifique se seu usu\u00e1rio est\u00e1 ativo (pe\u00e7a a um admin verificar)',\n        'Se problema persistir, contate o administrador do sistema'\n      ]\n    },\n    {\n      problema: 'Dados n\u00e3o aparecem ou est\u00e3o desatualizados',\n      solucao: [\n        'Clique no bot\u00e3o \"Atualizar\" (\u00edcone \u27f3) no topo da p\u00e1gina',\n        'Acesse Admin > Sincroniza\u00e7\u00e3o para sincronizar dados SQL Server \u2192 Parquet',\n        'Verifique se voc\u00ea tem permiss\u00e3o para acessar os dados (role necess\u00e1ria)',\n        'Limpe cache do navegador (Ctrl+Shift+Delete)',\n        'Verifique diagn\u00f3stico DB para status da conex\u00e3o'\n      ]\n    },\n    {\n      problema: 'Gr\u00e1ficos n\u00e3o s\u00e3o exibidos corretamente',\n      solucao: [\n        'Atualize a p\u00e1gina (F5)',\n        'Verifique se JavaScript est\u00e1 habilitado no navegador',\n        'Tente em modo an\u00f4nimo/privado para descartar extens\u00f5es',\n        'Use navegador moderno (Chrome, Firefox, Edge atualizados)',\n        'Verifique console do navegador (F12) para erros'\n      ]\n    },\n    {\n      problema: 'N\u00e3o consigo criar transfer\u00eancia - valida\u00e7\u00e3o falha',\n      solucao: [\n        'Verifique se o produto existe e tem estoque na UNE origem',\n        'Confirme que a quantidade solicitada \u00e9 v\u00e1lida (> 0)',\n        'Verifique se a UNE destino pode receber o produto',\n        'Alguns produtos podem ter restri\u00e7\u00f5es de transfer\u00eancia',\n        'Consulte a mensagem de erro detalhada retornada pelo sistema'\n      ]\n    },\n    {\n      problema: 'P\u00e1gina Admin n\u00e3o est\u00e1 acess\u00edvel',\n      solucao: [\n        'Verifique se seu usu\u00e1rio tem role \"admin\"',\n        'Fa\u00e7a logout e login novamente para atualizar permiss\u00f5es',\n        'Se voc\u00ea \u00e9 admin mas n\u00e3o consegue acessar, contate suporte t\u00e9cnico',\n        'Verifique se a URL est\u00e1 correta: /admin'\n      ]\n    },\n    {\n      problema: 'Download CSV falha ou arquivo vazio',\n      solucao: [\n        'Aplique filtros para reduzir quantidade de dados',\n        'Verifique se h\u00e1 dados dispon\u00edveis na tabela',\n        'Tente atualizar dados antes de exportar',\n        'Desabilite bloqueador de pop-ups no navegador',\n        'Verifique permiss\u00f5es de escrita na pasta Downloads'\n      ]\n    }\n  ];\n\n  const filteredFAQ = () => {\n    if (!searchTerm()) return FAQ_ITEMS;\n    const term = searchTerm().toLowerCase();\n    return FAQ_ITEMS.filter(item =>\n      item.pergunta.toLowerCase().includes(term) ||\n      item.resposta.toLowerCase().includes(term)\n    );\n  };\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6\">\n      {/* Header */}\n      <div>\n        <h2 class=\"text-2xl font-bold flex items-center gap-2\">\n          <HelpCircle size={28} />\n          Central de Ajuda\n        </h2>\n        <p class=\"text-muted\">Documenta\u00e7\u00e3o, FAQ e guias de uso do sistema</p>\n      </div>\n\n      {/* Tabs */}\n      <div class=\"border-b\">\n        <div class=\"flex gap-1\">\n          <button\n            onClick={() => setActiveTab('guia')}\n            class={`px-4 py-2 font-medium transition-colors ${\n              activeTab() === 'guia'\n                ?", "mimetype": "text/plain", "start_char_idx": 3802, "end_char_idx": 7515, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b0489814-f6e0-400b-ac1c-e46a7c8312d7": {"__data__": {"id_": "b0489814-f6e0-400b-ac1c-e46a7c8312d7", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "691115ece3459a854321b105016173f9fb6935f3b7dbfe87a9df3ad83ebd628b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "90efa031-8fe7-459a-a54f-9123318a6684", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "bb274c06e4a8caa6c1cb1f1d1058f472f2f8af3285bbb35cd610106b0ebccf65", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "577b19c8-5d7c-4959-93c9-aae14a9c859b", "node_type": "1", "metadata": {}, "hash": "9c94470a352ea3e22c9c50a421815e818ac94c3aa98412489a72d86d73fb2cd8", "class_name": "RelatedNodeInfo"}}, "text": "'border-b-2 border-primary text-primary'\n                : 'text-muted hover:text-foreground'\n            }`}\n          >\n            <div class=\"flex items-center gap-2\">\n              <Book size={16} />\n              Guia R\u00e1pido\n            </div>\n          </button>\n\n          <button\n            onClick={() => setActiveTab('faq')}\n            class={`px-4 py-2 font-medium transition-colors ${\n              activeTab() === 'faq'\n                ? 'border-b-2 border-primary text-primary'\n                : 'text-muted hover:text-foreground'\n            }`}\n          >\n            <div class=\"flex items-center gap-2\">\n              <HelpCircle size={16} />\n              FAQ\n            </div>\n          </button>\n\n          <Show when={isAdmin()}>\n            <button\n              onClick={() => setActiveTab('troubleshooting')}\n              class={`px-4 py-2 font-medium transition-colors ${\n                activeTab() === 'troubleshooting'\n                  ? 'border-b-2 border-primary text-primary'\n                  : 'text-muted hover:text-foreground'\n              }`}\n            >\n              <div class=\"flex items-center gap-2\">\n                <AlertCircle size={16} />\n                Troubleshooting\n              </div>\n            </button>\n\n            <button\n              onClick={() => setActiveTab('dados')}\n              class={`px-4 py-2 font-medium transition-colors ${\n                activeTab() === 'dados'\n                  ? 'border-b-2 border-primary text-primary'\n                  : 'text-muted hover:text-foreground'\n              }`}\n            >\n              <div class=\"flex items-center gap-2\">\n                <Database size={16} />\n                Dados Dispon\u00edveis\n              </div>\n            </button>\n          </Show>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div class=\"flex-1 overflow-auto\">\n        {/* Tab: Guia R\u00e1pido */}\n        <Show when={activeTab() === 'guia'}>\n          <div class=\"max-w-4xl mx-auto space-y-6\">\n            <div class=\"card p-6 border\">\n              <h3 class=\"text-xl font-bold mb-4\">\ud83d\ude80 Primeiros Passos</h3>\n              <ol class=\"list-decimal list-inside space-y-3 text-sm leading-relaxed\">\n                <li><strong>Login:</strong> Use suas credenciais corporativas. Ap\u00f3s autentica\u00e7\u00e3o, voc\u00ea ser\u00e1 redirecionado para o Dashboard.</li>\n                <li><strong>Dashboard:</strong> Visualize KPIs de neg\u00f3cio (total de produtos, UNEs, rupturas, valor de estoque) e gr\u00e1ficos principais.</li>\n                <li><strong>Chat BI:</strong> Fa\u00e7a perguntas em linguagem natural. Ex: \"Quais os 10 produtos mais vendidos?\"", "mimetype": "text/plain", "start_char_idx": 7516, "end_char_idx": 10147, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "577b19c8-5d7c-4959-93c9-aae14a9c859b": {"__data__": {"id_": "577b19c8-5d7c-4959-93c9-aae14a9c859b", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "691115ece3459a854321b105016173f9fb6935f3b7dbfe87a9df3ad83ebd628b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b0489814-f6e0-400b-ac1c-e46a7c8312d7", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "4ddcc14d160bb21fe4a3debedfc92b248c1ed6d5239c22e76f37e6e5e711e4db", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e95a2112-139c-4f41-ae26-d0416cd69b65", "node_type": "1", "metadata": {}, "hash": "494ebd80dda72b1846df732778965c0452caf883e70583cd7decbb31814c2d3d", "class_name": "RelatedNodeInfo"}}, "text": "Ap\u00f3s autentica\u00e7\u00e3o, voc\u00ea ser\u00e1 redirecionado para o Dashboard.</li>\n                <li><strong>Dashboard:</strong> Visualize KPIs de neg\u00f3cio (total de produtos, UNEs, rupturas, valor de estoque) e gr\u00e1ficos principais.</li>\n                <li><strong>Chat BI:</strong> Fa\u00e7a perguntas em linguagem natural. Ex: \"Quais os 10 produtos mais vendidos?\" ou \"Mostre rupturas do segmento X\".</li>\n                <li><strong>Rupturas:</strong> Acesse produtos cr\u00edticos, filtre por segmento/UNE, e exporte relat\u00f3rios CSV.</li>\n                <li><strong>Transfer\u00eancias:</strong> Solicite movimenta\u00e7\u00e3o de estoque entre UNEs com valida\u00e7\u00e3o autom\u00e1tica de prioridade.</li>\n              </ol>\n            </div>\n\n            <div class=\"card p-6 border\">\n              <h3 class=\"text-xl font-bold mb-4\">\ud83d\udcac Dicas para usar o Chat BI</h3>\n              <ul class=\"list-disc list-inside space-y-2 text-sm leading-relaxed\">\n                <li>Seja espec\u00edfico: \"Produtos com vendas acima de 1000 unidades no segmento Alimenta\u00e7\u00e3o\"</li>\n                <li>Use filtros: \"Mostre estoque da UNE 42 abaixo da linha verde\"</li>\n                <li>Solicite gr\u00e1ficos: \"Crie um gr\u00e1fico de vendas por categoria\"</li>\n                <li>Compare dados: \"Compare vendas de janeiro vs fevereiro\"</li>\n                <li>D\u00ea feedback: Use \ud83d\udc4d \ud83d\udc4e para melhorar o sistema</li>\n                <li>Explore exemplos: Acesse \"Exemplos\" no menu para 80 perguntas pr\u00e9-definidas</li>\n              </ul>\n            </div>\n\n            <div class=\"card p-6 border\">\n              <h3 class=\"text-xl font-bold mb-4\">\ud83c\udfaf Funcionalidades Principais</h3>\n              <div class=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm\">\n                <div class=\"p-4 bg-secondary rounded-lg\">\n                  <strong class=\"text-primary\">\ud83d\udcca Dashboards</strong>\n                  <p class=\"text-muted mt-1\">Monitoramento, M\u00e9tricas e Rupturas Cr\u00edticas com KPIs em tempo real</p>\n                </div>\n                <div class=\"p-4 bg-secondary rounded-lg\">\n                  <strong class=\"text-primary\">\ud83d\ude9a Operacional</strong>\n                  <p class=\"text-muted mt-1\">Transfer\u00eancias e Relat\u00f3rios com valida\u00e7\u00e3o e hist\u00f3rico completo</p>\n                </div>\n                <div class=\"p-4 bg-secondary rounded-lg\">\n                  <strong class=\"text-primary\">\ud83e\udd16 Intelig\u00eancia</strong>\n                  <p class=\"text-muted mt-1\">Chat BI, Exemplos, Aprendizado e Playground para testes</p>\n                </div>\n                <div class=\"p-4 bg-secondary rounded-lg\">\n                  <strong class=\"text-primary\">\u2699\ufe0f Sistema</strong>\n                  <p class=\"text-muted mt-1\">Diagn\u00f3stico DB, Alterar Senha e Administra\u00e7\u00e3o de usu\u00e1rios</p>\n                </div>\n              </div>\n            </div>\n          </div>\n        </Show>\n\n        {/* Tab: FAQ */}\n        <Show when={activeTab() === 'faq'}>\n          <div class=\"max-w-4xl mx-auto space-y-4\">\n            {/* Search */}\n            <div class=\"relative\">\n              <Search size={20} class=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted\" />\n              <input\n                type=\"text\"\n                class=\"w-full pl-10 pr-4 py-3 bg-card border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary\"\n                placeholder=\"Buscar perguntas...\"\n                value={searchTerm()}\n                onInput={(e) => setSearchTerm(e.currentTarget.value)}\n              />\n            </div>\n\n            {/* FAQ List */}\n            <div class=\"space-y-2\">\n              <For each={filteredFAQ()}>\n                {(item, index) => (\n                  <div class=\"card border\">\n                    <button\n                      onClick={() => setExpandedFAQ(expandedFAQ() === index() ?", "mimetype": "text/plain", "start_char_idx": 9801, "end_char_idx": 13535, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e95a2112-139c-4f41-ae26-d0416cd69b65": {"__data__": {"id_": "e95a2112-139c-4f41-ae26-d0416cd69b65", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "691115ece3459a854321b105016173f9fb6935f3b7dbfe87a9df3ad83ebd628b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "577b19c8-5d7c-4959-93c9-aae14a9c859b", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "9352255712cd58c4d8ef5c5b6cbe0a9c5e3fae7e33698d1fbe0410f65e661d89", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "5578c71b-544f-40e8-94d6-7f959893f695", "node_type": "1", "metadata": {}, "hash": "42d97dd877ed310028e7ca63b45cf7f35b1a2e98ee37ad3b47c5dcb3123ed150", "class_name": "RelatedNodeInfo"}}, "text": "null : index())}\n                      class=\"w-full p-4 text-left flex items-center justify-between hover:bg-secondary/50 transition-colors\"\n                    >\n                      <span class=\"font-semibold\">{item.pergunta}</span>\n                      <Show\n                        when={expandedFAQ() === index()}\n                        fallback={<ChevronDown size={20} class=\"text-muted\" />}\n                      >\n                        <ChevronUp size={20} class=\"text-primary\" />\n                      </Show>\n                    </button>\n                    <Show when={expandedFAQ() === index()}>\n                      <div class=\"px-4 pb-4 text-sm text-muted leading-relaxed border-t pt-4\">\n                        {item.resposta}\n                      </div>\n                    </Show>\n                  </div>\n                )}\n              </For>\n            </div>\n\n            <Show when={filteredFAQ().length === 0}>\n              <div class=\"text-center p-12\">\n                <Search size={48} class=\"mx-auto mb-4 opacity-20\" />\n                <p class=\"text-muted\">Nenhuma pergunta encontrada</p>\n              </div>\n            </Show>\n          </div>\n        </Show>\n\n        {/* Tab: Troubleshooting */}\n        <Show when={activeTab() === 'troubleshooting' && isAdmin()}>\n          <div class=\"max-w-4xl mx-auto space-y-4\">\n            <For each={TROUBLESHOOTING_ITEMS}>\n              {(item) => (\n                <div class=\"card p-6 border\">\n                  <div class=\"flex items-start gap-3 mb-4\">\n                    <div class=\"p-2 bg-red-500/10 text-red-500 rounded\">\n                      <AlertCircle size={20} />\n                    </div>\n                    <h4 class=\"font-bold text-lg flex-1\">{item.problema}</h4>\n                  </div>\n                  <div class=\"pl-11\">\n                    <div class=\"text-sm font-medium text-primary mb-2\">Solu\u00e7\u00f5es:</div>\n                    <ol class=\"list-decimal list-inside space-y-1 text-sm text-muted\">\n                      <For each={item.solucao}>\n                        {(solucao) => <li>{solucao}</li>}\n                      </For>\n                    </ol>\n                  </div>\n                </div>\n              )}\n            </For>\n          </div>\n        </Show>\n\n        {/* Tab: Dados Dispon\u00edveis */}\n        <Show when={activeTab() === 'dados' && isAdmin()}>\n          <div class=\"max-w-4xl mx-auto space-y-6\">\n            <div class=\"card p-6 border\">\n              <h3 class=\"text-xl font-bold mb-4 flex items-center gap-2\">\n                <Database size={24} />\n                Estrutura de Dados\n              </h3>\n              <p class=\"text-sm text-muted mb-4\">\n                O sistema utiliza dados de produtos, vendas e estoque armazenados em arquivos Parquet.", "mimetype": "text/plain", "start_char_idx": 13536, "end_char_idx": 16332, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5578c71b-544f-40e8-94d6-7f959893f695": {"__data__": {"id_": "5578c71b-544f-40e8-94d6-7f959893f695", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "bd027c39-9dc5-4d34-acde-f4c416dabc22", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "691115ece3459a854321b105016173f9fb6935f3b7dbfe87a9df3ad83ebd628b", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "e95a2112-139c-4f41-ae26-d0416cd69b65", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}, "hash": "f87d7386bde980f0b832e25d3bc5eb81e2c6e5013c518f4bfcb23324b974b9b2", "class_name": "RelatedNodeInfo"}}, "text": "Principal fonte: <code class=\"px-2 py-1 bg-secondary rounded\">admmat.parquet</code>\n              </p>\n\n              <div class=\"space-y-4\">\n                <div>\n                  <h4 class=\"font-semibold mb-2\">\ud83d\udce6 Campos Principais</h4>\n                  <div class=\"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm\">\n                    <div class=\"p-2 bg-secondary rounded\"><code>PRODUTO</code> - C\u00f3digo do produto</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>NOME</code> - Nome do produto</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>UNE</code> - Unidade de neg\u00f3cio</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>CATEGORIA</code> - Categoria do produto</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>SEGMENTO</code> - Segmento comercial</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>FABRICANTE</code> - Fabricante/marca</div>\n                  </div>\n                </div>\n\n                <div>\n                  <h4 class=\"font-semibold mb-2\">\ud83d\udcca Estoque</h4>\n                  <div class=\"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm\">\n                    <div class=\"p-2 bg-secondary rounded\"><code>ESTOQUE_LOJA</code> - Estoque na UNE</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>ESTOQUE_CD</code> - Estoque no Centro de Distribui\u00e7\u00e3o</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>ESTOQUE_LV</code> - Linha Verde (m\u00ednimo)</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>ESTOQUE_LR</code> - Linha Vermelha (cr\u00edtico)</div>\n                  </div>\n                </div>\n\n                <div>\n                  <h4 class=\"font-semibold mb-2\">\ud83d\udcb0 Vendas e Valores</h4>\n                  <div class=\"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm\">\n                    <div class=\"p-2 bg-secondary rounded\"><code>VENDA_30DD</code> - Vendas \u00faltimos 30 dias</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>VENDA_90DD</code> - Vendas \u00faltimos 90 dias</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>PRECO_VENDA</code> - Pre\u00e7o de venda</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>CUSTO</code> - Custo do produto</div>\n                  </div>\n                </div>\n\n                <div>\n                  <h4 class=\"font-semibold mb-2\">\ud83d\udcc8 M\u00e9tricas Calculadas</h4>\n                  <div class=\"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm\">\n                    <div class=\"p-2 bg-secondary rounded\"><code>CRITICIDADE_PCT</code> - % de criticidade de ruptura</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>NECESSIDADE</code> - Quantidade necess\u00e1ria para reposi\u00e7\u00e3o</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>GIRO_ESTOQUE</code> - Taxa de giro (vendas/estoque)</div>\n                    <div class=\"p-2 bg-secondary rounded\"><code>MARGEM</code> - Margem de lucro</div>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div class=\"card p-6 border bg-blue-500/5 border-blue-500/30\">\n              <h4 class=\"font-semibold mb-2 text-blue-400\">\ud83d\udca1 Dica para Desenvolvedores</h4>\n              <p class=\"text-sm text-muted leading-relaxed\">\n                Para consultar o schema completo dos dados Parquet, acesse a p\u00e1gina <strong>Diagn\u00f3stico DB</strong> no menu Sistema.\n                L\u00e1 voc\u00ea encontrar\u00e1 informa\u00e7\u00f5es detalhadas sobre colunas, tipos de dados e estat\u00edsticas das tabelas dispon\u00edveis.\n              </p>\n            </div>\n          </div>\n        </Show>\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 16349, "end_char_idx": 20001, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2cd5fbbd-cdfb-4992-b941-b7b2d8bc0f9c": {"__data__": {"id_": "2cd5fbbd-cdfb-4992-b941-b7b2d8bc0f9c", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "hash": "ec8652f334691402b841696a210c6156b28f1688ab2cf306bdd1176bdc50d7a0", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "eba33f6b-013c-4e1e-b9bb-9cab2b603bf1", "node_type": "1", "metadata": {}, "hash": "c7c869d43c9d87a94ef97fba3e66fa85f86bfe5b266e4f18ebf7f76249034451", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, onMount, Show, For } from 'solid-js';\nimport { BrainCircuit, ThumbsUp, ThumbsDown, AlertTriangle, TrendingUp, Search, BarChart3 } from 'lucide-solid';\nimport api from '../lib/api';\n\n// Types\ninterface FeedbackStats {\n  total_feedback: number;\n  positive: number;\n  negative: number;\n  partial: number;\n  success_rate: number;\n  problematic_queries: Array<{\n    query: string;\n    feedback_type: string;\n    timestamp: string;\n  }>;\n}\n\ninterface ErrorAnalysis {\n  total_errors: number;\n  error_types: Record<string, number>;\n  error_details: Array<{\n    error_type: string;\n    count: number;\n    suggestion: string;\n  }>;\n}\n\ninterface Pattern {\n  id: number;\n  keywords: string[];\n  pattern: string;\n  examples: string[];\n  success_count: number;\n}\n\ninterface PatternsResponse {\n  total_patterns: number;\n  patterns: Pattern[];\n}\n\ntype TabType = 'feedback' | 'errors' | 'patterns';\n\nexport default function Learning() {\n  const [activeTab, setActiveTab] = createSignal<TabType>('feedback');\n  const [loading, setLoading] = createSignal(true);\n  const [error, setError] = createSignal<string | null>(null);\n\n  // Data states\n  const [feedbackStats, setFeedbackStats] = createSignal<FeedbackStats | null>(null);\n  const [errorAnalysis, setErrorAnalysis] = createSignal<ErrorAnalysis | null>(null);\n  const [patterns, setPatterns] = createSignal<PatternsResponse | null>(null);\n\n  // Search\n  const [searchTerm, setSearchTerm] = createSignal('');\n\n  const loadData = async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const [feedbackRes, errorsRes, patternsRes] = await Promise.all([\n        api.get<FeedbackStats>('/learning/feedback-stats'),\n        api.get<ErrorAnalysis>('/learning/error-analysis'),\n        api.get<PatternsResponse>('/learning/patterns')\n      ]);\n\n      setFeedbackStats(feedbackRes.data);\n      setErrorAnalysis(errorsRes.data);\n      setPatterns(patternsRes.data);\n    } catch (err: any) {\n      console.error('Erro ao carregar dados de aprendizado:', err);\n      setError(err.response?.data?.detail || 'Erro ao carregar dados');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const searchPatterns = async () => {\n    if (!searchTerm()) {\n      loadData();\n      return;\n    }\n\n    try {\n      const response = await api.get<PatternsResponse>(`/learning/patterns?search=${encodeURIComponent(searchTerm())}`);\n      setPatterns(response.data);\n    } catch (err: any) {\n      console.error('Erro ao buscar padr\u00f5es:', err);\n    }\n  };\n\n  onMount(() => {\n    loadData();\n  });\n\n  const getSuccessRateColor = (rate: number) => {\n    if (rate >= 80) return 'text-green-500';\n    if (rate >= 60) return 'text-yellow-500';\n    return 'text-red-500';\n  };\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6\">\n      {/* Header */}\n      <div>\n        <h2 class=\"text-2xl font-bold flex items-center gap-2\">\n          <BrainCircuit size={28} />\n          Sistema de Aprendizado\n        </h2>\n        <p class=\"text-muted\">An\u00e1lise de feedback, erros e padr\u00f5es de uso do assistente BI</p>\n      </div>\n\n      {/* Error State */}\n      <Show when={error()}>\n        <div class=\"card p-4 border-red-500 bg-red-500/10\">\n          <div class=\"flex items-center gap-2 text-red-500\">\n            <AlertTriangle size={20} />\n            <span>{error()}</span>\n          </div>\n        </div>\n      </Show>\n\n      {/* Tabs */}\n      <div class=\"border-b\">\n        <div class=\"flex gap-1\">\n          <button\n            class={`px-4 py-2 font-medium transition-colors ${\n              activeTab() === 'feedback'\n                ? 'border-b-2 border-primary text-primary'\n                : 'text-muted hover:text-foreground'\n            }`}\n            onClick={() => setActiveTab('feedback')}\n          >\n            <div class=\"flex items-center gap-2\">\n              <ThumbsUp size={16} />\n              Feedback\n            </div>\n          </button>\n\n          <button\n            class={`px-4 py-2 font-medium transition-colors ${\n              activeTab() === 'errors'\n                ?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4053, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "eba33f6b-013c-4e1e-b9bb-9cab2b603bf1": {"__data__": {"id_": "eba33f6b-013c-4e1e-b9bb-9cab2b603bf1", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "hash": "ec8652f334691402b841696a210c6156b28f1688ab2cf306bdd1176bdc50d7a0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2cd5fbbd-cdfb-4992-b941-b7b2d8bc0f9c", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "hash": "7bffdb28ff8337cf4248e9768f42056008c78c83270b4ef7e32c6cf6731d032a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "05a2fab3-c692-4fef-bad1-98bd5b474bd9", "node_type": "1", "metadata": {}, "hash": "99615a35b75995b2ea7f2f223e80aeaac9452285ea9811b7183d5611012d6b48", "class_name": "RelatedNodeInfo"}}, "text": "'border-b-2 border-primary text-primary'\n                : 'text-muted hover:text-foreground'\n            }`}\n            onClick={() => setActiveTab('feedback')}\n          >\n            <div class=\"flex items-center gap-2\">\n              <ThumbsUp size={16} />\n              Feedback\n            </div>\n          </button>\n\n          <button\n            class={`px-4 py-2 font-medium transition-colors ${\n              activeTab() === 'errors'\n                ? 'border-b-2 border-primary text-primary'\n                : 'text-muted hover:text-foreground'\n            }`}\n            onClick={() => setActiveTab('errors')}\n          >\n            <div class=\"flex items-center gap-2\">\n              <AlertTriangle size={16} />\n              Erros\n            </div>\n          </button>\n\n          <button\n            class={`px-4 py-2 font-medium transition-colors ${\n              activeTab() === 'patterns'\n                ? 'border-b-2 border-primary text-primary'\n                : 'text-muted hover:text-foreground'\n            }`}\n            onClick={() => setActiveTab('patterns')}\n          >\n            <div class=\"flex items-center gap-2\">\n              <TrendingUp size={16} />\n              Padr\u00f5es\n            </div>\n          </button>\n        </div>\n      </div>\n\n      {/* Loading State */}\n      <Show when={loading()}>\n        <div class=\"flex-1 flex items-center justify-center\">\n          <div class=\"text-center\">\n            <BrainCircuit size={48} class=\"mx-auto mb-4 opacity-50 animate-pulse\" />\n            <p class=\"text-muted\">Carregando dados.</p>\n          </div>\n        </div>\n      </Show>\n\n      {/* Content */}\n      <Show when={!loading()}>\n        {/* Tab: Feedback */}\n        <Show when={activeTab() === 'feedback'}>\n          <Show when={feedbackStats()}>\n            <div class=\"space-y-6\">\n              {/* KPIs */}\n              <div class=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                <div class=\"card p-4 border\">\n                  <div class=\"text-sm text-muted mb-1\">Total de Feedback</div>\n                  <div class=\"text-2xl font-bold\">{feedbackStats()!.total_feedback}</div>\n                </div>\n\n                <div class=\"card p-4 border border-green-500/30 bg-green-500/5\">\n                  <div class=\"text-sm text-muted mb-1\">Positivos</div>\n                  <div class=\"text-2xl font-bold text-green-500\">\n                    {feedbackStats()!.positive}\n                  </div>\n                </div>\n\n                <div class=\"card p-4 border border-red-500/30 bg-red-500/5\">\n                  <div class=\"text-sm text-muted mb-1\">Negativos</div>\n                  <div class=\"text-2xl font-bold text-red-500\">\n                    {feedbackStats()!.negative}\n                  </div>\n                </div>\n\n                <div class=\"card p-4 border border-yellow-500/30 bg-yellow-500/5\">\n                  <div class=\"text-sm text-muted mb-1\">Parciais</div>\n                  <div class=\"text-2xl font-bold text-yellow-500\">\n                    {feedbackStats()!.partial}\n                  </div>\n                </div>\n              </div>\n\n              {/* Success Rate Gauge */}\n              <div class=\"card p-6 border\">\n                <h3 class=\"font-semibold mb-4\">Taxa de Sucesso</h3>\n                <div class=\"flex items-center justify-center\">\n                  <div class=\"text-center\">\n                    <div class={`text-6xl font-bold ${getSuccessRateColor(feedbackStats()!.success_rate)}`}>\n                      {feedbackStats()!.success_rate}%\n                    </div>\n                    <div class=\"text-sm text-muted mt-2\">\n                      Baseado em {feedbackStats()!.total_feedback} feedbacks\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Problematic Queries */}\n              <Show when={feedbackStats()!.problematic_queries.", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "05a2fab3-c692-4fef-bad1-98bd5b474bd9": {"__data__": {"id_": "05a2fab3-c692-4fef-bad1-98bd5b474bd9", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "hash": "ec8652f334691402b841696a210c6156b28f1688ab2cf306bdd1176bdc50d7a0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "eba33f6b-013c-4e1e-b9bb-9cab2b603bf1", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "hash": "d2d9f29328103cc27eb89d764d96b9d52c32b2a0d7734cb495103627e925646c", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2c2e1cd0-fe47-4482-b74f-09c29bb70672", "node_type": "1", "metadata": {}, "hash": "10f896fc2ff0d16dbc679563894b625b57c29407e35145f16525630adb017c01", "class_name": "RelatedNodeInfo"}}, "text": "partial}\n                  </div>\n                </div>\n              </div>\n\n              {/* Success Rate Gauge */}\n              <div class=\"card p-6 border\">\n                <h3 class=\"font-semibold mb-4\">Taxa de Sucesso</h3>\n                <div class=\"flex items-center justify-center\">\n                  <div class=\"text-center\">\n                    <div class={`text-6xl font-bold ${getSuccessRateColor(feedbackStats()!.success_rate)}`}>\n                      {feedbackStats()!.success_rate}%\n                    </div>\n                    <div class=\"text-sm text-muted mt-2\">\n                      Baseado em {feedbackStats()!.total_feedback} feedbacks\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Problematic Queries */}\n              <Show when={feedbackStats()!.problematic_queries.length > 0}>\n                <div class=\"card border\">\n                  <div class=\"p-4 border-b\">\n                    <h3 class=\"font-semibold\">Queries Problem\u00e1ticas (Top 10)</h3>\n                    <p class=\"text-sm text-muted\">Queries que receberam feedback negativo</p>\n                  </div>\n                  <div class=\"overflow-x-auto\">\n                    <table class=\"w-full\">\n                      <thead class=\"bg-muted/50\">\n                        <tr class=\"text-left text-xs font-medium text-muted uppercase\">\n                          <th class=\"p-3\">Query</th>\n                          <th class=\"p-3\">Tipo</th>\n                          <th class=\"p-3\">Timestamp</th>\n                        </tr>\n                      </thead>\n                      <tbody class=\"divide-y\">\n                        <For each={feedbackStats()!.problematic_queries}>\n                          {(query) => (\n                            <tr class=\"hover:bg-muted/30\">\n                              <td class=\"p-3 text-sm\">{query.query}</td>\n                              <td class=\"p-3\">\n                                <span class=\"px-2 py-1 bg-red-500/10 text-red-500 text-xs rounded\">\n                                  {query.feedback_type}\n                                </span>\n                              </td>\n                              <td class=\"p-3 text-sm text-muted font-mono\">{query.timestamp}</td>\n                            </tr>\n                          )}\n                        </For>\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              </Show>\n            </div>\n          </Show>\n        </Show>\n\n        {/* Tab: Errors */}\n        <Show when={activeTab() === 'errors'}>\n          <Show when={errorAnalysis()}>\n            <div class=\"space-y-6\">\n              {/* Total Errors */}\n              <div class=\"card p-6 border\">\n                <div class=\"text-sm text-muted mb-1\">Total de Erros</div>\n                <div class=\"text-4xl font-bold text-red-500\">\n                  {errorAnalysis()!.total_errors}\n                </div>\n              </div>\n\n              {/* Error Types Bar Chart */}\n              <div class=\"card p-6 border\">\n                <h3 class=\"font-semibold mb-4 flex items-center gap-2\">\n                  <BarChart3 size={20} />\n                  Tipos de Erro\n                </h3>\n                <div class=\"space-y-3\">\n                  <For each={Object.entries(errorAnalysis()!.error_types)}>\n                    {([type, count]) => {\n                      const total = errorAnalysis()!.total_errors;\n                      const percentage = (count / total) * 100;\n                      return (\n                        <div>\n                          <div class=\"flex justify-between text-sm mb-1\">\n                            <span class=\"font-medium\">{type}</span>\n                            <span class=\"text-muted\">{count} ({percentage.toFixed(1)}%)</span>\n                          </div>\n                          <div class=\"h-2 bg-muted rounded-full overflow-hidden\">\n                            <div\n                              class=\"h-full bg-red-500\"\n                              style={{ width: `${percentage}%` }}\n                            />\n                          </div>\n                        </div>\n                      );\n                    }}\n                  </For>\n                </div>\n              </div>\n\n              {/* Error Details & Suggestions */}\n              <div class=\"card border\">\n                <div class=\"p-4 border-b\">\n                  <h3 class=\"font-semibold\">Detalhes e Sugest\u00f5es</h3>\n                </div>\n                <div class=\"divide-y\">\n                  <For each={errorAnalysis()!.", "mimetype": "text/plain", "start_char_idx": 6641, "end_char_idx": 11307, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2c2e1cd0-fe47-4482-b74f-09c29bb70672": {"__data__": {"id_": "2c2e1cd0-fe47-4482-b74f-09c29bb70672", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "hash": "ec8652f334691402b841696a210c6156b28f1688ab2cf306bdd1176bdc50d7a0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "05a2fab3-c692-4fef-bad1-98bd5b474bd9", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "hash": "7230ab55a531db70058850f39bc641c8f49f39fe75bdcd38351278849d8463f9", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "d8d73997-59fc-4784-b811-5f3f74c53222", "node_type": "1", "metadata": {}, "hash": "ad01183cf7904ae9b5f2625b01d63e78c439573b5dcad05796bae030ad5f543e", "class_name": "RelatedNodeInfo"}}, "text": "return (\n                        <div>\n                          <div class=\"flex justify-between text-sm mb-1\">\n                            <span class=\"font-medium\">{type}</span>\n                            <span class=\"text-muted\">{count} ({percentage.toFixed(1)}%)</span>\n                          </div>\n                          <div class=\"h-2 bg-muted rounded-full overflow-hidden\">\n                            <div\n                              class=\"h-full bg-red-500\"\n                              style={{ width: `${percentage}%` }}\n                            />\n                          </div>\n                        </div>\n                      );\n                    }}\n                  </For>\n                </div>\n              </div>\n\n              {/* Error Details & Suggestions */}\n              <div class=\"card border\">\n                <div class=\"p-4 border-b\">\n                  <h3 class=\"font-semibold\">Detalhes e Sugest\u00f5es</h3>\n                </div>\n                <div class=\"divide-y\">\n                  <For each={errorAnalysis()!.error_details}>\n                    {(detail) => (\n                      <div class=\"p-4\">\n                        <div class=\"flex items-start gap-3\">\n                          <div class=\"p-2 bg-red-500/10 rounded\">\n                            <AlertTriangle size={20} class=\"text-red-500\" />\n                          </div>\n                          <div class=\"flex-1\">\n                            <div class=\"font-medium mb-1\">{detail.error_type}</div>\n                            <div class=\"text-sm text-muted mb-2\">{detail.count} ocorr\u00eancias</div>\n                            <div class=\"text-sm bg-blue-500/10 text-blue-400 p-2 rounded\">\n                              \ud83d\udca1 {detail.suggestion}\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    )}\n                  </For>\n                </div>\n              </div>\n            </div>\n          </Show>\n        </Show>\n\n        {/* Tab: Patterns */}\n        <Show when={activeTab() === 'patterns'}>\n          <Show when={patterns()}>\n            <div class=\"space-y-6\">\n              {/* Search */}\n              <div class=\"flex gap-2\">\n                <div class=\"flex-1 relative\">\n                  <Search size={20} class=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted\" />\n                  <input\n                    type=\"text\"\n                    class=\"input pl-10 w-full\"\n                    placeholder=\"Buscar padr\u00f5es por palavra-chave.\"\n                    value={searchTerm()}\n                    onInput={(e) => setSearchTerm(e.currentTarget.value)}\n                    onKeyPress={(e) => e.key === 'Enter' && searchPatterns()}\n                  />\n                </div>\n                <button class=\"btn btn-primary\" onClick={searchPatterns}>\n                  Buscar\n                </button>\n              </div>\n\n              {/* Total Patterns */}\n              <div class=\"card p-4 border\">\n                <div class=\"text-sm text-muted mb-1\">Padr\u00f5es Identificados</div>\n                <div class=\"text-2xl font-bold\">{patterns()!.total_patterns}</div>\n              </div>\n\n              {/* Patterns List */}\n              <div class=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <For each={patterns()!.patterns}>\n                  {(pattern) => (\n                    <div class=\"card p-4 border hover:border-primary/50 transition-colors\">\n                      <div class=\"flex items-start justify-between mb-3\">\n                        <h4 class=\"font-semibold\">{pattern.pattern}</h4>\n                        <span class=\"px-2 py-1 bg-primary/10 text-primary text-xs rounded\">\n                          {pattern.success_count} sucessos\n                        </span>\n                      </div>\n\n                      <div class=\"mb-3\">\n                        <div class=\"text-xs text-muted mb-1\">Palavras-chave:</div>\n                        <div class=\"flex flex-wrap gap-1\">\n                          <For each={pattern.keywords}>\n                            {(keyword) => (\n                              <span class=\"px-2 py-0.5 bg-secondary text-xs rounded\">\n                                {keyword}\n                              </span>\n                            )}\n                          </For>\n                        </div>\n                      </div>\n\n                      <div>\n                        <div class=\"text-xs text-muted mb-1\">Exemplos:</div>\n                        <ul class=\"text-sm space-y-1\">\n                          <For each={pattern.examples}>\n                            {(example) => (\n                              <li class=\"text-muted italic\">\u2022 {example}</li>\n                            )}\n                          </For>\n                        </ul>\n                      </div>\n                    </div>\n                  )}\n                </For>\n              </div>\n\n              <Show when={patterns()!.patterns.", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "d8d73997-59fc-4784-b811-5f3f74c53222": {"__data__": {"id_": "d8d73997-59fc-4784-b811-5f3f74c53222", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "hash": "ec8652f334691402b841696a210c6156b28f1688ab2cf306bdd1176bdc50d7a0", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2c2e1cd0-fe47-4482-b74f-09c29bb70672", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}, "hash": "c3506700fcfb0d9f95438e671e1ecc05e9f8b5351e469e3fc4abdad480fa2f14", "class_name": "RelatedNodeInfo"}}, "text": "keywords}>\n                            {(keyword) => (\n                              <span class=\"px-2 py-0.5 bg-secondary text-xs rounded\">\n                                {keyword}\n                              </span>\n                            )}\n                          </For>\n                        </div>\n                      </div>\n\n                      <div>\n                        <div class=\"text-xs text-muted mb-1\">Exemplos:</div>\n                        <ul class=\"text-sm space-y-1\">\n                          <For each={pattern.examples}>\n                            {(example) => (\n                              <li class=\"text-muted italic\">\u2022 {example}</li>\n                            )}\n                          </For>\n                        </ul>\n                      </div>\n                    </div>\n                  )}\n                </For>\n              </div>\n\n              <Show when={patterns()!.patterns.length === 0}>\n                <div class=\"card p-12 text-center border-dashed\">\n                  <Search size={48} class=\"mx-auto mb-4 opacity-20\" />\n                  <p class=\"text-muted\">Nenhum padr\u00e3o encontrado</p>\n                </div>\n              </Show>\n            </div>\n          </Show>\n        </Show>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 14335, "end_char_idx": 15631, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f09ee431-3eeb-4fd5-82c5-a96daeea1a41": {"__data__": {"id_": "f09ee431-3eeb-4fd5-82c5-a96daeea1a41", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Login.tsx", "language": "typescript", "lines": 146, "filename": "Login.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "81bfd6e6-4c4b-467b-a9bc-b47d512ff960", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Login.tsx", "language": "typescript", "lines": 146, "filename": "Login.tsx"}, "hash": "05fd8136c747f117ecd9153eac157b619c947cd08a97e7bc68063eb543ea9f65", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f27384fb-e990-449d-92c5-438083a20223", "node_type": "1", "metadata": {}, "hash": "d4717c5bdf212c1ab736ae17831c874971c78ac8d1139320cbef76fe23643208", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, Show, createEffect } from 'solid-js';\nimport { useNavigate } from '@solidjs/router';\nimport auth from '@/store/auth';\nimport { LogIn, Loader2 } from 'lucide-solid';\nimport { Logo } from '@/components/Logo';\n\nexport default function Login() {\n  console.log('\ud83d\udd35 Login component mounting...');\n  const [username, setUsername] = createSignal('');\n  const [password, setPassword] = createSignal('');\n  const navigate = useNavigate();\n  \n  // Log when rendering\n  createEffect(() => {\n    console.log('\ud83d\udd35 Login component rendered. Auth loading:', auth.loading());\n  });\n\n  const handleSubmit = async (e: Event) => {\n    e.preventDefault();\n    console.log('\ud83d\udd10 Login attempt:', { username: username(), passwordLength: password().length });\n    \n    if (!username() || !password()) {\n      console.error('\u274c Username or password empty');\n      return;\n    }\n    \n    try {\n      console.log('\ud83d\udce1 Calling auth.login...');\n      const success = await auth.login(username(), password());\n      console.log('\u2705 Login result:', success);\n      \n      if (success) {\n        console.log('\ud83c\udf89 Login successful! Navigating to dashboard.');\n        // Usar window.location.href para for\u00e7ar reload completo e garantir que o estado seja propagado\n        window.location.href = '/dashboard';\n      } else {\n        console.error('\u274c Login failed');\n      }\n    } catch (error) {\n      console.error('\ud83d\udca5 Login error:', error);\n    }\n  };\n\n  return (\n    <div class=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-amber-50 via-orange-50 to-stone-100 p-4\">\n      {/* Background Effects - Lojas Ca\u00e7ula (warm tones) */}\n      <div class=\"absolute inset-0 overflow-hidden pointer-events-none\">\n        <div class=\"absolute top-1/4 left-1/4 w-96 h-96 bg-primary/5 rounded-full blur-3xl animate-pulse\"></div>\n        <div class=\"absolute bottom-1/4 right-1/4 w-96 h-96 bg-accent/5 rounded-full blur-3xl animate-pulse\" style=\"animation-delay: 1s\"></div>\n      </div>\n\n      {/* Login Card - Lojas Ca\u00e7ula */}\n      <div class=\"relative w-full max-w-md\">\n        <div class=\"bg-white/95 backdrop-blur-xl border-2 border-primary/20 rounded-2xl shadow-2xl p-8 space-y-6\">\n          {/* Header */}\n          <div class=\"text-center space-y-4\">\n            <div class=\"flex justify-center mb-4\">\n              <Logo size=\"xl\" className=\"filter drop-shadow-lg\" />\n            </div>\n            <div class=\"space-y-2\">\n              <h1 class=\"text-3xl font-bold text-primary\">\n                CA\u00c7ULINHA BI\n              </h1>\n              <p class=\"text-sm text-muted-foreground\">\n                Entre para acessar seus dados anal\u00edticos\n              </p>\n            </div>\n          </div>\n\n          {/* Error Message */}\n          <Show when={auth.error()}>\n            <div class=\"bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3\">\n              <svg class=\"w-5 h-5 text-red-400 flex-shrink-0 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n              <div class=\"flex-1\">\n                <p class=\"text-sm text-red-200 font-medium\">Erro de Autentica\u00e7\u00e3o</p>\n                <p class=\"text-xs text-red-300/80 mt-1\">{auth.error()}</p>\n              </div>\n            </div>\n          </Show>\n\n          {/* Form */}\n          <form onSubmit={handleSubmit} class=\"space-y-4\">\n            {/* Username Field */}\n            <div class=\"space-y-2\">\n              <label for=\"username\" class=\"block text-sm font-medium text-foreground\">\n                Usu\u00e1rio\n              </label>\n              <input\n                id=\"username\"\n                type=\"text\"\n                value={username()}\n                onInput={(e) => setUsername(e.currentTarget.", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f27384fb-e990-449d-92c5-438083a20223": {"__data__": {"id_": "f27384fb-e990-449d-92c5-438083a20223", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Login.tsx", "language": "typescript", "lines": 146, "filename": "Login.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "81bfd6e6-4c4b-467b-a9bc-b47d512ff960", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Login.tsx", "language": "typescript", "lines": 146, "filename": "Login.tsx"}, "hash": "05fd8136c747f117ecd9153eac157b619c947cd08a97e7bc68063eb543ea9f65", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "f09ee431-3eeb-4fd5-82c5-a96daeea1a41", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Login.tsx", "language": "typescript", "lines": 146, "filename": "Login.tsx"}, "hash": "11685649cd4d33b380002b620c50f4e6616b3d1c596db8a58e1c2034f71e599a", "class_name": "RelatedNodeInfo"}}, "text": "01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n              </svg>\n              <div class=\"flex-1\">\n                <p class=\"text-sm text-red-200 font-medium\">Erro de Autentica\u00e7\u00e3o</p>\n                <p class=\"text-xs text-red-300/80 mt-1\">{auth.error()}</p>\n              </div>\n            </div>\n          </Show>\n\n          {/* Form */}\n          <form onSubmit={handleSubmit} class=\"space-y-4\">\n            {/* Username Field */}\n            <div class=\"space-y-2\">\n              <label for=\"username\" class=\"block text-sm font-medium text-foreground\">\n                Usu\u00e1rio\n              </label>\n              <input\n                id=\"username\"\n                type=\"text\"\n                value={username()}\n                onInput={(e) => setUsername(e.currentTarget.value)}\n                placeholder=\"Digite seu usu\u00e1rio\"\n                required\n                autocomplete=\"username\"\n                class=\"w-full px-4 py-3 bg-white border-2 border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all\"\n              />\n            </div>\n\n            {/* Password Field */}\n            <div class=\"space-y-2\">\n              <label for=\"password\" class=\"block text-sm font-medium text-foreground\">\n                Senha\n              </label>\n              <input\n                id=\"password\"\n                type=\"password\"\n                value={password()}\n                onInput={(e) => setPassword(e.currentTarget.value)}\n                placeholder=\"Digite sua senha\"\n                required\n                autocomplete=\"current-password\"\n                class=\"w-full px-4 py-3 bg-white border-2 border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all\"\n              />\n            </div>\n\n            {/* Submit Button - Lojas Ca\u00e7ula */}\n            <button\n              type=\"submit\"\n              disabled={auth.loading()}\n              class=\"w-full py-3 px-4 bg-gradient-to-r from-primary to-accent hover:from-primary/90 hover:to-accent/90 text-white font-semibold rounded-lg shadow-lg shadow-primary/20 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n            >\n              <Show when={auth.loading()} fallback={<>Entrar</>}>\n                <Loader2 size={20} class=\"animate-spin\" />\n                <span>Entrando.</span>\n              </Show>\n            </button>\n          </form>\n        </div>\n\n        {/* Version Info - Lojas Ca\u00e7ula */}\n        <div class=\"text-center mt-6 space-y-2\">\n          <div class=\"flex justify-center\">\n            <Logo size=\"sm\" className=\"opacity-60\" />\n          </div>\n          <div class=\"text-xs text-muted-foreground\">\n            Ca\u00e7ulinha BI v1.0.0 \u2022 Powered by SolidJS\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "68f7e8d9-7160-4bdb-8342-c9c99aca6024": {"__data__": {"id_": "68f7e8d9-7160-4bdb-8342-c9c99aca6024", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "dc1b08f2205ad6958873e2afc499e24f3cc44c1697e1cd7c75b4513aa8f61ba2", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3fce3c90-03f4-495a-93a9-abd0746d3fd8", "node_type": "1", "metadata": {}, "hash": "3673cee65a7f3ad6e51fde78e65947fa84c80944a5a13b4579b0b3e0755bdee7", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, For, Show, onMount, createEffect } from 'solid-js';\nimport { Terminal, Send, Trash2, Settings, Zap, Activity, Clock, Cpu, Info, Code, FileJson, Save, Play, X, ChevronDown, ChevronRight, Pencil } from 'lucide-solid';\nimport api from '../lib/api';\nimport { MessageActions } from '../components/MessageActions';\nimport 'github-markdown-css/github-markdown.css';\nimport './chat-markdown.css';\n\ninterface Message {\n  id: string; \n  role: 'user' | 'assistant';\n  content: string;\n  timestamp: string;\n}\n\ninterface ModelInfo {\n  model: string;\n  temperature: number;\n  max_tokens: number;\n  json_mode: boolean;\n  default_temperature?: number;\n  default_max_tokens?: number;\n  max_temperature_limit?: number;\n  max_tokens_limit?: number;\n}\n\ninterface CacheStats {\n  hits: number;\n  misses: number;\n  hit_rate: number;\n  enabled: boolean;\n}\n\ninterface ChatResponse {\n  response: string;\n  model_info: ModelInfo;\n  metadata: {\n    response_time: number;\n    timestamp: string;\n    user: string;\n  };\n  cache_stats: CacheStats;\n}\n\nexport default function Playground() {\n  const [messages, setMessages] = createSignal<Message[]>([]);\n  const [input, setInput] = createSignal('');\n  const [systemInstruction, setSystemInstruction] = createSignal('');\n  const [loading, setLoading] = createSignal(false);\n  let messagesEndRef: HTMLDivElement | undefined;\n  const [showCodeModal, setShowCodeModal] = createSignal(false);\n  const [systemExpanded, setSystemExpanded] = createSignal(false);\n\n  // Controls\n  const [temperature, setTemperature] = createSignal(1.0);\n  const [maxTokens, setMaxTokens] = createSignal(2048);\n  const [jsonMode, setJsonMode] = createSignal(false);\n  const [streamMode, setStreamMode] = createSignal(false);\n\n  // Stats & Info\n  const [modelInfo, setModelInfo] = createSignal<ModelInfo | null>(null);\n  const [cacheStats, setCacheStats] = createSignal<CacheStats | null>(null);\n  const [responseTime, setResponseTime] = createSignal(0);\n\n  // Editing state\n  const [editingMessageId, setEditingMessageId] = createSignal<string | null>(null);\n  const [editText, setEditText] = createSignal('');\n\n  // Examples\n  const examples = [\n    {\n      title: \"An\u00e1lise Financeira\",\n      system: \"Voc\u00ea \u00e9 um analista financeiro s\u00eanior. Responda de forma concisa e use tabelas markdown quando apropriado.\",\n      prompt: \"Analise o ROI de uma campanha de marketing que custou R$ 50.000 e gerou R$ 120.000 em vendas.\"\n    },\n    {\n      title: \"SQL Expert\",\n      system: \"Voc\u00ea \u00e9 um DBA especialista em SQL Server. Forne\u00e7a apenas o c\u00f3digo SQL otimizado sem explica\u00e7\u00f5es verbosas.\",\n      prompt: \"Escreva uma query para encontrar produtos que n\u00e3o venderam nos \u00faltimos 6 meses.\"\n    },\n    {\n      title: \"Python Data\",\n      system: \"Voc\u00ea \u00e9 um engenheiro de dados Python. Prefira a biblioteca Polars sobre Pandas.\",\n      prompt: \"Crie um script para ler um arquivo Parquet e filtrar linhas onde 'status' \u00e9 'error'.\"\n    }\n  ];\n\n  onMount(async () => {\n    try {\n      const response = await api.get('/playground/info');\n      \n      // Update ModelInfo with all details from the backend\n      setModelInfo(response.data);\n\n      // Set initial maxTokens and temperature from backend defaults\n      if (response.data.default_max_tokens) {\n        setMaxTokens(response.data.default_max_tokens);\n      }\n      if (response.data.default_temperature) {\n        setTemperature(response.data.default_temperature);\n      }\n\n    } catch (error) {\n      console.error('Erro ao carregar info do modelo:', error);\n    }\n  });\n\n  createEffect(() => {\n    if (messages()) {\n       setTimeout(() => messagesEndRef.scrollIntoView({ behavior: 'smooth' }), 100);\n    }\n  });\n\n  const sendMessage = async (e?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3708, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3fce3c90-03f4-495a-93a9-abd0746d3fd8": {"__data__": {"id_": "3fce3c90-03f4-495a-93a9-abd0746d3fd8", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "dc1b08f2205ad6958873e2afc499e24f3cc44c1697e1cd7c75b4513aa8f61ba2", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "68f7e8d9-7160-4bdb-8342-c9c99aca6024", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "538b3d02c58efb86b6ba6527f2aeeaf390ec4e0020817abfedc9df687b75144f", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b3583997-8db7-44d0-95eb-09e33a72bf86", "node_type": "1", "metadata": {}, "hash": "486cfbffed8456dd21314ac66456588d3034c035eaf53f75b852f881bb40f25d", "class_name": "RelatedNodeInfo"}}, "text": "\",\n      prompt: \"Crie um script para ler um arquivo Parquet e filtrar linhas onde 'status' \u00e9 'error'.\"\n    }\n  ];\n\n  onMount(async () => {\n    try {\n      const response = await api.get('/playground/info');\n      \n      // Update ModelInfo with all details from the backend\n      setModelInfo(response.data);\n\n      // Set initial maxTokens and temperature from backend defaults\n      if (response.data.default_max_tokens) {\n        setMaxTokens(response.data.default_max_tokens);\n      }\n      if (response.data.default_temperature) {\n        setTemperature(response.data.default_temperature);\n      }\n\n    } catch (error) {\n      console.error('Erro ao carregar info do modelo:', error);\n    }\n  });\n\n  createEffect(() => {\n    if (messages()) {\n       setTimeout(() => messagesEndRef.scrollIntoView({ behavior: 'smooth' }), 100);\n    }\n  });\n\n  const sendMessage = async (e?: Event) => {\n    e?.preventDefault();\n    if (!input().trim() || loading()) return;\n\n    const userMessage: Message = {\n      id: Date.now().toString(),\n      role: 'user',\n      content: input(),\n      timestamp: new Date().toISOString()\n    };\n\n    setMessages([...messages(), userMessage]);\n    setInput('');\n    setLoading(true);\n\n    await executeRequest([...messages(), userMessage]);\n  };\n\n  const executeRequest = async (currentHistory: Message[]) => {\n    try {\n      const response = await api.post<ChatResponse>('/playground/chat', {\n        message: currentHistory[currentHistory.length - 1].content,\n        system_instruction: systemInstruction(),\n        history: currentHistory.slice(0, -1).map(m => ({\n          role: m.role,\n          content: m.content,\n          timestamp: m.timestamp\n        })),\n        temperature: temperature(),\n        max_tokens: maxTokens(),\n        json_mode: jsonMode(),\n        stream: streamMode()\n      });\n\n      const assistantMessage: Message = {\n        id: (Date.now() + 1).toString(),\n        role: 'assistant',\n        content: response.data.response,\n        timestamp: response.data.metadata.timestamp\n      };\n\n      setMessages([...currentHistory, assistantMessage]);\n      setModelInfo(response.data.model_info);\n      setCacheStats(response.data.cache_stats);\n      setResponseTime(response.data.metadata.response_time);\n\n    } catch (error: any) {\n      const errorMessage: Message = {\n        id: Date.now().toString(),\n        role: 'assistant',\n        content: `\u274c **Erro na execu\u00e7\u00e3o**: ${error.response?.data?.detail || error.message}`,\n        timestamp: new Date().toISOString()\n      };\n      setMessages([...currentHistory, errorMessage]);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const clearHistory = () => {\n    if (confirm('Deseja limpar o hist\u00f3rico e come\u00e7ar do zero?')) {\n      setMessages([]);\n      setResponseTime(0);\n    }\n  };\n\n  const loadExample = (ex: any) => {\n    setSystemInstruction(ex.system);\n    setInput(ex.prompt);\n    setSystemExpanded(true);\n  };\n\n  const generateCodeSnippet = () => {\n    const pyCode = `\nimport requests\n\nurl = \"http://localhost:8000/api/v1/playground/chat\"\nheaders = {\"Authorization\": \"Bearer YOUR_TOKEN\"}\npayload = {\n    \"system_instruction\": \"${systemInstruction().replace(/\"/g, '\\\\\"')}\",\n    \"message\": \"${messages().length > 0 ? messages()[messages().length - 1].content.replace(/\"/g, '\\\\\"') : ''}\",\n    \"history\": ${JSON.stringify(messages().slice(0, -1).map(m => ({ role: m.role, content: m.content }))).replace(/\"/g, '\\\\\"')},\n    \"temperature\": ${temperature()},\n    \"max_tokens\": ${maxTokens()},\n    \"json_mode\": ${jsonMode()}\n}\n\nresponse = requests.post(url, json=payload, headers=headers)\nprint(response.json())\n    `.trim();\n    return pyCode;\n  };\n\n  return (\n    <div class=\"h-full flex flex-col bg-background max-w-[1800px] mx-auto relative\">\n      {/* 1.", "mimetype": "text/plain", "start_char_idx": 2830, "end_char_idx": 6609, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b3583997-8db7-44d0-95eb-09e33a72bf86": {"__data__": {"id_": "b3583997-8db7-44d0-95eb-09e33a72bf86", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "dc1b08f2205ad6958873e2afc499e24f3cc44c1697e1cd7c75b4513aa8f61ba2", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3fce3c90-03f4-495a-93a9-abd0746d3fd8", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "9a1b0cbc2a4b7beb2c19ccfdb1146a2be5c070b0490179590376bfa61316d49b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "21f20e6f-a2e2-4320-b417-8163633c0722", "node_type": "1", "metadata": {}, "hash": "2577942d1c67989b338dddddd3f45734120f868c5079fb54121dc9e707a45f17", "class_name": "RelatedNodeInfo"}}, "text": "messages()[messages().length - 1].content.replace(/\"/g, '\\\\\"') : ''}\",\n    \"history\": ${JSON.stringify(messages().slice(0, -1).map(m => ({ role: m.role, content: m.content }))).replace(/\"/g, '\\\\\"')},\n    \"temperature\": ${temperature()},\n    \"max_tokens\": ${maxTokens()},\n    \"json_mode\": ${jsonMode()}\n}\n\nresponse = requests.post(url, json=payload, headers=headers)\nprint(response.json())\n    `.trim();\n    return pyCode;\n  };\n\n  return (\n    <div class=\"h-full flex flex-col bg-background max-w-[1800px] mx-auto relative\">\n      {/* 1. Context7: Executive Header with KPIs */}\n      <div class=\"border-b bg-card/50 backdrop-blur-sm p-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-4 z-10\">\n        <div>\n          <h2 class=\"text-xl font-bold flex items-center gap-2 text-foreground\">\n            <Terminal class=\"text-primary\" /> \n            Playground <span class=\"text-muted font-normal text-sm border-l pl-2 ml-2\">Ambiente de Desenvolvimento</span>\n          </h2>\n        </div>\n\n        {/* Live Metrics Strip */}\n        <div class=\"flex gap-4\">\n           <div class=\"flex items-center gap-3 px-4 py-2 bg-secondary/50 rounded-lg border border-border/50\">\n              <Clock size={16} class=\"text-blue-500\" />\n              <div>\n                 <div class=\"text-[10px] text-muted uppercase tracking-wider font-semibold\">Lat\u00eancia</div>\n                 <div class=\"text-sm font-mono font-bold\">{responseTime() > 0 ? `${responseTime().toFixed(2)}s` : '--'}</div>\n              </div>\n           </div>\n           \n           <div class=\"flex items-center gap-3 px-4 py-2 bg-secondary/50 rounded-lg border border-border/50\">\n              <Cpu size={16} class=\"text-purple-500\" />\n              <div>\n                 <div class=\"text-[10px] text-muted uppercase tracking-wider font-semibold\">Modelo</div>\n                 <div class=\"text-sm font-mono font-bold\">{modelInfo()?.model || 'Gemini 2.5'}</div>\n              </div>\n           </div>\n\n           <button \n             onClick={() => setShowCodeModal(true)}\n             class=\"btn btn-outline gap-2\"\n             title=\"Ver C\u00f3digo\"\n           >\n              <Code size={16} /> <span class=\"hidden md:inline\">Ver C\u00f3digo</span>\n           </button>\n        </div>\n      </div>\n\n      <div class=\"flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-[1fr_350px]\">\n        {/* Main Workspace */}\n        <div class=\"flex flex-col min-h-0 bg-background/50 relative\">\n          \n          {/* System Instruction Panel - Context7: Define Persona First */}\n          <div class=\"border-b bg-card/20 transition-all duration-300\">\n             <button \n                onClick={() => setSystemExpanded(!systemExpanded())}\n                class=\"w-full flex items-center justify-between p-3 text-xs font-bold uppercase tracking-wider text-muted hover:bg-card/40\"\n             >\n                <div class=\"flex items-center gap-2\">\n                   <Settings size={14} /> Instru\u00e7\u00f5es do Sistema (Persona)\n                </div>\n                {systemExpanded() ? <ChevronDown size={14} /> : <ChevronRight size={14} />}\n             </button>\n             \n             <Show when={systemExpanded()}>\n                <div class=\"p-4 pt-0 animate-in slide-in-from-top-2\">\n                   <textarea \n                      class=\"input w-full min-h-[100px] font-mono text-sm bg-background\" \n                      placeholder=\"Ex: Voc\u00ea \u00e9 um assistente especialista em an\u00e1lise de dados. Responda sempre em JSON.\"", "mimetype": "text/plain", "start_char_idx": 6073, "end_char_idx": 9575, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "21f20e6f-a2e2-4320-b417-8163633c0722": {"__data__": {"id_": "21f20e6f-a2e2-4320-b417-8163633c0722", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "dc1b08f2205ad6958873e2afc499e24f3cc44c1697e1cd7c75b4513aa8f61ba2", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b3583997-8db7-44d0-95eb-09e33a72bf86", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "1f0e480d6a34b686b31001b11f4b404659b74f1941fb61a3ecebebf2d3158962", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b81541e1-8975-4e7c-a131-56d4bc6daf5a", "node_type": "1", "metadata": {}, "hash": "af049786df491764c842b37e786bf2028c03e811798d4261049784038b246a86", "class_name": "RelatedNodeInfo"}}, "text": "<ChevronDown size={14} /> : <ChevronRight size={14} />}\n             </button>\n             \n             <Show when={systemExpanded()}>\n                <div class=\"p-4 pt-0 animate-in slide-in-from-top-2\">\n                   <textarea \n                      class=\"input w-full min-h-[100px] font-mono text-sm bg-background\" \n                      placeholder=\"Ex: Voc\u00ea \u00e9 um assistente especialista em an\u00e1lise de dados. Responda sempre em JSON.\"\n                      value={systemInstruction()}\n                      onInput={(e) => setSystemInstruction(e.currentTarget.value)}\n                   />\n                </div>\n             </Show>\n          </div>\n\n          {/* Messages */}\n          <div class=\"flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth\">\n            <Show when={messages().length === 0}>\n              <div class=\"h-full flex flex-col items-center justify-center text-muted gap-6 animate-in fade-in zoom-in duration-500\">\n                <div class=\"p-6 bg-secondary/30 rounded-full\">\n                   <FileJson size={64} class=\"opacity-20\" />\n                </div>\n                <div class=\"text-center max-w-md space-y-2\">\n                  <h3 class=\"text-xl font-bold text-foreground\">Playground de Desenvolvimento</h3>\n                  <p>Defina uma persona, configure os par\u00e2metros e teste prompts complexos antes de implementar.</p>\n                </div>\n                \n                <div class=\"grid grid-cols-1 md:grid-cols-3 gap-3 w-full max-w-4xl mt-4\">\n                   <For each={examples}>\n                      {(example) => (\n                         <button \n                            onClick={() => loadExample(example)}\n                            class=\"p-4 rounded-xl border border-border/50 hover:border-primary/50 hover:bg-secondary/50 transition-all text-left group\"\n                         >\n                            <div class=\"font-semibold text-sm group-hover:text-primary transition-colors mb-1 flex items-center gap-2\">\n                               <Play size={14} /> {example.title}\n                            </div>\n                            <div class=\"text-xs text-muted line-clamp-2\">{example.system}</div>\n                         </button>\n                      )}\n                   </For>\n                </div>\n              </div>\n            </Show>\n\n            <For each={messages()}>\n              {(message) => (\n                <div class={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 group`}>\n                  <div\n                    class={`max-w-[85%] rounded-2xl p-5 shadow-sm relative ${\n                      message.role === 'user'\n                        ? 'bg-primary/10 border border-primary/20 text-foreground rounded-tr-none'\n                        : 'bg-card border text-card-foreground rounded-tl-none'\n                    }`}\n                  >\n                    <div class=\"flex items-center gap-2 mb-2 opacity-70 border-b border-border/10 pb-2\">\n                      <span class=\"text-xs font-bold uppercase tracking-wider\">\n                         {message.role === 'user' ? 'User' : 'Model'}\n                      </span>\n                      <span class=\"text-[10px] ml-auto\">\n                        {new Date(message.timestamp).toLocaleTimeString()}\n                      </span>\n                    </div>\n                    \n                    <div class=\"markdown-body text-sm leading-relaxed\" style=\"background: transparent;\">\n                       <pre class=\"whitespace-pre-wrap font-sans bg-transparent border-0 p-0 m-0 text-current\">{message.content}</pre>\n                    </div>\n\n                    <Show when={message.role === 'assistant'}>\n                        <div class=\"mt-3 pt-2 border-t border-border/10\">\n                           <MessageActions messageText={message.content} messageId={message.id} />\n                        </div>\n                    </Show>\n                  </div>\n                </div>\n              )}\n            </For>\n            \n            <Show when={loading()}>\n               <div class=\"flex justify-start\">\n                  <div class=\"bg-card border rounded-2xl rounded-tl-none p-4 flex items-center gap-3\">\n                     <div class=\"flex space-x-1\">\n                        <div class=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce [animation-delay:-0.3s]\"></div>\n                        <div class=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce [animation-delay:-0.15s]\"></div>\n                        <div class=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce\"></div>\n                     </div>\n                     <span class=\"text-xs text-muted font-medium\">Gerando resposta.", "mimetype": "text/plain", "start_char_idx": 9129, "end_char_idx": 13890, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b81541e1-8975-4e7c-a131-56d4bc6daf5a": {"__data__": {"id_": "b81541e1-8975-4e7c-a131-56d4bc6daf5a", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "dc1b08f2205ad6958873e2afc499e24f3cc44c1697e1cd7c75b4513aa8f61ba2", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "21f20e6f-a2e2-4320-b417-8163633c0722", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "15a365195eef252053d98f465f35d90581f70b06d9eb3962a307b93bc69ca546", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "da2c7ccb-0989-4e36-b7f0-cc91c04d3630", "node_type": "1", "metadata": {}, "hash": "acd3cf78de4e8467b45fe67db82a64e4042a911b1349007d7c5c77245f784273", "class_name": "RelatedNodeInfo"}}, "text": "content} messageId={message.id} />\n                        </div>\n                    </Show>\n                  </div>\n                </div>\n              )}\n            </For>\n            \n            <Show when={loading()}>\n               <div class=\"flex justify-start\">\n                  <div class=\"bg-card border rounded-2xl rounded-tl-none p-4 flex items-center gap-3\">\n                     <div class=\"flex space-x-1\">\n                        <div class=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce [animation-delay:-0.3s]\"></div>\n                        <div class=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce [animation-delay:-0.15s]\"></div>\n                        <div class=\"w-2 h-2 bg-primary/50 rounded-full animate-bounce\"></div>\n                     </div>\n                     <span class=\"text-xs text-muted font-medium\">Gerando resposta.</span>\n                  </div>\n               </div>\n            </Show>\n            <div ref={messagesEndRef} />\n          </div>\n\n          {/* Input Area */}\n          <div class=\"p-4 border-t bg-background/80 backdrop-blur-md\">\n            <form onSubmit={sendMessage} class=\"flex gap-3 max-w-4xl mx-auto\">\n              <button\n                type=\"button\"\n                onClick={clearHistory}\n                class=\"btn btn-ghost btn-icon text-muted hover:text-destructive\"\n                title=\"Limpar Hist\u00f3rico\"\n              >\n                <Trash2 size={20} />\n              </button>\n              \n              <div class=\"flex-1 relative\">\n                 <input\n                   type=\"text\"\n                   class=\"input w-full pr-12 shadow-sm font-mono text-sm\"\n                   placeholder=\"Digite sua mensagem.\"\n                   value={input()}\n                   onInput={(e) => setInput(e.currentTarget.value)}\n                   disabled={loading()}\n                 />\n              </div>\n\n              <button\n                type=\"submit\"\n                class=\"btn btn-primary shadow-md hover:shadow-lg transition-all\"\n                disabled={loading() || !input().trim()}\n              >\n                <Show when={!loading()} fallback={<Clock size={20} class=\"animate-spin\" />}>\n                   <Send size={20} />\n                </Show>\n              </button>\n            </form>\n          </div>\n        </div>\n\n        {/* Right Sidebar - Configuration */}\n        <div class=\"border-l bg-card/30 p-6 overflow-y-auto hidden lg:block\">\n           <div class=\"sticky top-0 space-y-8\">\n              {/* Settings Group */}\n              <div class=\"space-y-4\">\n                 <h3 class=\"font-bold flex items-center gap-2 text-foreground/80\">\n                    <Settings size={18} /> Par\u00e2metros\n                 </h3>\n                 \n                 <div class=\"space-y-4 p-4 bg-background border rounded-xl shadow-sm\">\n                    {/* Temperature */}\n                    <div class=\"space-y-3\">\n                       <div class=\"flex justify-between items-center\">\n                          <label class=\"text-sm font-medium\">Temperatura</label>\n                          <span class=\"text-xs font-mono bg-secondary px-2 py-1 rounded\">{temperature().toFixed(1)}</span>\n                       </div>\n                       <input\n                          type=\"range\" min=\"0\" max=\"2\" step=\"0.1\"\n                          value={temperature()}\n                          onInput={(e) => setTemperature(parseFloat(e.currentTarget.value))}\n                          class=\"w-full h-1.5 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary\"\n                       />\n                    </div>\n\n                    <div class=\"h-px bg-border/50\"></div>\n\n                    {/* Max Tokens */}\n                    <div class=\"space-y-3\">\n                       <div class=\"flex justify-between items-center\">\n                          <label class=\"text-sm font-medium\">Max Tokens</label>\n                          <span class=\"text-xs font-mono bg-secondary px-2 py-1 rounded\">{maxTokens()}</span>\n                       </div>\n                       <input\n                          type=\"range\" min=\"100\" max={modelInfo()?.max_tokens_limit || 8192} step=\"100\"\n                          value={maxTokens()}\n                          onInput={(e) => setMaxTokens(parseInt(e.currentTarget.value))}\n                          class=\"w-full h-1.", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "da2c7ccb-0989-4e36-b7f0-cc91c04d3630": {"__data__": {"id_": "da2c7ccb-0989-4e36-b7f0-cc91c04d3630", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "2e0b49ab-a3fd-4af3-8911-597e30482e53", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "dc1b08f2205ad6958873e2afc499e24f3cc44c1697e1cd7c75b4513aa8f61ba2", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b81541e1-8975-4e7c-a131-56d4bc6daf5a", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}, "hash": "16ba299052ecc4e4a84c5b64a202a60dd70c16d348910acfe1ec76808e468c35", "class_name": "RelatedNodeInfo"}}, "text": "1\"\n                          value={temperature()}\n                          onInput={(e) => setTemperature(parseFloat(e.currentTarget.value))}\n                          class=\"w-full h-1.5 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary\"\n                       />\n                    </div>\n\n                    <div class=\"h-px bg-border/50\"></div>\n\n                    {/* Max Tokens */}\n                    <div class=\"space-y-3\">\n                       <div class=\"flex justify-between items-center\">\n                          <label class=\"text-sm font-medium\">Max Tokens</label>\n                          <span class=\"text-xs font-mono bg-secondary px-2 py-1 rounded\">{maxTokens()}</span>\n                       </div>\n                       <input\n                          type=\"range\" min=\"100\" max={modelInfo()?.max_tokens_limit || 8192} step=\"100\"\n                          value={maxTokens()}\n                          onInput={(e) => setMaxTokens(parseInt(e.currentTarget.value))}\n                          class=\"w-full h-1.5 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary\"\n                       />\n                    </div>\n                 </div>\n              </div>\n\n              {/* Modes Group */}\n              <div class=\"space-y-4\">\n                 <h3 class=\"font-bold flex items-center gap-2 text-foreground/80\">\n                    <Cpu size={18} /> Output\n                 </h3>\n                 \n                 <div class=\"space-y-3 p-4 bg-background border rounded-xl shadow-sm\">\n                    <div class=\"flex items-center justify-between group\">\n                       <div class=\"space-y-0.5\">\n                          <label class=\"text-sm font-medium\">JSON Mode</label>\n                          <p class=\"text-xs text-muted\">Estrutura r\u00edgida</p>\n                       </div>\n                       <input\n                          type=\"checkbox\"\n                          checked={jsonMode()}\n                          onChange={(e) => setJsonMode(e.currentTarget.checked)}\n                          class=\"toggle toggle-sm toggle-primary\"\n                       />\n                    </div>\n                 </div>\n              </div>\n\n              {/* Context7 Help Box */}\n              <div class=\"p-4 bg-yellow-500/5 border border-yellow-500/10 rounded-xl space-y-2\">\n                 <div class=\"flex items-center gap-2 text-yellow-600 font-bold text-sm\">\n                    <Info size={16} /> Best Practice\n                 </div>\n                 <p class=\"text-xs text-muted leading-relaxed\">\n                    Use <strong>System Instructions</strong> para definir o comportamento base antes de iniciar a conversa. Isso economiza tokens e melhora a consist\u00eancia.\n                 </p>\n              </div>\n\n           </div>\n        </div>\n      </div>\n\n      {/* Code Modal */}\n      <Show when={showCodeModal()}>\n        <div class=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4\">\n           <div class=\"bg-card w-full max-w-2xl rounded-xl shadow-2xl border animate-in zoom-in-95\">\n              <div class=\"flex items-center justify-between p-4 border-b\">\n                 <h3 class=\"font-bold flex items-center gap-2\"><Code size={20} /> Snippet de Integra\u00e7\u00e3o</h3>\n                 <button onClick={() => setShowCodeModal(false)} class=\"btn btn-ghost btn-icon btn-sm\"><X size={18} /></button>\n              </div>\n              <div class=\"p-0 overflow-hidden\">\n                 <pre class=\"bg-secondary/50 p-4 text-xs font-mono overflow-x-auto text-foreground\">\n                    {generateCodeSnippet()}\n                 </pre>\n              </div>\n              <div class=\"p-4 border-t flex justify-end gap-2\">\n                 <button onClick={() => setShowCodeModal(false)} class=\"btn btn-outline\">Fechar</button>\n                 <button class=\"btn btn-primary\" onClick={() => {\n                    navigator.clipboard.writeText(generateCodeSnippet());\n                    setShowCodeModal(false);\n                 }}>Copiar C\u00f3digo</button>\n              </div>\n           </div>\n        </div>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 16355, "end_char_idx": 20542, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "dc45ba00-9d3e-4238-ac88-e7de5ea641d5": {"__data__": {"id_": "dc45ba00-9d3e-4238-ac88-e7de5ea641d5", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a3079cdf-9c72-4211-8b17-937bf2df6322", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "hash": "8087022e044e45a79e6e1c9ba0f766017f44e6e4d87d515027cc6b88498eb6a2", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "042c80a1-261e-4fcb-ab99-3a64ea675845", "node_type": "1", "metadata": {}, "hash": "b0597e2cbac9f016b427edd6c1d60cfd1c9f363013b397a82cd392316c3a95a3", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, createMemo, Show } from 'solid-js';\nimport { Lock, CheckCircle, AlertCircle, Shield, Info } from 'lucide-solid';\nimport auth from '@/store/auth';\nimport { UserPreferences } from '@/components/UserPreferences';\n\ninterface PasswordStrength {\n  score: number; // 0-4\n  label: string;\n  color: string;\n  barColor: string;\n}\n\nexport default function Profile() {\n  const [currentPass, setCurrentPass] = createSignal('');\n  const [newPass, setNewPass] = createSignal('');\n  const [confirmPass, setConfirmPass] = createSignal('');\n  const [message, setMessage] = createSignal<{ type: 'success' | 'error', text: string } | null>(null);\n\n  // Valida\u00e7\u00e3o de requisitos de senha\n  const passwordRequirements = createMemo(() => {\n    const pass = newPass();\n    return {\n      length: pass.length >= 8,\n      uppercase: /[A-Z]/.test(pass),\n      lowercase: /[a-z]/.test(pass),\n      number: /\\d/.test(pass),\n      special: /[!@#$%^&*(),.?\":{}|<>]/.test(pass),\n    };\n  });\n\n  // Calcular for\u00e7a da senha\n  const passwordStrength = createMemo((): PasswordStrength => {\n    const reqs = passwordRequirements();\n    const pass = newPass();\n\n    if (!pass) {\n      return { score: 0, label: 'Nenhuma', color: 'text-gray-500', barColor: 'bg-gray-500' };\n    }\n\n    const score = [reqs.length, reqs.uppercase, reqs.lowercase, reqs.number, reqs.special].filter(Boolean).length;\n\n    if (score === 5) {\n      return { score: 4, label: 'Muito Forte', color: 'text-green-500', barColor: 'bg-green-500' };\n    }\n    if (score === 4) {\n      return { score: 3, label: 'Forte', color: 'text-blue-500', barColor: 'bg-blue-500' };\n    }\n    if (score === 3) {\n      return { score: 2, label: 'M\u00e9dia', color: 'text-yellow-500', barColor: 'bg-yellow-500' };\n    }\n    if (score >= 1) {\n      return { score: 1, label: 'Fraca', color: 'text-orange-500', barColor: 'bg-orange-500' };\n    }\n\n    return { score: 0, label: 'Muito Fraca', color: 'text-red-500', barColor: 'bg-red-500' };\n  });\n\n  const isPasswordValid = createMemo(() => {\n    const reqs = passwordRequirements();\n    return reqs.length && reqs.uppercase && reqs.lowercase && reqs.number && reqs.special;\n  });\n\n  const handleChangePassword = async (e: Event) => {\n    e.preventDefault();\n\n    if (newPass() !== confirmPass()) {\n      setMessage({ type: 'error', text: 'As senhas n\u00e3o coincidem.' });\n      return;\n    }\n\n    if (!isPasswordValid()) {\n      setMessage({ type: 'error', text: 'A senha n\u00e3o atende aos requisitos m\u00ednimos de seguran\u00e7a.' });\n      return;\n    }\n\n    try {\n      const token = auth.token();\n      if (!token) {\n        setMessage({ type: 'error', text: 'Voc\u00ea precisa estar logado.' });\n        return;\n      }\n\n      const formData = new FormData();\n      formData.append('old_password', currentPass());\n      formData.append('new_password', newPass());\n      \n      const response = await fetch('/api/v1/auth/change-password', {\n        method: 'POST',\n        headers: { 'Authorization': `Bearer ${token}` },\n        body: formData\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.detail || 'Erro ao alterar senha');\n      }\n      \n      setMessage({ type: 'success', text: 'Senha alterada com sucesso!", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3253, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "042c80a1-261e-4fcb-ab99-3a64ea675845": {"__data__": {"id_": "042c80a1-261e-4fcb-ab99-3a64ea675845", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a3079cdf-9c72-4211-8b17-937bf2df6322", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "hash": "8087022e044e45a79e6e1c9ba0f766017f44e6e4d87d515027cc6b88498eb6a2", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "dc45ba00-9d3e-4238-ac88-e7de5ea641d5", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "hash": "ffc87b2f88e2e712d08080fdf767ab691946b9e0ce261e0b52ca5c51a0670c02", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "58779001-7119-49a3-9107-41b1e589798d", "node_type": "1", "metadata": {}, "hash": "84f9f2552a85bfe29742ea97d0c30512cb322d90517ea17c9565446356f3eeff", "class_name": "RelatedNodeInfo"}}, "text": "});\n      return;\n    }\n\n    try {\n      const token = auth.token();\n      if (!token) {\n        setMessage({ type: 'error', text: 'Voc\u00ea precisa estar logado.' });\n        return;\n      }\n\n      const formData = new FormData();\n      formData.append('old_password', currentPass());\n      formData.append('new_password', newPass());\n      \n      const response = await fetch('/api/v1/auth/change-password', {\n        method: 'POST',\n        headers: { 'Authorization': `Bearer ${token}` },\n        body: formData\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.detail || 'Erro ao alterar senha');\n      }\n      \n      setMessage({ type: 'success', text: 'Senha alterada com sucesso! Voc\u00ea ser\u00e1 deslogado em 3 segundos...' });\n      setCurrentPass('');\n      setNewPass('');\n      setConfirmPass('');\n\n      // Logout autom\u00e1tico ap\u00f3s 3 segundos\n      setTimeout(() => {\n        auth.logout();\n        window.location.href = '/login';\n      }, 3000);\n    } catch (err: any) {\n      setMessage({ type: 'error', text: err.message || 'Erro ao alterar senha' });\n    }\n  };\n\n  return (\n    <div class=\"p-6 max-w-3xl mx-auto\">\n      <h2 class=\"text-2xl font-bold mb-6 flex items-center gap-2\">\n        <Lock /> Perfil e Seguran\u00e7a\n      </h2>\n\n      <div class=\"card border p-6 space-y-6\">\n        <div>\n          <h3 class=\"text-lg font-medium\">Dados do Usu\u00e1rio</h3>\n          <div class=\"mt-4 grid grid-cols-2 gap-4\">\n            <div>\n              <label class=\"text-xs text-muted\">Nome de Usu\u00e1rio</label>\n              <div class=\"font-medium\">{auth.user()?.username}</div>\n            </div>\n            <div>\n              <label class=\"text-xs text-muted\">Fun\u00e7\u00e3o (Role)</label>\n              <div class=\"font-medium capitalize\">{auth.user()?.role}</div>\n            </div>\n            <div class=\"col-span-2\">\n              <label class=\"text-xs text-muted\">Segmentos Permitidos</label>\n              <div class=\"font-mono text-xs bg-secondary p-2 rounded mt-1\">\n                {JSON.stringify(auth.user()?.allowed_segments || [], null, 2)}\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <hr class=\"border-border\" />\n\n        <form onSubmit={handleChangePassword} class=\"space-y-4\">\n          <h3 class=\"text-lg font-medium\">Alterar Senha</h3>\n\n          {message() && (\n            <div class={`p-3 rounded text-sm flex items-center gap-2 ${\n              message()?.type === 'success' ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'\n            }`}>\n              {message()?.type === 'success' ?", "mimetype": "text/plain", "start_char_idx": 2502, "end_char_idx": 5121, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "58779001-7119-49a3-9107-41b1e589798d": {"__data__": {"id_": "58779001-7119-49a3-9107-41b1e589798d", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a3079cdf-9c72-4211-8b17-937bf2df6322", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "hash": "8087022e044e45a79e6e1c9ba0f766017f44e6e4d87d515027cc6b88498eb6a2", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "042c80a1-261e-4fcb-ab99-3a64ea675845", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "hash": "0188d13d424dba3c702a2bca58e3ae1204cd49db75923df87d2903b8b077a434", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "8a9e37a2-fec5-4fd2-aab2-9a044012df76", "node_type": "1", "metadata": {}, "hash": "081a211336ae7a6149ddae13843a87735ce39186c6093ab43175b573aef6781f", "class_name": "RelatedNodeInfo"}}, "text": "'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'\n            }`}>\n              {message()?.type === 'success' ? <CheckCircle size={16} /> : <AlertCircle size={16} />}\n              {message()?.text}\n            </div>\n          )}\n\n          <div>\n            <label class=\"label\">Senha Atual</label>\n            <input type=\"password\" class=\"input\" value={currentPass()} onInput={(e) => setCurrentPass(e.currentTarget.value)} required />\n          </div>\n\n          <div>\n            <label class=\"label\">Nova Senha</label>\n            <input type=\"password\" class=\"input\" value={newPass()} onInput={(e) => setNewPass(e.currentTarget.value)} required />\n\n            {/* Indicador de For\u00e7a da Senha */}\n            <Show when={newPass()}>\n              <div class=\"mt-2\">\n                <div class=\"flex justify-between items-center mb-1\">\n                  <span class=\"text-xs text-muted-foreground\">For\u00e7a da senha:</span>\n                  <span class={`text-xs font-medium ${passwordStrength().color}`}>\n                    {passwordStrength().label}\n                  </span>\n                </div>\n                <div class=\"w-full bg-gray-700 rounded-full h-2\">\n                  <div\n                    class={`h-2 rounded-full transition-all ${passwordStrength().barColor}`}\n                    style={`width: ${(passwordStrength().score / 4) * 100}%`}\n                  />\n                </div>\n              </div>\n            </Show>\n\n            {/* Requisitos de Senha */}\n            <Show when={newPass()}>\n              <div class=\"mt-3 space-y-1\">\n                <p class=\"text-xs text-muted-foreground font-medium mb-2\">Requisitos:</p>\n                <div class={`text-xs flex items-center gap-2 ${passwordRequirements().length ? 'text-green-500' : 'text-muted-foreground'}`}>\n                  {passwordRequirements().length ? <CheckCircle size={14} /> : <AlertCircle size={14} />}\n                  M\u00ednimo de 8 caracteres\n                </div>\n                <div class={`text-xs flex items-center gap-2 ${passwordRequirements().uppercase ? 'text-green-500' : 'text-muted-foreground'}`}>\n                  {passwordRequirements().uppercase ? <CheckCircle size={14} /> : <AlertCircle size={14} />}\n                  Letra mai\u00fascula (A-Z)\n                </div>\n                <div class={`text-xs flex items-center gap-2 ${passwordRequirements().lowercase ? 'text-green-500' : 'text-muted-foreground'}`}>\n                  {passwordRequirements().lowercase ? <CheckCircle size={14} /> : <AlertCircle size={14} />}\n                  Letra min\u00fascula (a-z)\n                </div>\n                <div class={`text-xs flex items-center gap-2 ${passwordRequirements().number ? 'text-green-500' : 'text-muted-foreground'}`}>\n                  {passwordRequirements().number ? <CheckCircle size={14} /> : <AlertCircle size={14} />}\n                  N\u00famero (0-9)\n                </div>\n                <div class={`text-xs flex items-center gap-2 ${passwordRequirements().special ? 'text-green-500' : 'text-muted-foreground'}`}>\n                  {passwordRequirements().special ? <CheckCircle size={14} /> : <AlertCircle size={14} />}\n                  Caractere especial (!@#$%^&*...)", "mimetype": "text/plain", "start_char_idx": 4994, "end_char_idx": 8219, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "8a9e37a2-fec5-4fd2-aab2-9a044012df76": {"__data__": {"id_": "8a9e37a2-fec5-4fd2-aab2-9a044012df76", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "a3079cdf-9c72-4211-8b17-937bf2df6322", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "hash": "8087022e044e45a79e6e1c9ba0f766017f44e6e4d87d515027cc6b88498eb6a2", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "58779001-7119-49a3-9107-41b1e589798d", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}, "hash": "5d7329de4f5fa761a6f6d498215994d6f180bf9d8c093a6f1421639a7639fc0b", "class_name": "RelatedNodeInfo"}}, "text": "'text-green-500' : 'text-muted-foreground'}`}>\n                  {passwordRequirements().lowercase ? <CheckCircle size={14} /> : <AlertCircle size={14} />}\n                  Letra min\u00fascula (a-z)\n                </div>\n                <div class={`text-xs flex items-center gap-2 ${passwordRequirements().number ? 'text-green-500' : 'text-muted-foreground'}`}>\n                  {passwordRequirements().number ? <CheckCircle size={14} /> : <AlertCircle size={14} />}\n                  N\u00famero (0-9)\n                </div>\n                <div class={`text-xs flex items-center gap-2 ${passwordRequirements().special ? 'text-green-500' : 'text-muted-foreground'}`}>\n                  {passwordRequirements().special ? <CheckCircle size={14} /> : <AlertCircle size={14} />}\n                  Caractere especial (!@#$%^&*...)\n                </div>\n              </div>\n            </Show>\n          </div>\n\n          <div>\n            <label class=\"label\">Confirmar Nova Senha</label>\n            <input type=\"password\" class=\"input\" value={confirmPass()} onInput={(e) => setConfirmPass(e.currentTarget.value)} required />\n            <Show when={confirmPass() && newPass() !== confirmPass()}>\n              <p class=\"text-xs text-red-500 mt-1 flex items-center gap-1\">\n                <AlertCircle size={12} />\n                As senhas n\u00e3o coincidem\n              </p>\n            </Show>\n          </div>\n\n          <button\n            type=\"submit\"\n            class=\"btn btn-primary\"\n            disabled={!isPasswordValid() || newPass() !== confirmPass()}\n          >\n            Salvar Nova Senha\n          </button>\n        </form>\n\n        {/* Dicas de Seguran\u00e7a */}\n        <div class=\"p-4 bg-blue-500/5 border border-blue-500/20 rounded-lg\">\n          <h4 class=\"font-semibold text-blue-500 mb-2 flex items-center gap-2\">\n            <Shield size={18} />\n            Dicas de Seguran\u00e7a\n          </h4>\n          <ul class=\"text-sm text-muted-foreground space-y-1 list-disc list-inside\">\n            <li>Nunca compartilhe sua senha com outras pessoas</li>\n            <li>Use senhas diferentes para cada sistema</li>\n            <li>Evite senhas \u00f3bvias como datas de nascimento</li>\n            <li>Considere usar um gerenciador de senhas</li>\n            <li>Troque sua senha regularmente (a cada 3-6 meses)</li>\n          </ul>\n        </div>\n      </div>\n\n      {/* User Preferences Section */}\n      <div class=\"card border p-6 mt-6\">\n        <UserPreferences />\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 7398, "end_char_idx": 9902, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "efe5985f-bee3-4e3d-a313-83ca4632fd4e": {"__data__": {"id_": "efe5985f-bee3-4e3d-a313-83ca4632fd4e", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9e523807-7308-4af7-ba56-998ea6431ba2", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "hash": "e9ba5252e1adfae69fa4e31a859572beb2d5ef250d1af6684177183f4ec587bd", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "038f01e9-3e44-4977-a6ff-fa1593623260", "node_type": "1", "metadata": {}, "hash": "73340247430e61b20f8e2925c1a2f8e135acd7f390731652789c8c90bb44558b", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, onMount, For, Show } from 'solid-js';\nimport { FileText, Download, Filter, Calendar, RefreshCw, Search, Package } from 'lucide-solid';\nimport api from '../lib/api';\n\ninterface TransferReport {\n  batch_id?: string;\n  transfer_id?: string;\n  modo?: string;\n  solicitante_id: string;\n  timestamp: string;\n  total_transferencias?: number;\n  transferencias?: Array<{\n    produto_id: number;\n    une_origem: number;\n    une_destino: number;\n    quantidade: number;\n  }>;\n  produto_id?: number;\n  une_origem?: number;\n  une_destino?: number;\n  quantidade?: number;\n}\n\nexport default function Reports() {\n  const [reports, setReports] = createSignal<TransferReport[]>([]);\n  const [loading, setLoading] = createSignal(true);\n  const [error, setError] = createSignal<string | null>(null);\n\n  // Filtros\n  const [startDate, setStartDate] = createSignal('');\n  const [endDate, setEndDate] = createSignal('');\n  const [searchTerm, setSearchTerm] = createSignal('');\n\n  const loadReports = async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const params = new URLSearchParams();\n      if (startDate()) params.append('start_date', startDate());\n      if (endDate()) params.append('end_date', endDate());\n\n      const response = await api.get<TransferReport[]>(`/transfers/report?${params.toString()}`);\n      setReports(response.data);\n    } catch (err: any) {\n      console.error('Erro ao carregar relat\u00f3rios:', err);\n      setError(err.response?.data?.detail || 'Erro ao carregar relat\u00f3rios');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const downloadReport = (report: TransferReport) => {\n    const dataStr = JSON.stringify(report, null, 2);\n    const dataBlob = new Blob([dataStr], { type: 'application/json' });\n    const url = URL.createObjectURL(dataBlob);\n    const link = document.createElement('a');\n    link.href = url;\n    const fileName = report.batch_id || report.transfer_id || 'transfer-report';\n    link.download = `${fileName}.json`;\n    link.click();\n    URL.revokeObjectURL(url);\n  };\n\n  const downloadAllAsCSV = () => {\n    const allTransfers: any[] = [];\n\n    reports().forEach(report => {\n      if (report.transferencias) {\n        // Batch transfer\n        report.transferencias.forEach(t => {\n          allTransfers.push({\n            .t,\n            solicitante: report.solicitante_id,\n            timestamp: report.timestamp,\n            batch_id: report.batch_id\n          });\n        });\n      } else {\n        // Single transfer\n        allTransfers.push({\n          produto_id: report.produto_id,\n          une_origem: report.une_origem,\n          une_destino: report.une_destino,\n          quantidade: report.quantidade,\n          solicitante: report.solicitante_id,\n          timestamp: report.timestamp,\n          transfer_id: report.transfer_id\n        });\n      }\n    });\n\n    if (allTransfers.length === 0) {\n      alert('Nenhuma transfer\u00eancia para exportar');\n      return;\n    }\n\n    // Gerar CSV\n    const headers = ['Produto ID', 'UNE Origem', 'UNE Destino', 'Quantidade', 'Solicitante', 'Data/Hora', 'ID'];\n    const csv = [\n      headers.join(','),\n      .allTransfers.map(t =>\n        [\n          t.produto_id,\n          t.une_origem,\n          t.une_destino,\n          t.quantidade,\n          t.solicitante,\n          t.timestamp,\n          t.batch_id || t.transfer_id || ''\n        ].join(',')\n      )\n    ].join('\\n');\n\n    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = `transferencias-${new Date().toISOString().split('T')[0]}.csv`;\n    link.click();", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "038f01e9-3e44-4977-a6ff-fa1593623260": {"__data__": {"id_": "038f01e9-3e44-4977-a6ff-fa1593623260", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9e523807-7308-4af7-ba56-998ea6431ba2", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "hash": "e9ba5252e1adfae69fa4e31a859572beb2d5ef250d1af6684177183f4ec587bd", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "efe5985f-bee3-4e3d-a313-83ca4632fd4e", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "hash": "067dfa7041e5e2655739b48c70505fda8fdb3f3b0645b6874a4091d868c064dd", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2d80feb5-ebf0-40df-9d23-1227f201b201", "node_type": "1", "metadata": {}, "hash": "c7323df4a8682facdd814076806b1f530b788f4a6b5821ed71d4cad81ec332b3", "class_name": "RelatedNodeInfo"}}, "text": "'UNE Destino', 'Quantidade', 'Solicitante', 'Data/Hora', 'ID'];\n    const csv = [\n      headers.join(','),\n      .allTransfers.map(t =>\n        [\n          t.produto_id,\n          t.une_origem,\n          t.une_destino,\n          t.quantidade,\n          t.solicitante,\n          t.timestamp,\n          t.batch_id || t.transfer_id || ''\n        ].join(',')\n      )\n    ].join('\\n');\n\n    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = `transferencias-${new Date().toISOString().split('T')[0]}.csv`;\n    link.click();\n    URL.revokeObjectURL(url);\n  };\n\n  const filteredReports = () => {\n    if (!searchTerm()) return reports();\n\n    return reports().filter(report => {\n      const search = searchTerm().toLowerCase();\n      return (\n        report.solicitante_id?.toLowerCase().includes(search) ||\n        report.batch_id?.toLowerCase().includes(search) ||\n        report.transfer_id?.toLowerCase().includes(search)\n      );\n    });\n  };\n\n  const setQuickFilter = (days: number) => {\n    const end = new Date();\n    const start = new Date();\n    start.setDate(start.getDate() - days);\n\n    setEndDate(end.toISOString().split('T')[0]);\n    setStartDate(start.toISOString().split('T')[0]);\n    loadReports();\n  };\n\n  onMount(() => {\n    loadReports();\n  });\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6\">\n      {/* Header */}\n      <div class=\"flex justify-between items-end\">\n        <div>\n          <h2 class=\"text-2xl font-bold flex items-center gap-2\">\n            <FileText size={28} />\n            Relat\u00f3rios de Transfer\u00eancias\n          </h2>\n          <p class=\"text-muted\">Hist\u00f3rico de solicita\u00e7\u00f5es de transfer\u00eancias entre UNEs</p>\n        </div>\n        <button\n          onClick={loadReports}\n          class=\"btn btn-outline gap-2\"\n          disabled={loading()}\n        >\n          <RefreshCw size={16} class={loading() ?", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2d80feb5-ebf0-40df-9d23-1227f201b201": {"__data__": {"id_": "2d80feb5-ebf0-40df-9d23-1227f201b201", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9e523807-7308-4af7-ba56-998ea6431ba2", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "hash": "e9ba5252e1adfae69fa4e31a859572beb2d5ef250d1af6684177183f4ec587bd", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "038f01e9-3e44-4977-a6ff-fa1593623260", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "hash": "040a6f053fabe5d2efc8d6ba9be42534f84f5a3c1d4903a746b783f32a94dd23", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "a79cb706-d28c-48b5-8e01-045dc1e95136", "node_type": "1", "metadata": {}, "hash": "0145c307522c0b5698d8b3a3f12fc9463815fa9eae723e0a86110e0104bf2745", "class_name": "RelatedNodeInfo"}}, "text": "toISOString().split('T')[0]);\n    setStartDate(start.toISOString().split('T')[0]);\n    loadReports();\n  };\n\n  onMount(() => {\n    loadReports();\n  });\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6\">\n      {/* Header */}\n      <div class=\"flex justify-between items-end\">\n        <div>\n          <h2 class=\"text-2xl font-bold flex items-center gap-2\">\n            <FileText size={28} />\n            Relat\u00f3rios de Transfer\u00eancias\n          </h2>\n          <p class=\"text-muted\">Hist\u00f3rico de solicita\u00e7\u00f5es de transfer\u00eancias entre UNEs</p>\n        </div>\n        <button\n          onClick={loadReports}\n          class=\"btn btn-outline gap-2\"\n          disabled={loading()}\n        >\n          <RefreshCw size={16} class={loading() ? 'animate-spin' : ''} />\n          Atualizar\n        </button>\n      </div>\n\n      {/* Filters */}\n      <div class=\"card p-4 border\">\n        <div class=\"flex items-center gap-2 mb-4\">\n          <Filter size={20} />\n          <h3 class=\"font-semibold\">Filtros</h3>\n        </div>\n\n        {/* Quick Filters */}\n        <div class=\"flex gap-2 mb-4\">\n          <button class=\"btn btn-outline text-sm\" onClick={() => setQuickFilter(7)}>\n            \u00daltimos 7 dias\n          </button>\n          <button class=\"btn btn-outline text-sm\" onClick={() => setQuickFilter(30)}>\n            \u00daltimos 30 dias\n          </button>\n          <button class=\"btn btn-outline text-sm\" onClick={() => setQuickFilter(90)}>\n            \u00daltimos 90 dias\n          </button>\n        </div>\n\n        {/* Custom Filters */}\n        <div class=\"grid grid-cols-1 md:grid-cols-4 gap-3\">\n          <input\n            type=\"date\"\n            class=\"input\"\n            value={startDate()}\n            onInput={(e) => setStartDate(e.currentTarget.value)}\n            placeholder=\"Data In\u00edcio\"\n          />\n          <input\n            type=\"date\"\n            class=\"input\"\n            value={endDate()}\n            onInput={(e) => setEndDate(e.currentTarget.value)}\n            placeholder=\"Data Fim\"\n          />\n          <input\n            type=\"text\"\n            class=\"input\"\n            placeholder=\"Buscar por solicitante ou ID...\"\n            value={searchTerm()}\n            onInput={(e) => setSearchTerm(e.currentTarget.value)}\n          />\n          <button\n            class=\"btn btn-primary\"\n            onClick={loadReports}\n            disabled={loading()}\n          >\n            Aplicar Filtros\n          </button>\n        </div>\n      </div>\n\n      {/* Error State */}\n      <Show when={error()}>\n        <div class=\"card p-4 border-red-500 bg-red-500/10\">\n          <p class=\"text-red-500\">{error()}</p>\n        </div>\n      </Show>\n\n      {/* Stats */}\n      <div class=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <div class=\"card p-4 border\">\n          <div class=\"text-sm text-muted mb-1\">Total de Solicita\u00e7\u00f5es</div>\n          <div class=\"text-2xl font-bold\">{filteredReports().length}</div>\n        </div>\n\n        <div class=\"card p-4 border\">\n          <div class=\"text-sm text-muted mb-1\">Total de Transfer\u00eancias</div>\n          <div class=\"text-2xl font-bold\">\n            {filteredReports().reduce((acc, r) => acc + (r.total_transferencias || 1), 0)}\n          </div>\n        </div>\n\n        <div class=\"card p-4 border\">\n          <div class=\"text-sm text-muted mb-1\">A\u00e7\u00f5es</div>\n          <button\n            class=\"btn btn-outline w-full gap-2 text-sm\"\n            onClick={downloadAllAsCSV}\n            disabled={filteredReports().length === 0}\n          >\n            <Download size={16} />\n            Exportar Tudo (CSV)\n          </button>\n        </div>\n      </div>\n\n      {/* Loading State */}\n      <Show when={loading()}>\n        <div class=\"flex-1 flex items-center justify-center\">\n          <div class=\"text-center\">\n            <RefreshCw size={48} class=\"mx-auto mb-4 opacity-50 animate-spin\" />\n            <p class=\"text-muted\">Carregando relat\u00f3rios...</p>\n          </div>\n        </div>\n      </Show>\n\n      {/* Reports Table */}\n      <Show when={!loading()}>\n        <div class=\"card border\">\n          <div class=\"p-4 border-b\">\n            <h3 class=\"font-semibold\">\n              Hist\u00f3rico ({filteredReports().length} {filteredReports().length === 1 ?", "mimetype": "text/plain", "start_char_idx": 4285, "end_char_idx": 8502, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "a79cb706-d28c-48b5-8e01-045dc1e95136": {"__data__": {"id_": "a79cb706-d28c-48b5-8e01-045dc1e95136", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "9e523807-7308-4af7-ba56-998ea6431ba2", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "hash": "e9ba5252e1adfae69fa4e31a859572beb2d5ef250d1af6684177183f4ec587bd", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2d80feb5-ebf0-40df-9d23-1227f201b201", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}, "hash": "6a1d78109b1623e646651d46b12b4affc482395e83c163b6c1469660cfde382a", "class_name": "RelatedNodeInfo"}}, "text": "'solicita\u00e7\u00e3o' : 'solicita\u00e7\u00f5es'})\n            </h3>\n          </div>\n\n          <Show when={filteredReports().length > 0} fallback={\n            <div class=\"p-12 text-center text-muted\">\n              <Package size={48} class=\"mx-auto mb-4 opacity-20\" />\n              <p>Nenhuma solicita\u00e7\u00e3o encontrada</p>\n              <p class=\"text-sm mt-2\">Ajuste os filtros ou crie uma nova transfer\u00eancia</p>\n            </div>\n          }>\n            <div class=\"overflow-x-auto\">\n              <table class=\"w-full\">\n                <thead class=\"bg-muted/50\">\n                  <tr class=\"text-left text-xs font-medium text-muted uppercase\">\n                    <th class=\"p-3\">ID</th>\n                    <th class=\"p-3\">Tipo</th>\n                    <th class=\"p-3\">Transfer\u00eancias</th>\n                    <th class=\"p-3\">Solicitante</th>\n                    <th class=\"p-3\">Data/Hora</th>\n                    <th class=\"p-3 text-right\">A\u00e7\u00f5es</th>\n                  </tr>\n                </thead>\n                <tbody class=\"divide-y\">\n                  <For each={filteredReports()}>\n                    {(report) => (\n                      <tr class=\"hover:bg-muted/30 transition-colors\">\n                        <td class=\"p-3 font-mono text-xs\">\n                          {report.batch_id || report.transfer_id || 'N/A'}\n                        </td>\n                        <td class=\"p-3\">\n                          <span class={`px-2 py-1 text-xs rounded ${\n                            report.batch_id\n                              ? 'bg-blue-500/10 text-blue-400'\n                              : 'bg-green-500/10 text-green-400'\n                          }`}>\n                            {report.batch_id ? `Lote (${report.modo})` : 'Simples'}\n                          </span>\n                        </td>\n                        <td class=\"p-3 font-semibold\">\n                          {report.total_transferencias || 1}\n                        </td>\n                        <td class=\"p-3 text-sm\">{report.solicitante_id}</td>\n                        <td class=\"p-3 text-sm font-mono text-muted\">\n                          {new Date(report.timestamp).toLocaleString('pt-BR')}\n                        </td>\n                        <td class=\"p-3 text-right\">\n                          <button\n                            class=\"btn btn-outline btn-sm gap-2\"\n                            onClick={() => downloadReport(report)}\n                          >\n                            <Download size={14} />\n                            JSON\n                          </button>\n                        </td>\n                      </tr>\n                    )}\n                  </For>\n                </tbody>\n              </table>\n            </div>\n          </Show>\n        </div>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 8503, "end_char_idx": 11320, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "af494ee7-b56b-4fb9-9977-d2c36c3de341": {"__data__": {"id_": "af494ee7-b56b-4fb9-9977-d2c36c3de341", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fece5066-9485-4734-8b7e-e516ad9b868f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f46a98e2-a9ec-4392-b739-c261d567ed98", "node_type": "1", "metadata": {}, "hash": "b5d75d50e9218553485edceef078b415bd9552c3d43efd3a53fe1dfd254515f0", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, onMount, Show, For } from 'solid-js';\nimport { rupturasApi, Ruptura, RupturasSummary } from '@/lib/api';\nimport { AlertTriangle, RefreshCw, PackageX, ShoppingCart, Archive, Download, Filter, X, TrendingUp, Package, BarChart3, PieChart } from 'lucide-solid';\nimport { PlotlyChart } from '@/components/PlotlyChart';\nimport { ChartDownloadButton } from '@/components/ChartDownloadButton';\n\nexport default function Rupturas() {\n  const [data, setData] = createSignal<Ruptura[]>([]);\n  const [loading, setLoading] = createSignal(true);\n  const [error, setError] = createSignal<string | null>(null);\n  const [summary, setSummary] = createSignal<RupturasSummary>({ total: 0, criticos: 0, valor_estimado: 0 });\n\n  // Chart specs\n  const [criticidadeChart, setCriticidadeChart] = createSignal<any>({});\n  const [topRupturasChart, setTopRupturasChart] = createSignal<any>({});\n  const [necessidadeSegmentoChart, setNecessidadeSegmentoChart] = createSignal<any>({});\n  const [selectedProduct, setSelectedProduct] = createSignal<Ruptura | null>(null);\n\n  // Filtros\n  const [segmentos, setSegmentos] = createSignal<string[]>([]);\n  const [unes, setUnes] = createSignal<string[]>([]);\n  const [selectedSegmento, setSelectedSegmento] = createSignal<string>('');\n  const [selectedUne, setSelectedUne] = createSignal<string>('');\n  const [showFilters, setShowFilters] = createSignal(false);\n  const [filtersLoading, setFiltersLoading] = createSignal(false);\n\n  const loadFilters = async () => {\n    setFiltersLoading(true);\n    try {\n      const [segmentosRes, unesRes] = await Promise.all([\n        rupturasApi.getSegmentos(),\n        rupturasApi.getUnes()\n      ]);\n      setSegmentos(Array.isArray(segmentosRes.data) ? segmentosRes.data : []);\n      setUnes(Array.isArray(unesRes.data) ? unesRes.data : []);\n    } catch (err) {\n      console.error(\"Error loading filters:\", err);\n      setSegmentos([]);\n      setUnes([]);\n    } finally {\n      setFiltersLoading(false);\n    }\n  };\n\n  const loadData = async () => {\n    setLoading(true);\n    setError(null);\n    try {\n      const segmento = selectedSegmento() || undefined;\n      const une = selectedUne() || undefined;\n\n      const [rupturaRes, summaryRes] = await Promise.all([\n        rupturasApi.getCritical(50, segmento, une),\n        rupturasApi.getSummary(segmento, une)\n      ]);\n\n      setData(rupturaRes.data);\n      setSummary(summaryRes.data);\n\n      // Gerar gr\u00e1ficos\n      generateCharts(rupturaRes.data);\n    } catch (err: any) {\n      console.error(\"Error loading rupturas:\", err);\n      setError(\"Falha ao carregar rupturas cr\u00edticas.\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const generateCharts = (rupturas: Ruptura[]) => {\n    if (rupturas.length === 0) return;\n\n    // 1.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2768, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f46a98e2-a9ec-4392-b739-c261d567ed98": {"__data__": {"id_": "f46a98e2-a9ec-4392-b739-c261d567ed98", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fece5066-9485-4734-8b7e-e516ad9b868f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "af494ee7-b56b-4fb9-9977-d2c36c3de341", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "86652d7c2058b2a9517be11d27ab3b4a76fd37e83acd80a0b95a7b8c8ff61d37", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3e8f2ec6-c323-40b4-9ed6-be276661afbd", "node_type": "1", "metadata": {}, "hash": "532b351cea9f231a0b350085977045f4704dce12c7b4739e481478ff494b7483", "class_name": "RelatedNodeInfo"}}, "text": "\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const generateCharts = (rupturas: Ruptura[]) => {\n    if (rupturas.length === 0) return;\n\n    // 1. Gr\u00e1fico de Pizza - Distribui\u00e7\u00e3o de Criticidade\n    const criticidade = {\n      critico: rupturas.filter(r => r.CRITICIDADE_PCT >= 75).length,\n      alto: rupturas.filter(r => r.CRITICIDADE_PCT >= 50 && r.CRITICIDADE_PCT < 75).length,\n      medio: rupturas.filter(r => r.CRITICIDADE_PCT >= 25 && r.CRITICIDADE_PCT < 50).length,\n      baixo: rupturas.filter(r => r.CRITICIDADE_PCT < 25).length\n    };\n\n    setCriticidadeChart({\n      data: [{\n        type: 'pie',\n        labels: ['CR\u00cdTICO (\u226575%)', 'ALTO (50-75%)', 'M\u00c9DIO (25-50%)', 'BAIXO (<25%)'],\n        values: [criticidade.critico, criticidade.alto, criticidade.medio, criticidade.baixo],\n        marker: {\n          colors: ['#ef4444', '#f97316', '#f59e0b', '#3b82f6']\n        },\n        textinfo: 'label+value+percent',\n        textposition: 'inside',\n        textfont: { size: 11, color: '#ffffff' },\n        hovertemplate: '<b>%{label}</b><br>Produtos: %{value}<br>%{percent}<extra></extra>'\n      }],\n      layout: {\n        title: {\n          text: 'Distribui\u00e7\u00e3o por Criticidade',\n          font: { size: 16, color: '#e5e7eb' }\n        },\n        plot_bgcolor: '#1f2937',\n        paper_bgcolor: '#1f2937',\n        margin: { l: 20, r: 20, t: 60, b: 20 },\n        font: { color: '#e5e7eb' },\n        showlegend: false\n      },\n      config: { responsive: true }\n    });\n\n    // 2.", "mimetype": "text/plain", "start_char_idx": 2610, "end_char_idx": 4108, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3e8f2ec6-c323-40b4-9ed6-be276661afbd": {"__data__": {"id_": "3e8f2ec6-c323-40b4-9ed6-be276661afbd", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fece5066-9485-4734-8b7e-e516ad9b868f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "f46a98e2-a9ec-4392-b739-c261d567ed98", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "e0bc980657552bcc4e1f7980d381edd4de86ede5b7b21da49b6ad875ffaee2da", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e06a546b-df1f-4d68-9083-494a3e4a7d23", "node_type": "1", "metadata": {}, "hash": "3aafc3c00c53c9cd9da5ff75fea89068234a35aa8ae4bc55584f9b6b87fa739e", "class_name": "RelatedNodeInfo"}}, "text": "Gr\u00e1fico de Barras - Top 10 Produtos em Ruptura\n    const top10 = rupturas\n      .sort((a, b) => b.NECESSIDADE - a.NECESSIDADE)\n      .slice(0, 10);\n\n    setTopRupturasChart({\n      data: [{\n        type: 'bar',\n        x: top10.map(r => r.NOME.substring(0, 30) + '...'),\n        y: top10.map(r => r.NECESSIDADE),\n        marker: {\n          color: top10.map(r => {\n            if (r.CRITICIDADE_PCT >= 75) return '#ef4444';\n            if (r.CRITICIDADE_PCT >= 50) return '#f97316';\n            if (r.CRITICIDADE_PCT >= 25) return '#f59e0b';\n            return '#3b82f6';\n          }),\n          line: { color: '#1e40af', width: 1 }\n        },\n        text: top10.map(r => Math.round(r.NECESSIDADE)),\n        textposition: 'outside',\n        hovertemplate: '<b>%{x}</b><br>Necessidade: %{y:.0f} un<br>C\u00f3digo: ' +\n          top10.map(r => r.PRODUTO).join('<br>C\u00f3digo: ') + '<extra></extra>',\n        customdata: top10.map(r => r.PRODUTO)\n      }],\n      layout: {\n        title: {\n          text: 'Top 10 Produtos - Maior Necessidade',\n          font: { size: 16, color: '#e5e7eb' }\n        },\n        xaxis: {\n          title: '',\n          tickangle: -45,\n          tickfont: { size: 9, color: '#9ca3af' },\n          gridcolor: '#374151'\n        },\n        yaxis: {\n          title: 'Necessidade (unidades)',\n          titlefont: { color: '#9ca3af' },\n          tickfont: { color: '#9ca3af' },\n          gridcolor: '#374151'\n        },\n        plot_bgcolor: '#1f2937',\n        paper_bgcolor: '#1f2937',\n        margin: { l: 60, r: 20, t: 60, b: 120 },\n        font: { color: '#e5e7eb' }\n      },\n      config: { responsive: true }\n    });\n\n    // 3. Gr\u00e1fico de Barras Empilhadas - Necessidade por Segmento\n    const segmentoData: { [key: string]: { critico: number, alto: number, medio: number, baixo: number } } = {};\n\n    rupturas.forEach(r => {\n      const seg = r.NOMESEGMENTO || 'SEM SEGMENTO';\n      if (!segmentoData[seg]) {\n        segmentoData[seg] = { critico: 0, alto: 0, medio: 0, baixo: 0 };\n      }\n\n      const necessidade = r.NECESSIDADE;\n      if (r.CRITICIDADE_PCT >= 75) segmentoData[seg].critico += necessidade;\n      else if (r.CRITICIDADE_PCT >= 50) segmentoData[seg].alto += necessidade;\n      else if (r.CRITICIDADE_PCT >= 25) segmentoData[seg].medio += necessidade;\n      else segmentoData[seg].baixo += necessidade;\n    });\n\n    const segmentos = Object.keys(segmentoData);\n\n    setNecessidadeSegmentoChart({\n      data: [\n        {\n          type: 'bar',\n          name: 'CR\u00cdTICO',\n          x: segmentos,\n          y: segmentos.map(s => segmentoData[s].critico),\n          marker: { color: '#ef4444' },\n          hovertemplate: '<b>%{x}</b><br>Cr\u00edtico: %{y:.0f} un<extra></extra>'\n        },\n        {\n          type: 'bar',\n          name: 'ALTO',\n          x: segmentos,\n          y: segmentos.map(s => segmentoData[s].alto),\n          marker: { color: '#f97316' },\n          hovertemplate: '<b>%{x}</b><br>Alto: %{y:.0f} un<extra></extra>'\n        },\n        {\n          type: 'bar',\n          name: 'M\u00c9DIO',", "mimetype": "text/plain", "start_char_idx": 4109, "end_char_idx": 7149, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e06a546b-df1f-4d68-9083-494a3e4a7d23": {"__data__": {"id_": "e06a546b-df1f-4d68-9083-494a3e4a7d23", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fece5066-9485-4734-8b7e-e516ad9b868f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3e8f2ec6-c323-40b4-9ed6-be276661afbd", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "cb8b977a0f9cbf8cccebf4f7b10fa76a7cf56eca2cbea3cacccfddf8529224a0", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "3d1e557e-395d-4b62-a07d-be31d4709cf2", "node_type": "1", "metadata": {}, "hash": "cd3d7290d59d500412f2f132889af1bc6b5965a16332ac40fa93aa59492a11a1", "class_name": "RelatedNodeInfo"}}, "text": "name: 'CR\u00cdTICO',\n          x: segmentos,\n          y: segmentos.map(s => segmentoData[s].critico),\n          marker: { color: '#ef4444' },\n          hovertemplate: '<b>%{x}</b><br>Cr\u00edtico: %{y:.0f} un<extra></extra>'\n        },\n        {\n          type: 'bar',\n          name: 'ALTO',\n          x: segmentos,\n          y: segmentos.map(s => segmentoData[s].alto),\n          marker: { color: '#f97316' },\n          hovertemplate: '<b>%{x}</b><br>Alto: %{y:.0f} un<extra></extra>'\n        },\n        {\n          type: 'bar',\n          name: 'M\u00c9DIO',\n          x: segmentos,\n          y: segmentos.map(s => segmentoData[s].medio),\n          marker: { color: '#f59e0b' },\n          hovertemplate: '<b>%{x}</b><br>M\u00e9dio: %{y:.0f} un<extra></extra>'\n        },\n        {\n          type: 'bar',\n          name: 'BAIXO',\n          x: segmentos,\n          y: segmentos.map(s => segmentoData[s].baixo),\n          marker: { color: '#3b82f6' },\n          hovertemplate: '<b>%{x}</b><br>Baixo: %{y:.0f} un<extra></extra>'\n        }\n      ],\n      layout: {\n        title: {\n          text: 'Necessidade por Segmento e Criticidade',\n          font: { size: 16, color: '#e5e7eb' }\n        },\n        barmode: 'stack',\n        xaxis: {\n          title: '',\n          tickangle: -45,\n          tickfont: { size: 10, color: '#9ca3af' },\n          gridcolor: '#374151'\n        },\n        yaxis: {\n          title: 'Necessidade Total (unidades)',\n          titlefont: { color: '#9ca3af' },\n          tickfont: { color: '#9ca3af' },\n          gridcolor: '#374151'\n        },\n        plot_bgcolor: '#1f2937',\n        paper_bgcolor: '#1f2937',\n        margin: { l: 60, r: 20, t: 60, b: 100 },\n        font: { color: '#e5e7eb' },\n        showlegend: true,\n        legend: {\n          orientation: 'h',\n          x: 0.5,\n          y: 1.1,\n          xanchor: 'center',\n          font: { size: 10, color: '#9ca3af' }\n        }\n      },\n      config: { responsive: true }\n    });\n  };\n\n  const handleChartClick = (clickData: any) => {\n    if (clickData && clickData.points && clickData.points[0]) {\n      const point = clickData.points[0];\n      // Se tem customdata, \u00e9 o c\u00f3digo do produto\n      if (point.customdata) {\n        const produto = data().find(r => r.PRODUTO === point.customdata);\n        if (produto) {\n          setSelectedProduct(produto);\n        }\n      }\n    }\n  };\n\n  const clearFilters = () => {\n    setSelectedSegmento('');\n    setSelectedUne('');\n    loadData();\n  };\n\n  const exportCSV = () => {\n    const items = data();\n    if (items.length === 0) return;\n\n    const headers = ['Produto', 'Nome', 'UNE', 'Segmento', 'Venda 30d', 'Estoque UNE', 'Estoque CD', 'Linha Verde', 'Criticidade %', 'Necessidade'];\n    const rows = items.map(item => [\n      item.PRODUTO,\n      item.NOME,\n      item.UNE,\n      item.NOMESEGMENTO || '',\n      item.VENDA_30DD,\n      item.ESTOQUE_UNE,\n      item.ESTOQUE_CD,\n      item.ESTOQUE_LV,\n      item.CRITICIDADE_PCT.toFixed(1),\n      item.NECESSIDADE\n    ]);\n\n    const csv = [headers, .", "mimetype": "text/plain", "start_char_idx": 6602, "end_char_idx": 9618, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "3d1e557e-395d-4b62-a07d-be31d4709cf2": {"__data__": {"id_": "3d1e557e-395d-4b62-a07d-be31d4709cf2", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fece5066-9485-4734-8b7e-e516ad9b868f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "e06a546b-df1f-4d68-9083-494a3e4a7d23", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "1b0247a78fe90a38a7c0c39b7b735e5084b6d56f38b4ce9f5f38285e9d83fc7c", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "9611f88a-2a44-494c-891b-cc138b4dbe11", "node_type": "1", "metadata": {}, "hash": "abf6c1617c9f97a97b9c9b128acaf5f39b4a498b27bc978bd6625af4655d1d27", "class_name": "RelatedNodeInfo"}}, "text": "};\n\n  const exportCSV = () => {\n    const items = data();\n    if (items.length === 0) return;\n\n    const headers = ['Produto', 'Nome', 'UNE', 'Segmento', 'Venda 30d', 'Estoque UNE', 'Estoque CD', 'Linha Verde', 'Criticidade %', 'Necessidade'];\n    const rows = items.map(item => [\n      item.PRODUTO,\n      item.NOME,\n      item.UNE,\n      item.NOMESEGMENTO || '',\n      item.VENDA_30DD,\n      item.ESTOQUE_UNE,\n      item.ESTOQUE_CD,\n      item.ESTOQUE_LV,\n      item.CRITICIDADE_PCT.toFixed(1),\n      item.NECESSIDADE\n    ]);\n\n    const csv = [headers, .rows].map(row => row.join(',')).join('\\n');\n    const blob = new Blob([csv], { type: 'text/csv' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `rupturas_criticas_${new Date().toISOString().split('T')[0]}.csv`;\n    a.click();\n    URL.revokeObjectURL(url);\n  };\n\n  onMount(() => {\n    loadFilters();\n    loadData();\n  });\n\n  const getCriticidadeColor = (pct: number) => {\n    if (pct >= 75) return 'bg-red-500/20 text-red-500 border-red-500/30';\n    if (pct >= 50) return 'bg-orange-500/20 text-orange-500 border-orange-500/30';\n    if (pct >= 25) return 'bg-yellow-500/20 text-yellow-500 border-yellow-500/30';\n    return 'bg-blue-500/20 text-blue-500 border-blue-500/30';\n  };\n\n  const getCriticidadeLabel = (pct: number) => {\n    if (pct >= 75) return 'CR\u00cdTICO';\n    if (pct >= 50) return 'ALTO';\n    if (pct >= 25) return 'M\u00c9DIO';\n    return 'BAIXO';\n  };\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6 max-w-7xl mx-auto\">\n      {/* Header */}\n      <div class=\"flex justify-between items-start\">\n        <div>\n          <h2 class=\"text-2xl font-bold tracking-tight text-red-500 flex items-center gap-2\">\n            <AlertTriangle size={24} />\n            Rupturas Cr\u00edticas\n          </h2>\n          <p class=\"text-muted mt-1\">CD zerado + Estoque loja abaixo da Linha Verde</p>\n        </div>\n        <div class=\"flex gap-2\">\n          <button onClick={() => {\n            console.log(\"Toggling filters:\", !showFilters());\n            setShowFilters(!showFilters());\n          }} class=\"btn btn-outline gap-2\">\n            <Filter size={16} />\n            Filtros\n          </button>\n          <button onClick={exportCSV} class=\"btn btn-outline gap-2\" disabled={data().length === 0}>\n            <Download size={16} />\n            Exportar CSV\n          </button>\n          <button onClick={loadData} class=\"btn btn-outline gap-2\" disabled={loading()}>\n            <RefreshCw size={16} class={loading() ?", "mimetype": "text/plain", "start_char_idx": null, "end_char_idx": null, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9611f88a-2a44-494c-891b-cc138b4dbe11": {"__data__": {"id_": "9611f88a-2a44-494c-891b-cc138b4dbe11", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fece5066-9485-4734-8b7e-e516ad9b868f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "3d1e557e-395d-4b62-a07d-be31d4709cf2", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "c95a5af47c36aa18e7f670950c1905de7582fb382d7e9388d948144c927f9b8b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "2f9496ff-c19a-4c9c-9535-a40283e396fb", "node_type": "1", "metadata": {}, "hash": "bedd34cb5737eea88c1c5503fc25c2bc454059ce0089aa86aac23ed8efc82623", "class_name": "RelatedNodeInfo"}}, "text": "log(\"Toggling filters:\", !showFilters());\n            setShowFilters(!showFilters());\n          }} class=\"btn btn-outline gap-2\">\n            <Filter size={16} />\n            Filtros\n          </button>\n          <button onClick={exportCSV} class=\"btn btn-outline gap-2\" disabled={data().length === 0}>\n            <Download size={16} />\n            Exportar CSV\n          </button>\n          <button onClick={loadData} class=\"btn btn-outline gap-2\" disabled={loading()}>\n            <RefreshCw size={16} class={loading() ? 'animate-spin' : ''} />\n            Atualizar\n          </button>\n        </div>\n      </div>\n\n      {/* Filtros */}\n      <Show when={showFilters()}>\n        <div class=\"p-4 bg-card border rounded-lg\">\n          <div class=\"flex items-center justify-between mb-4\">\n            <h3 class=\"font-semibold\">Filtros</h3>\n            <button onClick={() => setShowFilters(false)} class=\"text-muted-foreground hover:text-foreground\">\n              <X size={18} />\n            </button>\n          </div>\n          <div class=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <label class=\"block text-sm font-medium mb-2\">Segmento</label>\n              <select\n                class=\"w-full px-3 py-2 bg-background border rounded-lg disabled:opacity-50\"\n                value={selectedSegmento()}\n                onChange={(e) => setSelectedSegmento(e.target.value)}\n                disabled={filtersLoading()}\n              >\n                <Show when={!filtersLoading()} fallback={<option>Carregando filtros...</option>}>\n                  <option value=\"\">Todos</option>\n                  <For each={segmentos()} fallback={<option disabled>Nenhum segmento dispon\u00edvel</option>}>\n                    {(seg) => <option value={seg}>{seg}</option>}\n                  </For>\n                </Show>\n              </select>\n            </div>\n            <div>\n              <label class=\"block text-sm font-medium mb-2\">UNE</label>\n              <select\n                class=\"w-full px-3 py-2 bg-background border rounded-lg disabled:opacity-50\"\n                value={selectedUne()}\n                onChange={(e) => setSelectedUne(e.target.value)}\n                disabled={filtersLoading()}\n              >\n                <Show when={!filtersLoading()} fallback={<option>Carregando filtros...</option>}>\n                  <option value=\"\">Todas</option>\n                  <For each={unes()} fallback={<option disabled>Nenhuma UNE dispon\u00edvel</option>}>\n                    {(une) => <option value={une}>{une}</option>}\n                  </For>\n                </Show>\n              </select>\n            </div>\n            <div class=\"flex items-end gap-2\">\n              <button onClick={loadData} class=\"btn btn-primary flex-1\">\n                Aplicar Filtros\n              </button>\n              <button onClick={clearFilters} class=\"btn btn-outline\">\n                <X size={16} />\n              </button>\n            </div>\n          </div>\n        </div>\n      </Show>\n\n      {/* Resumo de M\u00e9tricas */}\n      <div class=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <div class=\"p-4 bg-card border rounded-lg\">\n          <div class=\"flex items-center gap-3\">\n            <div class=\"p-2 bg-red-500/10 rounded-lg\">\n              <PackageX size={24} class=\"text-red-500\" />\n            </div>\n            <div>\n              <p class=\"text-sm text-muted-foreground\">Total de Rupturas</p>\n              <p class=\"text-2xl font-bold\">{summary().total}</p>\n            </div>\n          </div>\n        </div>\n        <div class=\"p-4 bg-card border rounded-lg\">\n          <div class=\"flex items-center gap-3\">\n            <div class=\"p-2 bg-orange-500/10 rounded-lg\">\n              <AlertTriangle size={24} class=\"text-orange-500\" />\n            </div>\n            <div>\n              <p class=\"text-sm text-muted-foreground\">Criticidade Alta (\u226575%)</p>\n              <p class=\"text-2xl font-bold\">{summary().criticos}</p>\n            </div>\n          </div>\n        </div>\n        <div class=\"p-4 bg-card border rounded-lg\">\n          <div class=\"flex items-center gap-3\">\n            <div class=\"p-2 bg-blue-500/10 rounded-lg\">\n              <TrendingUp size={24} class=\"text-blue-500\" />\n            </div>\n            <div>\n              <p class=\"text-sm text-muted-foreground\">Taxa Cr\u00edtica</p>\n              <p class=\"text-2xl font-bold\">\n                {summary().total > 0 ?", "mimetype": "text/plain", "start_char_idx": 11094, "end_char_idx": 15521, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2f9496ff-c19a-4c9c-9535-a40283e396fb": {"__data__": {"id_": "2f9496ff-c19a-4c9c-9535-a40283e396fb", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fece5066-9485-4734-8b7e-e516ad9b868f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "9611f88a-2a44-494c-891b-cc138b4dbe11", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "2a7fa29b582f63ee768171e68c9e4f477bb7647b381c0689b5515e3f5b344241", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "95a2fb9d-11d3-4e53-8d47-6612b90b66cb", "node_type": "1", "metadata": {}, "hash": "e38525af18577abb91e1176cf8754401d5b913194c137142e610ed9f3ac90011", "class_name": "RelatedNodeInfo"}}, "text": "((summary().criticos / summary().total) * 100).toFixed(0) : 0}%\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Explica\u00e7\u00e3o */}\n      <div class=\"p-4 bg-blue-500/5 border border-blue-500/20 rounded-lg\">\n        <h3 class=\"font-semibold text-blue-500 mb-2\">O que \u00e9 Ruptura Cr\u00edtica?</h3>\n        <p class=\"text-sm text-muted-foreground\">\n          Produtos com <strong>estoque no CD zerado (ESTOQUE_CD = 0)</strong> e <strong>estoque da loja abaixo da Linha Verde (ESTOQUE_UNE &lt; ESTOQUE_LV)</strong> que tiveram vendas nos \u00faltimos 30 dias. A criticidade \u00e9 calculada pela raz\u00e3o entre vendas e linha verde.\n        </p>\n      </div>\n\n      {/* Gr\u00e1ficos Interativos */}\n      <Show when={!loading() && data().length > 0}>\n        <div class=\"space-y-6\">\n          {/* Primeira linha - 2 colunas */}\n          <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            {/* Gr\u00e1fico de Pizza - Criticidade */}\n            <div class=\"card p-6 border\">\n              <div class=\"flex justify-between items-center mb-4\">\n                <h3 class=\"font-semibold flex items-center gap-2\">\n                  <PieChart size={20} class=\"text-blue-500\" />\n                  Distribui\u00e7\u00e3o de Criticidade\n                </h3>\n                <ChartDownloadButton\n                  chartId=\"criticidade-chart\"\n                  filename=\"rupturas_criticidade\"\n                  label=\"Baixar\"\n                />\n              </div>\n              <PlotlyChart\n                chartSpec={criticidadeChart}\n                chartId=\"criticidade-chart\"\n                enableDownload={true}\n                height=\"350px\"\n              />\n            </div>\n\n            {/* Gr\u00e1fico de Barras - Top 10 */}\n            <div class=\"card p-6 border\">\n              <div class=\"flex justify-between items-center mb-4\">\n                <h3 class=\"font-semibold flex items-center gap-2\">\n                  <BarChart3 size={20} class=\"text-orange-500\" />\n                  Top 10 Produtos em Ruptura\n                </h3>\n                <ChartDownloadButton\n                  chartId=\"top-rupturas-chart\"\n                  filename=\"rupturas_top10\"\n                  label=\"Baixar\"\n                />\n              </div>\n              <PlotlyChart\n                chartSpec={topRupturasChart}\n                chartId=\"top-rupturas-chart\"\n                enableDownload={true}\n                height=\"350px\"\n                onDataClick={handleChartClick}\n              />\n              <p class=\"text-xs text-muted mt-2\">\ud83d\udca1 Clique nas barras para ver detalhes do produto</p>\n            </div>\n          </div>\n\n          {/* Segunda linha - 1 coluna */}\n          <div class=\"card p-6 border\">\n            <div class=\"flex justify-between items-center mb-4\">\n              <h3 class=\"font-semibold flex items-center gap-2\">\n                <TrendingUp size={20} class=\"text-green-500\" />\n                Necessidade por Segmento\n              </h3>\n              <ChartDownloadButton\n                chartId=\"necessidade-segmento-chart\"\n                filename=\"rupturas_por_segmento\"\n                label=\"Baixar\"\n              />\n            </div>\n            <PlotlyChart\n              chartSpec={necessidadeSegmentoChart}\n              chartId=\"necessidade-segmento-chart\"\n              enableDownload={true}\n              height=\"400px\"\n            />\n          </div>\n        </div>\n      </Show>\n\n      {/* Modal de Detalhes do Produto */}\n      <Show when={selectedProduct()}>\n        <div\n          class=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\"\n          onClick={() => setSelectedProduct(null)}\n        >\n          <div\n            class=\"bg-card border rounded-lg p-6 max-w-2xl w-full\"\n            onClick={(e) => e.", "mimetype": "text/plain", "start_char_idx": 15522, "end_char_idx": 19307, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "95a2fb9d-11d3-4e53-8d47-6612b90b66cb": {"__data__": {"id_": "95a2fb9d-11d3-4e53-8d47-6612b90b66cb", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fece5066-9485-4734-8b7e-e516ad9b868f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2f9496ff-c19a-4c9c-9535-a40283e396fb", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "e2832b87994129e69a705d450882cc2dbbb9cec58359c9158be086136e1dec91", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "f4ac6860-d059-42ff-a4cc-40ce2d257908", "node_type": "1", "metadata": {}, "hash": "9d3060b9fa950d6c190cd2f2639b591366c50adc77c46ca68b9b869432128d82", "class_name": "RelatedNodeInfo"}}, "text": "stopPropagation()}\n          >\n            <div class=\"flex justify-between items-start mb-4\">\n              <h3 class=\"text-xl font-bold\">Detalhes da Ruptura</h3>\n              <button\n                onClick={() => setSelectedProduct(null)}\n                class=\"text-muted hover:text-foreground\"\n              >\n                <X size={20} />\n              </button>\n            </div>\n\n            <div class=\"space-y-4\">\n              <div>\n                <p class=\"text-sm text-muted\">Produto</p>\n                <p class=\"font-mono font-medium\">{selectedProduct()!.PRODUTO}</p>\n              </div>\n              <div>\n                <p class=\"text-sm text-muted\">Nome</p>\n                <p class=\"font-medium\">{selectedProduct()!.NOME}</p>\n              </div>\n              <div class=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <p class=\"text-sm text-muted\">UNE</p>\n                  <p class=\"font-medium\">{selectedProduct()!.UNE}</p>\n                </div>\n                <div>\n                  <p class=\"text-sm text-muted\">Segmento</p>\n                  <p class=\"font-medium\">{selectedProduct()!.NOMESEGMENTO || 'N/A'}</p>\n                </div>\n              </div>\n              <div class=\"grid grid-cols-3 gap-4\">\n                <div class=\"p-3 bg-green-500/10 border border-green-500/30 rounded\">\n                  <p class=\"text-xs text-muted\">Vendas (30d)</p>\n                  <p class=\"text-xl font-bold text-green-500\">{Math.round(selectedProduct()!.VENDA_30DD)}</p>\n                </div>\n                <div class=\"p-3 bg-red-500/10 border border-red-500/30 rounded\">\n                  <p class=\"text-xs text-muted\">Estoque Loja</p>\n                  <p class=\"text-xl font-bold text-red-500\">{Math.round(selectedProduct()!.ESTOQUE_UNE)}</p>\n                </div>\n                <div class=\"p-3 bg-blue-500/10 border border-blue-500/30 rounded\">\n                  <p class=\"text-xs text-muted\">Linha Verde</p>\n                  <p class=\"text-xl font-bold text-blue-500\">{Math.round(selectedProduct()!.ESTOQUE_LV)}</p>\n                </div>\n              </div>\n              <div class=\"p-4 bg-orange-500/10 border border-orange-500/30 rounded\">\n                <p class=\"text-sm text-muted mb-2\">Necessidade de Reposi\u00e7\u00e3o</p>\n                <p class=\"text-3xl font-bold text-orange-500\">{Math.round(selectedProduct()!.NECESSIDADE)} unidades</p>\n                <div class=\"mt-3\">\n                  <div class=\"flex justify-between text-sm mb-1\">\n                    <span>Criticidade</span>\n                    <span class=\"font-medium\">{selectedProduct()!.CRITICIDADE_PCT.toFixed(0)}%</span>\n                  </div>\n                  <div class=\"w-full bg-gray-700 rounded-full h-2\">\n                    <div\n                      class={`h-2 rounded-full ${\n                        selectedProduct()!.CRITICIDADE_PCT >= 75 ? 'bg-red-500' :\n                        selectedProduct()!.CRITICIDADE_PCT >= 50 ? 'bg-orange-500' :\n                        selectedProduct()!.CRITICIDADE_PCT >= 25 ?", "mimetype": "text/plain", "start_char_idx": 19307, "end_char_idx": 22364, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "f4ac6860-d059-42ff-a4cc-40ce2d257908": {"__data__": {"id_": "f4ac6860-d059-42ff-a4cc-40ce2d257908", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fece5066-9485-4734-8b7e-e516ad9b868f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "95a2fb9d-11d3-4e53-8d47-6612b90b66cb", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "e955ad667a29d9711773d9bd8247472e1b7028da6930734481d8bed2103d7a36", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "16cc0a18-6b99-4573-a216-edd13ae09ca3", "node_type": "1", "metadata": {}, "hash": "f8af8039a8464cc0c8453e07c7430a8a94bd00edc4aa50eb196e209e111e4c79", "class_name": "RelatedNodeInfo"}}, "text": "round(selectedProduct()!.NECESSIDADE)} unidades</p>\n                <div class=\"mt-3\">\n                  <div class=\"flex justify-between text-sm mb-1\">\n                    <span>Criticidade</span>\n                    <span class=\"font-medium\">{selectedProduct()!.CRITICIDADE_PCT.toFixed(0)}%</span>\n                  </div>\n                  <div class=\"w-full bg-gray-700 rounded-full h-2\">\n                    <div\n                      class={`h-2 rounded-full ${\n                        selectedProduct()!.CRITICIDADE_PCT >= 75 ? 'bg-red-500' :\n                        selectedProduct()!.CRITICIDADE_PCT >= 50 ? 'bg-orange-500' :\n                        selectedProduct()!.CRITICIDADE_PCT >= 25 ? 'bg-yellow-500' : 'bg-blue-500'\n                      }`}\n                      style={`width: ${selectedProduct()!.CRITICIDADE_PCT}%`}\n                    />\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div class=\"mt-6 flex justify-end\">\n              <button\n                onClick={() => setSelectedProduct(null)}\n                class=\"btn btn-primary\"\n              >\n                Fechar\n              </button>\n            </div>\n          </div>\n        </div>\n      </Show>\n\n      {/* Tabela */}\n      <Show when={!loading()} fallback={\n        <div class=\"p-12 text-center border rounded-xl bg-card text-muted animate-pulse\">\n          <PackageX class=\"animate-spin mx-auto mb-4\" size={32} />\n          Identificando rupturas cr\u00edticas...\n        </div>\n      }>\n        <Show when={!error()} fallback={\n          <div class=\"p-6 bg-red-900/10 border border-red-900/30 rounded-lg text-red-300 flex items-center gap-3\">\n            <AlertTriangle size={24} />\n            <div>\n              <h3 class=\"font-bold\">Erro ao carregar dados</h3>\n              <p class=\"text-sm opacity-80\">{error()}</p>\n            </div>\n          </div>\n        }>\n          <Show when={data().length > 0} fallback={\n            <div class=\"p-12 text-center border border-dashed rounded-xl text-muted\">\n              <Package size={48} class=\"mx-auto mb-4 opacity-20 text-green-500\" />\n              <p class=\"text-lg font-medium text-green-500\">Nenhuma ruptura cr\u00edtica detectada!</p>\n              <p class=\"text-sm mt-2\">Todos os produtos de alta venda possuem estoque adequado.</p>\n            </div>\n          }>\n            <div class=\"border rounded-lg overflow-hidden bg-card shadow-sm\">\n              <div class=\"overflow-x-auto\">\n                <table class=\"w-full text-sm text-left\">\n                  <thead class=\"bg-muted/50 text-xs uppercase font-medium text-muted-foreground border-b\">\n                    <tr>\n                      <th class=\"px-4 py-3\">Produto</th>\n                      <th class=\"px-4 py-3\">UNE</th>\n                      <th class=\"px-4 py-3 text-right\">Venda (30d)</th>\n                      <th class=\"px-4 py-3 text-right\">Est. Loja</th>\n                      <th class=\"px-4 py-3 text-right\">Est.", "mimetype": "text/plain", "start_char_idx": 21663, "end_char_idx": 24654, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "16cc0a18-6b99-4573-a216-edd13ae09ca3": {"__data__": {"id_": "16cc0a18-6b99-4573-a216-edd13ae09ca3", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "fece5066-9485-4734-8b7e-e516ad9b868f", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "72aab103d3ea01e89cb00a99ab3371531a808bef591399869944135641453927", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "f4ac6860-d059-42ff-a4cc-40ce2d257908", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}, "hash": "a6fca7a9ad2be1a3cb5e4ede3499ecbe80ee10b527593e5d3e1b286affa86697", "class_name": "RelatedNodeInfo"}}, "text": "Loja</th>\n                      <th class=\"px-4 py-3 text-right\">Est. CD</th>\n                      <th class=\"px-4 py-3 text-right\">Linha Verde</th>\n                      <th class=\"px-4 py-3 text-right\">Necessidade</th>\n                      <th class=\"px-4 py-3 text-center\">Criticidade</th>\n                    </tr>\n                  </thead>\n                  <tbody class=\"divide-y\">\n                    <For each={data()}>\n                      {(item) => (\n                        <tr class=\"hover:bg-muted/30 transition-colors\">\n                          <td class=\"px-4 py-3\">\n                            <div class=\"font-medium\">{item.NOME}</div>\n                            <div class=\"text-xs text-muted-foreground font-mono\">{item.PRODUTO}</div>\n                          </td>\n                          <td class=\"px-4 py-3\">\n                            <span class=\"px-2 py-1 bg-secondary rounded text-xs font-mono\">{item.UNE}</span>\n                          </td>\n                          <td class=\"px-4 py-3 text-right font-medium\">\n                            <div class=\"flex items-center justify-end gap-1 text-green-500\">\n                              <ShoppingCart size={14} />\n                              {Math.round(item.VENDA_30DD)}\n                            </div>\n                          </td>\n                          <td class=\"px-4 py-3 text-right font-medium text-red-500\">\n                            <div class=\"flex items-center justify-end gap-1\">\n                              <Archive size={14} />\n                              {Math.round(item.ESTOQUE_UNE)}\n                            </div>\n                          </td>\n                          <td class=\"px-4 py-3 text-right font-medium text-red-500\">\n                            {Math.round(item.ESTOQUE_CD)}\n                          </td>\n                          <td class=\"px-4 py-3 text-right font-medium text-blue-500\">\n                            {Math.round(item.ESTOQUE_LV)}\n                          </td>\n                          <td class=\"px-4 py-3 text-right font-bold text-orange-500\">\n                            {Math.round(item.NECESSIDADE)} un\n                          </td>\n                          <td class=\"px-4 py-3 text-center\">\n                            <div class=\"flex flex-col items-center gap-1\">\n                              <span class={`px-2 py-1 rounded-full text-xs font-bold border ${getCriticidadeColor(item.CRITICIDADE_PCT)}`}>\n                                {getCriticidadeLabel(item.CRITICIDADE_PCT)}\n                              </span>\n                              <div class=\"w-full bg-gray-700 rounded-full h-1.5 mt-1\">\n                                <div\n                                  class={`h-1.5 rounded-full ${item.CRITICIDADE_PCT >= 75 ? 'bg-red-500' : item.CRITICIDADE_PCT >= 50 ? 'bg-orange-500' : item.CRITICIDADE_PCT >= 25 ? 'bg-yellow-500' : 'bg-blue-500'}`}\n                                  style={`width: ${item.CRITICIDADE_PCT}%`}\n                                />\n                              </div>\n                              <span class=\"text-xs text-muted-foreground\">{item.CRITICIDADE_PCT.toFixed(0)}%</span>\n                            </div>\n                          </td>\n                        </tr>\n                      )}\n                    </For>\n                  </tbody>\n                </table>\n              </div>\n            </div>\n          </Show>\n        </Show>\n      </Show>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 24585, "end_char_idx": 28093, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "2887d11e-da82-4f36-adf0-0fe80d76d7f3": {"__data__": {"id_": "2887d11e-da82-4f36-adf0-0fe80d76d7f3", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\SharedConversation.tsx", "language": "typescript", "lines": 156, "filename": "SharedConversation.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b2592cd2-45af-4230-8baf-a6e99c36c4bd", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\SharedConversation.tsx", "language": "typescript", "lines": 156, "filename": "SharedConversation.tsx"}, "hash": "4f26be8f342ba40220c803eb5ee77a97b0b0786aa1bc41dff86e019181855139", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "7dcacd5d-c264-402e-82b6-d7385361cfe5", "node_type": "1", "metadata": {}, "hash": "d48dda8d3d6d42847eabd48b12a79f2c2533f1dadc82880144a7dd61a3c12e81", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, onMount, For, Show } from 'solid-js';\nimport { useParams } from '@solidjs/router';\n// Removido solid-markdown devido a problemas de compatibilidade ESM\nimport { formatTimestamp } from '@/lib/formatters';\nimport 'github-markdown-css/github-markdown.css';\nimport './chat-markdown.css';\n\ninterface Message {\n  role: string;\n  text: string;\n  timestamp: number;\n}\n\ninterface SharedConversationData {\n  share_id: string;\n  title: string | null;\n  messages: Message[];\n  created_at: string;\n  view_count: number;\n}\n\nexport default function SharedConversation() {\n  const params = useParams();\n  const [conversation, setConversation] = createSignal<SharedConversationData | null>(null);\n  const [loading, setLoading] = createSignal(true);\n  const [error, setError] = createSignal('');\n\n  onMount(async () => {\n    const shareId = params.share_id;\n    if (!shareId) {\n      setError('ID de compartilhamento inv\u00e1lido');\n      setLoading(false);\n      return;\n    }\n\n    try {\n      const response = await fetch(`/api/v1/shared/${shareId}`);\n\n      if (!response.ok) {\n        if (response.status === 404) {\n          setError('Esta conversa n\u00e3o foi encontrada.');\n        } else if (response.status === 410) {\n          setError('Esta conversa expirou ou n\u00e3o est\u00e1 mais dispon\u00edvel.');\n        } else {\n          setError('Erro ao carregar conversa compartilhada.');\n        }\n        setLoading(false);\n        return;\n      }\n\n      const data = await response.json();\n      setConversation(data);\n    } catch (err) {\n      console.error('Error loading shared conversation:', err);\n      setError('Erro ao carregar conversa compartilhada.');\n    } finally {\n      setLoading(false);\n    }\n  });\n\n  return (\n    <div class=\"flex flex-col h-full max-w-4xl mx-auto\">\n      {/* Header */}\n      <div class=\"p-4 border-b bg-background/50 backdrop-blur\">\n        <div class=\"flex items-center justify-between\">\n          <div>\n            <h2 class=\"text-lg font-semibold\">\n              {conversation()?.title || 'Conversa Compartilhada'}\n            </h2>\n            <Show when={conversation()}>\n              <p class=\"text-sm text-muted-foreground mt-1\">\n                Compartilhado em {new Date(conversation()!.created_at).toLocaleDateString('pt-BR')}\n                {' \u2022 '}\n                {conversation()!.view_count} visualiza{conversation()!.view_count === 1 ? '\u00e7\u00e3o' : '\u00e7\u00f5es'}\n              </p>\n            </Show>\n          </div>\n          <a\n            href=\"/\"\n            class=\"btn btn-primary\"\n          >\n            Criar minha conversa\n          </a>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div class=\"flex-1 overflow-y-auto p-6 space-y-6\">\n        <Show when={loading()}>\n          <div class=\"flex items-center justify-center h-full\">\n            <div class=\"text-center\">\n              <div class=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4\"></div>\n              <p class=\"text-muted-foreground\">Carregando conversa...</p>\n            </div>\n          </div>\n        </Show>\n\n        <Show when={error()}>\n          <div class=\"flex items-center justify-center h-full\">\n            <div class=\"text-center max-w-md\">\n              <div class=\"text-6xl mb-4\">\u26a0\ufe0f</div>\n              <h3 class=\"text-xl font-semibold mb-2\">Ops!</h3>\n              <p class=\"text-muted-foreground mb-6\">{error()}</p>\n              <a href=\"/\" class=\"btn btn-primary\">\n                Ir para p\u00e1gina inicial\n              </a>\n            </div>\n          </div>\n        </Show>\n\n        <Show when={!loading() && !error() && conversation()}>\n          <div class=\"space-y-4\">\n            <div class=\"p-4 rounded-lg bg-muted/50 border\">\n              <p class=\"text-sm text-muted-foreground\">\n                \u2139\ufe0f Esta \u00e9 uma visualiza\u00e7\u00e3o somente leitura de uma conversa compartilhada do Chat BI.\n                Voc\u00ea n\u00e3o pode interagir ou continuar esta conversa.\n              </p>\n            </div>\n\n            <For each={conversation()!.messages}>\n              {(msg) => (\n                <div class={`flex ${msg.role === 'user' ?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4098, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "7dcacd5d-c264-402e-82b6-d7385361cfe5": {"__data__": {"id_": "7dcacd5d-c264-402e-82b6-d7385361cfe5", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\SharedConversation.tsx", "language": "typescript", "lines": 156, "filename": "SharedConversation.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "b2592cd2-45af-4230-8baf-a6e99c36c4bd", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\SharedConversation.tsx", "language": "typescript", "lines": 156, "filename": "SharedConversation.tsx"}, "hash": "4f26be8f342ba40220c803eb5ee77a97b0b0786aa1bc41dff86e019181855139", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "2887d11e-da82-4f36-adf0-0fe80d76d7f3", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\SharedConversation.tsx", "language": "typescript", "lines": 156, "filename": "SharedConversation.tsx"}, "hash": "6cc28a1a34834f11410c31e05d71c281553f580579b4a81792ba19ad46054c34", "class_name": "RelatedNodeInfo"}}, "text": "Voc\u00ea n\u00e3o pode interagir ou continuar esta conversa.\n              </p>\n            </div>\n\n            <For each={conversation()!.messages}>\n              {(msg) => (\n                <div class={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>\n                  <div\n                    class={`max-w-[80%] rounded-lg p-4 text-sm leading-relaxed shadow-sm ${msg.role === 'user'\n                        ? 'bg-primary text-primary-foreground'\n                        : 'bg-card border text-card-foreground'\n                      }`}\n                  >\n                    <div class=\"markdown-body\" style=\"white-space: pre-wrap;\">\n                      {msg.text}\n                    </div>\n                    <div class=\"text-xs text-muted-foreground mt-2 opacity-70\">\n                      {formatTimestamp(msg.timestamp)}\n                    </div>\n                  </div>\n                </div>\n              )}\n            </For>\n          </div>\n        </Show>\n      </div>\n\n      {/* Footer */}\n      <div class=\"p-4 border-t bg-background/50 backdrop-blur text-center\">\n        <p class=\"text-sm text-muted-foreground\">\n          Powered by <span class=\"font-semibold text-foreground\">Chat BI</span>\n          {' \u2022 '}\n          <a href=\"/\" class=\"text-primary hover:underline\">\n            Criar sua pr\u00f3pria conversa\n          </a>\n        </p>\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 3874, "end_char_idx": 5276, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6ff0537a-1587-44c9-bfdc-511d31272616": {"__data__": {"id_": "6ff0537a-1587-44c9-bfdc-511d31272616", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7983b46e-58f1-4f9b-a389-2588d6edef24", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "a390e776dcaced88e1a3b23800ca911eb4b437449eade697f7009fca6e08c986", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "25f4b3c8-b4ef-43bf-91f7-c6c6397cbc97", "node_type": "1", "metadata": {}, "hash": "6d14708a0024cc9027f3a97f3fcacfc65cdd04344e1fba153d6f23f882456319", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, createEffect, onMount, For, Show } from 'solid-js';\nimport { createStore } from 'solid-js/store';\nimport { Truck, Search, Plus, Trash2, ShoppingCart, AlertTriangle, CheckCircle, Package, ArrowRight } from 'lucide-solid';\nimport api from '../lib/api';\n\n// Types\ntype TransferMode = 'UNE - UNE' | 'UNE - UNES' | 'UNES - UNES';\n\ninterface Product {\n  produto_id: number;\n  nome: string;\n  segmento: string;\n  fabricante: string;\n  estoque_loja: number;\n  estoque_cd: number;\n  vendas_30dd: number;\n  unes: number;\n}\n\ninterface UNE {\n  une: number;\n  total_produtos: number;\n  estoque_total: number;\n}\n\ninterface CartItem {\n  produto_id: number;\n  produto_nome: string;\n  une_origem: number;\n  une_destino: number[];\n  quantidade: number;\n  score?: number;\n  nivel_urgencia?: string;\n}\n\ninterface ValidationResult {\n  status: string;\n  mensagem: string;\n  score_prioridade?: number;\n  nivel_urgencia?: string;\n}\n\nexport default function Transfers() {\n  // Estado principal\n  const [mode, setMode] = createSignal<TransferMode>('1\u21921');\n  const [unes, setUnes] = createSignal<UNE[]>([]);\n  const [products, setProducts] = createSignal<Product[]>([]);\n  const [cart, setCart] = createStore<{ items: CartItem[] }>({ items: [] });\n\n  // Filtros dispon\u00edveis\n  const [availableSegmentos, setAvailableSegmentos] = createSignal<string[]>([]);\n  const [availableFabricantes, setAvailableFabricantes] = createSignal<string[]>([]);\n\n  // Filtros de busca\n  const [searchSegmento, setSearchSegmento] = createSignal('');\n  const [searchFabricante, setSearchFabricante] = createSignal('');\n  const [searchEstoqueMin, setSearchEstoqueMin] = createSignal<number | ''>('');\n\n  // Sele\u00e7\u00e3o de produto/UNE para adicionar ao carrinho\n  const [selectedProducts, setSelectedProducts] = createSignal<Product[]>([]);\n  const [selectedUneOrigem, setSelectedUneOrigem] = createSignal<number | ''>('');\n  const [selectedUnesOrigem, setSelectedUnesOrigem] = createSignal<number[]>([]);\n  const [selectedUnesDestino, setSelectedUnesDestino] = createSignal<number[]>([]);\n  const [quantidade, setQuantidade] = createSignal<number | ''>('');\n\n  // Estados UI\n  const [loading, setLoading] = createSignal(false);\n  const [searching, setSearching] = createSignal(false);\n  const [validating, setValidating] = createSignal(false);\n  const [creating, setCreating] = createSignal(false);\n  const [error, setError] = createSignal<string | null>(null);\n  const [success, setSuccess] = createSignal<string | null>(null);\n  const [validationResult, setValidationResult] = createSignal<ValidationResult | null>(null);\n\n  // Toggle selection of a product\n  const toggleProductSelection = (product: Product) => {\n    const current = selectedProducts();\n    const exists = current.find(p => p.produto_id === product.produto_id);\n    \n    if (exists) {\n      setSelectedProducts(current.filter(p => p.produto_id !== product.produto_id));\n    } else {\n      setSelectedProducts([...current, product]);\n    }\n  };\n\n  // Carregar filtros dispon\u00edveis\n  const loadFilters = async (segmento?: string) => {\n    try {\n      const params = segmento ?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3112, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "25f4b3c8-b4ef-43bf-91f7-c6c6397cbc97": {"__data__": {"id_": "25f4b3c8-b4ef-43bf-91f7-c6c6397cbc97", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7983b46e-58f1-4f9b-a389-2588d6edef24", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "a390e776dcaced88e1a3b23800ca911eb4b437449eade697f7009fca6e08c986", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "6ff0537a-1587-44c9-bfdc-511d31272616", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "2ce3cac77b86341b2a7b0a137f45014702e6ccd5206ac7174bedf2913b9aeb59", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "dc0a7853-9319-4908-8f8c-867597acfc34", "node_type": "1", "metadata": {}, "hash": "a3b25a29c9f27e83963451ef2c07c3661b7705222c3134241d5352ba554e1fa6", "class_name": "RelatedNodeInfo"}}, "text": ": string) => {\n    try {\n      const params = segmento ? { segmento } : {};\n      const response = await api.get<{ segmentos: string[]; fabricantes: string[] }>('/transfers/filters', { params });\n      \n      // Se n\u00e3o tem segmento filtrado (inicializa\u00e7\u00e3o), carrega lista completa de segmentos\n      if (!segmento) {\n        setAvailableSegmentos(response.data.segmentos);\n      }\n      // Sempre atualiza fabricantes baseado no filtro (ou falta dele)\n      setAvailableFabricantes(response.data.fabricantes);\n    } catch (err: any) {\n      console.error('Erro ao carregar filtros:', err);\n    }\n  };\n\n  // Carregar UNEs dispon\u00edveis\n  const loadUnes = async () => {\n    try {\n      const response = await api.get<UNE[]>('/transfers/unes');\n      setUnes(response.data);\n      \n      // Context7 Best Practice: Auto-select if only one option is available\n      if (response.data.length === 1) {\n        const singleUne = response.data[0].une;\n        // Apply selection based on current mode\n        if (mode() === 'N\u2192N') {\n          // Only select if empty to avoid overwriting user choice during reloads (if any)\n          if (selectedUnesOrigem().length === 0) {\n            setSelectedUnesOrigem([singleUne]);\n          }\n        } else {\n          // Modes 1\u21921 and 1\u2192N\n          if (!selectedUneOrigem()) {\n            setSelectedUneOrigem(singleUne);\n          }\n        }\n      }\n    } catch (err: any) {\n      console.error('Erro ao carregar UNEs:', err);\n    }\n  };\n\n  // Re-apply auto-selection when mode changes, if applicable\n  createEffect(() => {\n    const currentUnes = unes();\n    if (currentUnes.length === 1) {\n        const singleUne = currentUnes[0].une;\n        if (mode() === 'UNES - UNES') {\n          if (selectedUnesOrigem().length === 0) setSelectedUnesOrigem([singleUne]);\n        } else {\n          // Modes UNE - UNE and UNE - UNES\n          if (!selectedUneOrigem()) {\n            setSelectedUneOrigem(singleUne);\n          }\n        }\n    }\n  });\n\n  // Buscar produtos\n  const searchProducts = async () => {\n    setSearching(true);\n    setError(null);\n    try {\n      const response = await api.post<Product[]>('/transfers/products/search', {\n        segmento: searchSegmento() || undefined,\n        fabricante: searchFabricante() || undefined,\n        estoque_min: searchEstoqueMin() || undefined,\n        limit: 50\n      });\n      setProducts(response.data);\n    } catch (err: any) {\n      setError(err.response?.data?.detail || 'Erro ao buscar produtos');\n    } finally {\n      setSearching(false);\n    }\n  };\n\n  // Adicionar item ao carrinho\n  const addToCart = async () => {\n    // Validar sele\u00e7\u00f5es baseado no modo\n    const selectedOrigens = mode() === 'UNES - UNES' ? selectedUnesOrigem() : selectedUneOrigem() ?", "mimetype": "text/plain", "start_char_idx": 3056, "end_char_idx": 5805, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "dc0a7853-9319-4908-8f8c-867597acfc34": {"__data__": {"id_": "dc0a7853-9319-4908-8f8c-867597acfc34", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7983b46e-58f1-4f9b-a389-2588d6edef24", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "a390e776dcaced88e1a3b23800ca911eb4b437449eade697f7009fca6e08c986", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "25f4b3c8-b4ef-43bf-91f7-c6c6397cbc97", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "9dc7262c087b3cb08a3f19aaa95cf6d73ab4c4b96da881d6aa457714e21b3e3a", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "ed07c4aa-37ee-4d9b-86e5-0cb3660263ee", "node_type": "1", "metadata": {}, "hash": "345d07f53d706bcf16270c3e4beeba1fe26321572211966edc379d0e1090716b", "class_name": "RelatedNodeInfo"}}, "text": "selectedUnesOrigem() : selectedUneOrigem() ? [selectedUneOrigem() as number] : [];\n    \n    if (selectedProducts().length === 0 || selectedOrigens.length === 0 || selectedUnesDestino().length === 0 || !quantidade()) {\n      setError(`Preencha todos os campos para adicionar ao carrinho (Modo ${mode()})`);\n      return;\n    }\n\n    const qtd = quantidade() as number;\n    setValidating(true);\n    \n    try {\n      const allNewItems: CartItem[] = [];\n      const firstOrigem = selectedOrigens[0];\n      const firstDestino = selectedUnesDestino()[0];\n\n      // Validate and create items for EACH selected product\n      const promises = selectedProducts().map(async (product) => {\n          const validationResponse = await api.post<ValidationResult>('/transfers/validate', {\n            produto_id: product.produto_id,\n            une_origem: firstOrigem,\n            une_destino: firstDestino,\n            quantidade: qtd,\n            solicitante_id: 'temp'\n          });\n\n          return selectedOrigens.map(origem => ({\n            produto_id: product.produto_id,\n            produto_nome: product.nome,\n            une_origem: origem,\n            une_destino: selectedUnesDestino(),\n            quantidade: qtd,\n            score: validationResponse.data.score_prioridade,\n            nivel_urgencia: validationResponse.data.nivel_urgencia\n          }));\n      });\n\n      const results = await Promise.all(promises);\n      results.forEach(items => allNewItems.push(...items));\n\n      setCart('items', [...cart.items, ...allNewItems]);\n      setSuccess(`${allNewItems.length} item(ns) adicionado(s) ao carrinho!`);\n\n      // Limpar sele\u00e7\u00e3o\n      setSelectedProducts([]);\n      setSelectedUneOrigem('');\n      setSelectedUnesOrigem([]);\n      setSelectedUnesDestino([]);\n      setQuantidade('');\n      setValidationResult(null);\n\n      setTimeout(() => setSuccess(null), 3000);\n    } catch (err: any) {\n      setError(err.response?.data?.detail || 'Erro ao validar transfer\u00eancia');\n    } finally {\n      setValidating(false);\n    }\n  };\n\n  // Remover item do carrinho\n  const removeFromCart = (index: number) => {\n    setCart('items', cart.items.filter((_, i) => i !== index));\n  };\n\n  // Limpar carrinho\n  const clearCart = () => {\n    setCart('items', []);\n    setSuccess('Carrinho limpo!');\n    setTimeout(() => setSuccess(null), 2000);\n  };\n\n  // Gerar solicita\u00e7\u00e3o\n  const generateRequest = async () => {\n    if (cart.items.length === 0) {\n      setError('Carrinho vazio! Adicione itens primeiro.');\n      return;\n    }\n\n    setCreating(true);\n    setError(null);\n\n    try {\n      // Preparar payload baseado no modo\n      const transfers = [];\n\n      for (const item of cart.items) {\n        for (const destino of item.une_destino) {\n          transfers.push({\n            produto_id: item.produto_id,\n            une_origem: item.une_origem,\n            une_destino: destino,\n            quantidade: item.quantidade,\n            solicitante_id: 'temp'\n          });\n        }\n      }\n\n      if (mode() === 'UNE - UNE' && transfers.length === 1) {\n        // Transfer\u00eancia simples\n        const response = await api.post('/transfers', transfers[0]);\n        setSuccess(`Solicita\u00e7\u00e3o criada! ID: ${response.data.transfer_id}`);\n      } else {\n        // Transfer\u00eancia em massa\n        const response = await api.post('/transfers/bulk', {\n          items: transfers,\n          modo: mode()\n        });\n        setSuccess(`Lote criado!", "mimetype": "text/plain", "start_char_idx": 5761, "end_char_idx": 9197, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ed07c4aa-37ee-4d9b-86e5-0cb3660263ee": {"__data__": {"id_": "ed07c4aa-37ee-4d9b-86e5-0cb3660263ee", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7983b46e-58f1-4f9b-a389-2588d6edef24", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "a390e776dcaced88e1a3b23800ca911eb4b437449eade697f7009fca6e08c986", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "dc0a7853-9319-4908-8f8c-867597acfc34", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "d351f2621464743c2553106b963da46ab1d20674db7bf00e3a593a04b0eeb55e", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "5fcabd73-d92e-4157-86cc-290fcd46db4e", "node_type": "1", "metadata": {}, "hash": "e0369c29a818c5f25540fd99df14edc9f97d3f589e0f7476f6e95cd46890773f", "class_name": "RelatedNodeInfo"}}, "text": "ID: ${response.data.transfer_id}`);\n      } else {\n        // Transfer\u00eancia em massa\n        const response = await api.post('/transfers/bulk', {\n          items: transfers,\n          modo: mode()\n        });\n        setSuccess(`Lote criado! ID: ${response.data.batch_id} (${transfers.length} transfer\u00eancias)`);\n      }\n\n      // Limpar carrinho\n      setCart('items', []);\n\n    } catch (err: any) {\n      setError(err.response?.data?.detail || 'Erro ao criar solicita\u00e7\u00e3o');\n    } finally {\n      setCreating(false);\n    }\n  };\n\n  // Limpar sele\u00e7\u00f5es ao mudar modo\n  createEffect(() => {\n    mode(); // Dependency on mode changes\n    setSelectedUneOrigem('');\n    setSelectedUnesOrigem([]);\n    setSelectedUnesDestino([]);\n    setSelectedProducts([]);\n    setValidationResult(null);\n  });\n\n  onMount(() => {\n    loadFilters();\n    loadUnes();\n    searchProducts();\n  });\n\n  // Atualizar filtros (fabricantes) quando segmento mudar\n  createEffect(() => {\n    loadFilters(searchSegmento());\n  });\n\n  // Auto-buscar ao mudar filtros\n  createEffect(() => {\n    if (searchSegmento() || searchFabricante() || searchEstoqueMin()) {\n      searchProducts();\n    }\n  });\n\n  const getUrgencyColor = (nivel?: string) => {\n    switch (nivel) {\n      case 'URGENTE': return 'text-red-500';\n      case 'ALTA': return 'text-orange-500';\n      case 'M\u00c9DIA': return 'text-yellow-500';\n      case 'BAIXA': return 'text-green-500';\n      default: return 'text-gray-500';\n    }\n  };\n\n  return (\n    <div class=\"flex flex-col h-full p-6 gap-6\">\n      {/* Header */}\n      <div>\n        <h2 class=\"text-2xl font-bold\">Sistema de Transfer\u00eancias</h2>\n        <p class=\"text-muted\">Gerencie transfer\u00eancias de produtos entre UNEs</p>\n      </div>\n\n      {/* Error/Success Messages */}\n      <Show when={error()}>\n        <div class=\"card p-4 border-red-500 bg-red-500/10\">\n          <div class=\"flex items-center gap-2 text-red-500\">\n            <AlertTriangle size={20} />\n            <span>{error()}</span>\n          </div>\n        </div>\n      </Show>\n\n      <Show when={success()}>\n        <div class=\"card p-4 border-green-500 bg-green-500/10\">\n          <div class=\"flex items-center gap-2 text-green-500\">\n            <CheckCircle size={20} />\n            <span>{success()}</span>\n          </div>\n        </div>\n      </Show>\n\n      {/* Mode Selection & UNE Origin/Destination Filters */}\n      <div class=\"card p-4 border\">\n        <div class=\"space-y-4\">\n          {/* Mode Selection */}\n          <div>\n            <label class=\"text-sm font-medium mb-3 block\">Modo de Transfer\u00eancia</label>\n            <div class=\"flex gap-2\">\n              <button\n                class={`btn ${mode() === 'UNE - UNE' ? 'btn-primary' : 'btn-outline'}`}\n                onClick={() => setMode('UNE - UNE')}\n              >\n                UNE - UNE (Simples)\n              </button>\n              <button\n                class={`btn ${mode() === 'UNE - UNES' ? 'btn-primary' : 'btn-outline'}`}\n                onClick={() => setMode('UNE - UNES')}\n              >\n                UNE - UNES (Uma origem, v\u00e1rias destinos)\n              </button>\n              <button\n                class={`btn ${mode() === 'UNES - UNES' ? 'btn-primary' : 'btn-outline'}`}\n                onClick={() => setMode('UNES - UNES')}\n              >\n                UNES - UNES (M\u00faltiplas origens e destinos)\n              </button>\n            </div>\n          </div>\n\n          {/* UNE Origin & Destination Pre-selection */}\n          <div class=\"border-t pt-4\">\n            <p class=\"text-xs text-muted mb-3\">\n              \u2139\ufe0f {\n                mode() === 'UNE - UNE' ? 'Selecione uma UNE de origem e uma de destino' :\n                mode() === 'UNE - UNES' ?", "mimetype": "text/plain", "start_char_idx": 8956, "end_char_idx": 12664, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5fcabd73-d92e-4157-86cc-290fcd46db4e": {"__data__": {"id_": "5fcabd73-d92e-4157-86cc-290fcd46db4e", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7983b46e-58f1-4f9b-a389-2588d6edef24", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "a390e776dcaced88e1a3b23800ca911eb4b437449eade697f7009fca6e08c986", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "ed07c4aa-37ee-4d9b-86e5-0cb3660263ee", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "17f1049cb6374059192e8209b8602f78fe223978aff2158022b81cb424a6aed6", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "b14969c2-d401-4431-8054-e171188eaa7b", "node_type": "1", "metadata": {}, "hash": "6910953e683f6cc2908dcc972457eabc85159fffcb757f79325b634c44cb372d", "class_name": "RelatedNodeInfo"}}, "text": "'btn-primary' : 'btn-outline'}`}\n                onClick={() => setMode('UNE - UNES')}\n              >\n                UNE - UNES (Uma origem, v\u00e1rias destinos)\n              </button>\n              <button\n                class={`btn ${mode() === 'UNES - UNES' ? 'btn-primary' : 'btn-outline'}`}\n                onClick={() => setMode('UNES - UNES')}\n              >\n                UNES - UNES (M\u00faltiplas origens e destinos)\n              </button>\n            </div>\n          </div>\n\n          {/* UNE Origin & Destination Pre-selection */}\n          <div class=\"border-t pt-4\">\n            <p class=\"text-xs text-muted mb-3\">\n              \u2139\ufe0f {\n                mode() === 'UNE - UNE' ? 'Selecione uma UNE de origem e uma de destino' :\n                mode() === 'UNE - UNES' ? 'Selecione uma UNE de origem e m\u00faltiplos destinos' :\n                'Selecione m\u00faltiplas UNEs de origem e destino'\n              }\n            </p>\n            \n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n              {/* Origin UNEs Selection */}\n              <div>\n                <label class=\"text-xs text-muted block mb-2 font-semibold\">\n                  UNE(s) de Origem\n                  {mode() === 'N\u2192N' && ` (${selectedUnesOrigem().length} selecionadas)`}\n                </label>\n                <div class=\"max-h-40 overflow-y-auto border rounded p-3 space-y-2 bg-muted/5\">\n                  <Show when={unes().length > 0} fallback={\n                    <div class=\"text-xs text-muted p-2\">Nenhuma UNE dispon\u00edvel</div>\n                  }>\n                    <For each={unes()}>\n                      {(une) => {\n                        const isSelectedInMode = () => mode() === 'N\u2192N' \n                          ? selectedUnesOrigem().includes(une.une)\n                          : selectedUneOrigem() === une.une;\n                        \n                        const toggleSelection = () => {\n                          if (mode() === 'UNES - UNES') {\n                            const current = selectedUnesOrigem();\n                            if (current.includes(une.une)) {\n                              setSelectedUnesOrigem(current.filter(u => u !== une.une));\n                            } else {\n                              setSelectedUnesOrigem([...current, une.une]);\n                            }\n                          } else {\n                            // Modo UNE - UNE ou UNE - UNES\n                            if (selectedUneOrigem() === une.une) {\n                              setSelectedUneOrigem('');\n                            } else {\n                              setSelectedUneOrigem(une.une);\n                            }\n                          }\n                        };\n                        \n                        return (\n                          <div \n                            class={`flex items-center gap-2 text-xs cursor-pointer p-1.5 rounded transition ${\n                              isSelectedInMode() ? 'bg-blue-100 dark:bg-blue-900' : 'hover:bg-muted/30'\n                            }`}\n                            onClick={toggleSelection}\n                          >\n                            <div class=\"flex-shrink-0\">\n                              {mode() === 'N\u2192N' ? (\n                                <input\n                                  type=\"checkbox\"\n                                  checked={isSelectedInMode()}\n                                  onClick={(e) => e.stopPropagation()}\n                                  onChange={toggleSelection}\n                                  class=\"cursor-pointer\"\n                                />\n                              ) : (\n                                <input\n                                  type=\"radio\"\n                                  name=\"origin-une\"\n                                  checked={isSelectedInMode()}\n                                  onClick={(e) => e.stopPropagation()}\n                                  onChange={toggleSelection}\n                                  class=\"cursor-pointer\"\n                                />\n                              )}\n                            </div>\n                            <span>UNE {une.une}</span>\n                            <span class=\"text-muted text-xs\">({une.estoque_total} un.", "mimetype": "text/plain", "start_char_idx": 11884, "end_char_idx": 16187, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b14969c2-d401-4431-8054-e171188eaa7b": {"__data__": {"id_": "b14969c2-d401-4431-8054-e171188eaa7b", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7983b46e-58f1-4f9b-a389-2588d6edef24", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "a390e776dcaced88e1a3b23800ca911eb4b437449eade697f7009fca6e08c986", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "5fcabd73-d92e-4157-86cc-290fcd46db4e", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "b179be03a89f90af6e3a949290d2dce51b76d602aa41cef302b3c07cf7cdba73", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "6ee26294-c1dd-48b0-9bb2-9d9b7c33e3d0", "node_type": "1", "metadata": {}, "hash": "f5f98a2990b17d21b0acfb41742d1ba4b9fb7f9bbe89aa2c609ff64aca800c86", "class_name": "RelatedNodeInfo"}}, "text": "'bg-blue-100 dark:bg-blue-900' : 'hover:bg-muted/30'\n                            }`}\n                            onClick={toggleSelection}\n                          >\n                            <div class=\"flex-shrink-0\">\n                              {mode() === 'N\u2192N' ? (\n                                <input\n                                  type=\"checkbox\"\n                                  checked={isSelectedInMode()}\n                                  onClick={(e) => e.stopPropagation()}\n                                  onChange={toggleSelection}\n                                  class=\"cursor-pointer\"\n                                />\n                              ) : (\n                                <input\n                                  type=\"radio\"\n                                  name=\"origin-une\"\n                                  checked={isSelectedInMode()}\n                                  onClick={(e) => e.stopPropagation()}\n                                  onChange={toggleSelection}\n                                  class=\"cursor-pointer\"\n                                />\n                              )}\n                            </div>\n                            <span>UNE {une.une}</span>\n                            <span class=\"text-muted text-xs\">({une.estoque_total} un.)</span>\n                          </div>\n                        );\n                      }}\n                    </For>\n                  </Show>\n                </div>\n              </div>\n\n              {/* Destination UNEs Selection */}\n              <div>\n                <label class=\"text-xs text-muted block mb-2 font-semibold\">\n                  UNE(s) de Destino\n                  {(mode() === '1\u2192N' || mode() === 'N\u2192N') && ` (${selectedUnesDestino().length} selecionadas)`}\n                </label>\n                <div class=\"max-h-40 overflow-y-auto border rounded p-3 space-y-2 bg-muted/5\">\n                  <Show when={unes().length > 0} fallback={\n                    <div class=\"text-xs text-muted p-2\">Nenhuma UNE dispon\u00edvel</div>\n                  }>\n                    <For each={unes()}>\n                      {(une) => {\n                        const isDisabledDestino = () => mode() === 'UNE - UNE' \n                          ? selectedUneOrigem() === une.une\n                          : mode() === 'UNES - UNES'\n                          ? selectedUnesOrigem().includes(une.une)\n                          : selectedUneOrigem() === une.une;\n\n                        const isSelectedDestino = () => selectedUnesDestino().includes(une.une);\n                        \n                        const toggleDestSelection = () => {\n                          if (isDisabledDestino()) return; // Impedir clique em origem\n                          \n                          const current = selectedUnesDestino();\n                          if (current.includes(une.une)) {\n                            setSelectedUnesDestino(current.filter(u => u !== une.une));\n                          } else {\n                            if (mode() === 'UNE - UNE' && current.length >= 1) {\n                              setSelectedUnesDestino([une.une]);\n                            } else {\n                              setSelectedUnesDestino([...current, une.une]);\n                            }\n                          }\n                        };\n\n                        return (\n                          <div \n                            class={`flex items-center gap-2 text-xs p-1.5 rounded transition ${\n                              isDisabledDestino() \n                                ? 'opacity-50 cursor-not-allowed bg-gray-100 dark:bg-gray-800' \n                                : isSelectedDestino()\n                                ? 'bg-green-100 dark:bg-green-900 cursor-pointer'\n                                : 'hover:bg-muted/30 cursor-pointer'\n                            }`}\n                            onClick={toggleDestSelection}\n                          >\n                            <div class=\"flex-shrink-0\">\n                              <input\n                                type=\"checkbox\"\n                                disabled={isDisabledDestino()}\n                                checked={isSelectedDestino()}\n                                onClick={(e) => e.stopPropagation()}\n                                onChange={toggleDestSelection}\n                                class={`cursor-pointer ${isDisabledDestino() ? 'opacity-50 cursor-not-allowed' : ''}`}\n                              />\n                            </div>\n                            <span class={isDisabledDestino() ? 'line-through text-muted' : ''}>\n                              UNE {une.une}\n                            </span>\n                            <span class=\"text-muted text-xs\">({une.estoque_total} un.", "mimetype": "text/plain", "start_char_idx": 14867, "end_char_idx": 19720, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "6ee26294-c1dd-48b0-9bb2-9d9b7c33e3d0": {"__data__": {"id_": "6ee26294-c1dd-48b0-9bb2-9d9b7c33e3d0", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7983b46e-58f1-4f9b-a389-2588d6edef24", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "a390e776dcaced88e1a3b23800ca911eb4b437449eade697f7009fca6e08c986", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "b14969c2-d401-4431-8054-e171188eaa7b", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "8f91462b4426a117bc5793d651ef77fe90f2886b84c2b08f60d19df59ab743f4", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "63fe201c-9c6e-4e3a-a9b9-9dcf6201ccc4", "node_type": "1", "metadata": {}, "hash": "9435002b2ddfdf8db90769a002ad91e48add13d1b7d0eed7ae61e7ac2a2f91d9", "class_name": "RelatedNodeInfo"}}, "text": "'opacity-50 cursor-not-allowed bg-gray-100 dark:bg-gray-800' \n                                : isSelectedDestino()\n                                ? 'bg-green-100 dark:bg-green-900 cursor-pointer'\n                                : 'hover:bg-muted/30 cursor-pointer'\n                            }`}\n                            onClick={toggleDestSelection}\n                          >\n                            <div class=\"flex-shrink-0\">\n                              <input\n                                type=\"checkbox\"\n                                disabled={isDisabledDestino()}\n                                checked={isSelectedDestino()}\n                                onClick={(e) => e.stopPropagation()}\n                                onChange={toggleDestSelection}\n                                class={`cursor-pointer ${isDisabledDestino() ? 'opacity-50 cursor-not-allowed' : ''}`}\n                              />\n                            </div>\n                            <span class={isDisabledDestino() ? 'line-through text-muted' : ''}>\n                              UNE {une.une}\n                            </span>\n                            <span class=\"text-muted text-xs\">({une.estoque_total} un.)</span>\n                          </div>\n                        );\n                      }}\n                    </For>\n                  </Show>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1\">\n        {/* Left Column - Product Search */}\n        <div class=\"lg:col-span-2 flex flex-col gap-4\">\n          {/* Search Filters */}\n          <div class=\"card p-4 border\">\n            <div class=\"flex items-center gap-2 mb-4\">\n              <Search size={20} />\n              <h3 class=\"font-semibold\">Buscar Produtos</h3>\n            </div>\n\n            <div class=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\n              <select\n                class=\"input\"\n                value={searchSegmento()}\n                onChange={(e) => setSearchSegmento(e.currentTarget.value)}\n              >\n                <option value=\"\">Todos os Segmentos</option>\n                <For each={availableSegmentos()}>\n                  {(segmento) => <option value={segmento}>{segmento}</option>}\n                </For>\n              </select>\n\n              <select\n                class=\"input\"\n                value={searchFabricante()}\n                onChange={(e) => setSearchFabricante(e.currentTarget.value)}\n              >\n                <option value=\"\">Todos os Fabricantes</option>\n                <For each={availableFabricantes()}>\n                  {(fabricante) => <option value={fabricante}>{fabricante}</option>}\n                </For>\n              </select>\n\n              <input\n                type=\"number\"\n                placeholder=\"Estoque m\u00edn.\"\n                class=\"input\"\n                value={searchEstoqueMin()}\n                onInput={(e) => setSearchEstoqueMin(parseInt(e.currentTarget.value) || '')}\n              />\n            </div>\n\n            <button\n              class=\"btn btn-primary w-full mt-3 gap-2\"\n              onClick={searchProducts}\n              disabled={searching()}\n            >\n              <Search size={16} />\n              {searching() ? 'Buscando...' : 'Buscar'}\n            </button>\n          </div>\n\n          {/* Products List */}\n          <div class=\"card border flex-1 flex flex-col\">\n            <div class=\"p-4 border-b\">\n              <h3 class=\"font-semibold\">Produtos ({products().length})</h3>\n            </div>\n\n            <div class=\"flex-1 overflow-y-auto\">\n              <Show when={products().length > 0} fallback={\n                <div class=\"p-8 text-center text-muted\">\n                  <Package size={48} class=\"mx-auto mb-4 opacity-50\" />\n                  <p>Nenhum produto encontrado</p>\n                </div>\n              }>\n                <For each={products()}>\n                  {(product) => {\n                    const isSelected = () => selectedProducts().some(p => p.produto_id === product.produto_id);\n                    return (\n                      <div\n                        class={`p-3 border-b hover:bg-muted/30 cursor-pointer transition-colors ${\n                          isSelected() ?", "mimetype": "text/plain", "start_char_idx": 18489, "end_char_idx": 22834, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "63fe201c-9c6e-4e3a-a9b9-9dcf6201ccc4": {"__data__": {"id_": "63fe201c-9c6e-4e3a-a9b9-9dcf6201ccc4", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7983b46e-58f1-4f9b-a389-2588d6edef24", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "a390e776dcaced88e1a3b23800ca911eb4b437449eade697f7009fca6e08c986", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "6ee26294-c1dd-48b0-9bb2-9d9b7c33e3d0", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "050f3ed6fd1aacb936619711d182bc1ccc422a4fd8e68a6f748a8a98938e4a0b", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "05495d88-f368-44c5-ab1a-ff73d4f0e3cd", "node_type": "1", "metadata": {}, "hash": "3d3ad014b834db6d097a072768a8a4a5016e8e45315c65fee28f879a8ab903f0", "class_name": "RelatedNodeInfo"}}, "text": "'bg-primary/10 border-primary' : ''\n                        }`}\n                        onClick={() => toggleProductSelection(product)}\n                      >\n                        <div class=\"flex items-start gap-3\">\n                          <div class=\"pt-1\">\n                            <input \n                              type=\"checkbox\" \n                              checked={isSelected()} \n                              readOnly\n                              class=\"cursor-pointer pointer-events-none\"\n                            />\n                          </div>\n                          <div class=\"flex-1 flex justify-between items-start\">\n                            <div>\n                              <div class=\"font-medium text-sm\">{product.nome}</div>\n                              <div class=\"text-xs text-muted mt-1\">\n                                ID: {product.produto_id} \u2022 {product.segmento} \u2022 {product.fabricante}\n                              </div>\n                            </div>\n                            <div class=\"text-right text-xs\">\n                              <div class=\"text-muted\">Loja: {product.estoque_loja}</div>\n                              <div class=\"text-muted\">CD: {product.estoque_cd}</div>\n                              <div class=\"text-blue-400\">Vendas: {product.vendas_30dd}</div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  }}\n                </For>\n              </Show>\n            </div>\n          </div>\n        </div>\n\n        {/* Right Column - Transfer Config & Cart */}\n        <div class=\"flex flex-col gap-4\">\n          {/* Transfer Configuration */}\n          <Show when={selectedProducts().length > 0}>\n            <div class=\"card p-4 border\">\n              <Show when={selectedProducts().length === 1} fallback={\n                <div class=\"mb-4\">\n                  <h3 class=\"font-semibold mb-3 text-sm\">{selectedProducts().length} Produtos Selecionados</h3>\n                  <div class=\"max-h-32 overflow-y-auto border rounded p-2 bg-muted/5 space-y-1\">\n                    <For each={selectedProducts()}>\n                      {p => <div class=\"text-xs truncate text-muted\">\u2022 {p.nome}</div>}\n                    </For>\n                  </div>\n                </div>\n              }>\n                <h3 class=\"font-semibold mb-3 text-sm\">Detalhe do Produto Selecionado</h3>\n\n                <div class=\"space-y-3 mb-4\">\n                  <div>\n                    <label class=\"text-xs text-muted block mb-1\">Produto</label>\n                    <div class=\"text-sm font-medium truncate\">{selectedProducts()[0].nome}</div>\n                  </div>\n\n                  <div class=\"text-xs text-muted space-y-1\">\n                    <div>ID: {selectedProducts()[0].produto_id}</div>\n                    <div>Segmento: {selectedProducts()[0].segmento}</div>\n                    <div>Fabricante: {selectedProducts()[0].fabricante}</div>\n                    <div class=\"mt-2 pt-2 border-t\">\n                      <div>Estoque Loja: <span class=\"text-foreground font-medium\">{selectedProducts()[0].estoque_loja} un.</span></div>\n                      <div>Estoque CD: <span class=\"text-foreground font-medium\">{selectedProducts()[0].estoque_cd} un.</span></div>\n                      <div>Vendas (30dd): <span class=\"text-blue-400 font-medium\">{selectedProducts()[0].vendas_30dd}</span></div>\n                    </div>\n                  </div>\n                </div>\n              </Show>\n\n              <div class=\"space-y-3\">\n                <div>\n                  <label class=\"text-xs text-muted block mb-1\">Quantidade a Transferir {selectedProducts().length > 1 ? '(para cada)' : ''}</label>\n                  <input\n                    type=\"number\"\n                    class=\"input w-full\"\n                    placeholder=\"0\"\n                    value={quantidade()}\n                    onInput={(e) => setQuantidade(parseInt(e.currentTarget.value) || '')}\n                  />\n                </div>\n\n                <button\n                  class=\"btn btn-primary w-full gap-2 text-sm\"\n                  onClick={addToCart}\n                  disabled={validating() || selectedProducts().length === 0 || \n                    (mode() === 'N\u2192N' ? selectedUnesOrigem().length === 0 : !selectedUneOrigem()) || \n                    selectedUnesDestino().length === 0 || !quantidade()}\n                >\n                  <Plus size={16} />\n                  {validating() ? 'Validando...' : `Adicionar ${selectedProducts().length > 1 ?", "mimetype": "text/plain", "start_char_idx": 22835, "end_char_idx": 27478, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "05495d88-f368-44c5-ab1a-ff73d4f0e3cd": {"__data__": {"id_": "05495d88-f368-44c5-ab1a-ff73d4f0e3cd", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "7983b46e-58f1-4f9b-a389-2588d6edef24", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "a390e776dcaced88e1a3b23800ca911eb4b437449eade697f7009fca6e08c986", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "63fe201c-9c6e-4e3a-a9b9-9dcf6201ccc4", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}, "hash": "3f47e2d328ff5e59ffa8453a2296d8d9deaddad235045d37afe445b15ebbf27a", "class_name": "RelatedNodeInfo"}}, "text": "'(para cada)' : ''}</label>\n                  <input\n                    type=\"number\"\n                    class=\"input w-full\"\n                    placeholder=\"0\"\n                    value={quantidade()}\n                    onInput={(e) => setQuantidade(parseInt(e.currentTarget.value) || '')}\n                  />\n                </div>\n\n                <button\n                  class=\"btn btn-primary w-full gap-2 text-sm\"\n                  onClick={addToCart}\n                  disabled={validating() || selectedProducts().length === 0 || \n                    (mode() === 'N\u2192N' ? selectedUnesOrigem().length === 0 : !selectedUneOrigem()) || \n                    selectedUnesDestino().length === 0 || !quantidade()}\n                >\n                  <Plus size={16} />\n                  {validating() ? 'Validando...' : `Adicionar ${selectedProducts().length > 1 ? `(${selectedProducts().length})` : ''} ao Carrinho`}\n                </button>\n              </div>\n            </div>\n          </Show>\n\n          {/* Cart */}\n          <div class=\"card border flex-1 flex flex-col\">\n            <div class=\"p-3 border-b flex justify-between items-center\">\n              <div class=\"flex items-center gap-2\">\n                <ShoppingCart size={18} />\n                <h3 class=\"font-semibold text-sm\">Carrinho ({cart.items.length})</h3>\n              </div>\n              <Show when={cart.items.length > 0}>\n                <button\n                  class=\"text-xs text-red-400 hover:text-red-300\"\n                  onClick={clearCart}\n                >\n                  Limpar\n                </button>\n              </Show>\n            </div>\n\n            <div class=\"flex-1 overflow-y-auto\">\n              <Show when={cart.items.length > 0} fallback={\n                <div class=\"p-6 text-center text-muted text-sm\">\n                  <ShoppingCart size={32} class=\"mx-auto mb-2 opacity-50\" />\n                  <p>Carrinho vazio</p>\n                </div>\n              }>\n                <For each={cart.items}>\n                  {(item, index) => (\n                    <div class=\"p-3 border-b text-xs\">\n                      <div class=\"flex justify-between items-start mb-2\">\n                        <div class=\"flex-1 font-medium\">{item.produto_nome}</div>\n                        <button\n                          class=\"text-red-400 hover:text-red-300\"\n                          onClick={() => removeFromCart(index())}\n                        >\n                          <Trash2 size={14} />\n                        </button>\n                      </div>\n\n                      <div class=\"space-y-1 text-muted\">\n                        <div class=\"flex items-center gap-1\">\n                          <span>UNE {item.une_origem}</span>\n                          <ArrowRight size={12} />\n                          <span>UNE {item.une_destino.join(', ')}</span>\n                        </div>\n                        <div>Qtd: {item.quantidade} un.</div>\n                        <Show when={item.score !== undefined}>\n                          <div class=\"flex items-center gap-2\">\n                            <span>Score: {item.score}</span>\n                            <span class={`font-semibold ${getUrgencyColor(item.nivel_urgencia)}`}>\n                              {item.nivel_urgencia}\n                            </span>\n                          </div>\n                        </Show>\n                      </div>\n                    </div>\n                  )}\n                </For>\n              </Show>\n            </div>\n\n            <Show when={cart.items.length > 0}>\n              <div class=\"p-3 border-t\">\n                <button\n                  class=\"btn btn-primary w-full gap-2 text-sm\"\n                  onClick={generateRequest}\n                  disabled={creating()}\n                >\n                  <Truck size={16} />\n                  {creating() ? 'Gerando...' : 'Gerar Solicita\u00e7\u00e3o'}\n                </button>\n              </div>\n            </Show>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}", "mimetype": "text/plain", "start_char_idx": 26608, "end_char_idx": 30674, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "b3b18377-3a62-4498-83cb-360fd9e07714": {"__data__": {"id_": "b3b18377-3a62-4498-83cb-360fd9e07714", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\services\\admin.service.ts", "language": "typescript", "lines": 59, "filename": "admin.service.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "c41d658b-1b6b-4bdd-9b34-f96365b4ac82", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\services\\admin.service.ts", "language": "typescript", "lines": 59, "filename": "admin.service.ts"}, "hash": "7bc709ec31a8690adb123c46d0329f00a9ab4b73b750ead07d29d4c8d9e996e3", "class_name": "RelatedNodeInfo"}}, "text": "import { apiClient } from '@/lib/api/client';\nimport type {\n  AdminStats,\n  User,\n  CreateUserDTO,\n  UpdateUserDTO,\n  AuditLog,\n  SystemSettings,\n} from '@/types/admin';\n\nexport const adminService = {\n  async getStats(): Promise<AdminStats> {\n    // Connect to FastAPI backend: GET /api/v1/admin/stats\n    return apiClient.get<AdminStats>('/api/v1/admin/stats');\n  },\n\n  async getUsers(): Promise<User[]> {\n    // Connect to FastAPI backend: GET /api/v1/admin/users\n    return apiClient.get<User[]>('/api/v1/admin/users');\n  },\n\n  async getUser(id: string): Promise<User> {\n    // Connect to FastAPI backend: GET /api/v1/admin/users/{id}\n    return apiClient.get<User>(`/api/v1/admin/users/${id}`);\n  },\n\n  async createUser(user: CreateUserDTO): Promise<User> {\n    // Connect to FastAPI backend: POST /api/v1/admin/users\n    return apiClient.post<User>('/api/v1/admin/users', user);\n  },\n\n  async updateUser(id: string, user: UpdateUserDTO): Promise<User> {\n    // Connect to FastAPI backend: PUT /api/v1/admin/users/{id}\n    return apiClient.put<User>(`/api/v1/admin/users/${id}`, user);\n  },\n\n  async deleteUser(id: string): Promise<void> {\n    // Connect to FastAPI backend: DELETE /api/v1/admin/users/{id}\n    return apiClient.delete(`/api/v1/admin/users/${id}`);\n  },\n\n  async getAuditLogs(limit = 100): Promise<AuditLog[]> {\n    // Connect to FastAPI backend: GET /api/v1/admin/audit-logs\n    return apiClient.get<AuditLog[]>(`/api/v1/admin/audit-logs?limit=${limit}`);\n  },\n\n  async getSettings(): Promise<SystemSettings> {\n    // Connect to FastAPI backend: GET /api/v1/admin/settings\n    // TODO: Backend endpoint not implemented yet\n    return apiClient.get<SystemSettings>('/api/v1/admin/settings');\n  },\n\n  async updateSettings(settings: Partial<SystemSettings>): Promise<SystemSettings> {\n    // Connect to FastAPI backend: PUT /api/v1/admin/settings\n    // TODO: Backend endpoint not implemented yet\n    return apiClient.put<SystemSettings>('/api/v1/admin/settings', settings);\n  },\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2000, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "ac46a0ac-4404-4384-8280-b27ee95b70d1": {"__data__": {"id_": "ac46a0ac-4404-4384-8280-b27ee95b70d1", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\services\\analytics.service.ts", "language": "typescript", "lines": 52, "filename": "analytics.service.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "88cba982-fb17-4b97-baa3-2f4d667ae13e", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\services\\analytics.service.ts", "language": "typescript", "lines": 52, "filename": "analytics.service.ts"}, "hash": "e7cc8920342c0395230269af66f38ecf9330c0173fd57cae8464a90cf87cac81", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * Analytics Service\n * Servi\u00e7o para comunica\u00e7\u00e3o com API de analytics\n */\n\nimport { apiClient } from '@/lib/api/client';\nimport type {\n  AnalyticsData,\n  AnalyticsFilter,\n  AnalyticsMetric,\n  ExportFormat,\n} from '@/types/analytics';\n\nexport const analyticsService = {\n  async getData(filters?: AnalyticsFilter): Promise<AnalyticsData[]> {\n    // Connect to FastAPI backend: GET /api/v1/analytics/data\n    const params = new URLSearchParams();\n    if (filters?.dateRange) {\n      params.append('date_start', filters.dateRange.start.toISOString());\n      params.append('date_end', filters.dateRange.end.toISOString());\n    }\n    if (filters?.category) params.append('category', filters.category);\n    if (filters?.segment) params.append('segment', filters.segment);\n    if (filters?.minValue !== undefined) params.append('min_value', filters.minValue.toString());\n    if (filters?.maxValue !== undefined) params.append('max_value', filters.maxValue.toString());\n\n    return apiClient.get<AnalyticsData[]>(`/api/v1/analytics/data?${params.toString()}`);\n  },\n\n  async getMetrics(): Promise<AnalyticsMetric[]> {\n    // Connect to FastAPI backend: GET /api/v1/analytics/metrics\n    return apiClient.get<AnalyticsMetric[]>('/api/v1/analytics/metrics');\n  },\n\n  async exportData(format: ExportFormat, filters?: AnalyticsFilter): Promise<Blob> {\n    // Connect to FastAPI backend: POST /api/v1/analytics/export\n    const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/v1/analytics/export`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({ format, filters }),\n    });\n    return response.blob();\n  },\n\n  async runCustomQuery(query: string): Promise<any> {\n    // Connect to FastAPI backend: POST /api/v1/analytics/query\n    return apiClient.post('/api/v1/analytics/query', { query });\n  },\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1878, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "16e7e1ac-be38-4c09-9ff9-63d771cc465c": {"__data__": {"id_": "16e7e1ac-be38-4c09-9ff9-63d771cc465c", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\services\\auth.service.ts", "language": "typescript", "lines": 38, "filename": "auth.service.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "0de11889-4a35-4bf4-b303-05575c99a366", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\services\\auth.service.ts", "language": "typescript", "lines": 38, "filename": "auth.service.ts"}, "hash": "08ec90d97b3e5b056819a742060de4225f02e0ee903f607dc778b7bfb3c4e9af", "class_name": "RelatedNodeInfo"}}, "text": "import { apiClient } from '@/lib/api/client';\nimport type { User } from '@/store/auth.store';\n\nexport interface LoginCredentials {\n  username: string;\n  password: string;\n}\n\nexport interface AuthResponse {\n  access_token: string;\n  refresh_token: string;\n  token_type: string;\n}\n\nexport const authService = {\n  async login(credentials: LoginCredentials): Promise<AuthResponse> {\n    // Use production authentication endpoint only\n    return apiClient.post<AuthResponse>('/api/v1/auth/login', credentials);\n  },\n\n  async logout(): Promise<void> {\n    // Connect to FastAPI backend: POST /api/v1/auth/logout\n    return apiClient.post('/api/v1/auth/logout');\n  },\n\n  async getCurrentUser(): Promise<User> {\n    // Connect to FastAPI backend: GET /api/v1/auth/me\n    return apiClient.get<User>('/api/v1/auth/me');\n  },\n\n  async refreshToken(refreshToken: string): Promise<AuthResponse> {\n    // Connect to FastAPI backend: POST /api/v1/auth/refresh\n    return apiClient.post<AuthResponse>('/api/v1/auth/refresh', {\n      refresh_token: refreshToken,\n    });\n  },\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 1061, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "52993a83-5c5b-41ef-904b-e47effd50b2b": {"__data__": {"id_": "52993a83-5c5b-41ef-904b-e47effd50b2b", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f58052c3-2b80-4156-b1a2-53145ff358b6", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "hash": "98e3f19a4fc9e86670208a18db3205074dba03963bb31f6f9bb5e2d78f7c7849", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "279e21f2-5cf2-44ac-83b9-86a811121baa", "node_type": "1", "metadata": {}, "hash": "024d4865ef229e42d6543fea03ecd0899139c9b323a29b1e156aa54db3212679", "class_name": "RelatedNodeInfo"}}, "text": "/**\n * Sistema de Logging para Frontend\n * Gerencia logs no browser e envia logs importantes para o backend\n */\n\nexport enum LogLevel {\n  DEBUG = 0,\n  INFO = 1,\n  WARN = 2,\n  ERROR = 3,\n  CRITICAL = 4,\n}\n\nexport interface LogEntry {\n  timestamp: string;\n  level: LogLevel;\n  levelName: string;\n  message: string;\n  context?: Record<string, any>;\n  error?: {\n    name: string;\n    message: string;\n    stack?: string;\n  };\n  user?: {\n    id?: string;\n    email?: string;\n  };\n  session?: {\n    id?: string;\n    duration?: number;\n  };\n  page?: {\n    url: string;\n    referrer?: string;\n    title?: string;\n  };\n  browser?: {\n    userAgent: string;\n    language: string;\n    platform: string;\n  };\n}\n\nexport interface LoggerConfig {\n  minLevel: LogLevel;\n  enableConsole: boolean;\n  enableRemote: boolean;\n  remoteEndpoint?: string;\n  maxBufferSize: number;\n  flushInterval: number;\n  includeStackTrace: boolean;\n  sanitizeData: boolean;\n}\n\n/**\n * Classe principal do Logger\n */\nclass Logger {\n  private config: LoggerConfig = {\n    minLevel: LogLevel.DEBUG,\n    enableConsole: true,\n    enableRemote: true,\n    remoteEndpoint: '/api/v1/logs',\n    maxBufferSize: 50,\n    flushInterval: 10000, // 10 segundos\n    includeStackTrace: true,\n    sanitizeData: true,\n  };\n\n  private buffer: LogEntry[] = [];\n  private flushTimer: number | null = null;\n  private sessionId: string;\n  private sessionStart: number;\n\n  constructor(config?: Partial<LoggerConfig>) {\n    if (config) {\n      this.config = { ...this.config, ...config };\n    }\n\n    this.sessionId = this.generateSessionId();\n    this.sessionStart = Date.now();\n\n    // Inicia o timer de flush\n    this.startFlushTimer();\n\n    // Captura erros globais n\u00e3o tratados\n    this.setupGlobalErrorHandlers();\n\n    // Flush antes de sair da p\u00e1gina\n    if (typeof window !== 'undefined') {\n      window.addEventListener('beforeunload', () => {\n        this.flush();\n      });\n    }\n  }\n\n  /**\n   * Configura o logger\n   */\n  public configure(config: Partial<LoggerConfig>): void {\n    this.config = { ...this.config, ...config };\n  }\n\n  /**\n   * Gera um ID \u00fanico para a sess\u00e3o\n   */\n  private generateSessionId(): string {\n    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * Obt\u00e9m informa\u00e7\u00f5es do browser\n   */\n  private getBrowserInfo() {\n    if (typeof window === 'undefined') return undefined;\n\n    return {\n      userAgent: navigator.userAgent,\n      language: navigator.language,\n      platform: navigator.platform,\n    };\n  }\n\n  /**\n   * Obt\u00e9m informa\u00e7\u00f5es da p\u00e1gina atual\n   */\n  private getPageInfo() {\n    if (typeof window === 'undefined') return undefined;\n\n    return {\n      url: window.location.href,\n      referrer: document.referrer || undefined,\n      title: document.title,\n    };\n  }\n\n  /**\n   * Obt\u00e9m informa\u00e7\u00f5es da sess\u00e3o\n   */\n  private getSessionInfo() {\n    return {\n      id: this.sessionId,\n      duration: Date.now() - this.sessionStart,\n    };\n  }\n\n  /**\n   * Sanitiza dados sens\u00edveis\n   */\n  private sanitize(data: any): any {\n    if (!this.config.sanitizeData) return data;\n\n    const sensitiveKeys = ['password', 'token', 'secret', 'apiKey', 'api_key', 'authorization'];\n\n    if (typeof data !== 'object' || data === null) return data;\n\n    const sanitized = Array.isArray(data) ? [...data] : { ...data };\n\n    for (const key in sanitized) {\n      if (sensitiveKeys.some(sk => key.toLowerCase().includes(sk.toLowerCase()))) {\n        sanitized[key] = '***REDACTED***';\n      } else if (typeof sanitized[key] === 'object' && sanitized[key] !== null) {\n        sanitized[key] = this.sanitize(sanitized[key]);\n      }\n    }\n\n    return sanitized;\n  }\n\n  /**\n   * Cria uma entrada de log\n   */\n  private createLogEntry(\n    level: LogLevel,\n    message: string,\n    context?: Record<string, any>,\n    error?", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 3809, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "279e21f2-5cf2-44ac-83b9-86a811121baa": {"__data__": {"id_": "279e21f2-5cf2-44ac-83b9-86a811121baa", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f58052c3-2b80-4156-b1a2-53145ff358b6", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "hash": "98e3f19a4fc9e86670208a18db3205074dba03963bb31f6f9bb5e2d78f7c7849", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "52993a83-5c5b-41ef-904b-e47effd50b2b", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "hash": "03f938e571147b8a3786cc23311b7906f8937452d7f015c77db00e89c34fe682", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "27454026-63dc-4179-a8f6-823e765b1286", "node_type": "1", "metadata": {}, "hash": "177ccc334341aad1d0fbfac34887eb8bd7dae2b5ae881ad0662e3479dab28f13", "class_name": "RelatedNodeInfo"}}, "text": "[...data] : { ...data };\n\n    for (const key in sanitized) {\n      if (sensitiveKeys.some(sk => key.toLowerCase().includes(sk.toLowerCase()))) {\n        sanitized[key] = '***REDACTED***';\n      } else if (typeof sanitized[key] === 'object' && sanitized[key] !== null) {\n        sanitized[key] = this.sanitize(sanitized[key]);\n      }\n    }\n\n    return sanitized;\n  }\n\n  /**\n   * Cria uma entrada de log\n   */\n  private createLogEntry(\n    level: LogLevel,\n    message: string,\n    context?: Record<string, any>,\n    error?: Error\n  ): LogEntry {\n    const entry: LogEntry = {\n      timestamp: new Date().toISOString(),\n      level,\n      levelName: LogLevel[level],\n      message,\n      context: context ? this.sanitize(context) : undefined,\n      browser: this.getBrowserInfo(),\n      page: this.getPageInfo(),\n      session: this.getSessionInfo(),\n    };\n\n    // Adiciona informa\u00e7\u00f5es de erro se dispon\u00edvel\n    if (error) {\n      entry.error = {\n        name: error.name,\n        message: error.message,\n        stack: this.config.includeStackTrace ? error.stack : undefined,\n      };\n    }\n\n    // Adiciona informa\u00e7\u00f5es do usu\u00e1rio se dispon\u00edvel\n    const user = this.getCurrentUser();\n    if (user) {\n      entry.user = user;\n    }\n\n    return entry;\n  }\n\n  /**\n   * Obt\u00e9m informa\u00e7\u00f5es do usu\u00e1rio atual (do localStorage ou store)\n   */\n  private getCurrentUser(): { id?: string; email?: string } | undefined {\n    if (typeof window === 'undefined') return undefined;\n\n    try {\n      const userStr = localStorage.getItem('user');\n      if (userStr) {\n        const user = JSON.parse(userStr);\n        return {\n          id: user.id,\n          email: user.email,\n        };\n      }\n    } catch {\n      // Ignora erros ao buscar usu\u00e1rio\n    }\n\n    return undefined;\n  }\n\n  /**\n   * Registra um log\n   */\n  private log(\n    level: LogLevel,\n    message: string,\n    context?: Record<string, any>,\n    error?: Error\n  ): void {\n    // Verifica se o n\u00edvel \u00e9 suficiente\n    if (level < this.config.minLevel) return;\n\n    const entry = this.createLogEntry(level, message, context, error);\n\n    // Log no console\n    if (this.config.enableConsole) {\n      this.logToConsole(entry);\n    }\n\n    // Adiciona ao buffer para envio remoto\n    if (this.config.enableRemote) {\n      this.buffer.push(entry);\n\n      // Se buffer est\u00e1 cheio, faz flush imediatamente\n      if (this.buffer.length >= this.config.maxBufferSize) {\n        this.flush();\n      }\n    }\n  }\n\n  /**\n   * Escreve log no console do browser\n   */\n  private logToConsole(entry: LogEntry): void {\n    const styles = {\n      [LogLevel.DEBUG]: 'color: #888; font-weight: normal',\n      [LogLevel.INFO]: 'color: #2563eb; font-weight: normal',\n      [LogLevel.WARN]: 'color: #d97706; font-weight: bold',\n      [LogLevel.ERROR]: 'color: #dc2626; font-weight: bold',\n      [LogLevel.CRITICAL]: 'color: #991b1b; font-weight: bold; font-size: 14px',\n    };\n\n    const prefix = `[${entry.levelName}] ${entry.timestamp}`;\n    const style = styles[entry.level];\n\n    const consoleMethod =\n      entry.level >= LogLevel.ERROR ? console.error :\n      entry.level === LogLevel.WARN ? console.warn :\n      entry.level === LogLevel.INFO ?", "mimetype": "text/plain", "start_char_idx": 3287, "end_char_idx": 6461, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "27454026-63dc-4179-a8f6-823e765b1286": {"__data__": {"id_": "27454026-63dc-4179-a8f6-823e765b1286", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f58052c3-2b80-4156-b1a2-53145ff358b6", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "hash": "98e3f19a4fc9e86670208a18db3205074dba03963bb31f6f9bb5e2d78f7c7849", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "279e21f2-5cf2-44ac-83b9-86a811121baa", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "hash": "7b8abd3f15e5115a709f3aaad5ebc45636a5a1d2807d854e4e3a766efdd021cd", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "e0bedf76-c15d-4c28-ba62-8bfc614de4a9", "node_type": "1", "metadata": {}, "hash": "32722bccbf619b833d31acb93974e4de55cac2922636f1af9badf7e2605c979d", "class_name": "RelatedNodeInfo"}}, "text": "console.error :\n      entry.level === LogLevel.WARN ? console.warn :\n      entry.level === LogLevel.INFO ? console.info :\n      console.debug;\n\n    consoleMethod(\n      `%c${prefix}`,\n      style,\n      entry.message,\n      entry.context || '',\n      entry.error || ''\n    );\n  }\n\n  /**\n   * Inicia o timer de flush autom\u00e1tico\n   */\n  private startFlushTimer(): void {\n    if (typeof window === 'undefined') return;\n\n    this.flushTimer = window.setInterval(() => {\n      if (this.buffer.length > 0) {\n        this.flush();\n      }\n    }, this.config.flushInterval);\n  }\n\n  /**\n   * Para o timer de flush\n   */\n  private stopFlushTimer(): void {\n    if (this.flushTimer !== null) {\n      clearInterval(this.flushTimer);\n      this.flushTimer = null;\n    }\n  }\n\n  /**\n   * Envia logs para o backend\n   */\n  public async flush(): Promise<void> {\n    if (this.buffer.length === 0 || !this.config.enableRemote) return;\n\n    const logsToSend = [...this.buffer];\n    this.buffer = [];\n\n    try {\n      const response = await fetch(this.config.remoteEndpoint!, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ logs: logsToSend }),\n        // N\u00e3o espera resposta em beforeunload\n        keepalive: true,\n      });\n\n      if (!response.ok) {\n        // Se falhar, recoloca no buffer\n        console.warn('Failed to send logs to backend:', response.statusText);\n        this.buffer.unshift(...logsToSend);\n      }\n    } catch (error) {\n      // Se falhar, recoloca no buffer\n      console.warn('Error sending logs to backend:', error);\n      this.buffer.unshift(...logsToSend);\n    }\n  }\n\n  /**\n   * Configura handlers para erros globais\n   */\n  private setupGlobalErrorHandlers(): void {\n    if (typeof window === 'undefined') return;\n\n    // Captura erros n\u00e3o tratados\n    window.addEventListener('error', (event) => {\n      this.error('Uncaught error', {\n        filename: event.filename,\n        lineno: event.lineno,\n        colno: event.colno,\n      }, event.error);\n    });\n\n    // Captura promises rejeitadas n\u00e3o tratadas\n    window.addEventListener('unhandledrejection', (event) => {\n      this.error('Unhandled promise rejection', {\n        reason: event.reason,\n      });\n    });\n  }\n\n  // M\u00e9todos p\u00fablicos para cada n\u00edvel de log\n\n  public debug(message: string, context?: Record<string, any>): void {\n    this.log(LogLevel.DEBUG, message, context);\n  }\n\n  public info(message: string, context?: Record<string, any>): void {\n    this.log(LogLevel.INFO, message, context);\n  }\n\n  public warn(message: string, context?: Record<string, any>): void {\n    this.log(LogLevel.WARN, message, context);\n  }\n\n  public error(message: string, context?: Record<string, any>, error?: Error): void {\n    this.log(LogLevel.ERROR, message, context, error);\n  }\n\n  public critical(message: string, context?: Record<string, any>, error?: Error): void {\n    this.log(LogLevel.CRITICAL, message, context, error);\n  }\n\n  /**\n   * M\u00e9todos para logging de eventos espec\u00edficos\n   */\n\n  public logPageView(pageName: string, metadata?: Record<string, any>): void {\n    this.info(`Page view: ${pageName}`, {\n      type: 'page_view',\n      page: pageName,\n      ...metadata,\n    });\n  }\n\n  public logUserAction(action: string, metadata?: Record<string, any>): void {\n    this.info(`User action: ${action}`, {\n      type: 'user_action',\n      action,\n      ...metadata,\n    });\n  }\n\n  public logApiCall(\n    method: string,\n    endpoint: string,\n    status: number,\n    duration: number,\n    error?: Error\n  ): void {\n    const level = status >= 500 ? LogLevel.ERROR : status >= 400 ? LogLevel.WARN : LogLevel.INFO;\n\n    this.log(\n      level,\n      `API ${method} ${endpoint} - ${status}`,\n      {\n        type: 'api_call',\n        method,\n        endpoint,\n        status,\n        duration,\n      },\n      error\n    );\n  }\n\n  public logPerformance(metric: string, value: number, metadata?", "mimetype": "text/plain", "start_char_idx": 6355, "end_char_idx": 10300, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e0bedf76-c15d-4c28-ba62-8bfc614de4a9": {"__data__": {"id_": "e0bedf76-c15d-4c28-ba62-8bfc614de4a9", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f58052c3-2b80-4156-b1a2-53145ff358b6", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "hash": "98e3f19a4fc9e86670208a18db3205074dba03963bb31f6f9bb5e2d78f7c7849", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "27454026-63dc-4179-a8f6-823e765b1286", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}, "hash": "96eaf90965100a1e76d8872e07080c1853b39566d6ba9b1b792b55f75f27b1cb", "class_name": "RelatedNodeInfo"}}, "text": ": Record<string, any>): void {\n    this.info(`User action: ${action}`, {\n      type: 'user_action',\n      action,\n      ...metadata,\n    });\n  }\n\n  public logApiCall(\n    method: string,\n    endpoint: string,\n    status: number,\n    duration: number,\n    error?: Error\n  ): void {\n    const level = status >= 500 ? LogLevel.ERROR : status >= 400 ? LogLevel.WARN : LogLevel.INFO;\n\n    this.log(\n      level,\n      `API ${method} ${endpoint} - ${status}`,\n      {\n        type: 'api_call',\n        method,\n        endpoint,\n        status,\n        duration,\n      },\n      error\n    );\n  }\n\n  public logPerformance(metric: string, value: number, metadata?: Record<string, any>): void {\n    this.info(`Performance: ${metric}`, {\n      type: 'performance',\n      metric,\n      value,\n      ...metadata,\n    });\n  }\n\n  /**\n   * Limpa o logger e para os timers\n   */\n  public destroy(): void {\n    this.flush();\n    this.stopFlushTimer();\n  }\n}\n\n// Singleton instance\nlet loggerInstance: Logger | null = null;\n\n/**\n * Obt\u00e9m a inst\u00e2ncia singleton do logger\n */\nexport function getLogger(config?: Partial<LoggerConfig>): Logger {\n  if (!loggerInstance) {\n    loggerInstance = new Logger(config);\n  } else if (config) {\n    loggerInstance.configure(config);\n  }\n  return loggerInstance;\n}\n\n/**\n * Exporta uma inst\u00e2ncia padr\u00e3o\n */\nexport const logger = getLogger();\n\n/**\n * Exporta m\u00e9todos convenientes\n */\nexport const log = {\n  debug: (message: string, context?: Record<string, any>) => logger.debug(message, context),\n  info: (message: string, context?: Record<string, any>) => logger.info(message, context),\n  warn: (message: string, context?: Record<string, any>) => logger.warn(message, context),\n  error: (message: string, context?: Record<string, any>, error?: Error) => logger.error(message, context, error),\n  critical: (message: string, context?: Record<string, any>, error?: Error) => logger.critical(message, context, error),\n  pageView: (pageName: string, metadata?: Record<string, any>) => logger.logPageView(pageName, metadata),\n  userAction: (action: string, metadata?: Record<string, any>) => logger.logUserAction(action, metadata),\n  apiCall: (method: string, endpoint: string, status: number, duration: number, error?: Error) =>\n    logger.logApiCall(method, endpoint, status, duration, error),\n  performance: (metric: string, value: number, metadata?: Record<string, any>) =>\n    logger.logPerformance(metric, value, metadata),\n};\n\nexport default logger;", "mimetype": "text/plain", "start_char_idx": 9647, "end_char_idx": 12112, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "5dacf70e-6265-434c-8e19-bfa904c3f5f5": {"__data__": {"id_": "5dacf70e-6265-434c-8e19-bfa904c3f5f5", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\services\\reports.service.ts", "language": "typescript", "lines": 65, "filename": "reports.service.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "19062a8f-ecf6-4569-9cba-72d49b774a24", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\services\\reports.service.ts", "language": "typescript", "lines": 65, "filename": "reports.service.ts"}, "hash": "e55d3c411e632c17bf0bb5c37bc6514318f821f4ee8263da4522eba7f7941252", "class_name": "RelatedNodeInfo"}}, "text": "import { apiClient } from '@/lib/api/client';\nimport type {\n  Report,\n  ReportTemplate,\n  CreateReportDTO,\n  UpdateReportDTO,\n  ReportSchedule,\n} from '@/types/reports';\n\nexport const reportsService = {\n  async getAll(): Promise<Report[]> {\n    // Connect to FastAPI backend: GET /api/v1/reports\n    return apiClient.get<Report[]>('/api/v1/reports');\n  },\n\n  async getById(id: string): Promise<Report> {\n    // Connect to FastAPI backend: GET /api/v1/reports/{id}\n    return apiClient.get<Report>(`/api/v1/reports/${id}`);\n  },\n\n  async create(report: CreateReportDTO): Promise<Report> {\n    // Connect to FastAPI backend: POST /api/v1/reports\n    return apiClient.post<Report>('/api/v1/reports', report);\n  },\n\n  async update(id: string, report: UpdateReportDTO): Promise<Report> {\n    // Connect to FastAPI backend: PUT /api/v1/reports/{id}\n    return apiClient.put<Report>(`/api/v1/reports/${id}`, report);\n  },\n\n  async delete(id: string): Promise<void> {\n    // Connect to FastAPI backend: DELETE /api/v1/reports/{id}\n    return apiClient.delete(`/api/v1/reports/${id}`);\n  },\n\n  async getTemplates(): Promise<ReportTemplate[]> {\n    // Connect to FastAPI backend: GET /api/v1/reports/templates\n    // TODO: Backend endpoint not implemented yet\n    return apiClient.get<ReportTemplate[]>('/api/v1/reports/templates');\n  },\n\n  async generatePDF(id: string): Promise<Blob> {\n    // Connect to FastAPI backend: POST /api/v1/reports/{id}/generate-pdf\n    const response = await fetch(\n      `${process.env.NEXT_PUBLIC_API_URL}/api/v1/reports/${id}/generate-pdf`,\n      {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      }\n    );\n    return response.blob();\n  },\n\n  async schedule(\n    id: string,\n    schedule: Omit<ReportSchedule, 'id' | 'reportId'>\n  ): Promise<ReportSchedule> {\n    // Connect to FastAPI backend: POST /api/v1/reports/{id}/schedule\n    // TODO: Backend endpoint not implemented yet\n    return apiClient.post<ReportSchedule>(`/api/v1/reports/${id}/schedule`, schedule);\n  },\n};", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2054, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9d094e7f-e856-4dad-8e7d-93e2cd07aa6a": {"__data__": {"id_": "9d094e7f-e856-4dad-8e7d-93e2cd07aa6a", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\store\\auth.ts", "language": "typescript", "lines": 149, "filename": "auth.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "20e450e3-0323-4181-8acb-11ffb5b2e030", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\store\\auth.ts", "language": "typescript", "lines": 149, "filename": "auth.ts"}, "hash": "e0012a8f4c6a1e31dc7bac9617c777097e67d5638e422c9bee5b2bd02ec67d9f", "class_name": "RelatedNodeInfo"}, "3": {"node_id": "12f92ccc-5547-4af8-adbc-4d65ce9da93b", "node_type": "1", "metadata": {}, "hash": "80e79468bbba76938dd075e01579705d8fb05a8b18c39a929ed8621bbc5794b9", "class_name": "RelatedNodeInfo"}}, "text": "import { createSignal, createRoot } from 'solid-js';\nimport api from '@/lib/api';\n\nexport interface User {\n  username: string;\n  role: string;\n  email: string;\n  allowed_segments: string[];\n}\n\nfunction createAuthStore() {\n  const [user, setUser] = createSignal<User | null>(null);\n  const [token, setToken] = createSignal<string | null>(null);\n  const [isAuthenticated, setIsAuthenticated] = createSignal<boolean>(false);\n  const [loading, setLoading] = createSignal<boolean>(false);\n  const [error, setError] = createSignal<string | null>(null);\n\n  // Fun\u00e7\u00e3o para validar e decodificar token\n  const validateAndDecodeToken = (tokenString: string): any | null => {\n    try {\n      // Verificar formato JWT (deve ter 3 partes separadas por .)\n      const parts = tokenString.split('.');\n      if (parts.length !== 3) {\n        console.error('\u274c Token inv\u00e1lido: formato incorreto');\n        return null;\n      }\n\n      // Decodificar payload\n      const payload = JSON.parse(atob(parts[1]));\n\n      // Verificar expira\u00e7\u00e3o\n      if (payload.exp) {\n        const now = Math.floor(Date.now() / 1000);\n        if (payload.exp < now) {\n          console.error('\u274c Token expirado');\n          return null;\n        }\n      }\n\n      return payload;\n    } catch (e) {\n      console.error('\u274c Erro ao validar token:', e);\n      return null;\n    }\n  };\n\n  // Restaurar user do token ao inicializar (com prote\u00e7\u00e3o para SSR)\n  const initializeAuth = () => {\n    try {\n      if (typeof window === 'undefined' || !window.localStorage) {\n        return;\n      }\n      \n      const initToken = localStorage.getItem('token');\n      if (initToken) {\n        const payload = validateAndDecodeToken(initToken);\n        \n        // Verifica\u00e7\u00e3o ESTRITA: Se o payload for nulo ou token expirado, limpar TUDO.\n        if (payload) {\n          const userData: User = {\n            username: payload.username || payload.sub || 'user',\n            role: payload.role || 'user',\n            email: payload.email || `${payload.username || payload.sub}@agentbi.com`,\n            allowed_segments: payload.allowed_segments || []\n          };\n          setUser(userData);\n          setToken(initToken);\n          setIsAuthenticated(true);\n          console.log('\ud83d\udd04 Sess\u00e3o restaurada com sucesso.');\n        } else {\n          // Token inv\u00e1lido, malformado ou expirado -> Logout for\u00e7ado imediato\n          console.warn('\u26a0\ufe0f Token inv\u00e1lido detectado na inicializa\u00e7\u00e3o - Limpando sess\u00e3o.');\n          localStorage.removeItem('token');\n          setIsAuthenticated(false);\n          setUser(null);\n          setToken(null);\n          // Opcional: Redirecionar se estiver numa rota protegida \u00e9 responsabilidade do Router,\n          // mas garantir o estado limpo previne o acesso visual indevido.\n        }\n      }\n    } catch (error) {\n      console.error('\u274c Erro cr\u00edtico ao inicializar autentica\u00e7\u00e3o:', error);\n      localStorage.removeItem('token');\n      setIsAuthenticated(false);\n    }\n  };\n\n  // Executar inicializa\u00e7\u00e3o\n  initializeAuth();\n\n  const login = async (username: string, password: string): Promise<boolean> => {\n    setLoading(true);\n    setError(null);\n    try {\n      // Endpoint correto do FastAPI (/auth/login -> recebe LoginRequest JSON)\n      const response = await api.post('/auth/login', { username, password });\n\n      const { access_token } = response.data;\n\n      if (access_token) {\n        // Validar token antes de salvar\n        const payload = validateAndDecodeToken(access_token);\n\n        if (!payload) {\n          setError(\"Token inv\u00e1lido recebido do servidor\");\n          return false;\n        }\n\n        localStorage.setItem('token', access_token);\n        setToken(access_token);\n        setIsAuthenticated(true);\n\n        // Definir dados do usu\u00e1rio baseado no payload do JWT\n        const userData: User = {\n          username: payload.username || payload.sub || username,\n          role: payload.role || 'user',\n          email: payload.email || `${payload.username || username}@agentbi.com`,\n          allowed_segments: payload.allowed_segments || []\n        };\n\n        console.log('\u2705 Login successful.", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 4098, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "12f92ccc-5547-4af8-adbc-4d65ce9da93b": {"__data__": {"id_": "12f92ccc-5547-4af8-adbc-4d65ce9da93b", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\store\\auth.ts", "language": "typescript", "lines": 149, "filename": "auth.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "20e450e3-0323-4181-8acb-11ffb5b2e030", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\store\\auth.ts", "language": "typescript", "lines": 149, "filename": "auth.ts"}, "hash": "e0012a8f4c6a1e31dc7bac9617c777097e67d5638e422c9bee5b2bd02ec67d9f", "class_name": "RelatedNodeInfo"}, "2": {"node_id": "9d094e7f-e856-4dad-8e7d-93e2cd07aa6a", "node_type": "1", "metadata": {"file_path": "frontend-solid\\src\\store\\auth.ts", "language": "typescript", "lines": 149, "filename": "auth.ts"}, "hash": "f3c13d9fe648288fd2c135886ffb11946edfa7d83d5267309c59bbfc23d971a1", "class_name": "RelatedNodeInfo"}}, "text": "User:', userData);\n        setUser(userData);\n\n        return true;\n      }\n      return false;\n    } catch (err: any) {\n      console.error(\"\u274c Login error:\", err);\n      const errorMsg = err.response?.data?.detail || \"Erro ao realizar login\";\n      setError(errorMsg);\n      return false;\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const logout = () => {\n    localStorage.removeItem('token');\n    setToken(null);\n    setUser(null);\n    setIsAuthenticated(false);\n    window.location.href = '/login';\n  };\n\n  return { user, token, isAuthenticated, login, logout, loading, error };\n}\n\nexport default createRoot(createAuthStore);", "mimetype": "text/plain", "start_char_idx": 4099, "end_char_idx": 4738, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "9e08a145-ecff-46a2-b2a8-bfd51fa88d92": {"__data__": {"id_": "9e08a145-ecff-46a2-b2a8-bfd51fa88d92", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\store\\dashboard.ts", "language": "typescript", "lines": 85, "filename": "dashboard.ts"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "d3e82f6b-64a9-4daf-9f0e-b6a3326b7a07", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\store\\dashboard.ts", "language": "typescript", "lines": 85, "filename": "dashboard.ts"}, "hash": "3961f5d91ad50d81104d563160c84fb5148f0919104d9c73e44753acd9ed2a08", "class_name": "RelatedNodeInfo"}}, "text": "import { createRoot, batch, createEffect } from 'solid-js';\nimport { createStore } from 'solid-js/store';\nimport { analyticsApi, KpiMetrics, TopQueryItem } from '@/lib/api';\n\ninterface DashboardState {\n  // Grid Data\n  data: TopQueryItem[]; // Now uses TopQueryItem\n  \n  // KPI Data\n  summary: KpiMetrics | null; // Now uses KpiMetrics\n  \n  // System State\n  isLoading: boolean;\n  error: string | null;\n  lastUpdate: Date | null;\n  isLive: boolean; // Controle do polling\n}\n\nfunction createDashboardStore() {\n  const [state, setState] = createStore<DashboardState>({\n    data: [],\n    summary: null,\n    isLoading: false,\n    error: null,\n    lastUpdate: null,\n    isLive: true\n  });\n\n  let intervalId: number;\n\n  const fetchData = async () => {\n    if (!state.data.length) setState('isLoading', true); // S\u00f3 mostra loading no primeiro load\n    \n    try {\n      // Buscar dados em paralelo dos novos endpoints\n      const [kpisRes, topQueriesRes] = await Promise.all([\n        analyticsApi.getKpis(),\n        analyticsApi.getTopQueries(7, 10) // Top 10 queries dos \u00faltimos 7 dias para a grid\n      ]);\n\n      batch(() => {\n        setState('summary', kpisRes.data); // KpiMetrics\n        setState('data', topQueriesRes.data); // TopQueryItem[]\n        setState('lastUpdate', new Date());\n        setState('error', null);\n        setState('isLoading', false);\n      });\n    } catch (err) {\n      console.error(\"Dashboard fetch error:\", err);\n      setState('error', \"Falha ao atualizar dados.\");\n      setState('isLoading', false);\n      // Se falhar, para o polling para n\u00e3o floodar erros\n      stopPolling(); \n    }\n  };\n\n  const startPolling = () => {\n    fetchData(); // Busca imediata\n    if (intervalId) clearInterval(intervalId);\n    intervalId = setInterval(fetchData, 5000); // Atualiza a cada 5s\n    setState('isLive', true);\n  };\n\n  const stopPolling = () => {\n    clearInterval(intervalId);\n    setState('isLive', false);\n  };\n\n  const togglePolling = () => {\n    if (state.isLive) stopPolling();\n    else startPolling();\n  };\n\n  // Iniciar polling automaticamente apenas se estiver logado (verifica\u00e7\u00e3o feita na view)\n  createEffect(() => {\n    const token = localStorage.getItem('token');\n    if (token && !state.isLive) {\n        startPolling();\n    }\n  });\n  \n  return { state, startPolling, stopPolling, togglePolling, fetchData };\n}\n\nexport default createRoot(createDashboardStore);", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 2398, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "e9169eee-a568-4bf6-898a-bcb54c631d9c": {"__data__": {"id_": "e9169eee-a568-4bf6-898a-bcb54c631d9c", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\__tests__\\App.test.tsx", "language": "typescript", "lines": 29, "filename": "App.test.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "abb2a4d6-5bbe-4b35-bfe8-49d1e9a79a06", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\__tests__\\App.test.tsx", "language": "typescript", "lines": 29, "filename": "App.test.tsx"}, "hash": "56da6040361912473035b5cf372abb658b569d9a63b7ebcbf5a863ff9d6e22c1", "class_name": "RelatedNodeInfo"}}, "text": "import { render, screen } from '@solidjs/testing-library';\nimport { describe, it, expect, beforeEach } from 'vitest';\nimport { Router, Route } from '@solidjs/router';\nimport Login from '../pages/Login';\nimport Dashboard from '../pages/Dashboard';\nimport Chat from '../pages/Chat';\n\ndescribe('App Component Tests', () => {\n  beforeEach(() => {\n    // Limpar localStorage antes de cada teste\n    localStorage.clear();\n  });\n\n  it('should render Login page', () => {\n    const { container } = render(() => (\n      <Router>\n        <Route path=\"/login\" component={Login} />\n      </Router>\n    ));\n\n    expect(container).toBeDefined();\n  });\n\n  it('should have root element in HTML', () => {\n    const root = document.getElementById('root');\n    expect(root).toBeDefined();\n  });\n});", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 779, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "89532045-3266-4a4b-a55b-f7c304e4e68e": {"__data__": {"id_": "89532045-3266-4a4b-a55b-f7c304e4e68e", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\__tests__\\ErrorBoundary.test.tsx", "language": "typescript", "lines": 30, "filename": "ErrorBoundary.test.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "3eece43e-f014-437e-b56e-5a4573b463e8", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\__tests__\\ErrorBoundary.test.tsx", "language": "typescript", "lines": 30, "filename": "ErrorBoundary.test.tsx"}, "hash": "eec17607180cb668e56c25aaf9f095d149e92e1d0fbcd0719c971042ab176ace", "class_name": "RelatedNodeInfo"}}, "text": "import { render } from '@solidjs/testing-library';\nimport { describe, it, expect } from 'vitest';\nimport { ErrorBoundary } from '../components/ErrorBoundary';\n\ndescribe('ErrorBoundary Component', () => {\n  it('should render children when no error', () => {\n    const { container } = render(() => (\n      <ErrorBoundary>\n        <div>Test Content</div>\n      </ErrorBoundary>\n    ));\n\n    expect(container.textContent).toContain('Test Content');\n  });\n\n  it('should render error message when error occurs', () => {\n    const ThrowError = () => {\n      throw new Error('Test error');\n    };\n\n    const { container } = render(() => (\n      <ErrorBoundary>\n        <ThrowError />\n      </ErrorBoundary>\n    ));\n\n    expect(container.textContent).toContain('Ops! Algo deu errado');\n  });\n});", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 786, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}, "372151b0-0514-4202-ab5a-c932424ae73f": {"__data__": {"id_": "372151b0-0514-4202-ab5a-c932424ae73f", "embedding": null, "metadata": {"file_path": "frontend-solid\\src\\__tests__\\Layout.test.tsx", "language": "typescript", "lines": 36, "filename": "Layout.test.tsx"}, "excluded_embed_metadata_keys": [], "excluded_llm_metadata_keys": [], "relationships": {"1": {"node_id": "f0d783f3-b717-486f-8c6f-57d61a800f51", "node_type": "4", "metadata": {"file_path": "frontend-solid\\src\\__tests__\\Layout.test.tsx", "language": "typescript", "lines": 36, "filename": "Layout.test.tsx"}, "hash": "cda94762fb6bd06ea162febf3ceec654fcee63d3dfa5dbf61e387a132c0a4fd0", "class_name": "RelatedNodeInfo"}}, "text": "import { render } from '@solidjs/testing-library';\nimport { describe, it, expect, beforeEach } from 'vitest';\nimport { Router } from '@solidjs/router';\nimport Layout from '../Layout';\n\ndescribe('Layout Component', () => {\n  beforeEach(() => {\n    localStorage.clear();\n  });\n\n  it('should render Layout component', () => {\n    const { container } = render(() => (\n      <Router>\n        <Layout>\n          <div>Test Content</div>\n        </Layout>\n      </Router>\n    ));\n\n    expect(container).toBeDefined();\n  });\n\n  it('should display Agent BI branding', () => {\n    const { container } = render(() => (\n      <Router>\n        <Layout>\n          <div>Test Content</div>\n        </Layout>\n      </Router>\n    ));\n\n    const text = container.textContent;\n    expect(text).toContain('Agent BI');\n  });\n});", "mimetype": "text/plain", "start_char_idx": 0, "end_char_idx": 805, "text_template": "{metadata_str}\n\n{content}", "metadata_template": "{key}: {value}", "metadata_seperator": "\n", "class_name": "TextNode"}, "__type__": "1"}}, "docstore/ref_doc_info": {"452719e6-dc5a-416a-9ae6-a31e8aae46ba": {"node_ids": ["d5245b86-deea-467b-8bc4-d06f0f93600a", "b6aaa604-b321-44c0-b94e-6d971a9a05ce", "6012402e-cfd1-4624-8707-b6db0934cd2a", "9d99c789-7d43-49d8-99fe-5e2304104d65"], "metadata": {"file_path": "backend\\app\\api\\dependencies.py", "language": "python", "lines": 506, "filename": "dependencies.py"}}, "7cbc0a2a-c981-4ec1-9ded-920d0241dca9": {"node_ids": ["a60245b5-dda1-43c4-99c6-446b53ab7715"], "metadata": {"file_path": "backend\\app\\api\\v1\\router.py", "language": "python", "lines": 56, "filename": "router.py"}}, "7f15b7b9-b758-45da-b7ec-44ebbf180a5b": {"node_ids": ["7c889e8d-7602-4c65-a1f6-8c2efb84d7c1", "03c522f2-b9d8-4d0c-bb95-a7ef7ec72d8b", "8de27ec6-8134-42e7-89dd-779c6db6e619", "f50e232b-61d0-4c57-91d7-b74912380f3b"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\admin.py", "language": "python", "lines": 380, "filename": "admin.py"}}, "649e0877-ef07-4eb4-9757-d99a3e142954": {"node_ids": ["396030fe-a5dd-4e15-8aa3-6aeed81a3b75", "add62210-a42c-4e5c-a8fb-7b87d6dbb70d", "734b4d07-8097-48ca-8ff1-13de33d4f81b", "80e94cb7-d8ff-44cb-a2c7-4511e7b39620"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\analytics.py", "language": "python", "lines": 280, "filename": "analytics.py"}}, "0a32108a-a19e-45c5-b967-ea3496ec4151": {"node_ids": ["95550363-55fe-4a5f-af0d-df0dbd90a656", "6037fc0c-32ba-4765-bd2a-f29669d6fb10", "9779d1c5-856d-497c-8c52-ed337d288f95"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth.py", "language": "python", "lines": 207, "filename": "auth.py"}}, "4ba513da-8176-4c46-bd36-559b7325ea0d": {"node_ids": ["33ae3e09-337c-43f8-80f5-a159d9de582a"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\auth_alt.py", "language": "python", "lines": 121, "filename": "auth_alt.py"}}, "8af8abd0-43ad-4548-a883-60adf617a50d": {"node_ids": ["171f1fb8-9973-43f4-8978-0d0707a6fbd1", "b35ed1c8-d20a-4a01-b17b-3ef33c4fb3ce", "50a71ecb-7625-41c3-ade1-d13c50f73a86", "d0884373-d5ad-4f15-a62f-da1f9d32c644", "b7bc953d-1b23-4fe4-a98e-87ade49f0703", "43cf191f-b8b6-4323-912d-4c284c744c33"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\chat.py", "language": "python", "lines": 436, "filename": "chat.py"}}, "5ca13317-56ef-4cc7-a3e1-f36ea4ca2bde": {"node_ids": ["742945ba-e49d-4739-ac7e-5d7945c50cad"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\code_chat.py", "language": "python", "lines": 152, "filename": "code_chat.py"}}, "17a12e9c-7800-4beb-a313-7223d929da87": {"node_ids": ["8e76522d-e12e-46ef-acc3-9739478eb40f", "f35d8c0a-53e9-41ad-9efd-becad964365b"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\diagnostics.py", "language": "python", "lines": 198, "filename": "diagnostics.py"}}, "944a7045-eba3-42ba-965c-db2f535de128": {"node_ids": ["5bdbff67-4aa1-474f-95ab-1d46aae2d53c", "8ac87245-c104-494d-be22-a6f4d546e701"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\frontend_logs.py", "language": "python", "lines": 158, "filename": "frontend_logs.py"}}, "f2512cca-0fa6-4443-9d1e-eb8176920f61": {"node_ids": ["b1cce014-3941-4704-af62-0cab5b47d067", "a999c9a4-a501-4e77-9c79-9596845f7ee9"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\health.py", "language": "python", "lines": 259, "filename": "health.py"}}, "72841d28-ba1e-424e-8023-0b0823df9ec7": {"node_ids": ["ccf3741c-0516-4935-9b58-4fc16b9a7e51", "f6b4085c-3566-4d79-aa58-7a1a19224e03", "2b478a8e-acf3-4a6d-8b69-6302116cf8c5"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\insights.py", "language": "python", "lines": 295, "filename": "insights.py"}}, "f3febc04-20fc-4651-ae44-daff4cc5bc74": {"node_ids": ["200605a2-e22f-4d5f-bb17-54a23e5c9bc5", "54b35d02-b86f-4728-b9a5-6ed497eb34c6", "ca7c4fcd-d9f0-4e3d-b7ba-77f293e98f51"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\learning.py", "language": "python", "lines": 272, "filename": "learning.py"}}, "791fa0a1-ef16-43b3-ae0f-6ce91fcd3982": {"node_ids": ["22b1eef8-3929-4630-842e-944d97e9783b", "5cdea29c-ef99-4bde-9c45-1110c60751f8", "da8e0de4-6c84-433d-9761-5fa03409fc45", "c75d44c6-e84e-4055-b2c2-ea848ef62786"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\metrics.py", "language": "python", "lines": 324, "filename": "metrics.py"}}, "b1685fa9-c29e-4648-82a8-da69110af002": {"node_ids": ["7ee3a314-1989-40aa-9b96-c8b9f1411aac", "cf828070-2cc0-4677-8b1c-534450c5d950"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\playground.py", "language": "python", "lines": 169, "filename": "playground.py"}}, "2d22952b-f353-4fd8-91db-1b3ffbccbbb3": {"node_ids": ["4b2d4ff8-9492-471a-8cb4-40d2a0458932", "8de11b9f-7516-4ded-9fb5-57391e7ac8f4"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\preferences.py", "language": "python", "lines": 286, "filename": "preferences.py"}}, "47ef942d-4e7c-4b8b-a31f-63bb4a87272a": {"node_ids": ["17f16b38-aaa9-4de5-83ad-77f09595413f", "00ea1eb8-e391-4f88-a6b4-bc537d8adfd5"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\reports.py", "language": "python", "lines": 218, "filename": "reports.py"}}, "623d9f4c-a409-45f9-b87f-6f7ddaecbd9b": {"node_ids": ["29814bdc-fb4d-4666-b1fb-d625c107489b", "64b44d21-bae1-44b6-9acc-2844af51070d", "17dde553-57f8-4e81-bc21-28d6d7f2e6b2"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\rupturas.py", "language": "python", "lines": 193, "filename": "rupturas.py"}}, "c837571e-9916-40cf-a47b-c5a6832b4b0d": {"node_ids": ["1317761a-85a1-4422-98a7-177ddcec1deb", "f17949ff-8dc0-43a6-a5fd-be34a19c1986"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\shared.py", "language": "python", "lines": 196, "filename": "shared.py"}}, "72fb99a6-8254-4f90-ac5c-2d76702d3626": {"node_ids": ["eb77c6a5-bf54-4737-b5e1-fcaa0e7c80e4"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\test.py", "language": "python", "lines": 15, "filename": "test.py"}}, "d080b56a-f7e8-4d10-b673-9ee7aa103a05": {"node_ids": ["42f48b85-8954-4feb-9189-4a8bfee0bffc", "34212621-39e3-4f0f-ade3-80a21c90d91d", "bad13939-b66b-41a4-b23c-be9e111d63aa", "57558293-7012-4cd5-9821-426c725f239c", "722b9ab4-79da-44a4-aeab-10320524d0dc", "88109f45-e2b0-4f63-a34d-6ed6caf26347"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\transfers.py", "language": "python", "lines": 419, "filename": "transfers.py"}}, "21ef2447-58b3-4267-bab6-cba51b47d579": {"node_ids": ["5b9134af-6e70-4c3b-bb7c-3b85f7cc582e"], "metadata": {"file_path": "backend\\app\\api\\v1\\endpoints\\__init__.py", "language": "python", "lines": 6, "filename": "__init__.py"}}, "084d2857-7398-4172-8425-2506e020917f": {"node_ids": ["42bae144-5f37-4d0a-8c47-4c8048783e3f"], "metadata": {"file_path": "backend\\app\\config\\database.py", "language": "python", "lines": 84, "filename": "database.py"}}, "edce654c-e12f-4d0c-bcc7-59aab2d88ea2": {"node_ids": ["93ce8a20-cb88-48c8-9c32-d44d1961ecfd"], "metadata": {"file_path": "backend\\app\\config\\logging_config.py", "language": "python", "lines": 87, "filename": "logging_config.py"}}, "59eaab45-a46c-4d8a-b4ff-139c9d0e67b6": {"node_ids": ["48991ca9-cef0-4390-9e73-61914c996054"], "metadata": {"file_path": "backend\\app\\config\\security.py", "language": "python", "lines": 82, "filename": "security.py"}}, "0fd13993-78dc-4353-ae98-f0fb5771d168": {"node_ids": ["4aa593d9-a568-4d1d-9e7d-e872d4f3dde4", "d7ad1a6d-e33b-462e-ab0e-5da36caf341c", "05ec67e9-4a1d-47ec-a457-aa3b38fb672d"], "metadata": {"file_path": "backend\\app\\config\\settings.py", "language": "python", "lines": 199, "filename": "settings.py"}}, "75d843d1-6d07-4f24-a0ee-153f1af4f10b": {"node_ids": ["f4387d1e-a498-4bd7-af9f-a3a9da8ce936"], "metadata": {"file_path": "backend\\app\\core\\agent_state.py", "language": "python", "lines": 35, "filename": "agent_state.py"}}, "9699f80e-72da-4d28-bd0e-7db183ca235e": {"node_ids": ["94f03584-1f19-4277-a1b5-672c0747ca84"], "metadata": {"file_path": "backend\\app\\core\\agent_wrapper.py", "language": "python", "lines": 75, "filename": "agent_wrapper.py"}}, "71e2a82f-ad00-4dbc-b526-5e625a8cda43": {"node_ids": ["2947d14b-4d6d-45e6-bae6-b23b37acb71c", "92de65ea-3b96-49e8-baac-12ca5dd8b114", "264c50e3-8a9c-40d6-9cc7-8f3371b892c4"], "metadata": {"file_path": "backend\\app\\core\\auth_service.py", "language": "python", "lines": 287, "filename": "auth_service.py"}}, "6c29441d-7bfb-4e17-9db3-ff323cc3190f": {"node_ids": ["b62f3379-75be-4f9d-8d2f-8e01c77951e1", "ac0b5851-a26c-40a7-a402-278a6b79a1d6"], "metadata": {"file_path": "backend\\app\\core\\cache.py", "language": "python", "lines": 197, "filename": "cache.py"}}, "b9752c92-923b-4765-9c3d-96f24e84b361": {"node_ids": ["b1a38a09-07e4-427b-ba62-3532f4b60028", "d44890db-634d-4ebb-abe7-78bfd1a10699"], "metadata": {"file_path": "backend\\app\\core\\code_rag_service.py", "language": "python", "lines": 260, "filename": "code_rag_service.py"}}, "0193b7c7-e67f-417d-8040-a3fefaca9ec4": {"node_ids": ["cac91c07-25e4-4b76-a17a-06d1e3e94bfb", "bc42ea72-fed3-466e-b723-06a5c83c0faa"], "metadata": {"file_path": "backend\\app\\core\\data_scope_service.py", "language": "python", "lines": 170, "filename": "data_scope_service.py"}}, "3a8e2b95-be73-4d30-8f12-4e89059b933c": {"node_ids": ["efebbe32-1f4f-48e1-a6b6-198bfd6bcea7", "c04f0a5e-495a-48e7-88b9-1193615324a6", "0c54ea1d-3352-436d-971b-71cb8704e65c"], "metadata": {"file_path": "backend\\app\\core\\data_source_manager.py", "language": "python", "lines": 219, "filename": "data_source_manager.py"}}, "2530a1a9-9ec3-4099-bf86-38f40a7eb25c": {"node_ids": ["de8878da-bd2d-4383-8336-0ca7e1728788", "22f82111-098f-4b48-985a-3ac462e23867"], "metadata": {"file_path": "backend\\app\\core\\intelligent_chatbi.py", "language": "python", "lines": 195, "filename": "intelligent_chatbi.py"}}, "e1cfddfb-e17a-4220-bd6c-f967d79dee9e": {"node_ids": ["df95e599-fb71-4d88-abf6-56bfc8ecdbe6"], "metadata": {"file_path": "backend\\app\\core\\llm_base.py", "language": "python", "lines": 8, "filename": "llm_base.py"}}, "b16bfb58-d366-4669-958d-c5e47f69298f": {"node_ids": ["167442e8-7ba7-43bc-b6ae-1ca478000af3"], "metadata": {"file_path": "backend\\app\\core\\llm_factory.py", "language": "python", "lines": 88, "filename": "llm_factory.py"}}, "1ecb7f8c-c239-4df3-ae82-87934e1785c0": {"node_ids": ["15d58a4e-22de-48c3-a4ce-9eb21f734860", "a9eba842-e393-4fe3-91f8-e9c752d2f3f9", "c5761b68-d681-495b-bb0f-492ba17cc04d", "5b65a6a5-9d8f-4318-b0cf-c8044729cc9f"], "metadata": {"file_path": "backend\\app\\core\\llm_gemini_adapter.py", "language": "python", "lines": 352, "filename": "llm_gemini_adapter.py"}}, "d219add8-5278-4d44-9b97-73c57038c907": {"node_ids": ["3c1998cd-03cc-43eb-ba3b-352de9c77dec", "58cde054-7542-4884-b924-0ef174006528", "5c354231-7c0a-4949-a736-05d64b95f295"], "metadata": {"file_path": "backend\\app\\core\\llm_langchain_adapter.py", "language": "python", "lines": 294, "filename": "llm_langchain_adapter.py"}}, "ed2689ba-d0c1-4c1a-8f3c-a83131b7b4c8": {"node_ids": ["2b13ff52-7436-4cdc-917e-9f373f0bd070", "51e52a81-64a3-4952-bd21-6d2837b42860", "8fa2d30a-64d6-4ca9-ae85-29ac05dc7189", "567182dd-c3fa-4aee-8d59-d04b12f43a0f"], "metadata": {"file_path": "backend\\app\\core\\logging_config.py", "language": "python", "lines": 477, "filename": "logging_config.py"}}, "6b927665-04e0-4bc1-859c-44b86808361c": {"node_ids": ["76f6aa2f-759a-49df-b79b-4d6f82738653", "4d477748-3e63-4f44-8ef4-2fad1938f8fd", "f9c8d3ae-dcb5-4d7b-af46-16b9f50b7142"], "metadata": {"file_path": "backend\\app\\core\\logging_middleware.py", "language": "python", "lines": 302, "filename": "logging_middleware.py"}}, "4c40bf77-29a3-48b9-b9bc-79cd209fb5f4": {"node_ids": ["d3ea2e15-f174-4527-8ae5-8a34d7ae1537"], "metadata": {"file_path": "backend\\app\\core\\parquet_cache.py", "language": "python", "lines": 128, "filename": "parquet_cache.py"}}, "04b40021-cc7f-49d7-bb90-87432bdc7a01": {"node_ids": ["b3aa4d10-1fc0-42d6-8ff2-de40de46cc2d", "bfe8d8e3-64ce-4474-802f-481be7b5cc94"], "metadata": {"file_path": "backend\\app\\core\\query_processor.py", "language": "python", "lines": 151, "filename": "query_processor.py"}}, "be0abac0-92fb-4ffe-a151-21b167412d07": {"node_ids": ["9fd7eb40-4c95-4ce0-8378-662783b2a6be", "1c5975d5-6841-488c-acf9-45ffe90a459a", "f2b4495d-6e0c-4952-9caf-e3e19346851b", "e374470f-9d2b-40cf-a3b9-2651e45b0f6f"], "metadata": {"file_path": "backend\\app\\core\\robust_chatbi.py", "language": "python", "lines": 318, "filename": "robust_chatbi.py"}}, "ac7bab28-7528-4223-a181-bed58104082a": {"node_ids": ["f30d135c-7467-405f-a43d-087fc1228037"], "metadata": {"file_path": "backend\\app\\core\\supabase_client.py", "language": "python", "lines": 43, "filename": "supabase_client.py"}}, "dd97e852-7b38-4daa-be9d-72ada2ff60b2": {"node_ids": ["27878837-c577-4918-a1a0-ae0b1c53f684", "e09a5fcb-253b-428d-b7e8-ce79cbf364b1", "626f1f51-9933-47e3-9fa2-c10549066ebc"], "metadata": {"file_path": "backend\\app\\core\\supabase_user_service.py", "language": "python", "lines": 310, "filename": "supabase_user_service.py"}}, "68f3d29c-e880-4c5d-b040-652e5acb68ab": {"node_ids": ["4eb326b6-06aa-47ee-85ff-a0674a43884d"], "metadata": {"file_path": "backend\\app\\core\\sync_service.py", "language": "python", "lines": 94, "filename": "sync_service.py"}}, "fb9ac0a9-3b54-4c48-bc50-cc8d37ad2ea4": {"node_ids": ["12ecfd74-3f96-4b37-b3a5-c3fa66471573"], "metadata": {"file_path": "backend\\app\\core\\agents\\base_agent.py", "language": "python", "lines": 106, "filename": "base_agent.py"}}, "58334eb2-4abf-4aa9-a68e-ee1ce63aa522": {"node_ids": ["6b9890fc-b5b4-464d-801a-8a2fbccb9a12", "ccaa2fcb-7363-46cd-a5d7-554b8c45fd0c", "e3e34443-694a-407b-a57f-003f4d782a19", "58d9708f-89f0-4230-83c2-f5c6321f56ec", "d95d6df5-7def-4c8c-92b8-ad0582f6b116", "8f47418a-0c22-4298-8f96-79bf36a6d497", "8545ec01-1c13-474f-b6f7-371094ed312c"], "metadata": {"file_path": "backend\\app\\core\\agents\\caculinha_bi_agent.py", "language": "python", "lines": 466, "filename": "caculinha_bi_agent.py"}}, "4bd6c109-ea92-48d9-ae98-0e3fd54f975e": {"node_ids": ["535c9687-23e6-409c-81b6-1edc7e352359", "50618e85-2f28-416a-a626-75e4abfa9cb5", "1bf98a6c-83fe-48ef-a922-2c9d16bab0a0", "0cad90a1-8971-4dc4-8525-49497c5c056c", "1a339394-03b9-4eaa-aa2a-99098db55e70"], "metadata": {"file_path": "backend\\app\\core\\agents\\code_gen_agent.py", "language": "python", "lines": 317, "filename": "code_gen_agent.py"}}, "75482dc6-110f-4a7f-8d2f-1c589e68b7bc": {"node_ids": ["5127c329-e747-4dc5-8f80-1e58a35e23c1"], "metadata": {"file_path": "backend\\app\\core\\agents\\developer_agent.py", "language": "python", "lines": 136, "filename": "developer_agent.py"}}, "fcd06331-492d-4004-ab85-d4b1e3e04703": {"node_ids": ["ad269d0b-e7f4-4fb0-bb45-6a4ac0a5948e", "ff59811a-ee14-4f10-ace0-837a6996dd9b", "46f3da86-a853-4441-8736-a97500e059f0"], "metadata": {"file_path": "backend\\app\\core\\agents\\multi_step_agent.py", "language": "python", "lines": 275, "filename": "multi_step_agent.py"}}, "a27465cd-c293-41cf-ae48-ed9ca95cc6a2": {"node_ids": ["823b5796-edeb-42a2-8c24-8feb053f334d", "c57a51d6-8a13-4baf-9072-2e0d2e4db110", "3ad8de8b-b3d1-45e1-b423-c856fafe9847", "11967f22-2cab-4d85-9f54-c852913550d4"], "metadata": {"file_path": "backend\\app\\core\\agents\\product_agent.py", "language": "python", "lines": 368, "filename": "product_agent.py"}}, "b65bfe97-58eb-4f1f-a892-b4c8529c9a4f": {"node_ids": ["e642a20e-246b-4b7d-9757-a2ff8e038035", "55b70490-8214-4461-86ab-cde65dbcadb0"], "metadata": {"file_path": "backend\\app\\core\\agents\\prompt_loader.py", "language": "python", "lines": 133, "filename": "prompt_loader.py"}}, "f0d803cd-f7cb-41b5-914f-0654ff3d9c82": {"node_ids": ["fdbc0e1e-b676-492a-b459-42daafbc0a7d"], "metadata": {"file_path": "backend\\app\\core\\agents\\supervisor_agent.py", "language": "python", "lines": 138, "filename": "supervisor_agent.py"}}, "f2b37f08-3fe3-486d-a728-766ddc4cc726": {"node_ids": ["972f3990-9ccf-4752-b552-ba9ccbafd109", "050a525a-f23a-4688-8913-5a17779de7fd"], "metadata": {"file_path": "backend\\app\\core\\agents\\tool_agent.py", "language": "python", "lines": 201, "filename": "tool_agent.py"}}, "bf436449-e80d-4d33-8a50-2369d1168551": {"node_ids": ["617adbe4-bcf3-474f-8127-39ace2089116"], "metadata": {"file_path": "backend\\app\\core\\agents\\__init__.py", "language": "python", "lines": 8, "filename": "__init__.py"}}, "f6091f5f-3b99-46bc-92d6-4407be75b727": {"node_ids": ["37f3c8ee-5bbe-4106-99d3-7cdf058987d7"], "metadata": {"file_path": "backend\\app\\core\\factory\\component_factory.py", "language": "python", "lines": 55, "filename": "component_factory.py"}}, "a8f93518-1344-4ff9-a3fa-16c577e1d2e8": {"node_ids": ["dff6d655-ec3f-479e-a0ea-f53763cf55f1"], "metadata": {"file_path": "backend\\app\\core\\factory\\__init__.py", "language": "python", "lines": 2, "filename": "__init__.py"}}, "555a4cf3-84d5-473f-a79f-3acd00d6f038": {"node_ids": ["6d5b7b65-0a70-43ed-9b64-b29a0205da64"], "metadata": {"file_path": "backend\\app\\core\\graph\\agent.py", "language": "python", "lines": 91, "filename": "agent.py"}}, "9199cb99-33f3-48d1-8f7b-dd1b4d41d5d1": {"node_ids": ["c731a862-e010-46dc-8ca5-4e60b1ac5517"], "metadata": {"file_path": "backend\\app\\core\\graph\\__init__.py", "language": "python", "lines": 18, "filename": "__init__.py"}}, "d7cf21b9-e632-40ea-870a-c7c33b2a5597": {"node_ids": ["1064f8fb-3498-4645-bb85-d46d125136ea", "d5092611-1baa-4ecc-bf8d-eb17bbdf8949", "e382f51c-15c8-4c2d-aa7a-067581695b2c"], "metadata": {"file_path": "backend\\app\\core\\learning\\feedback_system.py", "language": "python", "lines": 248, "filename": "feedback_system.py"}}, "b5bc249e-f558-434e-9e1e-df01ebb123d3": {"node_ids": ["ff75761f-a5f1-4685-ad50-90a893ec4994"], "metadata": {"file_path": "backend\\app\\core\\learning\\pattern_matcher.py", "language": "python", "lines": 63, "filename": "pattern_matcher.py"}}, "ec80adb7-1e19-42e1-9c9e-c72304ded225": {"node_ids": ["dff5c957-ba3f-44e6-8018-5af35e4eafe4", "3bd1e46c-05fb-4f98-bca9-226da59d6864", "e78781fc-1da8-45ff-9e43-3a2ffcc0b9c9"], "metadata": {"file_path": "backend\\app\\core\\monitoring\\metrics_dashboard.py", "language": "python", "lines": 183, "filename": "metrics_dashboard.py"}}, "4ba162b9-7119-44ec-bf12-36b4df557b4a": {"node_ids": ["0e51e622-5281-4ed5-9e7c-ee256b0cd870", "80109394-815e-4d0d-9fac-b996bb32bf87"], "metadata": {"file_path": "backend\\app\\core\\rag\\example_collector.py", "language": "python", "lines": 129, "filename": "example_collector.py"}}, "76f8076c-b9ad-4ec2-9635-1dc6cac1217e": {"node_ids": ["ac768216-94ce-4dac-bcb4-884068b762e2", "63e8f198-5138-4b0a-a3aa-79010b05fecc"], "metadata": {"file_path": "backend\\app\\core\\rag\\query_retriever.py", "language": "python", "lines": 179, "filename": "query_retriever.py"}}, "fd4fe35f-8dfa-45f8-b847-a745c776ba01": {"node_ids": ["4f1c2edb-a684-4b28-8856-3a9f2167a2ad"], "metadata": {"file_path": "backend\\app\\core\\security\\data_masking.py", "language": "python", "lines": 95, "filename": "data_masking.py"}}, "983b1bc6-4018-4ca0-bfd3-113a59ba53c4": {"node_ids": ["26eb2191-e916-46a5-98e4-45031a0c1fff"], "metadata": {"file_path": "backend\\app\\core\\security\\input_validator.py", "language": "python", "lines": 81, "filename": "input_validator.py"}}, "2b3e410e-1735-433e-a26d-6a0b0734a659": {"node_ids": ["8aa4adf2-e005-4c87-9b9b-24671126cf86", "2ec5eb91-5404-4770-a1a5-8014b7e7462e", "aee77904-2308-4c50-aee7-3e5f34733775", "78492376-95e6-48a0-9ef1-fccf05210c39", "9904175a-c176-4865-b351-0937385ff585", "c9288313-8d43-4391-b88d-d0da6936e659", "665147ae-3561-4525-8f05-9b663d6ab100", "14828b4d-172b-41f4-a157-edf69c5aa1f4", "f5d7a17d-317a-48d2-9811-d34ac0e3cbcd", "14329a39-a8ce-4e09-b601-1a030712231c", "baaf14ac-e422-4f6d-9b74-784c9de83cd9", "47fbfd2b-4015-42cc-971d-e80526624410", "5dd945ec-caac-4bea-890f-d957b06afab4", "1ec36c44-efd8-4074-b387-f3669a040d74", "3aab2fd3-0120-4047-b597-e7dc7c2ef2ee", "2a97ee66-bf37-46ee-8b8c-21c743c0d9e3", "59d02ba7-2070-45e1-afcc-80a07f36fee4", "3440163e-8445-444f-8a86-b53231b3e1ee"], "metadata": {"file_path": "backend\\app\\core\\tools\\chart_tools.py", "language": "python", "lines": 1563, "filename": "chart_tools.py"}}, "9ecd1dcb-1da9-40da-a8dc-3035678caead": {"node_ids": ["a4d27306-85ce-48a5-ab38-7380e28fbfee"], "metadata": {"file_path": "backend\\app\\core\\tools\\check_gui_dependencies.py", "language": "python", "lines": 57, "filename": "check_gui_dependencies.py"}}, "80514101-fc7f-4fa3-a6c7-0e720faa8681": {"node_ids": ["52023b49-1775-4d7e-903e-d12c8f382c55"], "metadata": {"file_path": "backend\\app\\core\\tools\\check_integration.py", "language": "python", "lines": 1, "filename": "check_integration.py"}}, "f7089940-ac3d-4982-813b-0f1f9fcbfce0": {"node_ids": ["edc65b51-e3dc-4165-aa16-6172afdeb09f", "128663cc-5953-43f4-ade9-e35d8bb51cc3", "5cc9bea4-e150-4c2a-ac22-139eaedbfdfb"], "metadata": {"file_path": "backend\\app\\core\\tools\\code_interpreter.py", "language": "python", "lines": 276, "filename": "code_interpreter.py"}}, "207e6bfc-4554-4ae6-90cb-19f777c30ba3": {"node_ids": ["c94c0747-d6b5-44db-9ac5-b808d103ba9d"], "metadata": {"file_path": "backend\\app\\core\\tools\\date_time_tools.py", "language": "python", "lines": 19, "filename": "date_time_tools.py"}}, "8219d331-a4fd-4480-b5d6-b507ede38e0b": {"node_ids": ["c76e7603-27d5-4bf8-8318-fdb62264e15d"], "metadata": {"file_path": "backend\\app\\core\\tools\\debug_server.py", "language": "python", "lines": 43, "filename": "debug_server.py"}}, "d1408d73-ee06-4439-b14c-1dab77a38edf": {"node_ids": ["c46dccb7-53e8-46d0-aab6-35e0eab8e048", "3d4b355f-6ec2-426c-805d-53a56706bbc3", "8d391dc4-45c8-4ce2-bf79-a8b5c3e7cc2a", "23e36d55-b747-40e1-9217-8b34ad32c2eb"], "metadata": {"file_path": "backend\\app\\core\\tools\\flexible_query_tool.py", "language": "python", "lines": 332, "filename": "flexible_query_tool.py"}}, "2aa4c010-8271-4f68-b5ec-f2d43ae8ce3b": {"node_ids": ["3d5381e4-212a-4b8c-b84d-433093088c71", "a2c5f4a4-138c-44a6-b598-d6580b1cb954", "6b44ffbe-6515-4a6d-ad59-88fa05b4ee82"], "metadata": {"file_path": "backend\\app\\core\\tools\\graph_integration.py", "language": "python", "lines": 147, "filename": "graph_integration.py"}}, "85e1f88b-9db1-4d48-a6eb-f6da51cddb31": {"node_ids": ["8ffd2447-76ce-4cf2-ba91-08447d0805c0", "a16124ec-0ed0-44bf-b9d2-de7ebc02735d"], "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_parquet_tools.py", "language": "python", "lines": 115, "filename": "mcp_parquet_tools.py"}}, "0b825a90-3ed8-40a4-af6f-a23526a54c6f": {"node_ids": ["7fb646e6-21c1-4899-9802-0c9412a64966", "4f76b6ef-7f7c-493b-be7b-93e232b1fcd4"], "metadata": {"file_path": "backend\\app\\core\\tools\\mcp_sql_server_tools.py", "language": "python", "lines": 122, "filename": "mcp_sql_server_tools.py"}}, "7edff531-f9a2-445d-b3fe-fefce6ea1469": {"node_ids": ["fb4a4e92-f9dd-43ce-a6b2-afcb3558b99b", "45a01ac8-94aa-4c16-a48b-5d10fff9b419"], "metadata": {"file_path": "backend\\app\\core\\tools\\quick_response.py", "language": "python", "lines": 159, "filename": "quick_response.py"}}, "ac39ce31-2917-4938-b1cf-f30ddf5ecc5f": {"node_ids": ["3f2f0192-39ad-4774-933b-ecc2764025e2", "33a45088-0f20-4977-90ca-42d2a7f1c529", "822e6fb7-c7fc-4eac-9a0d-cc9c23b04f41"], "metadata": {"file_path": "backend\\app\\core\\tools\\sql_server_tools.py", "language": "python", "lines": 357, "filename": "sql_server_tools.py"}}, "989a4d13-fc47-49e7-af38-f28af1dc9abb": {"node_ids": ["5aa919ed-a38e-4f99-abbf-6e07b90a2182", "6411b1eb-46af-4b3e-a973-a2f90ab73c1d", "22b5a32d-774a-4ea0-ba7e-02673c6de0ed", "a3a14f9b-75f9-475a-b38a-60beeb16a1f1", "b9bc750d-75e3-49a8-b720-3fe1666b0ab0", "61ad2d53-ceae-442f-9aab-e83024058f1f", "24cfde90-aef7-49e4-aa14-735c1399d06f", "1a15d8fa-3213-4717-97ee-3a00a813c5df", "c30cd625-1ceb-40ca-a927-d240e4203047", "907b793d-273e-4925-a483-d1868209a391", "172ced35-d90c-42d6-b58c-301018821d3f", "56aed099-8241-4ce0-bc2c-a199c635ac21", "262c8b90-f76b-4006-a322-4e07d3446f4b", "befd36bd-acb9-4a23-aece-e7f1d077b9b1", "fcb3aeaf-f895-468e-a379-f70ff91ace81", "c7a18404-9c81-49f8-844e-4fb9a5c486e9", "eb4630ce-dd89-4cf4-accd-8d30c2f1a1e9", "d479f69b-3ded-49af-b22d-3f26cb9e53a4", "a5fa4e16-cd42-484d-8dea-35f7f0f82e19", "a617a3fd-f0b2-42c8-a192-ed00c56ecde2", "7610e168-59f1-40e8-9dc0-a9df04ff6b02", "88ff1c6e-35f2-4a26-8498-a3c3988707bf", "dfd05c9a-a89e-447e-a544-f282e7a70f67", "966b4781-46ee-4852-9c93-2eaf2d232617"], "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools.py", "language": "python", "lines": 1580, "filename": "une_tools.py"}}, "a4138d34-acce-45e7-afa5-70ee1e20901a": {"node_ids": ["b1695045-39da-4a75-85b2-b835db9a2906", "29482fbb-00b7-4ee5-9ece-882b657de04d", "3a6c2027-d621-417a-8be8-8f2cff9f6992", "1bfb7cc3-a107-4076-9524-2ff8631ca224", "891fa1d1-d13f-4c4a-96e4-9d26c0224e77", "ed781b74-f00e-4a36-a9fb-130e1bb1e340"], "metadata": {"file_path": "backend\\app\\core\\tools\\une_tools_backup_old.py", "language": "python", "lines": 349, "filename": "une_tools_backup_old.py"}}, "661e34ff-e65c-4e69-b3b0-898ffbc65201": {"node_ids": ["c485acb2-0b63-4fa8-ae9d-e407b2a9e7da", "9c94e055-f57c-4d60-b19c-da2f8dd7851b", "e905bd8c-c552-4268-9c12-a27839f69421", "f3e62a9a-1886-4619-845b-b95b29804058"], "metadata": {"file_path": "backend\\app\\core\\tools\\unified_data_tools.py", "language": "python", "lines": 329, "filename": "unified_data_tools.py"}}, "6e414818-2def-4da0-ad7b-2083240dafac": {"node_ids": ["0b8503dc-0335-43a8-947e-6175105c4def"], "metadata": {"file_path": "backend\\app\\core\\tools\\verify_imports.py", "language": "python", "lines": 45, "filename": "verify_imports.py"}}, "6a3e6291-5b9b-434d-a8a0-9fb83d3eb662": {"node_ids": ["8dd9050b-29f0-454a-b5a7-555d98abe524"], "metadata": {"file_path": "backend\\app\\core\\tools\\__init__.py", "language": "python", "lines": 1, "filename": "__init__.py"}}, "265ddd63-d8e6-4210-820b-0bd4e7797745": {"node_ids": ["9c738ddf-68ae-4f34-920f-aa34cf9b7294", "cc0de57e-eece-4650-a46b-82a7c2fcbf53", "2169e8d1-ead4-4c44-a547-bd8fbe8ecabb", "6d79fa1d-5938-4d1c-b749-19b241964f33"], "metadata": {"file_path": "backend\\app\\core\\utils\\cache_cleaner.py", "language": "python", "lines": 360, "filename": "cache_cleaner.py"}}, "36b75554-8723-460d-8ca5-cac6322fbc27": {"node_ids": ["c925a0f4-71d2-48ed-8d25-65722cd3d060"], "metadata": {"file_path": "backend\\app\\core\\utils\\chart_saver.py", "language": "python", "lines": 54, "filename": "chart_saver.py"}}, "29096612-3ffa-4ba9-bf73-48fa3f45b354": {"node_ids": ["5dab1c3d-e65e-41bf-96b1-eddcfe8b1c62", "d77588c7-85fa-439d-8997-a804e99feba4", "88399c72-a630-4786-ba4b-b3e32f649cf1", "64e51d6e-4ffc-4ea4-b91c-5ad1ec1a369c", "b465b2ff-9c61-4d97-8063-d3c5ed4b35a4"], "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler.py", "language": "python", "lines": 409, "filename": "error_handler.py"}}, "f52fd3e4-756d-420f-8950-efc855d6dbd0": {"node_ids": ["899b9843-5ea6-4d19-a410-bc15e0287219"], "metadata": {"file_path": "backend\\app\\core\\utils\\error_handler_backup.py", "language": "python", "lines": 116, "filename": "error_handler_backup.py"}}, "342b7401-f2f2-4cd6-b4dd-bbb4dda0bfdf": {"node_ids": ["f64a07c9-f79f-465f-8d1d-4924f23faba0"], "metadata": {"file_path": "backend\\app\\core\\utils\\fast_path_detector.py", "language": "python", "lines": 74, "filename": "fast_path_detector.py"}}, "6aa7835c-ff39-4440-a414-2c1e18f53662": {"node_ids": ["66c84286-d684-4570-a1a4-90b93392e8c9", "dc845597-b1c6-428c-92d9-279e6c8fac92"], "metadata": {"file_path": "backend\\app\\core\\utils\\field_mapper.py", "language": "python", "lines": 125, "filename": "field_mapper.py"}}, "2fc296be-32a3-4c53-b5c2-39397423556f": {"node_ids": ["f5ff53c9-cfab-4e96-8447-22f1155b0b72", "c2cea6f4-27cf-47eb-83a1-fcec31bf95bd", "3e59af38-1f60-46fd-9b00-dd90735f14fe"], "metadata": {"file_path": "backend\\app\\core\\utils\\query_history.py", "language": "python", "lines": 179, "filename": "query_history.py"}}, "935ac8d6-1523-4919-90ec-9902cbeaf7b6": {"node_ids": ["5dc10106-0a8b-4123-8bbb-b8654d935765", "fd8538cc-76ef-4e3a-a400-5c9bb566d341", "22da6b71-621e-4217-8a47-806f03c4a510", "004ccd63-afda-43bc-b998-5203a63edf27"], "metadata": {"file_path": "backend\\app\\core\\utils\\query_validator.py", "language": "python", "lines": 362, "filename": "query_validator.py"}}, "10d73805-bb4f-40cc-9ba4-4e5389a4629d": {"node_ids": ["2ae11cb1-095f-4fcd-8138-6a952b249a1c", "5aa76912-85fa-4943-9707-8a427a2db18c"], "metadata": {"file_path": "backend\\app\\core\\utils\\response_cache.py", "language": "python", "lines": 158, "filename": "response_cache.py"}}, "11648e8a-5b5f-47b4-a171-042f18c322a1": {"node_ids": ["6a1de7df-ecb1-48a5-81f2-8ec326ec5c0c"], "metadata": {"file_path": "backend\\app\\core\\utils\\response_parser.py", "language": "python", "lines": 139, "filename": "response_parser.py"}}, "d33ca55a-61c0-4c93-a37a-7ab825660ef8": {"node_ids": ["7ed8104f-dab0-4781-8a99-9bbc91277315", "9821444d-aab9-4174-b47e-3c6dcb776dfc", "1dee5a99-3ded-490a-bb9e-6f8d0907e38c"], "metadata": {"file_path": "backend\\app\\core\\utils\\response_validator.py", "language": "python", "lines": 234, "filename": "response_validator.py"}}, "d51e5ac3-855f-4c59-b6cf-89ac2dacd175": {"node_ids": ["0b92b392-c6e5-490c-b136-8c0c48e38e45", "aab679ae-2d69-49e3-b716-ce9f6d3dc64f"], "metadata": {"file_path": "backend\\app\\core\\utils\\semantic_cache.py", "language": "python", "lines": 244, "filename": "semantic_cache.py"}}, "9f0213a1-8b99-416a-b97e-d6f73804b606": {"node_ids": ["6f807265-4089-41cc-9dc2-416a200e46e5"], "metadata": {"file_path": "backend\\app\\core\\utils\\session_manager.py", "language": "python", "lines": 57, "filename": "session_manager.py"}}, "f6f10c33-48e1-47c1-b2d0-39873e999a6d": {"node_ids": ["e82e749c-541f-4f2e-8aec-96ded845d24a"], "metadata": {"file_path": "backend\\app\\core\\utils\\__init__.py", "language": "python", "lines": 2, "filename": "__init__.py"}}, "76dd1381-3d9d-4f76-8d0c-54637b99cecd": {"node_ids": ["6fdbbcca-edfe-4749-ae67-a6de1bcbc3d5", "78e39a88-8c05-4570-b0b3-58c4e6b60119", "753424f8-e4b0-4b34-804c-41959cac64e1", "6d0df27e-e863-4c3f-835f-291dfd167e1d"], "metadata": {"file_path": "backend\\app\\core\\validators\\schema_validator.py", "language": "python", "lines": 397, "filename": "schema_validator.py"}}, "9851deb0-e7de-4c86-b544-d9521b2fdaff": {"node_ids": ["58aa4eb7-4dfd-4d67-9bfa-116cf705c9b7"], "metadata": {"file_path": "backend\\app\\core\\visualization\\advanced_charts.py", "language": "python", "lines": 107, "filename": "advanced_charts.py"}}, "337e53a3-c540-47f3-80f9-6c691356ea9b": {"node_ids": ["72cf6043-20f7-4c2e-a9fb-f01ac41350ce"], "metadata": {"file_path": "backend\\app\\core\\visualization\\__init__.py", "language": "python", "lines": 2, "filename": "__init__.py"}}, "d357f2a6-8e6c-4e2d-8856-fd2c94d167e5": {"node_ids": ["331b9e8e-7faf-46b7-8089-85ecf84b987c"], "metadata": {"file_path": "backend\\app\\infrastructure\\data\\base.py", "language": "python", "lines": 34, "filename": "base.py"}}, "1b38f269-50a5-4c64-bc9b-83f445d36732": {"node_ids": ["bb62e80f-4fcb-4491-98ad-0364206f5422"], "metadata": {"file_path": "backend\\app\\infrastructure\\data\\dependency.py", "language": "python", "lines": 25, "filename": "dependency.py"}}, "20d69657-d22e-4beb-8e97-03b91bc9ed8a": {"node_ids": ["9ab63a13-8876-445d-8941-e45035b6327a"], "metadata": {"file_path": "backend\\app\\infrastructure\\data\\hybrid_adapter.py", "language": "python", "lines": 105, "filename": "hybrid_adapter.py"}}, "8b235e2c-da4f-41a5-a1a6-3217968dd14d": {"node_ids": ["aad0558b-391d-40d6-bef7-25a9b68ef48e"], "metadata": {"file_path": "backend\\app\\infrastructure\\data\\parquet_adapter.py", "language": "python", "lines": 39, "filename": "parquet_adapter.py"}}, "b257e43a-66b1-4df6-be67-3150de4be004": {"node_ids": ["612f0646-d7fb-4826-929f-d504f68d2439", "4b9b7d8a-c51c-43c4-af6d-e596e33cf7c6", "c6ed794f-96d9-418f-9360-1c5d2f670019", "3876ded9-df10-4f8c-8f59-ecbde9f99020", "7d7cbdd7-b024-4630-96b1-79a833222298"], "metadata": {"file_path": "backend\\app\\infrastructure\\data\\polars_dask_adapter.py", "language": "python", "lines": 344, "filename": "polars_dask_adapter.py"}}, "9708101b-ad08-43dd-85ef-86d69891d93b": {"node_ids": ["a0a8dfa2-2daa-4c1e-a72e-1185c486fe96"], "metadata": {"file_path": "backend\\app\\infrastructure\\data\\sql_server_adapter.py", "language": "python", "lines": 114, "filename": "sql_server_adapter.py"}}, "08098e45-63d2-47c0-bb1a-f63a21099f39": {"node_ids": ["802d2599-9478-45a3-943b-5614bdd226be", "46b0b898-3aa9-41b1-aaac-a781b978fe8e", "7708cbed-c46d-4a56-a1fc-d8e23b1176c3", "f7bf6631-3fc8-49e5-b814-2c63e2d1f3d2"], "metadata": {"file_path": "backend\\app\\infrastructure\\data\\config\\column_mapping.py", "language": "python", "lines": 312, "filename": "column_mapping.py"}}, "eaeb5440-d56f-4082-bb26-6804bd20272e": {"node_ids": ["0829a6ff-388a-4a41-bcc9-6f95268b9ec8", "f24f80f2-9c40-4692-a1cd-cd0f808ef38a", "7bddda63-87c4-4d0b-b0a0-30163f361c4d", "f964a7a5-c70b-43a3-bb14-178f0578b850"], "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\column_validator.py", "language": "python", "lines": 342, "filename": "column_validator.py"}}, "1d8a64a0-0b1f-4a2b-aaa9-cd28e115d880": {"node_ids": ["2ced75d0-4613-4266-b73f-f1ef8bf3b743", "f318ec37-4a1a-49c3-af63-6f7cc967c3a2", "2e2ce22d-5907-4c79-adbe-b359746620c8"], "metadata": {"file_path": "backend\\app\\infrastructure\\data\\utils\\query_optimizer.py", "language": "python", "lines": 256, "filename": "query_optimizer.py"}}, "4e1187b0-d907-4d0a-93ab-350d9a58dd11": {"node_ids": ["169278cd-2fe1-4352-9cf3-ef4d4c8f6582"], "metadata": {"file_path": "backend\\app\\infrastructure\\database\\migrations\\env.py", "language": "python", "lines": 69, "filename": "env.py"}}, "29763e78-76e0-4efb-8899-64c6f8b2c148": {"node_ids": ["a16d19c6-0404-41c7-a781-eddf9005763c"], "metadata": {"file_path": "backend\\app\\infrastructure\\database\\migrations\\versions\\fresh_start_migration.py", "language": "python", "lines": 74, "filename": "fresh_start_migration.py"}}, "f33f5799-0b3c-4b81-bb8c-de1e4f1e5ba0": {"node_ids": ["217fe079-d69d-482a-aae4-7aa77b40f2fb", "744e327a-0ab9-485d-8bb8-4c1e7324bcb6"], "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\admmatao.py", "language": "python", "lines": 123, "filename": "admmatao.py"}}, "038fdd76-c25d-469a-9f9f-b90d63e65b31": {"node_ids": ["33f67462-1b67-49e6-a985-ed964b546f03"], "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\audit_log.py", "language": "python", "lines": 38, "filename": "audit_log.py"}}, "0c00f1af-b690-47b4-bf76-346204af944d": {"node_ids": ["4b2a641d-e25a-4b4b-83ac-b28fb87fe444"], "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\report.py", "language": "python", "lines": 43, "filename": "report.py"}}, "be81d64d-f554-4617-ba36-9494e1830d4f": {"node_ids": ["9d84ac0f-c9bb-490c-8106-d2b8f4e287f6"], "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\shared_conversation.py", "language": "python", "lines": 70, "filename": "shared_conversation.py"}}, "54cc6769-ba4b-443d-aa5f-205a61ea7085": {"node_ids": ["2064ba8e-ab08-4577-adf1-3cf548819731"], "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\user.py", "language": "python", "lines": 54, "filename": "user.py"}}, "50baffb5-891f-46e9-ba9f-5f231427eb73": {"node_ids": ["b1b9b403-4417-4c76-aeb7-3f44f4cc80bd"], "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\user_preference.py", "language": "python", "lines": 51, "filename": "user_preference.py"}}, "e45c7760-5324-472f-80a0-430efd09f021": {"node_ids": ["b1831ff0-5075-497b-bfa1-9bd719798526"], "metadata": {"file_path": "backend\\app\\infrastructure\\database\\models\\__init__.py", "language": "python", "lines": 15, "filename": "__init__.py"}}, "d4de66b4-b616-426f-858d-e555e6b6e888": {"node_ids": ["22c8a723-8d19-4c30-9b7a-b83178e4f238"], "metadata": {"file_path": "backend\\app\\schemas\\analytics.py", "language": "python", "lines": 55, "filename": "analytics.py"}}, "986aee79-7a40-4e5c-8c4a-ba677c3efc5e": {"node_ids": ["ec977477-afd7-4e2c-8917-3591236d8bed"], "metadata": {"file_path": "backend\\app\\schemas\\auth.py", "language": "python", "lines": 37, "filename": "auth.py"}}, "a2d5c3b6-9721-4d11-b886-23c01d077a5d": {"node_ids": ["dee21d55-3a8b-45f3-b096-18e3e2396110"], "metadata": {"file_path": "backend\\app\\schemas\\report.py", "language": "python", "lines": 61, "filename": "report.py"}}, "19bb81de-ecb8-418e-b274-7bfe2361812f": {"node_ids": ["dc86671d-02ca-4b37-990d-7a6b635e05b7"], "metadata": {"file_path": "backend\\app\\schemas\\user.py", "language": "python", "lines": 68, "filename": "user.py"}}, "1a986fab-103a-41f1-bd7b-c7b25aeab08e": {"node_ids": ["15453c59-d3dc-4f80-a018-2098e91f680f", "40b87286-fb0a-457f-ae14-6d45bade3d45"], "metadata": {"file_path": "frontend-solid\\src\\index.tsx", "language": "typescript", "lines": 158, "filename": "index.tsx"}}, "2995b554-16b2-47a1-8290-752393aab1ae": {"node_ids": ["46fed4cb-1b39-4339-84c1-c7795188164b"], "metadata": {"file_path": "frontend-solid\\src\\index_minimal_test.tsx", "language": "typescript", "lines": 11, "filename": "index_minimal_test.tsx"}}, "2210e22d-819c-4ee8-b4bf-a668724032f4": {"node_ids": ["09aa36da-5f6d-4fb6-82ab-d6e3df12184d", "efd292d3-6c16-403d-a12c-37c0a10867b6"], "metadata": {"file_path": "frontend-solid\\src\\Layout.tsx", "language": "typescript", "lines": 135, "filename": "Layout.tsx"}}, "643e9968-020a-4265-ba3a-c136bb3fb51b": {"node_ids": ["81a90d2a-574d-4ae2-a300-c3e4c993fa6c", "53323c09-9b3f-49ff-b1f8-f499b3741ed9"], "metadata": {"file_path": "frontend-solid\\src\\components\\AIInsightsPanel.tsx", "language": "typescript", "lines": 173, "filename": "AIInsightsPanel.tsx"}}, "e4f8a88e-a468-459f-be6a-731cf35faf13": {"node_ids": ["73adaafa-dc61-4a99-8176-a3e29ff98dce"], "metadata": {"file_path": "frontend-solid\\src\\components\\ChartDownloadButton.tsx", "language": "typescript", "lines": 123, "filename": "ChartDownloadButton.tsx"}}, "70106f2e-7567-435e-acd4-f7e6b59fc3d7": {"node_ids": ["6e49edac-1e90-4008-b2af-0ad97ccf877a", "7753a2e9-c2e3-4317-b054-63d9a6148743"], "metadata": {"file_path": "frontend-solid\\src\\components\\DataTable.tsx", "language": "typescript", "lines": 126, "filename": "DataTable.tsx"}}, "7780775f-421d-4242-b7fe-f5f4d8398457": {"node_ids": ["1945848b-8d8f-4421-9b85-353e06c916d5"], "metadata": {"file_path": "frontend-solid\\src\\components\\DownloadButton.tsx", "language": "typescript", "lines": 47, "filename": "DownloadButton.tsx"}}, "0875b3a1-3c84-4558-9165-c8e5e9179b74": {"node_ids": ["7ee5b1e0-ac82-46bc-87d0-d8f0bbbc4543"], "metadata": {"file_path": "frontend-solid\\src\\components\\ErrorBoundary.tsx", "language": "typescript", "lines": 38, "filename": "ErrorBoundary.tsx"}}, "7c3a0f7d-fb58-4c67-971f-4d0f0b70149b": {"node_ids": ["d83cfdcc-4403-4467-88d7-0584566d3105", "5fe02189-b760-4478-a125-23b68cf1960e"], "metadata": {"file_path": "frontend-solid\\src\\components\\ExportMenu.tsx", "language": "typescript", "lines": 137, "filename": "ExportMenu.tsx"}}, "a58bd078-5e80-4548-a6dc-3ffcf58de308": {"node_ids": ["edcddc78-7606-4a8b-9f2f-286c675a84c7"], "metadata": {"file_path": "frontend-solid\\src\\components\\FeedbackButtons.tsx", "language": "typescript", "lines": 41, "filename": "FeedbackButtons.tsx"}}, "9f7d5136-1a68-4d2f-ac12-61ba612ae228": {"node_ids": ["cdef3be0-c434-41f0-99b3-fee83a57116e"], "metadata": {"file_path": "frontend-solid\\src\\components\\index.ts", "language": "typescript", "lines": 12, "filename": "index.ts"}}, "9ec685e0-f3bb-433a-97c5-2e7e1d8d5d9e": {"node_ids": ["0d79ad5d-a10b-48de-afbb-2411d8895f1c"], "metadata": {"file_path": "frontend-solid\\src\\components\\Logo.tsx", "language": "typescript", "lines": 28, "filename": "Logo.tsx"}}, "569b3716-77bc-4551-9d10-2b0b23894e00": {"node_ids": ["d543ef81-725a-47f8-8c3b-c431457d80df"], "metadata": {"file_path": "frontend-solid\\src\\components\\MessageActions.tsx", "language": "typescript", "lines": 53, "filename": "MessageActions.tsx"}}, "3c0d95a2-5c99-4fda-b060-990250966bd2": {"node_ids": ["8455fed0-9a0f-42f1-a3c3-77b75f7b21d8", "0f7827e1-0d43-4557-a986-3f2864af70c6"], "metadata": {"file_path": "frontend-solid\\src\\components\\PlotlyChart.tsx", "language": "typescript", "lines": 170, "filename": "PlotlyChart.tsx"}}, "c77100a9-e1c8-4c85-8649-952b428ea00b": {"node_ids": ["8a30f374-beae-42ee-829f-8668d8e9da4b", "2fcae706-ebc3-47e8-9974-e2be0aa3a8b3"], "metadata": {"file_path": "frontend-solid\\src\\components\\ShareButton.tsx", "language": "typescript", "lines": 199, "filename": "ShareButton.tsx"}}, "3f20c2af-f0dd-4a74-bb3c-b33d76eb2cf1": {"node_ids": ["c3bd8588-fa8f-4377-a4fe-4d5861d0758e"], "metadata": {"file_path": "frontend-solid\\src\\components\\Typewriter.tsx", "language": "typescript", "lines": 124, "filename": "Typewriter.tsx"}}, "326af040-385f-4592-be57-172ee53c0865": {"node_ids": ["666e1f44-60fd-4df2-a0a7-d3b93cb29e96"], "metadata": {"file_path": "frontend-solid\\src\\components\\TypingIndicator.tsx", "language": "typescript", "lines": 13, "filename": "TypingIndicator.tsx"}}, "5ecddff0-031e-48cb-8316-73806ef9f524": {"node_ids": ["033afa20-be0f-45e9-8811-b4df2ab32f8d"], "metadata": {"file_path": "frontend-solid\\src\\components\\UserPreferences.tsx", "language": "typescript", "lines": 137, "filename": "UserPreferences.tsx"}}, "69ada291-f55c-49a7-a2a2-98550c6cba35": {"node_ids": ["34e544be-3bc2-4af7-b4d7-4415f937441f", "a06d5482-b557-4870-8739-98e76111edc5", "3f7bb3e9-99e4-4881-baf0-e42298893cb0"], "metadata": {"file_path": "frontend-solid\\src\\components\\__tests__\\Chat.test.tsx", "language": "typescript", "lines": 223, "filename": "Chat.test.tsx"}}, "6bcb8ccf-b935-43f8-948c-84b6dfe58909": {"node_ids": ["1b9c636c-3917-438b-a5c6-63cd915720b4", "7ab5f559-ccb2-49b2-83e8-2157c1b1354c", "d119ec1a-0561-4491-a9d7-31752efdc612", "2cb1a28c-3bdf-4695-8ce4-d83da532bdfb"], "metadata": {"file_path": "frontend-solid\\src\\examples\\ComponentsDemo.tsx", "language": "typescript", "lines": 167, "filename": "ComponentsDemo.tsx"}}, "17e250dc-a486-42ac-92b9-79283e8bb181": {"node_ids": ["ed8efb4a-6815-46a3-b73f-e11ced1257f8"], "metadata": {"file_path": "frontend-solid\\src\\examples\\MinimalLogin.tsx", "language": "typescript", "lines": 14, "filename": "MinimalLogin.tsx"}}, "3b7b22d2-b9a7-4439-a33a-e62e91aa2301": {"node_ids": ["0d2dbbdd-a03b-4a28-ade5-7f9cf43e5ec7"], "metadata": {"file_path": "frontend-solid\\src\\examples\\SkeletonDemo.tsx", "language": "typescript", "lines": 85, "filename": "SkeletonDemo.tsx"}}, "c5943d27-24e8-4821-b817-a97ff01f6fb3": {"node_ids": ["3c719b24-1c54-4418-93e6-7b8cea11eb9f"], "metadata": {"file_path": "frontend-solid\\src\\hooks\\useAdmin.ts", "language": "typescript", "lines": 91, "filename": "useAdmin.ts"}}, "5b77fe54-9b10-498c-ab50-ef1b5a679d1e": {"node_ids": ["2b01c65c-ff77-4943-b0e1-8603972cfd00"], "metadata": {"file_path": "frontend-solid\\src\\hooks\\useAnalytics.ts", "language": "typescript", "lines": 63, "filename": "useAnalytics.ts"}}, "1c8b7ffe-3389-4c3c-983c-a66ee5cd0d8d": {"node_ids": ["af48e01b-bc6c-4217-928f-7fbb56bb5391"], "metadata": {"file_path": "frontend-solid\\src\\hooks\\useMediaQuery.ts", "language": "typescript", "lines": 34, "filename": "useMediaQuery.ts"}}, "70742b89-de98-429f-8de5-bc66aec0c8c8": {"node_ids": ["1a44ee57-a47a-4a5e-bfcb-21678516f46c"], "metadata": {"file_path": "frontend-solid\\src\\hooks\\useReports.ts", "language": "typescript", "lines": 92, "filename": "useReports.ts"}}, "581ead2c-4ccc-4e96-9bcf-1cbb133447ca": {"node_ids": ["a1e01383-cd89-4deb-a975-e34349b90ce5", "c81d2e08-2e3e-4bfc-972e-becce5d4924a"], "metadata": {"file_path": "frontend-solid\\src\\lib\\api.ts", "language": "typescript", "lines": 209, "filename": "api.ts"}}, "3047959e-b205-4a94-8909-8848c2158d71": {"node_ids": ["612445c6-76a4-4945-ab1f-fb56454eec8d"], "metadata": {"file_path": "frontend-solid\\src\\lib\\export.ts", "language": "typescript", "lines": 30, "filename": "export.ts"}}, "93bb9756-5ed5-44dd-a57e-afe5415b2f5c": {"node_ids": ["eaf9dea7-2e42-40cc-beda-359923646183"], "metadata": {"file_path": "frontend-solid\\src\\lib\\formatters.ts", "language": "typescript", "lines": 20, "filename": "formatters.ts"}}, "cb44686a-6ca1-4136-97da-0f623d76042a": {"node_ids": ["9090160f-49eb-4067-9f25-3f8a4845913c"], "metadata": {"file_path": "frontend-solid\\src\\lib\\supabase.ts", "language": "typescript", "lines": 11, "filename": "supabase.ts"}}, "1ae1750c-c9fd-4451-a7ae-cfa6ebfa57e1": {"node_ids": ["54557e51-f726-4646-a99f-c2290a1be641"], "metadata": {"file_path": "frontend-solid\\src\\lib\\api\\client.ts", "language": "typescript", "lines": 74, "filename": "client.ts"}}, "39a14761-f57b-43a5-bd54-3763fe95b651": {"node_ids": ["552654b9-58e6-49ef-95ce-fad60cbf9b75"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Alert.tsx", "language": "typescript", "lines": 77, "filename": "Alert.tsx"}}, "75907ae3-2764-40b0-8140-09ccf704d647": {"node_ids": ["437c61ba-8bc3-48d9-a626-f23bc2e2b96d"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Avatar.tsx", "language": "typescript", "lines": 57, "filename": "Avatar.tsx"}}, "05a8716f-7666-4469-bb93-1556c22c722a": {"node_ids": ["6992e90a-4c68-4645-941b-80d00cec4dd1"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Badge.test.tsx", "language": "typescript", "lines": 55, "filename": "Badge.test.tsx"}}, "2c33595d-a26c-422f-9f6d-34e9267baada": {"node_ids": ["8fdb4730-6eb8-49e7-af41-20e84aa09eef"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Badge.tsx", "language": "typescript", "lines": 54, "filename": "Badge.tsx"}}, "7382a6cf-214f-4b11-946e-170d48598305": {"node_ids": ["0366115f-e42c-423c-96b1-bdb34e05df3e"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Button.test.tsx", "language": "typescript", "lines": 74, "filename": "Button.test.tsx"}}, "d136238d-a534-46cb-ae84-7e34780fb8a9": {"node_ids": ["ccaef467-a201-4dfe-b03b-9b072d630143"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Button.tsx", "language": "typescript", "lines": 65, "filename": "Button.tsx"}}, "688effb7-04ea-421b-bd98-f8cf0a6ac441": {"node_ids": ["2c8e6b71-26d3-424a-8bc2-6047db841fb0"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Card.tsx", "language": "typescript", "lines": 120, "filename": "Card.tsx"}}, "93214708-e259-4fbb-868c-51606fbceaf4": {"node_ids": ["815cd613-0496-4144-903c-f641afa70e33"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Dialog.tsx", "language": "typescript", "lines": 80, "filename": "Dialog.tsx"}}, "cbb8f796-bd73-4862-9638-517f64f5486f": {"node_ids": ["760ae05b-0e0d-4c3c-8ccb-b3f862febd62"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\DropdownMenu.tsx", "language": "typescript", "lines": 68, "filename": "DropdownMenu.tsx"}}, "58406d29-193c-46a4-9940-66d19f8aa1a5": {"node_ids": ["c3aad143-c8d9-4dd6-803a-8557911222ad"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\index.ts", "language": "typescript", "lines": 55, "filename": "index.ts"}}, "09712d3b-9cac-46ea-9aeb-8a261fb052e7": {"node_ids": ["6e203d6f-8f21-48d1-aa31-dfa749314653"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Input.tsx", "language": "typescript", "lines": 35, "filename": "Input.tsx"}}, "3583b44f-8839-4d9b-8a70-7661e91b5d2c": {"node_ids": ["fd3aca82-f0fb-422a-9c7c-98341bf58846"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Label.tsx", "language": "typescript", "lines": 31, "filename": "Label.tsx"}}, "f84654c1-b017-4e1c-a53a-a264e4499db4": {"node_ids": ["d4d836f2-7be5-4534-bf17-6b7440ceddc3"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\LazyImage.tsx", "language": "typescript", "lines": 45, "filename": "LazyImage.tsx"}}, "1faf9863-89b1-4892-99d1-67d0f4af8780": {"node_ids": ["01c75418-1e75-4089-923c-4ff6598b6b1e"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Select.tsx", "language": "typescript", "lines": 31, "filename": "Select.tsx"}}, "fb0a5321-3fc6-485c-97e9-20cd17c77874": {"node_ids": ["db0be077-d45a-4fe6-b833-2d79d1049c29"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Separator.tsx", "language": "typescript", "lines": 38, "filename": "Separator.tsx"}}, "27d35423-7646-440a-93bc-acca5d10dc3f": {"node_ids": ["f1bc8e25-88ee-43d8-9095-840d9b78a467"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Sheet.tsx", "language": "typescript", "lines": 75, "filename": "Sheet.tsx"}}, "0ea4417c-ec04-4bbc-962b-16f385506760": {"node_ids": ["7b6ed93e-cc15-4f42-9d27-58dd5563f7d2"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Skeleton.test.tsx", "language": "typescript", "lines": 45, "filename": "Skeleton.test.tsx"}}, "50c08b3a-e30e-4aec-be63-0955f844961d": {"node_ids": ["208baf1f-d45e-447f-805f-9e4d3a1bcb8a"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Skeleton.tsx", "language": "typescript", "lines": 24, "filename": "Skeleton.tsx"}}, "341107bd-c8af-4db9-8c15-1ac84d75d9c1": {"node_ids": ["cd066c4b-2112-40c6-8c13-c1464aecc7a1"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\SkipLink.tsx", "language": "typescript", "lines": 17, "filename": "SkipLink.tsx"}}, "ba82f80f-2d9d-4ccc-ba84-b619721ddf53": {"node_ids": ["ccf183a0-2138-47b1-a86e-4b5c0412c869"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Sonner.tsx", "language": "typescript", "lines": 73, "filename": "Sonner.tsx"}}, "97ba2cc4-0258-41c3-9ebc-e445cc98c19f": {"node_ids": ["16e002d8-5567-439c-86d8-be1b16a5041b"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Table.tsx", "language": "typescript", "lines": 145, "filename": "Table.tsx"}}, "ab3eb9f0-efa5-46bf-8f05-c7550691d3fd": {"node_ids": ["af56d3db-9ad0-46c4-906d-17db0147f39b"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\components\\ui\\Tabs.tsx", "language": "typescript", "lines": 126, "filename": "Tabs.tsx"}}, "6297b80b-1fb0-43d9-9cf7-3af223dff8f4": {"node_ids": ["74fad9d7-bdd0-4362-8b21-8e58b3422d1a"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\utils\\a11y.ts", "language": "typescript", "lines": 76, "filename": "a11y.ts"}}, "bb0c7ee8-f9db-44d1-a277-0e29c17dc739": {"node_ids": ["afba74f4-1820-4741-b83b-24f2fdc06422"], "metadata": {"file_path": "frontend-solid\\src\\migrated-components\\utils\\cn.ts", "language": "typescript", "lines": 11, "filename": "cn.ts"}}, "4ccfa527-961b-4559-b0e8-a3b5577e374c": {"node_ids": ["757a7382-2542-48cb-8b6f-3f0ae8772f79", "83a601a8-4d3e-47ef-8fa6-33eb6c426c04", "26c2ae28-e046-4c83-9e6e-71dd20a0cc4a", "c4ae8c59-f484-4bca-9483-86be7b303477", "0994923f-450d-4876-aead-d5091de5c4fc", "e6d19f77-9557-4fc0-af87-f9e582bfcac9"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Admin.tsx", "language": "typescript", "lines": 448, "filename": "Admin.tsx"}}, "788035dc-a6ee-45c6-82e8-2fe5edbc50d6": {"node_ids": ["6e3dbc47-bc3d-4695-80b7-552d4ae0ad86", "83c4d1a0-5c76-43dc-9ad6-2db8b3945e3c", "436628a7-2cef-48be-b8a5-0f595233da92", "566838e0-ae64-47ec-b414-3105ac4dd579", "43255017-ff84-4d1e-bd3b-8d8b026a6e1f"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Analytics.tsx", "language": "typescript", "lines": 456, "filename": "Analytics.tsx"}}, "d86ce7b4-3ebe-4523-a400-7d76bcf3345b": {"node_ids": ["04691b0e-e1a9-4789-baab-4c97a3618090", "e669d4f6-e189-4ed7-9957-f6bc4ce0c28a", "b89f6108-84ca-4704-957e-b985267149f6", "74f2c2bc-4330-4a28-97b4-15792d043452", "14244dcc-ebda-4ad6-b0e7-a09f90d1c9be", "3751deb0-9218-4bba-98fd-8e351554e362"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Chat.tsx", "language": "typescript", "lines": 542, "filename": "Chat.tsx"}}, "bd1c8fea-b1d5-4e6f-aff7-c490d6bbe96b": {"node_ids": ["81f75453-3f99-415b-a53d-cda4cdbcb2a7", "7a88f0d7-1083-44e7-8d18-cc971c4305b9", "36c522f0-ee31-4310-8ec2-d7cef5cc0eaa", "135ad231-0b04-4ab4-aba7-4cbb3dbd4427", "b8c959e0-32a8-4db9-bbc5-f25dae6649cd"], "metadata": {"file_path": "frontend-solid\\src\\pages\\CodeChat.tsx", "language": "typescript", "lines": 376, "filename": "CodeChat.tsx"}}, "dbd7ab52-5413-47aa-b8d7-9a15111cfc9d": {"node_ids": ["8eb3d2f9-06bd-465a-9ad4-0c58b1533535", "cf0e476c-4653-455c-8849-5971d2a0b42f", "ececcc0c-34cb-447f-9e25-6d461b547ef1", "8c2fc024-3454-4765-924b-d8b7b8ad18cb", "2acf7ece-d27d-4ca3-9f4e-5965c228be13", "21e67d06-58b8-446b-8e95-134cce03e837"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Dashboard.tsx", "language": "typescript", "lines": 420, "filename": "Dashboard.tsx"}}, "cb6502a1-1650-4d3c-a04a-11a62afa999e": {"node_ids": ["69d8fc56-a8b3-4a84-9d95-ea38df5e5cba", "26396f6e-0eee-4387-acc9-864a6bd4e9d1", "09bb3549-1b4f-4373-b5b2-1825e814fffe", "0711f047-86b3-4bce-bb10-8f7480a47f46", "63e6781b-049f-4c25-8153-8e18ee1b6c59"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Diagnostics.tsx", "language": "typescript", "lines": 391, "filename": "Diagnostics.tsx"}}, "6d1eb4e1-26e7-4182-8b2f-a301288f768e": {"node_ids": ["31250343-d683-48fa-91c9-ad9d65346916", "de782a34-5de6-470e-b8dd-6cf7fcf57549", "41573d29-c330-446e-a7e7-50e87559ebf9"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Examples.tsx", "language": "typescript", "lines": 175, "filename": "Examples.tsx"}}, "bd027c39-9dc5-4d34-acde-f4c416dabc22": {"node_ids": ["7fa11c02-225a-4511-93a9-130a72b4616b", "e2f3bc36-1239-4a1e-8f17-3ef59b6839e2", "90efa031-8fe7-459a-a54f-9123318a6684", "b0489814-f6e0-400b-ac1c-e46a7c8312d7", "577b19c8-5d7c-4959-93c9-aae14a9c859b", "e95a2112-139c-4f41-ae26-d0416cd69b65", "5578c71b-544f-40e8-94d6-7f959893f695"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Help.tsx", "language": "typescript", "lines": 421, "filename": "Help.tsx"}}, "180c39c6-28d2-4984-9c0a-9a5f7acaf1d0": {"node_ids": ["2cd5fbbd-cdfb-4992-b941-b7b2d8bc0f9c", "eba33f6b-013c-4e1e-b9bb-9cab2b603bf1", "05a2fab3-c692-4fef-bad1-98bd5b474bd9", "2c2e1cd0-fe47-4482-b74f-09c29bb70672", "d8d73997-59fc-4784-b811-5f3f74c53222"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Learning.tsx", "language": "typescript", "lines": 423, "filename": "Learning.tsx"}}, "81bfd6e6-4c4b-467b-a9bc-b47d512ff960": {"node_ids": ["f09ee431-3eeb-4fd5-82c5-a96daeea1a41", "f27384fb-e990-449d-92c5-438083a20223"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Login.tsx", "language": "typescript", "lines": 146, "filename": "Login.tsx"}}, "2e0b49ab-a3fd-4af3-8911-597e30482e53": {"node_ids": ["68f7e8d9-7160-4bdb-8342-c9c99aca6024", "3fce3c90-03f4-495a-93a9-abd0746d3fd8", "b3583997-8db7-44d0-95eb-09e33a72bf86", "21f20e6f-a2e2-4320-b417-8163633c0722", "b81541e1-8975-4e7c-a131-56d4bc6daf5a", "da2c7ccb-0989-4e36-b7f0-cc91c04d3630"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Playground.tsx", "language": "typescript", "lines": 491, "filename": "Playground.tsx"}}, "a3079cdf-9c72-4211-8b17-937bf2df6322": {"node_ids": ["dc45ba00-9d3e-4238-ac88-e7de5ea641d5", "042c80a1-261e-4fcb-ab99-3a64ea675845", "58779001-7119-49a3-9107-41b1e589798d", "8a9e37a2-fec5-4fd2-aab2-9a044012df76"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Profile.tsx", "language": "typescript", "lines": 252, "filename": "Profile.tsx"}}, "9e523807-7308-4af7-ba56-998ea6431ba2": {"node_ids": ["efe5985f-bee3-4e3d-a313-83ca4632fd4e", "038f01e9-3e44-4977-a6ff-fa1593623260", "2d80feb5-ebf0-40df-9d23-1227f201b201", "a79cb706-d28c-48b5-8e01-045dc1e95136"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Reports.tsx", "language": "typescript", "lines": 341, "filename": "Reports.tsx"}}, "fece5066-9485-4734-8b7e-e516ad9b868f": {"node_ids": ["af494ee7-b56b-4fb9-9977-d2c36c3de341", "f46a98e2-a9ec-4392-b739-c261d567ed98", "3e8f2ec6-c323-40b4-9ed6-be276661afbd", "e06a546b-df1f-4d68-9083-494a3e4a7d23", "3d1e557e-395d-4b62-a07d-be31d4709cf2", "9611f88a-2a44-494c-891b-cc138b4dbe11", "2f9496ff-c19a-4c9c-9535-a40283e396fb", "95a2fb9d-11d3-4e53-8d47-6612b90b66cb", "f4ac6860-d059-42ff-a4cc-40ce2d257908", "16cc0a18-6b99-4573-a216-edd13ae09ca3"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Rupturas.tsx", "language": "typescript", "lines": 700, "filename": "Rupturas.tsx"}}, "b2592cd2-45af-4230-8baf-a6e99c36c4bd": {"node_ids": ["2887d11e-da82-4f36-adf0-0fe80d76d7f3", "7dcacd5d-c264-402e-82b6-d7385361cfe5"], "metadata": {"file_path": "frontend-solid\\src\\pages\\SharedConversation.tsx", "language": "typescript", "lines": 156, "filename": "SharedConversation.tsx"}}, "7983b46e-58f1-4f9b-a389-2588d6edef24": {"node_ids": ["6ff0537a-1587-44c9-bfdc-511d31272616", "25f4b3c8-b4ef-43bf-91f7-c6c6397cbc97", "dc0a7853-9319-4908-8f8c-867597acfc34", "ed07c4aa-37ee-4d9b-86e5-0cb3660263ee", "5fcabd73-d92e-4157-86cc-290fcd46db4e", "b14969c2-d401-4431-8054-e171188eaa7b", "6ee26294-c1dd-48b0-9bb2-9d9b7c33e3d0", "63fe201c-9c6e-4e3a-a9b9-9dcf6201ccc4", "05495d88-f368-44c5-ab1a-ff73d4f0e3cd"], "metadata": {"file_path": "frontend-solid\\src\\pages\\Transfers.tsx", "language": "typescript", "lines": 781, "filename": "Transfers.tsx"}}, "c41d658b-1b6b-4bdd-9b34-f96365b4ac82": {"node_ids": ["b3b18377-3a62-4498-83cb-360fd9e07714"], "metadata": {"file_path": "frontend-solid\\src\\services\\admin.service.ts", "language": "typescript", "lines": 59, "filename": "admin.service.ts"}}, "88cba982-fb17-4b97-baa3-2f4d667ae13e": {"node_ids": ["ac46a0ac-4404-4384-8280-b27ee95b70d1"], "metadata": {"file_path": "frontend-solid\\src\\services\\analytics.service.ts", "language": "typescript", "lines": 52, "filename": "analytics.service.ts"}}, "0de11889-4a35-4bf4-b303-05575c99a366": {"node_ids": ["16e7e1ac-be38-4c09-9ff9-63d771cc465c"], "metadata": {"file_path": "frontend-solid\\src\\services\\auth.service.ts", "language": "typescript", "lines": 38, "filename": "auth.service.ts"}}, "f58052c3-2b80-4156-b1a2-53145ff358b6": {"node_ids": ["52993a83-5c5b-41ef-904b-e47effd50b2b", "279e21f2-5cf2-44ac-83b9-86a811121baa", "27454026-63dc-4179-a8f6-823e765b1286", "e0bedf76-c15d-4c28-ba62-8bfc614de4a9"], "metadata": {"file_path": "frontend-solid\\src\\services\\logger.service.ts", "language": "typescript", "lines": 490, "filename": "logger.service.ts"}}, "19062a8f-ecf6-4569-9cba-72d49b774a24": {"node_ids": ["5dacf70e-6265-434c-8e19-bfa904c3f5f5"], "metadata": {"file_path": "frontend-solid\\src\\services\\reports.service.ts", "language": "typescript", "lines": 65, "filename": "reports.service.ts"}}, "20e450e3-0323-4181-8acb-11ffb5b2e030": {"node_ids": ["9d094e7f-e856-4dad-8e7d-93e2cd07aa6a", "12f92ccc-5547-4af8-adbc-4d65ce9da93b"], "metadata": {"file_path": "frontend-solid\\src\\store\\auth.ts", "language": "typescript", "lines": 149, "filename": "auth.ts"}}, "d3e82f6b-64a9-4daf-9f0e-b6a3326b7a07": {"node_ids": ["9e08a145-ecff-46a2-b2a8-bfd51fa88d92"], "metadata": {"file_path": "frontend-solid\\src\\store\\dashboard.ts", "language": "typescript", "lines": 85, "filename": "dashboard.ts"}}, "abb2a4d6-5bbe-4b35-bfe8-49d1e9a79a06": {"node_ids": ["e9169eee-a568-4bf6-898a-bcb54c631d9c"], "metadata": {"file_path": "frontend-solid\\src\\__tests__\\App.test.tsx", "language": "typescript", "lines": 29, "filename": "App.test.tsx"}}, "3eece43e-f014-437e-b56e-5a4573b463e8": {"node_ids": ["89532045-3266-4a4b-a55b-f7c304e4e68e"], "metadata": {"file_path": "frontend-solid\\src\\__tests__\\ErrorBoundary.test.tsx", "language": "typescript", "lines": 30, "filename": "ErrorBoundary.test.tsx"}}, "f0d783f3-b717-486f-8c6f-57d61a800f51": {"node_ids": ["372151b0-0514-4202-ab5a-c932424ae73f"], "metadata": {"file_path": "frontend-solid\\src\\__tests__\\Layout.test.tsx", "language": "typescript", "lines": 36, "filename": "Layout.test.tsx"}}}}